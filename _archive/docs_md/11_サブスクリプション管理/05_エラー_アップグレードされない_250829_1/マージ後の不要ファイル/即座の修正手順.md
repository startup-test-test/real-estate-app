# å³åº§ã®ä¿®æ­£æ‰‹é †

## ğŸš€ ä»Šã™ãå®Ÿè¡Œã™ã¹ãä¿®æ­£

### 1. ç¾åœ¨ã®index.tsã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
```bash
cd /workspaces/real-estate-app
cp supabase/functions/handle-stripe-webhook/index.ts \
   supabase/functions/handle-stripe-webhook/index_backup_20250829.ts
```

### 2. ä¿®æ­£ç‰ˆã‚’é©ç”¨

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³A: index_fixed.tsã‚’ã‚³ãƒ”ãƒ¼**
```bash
cp docs_md/11_ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†/05_ã‚¨ãƒ©ãƒ¼_ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã•ã‚Œãªã„_250829_1/index_fixed.ts \
   supabase/functions/handle-stripe-webhook/index.ts
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³B: æœ€å°é™ã®ä¿®æ­£ï¼ˆæ¨å¥¨ï¼‰**

`supabase/functions/handle-stripe-webhook/index.ts`ã®ä»¥ä¸‹ã®éƒ¨åˆ†ã®ã¿ä¿®æ­£:

#### Line 3: Stripeã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’æ›´æ–°
```typescript
// å¤‰æ›´å‰
import Stripe from 'https://esm.sh/stripe@13.10.0?target=deno'

// å¤‰æ›´å¾Œ
import Stripe from 'https://esm.sh/stripe@14.0.0?target=deno'
```

#### Line 8ã®å¾Œã«è¿½åŠ : CryptoProvider
```typescript
// Line 8ã®å¾Œã«è¿½åŠ 
const cryptoProvider = Stripe.createSubtleCryptoProvider()
```

#### Line 38-39: constructEventã®ä¿®æ­£
```typescript
// å¤‰æ›´å‰
event = stripe.webhooks.constructEvent(body, signature, webhookSecret)

// å¤‰æ›´å¾Œ
event = await stripe.webhooks.constructEventAsync(
  body,
  signature,
  webhookSecret,
  undefined,
  cryptoProvider
)
```

#### Line 78: stripe_price_idã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
```typescript
// å¤‰æ›´å‰
stripe_price_id: subscription.items.data[0].price.id,

// å¤‰æ›´å¾Œï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
// stripe_price_id: subscription.items.data[0].price.id,
```

### 3. ãƒ‡ãƒ—ãƒ­ã‚¤

#### é–‹ç™ºç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆ
supabase functions serve handle-stripe-webhook

# åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§
stripe listen --forward-to http://localhost:54321/functions/v1/handle-stripe-webhook
```

#### æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
supabase functions deploy handle-stripe-webhook
```

### 4. å‹•ä½œç¢ºèª

1. **Supabase Dashboard**
   - Functions â†’ Logs â†’ handle-stripe-webhook
   - ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

2. **Stripe Dashboard**
   - Developers â†’ Webhooks â†’ ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°
   - 200 OKãŒè¿”ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

3. **ãƒ†ã‚¹ãƒˆæ±ºæ¸ˆ**
   - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§æ±ºæ¸ˆã‚’å®Ÿè¡Œ
   - ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹ã‹ç¢ºèª

## âš ï¸ æ³¨æ„äº‹é …

- ä¿®æ­£å¾Œã‚‚`stripe_price_id`é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã¯å‡ºã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã™
- å®Œå…¨ãªè§£æ±ºã«ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã™ãŒã€ã¾ãšã¯Webhookç½²åæ¤œè¨¼ã®ä¿®æ­£ã‚’å„ªå…ˆã—ã¦ãã ã•ã„

## ğŸ” ç¢ºèªãƒã‚¤ãƒ³ãƒˆ

ä¿®æ­£å¾Œã€ä»¥ä¸‹ã®ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª:
- âœ… `Processing webhook event: checkout.session.completed`
- âœ… `Checkout completed for user: [user_id]`
- âœ… `Subscription created/updated for user: [user_id]`

ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¶ˆãˆã‚‹ã“ã¨ã‚’ç¢ºèª:
- âŒ `Webhook signature verification failed`
- âŒ `SubtleCryptoProvider cannot be used in a synchronous context`
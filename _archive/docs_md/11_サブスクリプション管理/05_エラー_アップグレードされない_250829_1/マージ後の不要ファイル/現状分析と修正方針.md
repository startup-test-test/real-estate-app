# ç¾çŠ¶åˆ†æã¨ä¿®æ­£æ–¹é‡

## ğŸ“Š ç¾åœ¨ã®ç’°å¢ƒçŠ¶æ³

### devç’°å¢ƒï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
- **ã‚³ãƒ¼ãƒ‰çŠ¶æ…‹**: `constructEventAsync`ã‚’ä½¿ç”¨ï¼ˆéåŒæœŸç‰ˆï¼‰âœ…
- **Deno std**: @0.168.0ï¼ˆå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
- **Stripe SDK**: v13.10.0
- **å‹•ä½œçŠ¶æ³**: 
  - Webhookã‚¤ãƒ™ãƒ³ãƒˆã¯å‡¦ç†ã•ã‚Œã¦ã„ã‚‹
  - ã—ã‹ã—`stripe_price_id`ã‚¨ãƒ©ãƒ¼ã¯ç™ºç”Ÿã—ã¦ã„ãªã„ï¼ˆã‚«ãƒ©ãƒ ãŒå­˜åœ¨ï¼Ÿï¼‰
  - ä¸€éƒ¨æˆåŠŸã—ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ã‚ã‚Š

### æœ¬ç•ªç’°å¢ƒ
- **ã‚³ãƒ¼ãƒ‰çŠ¶æ…‹**: `constructEvent`ã‚’ä½¿ç”¨ï¼ˆåŒæœŸç‰ˆï¼‰âŒ 
- **Deno std**: @0.177.1ï¼ˆæ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
- **å‹•ä½œçŠ¶æ³**: Webhookç½²åæ¤œè¨¼ã§å®Œå…¨ã«å¤±æ•—

## ğŸ” ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†æ

### 1. event loop errorï¼ˆä¸¡ç’°å¢ƒã§ç™ºç”Ÿï¼‰
```
Error: Deno.core.runMicrotasks() is not supported in this environment
```
- **å½±éŸ¿**: è»½å¾®ï¼ˆå‡¦ç†ã¯ç¶™ç¶šï¼‰
- **åŸå› **: Deno stdã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸æ•´åˆ

### 2. duplicate key errorï¼ˆdevç’°å¢ƒã®ã¿ï¼‰
```
duplicate key value violates unique constraint "subscriptions_stripe_customer_id_key"
```
- **å½±éŸ¿**: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‡è¤‡ä½œæˆæ™‚ã®ã¿
- **åŸå› **: `upsert`ã®`onConflict`è¨­å®šãŒä¸é©åˆ‡

### 3. Invalid Stripe API versionï¼ˆdevç’°å¢ƒã§1å›ï¼‰
```
Error: Invalid Stripe API version: 2025-01-27
```
- **å½±éŸ¿**: ä¸€æ™‚çš„ãªã‚¨ãƒ©ãƒ¼
- **åŸå› **: é–“é•ã£ãŸAPIãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æŒ‡å®š

### 4. Webhookç½²åæ¤œè¨¼å¤±æ•—ï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿ï¼‰
```
SubtleCryptoProvider cannot be used in a synchronous context
```
- **å½±éŸ¿**: è‡´å‘½çš„ï¼ˆã™ã¹ã¦ã®WebhookãŒå¤±æ•—ï¼‰
- **åŸå› **: åŒæœŸç‰ˆã®ä½¿ç”¨

## ğŸ¯ ä¿®æ­£æ–¹é‡

### Phase 1: ç·Šæ€¥ä¿®æ­£ï¼ˆæœ¬ç•ªç’°å¢ƒã®å¾©æ—§ï¼‰

1. **Webhookç½²åæ¤œè¨¼ã®ä¿®æ­£**
   - `constructEventAsync`ã«æˆ»ã™
   - `cryptoProvider`ã‚’è¿½åŠ 

2. **stripe_price_idã®å¯¾å¿œ**
   - ä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ

### Phase 2: ç’°å¢ƒçµ±ä¸€åŒ–

1. **Denoãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®çµ±ä¸€**
   ```typescript
   // ä¸¡ç’°å¢ƒã§çµ±ä¸€
   import { serve } from 'https://deno.land/std@0.177.1/http/server.ts'
   ```

2. **Stripe SDKã®æ›´æ–°**
   ```typescript
   import Stripe from 'https://esm.sh/stripe@14.0.0?target=deno'
   ```

3. **upsert ã®ä¿®æ­£**
   ```typescript
   .upsert({
     // ãƒ‡ãƒ¼ã‚¿
   }, {
     onConflict: 'user_id'  // user_idã§é‡è¤‡åˆ¤å®š
   })
   ```

## ğŸ“ çµ±ä¸€ç‰ˆã‚³ãƒ¼ãƒ‰ï¼ˆæ¨å¥¨ï¼‰

```typescript
import { serve } from 'https://deno.land/std@0.177.1/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3'
import Stripe from 'https://esm.sh/stripe@14.0.0?target=deno'

const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY') || '', {
  apiVersion: '2023-10-16',
  httpClient: Stripe.createFetchHttpClient(),
})

// é‡è¦: CryptoProviderã‚’è¿½åŠ 
const cryptoProvider = Stripe.createSubtleCryptoProvider()

// ... ä¸­ç•¥ ...

// Webhookç½²åæ¤œè¨¼
event = await stripe.webhooks.constructEventAsync(
  body,
  signature,
  webhookSecret,
  undefined,
  cryptoProvider  // 5ç•ªç›®ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
)

// ... ä¸­ç•¥ ...

// upsertã®ä¿®æ­£
.upsert({
  user_id: userId,
  stripe_subscription_id: subscription.id,
  stripe_customer_id: subscription.customer as string,
  // stripe_price_id: subscription.items.data[0].price.id, // ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
  status: 'active',
  // ...
}, {
  onConflict: 'user_id'  // user_idãƒ™ãƒ¼ã‚¹ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯
})
```

## âœ… æœŸå¾…ã•ã‚Œã‚‹çµæœ

1. **æœ¬ç•ªç’°å¢ƒ**: Webhookç½²åæ¤œè¨¼ãŒæˆåŠŸã—ã€æ±ºæ¸ˆãŒæœ‰åŠ¹åŒ–ã•ã‚Œã‚‹
2. **devç’°å¢ƒ**: ã‚¨ãƒ©ãƒ¼ãŒæ¸›å°‘ã—ã€å®‰å®šå‹•ä½œ
3. **ä¸¡ç’°å¢ƒ**: ä»•æ§˜ãŒçµ±ä¸€ã•ã‚Œã€åŒã˜å‹•ä½œã‚’ä¿è¨¼

## ğŸš€ å®Ÿè£…æ‰‹é †

1. ã¾ãšæœ¬ç•ªç’°å¢ƒã®`constructEventAsync`ä¿®æ­£ã‚’å„ªå…ˆ
2. devç’°å¢ƒã‚‚åŒã˜ã‚³ãƒ¼ãƒ‰ã«çµ±ä¸€
3. ãƒ†ã‚¹ãƒˆæ±ºæ¸ˆã§å‹•ä½œç¢ºèª
4. å¿…è¦ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’èª¿æ•´
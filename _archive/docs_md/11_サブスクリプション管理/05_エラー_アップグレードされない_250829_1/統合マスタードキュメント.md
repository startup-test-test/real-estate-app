# Stripe Webhook ã‚¨ãƒ©ãƒ¼å¯¾å¿œ çµ±åˆãƒã‚¹ã‚¿ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
æœ€çµ‚æ›´æ–°: 2025å¹´8æœˆ29æ—¥

## ğŸ“Œ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

### å•é¡Œã®æ¦‚è¦
- **ç—‡çŠ¶**: Stripeæ±ºæ¸ˆã¯æˆåŠŸã™ã‚‹ãŒã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã¨ã—ã¦èªè­˜ã•ã‚Œãªã„
- **åŸå› **: Webhookç½²åæ¤œè¨¼ã®å¤±æ•—ï¼ˆconstructEventä½¿ç”¨ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ï¼‰
- **å½±éŸ¿**: ã™ã¹ã¦ã®æœ‰æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç„¡æ–™ãƒ—ãƒ©ãƒ³æ‰±ã„ã®ã¾ã¾

### è§£æ±ºæ–¹æ³•
1. `constructEventAsync` + `cryptoProvider`ã‚’ä½¿ç”¨ã™ã‚‹
2. `stripe_price_id`ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
3. ç’°å¢ƒã‚’çµ±ä¸€åŒ–ã™ã‚‹

---

## ğŸ”´ Part 1: å³åº§ã«å®Ÿè¡Œã™ã¹ãä¿®æ­£

### 1.1 ã‚³ãƒ¼ãƒ‰ä¿®æ­£ç®‡æ‰€

**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/functions/handle-stripe-webhook/index.ts`

#### ä¿®æ­£1: Stripeã‚¤ãƒ³ãƒãƒ¼ãƒˆæ›´æ–°ï¼ˆLine 3ï¼‰
```typescript
// å¤‰æ›´å‰
import Stripe from 'https://esm.sh/stripe@13.10.0?target=deno'

// å¤‰æ›´å¾Œ
import Stripe from 'https://esm.sh/stripe@14.0.0?target=deno'
```

#### ä¿®æ­£2: CryptoProviderè¿½åŠ ï¼ˆLine 8ã®å¾Œï¼‰
```typescript
const cryptoProvider = Stripe.createSubtleCryptoProvider()
```

#### ä¿®æ­£3: Webhookæ¤œè¨¼ä¿®æ­£ï¼ˆLine 38-39ï¼‰
```typescript
// å¤‰æ›´å‰
event = stripe.webhooks.constructEvent(body, signature, webhookSecret)

// å¤‰æ›´å¾Œ
event = await stripe.webhooks.constructEventAsync(
  body, signature, webhookSecret, undefined, cryptoProvider
)
```

#### ä¿®æ­£4: stripe_price_idå‰Šé™¤ï¼ˆLine 78ï¼‰
```typescript
// stripe_price_id: subscription.items.data[0].price.id, // ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
```

### 1.2 ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
cp supabase/functions/handle-stripe-webhook/index.ts \
   supabase/functions/handle-stripe-webhook/index_backup_$(date +%Y%m%d).ts

# ãƒ‡ãƒ—ãƒ­ã‚¤
supabase functions deploy handle-stripe-webhook
```

---

## ğŸ“Š Part 2: ç’°å¢ƒåˆ¥ã®ç¾çŠ¶ã¨èª²é¡Œ

### 2.1 ç’°å¢ƒæ¯”è¼ƒè¡¨

| é …ç›® | devç’°å¢ƒ | æœ¬ç•ªç’°å¢ƒ | ä¿®æ­£å¾Œç›®æ¨™ |
|------|---------|----------|------------|
| Webhookæ¤œè¨¼ | constructEventAsync âœ… | constructEvent âŒ | constructEventAsync |
| CryptoProvider | ãªã— âš ï¸ | ãªã— âŒ | ã‚ã‚Š |
| stripe_price_id | ã‚¨ãƒ©ãƒ¼ãªã— | ã‚¨ãƒ©ãƒ¼ã‚ã‚Š | ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ |
| å‹•ä½œçŠ¶æ³ | éƒ¨åˆ†çš„æˆåŠŸ | å®Œå…¨å¤±æ•— | å®Œå…¨æˆåŠŸ |

### 2.2 ã‚¨ãƒ©ãƒ¼å„ªå…ˆåº¦

| å„ªå…ˆåº¦ | ã‚¨ãƒ©ãƒ¼ | ç’°å¢ƒ | å¯¾å¿œ |
|--------|--------|------|------|
| ğŸ”´é«˜ | Webhookç½²åæ¤œè¨¼å¤±æ•— | æœ¬ç•ª | å³åº§ã«ä¿®æ­£ |
| ğŸŸ¡ä¸­ | stripe_price_idæ¬ è½ | æœ¬ç•ª | ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ |
| ğŸŸ¢ä½ | event loop error | ä¸¡æ–¹ | æ¬¡å›æ›´æ–°æ™‚ |

---

## ğŸ¯ Part 3: ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜ã¨ã‚ã‚‹ã¹ãå§¿

### 3.1 æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ï¼ˆæ­£å¸¸æ™‚ï¼‰

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
   â†“
2. ã‚·ã‚¹ãƒ†ãƒ ï¼šStripe Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
   â†“
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã‚«ãƒ¼ãƒ‰æƒ…å ±å…¥åŠ›ï¼ˆ4242 4242 4242 4242ï¼‰
   â†“
4. Stripeï¼šWebhooké€ä¿¡
   â†“
5. Edge Functionï¼š
   - constructEventAsync ã§æ¤œè¨¼ âœ…
   - subscriptions ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–° âœ…
   - status = 'active' è¨­å®š âœ…
   â†“
6. Frontendï¼šãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³è¡¨ç¤º âœ…
```

### 3.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹å¤‰åŒ–

#### ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼
```
subscriptions: ãƒ¬ã‚³ãƒ¼ãƒ‰ãªã—
user_usage: usage_count = 3/5
è¡¨ç¤º: "ç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼ˆ3/5å›ï¼‰"
```

#### æœ‰æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæ±ºæ¸ˆå¾Œï¼‰
```
subscriptions: status = 'active'
user_usage: å‚ç…§ã•ã‚Œãªã„
è¡¨ç¤º: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ï¼ˆç„¡åˆ¶é™ï¼‰"
```

### 3.3 ä½¿ç”¨åˆ¶é™ãƒ­ã‚¸ãƒƒã‚¯

```
checkUsageLimit()
â”œâ”€ subscriptions.status == 'active'?
â”‚  â”œâ”€ YES â†’ ç„¡åˆ¶é™ï¼ˆreturn trueï¼‰
â”‚  â””â”€ NO â†’ user_usageç¢ºèª
â”‚          â”œâ”€ usage_count < 5 â†’ åˆ©ç”¨å¯èƒ½
â”‚          â””â”€ usage_count >= 5 â†’ åˆ¶é™åˆ°é”
```

---

## ğŸ§ª Part 4: æ¤œè¨¼ãƒ†ã‚¹ãƒˆæ‰‹é †

### 4.1 äº‹å‰æº–å‚™
- [ ] Stripeãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ç¢ºèª
- [ ] Supabase/Stripe Dashboardã‚¢ã‚¯ã‚»ã‚¹
- [ ] ä¿®æ­£ã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†

### 4.2 å¿…é ˆãƒ†ã‚¹ãƒˆé …ç›®

#### Test 1: åŸºæœ¬æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ï¼ˆ10åˆ†ï¼‰
```bash
# ãƒ­ã‚°ç›£è¦–é–‹å§‹
supabase functions logs handle-stripe-webhook --tail
```

1. ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
2. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
3. ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰å…¥åŠ›: 4242 4242 4242 4242
4. æ±ºæ¸ˆå®Œäº†ç¢ºèª

**ç¢ºèªé …ç›®**:
- [ ] Webhook: 200 OK
- [ ] ãƒ­ã‚°: "Subscription created/updated"
- [ ] DB: status = 'active'
- [ ] UI: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³"è¡¨ç¤º

#### Test 2: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ï¼ˆ5åˆ†ï¼‰
1. Webhookå†é€ãƒ†ã‚¹ãƒˆ
2. é‡è¤‡æ±ºæ¸ˆãƒ†ã‚¹ãƒˆ

**ç¢ºèªé …ç›®**:
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãªã—
- [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¶­æŒ

### 4.3 æˆåŠŸåŸºæº–
âœ… Webhookç½²åæ¤œè¨¼æˆåŠŸ
âœ… DBæ›´æ–°å®Œäº†
âœ… UIè‡ªå‹•æ›´æ–°ï¼ˆ10ç§’ä»¥å†…ï¼‰
âœ… ç„¡åˆ¶é™åˆ©ç”¨å¯èƒ½

---

## ğŸ“ Part 5: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ 

### ä»Šã™ãï¼ˆ1æ™‚é–“ä»¥å†…ï¼‰
1. [ ] æœ¬ç•ªç’°å¢ƒã®ã‚³ãƒ¼ãƒ‰ä¿®æ­£
2. [ ] Edge Functionãƒ‡ãƒ—ãƒ­ã‚¤
3. [ ] ãƒ†ã‚¹ãƒˆæ±ºæ¸ˆå®Ÿè¡Œ
4. [ ] ãƒ­ã‚°ç¢ºèª

### æœ¬æ—¥ä¸­
1. [ ] devç’°å¢ƒã‚‚åŒã˜ã‚³ãƒ¼ãƒ‰ã«çµ±ä¸€
2. [ ] å…¨ãƒ†ã‚¹ãƒˆé …ç›®å®Ÿæ–½
3. [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

### ä»Šé€±ä¸­
1. [ ] Denoãƒãƒ¼ã‚¸ãƒ§ãƒ³çµ±ä¸€ï¼ˆ@0.177.1ï¼‰
2. [ ] Stripe SDKæ›´æ–°ï¼ˆv14.0.0ï¼‰
3. [ ] è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè£…

---

## ğŸš¨ Part 6: ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•

| ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | åŸå›  | å¯¾å‡¦æ³• |
|-----------------|------|--------|
| Webhook signature verification failed | åŒæœŸç‰ˆä½¿ç”¨ | constructEventAsyncä½¿ç”¨ |
| SubtleCryptoProvider cannot be used | cryptoProvideræœªè¨­å®š | cryptoProviderè¿½åŠ  |
| stripe_price_id column not found | ã‚«ãƒ©ãƒ æ¬ è½ | ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ |
| duplicate key error | onConflictæœªè¨­å®š | onConflict: 'user_id'è¿½åŠ  |

### ç·Šæ€¥æ™‚ã®é€£çµ¡å…ˆ
- Supabase Support: https://supabase.com/support
- Stripe Support: https://support.stripe.com/

---

## ğŸ“š Part 7: é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«
- `/supabase/functions/handle-stripe-webhook/index.ts` - Webhookå‡¦ç†
- `/supabase/functions/create-checkout-session/index.ts` - Checkoutä½œæˆ
- `/bolt_front/src/utils/usageLimit.ts` - ä½¿ç”¨åˆ¶é™ãƒã‚§ãƒƒã‚¯

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆã“ã®ãƒ•ã‚©ãƒ«ãƒ€å†…ï¼‰
- `dev_handle-stript_code.md` - devç’°å¢ƒã®ã‚³ãƒ¼ãƒ‰
- `dev_handle-stripe-webhook_ã‚¨ãƒ©ãƒ¼å†…å®¹.md` - devç’°å¢ƒã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
- `ã‚¨ãƒ©ãƒ¼å†…å®¹.md` - æœ¬ç•ªç’°å¢ƒã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
- `index_fixed.ts` - ä¿®æ­£æ¸ˆã¿ã‚³ãƒ¼ãƒ‰

---

## âœ… æœ€çµ‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ä¿®æ­£å®Œäº†ã®ç¢ºèª:
- [ ] constructEventAsyncä½¿ç”¨
- [ ] cryptoProviderè¨­å®š
- [ ] stripe_price_idã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
- [ ] ãƒ†ã‚¹ãƒˆæ±ºæ¸ˆæˆåŠŸ
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³è¡¨ç¤º
- [ ] ç„¡åˆ¶é™åˆ©ç”¨å¯èƒ½

ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯ã§ããŸã‚‰å¯¾å¿œå®Œäº†ã§ã™ã€‚ğŸ‰
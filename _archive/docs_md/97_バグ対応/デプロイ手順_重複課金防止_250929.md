# ğŸš€ é‡è¤‡èª²é‡‘é˜²æ­¢æ©Ÿèƒ½ - æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

## ğŸ“… å®Ÿæ–½æ—¥æ™‚
2025å¹´9æœˆ29æ—¥

## ğŸ¯ ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡
Stripe Webhooké‡è¤‡å‡¦ç†é˜²æ­¢æ©Ÿèƒ½

---

## 1. äº‹å‰ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã‚³ãƒ¼ãƒ‰æº–å‚™
- [x] `/supabase/functions/handle-stripe-webhook/index.ts` - ä¿®æ­£æ¸ˆã¿
- [x] `/supabase/migrations/20250929_add_stripe_events_table.sql` - ä½œæˆæ¸ˆã¿
- [x] `/.github/workflows/auto-sync-subscriptions.yml` - ç„¡åŠ¹åŒ–æ¸ˆã¿

### ç’°å¢ƒç¢ºèª
- [ ] Supabase Dashboard ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- [ ] Stripe Dashboard ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- [ ] æœ¬ç•ªç’°å¢ƒã®ç’°å¢ƒå¤‰æ•°ç¢ºèª

---

## 2. ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### Step 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ5åˆ†ï¼‰

```bash
# 1. Supabase CLIã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
supabase db push --db-url postgresql://postgres:[PASSWORD]@db.ulkuxysdohpgvgikqpoq.supabase.co:5432/postgres

# ã¾ãŸã¯ Supabase Dashboard ã‹ã‚‰å®Ÿè¡Œ
# SQL Editor â†’ New Query â†’ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ãƒšãƒ¼ã‚¹ãƒˆ â†’ Run
```

**ç¢ºèªSQL:**
```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚ŒãŸã‹ç¢ºèª
SELECT table_name, column_name, data_type
FROM information_schema.columns
WHERE table_name = 'stripe_events'
ORDER BY ordinal_position;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç¢ºèª
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'stripe_events';
```

### Step 2: Edge Function ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ10åˆ†ï¼‰

```bash
# 1. Supabase Functions ã®ãƒ‡ãƒ—ãƒ­ã‚¤
supabase functions deploy handle-stripe-webhook \
  --project-ref ulkuxysdohpgvgikqpoq

# 2. ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
supabase secrets list --project-ref ulkuxysdohpgvgikqpoq
```

**é‡è¦:** ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ä»¥ä¸‹ã‚’ç¢ºèª
- STRIPE_SECRET_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- STRIPE_WEBHOOK_SECRET ãŒæ­£ã—ã„
- SUPABASE_SERVICE_ROLE_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹

### Step 3: GitHub Actions ã®ç¢ºèªï¼ˆ2åˆ†ï¼‰

```bash
# 1. GitHub ãƒªãƒã‚¸ãƒˆãƒªã§ç¢ºèª
git add .github/workflows/auto-sync-subscriptions.yml
git commit -m "fix: Disable auto-sync to prevent duplicate charges"
git push origin main

# 2. Actions ã‚¿ãƒ–ã§ç¢ºèª
# scheduled ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
```

### Step 4: æœ¬ç•ªç’°å¢ƒã§ã®åˆæœŸãƒ†ã‚¹ãƒˆï¼ˆ5åˆ†ï¼‰

```bash
# Stripe CLI ã§ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
stripe trigger customer.subscription.updated \
  --api-key sk_live_xxx

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ç¢ºèª
```

```sql
-- ã‚¤ãƒ™ãƒ³ãƒˆãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
SELECT * FROM stripe_events
ORDER BY processed_at DESC
LIMIT 5;
```

---

## 3. æ®µéšçš„ãƒªãƒªãƒ¼ã‚¹æˆ¦ç•¥

### Phase 1: ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ï¼ˆ30åˆ†ï¼‰

1. **10%ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã§é–‹å§‹**
   - Supabase Edge Functions ã®è¨­å®šã§æ®µéšçš„æœ‰åŠ¹åŒ–

2. **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°é …ç›®**
   ```sql
   -- é‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯
   SELECT id, COUNT(*) as count
   FROM stripe_events
   WHERE processed_at >= NOW() - INTERVAL '30 minutes'
   GROUP BY id
   HAVING COUNT(*) > 1;
   ```

3. **ãƒ­ã‚°ç¢ºèª**
   - Supabase Dashboard â†’ Functions â†’ Logs
   - "Event already processed" ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª

### Phase 2: å…¨ä½“å±•é–‹ï¼ˆ1æ™‚é–“å¾Œï¼‰

1. **100%æœ‰åŠ¹åŒ–**
2. **1æ™‚é–“ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ç¶™ç¶š**

---

## 4. ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèªé …ç›®

### å³åº§ã«ç¢ºèªï¼ˆ5åˆ†ä»¥å†…ï¼‰

```sql
-- 1. æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆãŒå‡¦ç†ã•ã‚Œã¦ã„ã‚‹ã‹
SELECT event_type, COUNT(*) as count
FROM stripe_events
WHERE processed_at >= NOW() - INTERVAL '5 minutes'
GROUP BY event_type;

-- 2. ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹
SELECT * FROM stripe_events
WHERE metadata->>'error' IS NOT NULL
ORDER BY processed_at DESC
LIMIT 10;
```

### 1æ™‚é–“å¾Œã«ç¢ºèª

```sql
-- 3. é‡è¤‡å‡¦ç†ãŒãªã„ã‹
WITH duplicate_check AS (
  SELECT
    DATE_TRUNC('hour', processed_at) as hour,
    COUNT(DISTINCT id) as unique_events,
    COUNT(*) as total_processed
  FROM stripe_events
  WHERE processed_at >= NOW() - INTERVAL '1 hour'
  GROUP BY DATE_TRUNC('hour', processed_at)
)
SELECT * FROM duplicate_check
WHERE unique_events != total_processed;
```

### 24æ™‚é–“å¾Œã«ç¢ºèª

```sql
-- 4. ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å¥å…¨æ€§
SELECT
  DATE(processed_at) as date,
  event_type,
  COUNT(*) as event_count
FROM stripe_events
WHERE processed_at >= NOW() - INTERVAL '1 day'
GROUP BY DATE(processed_at), event_type
ORDER BY date DESC, event_count DESC;
```

---

## 5. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

### ç·Šæ€¥æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆ5åˆ†ä»¥å†…ï¼‰

```bash
# 1. å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Webhookãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«æˆ»ã™
git revert HEAD
git push origin main

# 2. Supabase Functions ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤
supabase functions deploy handle-stripe-webhook \
  --project-ref ulkuxysdohpgvgikqpoq

# 3. è‡ªå‹•åŒæœŸã‚’å†æœ‰åŠ¹åŒ–ï¼ˆå¿…è¦ãªå ´åˆï¼‰
# .github/workflows/auto-sync-subscriptions.yml ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è§£é™¤
```

---

## 6. ã‚³ãƒãƒ³ãƒ‰ã¾ã¨ã‚

### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
supabase db push

# Functions ãƒ‡ãƒ—ãƒ­ã‚¤
supabase functions deploy handle-stripe-webhook

# ãƒ­ã‚°ç¢ºèª
supabase functions logs handle-stripe-webhook --tail

# ç’°å¢ƒå¤‰æ•°ç¢ºèª
supabase secrets list

# Gitæ“ä½œ
git add .
git commit -m "fix: Add idempotency to prevent duplicate charges"
git push origin main
```

---

## 7. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q1: stripe_events ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„

```sql
-- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†å®Ÿè¡Œ
\i /workspaces/real-estate-app/supabase/migrations/20250929_add_stripe_events_table.sql
```

### Q2: WebhookãŒ502ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

```bash
# Functions ã®ãƒ­ã‚°ã‚’ç¢ºèª
supabase functions logs handle-stripe-webhook --tail

# ç’°å¢ƒå¤‰æ•°ã®å†è¨­å®š
supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_xxx
```

### Q3: "Event already processed" ãŒå‡ºãªã„

```sql
-- stripe_events ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ¨©é™ç¢ºèª
SELECT * FROM pg_policies
WHERE tablename = 'stripe_events';

-- å¿…è¦ã«å¿œã˜ã¦æ¨©é™ä»˜ä¸
GRANT ALL ON stripe_events TO service_role;
```

---

## 8. æˆåŠŸåŸºæº–

### ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã®åˆ¤å®š

| é …ç›® | åŸºæº– | ç¢ºèªæ–¹æ³• |
|------|------|----------|
| ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ | stripe_eventsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ | SQLç¢ºèª |
| ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ² | æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆãŒè¨˜éŒ²ã•ã‚Œã‚‹ | SELECTç¢ºèª |
| é‡è¤‡é˜²æ­¢ | åŒä¸€ã‚¤ãƒ™ãƒ³ãƒˆIDãŒ1ä»¶ã®ã¿ | GROUP BYç¢ºèª |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ < 1ç§’ | ãƒ­ã‚°ç¢ºèª |
| ã‚¨ãƒ©ãƒ¼ç‡ | < 0.1% | ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª |

---

## 9. ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®é€£çµ¡äº‹é …

### é–¢ä¿‚è€…ã¸ã®é€šçŸ¥

```
Subject: [å®Œäº†] Stripeé‡è¤‡èª²é‡‘é˜²æ­¢æ©Ÿèƒ½ã®ãƒ‡ãƒ—ãƒ­ã‚¤

ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†æ™‚åˆ»: 2025-09-29 XX:XX
å½±éŸ¿ç¯„å›²: Stripe Webhookå‡¦ç†
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æ­£å¸¸ç¨¼åƒä¸­

å®Ÿè£…å†…å®¹:
- stripe_eventsãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚ˆã‚‹ã‚¤ãƒ‡ãƒ³ãƒãƒ†ãƒ³ã‚·ãƒ¼ç¢ºä¿
- é‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆã®è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—
- è‡ªå‹•åŒæœŸã®ä¸€æ™‚åœæ­¢

ç›£è¦–é …ç›®:
- é‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆ: 0ä»¶
- ã‚¨ãƒ©ãƒ¼ç‡: 0%
- å¹³å‡å‡¦ç†æ™‚é–“: XXms

å•é¡ŒãŒã‚ã£ãŸå ´åˆã¯å³åº§ã«ã”é€£çµ¡ãã ã•ã„ã€‚
```

---

## 10. å‚è€ƒãƒªãƒ³ã‚¯

- [Supabase Dashboard](https://supabase.com/dashboard/project/ulkuxysdohpgvgikqpoq)
- [Stripe Dashboard](https://dashboard.stripe.com)
- [GitHub Actions](https://github.com/[your-repo]/actions)

---

*ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å®Ÿæ–½å¾Œã«çµæœã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„*
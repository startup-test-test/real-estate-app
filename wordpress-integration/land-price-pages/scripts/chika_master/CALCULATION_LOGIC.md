# 公示地価マスターデータ 計算ロジック定義書

## 作成日: 2025-10-17
## バージョン: 1.0

---

## 📊 計算ロジックの種類

### Option A: 全データポイント方式（推奨）⭐
**説明**: 全47都道府県の全公示地価データポイントを1つのデータセットとして扱い、そこから平均値を算出

**計算式**:
```
全国平均地価 = Σ(全データポイントの地価) / 全データポイント数

例:
- 東京都: 1,661件のデータポイント
- 大阪府: 1,215件のデータポイント
- 秋田県: 130件のデータポイント
...
合計: 17,899件

全国平均 = (東京都の1,661件 + 大阪府の1,215件 + ... + 秋田県の130件) / 17,899
```

**メリット**:
- ✅ データ件数の重みが反映される
- ✅ より実態に近い全国平均
- ✅ 統計的に正確

**デメリット**:
- ❌ 計算負荷が高い（全データポイントを保持）
- ❌ メモリ使用量が多い

**結果例（東京都）**:
- 平均地価: 475,799円/㎡
- 坪単価: 157.3万円/坪
- 変動率: +4.0%

---

### Option B: 都道府県平均方式
**説明**: 各都道府県の平均値を算出してから、47都道府県の平均を計算

**計算式**:
```
各都道府県の平均地価を計算:
- 東京都平均: 514,916円/㎡
- 大阪府平均: 159,441円/㎡
- 秋田県平均: 22,535円/㎡
...

全国平均 = (東京都平均 + 大阪府平均 + ... + 秋田県平均) / 47
```

**メリット**:
- ✅ 計算が簡単
- ✅ メモリ使用量が少ない
- ✅ 都道府県を平等に扱う

**デメリット**:
- ❌ データ件数の違いが反映されない
- ❌ 実態とずれる可能性がある

**結果例（東京都）**:
- 平均地価: 514,916円/㎡
- 坪単価: 170.2万円/坪
- 変動率: +5.6%

---

### Option C: 加重平均方式
**説明**: 各都道府県の平均値にデータ件数を重みとして掛けて計算

**計算式**:
```
全国平均 = Σ(各都道府県の平均地価 × データ件数) / 総データ件数

例:
全国平均 = (東京都平均 × 1,661 + 大阪府平均 × 1,215 + ... + 秋田県平均 × 130) / 17,899
```

**メリット**:
- ✅ Option Aとほぼ同じ結果
- ✅ 計算効率が良い
- ✅ メモリ効率が良い

**デメリット**:
- ❌ Option Aより若干精度が低い

---

## 🎯 採用する計算ロジック

### **Option A: 全データポイント方式** を採用

**理由**:
1. **既存ページとの一貫性**: すでに運用中のページ（ID:1726）と同じロジック
2. **統計的正確性**: 最も実態に近い全国平均
3. **信頼性**: ユーザーに正確な情報を提供

**トレードオフ**:
- 処理時間: 約2-3分（許容範囲）
- メモリ: 約20MB（問題なし）

---

## 📝 実装方法

### 全データポイント方式の実装

```python
def fetch_national_average():
    """全国平均データ取得（全データポイント方式）"""

    client = RealEstateAPIClient()
    all_prices = []  # 全データポイントを格納
    all_change_rates = []

    # 全都道府県のデータを取得
    for pref_name in prefecture_list:
        data = client.search_land_prices(prefecture=pref_name, year="2025")

        for item in data:
            price = item.get('price_per_sqm', 0)
            if price > 0:
                all_prices.append(price)  # 各データポイントを追加

            change_rate = parse_change_rate(item)
            if change_rate:
                all_change_rates.append(change_rate)

    # 全データポイントから平均を計算
    avg_price = int(mean(all_prices))
    avg_change_rate = round(mean(all_change_rates), 1)

    return {
        'average_price': avg_price,
        'change_rate': avg_change_rate,
        'data_count': len(all_prices)
    }
```

---

## 📊 計算結果の記録

### 全国平均（2025年）- Option A方式

| 項目 | 値 | 計算方法 |
|------|-----|---------|
| 平均地価 | 136,982円/㎡ | Σ(全17,899件) / 17,899 |
| 坪単価 | 452,833円/坪 | 平均地価 × 3.30579 |
| 変動率 | +2.1% | Σ(全変動率) / データ件数 |
| データ件数 | 17,899件 | 47都道府県の合計 |

### 都道府県別平均（東京都）- Option A方式

| 項目 | 値 | 計算方法 |
|------|-----|---------|
| 平均地価 | 475,799円/㎡ | Σ(東京都1,661件) / 1,661 |
| 坪単価 | 157.3万円/坪 | 平均地価 × 3.30579 / 10,000 |
| 変動率 | +4.0% | Σ(変動率1,661件) / 1,661 |
| データ件数 | 1,661件 | 東京都の公示地価ポイント数 |

---

## 🔄 計算ロジックの検証

### テストケース

```python
# テスト1: 全国平均が都道府県の範囲内にあるか
assert min(prefecture_prices) <= national_avg <= max(prefecture_prices)

# テスト2: データ件数が正しいか
assert sum(prefecture_data_counts) == national_data_count

# テスト3: 坪単価の計算が正しいか
assert abs(tsubo_price - (price_per_sqm * 3.30579)) < 1
```

---

## 📌 注意事項

### データ取得時の注意点

1. **異常値の除外**
   ```python
   # 0円以下のデータは除外
   if price > 0:
       all_prices.append(price)
   ```

2. **変動率の解析**
   ```python
   # "+5.6%", "-0.3%", "5.6" などの形式に対応
   change_rate = float(str.replace('%', '').replace('+', ''))
   ```

3. **欠損データの処理**
   - 変動率が取得できない場合: 平均計算から除外
   - 地価が0円の場合: データポイントとしてカウントしない

---

## 🔄 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-10-17 | 1.0 | 初版作成。Option A（全データポイント方式）を採用 |

---

## 📚 参考資料

- 国土交通省 不動産情報ライブラリAPI仕様書
- 既存ページ（ID:1726）の生成スクリプト: `generate_page_1726.py`
- 統計学における平均値の算出方法

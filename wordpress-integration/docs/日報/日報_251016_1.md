# 日報 2025年10月16日 (1)

## 作業概要
1,900ページ地価情報サイト構築に向けて、CSV一括インポート方式の設計・実装・テストを実施。ACF設定方針の決定、WordPress環境管理の検討を完了。

---

## 完了タスク

### 1. マスターデータCSV生成システムの構築

**背景:**
- 1,900ページ（全国+47都道府県+市区町村）を効率的に生成・管理する必要
- WordPress手動作成は非現実的
- データソースとWordPressを分離して管理したい

**実施内容:**

#### Phase 1: テスト生成（1ページ）
1. **全国平均ページ生成スクリプト作成**
   - ファイル: `pages/page_1726/generate_page_1726.py`
   - 機能:
     - 47都道府県の2025年公示地価データをAPIから取得
     - 平均地価・坪単価・変動率を算出
     - HTMLセクションを生成
   - 取得データ件数: 17,899件
   - 処理時間: 約2分

2. **生成結果:**
   ```
   平均地価: 136,982円/㎡
   坪単価: 452,833円/坪
   変動率: +2.1%
   ```

#### Phase 2: CSV形式でのエクスポート
1. **基本CSV生成** (`generate_csv_master.py`)
   - 構造化されたデータのみのCSV
   - カラム: post_id, post_title, area_name, heikin_chika, tsubo_tanka, hendo_ritsu, data_count
   - 用途: データ確認・バックアップ

2. **WP All Import対応CSV生成** (`generate_wp_import_csv.py`)
   - HTMLコンテンツを含むCSV
   - カラム: post_id, post_title, post_content, post_status
   - post_contentに完全なHTMLセクションを格納
   - ファイルサイズ: 1.6 KB

#### Phase 3: 3ページ版CSV生成
1. **スクリプト作成** (`generate_wp_import_csv_3pages.py`)
   - 全国平均 + 東京都 + 大阪府の3ページ
   - 都道府県別データ取得関数を実装

2. **生成結果:**
   | ページID | エリア | 平均地価 | 坪単価 | 変動率 | データ件数 |
   |---------|--------|---------|--------|--------|-----------|
   | 1726 | 日本全国 | 136,982円/㎡ | 452,833円/坪 | +2.1% | 17,899件 |
   | 1727 | 東京都 | 514,916円/㎡ | 1,702,159円/坪 | +5.6% | 1,661件 |
   | 1728 | 大阪府 | 159,441円/㎡ | 527,182円/坪 | +2.3% | 1,215件 |

3. **ファイルサイズ:** 4.7 KB

**成果物:**
- ✅ 1ページ生成システム完成
- ✅ CSV一括インポート方式の確立
- ✅ WordPressで正常にインポート・表示確認
- ✅ 3ページ版で拡張性を実証

---

### 2. ACF設計方針の決定

**検討内容:**

#### Option A: ACF不要（HTMLのみ）
**メリット:**
- シンプルな実装
- ACF設定不要
- 高速表示（DBクエリ不要）

**デメリット:**
- セクション単位の更新が困難
- データ構造化されていない

#### Option B: ACFでデータ項目管理
**例:**
```
ACFフィールド:
├─ heikin_chika (数値)
├─ tsubo_tanka (数値)
└─ hendo_ritsu (テキスト)
```

**メリット:**
- データ構造化
- 検索・ソート可能

**デメリット:**
- PHPテンプレート編集が必要
- HTML生成ロジックをPHP側に持つ必要

#### Option C: ACFでセクション管理（推奨案）
**例:**
```
ACFフィールド:
├─ summary_section (テキストエリア) → HTML
├─ ranking_section (テキストエリア) → HTML
├─ history_section (テキストエリア) → HTML
└─ map_section (テキストエリア) → HTML
```

**メリット:**
- ✅ セクション単位で更新可能
- ✅ HTML生成はPython側（単一責任）
- ✅ デザイン変更が柔軟
- ✅ REST APIで取得しやすい

**デメリット:**
- ACF設定が必要（約5分）
- PHPテンプレート編集が必要

**決定事項:**
- **当面はACF不要（Option A）で進める**
- 理由:
  1. データソースはAPI（単一の真実）
  2. 検索・ソート機能は現時点で不要
  3. デザイン変更はCSV再生成で対応可能
  4. ACF設定の工数 > 得られるメリット
- **将来的にOption Cへの移行パスを残す**
  - サイト内検索機能が必要になった場合
  - WordPress管理画面でセクション編集が必要になった場合

---

### 3. WordPress環境管理の検討

**課題:**
- 現在は本番環境のみ
- テスト・開発環境が不在
- 本番環境への直接更新はリスクが高い

**検討した方法:**

#### 方法1: WP Staging プラグイン
**メリット:**
- ワンクリックでステージング環境作成
- プラグインのみで完結
- 本番への反映（プッシュ）機能

**デメリット:**
- Pro版は有料（$99/年）
- 無料版は機能制限

#### 方法2: サブドメインで手動構築
**例:** `dev.ooya.tech`

**メリット:**
- 完全に分離された環境
- 自由度が高い

**デメリット:**
- 手動セットアップが必要
- データ同期の仕組みが必要

#### 方法3: Dockerローカル環境
**メリット:**
- ローカルで完結
- Git管理可能
- 無料

**デメリット:**
- Docker環境構築が必要
- 本番へのデプロイ手順が別途必要

**記事マージの方法:**

| 方法 | dev→本番マージ | 工数 | コスト |
|-----|--------------|------|--------|
| WP Staging Pro | ワンクリック | ⭐ | 有料 |
| WP All Export/Import | CSV経由 | ⭐⭐ | 無料 |
| REST APIスクリプト | 自動化可能 | ⭐⭐⭐ | 無料 |

**推奨ワークフロー（今回のケース）:**
```
Python Script
    ↓
CSV生成（HTML含む）
    ↓
dev環境でテストインポート
    ↓
表示確認・デザイン調整
    ↓
本番環境に同じCSVをインポート
```

**決定事項:**
- **当面は本番環境のみで運用**
- 理由:
  1. CSVインポート方式なら失敗リスクが低い
  2. draft状態でインポート→確認後に公開
  3. テスト環境構築の工数を1,900ページ生成に充てる
- **将来的にWP Stagingの導入を検討**

---

## 技術的な学び

### 1. CSV一括インポートのベストプラクティス
**発見:**
- WP All Importは大量ページの一括生成に最適
- `post_status: draft` でインポートすれば安全
- CSVのカラム設計が重要（拡張性を考慮）

**推奨CSV構造:**
```csv
post_id,post_title,post_content,post_status,post_author
1726,タイトル,"<HTML>",draft,1
```

### 2. ACFの適切な使いどころ
**ACFが有効:**
- WordPress管理画面で頻繁に編集する項目
- ユーザーが検索・フィルタリングする項目
- 複雑な条件分岐が必要な項目

**ACFが不要:**
- データソースが外部API
- 静的コンテンツ（HTML生成済み）
- 検索・ソート機能が不要

### 3. 段階的な実装の重要性
**アプローチ:**
```
1ページ → 3ページ → 47ページ → 1,900ページ
```

**メリット:**
- 各段階で問題を発見・修正
- ユーザーフィードバックを早期に取得
- リスクの分散

---

## ファイル構成

### 新規作成ファイル
```
wordpress-integration/land-price-pages/
├── scripts/
│   ├── generate_csv_master.py              # 基本CSV生成
│   ├── generate_wp_import_csv.py           # WP All Import用CSV（1ページ）
│   └── generate_wp_import_csv_3pages.py    # WP All Import用CSV（3ページ）
├── pages/
│   └── page_1726/
│       ├── generate_page_1726.py           # 全国平均ページ生成
│       └── page_1726_summary_section.html  # 生成されたHTML
└── COMPLETE_SYSTEM_DESIGN.md               # システム設計書
```

### 生成されたCSVファイル
```
wordpress-integration/land-price-pages/scripts/
├── land_price_master.csv         # データのみCSV（167 bytes）
├── wp_all_import.csv             # 1ページ版（1.6 KB）
└── wp_all_import_3pages.csv      # 3ページ版（4.7 KB）
```

---

## WordPress操作履歴

### 実施した操作
1. **WP All Import でCSVインポート**
   - 1ページ版: 成功
   - 3ページ版: 成功
   - すべて draft 状態でインポート
   - 表示確認後に公開

2. **ACFフィールド作成テスト**
   - フィールドグループ: 地価データ
   - フィールド: heikin_chika, tsubo_tanka, hendo_ritsu
   - 結果: 表示にはPHP編集が必要と判明
   - 判断: 当面ACF不要

---

## データ統計

### API呼び出し回数
- 全国平均データ取得: 47回（都道府県数）
- 東京都データ取得: 1回
- 大阪府データ取得: 1回
- **合計: 49回**

### 取得データ件数
- 全国: 17,899件
- 東京都: 1,661件
- 大阪府: 1,215件
- **合計: 20,775件**

### 処理時間
- 全国平均データ取得: 約2分
- 都道府県別データ取得: 約3秒/県
- CSV生成: 1秒未満
- **合計: 約2分10秒（3ページ分）**

---

## 次回作業予定

### 優先度: 高

#### 1. 47都道府県全ページのCSV生成
**目標:**
- 全国 + 47都道府県 = 48ページのCSV生成
- 処理時間: 約5分（予想）

**実装内容:**
```python
# generate_wp_import_csv_all_prefectures.py
for pref_name in prefecture_list:
    data = fetch_prefecture_data(pref_name)
    html = generate_html(pref_name, data)
    csv_writer.writerow([...])
```

---

#### 2. 市区町村ページ生成の設計
**課題:**
- 市区町村コードの取得方法
- API呼び出し回数の最適化（1,900回は多い）
- データキャッシュの仕組み

**実装案:**
1. 都道府県別にデータ取得
2. 市区町村でグルーピング
3. 各市区町村の平均値を算出
4. CSVに出力

---

#### 3. テンプレートシステムの確立
**現状:**
- 各ページのHTMLを個別に生成している
- デザイン変更時に全スクリプト修正が必要

**改善案:**
```python
# templates/page_template.py
def generate_summary_section(data):
    return f"""<section>...</section>"""

def generate_ranking_section(data):
    return f"""<section>...</section>"""

# 各ページ生成スクリプトから呼び出し
```

---

### 優先度: 中

#### 4. エラーハンドリングの強化
**現状の問題:**
- API呼び出し失敗時にスクリプトが停止
- リトライ機構がない

**改善案:**
```python
import time
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=2, max=10))
def fetch_data_with_retry(prefecture):
    return client.search_land_prices(prefecture=prefecture, year="2025")
```

---

#### 5. ドキュメント整備
**必要なドキュメント:**
- README.md: 各スクリプトの使い方
- 運用マニュアル: データ更新手順
- トラブルシューティング: よくあるエラーと対処法

---

## 課題・懸念事項

### 1. WordPress テスト環境未構築 🔴
**リスク:**
- 本番環境のみで開発・テストを実施
- 失敗時にユーザーに影響が出る可能性
- デザイン試行錯誤が本番に反映されてしまう

**検討した解決策:**

#### A. WP Staging プラグイン
- **メリット:** ワンクリックでステージング環境作成、本番へのプッシュ機能
- **デメリット:** Pro版は有料（$99/年）、無料版は機能制限

#### B. サブドメイン手動構築（例: dev.ooya.tech）
- **メリット:** 完全分離、自由度が高い
- **デメリット:** 手動セットアップが必要、データ同期の仕組みが必要

#### C. Dockerローカル環境
- **メリット:** ローカルで完結、Git管理可能、無料
- **デメリット:** Docker環境構築が必要、本番へのデプロイ手順が別途必要

**記事マージの課題:**
- WordPressはGitとは異なり、データベース管理が中心
- dev環境で作成した記事を本番にマージする方法:
  1. **WP Staging Pro（有料）:** ワンクリックでプッシュ
  2. **WP All Export/Import:** CSV経由で手動マージ（無料）
  3. **REST APIスクリプト:** 自動化可能（開発工数が必要）

**当面の対応:**
- CSVインポート方式なら draft 状態でインポート→確認後に公開で安全性を確保
- 1,900ページ生成を優先し、環境構築は後回し

**今後の対応:**
- WP Stagingプラグインの導入を検討
- または、サブドメインでのステージング環境構築

---

### 2. APIレート制限 🟡
**リスク:**
- 1,900ページ生成時にAPI呼び出しが大量発生
- レート制限に引っかかる可能性

**対策:**
1. データキャッシュの実装
2. API呼び出し間隔の調整（sleep）
3. 段階的な生成（100ページずつ）

---

### 3. CSV管理の複雑化 🟡
**リスク:**
- 1,900行のCSVファイルは管理が困難
- 一部だけ更新したい場合の対応

**対策:**
1. 都道府県ごとにCSVファイルを分割
2. マージスクリプトの作成
3. Git LFSの活用（大容量CSV管理）

---

### 4. WordPress パフォーマンス 🟢
**懸念:**
- 1,900ページのインポートでWordPressが重くならないか

**確認事項:**
- データベースサイズの監視
- ページ表示速度の計測
- キャッシュプラグインの導入検討

---

## 所感

### よかった点
1. **段階的アプローチの有効性**
   - 1ページ → 3ページと段階的に進めたことで、問題を早期発見
   - CSV構造の最適化ができた

2. **ACF不要という判断**
   - 複雑な設定を避け、シンプルな構成を維持
   - HTMLベースのアプローチで拡張性も確保

3. **ユーザーフィードバックの活用**
   - 実際にWordPressにインポートして表示確認
   - 本番環境での動作を早期に検証

### 改善点
1. **エラーハンドリング不足**
   - API呼び出し失敗時の処理が不十分
   - 次回実装で改善

2. **ドキュメント不足**
   - 各スクリプトの使い方が口頭説明のみ
   - README作成が必要

3. **パフォーマンス未計測**
   - 処理時間は測定したが、最適化の余地は未検討
   - 1,900ページ生成時に要再検討

---

## 作業時間
- 1ページ生成スクリプト作成: 30分
- CSV生成スクリプト作成: 40分
- 3ページ版スクリプト作成: 30分
- ACF検討・テスト: 40分
- WordPress環境管理の検討: 30分
- 日報作成: 30分
- **合計: 約3時間20分**

---

## 参考リンク
- トップページ: https://ooya.tech/media/?page_id=1726
- 国土交通省 不動産情報ライブラリ: https://www.reinfolib.mlit.go.jp/
- WP All Import ドキュメント: https://www.wpallimport.com/documentation/
- ACF ドキュメント: https://www.advancedcustomfields.com/resources/

---

**作成日:** 2025年10月16日
**作成者:** Claude Code
**プロジェクト:** Real Estate App - WordPress Integration
**マイルストーン:** 1,900ページ地価情報サイト構築 - Phase 1完了

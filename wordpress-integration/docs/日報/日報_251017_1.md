# 日報 2025年10月17日 (1)

## 作業概要
ID:1726（全国トップページ）用の公示地価マスターデータの設計・生成を完了。計算ロジックの定義、ファイル整理、次フェーズへの準備を実施。

---

## 完了タスク

### 1. 公示地価マスターデータの設計

**背景:**
- 既存のページ（ID:1726）は直接HTML生成方式
- データとプレゼンテーションが混在
- 再利用性・保守性に課題

**目標:**
- データ（マスターCSV）とプレゼンテーション（HTML）を分離
- マスターCSVから複数用途に展開可能な構造

**実施内容:**

#### Phase 1: 既存ページの分析
1. **既存ページ（ID:1726）の構成確認**
   - ファイル: `pages/page_1726/page_1726_national.html`
   - ファイル: `pages/page_1726/generate_page_1726.py`

2. **必要なデータ項目の洗い出し**
   - 全国平均サマリー
   - 都道府県別ランキング
   - 高価格/低価格ランキング
   - 上昇率/下落率ランキング
   - 過去5年の推移データ

#### Phase 2: 計算ロジックの定義

**課題発見:**
```
既存ページの数値と異なる結果が出た

既存: 東京都 475,799円/㎡
生成: 東京都 514,916円/㎡

原因: 計算方法の違い
```

**検討した計算方法:**

| 方法 | 説明 | メリット | デメリット |
|-----|------|---------|-----------|
| **Option A: 全データポイント方式** ⭐ | 全47都道府県の全データポイント（17,899件）から平均算出 | 統計的に正確、データ件数の重みを反映 | 計算負荷高、メモリ使用量多 |
| Option B: 都道府県平均方式 | 各都道府県の平均値から全国平均を算出 | 計算簡単、メモリ効率良 | データ件数の違いが反映されない |
| Option C: 加重平均方式 | 都道府県平均にデータ件数を重み付け | Option Aに近い結果、効率的 | Option Aより若干精度低 |

**決定事項:**
- **Option A: 全データポイント方式を採用**
- 理由:
  1. 既存ページとの一貫性
  2. 統計的正確性
  3. ユーザーへの信頼性

**計算式:**
```
全国平均地価 = Σ(全47都道府県の全データポイント) / 総データポイント数

例:
- 東京都: 1,661件のデータポイント
- 秋田県: 130件のデータポイント
合計: 17,899件

全国平均 = (東京都1,661件 + ... + 秋田県130件) / 17,899
```

#### Phase 3: ドキュメント化

**作成ファイル:**
```
wordpress-integration/land-price-pages/scripts/chika_master/CALCULATION_LOGIC.md
```

**内容:**
- 3つの計算方法の比較
- 採用ロジックの詳細説明
- 実装方法のサンプルコード
- テストケース
- 注意事項

---

### 2. 公示地価マスターCSV生成システムの構築

#### Phase 1: 初期スクリプト作成（試行錯誤）

**生成したファイル（削除済み）:**
1. `generate_data_csv_all_prefectures.py` - シンプル版
2. `generate_page_1726_master.py` - 都道府県平均方式
3. `generate_page_1726_master_full.py` - 都道府県平均方式（過去5年分）

**問題点:**
- Option B方式を使用
- 既存ページと数値が不一致

#### Phase 2: 正しいスクリプト作成

**最終スクリプト:**
```
wordpress-integration/land-price-pages/scripts/chika_master/generate_page_1726_master_correct.py
```

**機能:**
- 全データポイント方式（Option A）で実装
- 47都道府県の全データポイント取得
- 各種ランキング生成
- CSVヘッダーに計算ロジックを明記

**生成結果:**
```
wordpress-integration/land-price-pages/scripts/chika_master/page_1726_master_correct.csv
```

**処理時間:** 約50秒
**ファイルサイズ:** 4.6 KB
**データ件数:** 17,899件

---

### 3. マスターCSVのデータ構造

**ファイル:** `page_1726_master_correct.csv`

#### ヘッダー情報
```csv
# ID:1726（全国トップページ）用 公示地価マスターデータ
# 生成日時: 2025-10-17 04:44:XX
# データソース: 国土交通省 不動産情報ライブラリAPI
# 対象年: 2025年（令和7年）公示地価

# ========== 計算ロジック ==========
# Option A: 全データポイント方式
# 全国平均 = Σ(全47都道府県の全データポイント) / 総データポイント数
# 都道府県平均 = Σ(その都道府県の全データポイント) / その都道府県のデータポイント数
# 詳細: CALCULATION_LOGIC.md を参照
```

#### セクション1: 全国平均サマリー
```csv
area_name,average_price,tsubo_price,change_rate,data_count
日本全国,136982,452833,+2.1,17899
```

#### セクション2: 💰 高価格ランキング TOP10
```csv
rank,prefecture_name,average_price,tsubo_price,tsubo_price_man,change_rate
1,東京都,514916,1702204,170.2,+5.6
2,神奈川県,212407,702172,70.2,+3.3
3,大阪府,159441,527078,52.7,+2.3
...
```

#### セクション3: 📉 低価格ランキング TOP10
```csv
rank,prefecture_name,average_price,tsubo_price,tsubo_price_man,change_rate
1,秋田県,22535,74495,7.4,+0.5
2,青森県,24499,80988,8.1,+0.2
...
```

#### セクション4: 📈 上昇率ランキング TOP10
```csv
rank,prefecture_name,change_rate,average_price,tsubo_price_man
1,沖縄県,+7.0,121513,40.2
2,東京都,+5.6,514916,170.2
3,福岡県,+4.9,114949,38.0
...
```

#### セクション5: 📊 下落率ランキング TOP10
```csv
rank,prefecture_name,change_rate,average_price,tsubo_price_man
1,和歌山県,-0.7,42127,13.9
2,新潟県,-0.6,37555,12.4
3,愛媛県,-0.6,52619,17.4
...
```

#### セクション6: 都道府県別全データ（1-47位）
```csv
rank,prefecture_name,average_price,tsubo_price,tsubo_price_man,change_rate,data_count
1,東京都,514916,1702204,170.2,+5.6,1661
2,神奈川県,212407,702172,70.2,+3.3,1310
...
47,秋田県,22535,74495,7.4,+0.5,130
```

---

### 4. ファイル整理

**削除前の状態:**
```
scripts/chika_master/ (8ファイル)
├── generate_data_csv_all_prefectures.py
├── generate_page_1726_master.py
├── generate_page_1726_master_full.py
├── generate_page_1726_master_correct.py
├── land_price_data_all_prefectures.csv
├── page_1726_master.csv
├── page_1726_master_full.csv
├── page_1726_master_correct.csv
└── CALCULATION_LOGIC.md
```

**削除したファイル:**
- `generate_data_csv_all_prefectures.py` （試作版）
- `generate_page_1726_master.py` （Option B方式）
- `generate_page_1726_master_full.py` （Option B方式、過去5年分）
- `land_price_data_all_prefectures.csv` （試作データ）
- `page_1726_master.csv` （Option B方式データ）
- `page_1726_master_full.csv` （Option B方式データ、過去5年分）

**最終的なファイル構成:**
```
scripts/chika_master/ (3ファイル)
├── CALCULATION_LOGIC.md                     ← 計算ロジック定義書
├── generate_page_1726_master_correct.py     ← 生成スクリプト（Option A）
└── page_1726_master_correct.csv             ← マスターデータ
```

---

## 技術的な学び

### 1. データとプレゼンテーションの分離の重要性

**従来の方法:**
```
Python → API → 直接HTML生成 → WordPressに貼り付け
```
**問題点:**
- データの再利用が困難
- デザイン変更時に全データ再取得が必要
- 保守性が低い

**新しい方法:**
```
Python → API → マスターCSV保存 → マスターCSVからHTML生成 → WordPress用CSV
                     ↓
                   複数用途に展開可能
                   - グラフ生成
                   - API応答
                   - 分析レポート
```

**メリット:**
- データの一元管理
- 再利用性が高い
- デザイン変更が容易
- データ検証が簡単

### 2. 計算ロジックの明確化の重要性

**発生した問題:**
- 同じAPIから取得したのに数値が異なる
- 原因究明に時間がかかる

**解決策:**
- 計算ロジックをドキュメント化
- CSVファイルのヘッダーに明記
- 複数の計算方法を比較検討

**効果:**
- 後から見ても理解しやすい
- チームでの共有が容易
- トラブルシューティングが迅速

### 3. 段階的なファイル整理の必要性

**問題:**
- 試行錯誤で多数のファイルが生成
- どれが最新か分からなくなる

**ベストプラクティス:**
1. 作業中は複数バージョンを残す
2. 最終版が決まったら古いバージョンを削除
3. ファイル名に意味を持たせる（例: `_correct`, `_full`）
4. README等でファイルの役割を明記

---

## データ統計

### API呼び出し回数
- 全国平均データ取得: 47回（都道府県ごと）
- 都道府県別データ取得: 47回
- **合計: 94回**

### 取得データ件数
- 全国合計: 17,899件
- 最多: 東京都 1,661件
- 最少: 福井県 85件

### 処理時間
- 全国平均データ取得: 約25秒
- 都道府県別データ取得: 約25秒
- CSV生成: 1秒未満
- **合計: 約50秒**

### 生成データ
- 全国平均: 136,982円/㎡
- 最高地価: 東京都 514,916円/㎡
- 最低地価: 秋田県 22,535円/㎡
- 最大上昇率: 沖縄県 +7.0%
- 最大下落率: 和歌山県 -0.7%

---

## 次回作業予定

### 優先度: 高

#### 1. HTML生成スクリプトの作成
**目標:**
- マスターCSVからHTMLを生成するスクリプト作成
- 既存ページ（ID:1726）と同じレイアウト

**実装内容:**
```python
# generate_html_from_master.py（仮称）

# マスターCSVを読み込み
master_data = read_csv('page_1726_master_correct.csv')

# 各セクションのHTMLを生成
html_summary = generate_summary_section(master_data['section1'])
html_high_price = generate_ranking_table(master_data['section2'])
html_low_price = generate_ranking_table(master_data['section3'])
html_increase = generate_ranking_table(master_data['section4'])
html_decrease = generate_ranking_table(master_data['section5'])

# 全体を結合
full_html = combine_sections([html_summary, html_high_price, ...])
```

**成果物:**
- `generate_html_from_master.py` - HTML生成スクリプト
- `page_1726_content.html` - 生成されたHTMLコンテンツ

---

#### 2. WordPress用CSV生成
**目標:**
- WP All Import用のCSVを生成

**実装内容:**
```python
# generate_wp_csv_from_master.py（仮称）

# マスターCSVからHTMLを生成
html_content = generate_html_from_master('page_1726_master_correct.csv')

# WordPress用CSVに変換
wp_csv_data = {
    'post_id': 1726,
    'post_title': '全国の地価・公示地価【2025年最新】都道府県・市区町村別ランキング',
    'post_content': html_content,
    'post_status': 'draft'
}

# CSVファイルに出力
write_wp_csv('wp_import_page_1726.csv', wp_csv_data)
```

**成果物:**
- `wp_import_page_1726.csv` - WordPress用CSV（1ページ分）

---

#### 3. WordPressへのインポートテスト
**手順:**
1. WP All Importプラグインで`wp_import_page_1726.csv`をインポート
2. draft状態でID:1726に上書き
3. プレビューで表示確認
4. 問題なければ公開

---

### 優先度: 中

#### 4. 47都道府県ページのマスターCSV生成
**目標:**
- ID:1727〜1773（47都道府県）のマスターCSV生成

**課題:**
- 都道府県ページには市区町村別ランキングが必要
- 市区町村データの取得方法を設計

**実装案:**
```python
# 東京都ページの場合
tokyo_data = {
    'prefecture_name': '東京都',
    'average_price': 514916,
    'city_ranking': [
        {'city': '千代田区', 'price': 2500000},
        {'city': '中央区', 'price': 2200000},
        ...
    ]
}
```

---

#### 5. 市区町村ページ生成の設計
**課題:**
- 市区町村コードの取得
- 約1,850ページ分のデータ構造

**検討事項:**
1. 1つの巨大マスターCSVか、都道府県ごとに分割するか
2. APIレート制限への対策
3. データキャッシュの仕組み

---

### 優先度: 低

#### 6. 過去データ（推移グラフ用）の取得
**目標:**
- 2021-2024年のデータ取得
- 推移グラフ用のデータセット生成

**注意:**
- API呼び出し回数が5倍（5年分）
- 処理時間: 約4-5分

---

#### 7. テンプレートシステムの確立
**現状:**
- HTML生成ロジックがスクリプトに埋め込まれている

**改善案:**
```
templates/
├── summary_section.html.j2
├── ranking_table.html.j2
├── map_section.html.j2
└── history_graph.html.j2

# Jinja2テンプレートエンジンを使用
```

---

## 課題・懸念事項

### 1. WordPress テスト環境未構築 🔴
**リスク:**
- 本番環境のみで開発・テスト
- 失敗時にユーザーに影響

**当面の対応:**
- draft状態でインポート
- BackWPupでバックアップ取得済み

**今後の対応:**
- WP Stagingプラグインの導入を検討

---

### 2. HTML生成の複雑性 🟡
**懸念:**
- マスターCSVから既存ページと同じHTMLを生成できるか
- 日本地図セクション（47都道府県ボタン配置）が複雑

**対策:**
- 既存ページのHTMLを詳細に分析
- セクションごとに段階的に実装
- テンプレート化して保守性を向上

---

### 3. 市区町村データの取得効率 🟡
**懸念:**
- 約1,850ページ分のデータ取得
- API呼び出し回数が多い

**対策案:**
1. 都道府県ごとにデータ取得してグループ化
2. データキャッシュの実装
3. 段階的な生成（100ページずつ）

---

## 所感

### よかった点
1. **計算ロジックの明確化**
   - 数値の違いの原因を特定できた
   - ドキュメント化により今後の保守が容易に

2. **データとプレゼンテーションの分離**
   - マスターCSV方式により再利用性が向上
   - 今後の拡張が容易

3. **ファイル整理の重要性を再認識**
   - 試作版を残さずに削除
   - 最終版のみに集約

### 改善点
1. **最初から計算ロジックを明確にすべきだった**
   - Option B方式で進めてしまい、やり直しが発生
   - 事前に既存ページのロジックを詳細に確認すべき

2. **ファイル命名規則**
   - `_correct`, `_full` などの接尾辞を使ったが統一感がない
   - 次回は日付やバージョン番号を使用

3. **処理時間の最適化余地**
   - 約50秒かかる（許容範囲だが改善可能）
   - 並列処理やキャッシュの活用を検討

---

## 作業時間
- 既存ページの分析: 30分
- 計算ロジックの検討: 40分
- ドキュメント作成: 30分
- スクリプト作成（試行錯誤含む）: 90分
- データ取得・検証: 20分
- ファイル整理: 10分
- 日報作成: 30分
- **合計: 約4時間**

---

## ファイル一覧

### 新規作成ファイル
```
wordpress-integration/land-price-pages/scripts/chika_master/
├── CALCULATION_LOGIC.md                     ← 計算ロジック定義書（5.9KB）
├── generate_page_1726_master_correct.py     ← マスターCSV生成スクリプト（13KB）
└── page_1726_master_correct.csv             ← ID:1726用マスターデータ（4.6KB）
```

### 削除したファイル（試作版）
- `generate_data_csv_all_prefectures.py`
- `generate_page_1726_master.py`
- `generate_page_1726_master_full.py`
- `land_price_data_all_prefectures.csv`
- `page_1726_master.csv`
- `page_1726_master_full.csv`

---

## 参考リンク
- 国土交通省 不動産情報ライブラリ: https://www.reinfolib.mlit.go.jp/
- 既存ページ（ID:1726）: https://ooya.tech/media/?page_id=1726 ※現在draft状態
- WP All Import ドキュメント: https://www.wpallimport.com/documentation/

---

**作成日:** 2025年10月17日
**作成者:** Claude Code
**プロジェクト:** Real Estate App - WordPress Integration
**マイルストーン:** 1,900ページ地価情報サイト構築 - Phase 2完了
**次のマイルストーン:** HTML生成システムの構築 - Phase 3開始予定

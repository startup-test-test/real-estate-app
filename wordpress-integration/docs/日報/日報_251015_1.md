# 日報 2025年10月15日 (1)

## 作業概要
トップページ（ID: 1726）のデータ表記修正、過去推移データ追加、グラフ実装を実施。

---

## 完了タスク

### 1. 「基準地価」→「公示地価」への表記修正
**背景:**
- 実際に取得しているのは公示地価（XCT001 API）のデータ
- ページ表記は「基準地価」となっており、データと表記が不一致

**実施内容:**
- `page_1726.html` 内の「基準地価」を「公示地価」に一括置換
- 置換箇所: 5箇所
- 使用スクリプト: `replace_chika_text.py`

**成果物:**
- ✅ データソースと表記が一致
- ✅ ユーザーに正確な情報を提供

---

### 2. 過去5年分の公示地価推移データ追加
**背景:**
- ユーザーから「📋 データについて」の上に過去5年分の推移を追加してほしいとの要望

**実施内容:**
1. **データ取得スクリプト作成** (`fetch_historical_data.py`)
   - 2021年〜2025年の全国47都道府県データを取得
   - 各年約18,000地点のデータから平均値を算出
   - API呼び出し回数: 47都道府県 × 5年 = 235回

2. **取得データ:**
   | 年度 | 公示地価平均（円/㎡） | 坪単価平均（万円/坪） | 変動率 | データ件数 |
   |------|---------------------|-------------------|--------|-----------|
   | 2025年 | 136,982 | 45.3 | +2.1% | 17,899件 |
   | 2024年 | 129,895 | 42.9 | +1.9% | 18,267件 |
   | 2023年 | 124,919 | 41.3 | +1.4% | 18,268件 |
   | 2022年 | 121,428 | 40.1 | +0.5% | 18,301件 |
   | 2021年 | 119,943 | 39.7 | -0.4% | 18,305件 |

3. **HTMLテーブル生成** (`history_section.html`)
   - h3タイトル: 📈 日本全国の公示地価　過去の推移
   - 4列テーブル: 年度、公示地価平均、坪単価平均、変動率
   - 変動率は色付き表示（緑: 上昇、赤: 下落）

4. **ページへの挿入**
   - 挿入位置: 「📋 データについて」の直前
   - 使用スクリプト: `insert_history.py`

**成果物:**
- ✅ 過去5年分の実データに基づく推移テーブル
- ✅ 視覚的にわかりやすい変動率表示
- ✅ 約91,000件のデータから算出した信頼性の高い平均値

---

### 3. 地価推移グラフの実装
**背景:**
- ユーザーから「📈 日本全国の公示地価　過去の推移」の下にグラフを追加してほしいとの要望

**実施内容と試行錯誤:**

#### 試行1: Chart.js による実装（失敗）
- `chart_section.html` を生成
- Chart.js v4.4.0 を使用
- 2軸の折れ線グラフ（公示地価平均、坪単価平均）
- **問題:** WordPressのコンテンツエディタでJavaScriptが実行されず、真っ白に表示

#### 試行2: CSS専用グラフ（display: inline-block）（失敗）
- `css_chart_section.html` を生成
- JavaScriptを使わず、CSSのみで実装
- `display: inline-block` で横並び
- **問題:** WordPressで縦並びに表示されてしまう（inline-blockが効かない）

#### 試行3: Flexboxレイアウト + 単色グラフ（成功）
- `flex_chart_section.html` を生成
- `display: flex` で確実に横並び
- グラデーションをシンプルな単色（#667eea）に変更
- **成功:** 正しく横並びで表示

**最終仕様:**
- h3タイトル: 📊 日本全国の地価推移グラフ
- 5本の棒グラフ（2021年〜2025年）
- 各バーの上に以下を表示:
  - 公示地価平均（円/㎡）
  - 坪単価平均（万円/坪）
  - 変動率（色付き矢印）
- バーの高さ: 最大値を基準に相対的に表示
- 5年間の推移まとめボックス付き

**使用スクリプト:**
1. `create_chart_section.py` → Chart.js版（不採用）
2. `create_css_chart.py` → CSS inline-block版（不採用）
3. `create_flex_chart.py` → Flexbox版（採用）
4. `replace_with_flex_chart.py` → グラフ置き換え

**成果物:**
- ✅ WordPressで正しく表示される横並びグラフ
- ✅ JavaScriptなしでシンプルに実装
- ✅ レスポンシブ対応
- ✅ 5年間の推移が一目で把握可能

---

## 技術的な学び

### 1. WordPress コンテンツエディタの制約
- 投稿/固定ページのコンテンツ内では外部JavaScriptライブラリ（Chart.js等）が動作しない
- `<script>` タグは保存時に削除される可能性がある
- 解決策: CSS専用のグラフ実装

### 2. CSS横並びレイアウトの注意点
- `display: inline-block` はWordPressのテーマCSSと競合する可能性
- `display: flex` の方が確実に横並びを実現できる
- `justify-content: space-between` で均等配置

### 3. APIデータ取得の効率化
- 全都道府県 × 5年分のデータ取得には約3分かかる
- キャッシュ機構の実装を検討すべき
- 次回は `prefecture_ranking_data.json` のような形式で保存

---

## ファイル構成

### 新規作成ファイル
```
wordpress-integration/land-price-pages/
├── replace_chika_text.py          # 基準地価→公示地価 置換スクリプト
├── fetch_historical_data.py       # 過去5年分データ取得スクリプト
├── history_section.html           # 過去推移テーブルHTML
├── insert_history.py              # 過去推移セクション挿入スクリプト
├── create_chart_section.py        # Chart.jsグラフ生成（不採用）
├── chart_section.html             # Chart.jsグラフHTML（不採用）
├── insert_chart.py                # Chart.js挿入スクリプト（不採用）
├── create_css_chart.py            # CSSグラフ生成（不採用）
├── css_chart_section.html         # CSSグラフHTML（不採用）
├── replace_chart.py               # グラフ置き換えスクリプト
├── create_flex_chart.py           # Flexboxグラフ生成（採用）
├── flex_chart_section.html        # FlexboxグラフHTML（採用）
└── replace_with_flex_chart.py     # Flexboxグラフ置き換えスクリプト
```

### 更新ファイル
```
wordpress-integration/land-price-pages/
└── page_1726.html                 # トップページHTML
    - 基準地価→公示地価に修正
    - 過去5年分の推移テーブル追加
    - 地価推移グラフ追加
```

---

## WordPress REST API 使用状況

### 実行したAPI呼び出し
```python
# ページ更新
POST /wp-json/wp/v2/pages/1726
Content-Type: application/json
Authorization: Basic <base64(username:app_password)>

{
  "content": "<HTML コンテンツ>"
}
```

### 更新回数
- 基準地価→公示地価: 1回
- 過去推移テーブル追加: 1回
- Chart.jsグラフ追加: 1回
- CSSグラフ置き換え: 1回
- Flexboxグラフ置き換え: 1回
- **合計: 5回**

---

## データ統計

### 取得データ量
- 対象期間: 2021年〜2025年（5年分）
- 都道府県: 47都道府県
- 総データ件数: 91,040件
  - 2021年: 18,305件
  - 2022年: 18,301件
  - 2023年: 18,268件
  - 2024年: 18,267件
  - 2025年: 17,899件

### 地価推移サマリー
- **5年間の変化:**
  - 絶対値: +17,039円/㎡ (+5.6万円/坪)
  - 上昇率: +14.2%
- **2021年:** 唯一のマイナス成長（-0.4%）
- **2022年以降:** 連続プラス成長
- **2025年:** 最大の上昇率（+2.1%）

---

## 次回作業予定

### 優先度: 高

#### 1. WordPressテスト環境の構築 🆕
**目的:**
- 本番環境への直接更新リスクを軽減
- 安全にデザイン・機能のテストを実施

**実装方針:**
1. **Docker Compose でローカル環境構築**
   ```yaml
   services:
     wordpress:
       image: wordpress:latest
       ports:
         - "8080:80"
       environment:
         WORDPRESS_DB_HOST: db
         WORDPRESS_DB_NAME: test_wp
         WORDPRESS_DB_USER: test_user
         WORDPRESS_DB_PASSWORD: test_pass
     db:
       image: mysql:8.0
       environment:
         MYSQL_DATABASE: test_wp
         MYSQL_USER: test_user
         MYSQL_PASSWORD: test_pass
         MYSQL_ROOT_PASSWORD: root_pass
   ```

2. **本番環境からのデータ同期**
   - WordPress REST API経由でページデータをエクスポート
   - テスト環境にインポート
   - テーマ・プラグインの同期

3. **quick_edit.py の拡張**
   ```python
   # 環境切り替え機能
   python quick_edit.py 1726 page_1726.html --env=test
   python quick_edit.py 1726 page_1726.html --env=prod
   ```

**期待される効果:**
- ✅ 本番環境への影響ゼロでテスト可能
- ✅ 複数のデザインパターンを試行可能
- ✅ プルリクエスト前の最終確認が可能

---

#### 2. 都道府県別ページのテンプレート化
**現状:**
- トップページ（ID: 1726）のデザイン・構成が固まった

**次のステップ:**
1. トップページをテンプレートとしてYAML化
2. 都道府県別データを挿入
3. 47都道府県分のページを一括生成
4. WordPress REST APIで一括アップロード

**実装予定:**
```python
# テンプレートベースの都道府県ページ生成
python generate_prefecture_pages.py --prefecture=tokyo
python generate_prefecture_pages.py --all  # 47都道府県一括
```

---

### 優先度: 中

#### 3. 4つの全国ランキングの実データ実装
**現状:**
- 💰 高価格ランキング TOP10: サンプルデータ
- 📉 低価格ランキング TOP10: サンプルデータ
- 📈 上昇率ランキング TOP10: サンプルデータ
- 📊 下落率ランキング TOP10: サンプルデータ

**必要な作業:**
1. `fetch_national_ranking.py` を拡張
2. 4種類のランキングデータを取得
3. HTMLセクション生成
4. ページに反映

---

#### 4. データ自動更新機構の実装
**背景:**
- 公示地価は毎年1月1日に更新される
- 手動更新は運用負荷が高い

**実装案:**
1. GitHub Actions で定期実行
2. 年1回（1月中旬）に自動実行
3. データ取得 → HTML生成 → WordPress更新
4. 更新結果をSlack/Email通知

---

## 課題・懸念事項

### 1. WordPressテスト環境未構築 🔴
**リスク:**
- 本番環境で直接テストしているため、ユーザーに不完全なページが表示される可能性
- デザイン修正の試行錯誤が本番に反映されてしまう

**対策:**
- 次回最優先でテスト環境構築

---

### 2. APIレート制限の懸念 🟡
**現状:**
- 過去5年分のデータ取得で235回のAPI呼び出し
- 不動産情報ライブラリAPIのレート制限は不明

**対策案:**
1. API呼び出し間隔を調整（sleep追加）
2. 取得データをJSONファイルにキャッシュ
3. 差分更新の実装

---

### 3. グラフの視認性 🟡
**現状:**
- Flexbox + 単色グラフで実装
- モバイル表示での視認性が未確認

**対策:**
- レスポンシブデザインのテスト
- モバイルでは縦スクロール対応を検討

---

## 所感

### よかった点
1. **段階的な実装アプローチ**
   - Chart.js → CSS inline-block → Flexbox と試行錯誤しながら最適解に到達
   - 各段階でユーザーフィードバックを得られた

2. **実データの活用**
   - サンプルデータではなく、約91,000件の実データから算出
   - 信頼性の高い情報をユーザーに提供できた

3. **quick_edit.py の有用性**
   - HTML直接編集 → アップロードのワークフローが確立
   - 迅速なイテレーションが可能

### 改善点
1. **テスト環境の不在**
   - 本番環境で試行錯誤してしまった
   - 次回最優先で構築

2. **エラーハンドリング不足**
   - APIエラー時のリトライ機構がない
   - ネットワークエラーで処理が中断する可能性

3. **ドキュメント不足**
   - 各スクリプトの使い方をREADMEにまとめるべき
   - 運用手順書の作成が必要

---

## 作業時間
- 基準地価→公示地価修正: 10分
- 過去5年分データ取得・実装: 60分
- グラフ実装（試行錯誤含む）: 90分
- 日報作成: 40分
- **合計: 約3時間20分**

---

## 参考リンク
- トップページ: https://ooya.tech/media/?page_id=1726
- 国土交通省 不動産情報ライブラリ: https://www.reinfolib.mlit.go.jp/
- WordPress REST API ドキュメント: https://developer.wordpress.org/rest-api/

---

**作成日:** 2025年10月15日
**作成者:** Claude Code
**プロジェクト:** Real Estate App - WordPress Integration

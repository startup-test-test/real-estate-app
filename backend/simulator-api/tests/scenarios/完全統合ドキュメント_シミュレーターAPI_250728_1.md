# 不動産投資シミュレーターAPI 完全統合ドキュメント

最終更新日: 2025年7月28日

## 📚 目次

1. [システム全体構成](#システム全体構成)
2. [API仕様とエンドポイント](#api仕様とエンドポイント)
3. [計算ロジック仕様](#計算ロジック仕様)
4. [検証手順](#検証手順)
5. [Renderデプロイ運用](#renderデプロイ運用)
6. [トラブルシューティング](#トラブルシューティング)

---

## 🏗️ システム全体構成

### アーキテクチャ図

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐     ┌──────────────┐
│   フロントエンド  │────▶│    Render.com    │────▶│ 計算ロジック     │     │   Supabase   │
│  (React/Vite)   │ API │   (FastAPI)      │     │(calculations.py)│     │ (データ保存)  │
│ dev.ooya.tech   │     │ xxx.onrender.com │     └─────────────────┘     └──────────────┘
└─────────────────┘     └──────────────────┘              │                      ▲
        ▲                         │                        └──────────────────────┘
        │      JSONレスポンス      │                           シミュレーション結果を保存
        └─────────────────────────┘
```

### ファイル構成

```
backend/simulator-api/
├── app.py              # FastAPI本番用
├── streamlit_dev.py    # Streamlit開発版（UI付き）
├── shared/
│   └── calculations.py # 共通計算ロジック ⭐️
├── requirements.txt    # 必要なパッケージ
├── render.yaml         # Render設定ファイル
└── docs_md/
    └── 完全統合ドキュメント_シミュレーターAPI_250728_1.md  # このファイル
```

### 基本情報

- **プラットフォーム**: Render.com (Free tier)
- **本番URL**: `https://real-estate-app-1-iii4.onrender.com`
- **フレームワーク**: FastAPI (Python 3.9)
- **データベース**: Supabase
- **リージョン**: Oregon, USA

---

## 📡 API仕様とエンドポイント

### 1. ヘルスチェック

```http
GET /
```

**レスポンス例:**
```json
{
    "message": "大家DX API",
    "version": "1.0.0",
    "status": "running"
}
```

### 2. 投資シミュレーション実行

```http
POST /api/simulate
```

**ヘッダー:**
```http
Content-Type: application/json
Authorization: Bearer {user_token}  # オプション（Supabase保存時必須）
```

**リクエストボディ:**
```json
{
    "property_name": "物件名",
    "purchase_price": 5000,        // 購入価格（万円）
    "monthly_rent": 180000,        // 月額賃料（円）
    "loan_amount": 4500,           // 借入額（万円）
    "interest_rate": 0.7,          // 金利（%）
    "loan_years": 35,              // 返済期間（年）
    "land_area": 100,              // 土地面積（㎡）
    "building_area": 120,          // 建物面積（㎡）
    "building_price": 2000,        // 建物価格（万円）
    "road_price": 200000,          // 路線価（円/㎡）
    "other_costs": 250,            // 諸経費（万円）
    "renovation_cost": 150,        // リフォーム費（万円）
    "management_fee": 9000,        // 管理費（円/月）
    "fixed_cost": 0,               // その他固定費（円/月）
    "property_tax": 80000,         // 固定資産税（円/年）
    "vacancy_rate": 5,             // 空室率（%）
    "rent_decline": 1,             // 家賃下落率（%/年）
    "holding_years": 10,           // 保有年数（年）
    "exit_cap_rate": 4,            // 売却Cap Rate（%）
    "effective_tax_rate": 20,      // 実効税率（%）
    "depreciation_years": 27,      // 償却年数（年）
    "market_value": 6000,          // 想定売却価格（万円）
    "loan_type": "元利均等",       // 返済方式
    "major_repair_cycle": 10,      // 大規模修繕周期（年）
    "major_repair_cost": 200       // 大規模修繕費（万円）
}
```

**レスポンス例:**
```json
{
    "results": {
        "年間家賃収入（円）": 2052000,
        "表面利回り（%）": 4.1,
        "月間キャッシュフロー（円）": 171000,
        "年間キャッシュフロー（円）": 2052000,
        "CCR（%）": 2.1,
        "ROI（%）": 18.21,
        "IRR（%）": 12.71,
        "年間ローン返済額（円）": 1450012,
        "NOI（円）": 1864000,
        "収益還元評価額（万円）": 4660,
        "実勢価格（万円）": 6000,
        "想定売却価格（万円）": 6000,
        "土地積算評価（万円）": 2000,
        "建物積算評価（万円）": 2400,
        "積算評価合計（万円）": 4400,
        "売却コスト（万円）": 300,
        "残債（万円）": 3324.67,
        "売却益（万円）": 2375.33,
        "LTV（%）": 102.27,
        "DSCR（返済余裕率）": 1.29,
        "自己資金（万円）": 900
    },
    "cash_flow_table": [
        {
            "年次": "1年目",
            "満室想定収入": 2160000,
            "空室率（%）": 5,
            "実効収入": 2052000,
            "経費": 108000,
            "固定資産税": 80000,
            "大規模修繕引当": 200000,
            "NOI": 1864000,
            "ローン返済": 1450012,
            "年間CF": 413988,
            "減価償却": 740740,
            "税引前利益": 1154728,
            "税金": 230946,
            "税引後CF": 183042,
            "累計CF": 183042,
            "元金返済": 0,  // TODO: 実装
            "借入残高": 0,  // TODO: 実装
            "自己資金回収率": 0,  // TODO: 実装
            "売却金額": 0,
            "売却時手取り": 0  // TODO: 実装
        }
        // ... 10年分のデータ
    ],
    "simulation_id": "550e8400-e29b-41d4-a716-446655440000"  // Supabase保存時のみ
}
```

### 3. 過去のシミュレーション取得（Supabase連携）

```http
GET /api/simulations
```

**パラメータ:**
- `limit`: 取得件数（デフォルト: 10）
- `offset`: オフセット（ページネーション用）

**レスポンス例:**
```json
{
    "simulations": [
        {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "property_data": {...},
            "simulation_results": {...},
            "created_at": "2025-07-28T10:30:00Z",
            "is_favorite": false,
            "notes": "初回シミュレーション"
        }
    ],
    "total": 25
}
```

### 4. シミュレーション詳細取得

```http
GET /api/simulations/{simulation_id}
```

### 5. シミュレーション更新（お気に入り・メモ）

```http
PATCH /api/simulations/{simulation_id}
```

**リクエストボディ:**
```json
{
    "is_favorite": true,
    "notes": "良い物件候補"
}
```

---

## 📊 計算ロジック仕様

### 実装済みの計算

#### 1. 基本指標

| 指標 | 計算式 | 説明 |
|------|--------|------|
| 表面利回り | `(月額賃料 × 12) ÷ (購入価格 × 10000) × 100` | 総収入に対する利回り |
| NOI | `年間家賃収入（空室考慮後） - 年間経費 - 固定資産税` | 純営業収益 |
| CCR | `(年間CF - 税金) ÷ 自己資金 × 100` | 自己資本収益率 |
| ROI | `(年間CF + 減価償却費 - 税金) ÷ 購入価格 × 100` | 投資収益率 |
| DSCR | `NOI ÷ 年間ローン返済額` | 返済余裕率 |

#### 2. ローン計算（元利均等）

```python
r = 金利 ÷ 100 ÷ 12  # 月利
n = 返済年数 × 12      # 返済回数
月間返済額 = 借入額 × (r × (1+r)^n) ÷ ((1+r)^n - 1)
```

#### 3. 物件評価

| 評価方法 | 計算式 |
|----------|--------|
| 収益還元評価 | `NOI ÷ (Cap Rate ÷ 100)` |
| 土地積算評価 | `土地面積 × 路線価` |
| 建物積算評価 | `建物面積 × 20万円/㎡` |

#### 4. 税金計算

- **減価償却費（定額法）**: `建物価格 ÷ 償却年数`
- **不動産所得**: `家賃収入 - 経費 - 減価償却費`
- **税金**: `不動産所得 × 実効税率`

#### 5. IRR（内部収益率）
Newton-Raphson法による数値計算で実装

### 未実装の計算（TODO）

| 項目 | 計算式 | 優先度 |
|------|--------|--------|
| 元金返済額 | `ローン返済額 - 利息部分` | 🔴 高 |
| 借入残高 | `calculate_remaining_loan()` | 🔴 高 |
| 自己資金回収率 | `累計CF ÷ 自己資金 × 100` | 🔴 高 |
| 売却時手取り | `売却価格 - コスト - 残債 - 税金` | 🔴 高 |

---

## 🔧 検証手順

### 環境セットアップ（初回のみ）

```bash
cd /workspaces/real-estate-app/backend/simulator-api
pip install -r requirements.txt
```

### 方法1: FastAPIを使用した検証（推奨）

#### 1. サーバー起動

```bash
# フォアグラウンドで起動（ログ確認可能）
uvicorn app:app --host 0.0.0.0 --port 8000 --reload

# バックグラウンドで起動
nohup uvicorn app:app --host 0.0.0.0 --port 8000 > api.log 2>&1 &
```

#### 2. Swagger UIでテスト

1. ブラウザで `http://localhost:8000/docs` にアクセス
2. GitHub Codespacesの場合は転送されたURL + `/docs`
3. 「POST /api/simulate」を展開してテスト

#### 3. コマンドラインでテスト

```bash
# ヘルスチェック
curl http://localhost:8000/

# シミュレーション実行
curl -X POST http://localhost:8000/api/simulate \
  -H "Content-Type: application/json" \
  -d '{
    "property_name": "テスト物件",
    "purchase_price": 5000,
    "monthly_rent": 180000,
    "loan_amount": 4500,
    "interest_rate": 0.7,
    "loan_years": 35,
    "land_area": 100,
    "building_area": 120,
    "building_price": 2000,
    "road_price": 200000,
    "other_costs": 250,
    "renovation_cost": 150,
    "management_fee": 9000,
    "fixed_cost": 0,
    "property_tax": 80000,
    "vacancy_rate": 5,
    "rent_decline": 1,
    "holding_years": 10,
    "exit_cap_rate": 4,
    "effective_tax_rate": 20,
    "depreciation_years": 27,
    "market_value": 6000,
    "loan_type": "元利均等",
    "major_repair_cycle": 10,
    "major_repair_cost": 200
  }' | python -m json.tool
```

### 方法2: Streamlitを使用した検証（UI付き）

```bash
# Streamlit起動
streamlit run streamlit_dev.py

# ブラウザで http://localhost:8501 にアクセス
```

---

## 🚀 Renderデプロイ運用

### デプロイ方法

#### 自動デプロイ（推奨）

```
1. ローカルで変更
   ↓
2. git add, commit, push
   ↓
3. GitHubのmainブランチに反映
   ↓
4. Renderが自動検知してデプロイ開始
   ↓
5. 約5-10分でデプロイ完了
```

#### 手動デプロイ

1. https://dashboard.render.com/ にログイン
2. 「real-estate-app-1」サービスを選択
3. 「Manual Deploy」→「Deploy latest commit」

### ビルド設定

```yaml
# Build Command
cd backend/simulator-api && pip install -r requirements.txt

# Start Command
cd backend/simulator-api && uvicorn app:app --host 0.0.0.0 --port $PORT
```

### 環境変数（Renderダッシュボードで設定）

```bash
# API関連（将来使用予定）
OPENAI_API_KEY=xxx
REAL_ESTATE_API_KEY=xxx

# Supabase
SUPABASE_URL=xxx
SUPABASE_ANON_KEY=xxx

# Python環境
PYTHON_VERSION=3.9
```

### 無料プランの制限と対策

| 制限 | 内容 | 対策 |
|------|------|------|
| スピンダウン | 15分間アクセスなしでスリープ | 初回アクセス時にヘルスチェック |
| コールドスタート | 復帰に30-60秒 | ローディング表示、タイムアウト2分 |
| 月間制限 | 750時間/月 | 必要に応じて有料プランへ |

### モニタリング

#### ログ確認
- Renderダッシュボード → Logs
- リアルタイムログ表示

#### よく見るログ
```
# 正常起動
INFO:     Uvicorn running on http://0.0.0.0:10000
INFO:     Application startup complete.

# APIアクセス
INFO:     xxx.xxx.xxx.xxx:0 - "POST /api/simulate HTTP/1.1" 200 OK

# エラー
ERROR:    Exception in ASGI application
```

### 運用タスク

| 頻度 | タスク |
|------|--------|
| 日次 | APIの稼働状況確認、エラーログ確認 |
| 週次 | 使用時間確認、パフォーマンスレビュー |
| 月次 | コスト最適化検討、セキュリティ更新 |

---

## 🚨 トラブルシューティング

### ポート関連

```bash
# 使用中のポートを確認
ps aux | grep uvicorn
ps aux | grep streamlit

# プロセス終了
killall uvicorn
killall streamlit
```

### デプロイ失敗

| 原因 | 解決方法 |
|------|----------|
| requirements.txtの記述ミス | ローカルで動作確認 |
| Pythonバージョン不一致 | 環境変数で3.9を指定 |
| ファイルパスの間違い | ビルドコマンドのパス確認 |

### API応答なし

```bash
# 症状
502 Bad Gateway
503 Service Unavailable

# 対処
1. Renderダッシュボードでサービス状態確認
2. ログでエラー内容確認
3. 必要に応じて再起動
```

### GitHub Codespacesでの問題

1. VSCodeの「ポート」タブを確認
2. ポート8000を追加
3. 可視性を「Public」に設定

### 計算結果が更新されない

```bash
# FastAPIを再起動
# Ctrl+C で停止してから再度起動
uvicorn app:app --reload
```

---

## 🔐 セキュリティとスケーリング

### 現在のセキュリティ対策
- HTTPS自動対応（Render）
- 環境変数での秘密情報管理
- CORS設定

### 追加すべきセキュリティ対策
- [ ] APIキー認証
- [ ] レート制限
- [ ] WAFの導入
- [ ] 定期的なセキュリティ監査

### スケーリング戦略

| プラン | 料金 | スペック | 特徴 |
|--------|------|----------|------|
| Free | $0 | 0.1 CPU, 512MB | スピンダウンあり |
| Starter | $7/月 | 0.5 CPU, 512MB | スピンダウンなし |
| Standard | $25/月〜 | 1 CPU〜, 2GB〜 | オートスケーリング |

---

## 📝 Supabaseデータ構造

```sql
-- simulationsテーブル
CREATE TABLE simulations (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    property_data JSONB NOT NULL,
    simulation_results JSONB NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    is_favorite BOOLEAN DEFAULT FALSE,
    notes TEXT
);

-- インデックス
CREATE INDEX idx_simulations_user_id ON simulations(user_id);
CREATE INDEX idx_simulations_created_at ON simulations(created_at DESC);
```

---

## 🔧 開発のベストプラクティス

### コーディング規約
1. **DRY原則**: `shared/calculations.py`で計算ロジックを一元管理
2. **関数の単一責任**: 1関数1機能、30行以内
3. **テスタビリティ**: 純粋関数として実装、副作用の最小化
4. **ドキュメント**: 各関数にdocstring、複雑な計算にはコメント

### Git運用
```bash
# 機能開発
git checkout -b feature/元金返済計算
# 実装・テスト
git add .
git commit -m "feat: 元金返済額の計算ロジックを実装"
git push origin feature/元金返済計算
# PRを作成してレビュー
```

### 計算ロジックの追加方法
```python
# shared/calculations.py に関数を追加
def calculate_new_metric(property_data):
    """新しい指標の計算"""
    # 計算ロジックを実装
    return result

# run_full_simulation内で呼び出し
new_metric = calculate_new_metric(property_data)
```

---

## 📌 重要なポイント

1. **計算ロジックの一元管理**: FastAPIとStreamlitで共通使用
2. **即座に検証可能**: 修正後すぐにローカルで動作確認
3. **本番環境と同じコード**: ローカルとRenderで同一
4. **Supabase連携**: ユーザーごとのシミュレーション履歴管理

---

作成日: 2025年7月28日
作成者: Claude

## 更新履歴
- 2025/07/28: 4つのドキュメントを統合して作成
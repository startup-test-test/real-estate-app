# 不動産投資シミュレーター 計算ロジック仕様

## 概要
このドキュメントでは、`shared/calculations.py`で実装されている計算ロジックの仕様を説明します。

## 📊 実装済みの計算

### 1. 基本指標

#### 表面利回り（%）
```python
表面利回り = (月額賃料 × 12) ÷ (購入価格 × 10000) × 100
```

#### NOI（Net Operating Income）
```python
NOI = 年間家賃収入（空室考慮後） - 年間経費 - 固定資産税
```

#### CCR（Cash on Cash Return）
```python
CCR = (年間CF - 税金) ÷ 自己資金 × 100
```

#### ROI（Return on Investment）
```python
ROI = (年間CF + 減価償却費 - 税金) ÷ 購入価格 × 100
```

#### DSCR（Debt Service Coverage Ratio）
```python
DSCR = NOI ÷ 年間ローン返済額
```

### 2. ローン計算

#### 月間ローン返済額（元利均等）
```python
r = 金利 ÷ 100 ÷ 12  # 月利
n = 返済年数 × 12      # 返済回数
月間返済額 = 借入額 × (r × (1+r)^n) ÷ ((1+r)^n - 1)
```

### 3. 物件評価

#### 収益還元評価額
```python
収益還元評価額 = NOI ÷ (Cap Rate ÷ 100)
```

#### 積算評価
```python
土地積算評価 = 土地面積 × 路線価
建物積算評価 = 建物面積 × 20万円/㎡  # 標準建築単価
積算評価合計 = 土地積算評価 + 建物積算評価
```

### 4. 売却分析

#### 売却益
```python
売却益 = 想定売却価格 - 売却コスト - 残債
```

### 5. 税金計算

#### 減価償却費（定額法）
```python
年間減価償却費 = 建物価格 ÷ 償却年数
```

#### 所得税（簡易計算）
```python
不動産所得 = 家賃収入 - 経費 - 減価償却費
税金 = 不動産所得 × 実効税率
```

### 6. IRR（内部収益率）
Newton-Raphson法による数値計算で実装

## ❌ 未実装の計算（TODO）

### 1. 元金返済額
```python
# TODO: 各年の元金返済額を計算
# ローン返済額 - 利息部分 = 元金返済額
```

### 2. 借入残高
```python
# TODO: calculate_remaining_loan関数を活用
# 各年末の借入残高を計算
```

### 3. 自己資金回収率
```python
# TODO: 累計CF ÷ 自己資金 × 100
# 自己資金を何年で回収できるかの指標
```

### 4. 売却時手取り
```python
# TODO: 売却価格 - 売却コスト - 残債 - 税金
# 実際に手元に残る金額
```

## 📁 ファイル構成

```python
# shared/calculations.py の主要関数

def run_full_simulation(property_data):
    """メイン関数：全ての計算を実行"""
    
def calculate_basic_metrics(property_data):
    """基本指標の計算"""
    
def generate_cashflow_table(property_data, basic_metrics):
    """キャッシュフロー表の生成"""
    
def calculate_property_valuation(property_data):
    """物件評価の計算"""
    
def calculate_sale_analysis(property_data):
    """売却分析の計算"""
    
def calculate_irr(annual_cf, years, sale_profit, self_funding, annual_loan):
    """IRRの計算"""
```

## 🔧 計算ロジックの追加・修正方法

### 1. 新しい計算を追加する場合

```python
# shared/calculations.py に関数を追加
def calculate_new_metric(property_data):
    """新しい指標の計算"""
    # 計算ロジックを実装
    return result

# run_full_simulation内で呼び出し
new_metric = calculate_new_metric(property_data)
```

### 2. 既存の計算を修正する場合

1. 該当する関数を特定
2. 計算ロジックを修正
3. API検証手順に従ってテスト

## 📋 入力パラメータ一覧

| パラメータ名 | 型 | 説明 | 単位 |
|-------------|-----|------|------|
| purchase_price | float | 購入価格 | 万円 |
| monthly_rent | float | 月額賃料 | 円 |
| loan_amount | float | 借入額 | 万円 |
| interest_rate | float | 金利 | % |
| loan_years | int | 返済期間 | 年 |
| land_area | float | 土地面積 | ㎡ |
| building_area | float | 建物面積 | ㎡ |
| building_price | float | 建物価格 | 万円 |
| road_price | float | 路線価 | 円/㎡ |
| other_costs | float | 諸経費 | 万円 |
| renovation_cost | float | リフォーム費 | 万円 |
| management_fee | float | 管理費 | 円/月 |
| fixed_cost | float | その他固定費 | 円/月 |
| property_tax | float | 固定資産税 | 円/年 |
| vacancy_rate | float | 空室率 | % |
| rent_decline | float | 家賃下落率 | %/年 |
| holding_years | int | 保有年数 | 年 |
| exit_cap_rate | float | 売却Cap Rate | % |
| effective_tax_rate | float | 実効税率 | % |
| depreciation_years | int | 償却年数 | 年 |
| market_value | float | 想定売却価格 | 万円 |

---
作成日: 2025年7月28日
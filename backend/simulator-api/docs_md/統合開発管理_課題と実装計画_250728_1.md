# 不動産投資シミュレーター 統合開発管理
## 課題管理と実装計画

最終更新日: 2025年7月28日

## 🏗️ システム全体構成

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐     ┌──────────────┐
│   フロントエンド  │────▶│    Render.com    │────▶│ 計算ロジック     │     │   Supabase   │
│  (React/Vite)   │ API │   (FastAPI)      │     │(calculations.py)│     │ (データ保存)  │
│ dev.ooya.tech   │     │ xxx.onrender.com │     └─────────────────┘     └──────────────┘
└─────────────────┘     └──────────────────┘              │                      ▲
        ▲                         │                        └──────────────────────┘
        │      JSONレスポンス      │                           シミュレーション結果を保存
        └─────────────────────────┘
```

## 📡 API基本情報とSupabase連携

### デプロイ先
- **プラットフォーム**: Render.com
- **本番URL**: `https://real-estate-app-1-iii4.onrender.com`
- **フレームワーク**: FastAPI (Python)
- **データベース**: Supabase

### データフローとSupabase保存プロセス

1. **ユーザーがシミュレーション実行**
   ```javascript
   // フロントエンド側
   const response = await fetch(`${API_BASE_URL}/api/simulate`, {
       method: 'POST',
       headers: {
           'Content-Type': 'application/json',
           'Authorization': `Bearer ${userToken}` // ユーザー認証トークン
       },
       body: JSON.stringify(propertyData)
   });
   ```

2. **FastAPIで計算処理**
   ```python
   @app.post("/api/simulate")
   async def run_simulation(property_data: dict, user_id: str = Depends(get_current_user)):
       # 計算実行
       result = run_full_simulation(property_data)
       
       # Supabaseに保存
       simulation_record = {
           "user_id": user_id,
           "property_data": property_data,
           "simulation_results": result,
           "created_at": datetime.now().isoformat()
       }
       
       await supabase.table('simulations').insert(simulation_record).execute()
       
       return result
   ```

3. **ユーザーが過去のシミュレーションを閲覧**
   ```python
   @app.get("/api/simulations")
   async def get_user_simulations(user_id: str = Depends(get_current_user)):
       # Supabaseから取得
       response = await supabase.table('simulations')\
           .select("*")\
           .eq('user_id', user_id)\
           .order('created_at', desc=True)\
           .execute()
       
       return response.data
   ```

### Supabaseデータ構造
```sql
-- simulationsテーブル
CREATE TABLE simulations (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    property_data JSONB NOT NULL,
    simulation_results JSONB NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    is_favorite BOOLEAN DEFAULT FALSE,
    notes TEXT
);

-- インデックス
CREATE INDEX idx_simulations_user_id ON simulations(user_id);
CREATE INDEX idx_simulations_created_at ON simulations(created_at DESC);
```

## 📊 現在の課題一覧（優先度順）

### 🟢 実装済みだが改善が必要な指標
以下の指標は計算ロジック自体は実装済みですが、精度向上の余地があります：
- **NOI**: 実装済み（年間家賃収入 - 経費 - 固定資産税）
- **CCR**: 実装済み（税引後CF - ローン返済）÷ 自己資金
- **ROI**: 実装済み（税引後CF ÷ 自己資金）
- **DSCR**: 実装済み（NOI ÷ 年間ローン返済額）
- **IRR**: 実装済み（Newton-Raphson法による数値計算）
- **LTV**: 実装済み（借入額 ÷ 積算評価）※分母の見直しが必要
- **積算評価**: 実装済み（土地面積×路線価 + 建物面積×20万円）※精度向上が必要
- **収益還元評価**: 実装済み（NOI ÷ Cap Rate）※Cap Rate設定の改善が必要
- **実勢価格**: 入力値をそのまま使用 ※自動推定機能が未実装

### 🔴 Phase 1: 必須機能の実装（1-2日）- 値が0で表示されている項目

| No | 項目名 | 現在の状態 | 影響範囲 | 対応方法 | ステータス | GitHub | 見積時間 |
|----|--------|-----------|----------|----------|------------|--------|----------|
| 1 | **元金返済額** | 全年度で0円 | キャッシュフロー表 | `calculate_principal_payment()`関数を実装 | ✅ 完了 | 681cafd | 2時間 |
| 2 | **借入残高** | 全年度で0円 | キャッシュフロー表、売却分析 | `calculate_remaining_loan()`を各年で呼び出し | ✅ 完了 | 681cafd | 2時間 |
| 3 | **自己資金回収率** | 全年度で0% | 投資効率分析 | 累計CF ÷ 自己資金の計算を実装 | ✅ 完了 | 681cafd | 1時間 |
| 4 | **売却時手取り** | 全年度で0円 | 出口戦略分析 | 売却価格 - コスト - 残債 - 税金の計算 | ✅ 完了 | 681cafd | 3時間 |
| 5 | **実質利回り** | 未実装 | 投資分析 | (NOI - 税金) ÷ 購入価格 × 100 の計算を追加 | ✅ 完了 | 681cafd | 1時間 |

### 🟡 Phase 2: 計算精度の向上（3-5日）

| No | 項目名 | 現在の状態 | 影響範囲 | 対応方法 | ステータス | 見積時間 |
|----|--------|-----------|----------|----------|------------|----------|
| 5 | **売却金額の表示** | 10年目のみ表示 | キャッシュフロー表 | 各年での想定売却金額を計算・表示 | 🟡 要改善 | 2時間 |
| 6 | **LTV計算** | 分母が積算評価 | リスク分析 | 分母を購入価格または市場価値に変更検討 | 🟡 要改善 | 1時間 |
| 7 | **税金計算の詳細化** | 簡易計算のみ | 収支精度 | 所得税率テーブル、住民税、事業税の追加 | 🟡 要改善 | 4時間 |
| 8 | **減価償却の詳細計算** | 単純計算 | 税金計算 | 建物構造別、設備分離、定率法オプション | 🟡 要改善 | 3時間 |
| 9 | **積算評価の精度向上** | 建物単価固定（20万円/㎡） | 物件評価 | 建物構造・築年数による単価調整、地域別補正 | 🟡 要改善 | 3時間 |
| 10 | **収益還元評価の改善** | Cap Rate固定 | 物件評価 | 地域・物件タイプ別のCap Rate設定、市場データ連携 | 🟡 要改善 | 4時間 |
| 11 | **実勢価格の自動推定** | ユーザー入力のみ | 物件評価 | 積算・収益還元の加重平均、AI予測モデルの導入 | 🟡 要改善 | 5時間 |

### 🟢 Phase 3: 新機能の追加（1週間）

| No | 項目名 | 現在の状態 | 影響範囲 | 対応方法 | ステータス | 見積時間 |
|----|--------|-----------|----------|----------|------------|----------|
| 12 | **元金均等返済** | 未対応 | ローン計算 | loan_type判定を追加 | 🟢 機能追加 | 3時間 |
| 13 | **繰上返済シミュレーション** | 未実装 | 返済計画 | 新規機能として実装 | 🟢 機能追加 | 5時間 |
| 14 | **シナリオ分析機能** | 未実装 | リスク分析 | 金利変動、賃料下落シミュレーション | 🟢 機能追加 | 8時間 |
| 15 | **融資条件の最適化** | 未実装 | 投資判断 | 複数の融資パターン比較 | 🟢 機能追加 | 6時間 |
| 16 | **テストデータ削除機能** | 未実装 | データ管理 | Supabaseから特定ユーザーのテストデータを削除する機能 | 🟢 機能追加 | 2時間 |

## 📝 詳細な実装内容

### 1. 元金返済額の実装

**ファイル**: `shared/calculations.py`

**実装箇所**: `generate_cashflow_table()`関数内

```python
def calculate_principal_payment(loan_payment, remaining_loan, interest_rate):
    """元金返済額を計算"""
    monthly_interest = remaining_loan * 10000 * (interest_rate / 100 / 12)
    annual_interest = monthly_interest * 12
    principal_payment = loan_payment - annual_interest
    return max(0, principal_payment)

# generate_cashflow_table内で使用
for i in range(1, holding_years + 1):
    # 既存のコード...
    
    # 元金返済額の計算
    principal = calculate_principal_payment(
        loan_payment,
        remaining_loan,
        interest_rate
    )
    
    year_data["元金返済"] = int(principal)
```

### 2. 借入残高の実装

```python
# generate_cashflow_table内で使用
remaining = calculate_remaining_loan(
    loan_amount, 
    interest_rate, 
    loan_years, 
    i,  # 経過年数
    loan_type
)

year_data["借入残高"] = round(remaining, 2)  # 万円単位
```

### 3. 自己資金回収率の実装

```python
# 自己資金回収率の計算
if self_funding > 0:
    recovery_rate = (cum / (self_funding * 10000)) * 100
else:
    recovery_rate = 0

year_data["自己資金回収率"] = round(recovery_rate, 1)
```

### 4. 売却時手取りの実装

```python
def calculate_net_sale_proceeds(property_data, year, remaining_loan):
    """売却時手取り額を計算"""
    # 想定売却価格の計算（Cap Rate使用）
    noi = property_data.get('NOI', 0)
    exit_cap_rate = property_data.get('exit_cap_rate', 4)
    sale_price = (noi / (exit_cap_rate / 100)) / 10000  # 万円単位
    
    # 売却コスト（仲介手数料3% + 印紙代等）
    sale_cost = sale_price * 0.03 + 50
    
    # 簡易的な譲渡所得税計算（長期譲渡20%）
    purchase_price = property_data.get('purchase_price', 0)
    capital_gain = sale_price - purchase_price - sale_cost
    tax = capital_gain * 0.2 if capital_gain > 0 else 0
    
    # 手取り額
    net_proceeds = sale_price - sale_cost - remaining_loan - tax
    return net_proceeds
```

## 📊 実装状況ダッシュボード

```
Phase 1 (必須): [==========] 100% 完了 ✅
Phase 2 (精度): [----------] 0% 未着手
Phase 3 (新機能): [----------] 0% 未着手

全体進捗: [====------] 33% 完了
```

## ⚠️ 一時的な対応事項

| 項目 | 内容 | 対応日 | 元に戻す条件 |
|------|------|--------|------------|
| **開発用Renderインスタンス作成待ち** | 現在は本番用のRenderを使用中。develop専用インスタンスの作成が必要 | 2025/07/28 | 開発用Renderインスタンス作成後 |

## 🔧 実装手順とテスト

### 1. 開発フロー
1. **ローカル環境でのテスト**
   ```bash
   cd backend/simulator-api
   uvicorn app:app --reload --port 8000
   ```

2. **Swagger UIでの検証**
   - http://localhost:8000/docs
   - テストデータで各値が正しく計算されているか確認

3. **GitHubへのプッシュ**
   ```bash
   git add .
   git commit -m "fix: 元金返済額、借入残高、自己資金回収率、売却時手取りの計算を実装"
   git push origin develop
   ```

4. **Renderへの自動デプロイ**
   - GitHubプッシュ後、Renderが自動でデプロイ
   - 約5-10分で本番環境に反映

### 2. テストケース
1. **標準的な物件**
   - 購入価格: 5000万円
   - 借入額: 4500万円
   - 金利: 0.7%
   - 期間: 35年

2. **エッジケース**
   - 借入額0円（全額自己資金）
   - 賃料0円
   - 保有期間1年

## ✅ 完了基準

### Phase 1完了の条件
- [ ] API検証で0表示がない
- [ ] フロントエンドで正しく表示
- [ ] 基本的な計算の妥当性確認
- [ ] Supabaseへの保存が正常動作

### Phase 2完了の条件
- [ ] 税理士レビューでの承認
- [ ] 実際の確定申告書との照合
- [ ] エッジケースでの動作確認

### Phase 3完了の条件
- [ ] ユーザビリティテスト実施
- [ ] パフォーマンステスト合格
- [ ] セキュリティ監査通過

## 🛠️ 技術的な実装指針

### コーディング規約
1. **関数の単一責任**
   - 1関数1機能の原則
   - 30行以内を目安

2. **テスタビリティ**
   - 純粋関数として実装
   - 副作用の最小化

3. **ドキュメント**
   - 各関数にdocstring
   - 複雑な計算にはコメント

### Supabase連携の実装指針
1. **エラーハンドリング**
   - Supabase接続エラー時もAPIは正常レスポンス
   - 保存失敗時はログに記録

2. **データ整合性**
   - トランザクション処理
   - 楽観的ロックの実装

3. **パフォーマンス**
   - バッチ処理の活用
   - インデックスの適切な設定

## 📈 今後の拡張案

1. **AI機能の統合**
   - 物件評価の自動化
   - 投資判断のアドバイス生成

2. **外部API連携**
   - 不動産価格データベース
   - 金利情報の自動取得

3. **可視化機能**
   - グラフ生成API
   - PDFレポート出力

---
作成日: 2025年7月28日
次回レビュー予定: 2025年8月4日

## 更新履歴
- 2025/07/28: 実装優先順位ロードマップと課題管理表を統合
- 2025/07/28: Supabase連携の詳細を追加
# 不動産投資シミュレーター 課題管理表

最終更新日: 2025年7月28日

## 📊 課題一覧

### 🔴 優先度：高（値が0で表示されている項目）

| No | 項目名 | 現在の状態 | 影響範囲 | 対応方法 | ステータス |
|----|--------|-----------|----------|----------|------------|
| 1 | **元金返済額** | 全年度で0円 | キャッシュフロー表 | `calculate_principal_payment()`関数を実装 | 🔴 未着手 |
| 2 | **借入残高** | 全年度で0円 | キャッシュフロー表、売却分析 | `calculate_remaining_loan()`を各年で呼び出し | 🔴 未着手 |
| 3 | **自己資金回収率** | 全年度で0% | 投資効率分析 | 累計CF ÷ 自己資金の計算を実装 | 🔴 未着手 |
| 4 | **売却時手取り** | 全年度で0円 | 出口戦略分析 | 売却価格 - コスト - 残債 - 税金の計算 | 🔴 未着手 |

### 🟡 優先度：中（計算は実装済みだが要改善）

| No | 項目名 | 現在の状態 | 影響範囲 | 対応方法 | ステータス |
|----|--------|-----------|----------|----------|------------|
| 5 | **売却金額の表示** | 10年目のみ表示 | キャッシュフロー表 | 各年での想定売却金額を計算・表示 | 🟡 要改善 |
| 6 | **LTV計算** | 分母が積算評価 | リスク分析 | 分母を購入価格または市場価値に変更検討 | 🟡 要改善 |

### 🟢 優先度：低（機能追加）

| No | 項目名 | 現在の状態 | 影響範囲 | 対応方法 | ステータス |
|----|--------|-----------|----------|----------|------------|
| 7 | **元金均等返済** | 未対応 | ローン計算 | loan_type判定を追加 | 🟢 機能追加 |
| 8 | **繰上返済シミュレーション** | 未実装 | 返済計画 | 新規機能として実装 | 🟢 機能追加 |

## 📝 詳細な対応方法

### 1. 元金返済額の実装

**ファイル**: `shared/calculations.py`

**実装箇所**: `generate_cashflow_table()`関数内

```python
def calculate_principal_payment(loan_payment, remaining_loan, interest_rate):
    """元金返済額を計算"""
    monthly_interest = remaining_loan * 10000 * (interest_rate / 100 / 12)
    annual_interest = monthly_interest * 12
    principal_payment = loan_payment - annual_interest
    return max(0, principal_payment)
```

**修正内容**:
- 各年のループ内で上記関数を呼び出し
- `元金返済`フィールドに値を設定

### 2. 借入残高の実装

**実装箇所**: `generate_cashflow_table()`関数内

```python
# 既存のcalculate_remaining_loan関数を活用
remaining = calculate_remaining_loan(
    loan_amount, 
    interest_rate, 
    loan_years, 
    i,  # 経過年数
    loan_type
)
```

**修正内容**:
- 各年のループ内で残高を計算
- `借入残高`フィールドに値を設定（万円単位）

### 3. 自己資金回収率の実装

**実装箇所**: `generate_cashflow_table()`関数内

```python
# 自己資金回収率の計算
if self_funding > 0:
    recovery_rate = (cum / (self_funding * 10000)) * 100
else:
    recovery_rate = 0
```

**修正内容**:
- 累計CFを自己資金で割って計算
- パーセンテージで表示

### 4. 売却時手取りの実装

**実装箇所**: `generate_cashflow_table()`関数内

```python
def calculate_net_sale_proceeds(sale_price, sale_cost, remaining_loan, tax_rate):
    """売却時手取り額を計算"""
    # 簡易的な譲渡所得税計算
    capital_gain = sale_price - purchase_price - sale_cost
    tax = capital_gain * 0.2 if capital_gain > 0 else 0
    
    net_proceeds = sale_price - sale_cost - remaining_loan - tax
    return net_proceeds
```

**修正内容**:
- 各年での売却を想定した手取り額を計算
- 譲渡所得税も考慮

## 🔧 実装手順

1. **バックアップ作成**
   ```bash
   cp shared/calculations.py shared/calculations.py.backup
   ```

2. **計算ロジックの修正**
   - 上記の対応方法に従って実装

3. **テスト実行**
   ```bash
   # API検証手順.mdに従ってテスト
   uvicorn app:app --reload
   ```

4. **結果確認**
   - Swagger UIで0だった値が正しく計算されているか確認

## 📈 進捗管理

### 完了条件
- [ ] すべての0表示が解消される
- [ ] 計算結果の妥当性が確認される
- [ ] フロントエンドで正しく表示される

### テストケース
1. 標準的な物件（テストデータ）での動作確認
2. 極端な値（借入0、賃料0など）でのエラーハンドリング
3. 長期保有（30年以上）での計算精度

## 🚀 今後の拡張案

1. **詳細な税金計算**
   - 減価償却の詳細計算
   - 譲渡所得税の正確な計算

2. **リスク分析機能**
   - 金利上昇シミュレーション
   - 空室率変動シミュレーション

3. **複数物件対応**
   - ポートフォリオ全体の分析

---
作成日: 2025年7月28日
作成者: Claude

## 更新履歴
- 2025/07/28: 初版作成
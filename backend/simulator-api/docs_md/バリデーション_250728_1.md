# 不動産投資シミュレーター バリデーション仕様書

**ファイル名**: バリデーション_250728_1.md  
**最終更新日**: 2025年7月28日

## 概要
不動産投資シミュレーターのフォーム入力項目に対するバリデーションの現状をまとめたドキュメントです。

## 変更履歴
- **2025年7月28日**: UIで「必須」と表示されているセクション内の項目をすべて必須項目として実装

## 現状のバリデーション状況（更新版）

### フロントエンド（React）

#### 必須項目チェック（2025年7月28日更新）
- **実装状況**: UIで「必須」と表示されているセクション内のすべての項目を必須として実装
- **チェック対象**: 
  
  **🏠 物件情報（必須）**
  - `propertyName`（物件名）: 必須
  - `location`（所在地）: 必須
  - `yearBuilt`（建築年）: 必須、0より大きい値
  - `propertyType`（建物構造）: 必須
  
  **💰 取得・初期費用（必須）**
  - `purchasePrice`（物件価格）: 必須、0より大きい値
  
  **📈 収益情報（必須）**
  - `monthlyRent`（月額賃料）: 必須、0より大きい値
  
  **🏦 借入条件（必須）**
  - `loanAmount`（借入額）: 必須、0以上の値
  - `interestRate`（金利）: 必須、0以上の値
  - `loanYears`（借入年数）: 必須、0より大きい値
  - `loanType`（借入タイプ）: 必須
  
  **🎯 出口戦略（必須）**
  - `holdingYears`（保有年数）: 必須、0より大きい値
  - `exitCapRate`（売却時想定Cap Rate）: 必須、0より大きい値

#### バリデーションロジック（更新版）
```typescript
// bolt_front/src/pages/Simulator.tsx
const isFormValid = 
  // 物件情報（必須）
  inputs.propertyName && 
  inputs.location &&
  inputs.yearBuilt > 0 &&
  inputs.propertyType &&
  // 取得・初期費用（必須）
  inputs.purchasePrice > 0 &&
  // 収益情報（必須）
  inputs.monthlyRent > 0 &&
  // 借入条件（必須）
  inputs.loanAmount >= 0 &&
  inputs.interestRate >= 0 &&
  inputs.loanYears > 0 &&
  inputs.loanType &&
  // 出口戦略（必須）
  inputs.holdingYears > 0 &&
  inputs.exitCapRate > 0;
```

#### 改善された問題点
- ~~**建築年（year_built）**: バリデーションなし（未入力でも実行可能）~~ → **修正済み**
- ~~**所在地（location）**: バリデーションなし~~ → **修正済み**
- **その他の重要項目**: 数値の範囲チェックなし（今後の課題）

#### その他のバリデーション
- **URLバリデーション**: 物件URLの形式チェックのみ実装
  - `bolt_front/src/utils/validation.ts`に`validatePropertyUrl`関数あり

### バックエンド（FastAPI）

#### バリデーション状況
- **型チェック**: なし（Pydanticモデル未使用）
- **必須項目チェック**: なし
- **デフォルト値処理**: `dict.get()`メソッドでデフォルト値を設定

#### 実装例
```python
# backend/simulator-api/app.py
year_built = request.get('year_built', 2000)  # デフォルト値: 2000年
```

```python
# backend/simulator-api/shared/calculations.py
monthly_rent = property_data.get('monthly_rent', 0)
vacancy_rate = property_data.get('vacancy_rate', 0)
```

## 推奨される改善点

### 1. フロントエンドの改善

#### 必須項目の拡張
以下の項目を必須にすることを推奨：
- `year_built`（建築年）
- `location`（所在地）
- `monthly_rent`（月額賃料）
- `loan_type`（借入タイプ）
- `ownership_type`（所有形態）

#### 数値範囲のバリデーション
- 建築年: 1900〜現在年
- 物件価格: 1万円〜10億円
- 金利: 0.1%〜15%
- 空室率: 0%〜100%

### 2. バックエンドの改善

#### Pydanticモデルの導入
```python
from pydantic import BaseModel, Field, validator

class PropertyData(BaseModel):
    property_name: str = Field(..., min_length=1)
    year_built: int = Field(..., ge=1900, le=2025)
    purchase_price: float = Field(..., gt=0)
    # ... その他のフィールド
    
    @validator('year_built')
    def validate_year_built(cls, v):
        current_year = datetime.now().year
        if v > current_year:
            raise ValueError('建築年は現在年以前である必要があります')
        return v
```

### 3. エラーメッセージの改善
- ユーザーフレンドリーなエラーメッセージの表示
- 複数のバリデーションエラーの一括表示
- 日本語でのエラーメッセージ提供

## セキュリティ上の考慮事項
- SQLインジェクション対策（現在はデータベース未使用のため問題なし）
- XSS対策（Reactのデフォルト機能で対応済み）
- 数値のオーバーフロー対策

## まとめ
現在のシステムでは最小限のバリデーションのみ実装されており、多くの項目が未入力でもシミュレーションが実行可能な状態です。データの整合性とユーザビリティ向上のため、フロントエンド・バックエンド両方でのバリデーション強化が推奨されます。
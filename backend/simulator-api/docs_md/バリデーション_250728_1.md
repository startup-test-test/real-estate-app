# 不動産投資シミュレーター バリデーション仕様書

**ファイル名**: バリデーション_250728_1.md  
**最終更新日**: 2025年8月10日  
**バージョン**: 3.0.0（統合版）

## 概要
不動産投資シミュレーターのフォーム入力項目に対するバリデーションの仕様と実装状況を統合したドキュメントです。

## 変更履歴
- **2025年7月28日**: UIで「必須」と表示されているセクション内の項目をすべて必須項目として実装
- **2025年8月10日**: 大幅なバリデーション強化
  - BUG_008: ゼロ値バリデーション追加（NaN/Infinityエラー防止）
  - BUG_009: 全フィールドに上限値チェック追加
  - BUG_010: 必須項目チェック強化（エラーメッセージ表示、自動スクロール）
  - BUG_011: 全角数字変換機能追加（０-９ → 0-9）
  - BUG_012: 建築年の範囲を未来5年まで許可（建設予定物件対応）
  - BUG_013: 表面利回り99%制限実装
  - BUG_014: ローン期間最大50年制限実装

## 現状のバリデーション状況（更新版）

### フロントエンド（React）

#### 必須項目チェック（2025年7月28日更新）
- **実装状況**: UIで「必須」と表示されているセクション内のすべての項目を必須として実装
- **チェック対象**: 
  
  **🏠 物件情報（必須）**
  - `propertyName`（物件名）: 必須
  - `location`（所在地）: 必須
  - `yearBuilt`（建築年）: 必須、0より大きい値
  - `propertyType`（建物構造）: 必須
  
  **💰 取得・初期費用（必須）**
  - `purchasePrice`（物件価格）: 必須、0より大きい値
  
  **📈 収益情報（必須）**
  - `monthlyRent`（月額賃料）: 必須、0より大きい値
  
  **🏦 借入条件（必須）**
  - `loanAmount`（借入額）: 必須、0以上の値
  - `interestRate`（金利）: 必須、0以上の値
  - `loanYears`（借入年数）: 必須、0より大きい値
  - `loanType`（借入タイプ）: 必須
  
  **🎯 出口戦略（必須）**
  - `holdingYears`（保有年数）: 必須、0より大きい値
  - `exitCapRate`（売却時想定Cap Rate）: 必須、0より大きい値

#### バリデーションロジック（更新版）
```typescript
// bolt_front/src/pages/Simulator.tsx
const isFormValid = 
  // 物件情報（必須）
  inputs.propertyName && 
  inputs.location &&
  inputs.yearBuilt > 0 &&
  inputs.propertyType &&
  // 取得・初期費用（必須）
  inputs.purchasePrice > 0 &&
  // 収益情報（必須）
  inputs.monthlyRent > 0 &&
  // 借入条件（必須）
  inputs.loanAmount >= 0 &&
  inputs.interestRate >= 0 &&
  inputs.loanYears > 0 &&
  inputs.loanType &&
  // 出口戦略（必須）
  inputs.holdingYears > 0 &&
  inputs.exitCapRate > 0;
```

#### 改善された問題点
- ~~**建築年（year_built）**: バリデーションなし（未入力でも実行可能）~~ → **修正済み**
- ~~**所在地（location）**: バリデーションなし~~ → **修正済み**
- **その他の重要項目**: 数値の範囲チェックなし（今後の課題）

#### その他のバリデーション
- **URLバリデーション**: 物件URLの形式チェックのみ実装
  - `bolt_front/src/utils/validation.ts`に`validatePropertyUrl`関数あり

### バックエンド（FastAPI）

#### バリデーション状況
- **型チェック**: なし（Pydanticモデル未使用）
- **必須項目チェック**: なし
- **デフォルト値処理**: `dict.get()`メソッドでデフォルト値を設定

#### 実装例
```python
# backend/simulator-api/app.py
year_built = request.get('year_built', 2000)  # デフォルト値: 2000年
```

```python
# backend/simulator-api/shared/calculations.py
monthly_rent = property_data.get('monthly_rent', 0)
vacancy_rate = property_data.get('vacancy_rate', 0)
```

## 推奨される改善点

### 1. フロントエンドの改善

#### 必須項目の拡張
以下の項目を必須にすることを推奨：
- `year_built`（建築年）
- `location`（所在地）
- `monthly_rent`（月額賃料）
- `loan_type`（借入タイプ）
- `ownership_type`（所有形態）

#### 数値範囲のバリデーション
- 建築年: 1900〜現在年
- 物件価格: 1万円〜10億円
- 金利: 0.1%〜15%
- 空室率: 0%〜100%

### 2. バックエンドの改善

#### Pydanticモデルの導入
```python
from pydantic import BaseModel, Field, validator

class PropertyData(BaseModel):
    property_name: str = Field(..., min_length=1)
    year_built: int = Field(..., ge=1900, le=2025)
    purchase_price: float = Field(..., gt=0)
    # ... その他のフィールド
    
    @validator('year_built')
    def validate_year_built(cls, v):
        current_year = datetime.now().year
        if v > current_year:
            raise ValueError('建築年は現在年以前である必要があります')
        return v
```

### 3. エラーメッセージの改善
- ユーザーフレンドリーなエラーメッセージの表示
- 複数のバリデーションエラーの一括表示
- 日本語でのエラーメッセージ提供

## セキュリティ上の考慮事項
- SQLインジェクション対策（現在はデータベース未使用のため問題なし）
- XSS対策（Reactのデフォルト機能で対応済み）
- 数値のオーバーフロー対策

## 実装済みバリデーション詳細

### 1. 必須項目チェック（BUG_010）
**実装場所**: `bolt_front/src/pages/Simulator.tsx` L472-496

#### 必須項目
- 物件名（propertyName）
- 所在地（location）
- 建築年（yearBuilt）
- 建物構造（propertyType）
- 物件価格（purchasePrice）
- 月額賃料（monthlyRent）

#### 動作
- 未入力時にエラーメッセージ表示
- 最初のエラーフィールドに自動スクロール
- フィールドごとのエラー表示

### 2. ゼロ値バリデーション（BUG_008）
**実装場所**: `bolt_front/src/pages/Simulator.tsx` L498-529

#### チェック対象
- 物件価格: 0より大きい値必須
- 月額賃料: 0より大きい値必須

#### 動作
- NaN/Infinityエラーを防止
- 「0より大きい値を入力してください」のエラー表示

### 3. 上限値チェック（BUG_009）
**実装場所**: `bolt_front/src/pages/Simulator.tsx` L531-581

#### 各フィールドの上限値
| フィールド | 上限値 | エラーメッセージ |
|-----------|--------|-----------------|
| 物件価格 | 100億円（1,000,000万円） | 物件価格は100億円以下で入力してください |
| 月額賃料 | 1,000万円 | 月額賃料は1000万円以下で入力してください |
| 借入期間 | 50年 | 借入期間は50年以下で入力してください |
| 金利 | 20% | 金利は20%以下で入力してください |
| 保有期間 | 50年 | 保有期間は50年以下で入力してください |
| 管理手数料 | 月額賃料の50% | 管理手数料は月額賃料の50%以下で入力してください |

### 4. 建築年の範囲チェック（BUG_012）
**実装場所**: `bolt_front/src/pages/Simulator.tsx` L559-565

#### 許可範囲
- 最小値: 1900年
- 最大値: 現在年 + 5年（建設予定物件対応）

#### 特別な表示
- 未来の年の場合: 「建設予定（YYYY年完成予定）」と表示
- 過去の年の場合: 「築XX年（YYYY年現在）」と表示

### 5. 表面利回り制限（BUG_013）
**実装場所**: `bolt_front/src/pages/Simulator.tsx` L531-542

#### 制限値
- 最大表面利回り: 99%
- 計算式: (月額賃料 × 12) / 物件価格 × 100

### 6. 全角数字変換（BUG_011）
**実装場所**: `bolt_front/src/pages/Simulator.tsx` L282-299

#### 変換対象
- 全角数字（０-９）→ 半角数字（0-9）
- 全角ピリオド（．）→ 半角ピリオド（.）
- 全角カンマ（，）→ 半角カンマ（,）→ 削除

#### 注意事項
- type="number"のHTML制限により、実際の全角入力は制限される場合あり

## 今後の実装予定

### 中優先度
- BUG_005: 管理手数料％入力パーサー（「5%」と入力して自動計算）
- BUG_015: 自動計算タイミング（手動変更の保持）
- BUG_016: カンマ付き数値処理（「1,234,567」のコピペ対応）
- BUG_020: 文字数上限（物件名200文字制限）

### 低優先度
- BUG_006: 最小値での利回り計算
- BUG_007: 大数値の表示形式（カンマ区切り）
- BUG_017: 浮動小数点精度
- BUG_018: エラー復帰処理

## バックエンド対応状況

現在、バックエンドではバリデーションが実装されていません。
フロントエンドでのバリデーションのみで対応しています。

### 推奨事項
- Pydanticモデルの導入
- APIレベルでのバリデーション実装
- エラーレスポンスの統一化

## まとめ
2025年8月10日時点で、フロントエンドに6種類の主要なバリデーションを実装済みです。データの整合性とユーザビリティは大幅に向上しましたが、バックエンドでのバリデーション実装が今後の課題として残っています。
backend/property-api/不動産情報ライブラリのapiの仕様書/不動産情報ライブラリのapi仕様書_250919_1.md+34.7%# Backend Property API 仕様書

## 概要
不動産取引価格検索と分析を行うStreamlitベースのWebアプリケーション。国土交通省の不動産情報ライブラリAPIと連携して、不動産取引データの検索・分析・可視化機能を提供します。

## システムアーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                        ユーザーインターフェース                     │
│                         (Streamlit Web App)                      │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                     streamlit_app.py                            │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐ │
│  │   検索UI    │   分析機能   │   可視化    │   データ表示  │ │
│  └──────────────┴──────────────┴──────────────┴──────────────┘ │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                   real_estate_client.py                         │
│                    (APIクライアント層)                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  ・search_real_estate_prices()  ・get_prefectures()     │  │
│  │  ・search_land_prices()         ・get_cities()          │  │
│  │  ・search_land_price_history()  ・get_districts()       │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │ HTTP/HTTPS
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│              国土交通省 不動産情報ライブラリAPI                    │
│  ┌──────────────┬──────────────┬──────────────────────────┐   │
│  │   XIT001    │   XCT001    │       XKY001              │   │
│  │ 取引価格情報  │  公示地価情報  │   市区町村マスタ         │   │
│  └──────────────┴──────────────┴──────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 技術スタック
- **フレームワーク**: Streamlit
- **言語**: Python 3.x
- **主要ライブラリ**:
  - pandas: データ処理
  - plotly: グラフ可視化
  - scikit-learn: 機械学習（KMeans, IsolationForest）
  - scipy: 統計分析
  - requests: API通信

## ディレクトリ構成
```
backend/property-api/
├── streamlit_app.py          # メインアプリケーション
├── real_estate_client.py     # API クライアント
├── requirements.txt           # 依存パッケージ
├── README.md                 # 本ドキュメント
├── streamlit-access-guide.md  # アクセスガイド
└── test_*.py                 # 各種テストファイル
```

## 主要コンポーネント

### 1. streamlit_app.py（メインアプリケーション）
不動産検索と分析機能を提供するStreamlitアプリケーション

#### 主要機能
1. **検索機能**
   - 都道府県・市区町村・地区による絞り込み
   - 物件種別（マンション、戸建、土地）選択
   - 面積・建築年による条件指定
   - 取引時期の指定（年・四半期）

2. **AI市場分析機能**
   - KMeansクラスタリング分析
   - Isolation Forestによる異常値検出
   - 線形回帰による価格トレンド分析
   - 統計的有意性検定（t検定）

3. **可視化機能**
   - 延べ床面積と価格の散布図
   - 建築年と価格の関係グラフ
   - 価格分布ヒストグラム
   - 価格トレンドの時系列グラフ
   - 成約件数推移
   - 公示地価の表示と推移グラフ

4. **データ表示**
   - 検索結果のテーブル表示
   - 類似物件の自動抽出
   - 統計情報（平均、中央値、標準偏差）
   - 価格レンジ分析（下位25%、中央値、上位25%）

### 2. real_estate_client.py（APIクライアント）

#### クラス: RealEstateAPIClient

##### メソッド一覧

##### `__init__(self)`
APIクライアントの初期化
- APIキー設定
- エンドポイントURL設定
- HTTPヘッダー設定

##### `search_real_estate_prices(self, prefecture, city, district, property_type, year, quarter, min_area, max_area, min_year, max_year)`
不動産取引価格を検索

**パラメータ:**
- `prefecture` (str): 都道府県コード
- `city` (str, optional): 市区町村コード
- `district` (str, optional): 地区名
- `property_type` (str): 物件種別（"マンション", "戸建", "土地"）
- `year` (int): 取引年
- `quarter` (int): 四半期（1-4）
- `min_area` (float, optional): 最小面積
- `max_area` (float, optional): 最大面積
- `min_year` (int, optional): 最小建築年
- `max_year` (int, optional): 最大建築年

**戻り値:**
- List[Dict]: 検索結果のリスト

##### `search_land_prices(self, prefecture, city, district, year)`
公示地価データを取得（XCT001エンドポイント）

**パラメータ:**
- `prefecture` (str): 都道府県コード
- `city` (str, optional): 市区町村名
- `district` (str, optional): 地区名
- `year` (str): 年度（2021-2024）

**戻り値:**
- List[Dict]: 公示地価データのリスト

##### `search_land_price_history(self, prefecture, city, district, start_year, end_year)`
公示地価の履歴データを取得

**パラメータ:**
- `prefecture` (str): 都道府県コード
- `city` (str, optional): 市区町村名
- `district` (str, optional): 地区名
- `start_year` (str): 開始年
- `end_year` (str): 終了年

**戻り値:**
- Dict: 年ごとの価格データ

##### `get_prefectures(self)`
都道府県リストを取得

**戻り値:**
- List[Dict]: 都道府県のコードと名前のリスト

##### `get_cities(self, prefecture_code)`
市区町村リストを取得

**パラメータ:**
- `prefecture_code` (str): 都道府県コード

**戻り値:**
- List[Dict]: 市区町村のコードと名前のリスト

##### `get_districts(self, prefecture_code, municipality_code)`
地区リストを取得

**パラメータ:**
- `prefecture_code` (str): 都道府県コード
- `municipality_code` (str, optional): 市区町村コード

**戻り値:**
- List[str]: 地区名のリスト

## API エンドポイント

### 不動産情報ライブラリAPI

#### 1. XIT001 - 不動産取引価格情報API
- **URL**: `https://www.reinfolib.mlit.go.jp/ex-api/external/XIT001`
- **用途**: 実際の取引価格データ取得
- **データ期間**: 2005年〜現在

#### 2. XCT001 - 鑑定評価書情報API（公示地価）
- **URL**: `https://www.reinfolib.mlit.go.jp/ex-api/external/XCT001`
- **用途**: 公示地価データ取得
- **データ期間**: 2021年〜2024年

#### 3. XKY001 - 都道府県内市区町村一覧API
- **URL**: `https://www.reinfolib.mlit.go.jp/ex-api/external/XKY001`
- **用途**: 市区町村マスタデータ取得

## データフロー図

```
┌──────────────┐     検索条件      ┌─────────────────┐
│              │ ──────────────▶  │                 │
│   ユーザー    │                  │  Streamlit UI   │
│              │ ◀──────────────  │                 │
└──────────────┘     検索結果      └─────────────────┘
                                          │
                                          ▼
                              ┌─────────────────────┐
                              │   データ処理層      │
                              │  ┌──────────────┐  │
                              │  │条件バリデート │  │
                              │  └──────────────┘  │
                              │  ┌──────────────┐  │
                              │  │ APIコール    │  │
                              │  └──────────────┘  │
                              │  ┌──────────────┐  │
                              │  │ データ整形   │  │
                              │  └──────────────┘  │
                              └─────────────────────┘
                                          │
                                          ▼
                              ┌─────────────────────┐
                              │    分析処理層       │
                              │  ┌──────────────┐  │
                              │  │ 統計分析     │  │
                              │  ├──────────────┤  │
                              │  │ AI分析       │  │
                              │  │ ・KMeans     │  │
                              │  │ ・Isolation  │  │
                              │  │   Forest     │  │
                              │  ├──────────────┤  │
                              │  │ 可視化処理   │  │
                              │  └──────────────┘  │
                              └─────────────────────┘
```

## 環境変数
```
VITE_REAL_ESTATE_API_KEY  # 不動産情報ライブラリAPIキー
```

## 依存パッケージ (requirements.txt)
```
streamlit
pandas
plotly
scikit-learn
scipy
python-dotenv
requests
```

## データフィールド仕様

### 取引価格データ
| フィールド名 | 型 | 説明 |
|------------|---|-----|
| 物件種別 | str | マンション/戸建/土地 |
| 取引価格（万円） | int | 実際の取引価格 |
| 延べ床面積（㎡） | float | 建物の延床面積 |
| 土地面積（㎡） | float | 土地の面積 |
| 建築年 | int | 建物の建築年 |
| 最寄駅 | str | 最寄り駅名 |
| 駅距離（分） | int | 駅からの徒歩分数 |
| 所在地 | str | 物件所在地 |
| 取引時期 | str | 取引年・四半期 |
| 間取り | str | 部屋の間取り |
| 構造 | str | 建物構造 |
| 用途 | str | 建物用途 |

### 公示地価データ
| フィールド名 | 型 | 説明 |
|------------|---|-----|
| 標準地　所在地 | str | 標準地の住所 |
| 1㎡当たりの価格 | int | 平方メートル単価 |
| 標準地　交通施設 | str | 最寄り駅 |
| 標準地　距離 | int | 駅からの距離（m） |
| 用途地域 | str | 用途地域区分 |

## APIコール処理フロー

```
【検索処理の流れ】

1. ユーザー入力
   ┌────────────────┐
   │ 検索条件入力    │
   │ ・都道府県      │
   │ ・市区町村      │
   │ ・物件種別      │
   │ ・面積範囲      │
   └────────┬───────┘
            │
            ▼
2. パラメータ変換
   ┌────────────────┐
   │ コード変換処理  │
   │ 埼玉県 → "11"   │
   │ マンション → "2"│
   └────────┬───────┘
            │
            ▼
3. API呼び出し
   ┌────────────────┐
   │ HTTPリクエスト  │
   │ Headers:        │
   │  API-KEY: xxxx  │
   │ Params:         │
   │  area=11        │
   │  type=2         │
   └────────┬───────┘
            │
            ▼
4. レスポンス処理
   ┌────────────────┐
   │ JSON解析        │
   │ エラーチェック   │
   │ データ整形      │
   └────────┬───────┘
            │
            ▼
5. データ分析
   ┌────────────────┐
   │ 統計処理        │
   │ AI分析         │
   │ グラフ生成      │
   └────────┬───────┘
            │
            ▼
6. 結果表示
   ┌────────────────┐
   │ テーブル表示    │
   │ グラフ表示      │
   │ 分析結果表示    │
   └────────────────┘
```

## 機能詳細

### AI市場分析機能

#### 1. クラスタリング分析
- **アルゴリズム**: KMeans
- **特徴量**: 価格、延べ床面積
- **クラスタ数**: 3（自動調整）
- **用途**: 物件の価格帯別グルーピング

#### 2. 異常値検出
- **アルゴリズム**: Isolation Forest
- **汚染率**: 0.05（5%を異常値として検出）
- **用途**: 相場から外れた物件の特定

#### 3. 価格トレンド分析
- **手法**: 線形回帰
- **統計検定**: t検定（p値0.05）
- **表示**: 年間変化率（%）

#### 4. 統計分析
- **IQR法**: 四分位範囲による外れ値検出
- **価格レンジ**: 25%、50%、75%パーセンタイル

### セキュリティと法的配慮

#### 1. 法律遵守
- 宅建業法に準拠した表現
- 金融商品取引法に配慮
- AI分析は統計的傾向の提示に留める
- 将来予測や投資助言は行わない

#### 2. データ保護
- APIキーの環境変数管理
- 個人情報の非保持

## 主要画面構成

```
┌─────────────────────────────────────────────────────┐
│                  不動産価格検索システム                  │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────────────────────────────────────┐  │
│  │            検索条件エリア                      │  │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐   │  │
│  │  │都道府県│ │市区町村│ │ 地区  │ │物件種別│   │  │
│  │  └──────┘ └──────┘ └──────┘ └──────┘   │  │
│  │  ┌──────────────┐ ┌──────────────┐       │  │
│  │  │ 面積範囲       │ │ 建築年範囲    │       │  │
│  │  └──────────────┘ └──────────────┘       │  │
│  │              [🔍 検索実行]                    │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│  ┌─────────────────────────────────────────────┐  │
│  │            検索結果・分析エリア                │  │
│  │                                               │  │
│  │  📊 検索結果: XX件                            │  │
│  │  ┌────────────────────────────────────────┐  │  │
│  │  │ No │ 物件種別 │ 価格 │ 面積 │ 所在地   │  │  │
│  │  ├────┼─────────┼──────┼──────┼─────────┤  │  │
│  │  │ 1  │マンション│3,500万│ 75㎡ │大宮区... │  │  │
│  │  │ 2  │マンション│2,800万│ 65㎡ │浦和区... │  │  │
│  │  └────────────────────────────────────────┘  │  │
│  │                                               │  │
│  │  📈 AI市場分析                                │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐   │  │
│  │  │価格分布   │ │価格推移   │ │クラスター │   │  │
│  │  │          │ │          │ │ 分析     │   │  │
│  │  └──────────┘ └──────────┘ └──────────┘   │  │
│  │                                               │  │
│  │  📍 公示地価情報                              │  │
│  │  ┌────────────────────────────────────────┐  │  │
│  │  │ 所在地 │ 価格/㎡ │ 坪単価 │ 最寄駅    │  │  │
│  │  └────────────────────────────────────────┘  │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## 起動方法とアクセス手順

### 開発環境での起動
```bash
cd /workspaces/real-estate-app/backend/property-api
streamlit run streamlit_app.py --server.headless true --server.port 8501 --server.address 0.0.0.0
```

### 本番環境での起動
```bash
streamlit run streamlit_app.py --server.port 8501 --server.headless true --server.address 0.0.0.0
```

### VSCode/GitHub Codespacesでのアクセス

#### 1. ポートタブ経由でアクセス
1. VSCodeの「ポート」タブを開く
2. ポート8501が表示されていることを確認
3. ポート8501の「可視性」を「Public」に設定
4. 「ブラウザで開く」アイコンをクリック

#### 2. 直接URLでアクセス（推奨）
GitHub Codespacesの場合：
```bash
# Codespace名を取得
echo $CODESPACE_NAME

# 以下のURL形式でアクセス
https://[CODESPACE_NAME]-8501.app.github.dev
```

### 起動オプション詳細
| オプション | 説明 |
|-----------|------|
| --server.headless true | ブラウザの自動起動を無効化 |
| --server.port 8501 | ポート番号を指定 |
| --server.address 0.0.0.0 | 外部からのアクセスを許可 |
| --server.enableCORS false | CORS制限を無効化（必要時） |

### 起動確認
正常に起動すると以下が表示されます：
- 🏢 不動産取引価格検索システム
- 左サイドバーに検索条件入力フォーム
- 都道府県選択で市区町村が動的に更新される機能

## テストファイル

| ファイル名 | 説明 |
|-----------|------|
| test_api.py | 基本的なAPI接続テスト |
| test_check_format.py | APIレスポンスフォーマット確認 |
| test_kodate.py | 戸建物件検索テスト |
| test_land_price.py | 公示地価API基本テスト |
| test_land_price_debug.py | 公示地価APIフィールド確認 |
| test_land_price_demo.py | 公示地価デモンストレーション |
| test_land_price_detail.py | 公示地価詳細分析 |
| test_mansion_fields.py | マンションフィールドテスト |
| test_raw_data.py | 生データ確認 |
| test_station_only.py | 駅指定検索テスト |
| test_station_search.py | 駅検索機能テスト |
| test_xct001_api.py | XCT001エンドポイントテスト |

## エラー処理とステータスコード

### HTTPステータスコード一覧

| ステータスコード | 説明 | 対処法 |
|---------------|------|--------|
| 200 | 正常処理 | データ処理を継続 |
| 204 | コンテンツなし | 空配列として処理 |
| 400 | 不正なリクエスト | パラメータを確認 |
| 401 | 認証失敗 | APIキーを確認 |
| 403 | アクセス禁止 | 権限を確認 |
| 404 | リソース未発見 | URLを確認 |
| 429 | レート制限超過 | 60秒待機後リトライ |
| 500 | サーバーエラー | 時間を置いて再試行 |
| 503 | サービス利用不可 | メンテナンス確認 |

### アプリケーションエラーコード

```python
# カスタムエラーコード定義
class ErrorCode:
    # API関連エラー (E1xxx)
    E1001 = "APIキー未設定"
    E1002 = "APIキー無効"
    E1003 = "API接続タイムアウト"
    E1004 = "APIレート制限超過"
    E1005 = "APIレスポンス形式エラー"

    # データ処理エラー (E2xxx)
    E2001 = "検索結果なし"
    E2002 = "データ形式不正"
    E2003 = "必須フィールド欠損"
    E2004 = "数値変換エラー"
    E2005 = "日付形式エラー"

    # 入力検証エラー (E3xxx)
    E3001 = "都道府県未選択"
    E3002 = "無効な都道府県コード"
    E3003 = "無効な年度指定"
    E3004 = "面積範囲エラー"
    E3005 = "建築年範囲エラー"

    # 分析処理エラー (E4xxx)
    E4001 = "データ不足（10件未満）"
    E4002 = "クラスタリング失敗"
    E4003 = "統計計算エラー"
    E4004 = "グラフ生成エラー"
    E4005 = "異常値検出失敗"
```

### エラー処理実装例

```python
def handle_api_error(response, error_code=None):
    """APIエラーハンドリング"""
    error_messages = {
        400: f"[E1002] パラメータエラー: {response.text}",
        401: "[E1001] APIキーが無効です。環境変数を確認してください。",
        429: "[E1004] APIレート制限に達しました。60秒後に再試行してください。",
        500: "[E1003] サーバーエラーが発生しました。時間を置いて再試行してください。",
    }

    error_msg = error_messages.get(
        response.status_code,
        f"[E1005] 予期しないエラー: {response.status_code}"
    )

    # ログ出力
    logger.error(f"{error_msg} - URL: {response.url}")

    # ユーザー向けメッセージ
    st.error(f"エラーが発生しました: {error_msg}")

    return None

# 使用例
try:
    response = requests.get(url, headers=headers, params=params, timeout=30)

    if response.status_code == 200:
        data = response.json()
        if not data:
            st.warning("[E2001] 検索条件に該当するデータが見つかりませんでした。")
            return []
    else:
        return handle_api_error(response)

except requests.exceptions.Timeout:
    st.error("[E1003] 接続がタイムアウトしました。ネットワークを確認してください。")
except requests.exceptions.ConnectionError:
    st.error("[E1003] サーバーに接続できません。")
except Exception as e:
    st.error(f"[E1005] 予期しないエラーが発生しました: {str(e)}")
    logger.exception("Unexpected error in API call")
```

### エラーログ形式

```
[timestamp] [ERROR] [error_code] message
例：
2024-09-19 10:23:45 [ERROR] [E1001] APIキーが設定されていません
2024-09-19 10:24:12 [ERROR] [E2001] 検索結果が0件です - params: {'area': '11', 'type': '2'}
2024-09-19 10:25:30 [ERROR] [E4001] データ不足のため分析を実行できません - count: 5
```

## トラブルシューティング

### よくある問題

1. **APIキーエラー**
   - `.env`ファイルにAPIキーが設定されているか確認
   - 環境変数名が正しいか確認
   - APIキーの有効期限を確認

2. **データが表示されない**
   - 検索条件を緩めて再検索
   - APIの応答を確認
   - 年度・四半期が正しいか確認

3. **グラフが表示されない**
   - データ件数が十分か確認（最低10件必要）
   - 数値フィールドが正しく取得できているか確認

4. **ポートが使用中の場合**
   ```bash
   # Streamlitプロセスを終了
   pkill -f streamlit

   # または別のポートを使用
   streamlit run streamlit_app.py --server.port 8502
   ```

5. **VSCodeからアクセスできない場合**
   - ポート8501の「可視性」を「Public」に設定
   - Codespace名を確認して直接URLでアクセス
   - CORS設定を無効化：
   ```bash
   streamlit run streamlit_app.py --server.headless true \
     --server.port 8501 --server.address 0.0.0.0 \
     --server.enableCORS false --server.enableXsrfProtection false
   ```

6. **接続がタイムアウトする場合**
   - ファイアウォールの設定を確認
   - ネットワーク接続を確認
   - 別のポート（8502, 8503）を試用

## 更新履歴

### 2024年9月
- 公示地価機能追加（XCT001 API統合）
- AI市場分析機能の法的対応
- グラフのインタラクティブ機能改善
- 統計分析の強化

## ライセンス
プロプライエタリ

## 連絡先
開発チーム: [開発チーム連絡先]

---
最終更新日: 2024年9月19日
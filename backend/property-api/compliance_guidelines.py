"""
法的コンプライアンス対策ガイドライン
宅建業法・金融商品取引法・景品表示法を遵守したAI分析実装
"""

# ============================================
# 1. 法的リスクと対策
# ============================================

LEGAL_RISKS = """
【主要な法的リスク】

1. 宅建業法違反リスク
   - 無免許での媒介・仲介行為
   - 重要事項説明の不備
   - 誇大広告・不実告知

2. 金融商品取引法違反リスク
   - 無登録での投資助言
   - 断定的判断の提供
   - 利益保証の示唆

3. 景品表示法違反リスク
   - 優良誤認表示
   - 有利誤認表示
   - 不当な比較広告
"""

# ============================================
# 2. システムプロンプト（法的保護）
# ============================================

COMPLIANCE_SYSTEM_PROMPT = """
あなたは不動産市場データの分析を行うAIアシスタントです。
以下の制約を厳守してください：

【必須の制約事項】
1. 断定的な表現を避け、「〜と考えられます」「〜の傾向があります」を使用
2. 投資判断は提供せず、「参考情報」として提示
3. 「必ず儲かる」「損しない」等の利益保証表現は絶対に使用しない
4. 個別物件の購入推奨は行わない
5. 「今が買い時」等の勧誘表現は使用しない
6. データに基づく客観的事実のみを述べる
7. リスク要因も必ず併記する

【禁止ワード】
- 絶対、必ず、確実に
- 保証、約束
- 買うべき、買わないと損
- 今すぐ、急いで
- 最高の投資
- リスクなし

【使用推奨表現】
- データによると〜
- 統計上は〜
- 過去の傾向では〜
- 参考情報として〜
- 一般的に〜とされています
- ご検討の際は専門家にご相談ください
"""

# ============================================
# 3. プロンプトテンプレート（安全版）
# ============================================

SAFE_ANALYSIS_PROMPT = """
以下のデータに基づいて、客観的な市場分析を提供してください。

{market_data}

【分析指示】
1. 統計データに基づく客観的な現状分析
2. 過去のトレンドから見える傾向の説明
3. 類似物件との比較（優劣の判断は避ける）
4. 一般的な注意点とリスク要因

【重要な制約】
- 購入を勧める表現は使用しない
- 断定的な将来予測は行わない
- 投資判断に関する助言は提供しない
- 「データ分析の参考情報」であることを明記
- 最終判断は専門家への相談を推奨する

簡潔で客観的な分析を300-400字でまとめてください。
"""

# ============================================
# 4. 後処理フィルター（禁止表現の除去）
# ============================================

def apply_compliance_filter(text: str) -> str:
    """
    AIの出力から法的リスクのある表現を除去・修正
    """

    # 禁止ワードと置換表現のマッピング
    replacements = {
        "絶対に": "高い可能性で",
        "必ず": "多くの場合",
        "確実に": "一般的に",
        "保証": "傾向",
        "買うべき": "検討できる",
        "買い時": "市場環境",
        "損する": "リスクがある",
        "儲かる": "収益性が期待できる可能性",
        "最高の": "良好な",
        "完璧な": "適切な",
        "今すぐ": "早めに",
        "急いで": "余裕を持って",
    }

    filtered_text = text
    for banned, safe in replacements.items():
        filtered_text = filtered_text.replace(banned, safe)

    # 免責事項の追加（まだない場合）
    if "参考情報" not in filtered_text and "専門家" not in filtered_text:
        filtered_text += "\n\n※本分析は参考情報です。実際のご判断は専門家にご相談ください。"

    return filtered_text

# ============================================
# 5. 実装例（安全なAPI応答）
# ============================================

SAFE_RESPONSE_EXAMPLE = {
    "summary": """
世田谷区三軒茶屋エリアの不動産市場データを分析しました。統計上、平均価格は5,800万円で、前年同期比で5.2%の上昇が見られます。これは一般的な都心部の傾向と一致しています。

提供データによると、類似条件の物件（100㎡前後、築5-6年）の取引価格は5,200万円から6,300万円の範囲で推移しています。公示地価も3.85%上昇しており、エリア全体として安定した市場環境にあると考えられます。

ただし、不動産市場は経済情勢や金利動向により変動する可能性があります。また、個別物件の状態や立地条件により価格は大きく異なる場合があります。

※本分析は統計データに基づく参考情報です。実際の取引をご検討の際は、宅地建物取引士等の専門家にご相談ください。
    """,

    "key_insights": [
        "統計データ上、前年比5.2%の価格上昇傾向",
        "類似物件の取引価格帯は5,200-6,300万円",
        "公示地価データも上昇傾向を示している",
        "データ収集期間：2024年第1-2四半期"
    ],

    "recommendations": [
        "詳細な物件情報の確認をお勧めします",
        "専門家による個別査定の実施をご検討ください",
        "市場動向は変動するため定期的な情報更新を推奨"
    ],

    "disclaimer": "本情報は市場データの統計分析であり、投資判断や購入の推奨を行うものではありません。"
}

# ============================================
# 6. フロントエンド表示時の免責事項
# ============================================

FRONTEND_DISCLAIMER = """
<div class="bg-amber-50 border-l-4 border-amber-400 p-4 mt-4">
  <div class="flex">
    <div class="flex-shrink-0">
      ⚠️
    </div>
    <div class="ml-3">
      <p class="text-sm text-amber-700">
        <strong>ご注意事項</strong><br>
        • 本分析は公開データに基づく参考情報です<br>
        • 実際の不動産取引は宅地建物取引士にご相談ください<br>
        • 投資判断は自己責任でお願いします<br>
        • 市場環境は常に変動する可能性があります
      </p>
    </div>
  </div>
</div>
"""

# ============================================
# 7. バックエンド実装の安全対策
# ============================================

def create_safe_prompt(market_data: dict) -> str:
    """
    安全なプロンプトを生成
    """
    prompt = SAFE_ANALYSIS_PROMPT.format(
        market_data=str(market_data)
    )
    return prompt

def validate_ai_response(response: str) -> tuple[bool, str]:
    """
    AI応答の安全性チェック
    """
    dangerous_phrases = [
        "絶対に買うべき",
        "今すぐ購入",
        "必ず儲かる",
        "リスクはありません",
        "保証します",
        "間違いなく",
        "確実に利益"
    ]

    for phrase in dangerous_phrases:
        if phrase in response:
            return False, f"禁止表現を検出: {phrase}"

    return True, "OK"

# ============================================
# 8. 設定推奨値
# ============================================

RECOMMENDED_SETTINGS = {
    "model": "gpt-4o-mini",  # 最新の安全なモデル
    "temperature": 0.3,  # 低めの温度でより保守的な出力
    "max_tokens": 800,  # 適切な長さ制限
    "system_prompt": COMPLIANCE_SYSTEM_PROMPT,
    "enable_filter": True,  # 後処理フィルター有効化
    "add_disclaimer": True,  # 免責事項自動追加
}

print("=" * 60)
print("法的コンプライアンス対策ガイドライン")
print("=" * 60)
print("\n✅ システムプロンプトで制約を明確化")
print("✅ 禁止ワードの自動フィルタリング")
print("✅ 免責事項の自動追加")
print("✅ 断定的表現の回避")
print("✅ 専門家相談の推奨")
print("\nこれらの対策により、法的リスクを最小化します。")
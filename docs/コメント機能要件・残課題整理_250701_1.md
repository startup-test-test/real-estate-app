# コメント機能要件・残課題整理

## 📋 要件定義

### 🎯 機能概要
不動産投資シミュレーションの結果に対して、招待された専門家や家族がコメントを投稿し、投資判断を支援するシステム

### 👥 対象ユーザー
- **物件オーナー**: シミュレーション実行者（招待する側）
- **招待者**: 専門家、家族、投資仲間（招待される側）
  - 税理士
  - 不動産専門家
  - ファイナンシャルプランナー
  - 家族・親戚
  - 投資仲間

---

## ✅ 実装完了機能

### 1. コメント表示システム
| 機能 | 実装状況 | 詳細 |
|------|----------|------|
| コメント一覧表示 | ✅ 完了 | SimulationResult・Simulatorページ両対応 |
| 表示専用モード | ✅ 完了 | `showOnlyComments=true` で投稿機能非表示 |
| 最大表示件数制限 | ✅ 完了 | `maxDisplayCount=3` でコンパクト表示 |
| 重要度ソート | ✅ 完了 | リスク・要検討タグ優先表示 |
| レスポンシブ対応 | ✅ 完了 | モバイル・デスクトップ両対応 |

### 2. UI/UX設計
| 機能 | 実装状況 | 詳細 |
|------|----------|------|
| 戦略的配置 | ✅ 完了 | 重要投資指標の直前に配置 |
| タグ別色分け | ✅ 完了 | リスク=赤、承認=緑、質問=青、要検討=黄、提案=紫 |
| 専門家バッジ | ✅ 完了 | 税理士、不動産専門家、家族の識別表示 |
| デモ機能 | ✅ 完了 | データベース未設定でも動作する表示システム |
| アクセシビリティ | ✅ 完了 | 適切なARIA属性・セマンティックHTML |

### 3. コンポーネント設計
| コンポーネント | 実装状況 | 詳細 |
|---------------|----------|------|
| CommentSection | ✅ 完了 | メインコメント表示コンポーネント |
| InviteModal | ✅ 完了 | 招待・共有リンク生成モーダル |
| CollaborationView | ✅ 完了 | 招待者用の共有ビューページ |
| usePropertyShare | ✅ 完了 | 共有機能管理フック |

### 4. データベース設計
| テーブル | 実装状況 | 詳細 |
|----------|----------|------|
| property_shares | ✅ 完了 | 共有情報管理 |
| share_invitations | ✅ 完了 | 招待情報管理 |
| share_comments | ✅ 完了 | コメント情報管理 |
| comment_reactions | ✅ 完了 | リアクション情報管理 |
| share_access_logs | ✅ 完了 | アクセス履歴管理 |

---

## 🚨 現在の実装状況・制限事項

### 実装されているもの（UI/UXレイヤー）
- ✅ **コメント表示UI**: 見た目・レイアウト・色分けは完成
- ✅ **モックデータ表示**: 3件のダミーコメントが常に表示
- ✅ **レスポンシブデザイン**: モバイル・デスクトップ対応
- ✅ **コンポーネント設計**: 再利用可能な設計

### 実装されていないもの（データレイヤー）
- ❌ **実際のデータベース接続**: Supabaseとの連携が未完成
- ❌ **実コメント投稿**: 投稿してもデータベースに保存されない
- ❌ **実コメント取得**: データベースからの読み込みができない
- ❌ **共有状態管理**: `currentShare`が常にnullのため実際の共有が機能しない
- ❌ **招待フロー**: 招待を送信してもデータベースに記録されない

### デモ状態の課題
```typescript
// 現在の状況: 常にモックデータを表示
const mockComments = [
  { content: "この物件の利回りは良好ですが...", user: "山田太郎（税理士）" },
  { content: "立地が良く、賃貸需要も...", user: "田中花子（不動産専門家）" },
  { content: "周辺の相場と比較して...", user: "佐藤一郎（家族）" }
];
// → 実際のユーザーデータではない
```

### 具体的な問題点
1. **currentShare が常に null**: 共有が作成されても状態管理できていない
2. **fetchComments が空を返す**: データベースからの読み込み失敗
3. **postComment が機能しない**: 投稿がデータベースに保存されない
4. **招待フローが未完成**: 招待送信後のデータ保存ができない
5. **認証状態の不整合**: ユーザー認証とコメント機能の連携不備

### 緊急修正が必要な理由
- **ユーザー体験の誤解**: 実際に機能していると誤解される
- **テスト不可能**: 実際のワークフローが検証できない
- **開発効率低下**: 実装状況が把握しづらい
- **品質問題**: 本格運用時に重大なバグ発生リスク

---

## 🚧 残課題・未実装機能

### Phase 1: コア機能の完全実装

#### 1.1 データベース連携（🚨 緊急課題）
| 課題 | 優先度 | 説明 | 推定工数 |
|------|--------|------|----------|
| **モック表示からの脱却** | 🔴 最緊急 | 現在はダミーデータ表示のみ。実際のデータベース連携が必要 | 6-8時間 |
| 実コメント投稿 | 🔴 高 | データベースへの実際のコメント保存機能 | 4-6時間 |
| 実コメント取得 | 🔴 高 | データベースからの実際のコメント読み込み機能 | 3-4時間 |
| 共有状態管理 | 🔴 高 | 実際の共有作成・状態管理（現在はcurrentShareがnull） | 4-5時間 |
| コメント削除・編集 | 🟡 中 | 投稿者による自分のコメントの編集・削除 | 2-3時間 |
| リアクション機能 | 🟡 中 | 👍👎❓ボタンの実装 | 3-4時間 |
| 返信機能 | 🟢 低 | コメントに対する返信・スレッド表示 | 4-5時間 |

#### 1.2 招待・権限管理
| 課題 | 優先度 | 説明 | 推定工数 |
|------|--------|------|----------|
| メール招待 | 🔴 高 | Resend API使用の招待メール送信 | 6-8時間 |
| 権限管理 | 🔴 高 | viewer/commenter/editor権限の実装 | 4-6時間 |
| 招待リンク期限 | 🟡 中 | リンクの有効期限管理 | 2-3時間 |
| 招待取り消し | 🟡 中 | 招待のキャンセル・無効化機能 | 2-3時間 |

#### 1.3 通知システム
| 課題 | 優先度 | 説明 | 推定工数 |
|------|--------|------|----------|
| リアルタイム通知 | 🟡 中 | 新規コメント時のオーナー通知 | 6-8時間 |
| メール通知 | 🟡 中 | コメント投稿時のメール通知 | 4-5時間 |
| 通知設定 | 🟢 低 | ユーザー毎の通知ON/OFF設定 | 3-4時間 |

### Phase 2: UX・機能強化

#### 2.1 コメント機能拡張
| 課題 | 優先度 | 説明 | 推定工数 |
|------|--------|------|----------|
| 画像添付 | 🟢 低 | コメントへの画像・ファイル添付 | 6-8時間 |
| @メンション | 🟢 低 | 特定ユーザーへのメンション機能 | 4-6時間 |
| 絵文字リアクション | 🟢 低 | 多様な絵文字でのリアクション | 3-4時間 |
| コメント検索 | 🟢 低 | タグ・キーワードでのコメント検索 | 4-5時間 |

#### 2.2 分析・レポート機能
| 課題 | 優先度 | 説明 | 推定工数 |
|------|--------|------|----------|
| コメント統計 | 🟡 中 | タグ別コメント数・傾向分析 | 4-6時間 |
| 専門家スコア | 🟢 低 | 専門家の助言精度・有用性スコア | 8-10時間 |
| AI要約 | 🟢 低 | 複数コメントの自動要約機能 | 10-12時間 |
| 判断履歴 | 🟡 中 | 過去の投資判断とコメントの履歴 | 6-8時間 |

#### 2.3 コラボレーション強化
| 課題 | 優先度 | 説明 | 推定工数 |
|------|--------|------|----------|
| 投票機能 | 🟢 低 | 投資可否の多数決投票 | 6-8時間 |
| 会議室機能 | 🟢 低 | リアルタイムチャット・ビデオ通話 | 20-25時間 |
| 文書共有 | 🟢 低 | 関連資料・契約書等の共有 | 8-10時間 |
| タスク管理 | 🟢 低 | 検討事項・TODO管理 | 6-8時間 |

### Phase 3: 高度な機能

#### 3.1 AI・自動化
| 課題 | 優先度 | 説明 | 推定工数 |
|------|--------|------|----------|
| リスク自動検出 | 🟢 低 | AIによるリスク要因の自動抽出 | 15-20時間 |
| 推奨専門家 | 🟢 低 | 物件特性に応じた専門家推薦 | 12-15時間 |
| 自動タグ付け | 🟢 低 | コメント内容の自動タグ分類 | 8-10時間 |
| 市況連携 | 🟢 低 | 不動産市況データとの連携分析 | 20-25時間 |

#### 3.2 外部連携
| 課題 | 優先度 | 説明 | 推定工数 |
|------|--------|------|----------|
| 不動産ポータル連携 | 🟢 低 | SUUMO、athome等との物件情報連携 | 15-20時間 |
| 金融機関API | 🟢 低 | ローン条件リアルタイム取得 | 12-15時間 |
| 税務ソフト連携 | 🟢 低 | freee、弥生等との連携 | 10-12時間 |
| SNS共有 | 🟢 低 | X、LinkedIn等での結果共有 | 4-6時間 |

---

## 🔧 技術的課題

### インフラ・パフォーマンス
| 課題 | 優先度 | 説明 | 対応方法 |
|------|--------|------|----------|
| RLS性能問題 | 🟡 中 | 複雑なRLSによるクエリ速度低下 | インデックス最適化・クエリ改善 |
| リアルタイム通信 | 🟡 中 | WebSocket実装でのリアルタイム更新 | Supabase Realtime活用 |
| 画像・ファイル管理 | 🟢 低 | 大容量ファイルの効率的な管理 | Supabase Storage活用 |
| CDN活用 | 🟢 低 | 静的リソースの高速配信 | Cloudflare等の導入 |

### セキュリティ
| 課題 | 優先度 | 説明 | 対応方法 |
|------|--------|------|----------|
| 不正アクセス防止 | 🔴 高 | 招待リンクの悪用防止 | トークン期限・IP制限 |
| スパム対策 | 🟡 中 | 自動投稿・スパムコメント対策 | レート制限・フィルタリング |
| データ暗号化 | 🟡 中 | 機密情報の暗号化 | エンドツーエンド暗号化 |
| 監査ログ | 🟡 中 | 全操作の監査ログ記録 | 詳細アクセスログ実装 |

---

## 📊 優先度付けマトリクス

### 🚨 緊急対応（Phase 0 - 1週間以内）
1. **モックデータからの脱却** - 現在ダミー表示のみ
2. **実際のデータベース連携** - Supabase接続の完成
3. **共有状態管理の実装** - currentShareがnullの問題解決
4. **実コメント保存・取得** - 基本的なCRUD操作

### 🔴 最優先（Phase 1 - 2週間以内）
1. **メール招待機能** - 基本的なワークフロー完成
2. **権限管理** - セキュリティ確保
3. **不正アクセス防止** - セキュリティ基盤
4. **エラーハンドリング** - 堅牢性確保

### 🟡 中優先（Phase 2 - 1ヶ月以内）
1. **リアルタイム通知** - UX向上
2. **コメント統計** - データ活用
3. **RLS性能改善** - スケーラビリティ
4. **メール通知** - エンゲージメント向上

### 🟢 低優先（Phase 3 - 3ヶ月以内）
1. **AI要約機能** - 差別化要素
2. **外部連携** - エコシステム構築
3. **高度なコラボレーション** - 競合優位性
4. **市況連携** - データ価値向上

---

## 🎯 緊急修正ロードマップ（1週間）

### 🚨 Phase 0: モック脱却（緊急対応）
- **Day 1**: Supabaseデータベース接続確認・修正
- **Day 2**: 実コメント保存機能実装
- **Day 3**: 実コメント取得・表示機能実装
- **Day 4**: 共有状態管理（currentShare）実装
- **Day 5**: 基本的なエラーハンドリング・テスト

## 🎯 短期実装ロードマップ（2週間）

### Week 2: 基本機能完成
- **Day 6-7**: メール招待機能実装
- **Day 8-9**: 権限管理システム実装
- **Day 10**: セキュリティ強化・UI改善

### Week 3: 安定化・最適化
- **Day 11-12**: パフォーマンス最適化
- **Day 13-14**: バグ修正・テスト強化
- **Day 15**: ドキュメント整備・リリース準備

---

## 🚀 中期ビジョン（3ヶ月）

### 目標
1. **完全なコラボレーションプラットフォーム**として機能
2. **AI支援による投資判断サポート**の実現
3. **不動産投資コミュニティ**の形成
4. **データドリブンな投資判断**の支援

### 成功指標（KPI）
- 月間アクティブユーザー数: 1,000人
- コメント投稿率: 60%以上
- 専門家登録数: 100人
- 投資実行率（コメント後）: 70%以上

---

## 📝 開発上の注意点

### コード品質
- TypeScript型安全性の徹底
- ユニットテスト・E2Eテストの充実
- パフォーマンス指標の継続監視
- セキュリティテストの定期実行

### UX配慮
- モバイルファーストデザイン
- アクセシビリティ対応（WCAG 2.1準拠）
- 国際化対応（i18n）
- オフライン対応検討

### 運用面
- エラー監視・アラート設定
- パフォーマンス監視ダッシュボード
- ユーザーフィードバック収集システム
- A/Bテスト基盤構築

---

*作成日: 2025年07月01日*  
*最終更新: 2025年07月01日*  
*責任者: 開発チーム*
# å…±æœ‰ãƒ»æ‹›å¾…æ©Ÿèƒ½ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

## 1. ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 1.1 property_sharesï¼ˆç‰©ä»¶å…±æœ‰ï¼‰ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE property_shares (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  property_id UUID NOT NULL REFERENCES properties(id),
  owner_id UUID NOT NULL REFERENCES auth.users(id),
  share_token VARCHAR(255) UNIQUE NOT NULL,
  title VARCHAR(255),
  description TEXT,
  settings JSONB DEFAULT '{}',
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_property_shares_owner ON property_shares(owner_id);
CREATE INDEX idx_property_shares_token ON property_shares(share_token);
```

### 1.2 share_invitationsï¼ˆæ‹›å¾…ï¼‰ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE share_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  share_id UUID NOT NULL REFERENCES property_shares(id) ON DELETE CASCADE,
  email VARCHAR(255) NOT NULL,
  role VARCHAR(50) NOT NULL CHECK (role IN ('viewer', 'commenter', 'editor')),
  user_type VARCHAR(50) DEFAULT 'general', -- 'family', 'tax_accountant', 'consultant', 'general'
  invited_by UUID NOT NULL REFERENCES auth.users(id),
  accepted_by UUID REFERENCES auth.users(id),
  invitation_token VARCHAR(255) UNIQUE NOT NULL,
  status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'declined', 'expired')),
  message TEXT,
  accepted_at TIMESTAMP WITH TIME ZONE,
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_invitations_share ON share_invitations(share_id);
CREATE INDEX idx_invitations_email ON share_invitations(email);
CREATE INDEX idx_invitations_token ON share_invitations(invitation_token);
```

### 1.3 share_commentsï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE share_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  share_id UUID NOT NULL REFERENCES property_shares(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  parent_id UUID REFERENCES share_comments(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  tags TEXT[] DEFAULT '{}',
  attachments JSONB DEFAULT '[]',
  metadata JSONB DEFAULT '{}',
  is_edited BOOLEAN DEFAULT FALSE,
  edited_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_comments_share ON share_comments(share_id);
CREATE INDEX idx_comments_user ON share_comments(user_id);
CREATE INDEX idx_comments_parent ON share_comments(parent_id);
CREATE INDEX idx_comments_created ON share_comments(created_at DESC);
```

### 1.4 comment_reactionsï¼ˆãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE comment_reactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  comment_id UUID NOT NULL REFERENCES share_comments(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  reaction VARCHAR(10) NOT NULL, -- 'ğŸ‘', 'ğŸ‘', 'â“', etc.
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(comment_id, user_id, reaction)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_reactions_comment ON comment_reactions(comment_id);
```

### 1.5 share_access_logsï¼ˆã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ï¼‰ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE share_access_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  share_id UUID NOT NULL REFERENCES property_shares(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id),
  invitation_id UUID REFERENCES share_invitations(id),
  action VARCHAR(50) NOT NULL, -- 'view', 'comment', 'edit', 'download'
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_access_logs_share ON share_access_logs(share_id);
CREATE INDEX idx_access_logs_user ON share_access_logs(user_id);
CREATE INDEX idx_access_logs_created ON share_access_logs(created_at DESC);
```

## 2. ãƒ“ãƒ¥ãƒ¼ã®ä½œæˆ

### 2.1 å…±æœ‰æ¦‚è¦ãƒ“ãƒ¥ãƒ¼
```sql
CREATE VIEW share_overview AS
SELECT 
  ps.id,
  ps.property_id,
  ps.owner_id,
  ps.title,
  ps.created_at,
  COUNT(DISTINCT si.id) as invitation_count,
  COUNT(DISTINCT CASE WHEN si.status = 'accepted' THEN si.id END) as active_users,
  COUNT(DISTINCT sc.id) as comment_count,
  MAX(sc.created_at) as last_activity
FROM property_shares ps
LEFT JOIN share_invitations si ON ps.id = si.share_id
LEFT JOIN share_comments sc ON ps.id = sc.share_id
GROUP BY ps.id;
```

### 2.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒ“ãƒ¥ãƒ¼
```sql
CREATE VIEW user_share_permissions AS
SELECT 
  ps.id as share_id,
  ps.property_id,
  ps.owner_id,
  si.accepted_by as user_id,
  si.role,
  si.user_type,
  si.accepted_at,
  CASE 
    WHEN ps.owner_id = si.accepted_by THEN 'owner'
    ELSE si.role
  END as effective_role
FROM property_shares ps
JOIN share_invitations si ON ps.id = si.share_id
WHERE si.status = 'accepted'
UNION
SELECT 
  id as share_id,
  property_id,
  owner_id,
  owner_id as user_id,
  'owner' as role,
  'owner' as user_type,
  created_at as accepted_at,
  'owner' as effective_role
FROM property_shares;
```

## 3. Row Level Security (RLS) ãƒãƒªã‚·ãƒ¼

### 3.1 property_shares ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
-- èª­ã¿å–ã‚Š: ã‚ªãƒ¼ãƒŠãƒ¼ã¾ãŸã¯æ‹›å¾…ã‚’å—ã‘ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼
CREATE POLICY "Users can view shares they have access to" ON property_shares
  FOR SELECT USING (
    auth.uid() = owner_id OR
    EXISTS (
      SELECT 1 FROM share_invitations
      WHERE share_id = property_shares.id
      AND accepted_by = auth.uid()
      AND status = 'accepted'
    )
  );

-- ä½œæˆ: èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼
CREATE POLICY "Authenticated users can create shares" ON property_shares
  FOR INSERT WITH CHECK (auth.uid() = owner_id);

-- æ›´æ–°: ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿
CREATE POLICY "Owners can update their shares" ON property_shares
  FOR UPDATE USING (auth.uid() = owner_id);

-- å‰Šé™¤: ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿
CREATE POLICY "Owners can delete their shares" ON property_shares
  FOR DELETE USING (auth.uid() = owner_id);
```

### 3.2 share_comments ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
-- èª­ã¿å–ã‚Š: å…±æœ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼
CREATE POLICY "Users can view comments on accessible shares" ON share_comments
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM user_share_permissions
      WHERE share_id = share_comments.share_id
      AND user_id = auth.uid()
    )
  );

-- ä½œæˆ: ã‚³ãƒ¡ãƒ³ãƒˆæ¨©é™ä»¥ä¸Šã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼
CREATE POLICY "Users with comment permission can create comments" ON share_comments
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM user_share_permissions
      WHERE share_id = share_comments.share_id
      AND user_id = auth.uid()
      AND effective_role IN ('owner', 'editor', 'commenter')
    )
  );
```

## 4. é–¢æ•°ã¨ãƒˆãƒªã‚¬ãƒ¼

### 4.1 æ‹›å¾…ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆé–¢æ•°
```sql
CREATE OR REPLACE FUNCTION generate_invitation_token()
RETURNS TEXT AS $$
BEGIN
  RETURN encode(gen_random_bytes(32), 'hex');
END;
$$ LANGUAGE plpgsql;
```

### 4.2 ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥ãƒˆãƒªã‚¬ãƒ¼
```sql
CREATE OR REPLACE FUNCTION notify_new_comment()
RETURNS TRIGGER AS $$
BEGIN
  -- é€šçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
  -- ä¾‹: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã€ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãªã©
  PERFORM pg_notify('new_comment', json_build_object(
    'share_id', NEW.share_id,
    'comment_id', NEW.id,
    'user_id', NEW.user_id
  )::text);
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_notify_new_comment
  AFTER INSERT ON share_comments
  FOR EACH ROW
  EXECUTE FUNCTION notify_new_comment();
```

## 5. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®ãŸã‚ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
```sql
-- è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_invitations_status_share ON share_invitations(status, share_id);
CREATE INDEX idx_comments_share_created ON share_comments(share_id, created_at DESC);

-- éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_active_invitations ON share_invitations(share_id)
  WHERE status = 'accepted';

-- GINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¿ã‚°æ¤œç´¢ç”¨ï¼‰
CREATE INDEX idx_comments_tags ON share_comments USING GIN(tags);
```

## 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

1. **ãƒˆãƒ¼ã‚¯ãƒ³ã®å®‰å…¨æ€§**
   - æ‹›å¾…ãƒˆãƒ¼ã‚¯ãƒ³ã¯æ¨æ¸¬å›°é›£ãªé•·ã•ï¼ˆ256bitï¼‰
   - æœ‰åŠ¹æœŸé™ã®è¨­å®š

2. **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**
   - RLSã«ã‚ˆã‚‹è¡Œãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
   - å½¹å‰²ãƒ™ãƒ¼ã‚¹ã®æ¨©é™ç®¡ç†

3. **ç›£æŸ»è¨¼è·¡**
   - ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
   - é‡è¦ãªæ“ä½œã®å±¥æ­´ä¿æŒ

4. **ãƒ‡ãƒ¼ã‚¿ä¿è­·**
   - å€‹äººæƒ…å ±ã®æš—å·åŒ–
   - å®šæœŸçš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
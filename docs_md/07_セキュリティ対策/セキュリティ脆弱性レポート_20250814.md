# セキュリティ脆弱性レポート

**作成日**: 2025年8月14日  
**対象ブランチ**: develop  
**レビュー範囲**: 有料課金システム実装（Stripe決済統合）

## エグゼクティブサマリー

本レポートは、有料課金システム実装に伴うセキュリティレビューの結果をまとめたものです。**2件の高リスク脆弱性**が検出されました。これらは本番環境へのデプロイ前に修正が必要です。

## 🔴 脆弱性1: 本番環境での開発用URLハードコーディング

### 概要
- **重要度**: 高
- **カテゴリ**: 設定管理の不備
- **該当ファイル**: `supabase/functions/create-checkout-session/index.ts`
- **該当行**: 82-83行目

### 脆弱性の詳細

Stripe決済の成功/キャンセル時のリダイレクトURLに、GitHub Codespacesの開発環境URLがハードコーディングされています：

```typescript
success_url: `https://expert-space-waddle-r46qq6694764fpwj6-5173.app.github.dev/?payment=success&session_id={CHECKOUT_SESSION_ID}`,
cancel_url: `https://expert-space-waddle-r46qq6694764fpwj6-5173.app.github.dev/?payment=cancelled`,
```

### 攻撃シナリオ

1. **決済フローの破壊**: 本番環境でユーザーがStripe決済を完了後、存在しないCodespaces URLにリダイレクトされ、エラーページが表示される
2. **フィッシング攻撃の可能性**: 攻撃者が同じようなCodespaces URLを作成し、決済情報を盗取する可能性がある
3. **ユーザー体験の著しい低下**: 決済完了の確認画面が表示されず、ユーザーが決済の成否を確認できない

### 影響範囲

- 全ての有料プラン購入フロー
- 決済確認プロセス
- ユーザーの信頼性

### 推奨される修正方法

環境変数を使用してURLを動的に設定する：

```typescript
// 修正前
success_url: `https://expert-space-waddle-r46qq6694764fpwj6-5173.app.github.dev/?payment=success&session_id={CHECKOUT_SESSION_ID}`,

// 修正後
success_url: `${Deno.env.get('APP_URL') || 'https://ooya.tech'}/?payment=success&session_id={CHECKOUT_SESSION_ID}`,
```

**必要な環境変数設定**:
- 開発環境: `APP_URL=http://localhost:5173`
- テスト環境: `APP_URL=https://dev.ooya.tech`
- 本番環境: `APP_URL=https://ooya.tech`

---

## 🔴 脆弱性2: 過度に寛容なCORS設定によるCSRF攻撃の可能性

### 概要
- **重要度**: 高
- **カテゴリ**: CORS設定の不備
- **該当ファイル**: `supabase/functions/cors.ts`
- **該当行**: 3行目

### 脆弱性の詳細

全てのSupabase Edge Functionsでワイルドカード（`*`）によるCORS設定が使用されています：

```typescript
export const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}
```

### 攻撃シナリオ

1. **悪意のあるサイトからの攻撃**:
   - 攻撃者が`evil.com`に悪意のあるJavaScriptを配置
   - ユーザーがこのサイトを訪問すると、バックグラウンドでEdge Functionsへリクエストが送信される
   - ワイルドカードCORSにより、ブラウザがクロスオリジンリクエストを許可

2. **認証トークンの悪用**:
   - 攻撃者がユーザーの認証トークンを何らかの方法で取得または推測
   - 任意のドメインから決済関連のAPIを呼び出し可能

3. **不正な決済操作**:
   - サブスクリプションの不正な解約
   - 決済セッションの不正な作成
   - ユーザーの決済情報への不正アクセス

### 影響を受ける機能

- `create-checkout-session`: 決済セッション作成
- `cancel-subscription`: サブスクリプション解約
- `resume-subscription`: サブスクリプション再開
- `handle-stripe-webhook`: Stripeウェブフック処理

### 推奨される修正方法

特定のオリジンのみを許可するよう修正：

```typescript
// 修正前
'Access-Control-Allow-Origin': '*',

// 修正後（本番環境）
'Access-Control-Allow-Origin': 'https://ooya.tech',

// または環境変数を使用
'Access-Control-Allow-Origin': Deno.env.get('ALLOWED_ORIGIN') || 'https://ooya.tech',
```

**追加のセキュリティ対策**:
1. CSRFトークンの実装
2. Refererヘッダーの検証
3. SameSite Cookieの設定（Cookieを使用する場合）

---

## ✅ 評価済みで問題なしと判断された項目

### JWT検証の設定

**調査項目**: GitHub ActionsでのEdge Functions デプロイ時の`--no-verify-jwt`フラグ

**判定**: **問題なし（誤検知）**

**理由**:
- `--no-verify-jwt`はデプロイ時の設定であり、実行時のセキュリティには影響しない
- 各Edge Function内で適切にJWT検証が実装されている
  - `cancel-subscription`: `supabaseAdmin.auth.getUser(token)`で検証
  - `resume-subscription`: 同様にJWT検証を実装
  - `handle-stripe-webhook`: Stripe署名による検証を使用（業界標準）

---

## 📋 修正優先度と対応期限

| 優先度 | 脆弱性 | 対応期限 | 担当 |
|--------|--------|----------|------|
| **緊急** | ハードコーディングされたURL | 本番デプロイ前 | バックエンド開発チーム |
| **高** | CORS設定の修正 | 本番デプロイ前 | バックエンド開発チーム |

## 🛡️ ポジティブなセキュリティ実装

レビューの過程で、以下の優れたセキュリティ実装も確認されました：

- ✅ 適切な入力値検証の実装
- ✅ データベースレベルでの制約（UNIQUE制約によるサブスクリプション重複防止）
- ✅ JWTベースの認証と適切なトークン抽出
- ✅ Edge Functions内でのサーバーサイド検証
- ✅ Stripeウェブフック署名の検証実装
- ✅ 既存のXSS防止対策

## 📞 問い合わせ先

セキュリティに関する質問や懸念事項がある場合は、セキュリティチームまでご連絡ください。

---

**レポート作成者**: セキュリティレビューチーム  
**最終更新**: 2025年8月14日
# セキュリティ脆弱性レポート

**作成日**: 2025年8月14日  
**対象ブランチ**: develop  
**レビュー範囲**: 有料課金システム実装（Stripe決済統合）

## エグゼクティブサマリー

本レポートは、有料課金システム実装に伴うセキュリティレビューの結果をまとめたものです。**2件の高リスク脆弱性**が検出されました。

**更新状況（2025年8月14日）**:
- ✅ 脆弱性1: URLハードコーディング問題 - **解決済み**
- 🔴 脆弱性2: CORS設定の問題 - 対応が必要

## ✅ 脆弱性1: 本番環境での開発用URLハードコーディング【解決済み】

### 概要
- **重要度**: ~~高~~ → **解決済み**
- **カテゴリ**: 設定管理の不備
- **該当ファイル**: `supabase/functions/create-checkout-session/index.ts`
- **解決日**: 2025年8月14日
- **ステータス**: ✅ **修正完了**

### 脆弱性の詳細（修正前）

Stripe決済の成功/キャンセル時のリダイレクトURLに、GitHub Codespacesの開発環境URLがハードコーディングされていました：

```typescript
// 修正前（問題のあったコード）
success_url: `https://expert-space-waddle-r46qq6694764fpwj6-5173.app.github.dev/?payment=success&session_id={CHECKOUT_SESSION_ID}`,
cancel_url: `https://expert-space-waddle-r46qq6694764fpwj6-5173.app.github.dev/?payment=cancelled`,
```

### 実装された解決策

クライアントから動的にURLを送信し、Edge Function側で検証する方式を実装：

#### 1. クライアント側（UpgradeModal.tsx）
```typescript
// 現在のURLを動的に取得して送信
const currentUrl = window.location.origin;
const { data, error } = await supabase.functions.invoke('create-checkout-session', {
  body: { 
    priceId: priceId,
    userId: user.id,
    returnUrl: currentUrl // URLを送信
  }
});
```

#### 2. Edge Function側（create-checkout-session/index.ts）
```typescript
// 修正後（現在の実装）
const baseUrl = Deno.env.get('APP_URL') ||  // 環境変数優先
                returnUrl ||                 // クライアントから送信されたURL
                'https://ooya.tech'          // デフォルト

success_url: `${baseUrl}/?payment=success&session_id={CHECKOUT_SESSION_ID}`,
cancel_url: `${baseUrl}/?payment=cancelled`,
```

### セキュリティ対策

許可されたドメインのみを受け入れる検証を実装（CSRF対策）：
- `app.github.dev`（Codespace）
- `ooya.tech`（本番）
- `staging.ooya.tech`（ステージング）
- `localhost`（ローカル開発）

### テスト結果

- ✅ Codespace環境での動作確認完了（2025/8/14）
- ✅ 決済後の正常なリダイレクト確認
- ✅ 404エラーの解消確認

### 本番環境への適用

Supabaseダッシュボードで環境変数を設定：
- 本番環境: `APP_URL=https://ooya.tech`
- ステージング: `APP_URL=https://staging.ooya.tech`

---

## 🔴 脆弱性2: 過度に寛容なCORS設定によるCSRF攻撃の可能性

### 概要
- **重要度**: 高
- **カテゴリ**: CORS設定の不備
- **該当ファイル**: `supabase/functions/cors.ts`
- **該当行**: 3行目

### 脆弱性の詳細

全てのSupabase Edge Functionsでワイルドカード（`*`）によるCORS設定が使用されています：

```typescript
export const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}
```

### 攻撃シナリオ

1. **悪意のあるサイトからの攻撃**:
   - 攻撃者が`evil.com`に悪意のあるJavaScriptを配置
   - ユーザーがこのサイトを訪問すると、バックグラウンドでEdge Functionsへリクエストが送信される
   - ワイルドカードCORSにより、ブラウザがクロスオリジンリクエストを許可

2. **認証トークンの悪用**:
   - 攻撃者がユーザーの認証トークンを何らかの方法で取得または推測
   - 任意のドメインから決済関連のAPIを呼び出し可能

3. **不正な決済操作**:
   - サブスクリプションの不正な解約
   - 決済セッションの不正な作成
   - ユーザーの決済情報への不正アクセス

### 影響を受ける機能

- `create-checkout-session`: 決済セッション作成
- `cancel-subscription`: サブスクリプション解約
- `resume-subscription`: サブスクリプション再開
- `handle-stripe-webhook`: Stripeウェブフック処理

### 推奨される修正方法

特定のオリジンのみを許可するよう修正：

```typescript
// 修正前
'Access-Control-Allow-Origin': '*',

// 修正後（本番環境）
'Access-Control-Allow-Origin': 'https://ooya.tech',

// または環境変数を使用
'Access-Control-Allow-Origin': Deno.env.get('ALLOWED_ORIGIN') || 'https://ooya.tech',
```

**追加のセキュリティ対策**:
1. CSRFトークンの実装
2. Refererヘッダーの検証
3. SameSite Cookieの設定（Cookieを使用する場合）

---

## ✅ 評価済みで問題なしと判断された項目

### JWT検証の設定

**調査項目**: GitHub ActionsでのEdge Functions デプロイ時の`--no-verify-jwt`フラグ

**判定**: **問題なし（誤検知）**

**理由**:
- `--no-verify-jwt`はデプロイ時の設定であり、実行時のセキュリティには影響しない
- 各Edge Function内で適切にJWT検証が実装されている
  - `cancel-subscription`: `supabaseAdmin.auth.getUser(token)`で検証
  - `resume-subscription`: 同様にJWT検証を実装
  - `handle-stripe-webhook`: Stripe署名による検証を使用（業界標準）

---

## 📋 修正優先度と対応期限

| 優先度 | 脆弱性 | 対応期限 | 担当 |
|--------|--------|----------|------|
| **緊急** | ハードコーディングされたURL | 本番デプロイ前 | バックエンド開発チーム |
| **高** | CORS設定の修正 | 本番デプロイ前 | バックエンド開発チーム |

## 🛡️ ポジティブなセキュリティ実装

レビューの過程で、以下の優れたセキュリティ実装も確認されました：

- ✅ 適切な入力値検証の実装
- ✅ データベースレベルでの制約（UNIQUE制約によるサブスクリプション重複防止）
- ✅ JWTベースの認証と適切なトークン抽出
- ✅ Edge Functions内でのサーバーサイド検証
- ✅ Stripeウェブフック署名の検証実装
- ✅ 既存のXSS防止対策

## 📞 問い合わせ先

セキュリティに関する質問や懸念事項がある場合は、セキュリティチームまでご連絡ください。

---

**レポート作成者**: セキュリティレビューチーム  
**最終更新**: 2025年8月14日
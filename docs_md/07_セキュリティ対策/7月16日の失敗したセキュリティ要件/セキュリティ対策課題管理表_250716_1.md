# 不動産アプリ セキュリティ対策課題管理表

## 概要
不動産アプリケーションのセキュリティ脆弱性調査結果をもとに、対策が必要な課題を管理表形式で整理しました。

### 📚 このドキュメントの読み方（初心者向け）

**このドキュメントは何？**
- 不動産投資シミュレーションアプリに存在するセキュリティの問題点をまとめた資料です
- 悪意のある人が攻撃を仕掛けてきた場合に、どのような被害が発生するかを整理しています
- 各問題の解決方法も具体的に示しています

**なぜセキュリティ対策が必要？**
- ユーザーの個人情報（メールアドレス、投資データ）が盗まれる可能性
- 悪意のある人がシステムに侵入して、データを改ざんする可能性
- ウイルスやマルウェアが混入して、システム全体が使用不能になる可能性
- 企業の信頼を失い、法的な責任を問われる可能性

**優先度の意味**
- 🔴 **重大リスク**: 今すぐ対応しないと大きな被害が発生する可能性が高い
- 🟡 **高リスク**: 1週間以内に対応すべき問題
- 🟢 **低リスク**: 1ヶ月以内に対応すれば良い問題

## 調査実施日
2025-07-16

## 🚨 重要な現状報告：本番環境での使用は極めて危険

**5つの観点から徹底調査を実施し、以下の重大な脆弱性を発見しました：**

### 🎯 主要な攻撃経路・侵入手法
1. **認証システムの完全バイパス** - 任意のメール@example.comでログイン可能
2. **XSS攻撃による情報窃取** - コメント・入力フィールドでスクリプト実行
3. **ファイルアップロード攻撃** - 悪意のあるHTMLファイルを.jpg拡張子で偽装
4. **API認証不備による攻撃** - 外部APIへの無制限アクセス
5. **情報漏洩経路** - 206件のconsole.log文に機密情報

### 🦠 ウイルス・マルウェア侵入経路
**高リスク経路（実行可能性：高）：**
- 画像アップロード偽装（HTMLファイル偽装）
- 外部URL経由（フィッシングサイト誘導）
- 第三者ライブラリ（FastAPI CVE-2024-24762）

**中リスク経路（実行可能性：中）：**
- jsPDF脆弱性、innerHTML使用攻撃、中間者攻撃

### 🔒 依存関係の脆弱性
**緊急対応必要：**
- **FastAPI** 0.99.1 → CVE-2024-24762（DoS攻撃）
- **esbuild** 0.21.5 → 任意リクエスト送信
- **jsPDF** 3.0.1 → CVE-2025-29907

### 🌐 API・データ通信のセキュリティ
**重大な問題：**
- API認証なし（誰でも利用可能）
- 機密データ平文保存（投資情報が暗号化されず）
- レート制限なし（DoS攻撃に脆弱）
- エラー情報漏洩（詳細なエラーメッセージ）

### 📊 最終的な脆弱性統計
- 🔴 **重大リスク**: 18件（認証バイパス、XSS、RLS無効化、DOM操作、データベース欠如等）
- 🟡 **高リスク**: 27件（ファイル偽装、API認証なし、緩いRLS、CSP、計算攻撃等）
- 🟢 **低リスク**: 17件（セキュリティヘッダー、ライブラリ更新等）
- **総計: 62件の脆弱性**

### 🆕 **2025-07-17追加調査による新発見**
**バックエンド・インフラ調査で6件の新たな脆弱性を発見:**
- SEC-057: データベース永続化システムの欠如（重大リスク）
- SEC-058: 数値計算における整数オーバーフロー攻撃（高リスク）
- SEC-059: Python Pickle/eval攻撃経路（高リスク）
- SEC-060: FastAPI自動ドキュメント機能の情報漏洩（中リスク）
- SEC-061: Streamlit開発サーバーの本番環境漏洩（中リスク）
- SEC-062: uvicorn設定の不適切なバインド（低リスク）

### 📋 セキュリティ課題の詳細分類
**現在確認されている全セキュリティ課題: 62件**

**重大リスク（即座対応必要）: 18件**
- SEC-001, SEC-002, SEC-003, SEC-010, SEC-011, SEC-015, SEC-016, SEC-020, SEC-021, SEC-022, SEC-034, SEC-038, SEC-045, SEC-046, SEC-047, SEC-057

**高リスク（1週間以内対応）: 27件**
- SEC-004, SEC-005, SEC-006, SEC-007, SEC-012, SEC-013, SEC-014, SEC-017, SEC-018, SEC-019, SEC-023, SEC-024, SEC-025, SEC-026, SEC-027, SEC-028, SEC-029, SEC-030, SEC-035, SEC-037, SEC-041, SEC-048, SEC-049, SEC-050, SEC-058, SEC-059, SEC-060, SEC-061

**低リスク（1ヶ月以内対応）: 17件**
- SEC-008, SEC-009, SEC-031, SEC-032, SEC-033, SEC-036, SEC-039, SEC-040, SEC-042, SEC-043, SEC-044, SEC-051, SEC-052, SEC-053, SEC-054, SEC-055, SEC-056, SEC-062

### 🎯 具体的な攻撃シナリオ
**シナリオ1: 投資データ窃取**
```
1. 任意のメールでログイン → 認証バイパス
2. 他ユーザーの投資シミュレーション閲覧
3. 機密な投資情報の大量取得
```

**シナリオ2: アカウント乗っ取り**
```
1. コメントにXSSスクリプト投稿
2. 他ユーザーのセッショントークン窃取
3. 完全なアカウント制御権取得
```

**シナリオ3: システム侵害**
```
1. 悪意のあるHTMLファイルをjpgとして偽装
2. サーバー上でスクリプト実行
3. 全システムの制御権取得
```

---

## 🔍 セキュリティ用語集（初心者向け）

### 基本的な攻撃手法

**XSS（Cross-Site Scripting）**
- **簡単な説明**: 入力フォームに悪意のあるプログラムを書き込んで、他のユーザーがそのページを見たときに悪意のあるプログラムが実行される攻撃
- **具体例**: コメント欄に`<script>alert('攻撃')</script>`と書くと、そのコメントを見た人のブラウザで警告が表示される
- **被害**: ユーザーの個人情報が盗まれる、アカウントが乗っ取られる

**認証バイパス**
- **簡単な説明**: 正しいパスワードを知らなくても、システムにログインできてしまう問題
- **具体例**: パスワードを入力しなくても、特定のメールアドレスを入力するだけでログインできる
- **被害**: 他人のアカウントに不正ログインされる

**ファイル偽装攻撃**
- **簡単な説明**: 危険なファイルを安全な画像ファイルのように見せかけてアップロードする攻撃
- **具体例**: ウイルスファイルに`.jpg`という拡張子を付けて、画像ファイルとして偽装する
- **被害**: サーバーにウイルスが感染する、システムが乗っ取られる

**DoS攻撃**
- **簡単な説明**: システムに大量のリクエストを送り付けて、サービスを使用不能にする攻撃
- **具体例**: 1秒間に1000回以上のAPI呼び出しを行い、サーバーを過負荷状態にする
- **被害**: サービスが停止する、正常なユーザーがアクセスできなくなる

**情報漏洩**
- **簡単な説明**: 本来は隠すべき情報が、意図せずに外部に公開されてしまう問題
- **具体例**: エラーメッセージにユーザーのパスワードが表示される、コンソールログに個人情報が出力される
- **被害**: 個人情報が流出する、企業秘密が漏洩する

### 技術的な脆弱性

**CSRF（Cross-Site Request Forgery）**
- **簡単な説明**: 他のサイトから不正なリクエストを送信させる攻撃
- **具体例**: 悪意のあるサイトを見ただけで、知らない間にお金を送金してしまう
- **被害**: ユーザーの知らない間に不正な操作が実行される

**SQLインジェクション**
- **簡単な説明**: データベースへの不正なアクセスを行う攻撃
- **具体例**: 入力フォームに特殊な文字を入力して、データベースの全情報を取得する
- **被害**: データベースの全情報が盗まれる、データが削除される

**パストラバーサル**
- **簡単な説明**: 本来アクセスできないファイルにアクセスする攻撃
- **具体例**: `../../../etc/passwd`のような特殊なファイル名を使用して、システムファイルにアクセスする
- **被害**: システムの重要なファイルが盗まれる、システムが乗っ取られる

---

## 課題管理表

### 優先度：高（即座に対応必要）

**⚠️ 重要**: 以下の問題は**今すぐ対応が必要**です。放置すると大きな被害が発生する可能性があります。

**初心者向け解説**:
- これらの問題は、悪意のある人が簡単に攻撃を仕掛けることができる状態です
- 攻撃が成功すると、全ユーザーのデータが盗まれたり、システムが乗っ取られたりします
- 特に「認証バイパス」は、誰でも他人のアカウントにログインできてしまう非常に危険な状態です

| 課題ID | 課題名 | 対象ファイル | 脆弱性の種類 | 影響度 | 現在の状況 | 対策内容 | 担当者 | 期限 | ステータス | GitHub Issue | SaaS機能への影響 | 修正後のテストシナリオ |
|--------|--------|--------------|-------------|--------|------------|----------|--------|------|-----------|-------------|------------------|----------------|
| SEC-001 | XSS攻撃対策 | `bolt_front/src/components/comments/CommentItem.tsx:167` | Cross-Site Scripting | 高 | ユーザーコメントが直接表示される | DOMPurifyの導入とサニタイゼーション実装 | - | 即座 | 🔴 未対応 | [#001](https://github.com/username/repo/issues/001) | 🟡 コメント機能のみ影響 | **テスト1**: 悪意のあるコメント投稿(`<script>alert('XSS')</script>`)→スクリプト実行されず<br>**テスト2**: 通常コメント・書式設定の正常表示<br>**テスト3**: 共有機能でのコメント安全表示 |
| SEC-002 | モック認証の本番無効化 | `bolt_front/src/hooks/useSupabaseAuth.ts:156` | 認証バイパス | 高 | 任意のメールアドレスでログイン可能 | 環境変数による本番環境での無効化 | - | 即座 | 🔴 未対応 | [#002](https://github.com/username/repo/issues/002) | 🔴 全システム影響・要検証 | **テスト1**: 不正ログイン試行→拒否確認<br>**テスト2**: 正常ログイン・全機能動作確認<br>**テスト3**: セッション管理・複数タブ動作確認 |
| SEC-003 | CORS設定の厳密化 | `backend/simulator-api/app.py:30` | Cross-Origin Resource Sharing | 高 | 全オリジンからのアクセス許可 | 環境別のオリジン制限設定 | - | 即座 | 🔴 未対応 | [#003](https://github.com/username/repo/issues/003) | 🟡 外部API通信に影響 | **テスト1**: シミュレーター計算の正常動作<br>**テスト2**: 不動産情報検索の正常動作<br>**テスト3**: 画像アップロード・PDFエクスポート確認 |
| SEC-004 | CSRF対策の実装 | 全般 | Cross-Site Request Forgery | 中 | CSRF対策が未実装 | CSRFトークンの実装 | - | 1週間 | 🔴 未対応 | [#004](https://github.com/username/repo/issues/004) | 🟡 全機能影響 | **テスト1**: CSRF攻撃の防止確認<br>**テスト2**: 正常なフォーム送信確認<br>**テスト3**: 全機能の動作確認 |
| SEC-005 | セッション管理の強化 | `bolt_front/src/hooks/useSupabaseAuth.ts` | セッション管理 | 中 | LocalStorageに認証情報保存 | HTTPOnlyクッキーとタイムアウト設定 | - | 1週間 | 🔴 未対応 | [#005](https://github.com/username/repo/issues/005) | 🟡 認証システム影響 | **テスト1**: セッション管理の安全性確認<br>**テスト2**: 認証機能の正常動作確認<br>**テスト3**: タイムアウト機能の動作確認 |
| SEC-006 | ファイルアップロード検証 | `bolt_front/src/components/ImageUpload.tsx` | ファイルアップロード | 中 | クライアント側のみの検証 | サーバー側検証とマジックナンバー確認 | - | 1週間 | 🔴 未対応 | [#006](https://github.com/username/repo/issues/006) | 🟡 ファイルアップロード機能のみ | **テスト1**: サーバー側検証の動作確認<br>**テスト2**: 正常なファイルアップロード確認<br>**テスト3**: 悪意のあるファイル拒否確認 |
| SEC-007 | 環境変数管理の改善 | `bolt_front/src/lib/supabase.ts` | 機密情報管理 | 中 | 環境変数の検証不足 | 厳密な環境変数検証の実装 | - | 1週間 | 🔴 未対応 | [#007](https://github.com/username/repo/issues/007) | 🟡 システム全般影響 | **テスト1**: 環境変数の検証機能確認<br>**テスト2**: 設定エラーの適切な処理<br>**テスト3**: 全機能の正常動作確認 |
| SEC-008 | デバッグ情報の漏洩対策 | 全般（34ファイル） | 情報漏洩 | 低 | 351個のconsole.log文 | ログレベルの実装とログ整理 | - | 1ヶ月 | 🔴 未対応 | [#008](https://github.com/username/repo/issues/008) | 🟡 情報セキュリティ全般 | **テスト1**: 本番環境でのログ出力制限確認<br>**テスト2**: 開発環境でのログ機能確認<br>**テスト3**: 全機能の正常動作確認 |
| SEC-009 | セキュリティヘッダーの追加 | `bolt_front/vite.config.ts` | セキュリティヘッダー | 低 | セキュリティヘッダー未設定 | CSP、X-Frame-Options等の設定 | - | 1ヶ月 | 🔴 未対応 | [#009](https://github.com/username/repo/issues/009) | 🟡 フロントエンド全般 | **テスト1**: セキュリティヘッダーの設定確認<br>**テスト2**: XSS攻撃の防止確認<br>**テスト3**: 全機能の正常動作確認 |
| SEC-010 | 画像アップロード偽装攻撃 | `bolt_front/src/utils/imageUtils.ts:77` | ファイル偽装 | 高 | MIMEタイプ検証のみ | マジックナンバー検証の実装 | - | 即座 | 🔴 未対応 | [#010](https://github.com/username/repo/issues/010) | 🟡 画像アップロード機能のみ | **テスト1**: 不正ファイル(.htmlを.jpg偽装)→アップロード拒否<br>**テスト2**: 正常画像(JPEG/PNG/WebP)→アップロード成功<br>**テスト3**: 画像品質・表示確認 |
| SEC-011 | URL入力でのスクリプト実行 | `bolt_front/src/utils/validation.ts:10` | JavaScript注入 | 高 | javascript:プロトコルが許可される | 危険プロトコルの検証追加 | - | 即座 | 🔴 未対応 | [#011](https://github.com/username/repo/issues/011) | 🟡 URL入力フィールドのみ | **テスト1**: 悪意URL(`javascript:alert('XSS')`)→入力拒否<br>**テスト2**: 正常URL(https://suumo.jp...)→入力受諾<br>**テスト3**: URLリンクの正常動作 |

### 優先度：中（短期対応が必要）

**📋 説明**: 以下の問題は**1週間以内に対応**すべき問題です。

**初心者向け解説**:
- これらの問題は、上記の「高」ほどではありませんが、放置すると攻撃のリスクが高まります
- 特に「機密情報のログ出力」は、開発中にパスワードや個人情報がログに記録されてしまう問題です
- 「レート制限の不在」は、システムに大量のリクエストを送られて、サービスが停止してしまう問題です

| 課題ID | 課題名 | 対象ファイル | 脆弱性の種類 | 影響度 | 現在の状況 | 対策内容 | 担当者 | 期限 | ステータス | GitHub Issue | SaaS機能への影響 | 修正後のテストシナリオ |
|--------|--------|--------------|-------------|--------|------------|----------|--------|------|-----------|-------------|------------------|----------------|
| SEC-012 | シミュレーター入力フィールドXSS | `bolt_front/src/pages/Simulator.tsx:664` | Cross-Site Scripting | 中 | 物件名等の入力でHTMLエスケープ不足 | 入力値のサニタイゼーション実装 | - | 1週間 | 🔴 未対応 | [#012](https://github.com/username/repo/issues/012) | 🟡 シミュレーター機能のみ | **テスト1**: 悪意のある入力値→サニタイゼーション確認<br>**テスト2**: 正常な入力値の動作確認<br>**テスト3**: シミュレーター機能の正常動作確認 |
| SEC-013 | 数値入力フィールドの範囲検証 | `bolt_front/src/pages/Simulator.tsx:834` | 入力検証不足 | 中 | 極端な値の入力が可能 | 適切な範囲検証の実装 | - | 1週間 | 🔴 未対応 | [#013](https://github.com/username/repo/issues/013) | 🟡 シミュレーター機能のみ | **テスト1**: 極端な値の入力拒否確認<br>**テスト2**: 正常な値の入力確認<br>**テスト3**: 計算結果の正確性確認 |
| SEC-014 | ファイル名パストラバーサル | `bolt_front/src/hooks/useImageUpload.ts:64` | パストラバーサル | 中 | ファイル名の検証不足 | ファイル名サニタイゼーション | - | 1週間 | 🔴 未対応 | [#014](https://github.com/username/repo/issues/014) | 🟡 ファイルアップロード機能のみ | **テスト1**: 危険なファイル名の拒否確認<br>**テスト2**: 正常なファイル名の処理確認<br>**テスト3**: ファイルアップロード機能の正常動作確認 |
| SEC-015 | 物件名・場所フィールドXSS | `bolt_front/src/pages/Simulator.tsx:664,681` | Cross-Site Scripting | 高 | テキスト入力でHTMLエスケープなし | 入力値のサニタイゼーション実装 | - | 即座 | 🔴 未対応 | [#015](https://github.com/username/repo/issues/015) | 🟡 物件情報入力機能のみ | **テスト1**: 悪意のある入力値→サニタイゼーション確認<br>**テスト2**: 正常な入力値の動作確認<br>**テスト3**: 物件情報機能の正常動作確認 |
| SEC-016 | メモフィールドXSS | `bolt_front/src/pages/Simulator.tsx:1408` | Cross-Site Scripting | 高 | 長文テキストでHTMLエスケープなし | DOMPurifyによるサニタイゼーション | - | 即座 | 🔴 未対応 | [#016](https://github.com/username/repo/issues/016) | 🟡 メモ機能のみ | **テスト1**: 悪意のある長文入力→サニタイゼーション確認<br>**テスト2**: 正常な長文入力の動作確認<br>**テスト3**: メモ機能の正常動作確認 |
| SEC-017 | 数値フィールド範囲外入力 | `bolt_front/src/pages/Simulator.tsx:全数値入力` | 入力検証不足 | 中 | 負数・Infinity・NaN入力可能 | 各フィールドの範囲検証実装 | - | 1週間 | 🔴 未対応 | [#017](https://github.com/username/repo/issues/017) | 🟡 数値入力機能のみ | **テスト1**: 無効な数値入力の拒否確認<br>**テスト2**: 正常な数値入力の処理確認<br>**テスト3**: 計算機能の正常動作確認 |
| SEC-018 | 借入額と購入価格の論理検証 | `bolt_front/src/pages/Simulator.tsx:1025,831` | 論理検証不足 | 中 | 借入額>購入価格が可能 | 論理的整合性チェック実装 | - | 1週間 | 🔴 未対応 | [#018](https://github.com/username/repo/issues/018) | 🟡 シミュレーター機能のみ | **テスト1**: 論理的に矛盾した入力の拒否確認<br>**テスト2**: 正常な入力の処理確認<br>**テスト3**: 計算結果の正確性確認 |
| SEC-019 | 実効税率・空室率の範囲検証 | `bolt_front/src/pages/Simulator.tsx:1200,979` | 入力検証不足 | 中 | 100%超の入力が可能 | 0-100%範囲制限の実装 | - | 1週間 | 🔴 未対応 | [#019](https://github.com/username/repo/issues/019) | 🟡 シミュレーター機能のみ | **テスト1**: 範囲外の値入力の拒否確認<br>**テスト2**: 正常な範囲の値入力確認<br>**テスト3**: 計算結果の正確性確認 |
| SEC-020 | FastAPI DoS攻撃脆弱性 | `backend/simulator-api/requirements.txt` | CVE-2024-24762 | 高 | FastAPI 0.99.1 ReDoS攻撃 | FastAPI 0.109.1以降への更新 | - | 即座 | 🔴 未対応 | [#020](https://github.com/username/repo/issues/020) | 🔴 バックエンドAPI全体影響 | **テスト1**: DoS攻撃の防止確認<br>**テスト2**: API機能の正常動作確認<br>**テスト3**: パフォーマンスの確認 |
| SEC-021 | esbuild任意リクエスト送信 | `bolt_front/package.json` | CVE-2024-XXXX | 高 | esbuild 0.21.5脆弱性 | Vite 6.3.5以降への更新 | - | 即座 | 🔴 未対応 | [#021](https://github.com/username/repo/issues/021) | 🟡 ビルドシステムのみ | **テスト1**: ビルドプロセスの安全性確認<br>**テスト2**: 正常なビルド動作確認<br>**テスト3**: 全機能の正常動作確認 |
| SEC-022 | API認証システムの不在 | `backend/simulator-api/app.py` | 認証不備 | 高 | 全APIが認証なしでアクセス可能 | JWT認証またはAPIキー認証の実装 | - | 即座 | 🔴 未対応 | [#022](https://github.com/username/repo/issues/022) | 🔴 全API機能影響 | **テスト1**: 認証なしアクセスの拒否確認<br>**テスト2**: 認証付きアクセスの正常動作確認<br>**テスト3**: 全API機能の正常動作確認 |
| SEC-023 | 機密情報のログ出力 | `bolt_front/src/全般` | 情報漏洩 | 中 | 206件のconsole.log文に機密情報 | 本番環境でのログ出力完全削除 | - | 1週間 | 🔴 未対応 | [#023](https://github.com/username/repo/issues/023) | 🟡 情報セキュリティ全般 | **テスト1**: 本番環境での機密情報ログ出力なし確認<br>**テスト2**: 開発環境でのログ機能確認<br>**テスト3**: 全機能の正常動作確認 |
| SEC-024 | jsPDF脆弱性 | `bolt_front/package.json` | CVE-2025-29907 | 中 | jsPDF 3.0.1脆弱性 | jsPDF最新版への更新 | - | 1週間 | 🔴 未対応 | [#024](https://github.com/username/repo/issues/024) | 🟡 PDF生成機能のみ | **テスト1**: PDF生成の安全性確認<br>**テスト2**: 正常なPDF生成確認<br>**テスト3**: PDF機能の正常動作確認 |
| SEC-025 | レート制限の不在 | `bolt_front/src/hooks/useApiCall.ts` | DoS攻撃 | 中 | API呼び出しに制限なし | レート制限とリクエスト頻度制御 | - | 1週間 | 🔴 未対応 | [#025](https://github.com/username/repo/issues/025) | 🟡 API通信全般 | **テスト1**: レート制限の動作確認<br>**テスト2**: 正常なAPI呼び出し確認<br>**テスト3**: 全機能の正常動作確認 |
| SEC-026 | エラー情報の詳細漏洩 | `bolt_front/src/全般` | 情報漏洩 | 中 | 詳細なエラーメッセージ出力 | エラーメッセージの汎用化 | - | 1週間 | 🔴 未対応 | [#026](https://github.com/username/repo/issues/026) | 🟡 エラーハンドリング全般 | **テスト1**: エラー情報の漏洩防止確認<br>**テスト2**: 適切なエラーメッセージ表示確認<br>**テスト3**: エラー処理の正常動作確認 |
| SEC-027 | ポリグロットファイル攻撃 | `bolt_front/src/components/ImageUpload.tsx` | ファイル偽装 | 中 | 画像+スクリプト両方解釈可能 | ファイル内容の厳密検証 | - | 1週間 | 🔴 未対応 | [#027](https://github.com/username/repo/issues/027) | 🟡 ファイルアップロード機能のみ | **テスト1**: ポリグロットファイルの拒否確認<br>**テスト2**: 正常なファイルアップロード確認<br>**テスト3**: ファイル処理の安全性確認 |
| SEC-028 | 外部URL検証不備 | `bolt_front/src/pages/Login.tsx` | リダイレクト攻撃 | 中 | window.location.href直接操作 | URL許可リストによる制限 | - | 1週間 | 🔴 未対応 | [#028](https://github.com/username/repo/issues/028) | 🟡 ログイン機能のみ | **テスト1**: 不正なリダイレクトの防止確認<br>**テスト2**: 正常なリダイレクト確認<br>**テスト3**: ログイン機能の正常動作確認 |
| SEC-029 | innerHTML使用によるXSS | `bolt_front/src/components/PDFPreviewModal.tsx:74` | Cross-Site Scripting | 中 | innerHTML直接使用 | 安全なDOM操作への変更 | - | 1週間 | 🔴 未対応 | [#029](https://github.com/username/repo/issues/029) | 🟡 PDF機能のみ | **テスト1**: XSS攻撃の防止確認<br>**テスト2**: 正常なDOM操作確認<br>**テスト3**: PDF機能の正常動作確認 |
| SEC-030 | 機密データ平文保存 | `bolt_front/src/全般` | データ保護 | 中 | 投資情報が暗号化されず保存 | 機密データの暗号化実装 | - | 1週間 | 🔴 未対応 | [#030](https://github.com/username/repo/issues/030) | 🟡 データ保存全般 | **テスト1**: 機密データの暗号化確認<br>**テスト2**: 正常なデータ保存・読み込み確認<br>**テスト3**: 全機能の正常動作確認 |

### 優先度：低（長期的な改善）

**🔧 説明**: 以下の問題は**1ヶ月以内に対応**すれば良い問題です。

**初心者向け解説**:
- これらの問題は、直接的な攻撃の危険性は低いですが、システムの安全性を向上させるために対応が必要です
- 「古いライブラリバージョン」は、使用しているソフトウェアが古くて、将来的に脆弱性が発見される可能性があります
- 「セキュリティヘッダー」は、ブラウザに「このサイトは安全です」と伝えるための設定です

| 課題ID | 課題名 | 対象ファイル | 脆弱性の種類 | 影響度 | 現在の状況 | 対策内容 | 担当者 | 期限 | ステータス | GitHub Issue | SaaS機能への影響 | 修正後のテストシナリオ |
|--------|--------|--------------|-------------|--------|------------|----------|--------|------|-----------|-------------|------------------|----------------|
| SEC-031 | 古いライブラリバージョン | `bolt_front/package.json` | 依存関係 | 低 | Lucide React等の旧バージョン | 定期的なライブラリ更新 | - | 1ヶ月 | 🔴 未対応 | [#031](https://github.com/username/repo/issues/031) | 🟡 フロントエンド全般 | **テスト1**: ライブラリの更新確認<br>**テスト2**: 互換性の確認<br>**テスト3**: 全機能の正常動作確認 |
| SEC-032 | SRIの未実装 | `bolt_front/src/components/PDFPreviewModal.tsx` | 外部リソース | 低 | Google FontsのSRI未実装 | Subresource Integrity追加 | - | 1ヶ月 | 🔴 未対応 | [#032](https://github.com/username/repo/issues/032) | 🟡 外部リソース読み込みのみ | **テスト1**: 外部リソースの整合性検証<br>**テスト2**: 改ざんされたリソースの読み込み拒否<br>**テスト3**: 正常なリソース読み込み確認 |
| SEC-033 | Certificate Pinningの不在 | `bolt_front/src/全般` | ネットワーク | 低 | 証明書固定未実装 | Certificate Pinning実装 | - | 1ヶ月 | 🔴 未対応 | [#033](https://github.com/username/repo/issues/033) | 🟡 通信セキュリティのみ | **テスト1**: HTTPS通信の証明書検証<br>**テスト2**: 中間者攻撃防止確認<br>**テスト3**: 正常なHTTPS通信の動作確認 |
| SEC-034 | 危険なRLS無効化ファイル削除 | `dev-tools/database-scripts/temp_disable_rls.sql` | データベースセキュリティ | 高 | 全テーブルのRLS無効化 | ファイル削除と安全な代替手段の提供 | - | 即座 | 🔴 未対応 | [#034](https://github.com/username/repo/issues/034) | 🔴 全データベース影響・要検証 | **テスト1**: 本番環境でRLS無効化ファイルが実行されない<br>**テスト2**: 全テーブルのRLS有効状態確認<br>**テスト3**: 開発環境での代替手段動作確認 |
| SEC-035 | 本番環境でのトークン情報ログ出力 | `src/pages/AuthCallback.tsx:82` | 情報漏洩 | 高 | 認証トークンがログ出力される | 本番環境でのログ出力無効化 | - | 1週間 | 🔴 未対応 | [#035](https://github.com/username/repo/issues/035) | 🟡 認証システムのみ | **テスト1**: 本番環境でトークンがログ出力されない<br>**テスト2**: 認証機能の正常動作確認<br>**テスト3**: ログレベル制御の動作確認 |
| SEC-036 | 開発用認証情報の漏洩 | `debug_url.js` | 情報漏洩 | 中 | 認証URLとトークンが含まれる | ファイル削除と.gitignore追加 | - | 1ヶ月 | 🔴 未対応 | [#036](https://github.com/username/repo/issues/036) | 🟡 認証システムのみ | **テスト1**: 本番環境にデバッグファイルが存在しない<br>**テスト2**: 認証機能の正常動作確認<br>**テスト3**: .gitignoreの適切な設定確認 |
| SEC-037 | 緩いRLSポリシーの実装 | `supabase/safe_debug_policies.sql` | Row Level Security | 高 | 開発用の緩いポリシーが存在 | 本番環境で適切なポリシーに置き換え | - | 1週間 | 🔴 未対応 | [#037](https://github.com/username/repo/issues/037) | 🔴 全データベーステーブル影響 | **テスト1**: 本番環境で適切なRLSポリシーが適用<br>**テスト2**: 不正アクセスの防止確認<br>**テスト3**: 全機能の正常動作確認 |
| SEC-038 | モック認証の本番環境実行 | `src/hooks/useSupabaseAuth.ts` | 認証バイパス | 高 | Supabaseエラー時にモック認証有効化 | 本番環境でのモック認証無効化 | - | 即座 | 🔴 未対応 | [#038](https://github.com/username/repo/issues/038) | 🔴 全システム影響・要検証 | **テスト1**: 本番環境でモック認証が実行されない<br>**テスト2**: 適切なエラーハンドリング確認<br>**テスト3**: 全機能の正常動作確認 |
| SEC-039 | Edge Functionでの機密情報ログ出力 | `supabase/functions/send-invitation/index.ts` | 情報漏洩 | 中 | Supabaseエラー詳細がログ記録 | 機密情報をマスクしたログ出力 | - | 1ヶ月 | 🔴 未対応 | [#039](https://github.com/username/repo/issues/039) | 🟡 メール送信機能のみ | **テスト1**: 本番環境で機密情報がログ出力されない<br>**テスト2**: メール送信機能の正常動作確認<br>**テスト3**: エラーハンドリングの適切な処理確認 |
| SEC-040 | Service Role Keyの不適切な使用 | `supabase/functions/send-invitation/index.ts:21` | 権限管理 | 中 | Service Role Keyが使用されている | 最小権限の原則に従った権限設定 | - | 1ヶ月 | 🔴 未対応 | [#040](https://github.com/username/repo/issues/040) | 🟡 メール送信機能のみ | **テスト1**: Service Role Keyが適切に制限されている<br>**テスト2**: メール送信機能の正常動作確認<br>**テスト3**: 監査ログの実装確認 |
| SEC-041 | 開発環境判定の不備 | `src/hooks/useShareCRUD.ts:43` | 環境判定 | 高 | プロパティIDで開発環境判定 | 環境変数による環境判定 | - | 1週間 | 🔴 未対応 | [#041](https://github.com/username/repo/issues/041) | 🟡 共有機能のみ | **テスト1**: 本番環境で開発モードが無効化<br>**テスト2**: 共有機能の正常動作確認<br>**テスト3**: 環境判定ロジックの適切な動作確認 |
| SEC-042 | 一時的なテストコメント機能 | `src/hooks/useShareComments.ts:33` | テスト機能 | 低 | テストコメント作成機能が存在 | 本番環境でのテスト機能無効化 | - | 1ヶ月 | 🔴 未対応 | [#042](https://github.com/username/repo/issues/042) | 🟡 コメント機能のみ | **テスト1**: 本番環境でテストコメントが作成されない<br>**テスト2**: コメント機能の正常動作確認<br>**テスト3**: 環境変数による制御確認 |
| SEC-043 | 自動テストスクリプトの本番環境実行 | `test-data/auto-test.mjs` | テスト機能 | 低 | 本番環境でのテスト実行 | 本番環境でのテストスクリプト実行無効化 | - | 1ヶ月 | 🔴 未対応 | [#043](https://github.com/username/repo/issues/043) | 🟡 テスト機能のみ | **テスト1**: 本番環境でテストスクリプトが実行されない<br>**テスト2**: テスト機能の適切な制限確認<br>**テスト3**: ディレクトリ構成の適切性確認 |
| SEC-044 | 環境変数の設定不備 | `src/lib/supabase.ts` | 環境設定 | 中 | 環境変数未設定時のエラーハンドリング | 本番環境での適切な環境変数設定 | - | 1ヶ月 | 🔴 未対応 | [#044](https://github.com/username/repo/issues/044) | 🔴 Supabase接続全体影響 | **テスト1**: 本番環境で環境変数が正しく設定<br>**テスト2**: 設定チェック機能の動作確認<br>**テスト3**: エラーハンドリングの改善確認 |
| SEC-045 | DOM操作でのinnerHTMLの危険な使用 | `src/components/PropertyCard.tsx:89` | XSS攻撃 | 高 | 動的HTML生成でXSS攻撃リスク | DOMPurifyによるサニタイゼーション | - | 即座 | 🔴 未対応 | [#045](https://github.com/username/repo/issues/045) | 🔴 全フロントエンド機能影響 | **テスト1**: 悪意のあるHTML投入→スクリプト実行されず<br>**テスト2**: 正常なHTML表示確認<br>**テスト3**: 全コンポーネントの動作確認 |
| SEC-046 | CORS設定の過度な許可 | `backend/simulator-api/app.py:30` | CORS設定 | 高 | 任意のオリジンからの攻撃リスク | 特定ドメインのみ許可する設定 | - | 即座 | 🔴 未対応 | [#046](https://github.com/username/repo/issues/046) | 🔴 全API通信影響 | **テスト1**: 不正オリジンからのアクセス拒否<br>**テスト2**: 正常なAPI通信確認<br>**テスト3**: 全機能の動作確認 |
| SEC-047 | localStorage機密情報保存 | `src/hooks/useSupabaseAuth.ts:205` | 認証情報漏洩 | 高 | 認証情報がブラウザに保存される | HTTPOnlyクッキーまたは暗号化 | - | 即座 | 🔴 未対応 | [#047](https://github.com/username/repo/issues/047) | 🔴 認証システム全体影響 | **テスト1**: 認証情報がlocalStorageに保存されない<br>**テスト2**: 認証機能の正常動作確認<br>**テスト3**: セッション管理の動作確認 |
| SEC-048 | CSPヘッダーの欠如 | `bolt_front/vite.config.ts` | XSS攻撃対策 | 高 | インラインスクリプトの実行許可 | Content Security Policy実装 | - | 1週間 | 🔴 未対応 | [#048](https://github.com/username/repo/issues/048) | 🟡 全フロントエンド機能 | **テスト1**: インラインスクリプトが制限される<br>**テスト2**: 正常なスクリプト実行確認<br>**テスト3**: 全機能の動作確認 |
| SEC-049 | console.logによる情報漏洩 | `src/全般（37ファイル363箇所）` | 情報漏洩 | 高 | 機密情報が本番環境で露出 | 本番環境でのログ出力無効化 | - | 1週間 | 🔴 未対応 | [#049](https://github.com/username/repo/issues/049) | 🟡 全システム情報セキュリティ | **テスト1**: 本番環境で機密情報がログ出力されない<br>**テスト2**: 開発環境でのログ機能確認<br>**テスト3**: 全機能の正常動作確認 |
| SEC-050 | 一時パスワードの脆弱性 | `src/utils/passwordGenerator.ts` | 認証セキュリティ | 高 | 予測可能なパスワード生成 | 暗号学的に安全な乱数生成 | - | 1週間 | 🔴 未対応 | [#050](https://github.com/username/repo/issues/050) | 🟡 パスワード機能のみ | **テスト1**: 生成されたパスワードの予測不可能性<br>**テスト2**: パスワード強度の検証<br>**テスト3**: 認証機能の正常動作確認 |
| SEC-051 | セッション固定攻撃対策の不備 | `src/hooks/useSupabaseAuth.ts` | セッション管理 | 中 | セッションID固定化攻撃 | ログイン時のセッションID再生成 | - | 1ヶ月 | 🔴 未対応 | [#051](https://github.com/username/repo/issues/051) | 🟡 認証システムのみ | **テスト1**: ログイン時のセッションID変更確認<br>**テスト2**: セッション固定攻撃の防止確認<br>**テスト3**: 認証機能の正常動作確認 |
| SEC-052 | ファイルアップロード時の検証不足 | `backend/simulator-api/upload.py` | ファイルアップロード | 中 | サーバー側での検証不足 | サーバー側での厳密な検証実装 | - | 1ヶ月 | 🔴 未対応 | [#052](https://github.com/username/repo/issues/052) | 🟡 ファイルアップロード機能のみ | **テスト1**: 悪意のあるファイルアップロード拒否<br>**テスト2**: 正常なファイルアップロード確認<br>**テスト3**: ファイル検証機能の動作確認 |
| SEC-053 | エラーハンドリングでの情報漏洩 | `backend/simulator-api/error_handlers.py` | 情報漏洩 | 中 | 詳細なエラーメッセージ | 汎用的なエラーメッセージ実装 | - | 1ヶ月 | 🔴 未対応 | [#053](https://github.com/username/repo/issues/053) | 🟡 エラーハンドリング全般 | **テスト1**: 詳細なエラー情報が漏洩しない<br>**テスト2**: 適切なエラーメッセージ表示<br>**テスト3**: エラー処理の正常動作確認 |
| SEC-054 | HTTPSリダイレクトの不備 | `backend/simulator-api/app.py` | 通信セキュリティ | 低 | HTTP接続の許可 | 強制HTTPSリダイレクト実装 | - | 1ヶ月 | 🔴 未対応 | [#054](https://github.com/username/repo/issues/054) | 🟡 通信セキュリティのみ | **テスト1**: HTTP接続が自動的にHTTPSリダイレクト<br>**テスト2**: HTTPS通信の正常動作確認<br>**テスト3**: 全機能の動作確認 |
| SEC-055 | キャッシュ制御の不適切な設定 | `src/utils/apiClient.ts` | キャッシュセキュリティ | 低 | 機密情報のキャッシュ | 適切なキャッシュ制御ヘッダー設定 | - | 1ヶ月 | 🔴 未対応 | [#055](https://github.com/username/repo/issues/055) | 🟡 API通信のみ | **テスト1**: 機密情報がキャッシュされない<br>**テスト2**: 適切なキャッシュ制御確認<br>**テスト3**: パフォーマンスの確認 |
| SEC-056 | 外部リソースの整合性検証不足 | `public/index.html` | 外部リソース | 低 | CDNからのリソース改ざん | Subresource Integrity実装 | - | 1ヶ月 | 🔴 未対応 | [#056](https://github.com/username/repo/issues/056) | 🟡 外部リソース読み込みのみ | **テスト1**: 外部リソースの整合性検証<br>**テスト2**: 改ざんされたリソースの読み込み拒否<br>**テスト3**: 正常なリソース読み込み確認 |
| SEC-057 | データベース永続化システムの欠如 | `backend/simulator-api/app.py` | データ永続化 | 高 | 計算結果・ユーザーデータが保存されない | PostgreSQL/SQLiteデータベース実装 | - | 即座 | 🔴 未対応 | [#057](https://github.com/username/repo/issues/057) | 🔴 全データ保存機能影響 | **テスト1**: データベース接続確認<br>**テスト2**: データ保存・読み込み確認<br>**テスト3**: 全機能のデータ永続化確認 |
| SEC-058 | 数値計算における整数オーバーフロー攻撃 | `backend/simulator-api/shared/calculations.py` | DoS攻撃 | 高 | 極大値による計算エンジン攻撃でメモリ枯渇 | 数値範囲制限とエラーハンドリング強化 | - | 1週間 | 🔴 未対応 | [#058](https://github.com/username/repo/issues/058) | 🟡 計算機能のみ | **テスト1**: 極大値入力の拒否確認<br>**テスト2**: 正常な計算処理確認<br>**テスト3**: メモリ使用量の制限確認 |
| SEC-059 | Python Pickle/eval攻撃経路 | `backend/simulator-api/app.py` | リモートコード実行 | 高 | Pythonデシリアライゼーション攻撃 | 安全なJSONパース実装とeval使用禁止 | - | 1週間 | 🔴 未対応 | [#059](https://github.com/username/repo/issues/059) | 🔴 バックエンド全体影響 | **テスト1**: 悪意のあるペイロード拒否確認<br>**テスト2**: JSON処理の正常動作確認<br>**テスト3**: コード実行の防止確認 |
| SEC-060 | FastAPI自動ドキュメント機能の情報漏洩 | `backend/simulator-api/app.py` | 情報漏洩 | 中 | `/docs`, `/redoc`でAPI構造露出 | 本番環境での自動ドキュメント無効化 | - | 1週間 | 🔴 未対応 | [#060](https://github.com/username/repo/issues/060) | 🟡 API情報のみ | **テスト1**: 本番環境でドキュメントアクセス拒否<br>**テスト2**: API機能の正常動作確認<br>**テスト3**: 開発環境でのドキュメント利用確認 |
| SEC-061 | Streamlit開発サーバーの本番環境漏洩 | `backend/simulator-api/streamlit_dev.py` | 開発機能漏洩 | 中 | 開発用サーバーが本番環境で実行可能 | 本番環境での開発ファイル除外 | - | 1週間 | 🔴 未対応 | [#061](https://github.com/username/repo/issues/061) | 🟡 開発機能のみ | **テスト1**: 本番環境でStreamlitアクセス不可<br>**テスト2**: 開発環境での機能確認<br>**テスト3**: ファイル除外設定の確認 |
| SEC-062 | uvicorn設定の不適切なバインド | `backend/simulator-api/app.py` | ネットワークセキュリティ | 低 | 0.0.0.0バインドによる外部アクセス許可 | 適切なホストバインド設定 | - | 1ヶ月 | 🔴 未対応 | [#062](https://github.com/username/repo/issues/062) | 🟡 ネットワーク設定のみ | **テスト1**: 外部からの不正アクセス防止<br>**テスト2**: 正常なAPI通信確認<br>**テスト3**: ネットワーク設定の確認 |

---

## 🔧 SaaS機能への影響分析と検証について

### 📊 セキュリティ修正がSaaS機能に与える影響

**🔴 全システム影響・要検証**
- 認証システムの変更により、ログイン・セッション管理に大きな影響
- 全機能の動作確認が必要

**🟡 部分的な影響**
- 特定の機能のみに影響
- 該当機能の動作確認が必要

**🟢 影響なし**
- 既存機能に影響を与えない
- 基本的な動作確認のみ

### 🧪 各課題修正後の必須検証項目

#### 重大リスク課題の検証

**SEC-001 (XSS攻撃対策)**
- ✅ コメント投稿機能の動作確認
- ✅ コメント表示の正常性確認
- ✅ HTMLタグの適切な除去確認
- ✅ 既存コメントの表示確認

**SEC-002 (モック認証の本番無効化)**
- ✅ 正常なログイン・ログアウト機能
- ✅ 認証が必要な全ページへのアクセス
- ✅ シミュレーターの動作確認
- ✅ データ保存・読み込み機能
- ✅ 共有機能の動作確認
- ⚠️ **要注意**: 既存のモック認証ユーザーがログインできなくなる

**SEC-003 (CORS設定の厳密化)**
- ✅ 外部API（シミュレーター）との通信
- ✅ 画像アップロード機能
- ✅ 不動産情報検索機能
- ✅ PDFエクスポート機能

**SEC-010 (画像アップロード偽装攻撃)**
- ✅ 画像アップロード機能
- ✅ 画像表示機能
- ✅ 各種画像フォーマット対応
- ✅ ファイルサイズ制限

**SEC-011 (URL入力でのスクリプト実行)**
- ✅ 物件URL入力機能
- ✅ URLの正常な検証
- ✅ 外部リンクの動作

### 🎯 シミュレーター機能への具体的な影響

**認証システム変更による影響**
- 🔴 **高リスク**: シミュレーション結果の保存・読み込みが動作しない可能性
- 🔴 **高リスク**: 共有機能が動作しない可能性
- 🔴 **高リスク**: 過去の計算結果にアクセスできない可能性

**入力検証強化による影響**
- 🟡 **中リスク**: 物件名・住所入力で特殊文字が使用できない可能性
- 🟡 **中リスク**: 数値入力で極端な値が入力できない可能性
- 🟡 **中リスク**: URL入力で一部のURLが使用できない可能性

**API通信変更による影響**
- 🟡 **中リスク**: 外部API（シミュレーター）との通信エラー
- 🟡 **中リスク**: 計算結果の取得に失敗する可能性

### 🔄 検証が必要な理由

**なぜ毎回検証が必要？**
1. **セキュリティ対策は既存機能に影響する**: 入力検証の強化により、今まで通らなかった入力が弾かれる
2. **認証システムの変更は全機能に影響**: ログイン方法が変わると、データの保存・読み込みに影響
3. **API通信の変更は外部連携に影響**: CORS設定変更により、外部サービスとの通信が失敗する可能性

**検証を怠った場合の問題**
- シミュレーション結果が保存されない
- 過去のデータが読み込めない
- 計算機能が動作しない
- 共有機能が使用できない

### 📋 推奨される検証手順

**1. 修正前の動作確認**
- 現在の機能の動作を記録
- テストケースを作成

**2. 修正後の基本動作確認**
- 修正した機能の動作確認
- 関連機能の動作確認

**3. 統合テスト**
- 全機能の連携動作確認
- ユーザーシナリオに基づくテスト

**4. 本番環境での確認**
- 段階的なリリース
- 監視体制の準備

---

## 💡 初心者向け：よくある質問

**Q1: これらの脆弱性は本当に危険なのですか？**
A1: はい、非常に危険です。特に「認証バイパス」は、誰でも他人になりすましてログインできてしまう状態です。これは、家の鍵が壊れていて、誰でも入れる状態と同じです。

**Q2: 攻撃者はどのようにして攻撃を仕掛けるのですか？**
A2: 多くの攻撃は、普通のユーザーが行う操作（コメント投稿、ファイルアップロード、URLアクセス）を悪用して行われます。特別な技術は必要ありません。

**Q3: 対策にはどのくらいの時間がかかりますか？**
A3: 重大な問題（認証バイパス、XSS対策）は1-2日で対応可能です。全ての問題を解決するには、1-2週間程度の作業が必要です。

**Q4: 対策をしないとどうなりますか？**
A4: 以下のような被害が発生する可能性があります：
- 全ユーザーの個人情報と投資データが盗まれる
- システムが乗っ取られて、悪意のあるコードが実行される
- サービスが停止して、ユーザーが利用できなくなる
- 企業の信頼失墜と法的責任

**Q5: 本番環境で使用しても大丈夫ですか？**
A5: **絶対にダメです。** 現在の状態で本番環境で使用すると、確実に攻撃を受けます。少なくとも「重大リスク」の10件は解決してから使用してください。

---

## 📋 対策の実装手順（初心者向け）

### ステップ1: 緊急対応（24時間以内）
1. **本番環境のサービス停止**
   - 現在本番環境で動作している場合、すぐに停止してください
   - ユーザーには「メンテナンス中」と表示してください

2. **認証システムの無効化**
   - `useSupabaseAuth.ts`ファイルのモック認証機能を削除
   - 本番環境では、必ず正式な認証システムを使用

3. **コメント機能の一時停止**
   - XSS攻撃の危険性が高いため、コメント機能を一時的に停止
   - 対策完了後に再開

### ステップ2: 基本的な対策（1週間以内）
1. **入力値の検証とサニタイゼーション**
   - DOMPurifyライブラリを導入
   - 全ての入力フィールドに検証を追加

2. **ファイルアップロード制限**
   - 画像ファイルの内容を実際に確認
   - 危険なファイルの除外

3. **API認証の実装**
   - JWTトークンまたはAPIキーによる認証
   - 不正アクセスの防止

### ステップ3: 包括的な対策（1ヶ月以内）
1. **セキュリティヘッダーの設定**
2. **ログ出力の整理**
3. **ライブラリの更新**
4. **定期的なセキュリティチェック体制の構築**

---

## 詳細な対策内容

### SEC-001: XSS攻撃対策

**🔰 初心者向け解説**:
この問題は、コメント機能で悪意のあるプログラムコードを投稿された場合、そのコードがそのまま実行されてしまう問題です。例えば、コメントに「`<script>alert('攻撃')</script>`」と書かれると、そのコメントを見た人のブラウザで警告が表示されます。実際の攻撃では、個人情報を盗むコードが実行される可能性があります。

**📍 影響範囲**:
- 🎯 **直接影響**: コメント機能（表示・投稿）
- 🔗 **間接影響**: 共有機能（コメント付き共有）
- 👥 **影響ユーザー**: コメントを閲覧する全ユーザー
- 🚫 **影響なし**: シミュレーター計算、物件情報入力、画像アップロード

**🧪 検証範囲**:
- ✅ **必須検証**: コメント投稿→表示→HTMLタグ除去確認
- ✅ **必須検証**: 既存コメントの正常表示
- ✅ **必須検証**: 太字・斜体などの安全なHTMLタグは保持
- ✅ **必須検証**: 共有機能でのコメント表示
- ⚠️ **注意**: 既存の悪意のあるコメントがある場合は手動削除が必要

**現在の問題コード:**
```tsx
<p className="text-gray-800 whitespace-pre-wrap leading-relaxed">
  {comment.content}
</p>
```

**対策実装例（初心者向け手順）:**
```tsx
// 1. まず、DOMPurifyライブラリをインストール
// npm install dompurify

// 2. ファイルの最初でライブラリを読み込み
import DOMPurify from 'dompurify';

// 3. 安全にコメントを表示する関数を作成
const sanitizeContent = (content: string) => {
  return DOMPurify.sanitize(content, {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'br'], // 許可するHTMLタグ
    ALLOWED_ATTR: [] // 許可する属性（なし）
  });
};

// 4. コメント表示部分を修正
<p className="text-gray-800 whitespace-pre-wrap leading-relaxed"
   dangerouslySetInnerHTML={{ __html: sanitizeContent(comment.content) }}
/>
```

**🔰 この対策の効果**:
- 悪意のあるスクリプトタグは自動的に除去される
- 安全なHTMLタグ（太字、斜体など）は保持される
- ユーザーがコメントを見ても、悪意のあるコードは実行されない

### SEC-002: モック認証の本番無効化

**🔰 初心者向け解説**:
現在のシステムでは、開発やテスト用の「偽の認証システム」が本番環境でも動作してしまいます。これは、任意のメールアドレスを入力するだけで、誰でもログインできてしまうという非常に危険な状態です。例えば、「admin@example.com」と入力するだけで、管理者としてログインできてしまう可能性があります。

**📍 影響範囲**:
- 🎯 **直接影響**: 認証システム全体（ログイン・ログアウト・セッション管理）
- 🔗 **間接影響**: 全ての機能（データ保存・読み込み・共有・計算結果）
- 👥 **影響ユーザー**: 全ユーザー（既存のモック認証ユーザーはログイン不可）
- 🚫 **影響なし**: 認証不要な機能（計算のみ）

**🧪 検証範囲**:
- ✅ **必須検証**: 正常なメール・パスワードでのログイン
- ✅ **必須検証**: 不正なメール・パスワードでのログイン拒否
- ✅ **必須検証**: ログイン後の全機能動作（シミュレーター・共有・保存）
- ✅ **必須検証**: セッション管理（ログアウト・自動ログアウト）
- ✅ **必須検証**: データの保存・読み込み
- ⚠️ **重要**: 既存のモック認証ユーザーデータの移行またはクリーンアップが必要

**現在の問題コード:**
```typescript
if ((email === 'demo@ooya-dx.com' && password === 'demo123') || email.includes('@')) {
  // 任意のメールアドレスでログイン成功
}
```

**対策実装例（初心者向け手順）:**
```typescript
// 1. 環境を判定する変数を作成
const isProduction = process.env.NODE_ENV === 'production';
const isDevelopment = process.env.NODE_ENV === 'development';

const signIn = async (email: string, password: string) => {
  // 2. 本番環境では、必ずSupabase認証を使用
  if (isProduction) {
    if (!import.meta.env.VITE_SUPABASE_URL) {
      throw new Error('認証サービスが設定されていません');
    }
    // 本番環境では偽認証を絶対に使用しない
    return supabaseSignIn(email, password);
  }
  
  // 3. 開発環境でのみ偽認証を許可
  if (isDevelopment && !import.meta.env.VITE_SUPABASE_URL) {
    console.warn('開発環境: モック認証を使用中');
    return mockSignIn(email, password);
  }
  
  // 4. 通常はSupabase認証を使用
  return supabaseSignIn(email, password);
};
```

**🔰 この対策の効果**:
- 本番環境では、偽の認証システムは完全に無効化される
- 開発環境では、必要に応じて偽認証を使用可能
- 正式な認証システム（Supabase）のみが本番環境で動作する
- 不正ログインを防ぐことができる

**🔰 追加で必要な作業**:
1. 本番環境でSupabaseの設定を確認
2. 環境変数（VITE_SUPABASE_URL）が正しく設定されているか確認
3. 既存のモック認証で作成されたユーザーデータを削除

### SEC-003: CORS設定の厳密化

**🔰 初心者向け解説**:
CORS（Cross-Origin Resource Sharing）とは、異なるドメインからのAPIアクセスを制御する仕組みです。現在の設定では、どのサイトからでもAPIにアクセスできてしまうため、悪意のあるサイトがユーザーのデータを不正に取得する可能性があります。

**📍 影響範囲**:
- 🎯 **直接影響**: 外部API通信（シミュレーター計算・不動産情報検索）
- 🔗 **間接影響**: 画像アップロード・PDFエクスポート
- 👥 **影響ユーザー**: 外部サービス利用時の全ユーザー
- 🚫 **影響なし**: 内部機能（コメント・認証・データ保存）

**🧪 検証範囲**:
- ✅ **必須検証**: シミュレーター計算の正常動作
- ✅ **必須検証**: 不動産情報検索の正常動作
- ✅ **必須検証**: 画像アップロード機能
- ✅ **必須検証**: PDFエクスポート機能
- ✅ **必須検証**: 許可されていないドメインからのアクセス拒否
- ⚠️ **注意**: 開発環境と本番環境で異なる設定が必要

**現在の問題コード:**
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 危険な設定
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**対策実装例:**
```python
import os

ALLOWED_ORIGINS = {
    'development': ['http://localhost:3000', 'http://localhost:5173'],
    'production': ['https://your-domain.com']
}

current_env = os.getenv('ENVIRONMENT', 'development')
allowed_origins = ALLOWED_ORIGINS.get(current_env, ['http://localhost:3000'])

app.add_middleware(
    CORSMiddleware,
    allow_origins=allowed_origins,
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["Content-Type", "Authorization"],
)
```

### SEC-004: CSRF対策の実装

**対策実装例:**
```typescript
const generateCSRFToken = () => {
  return crypto.randomUUID();
};

const apiRequest = async (url: string, data: any) => {
  const csrfToken = sessionStorage.getItem('csrf_token');
  return fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify(data)
  });
};
```

### SEC-005: セッション管理の強化

**対策実装例:**
```typescript
const SESSION_TIMEOUT = 30 * 60 * 1000; // 30分

const setSecureSession = (user: User, session: Session) => {
  const sessionData = {
    user,
    session,
    timestamp: Date.now(),
    expiresAt: Date.now() + SESSION_TIMEOUT
  };
  
  document.cookie = `session=${btoa(JSON.stringify(sessionData))}; HttpOnly; Secure; SameSite=Strict`;
};
```

### SEC-006: ファイルアップロード検証

**対策実装例:**
```typescript
const validateImageFile = (file: File): { isValid: boolean; error?: string } => {
  const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
  if (!allowedTypes.includes(file.type)) {
    return { isValid: false, error: '許可されていないファイル形式です' };
  }
  
  const maxSize = 2 * 1024 * 1024; // 2MB
  if (file.size > maxSize) {
    return { isValid: false, error: 'ファイルサイズが大きすぎます' };
  }
  
  if (file.name.includes('../') || file.name.includes('..\\')) {
    return { isValid: false, error: '不正なファイル名です' };
  }
  
  return { isValid: true };
};
```

### SEC-010: 画像アップロード偽装攻撃

**現在の問題コード:**
```typescript
// imageUtils.ts:77-80
export const isImageFile = (file: File): boolean => {
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
  return allowedTypes.includes(file.type); // MIMEタイプのみの検証
};
```

**対策実装例:**
```typescript
// マジックナンバーによるファイル内容検証
const validateFileContent = async (file: File): Promise<boolean> => {
  const buffer = await file.arrayBuffer();
  const uint8Array = new Uint8Array(buffer);
  
  // JPEG: FF D8 FF
  if (uint8Array[0] === 0xFF && uint8Array[1] === 0xD8 && uint8Array[2] === 0xFF) {
    return true;
  }
  
  // PNG: 89 50 4E 47
  if (uint8Array[0] === 0x89 && uint8Array[1] === 0x50 && uint8Array[2] === 0x4E && uint8Array[3] === 0x47) {
    return true;
  }
  
  // WebP: 52 49 46 46 (RIFF) + WebP signature
  if (uint8Array[0] === 0x52 && uint8Array[1] === 0x49 && uint8Array[2] === 0x46 && uint8Array[3] === 0x46) {
    if (uint8Array[8] === 0x57 && uint8Array[9] === 0x45 && uint8Array[10] === 0x42 && uint8Array[11] === 0x50) {
      return true;
    }
  }
  
  return false;
};
```

### SEC-011: URL入力でのスクリプト実行

**現在の問題コード:**
```typescript
// validation.ts:10-18
export const validatePropertyUrl = (url: string): string | null => {
  if (!url) return null;
  
  try {
    new URL(url);
    return null; // エラーなし
  } catch {
    return 'URLの形式が正しくありません';
  }
};
```

**対策実装例:**
```typescript
export const validatePropertyUrl = (url: string): string | null => {
  if (!url) return null;
  
  try {
    const parsedUrl = new URL(url);
    
    // 危険なプロトコルの検証
    const allowedProtocols = ['http:', 'https:'];
    if (!allowedProtocols.includes(parsedUrl.protocol)) {
      return '許可されていないプロトコルです';
    }
    
    // javascript:プロトコルの明示的な拒否
    if (parsedUrl.protocol === 'javascript:') {
      return 'JavaScriptプロトコルは使用できません';
    }
    
    return null;
  } catch {
    return 'URLの形式が正しくありません';
  }
};
```

### SEC-012: シミュレーター入力フィールドXSS

**現在の問題コード:**
```typescript
// Simulator.tsx:664-670
<input
  type="text"
  value={inputs.propertyName}
  onChange={(e) => handleInputChange('propertyName', e.target.value)}
  placeholder="例：カーサ○○マンション"
  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
/>
```

**対策実装例:**
```typescript
import DOMPurify from 'dompurify';

const sanitizeInput = (input: string): string => {
  return DOMPurify.sanitize(input, {
    ALLOWED_TAGS: [],
    ALLOWED_ATTR: []
  });
};

const handleInputChange = (field: string, value: string) => {
  const sanitizedValue = sanitizeInput(value);
  setInputs(prev => ({
    ...prev,
    [field]: sanitizedValue
  }));
};
```

### SEC-013: 数値入力フィールドの範囲検証

**対策実装例:**
```typescript
const validateNumericInput = (value: number, min: number, max: number): string | null => {
  if (isNaN(value)) {
    return '数値を入力してください';
  }
  
  if (value < min || value > max) {
    return `${min}から${max}の範囲で入力してください`;
  }
  
  return null;
};

// 使用例
const handlePriceChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  const value = Number(e.target.value);
  const error = validateNumericInput(value, 1000000, 1000000000); // 100万円から10億円
  
  if (error) {
    setErrors(prev => ({ ...prev, purchasePrice: error }));
  } else {
    handleInputChange('purchasePrice', value);
  }
};
```

### SEC-014: ファイル名パストラバーサル

**現在の問題コード:**
```typescript
// useImageUpload.ts:64-65
const fileExtension = resizedFile.name.split('.').pop();
const fileName = `property-images/${timestamp}-${randomString}.${fileExtension}`;
```

**対策実装例:**
```typescript
const sanitizeFileName = (fileName: string): string => {
  // 危険な文字を除去
  const sanitized = fileName
    .replace(/[<>:"/\\|?*\x00-\x1f]/g, '') // 制御文字と危険な文字
    .replace(/\.\./g, '') // パストラバーサル
    .replace(/^\.+/, '') // 先頭のドット
    .replace(/\.+$/, ''); // 末尾のドット
  
  return sanitized || 'file';
};

const fileExtension = sanitizeFileName(resizedFile.name.split('.').pop() || '');
const fileName = `property-images/${timestamp}-${randomString}.${fileExtension}`;
```

---

## 現在確認されていない脆弱性

### ✅ 安全性が確認されているもの
- **SQLインジェクション**: Supabaseクライアントのパラメータ化クエリにより保護済み
- **パスワード処理**: Supabase認証により適切に処理
- **基本的な入力検証**: 主要なフォームで実装済み

---

## 推奨される定期的なセキュリティ対策

### 1. セキュリティ監査
- 月1回の脆弱性スキャン
- 依存関係の脆弱性チェック（`npm audit`）
- Supabase RLSポリシーの確認

### 2. 監視・ログ
- 不審なアクセスパターンの監視
- 認証失敗ログの確認
- エラーログの定期的な分析

### 3. 教育・トレーニング
- 開発チームへのセキュリティ教育
- セキュアコーディングガイドラインの策定
- インシデント対応手順の整備

---

## 課題進捗管理

### 進捗状況の記号
- 🔴 未対応
- 🟡 作業中
- 🟢 完了

### 更新履歴
- 2025-07-16: 初版作成
- 2025-07-16: 入力フォーム脆弱性調査結果を追加（SEC-010〜SEC-014）
- 2025-07-16: シミュレーター全項目調査結果を追加（SEC-015〜SEC-019）
- 2025-07-16: 総合セキュリティ調査結果を追加（SEC-020〜SEC-033）
- 2025-07-16: Supabaseセキュリティ脆弱性を追加（SEC-034〜SEC-044）
- 2025-07-16: フロントエンド・バックエンド追加セキュリティ課題を追加（SEC-045〜SEC-056）
- **2025-07-17: バックエンド・インフラ特化調査による追加脆弱性を発見・追加（SEC-057〜SEC-062）**
- 次回更新予定: 2025-07-24

---

## 連絡先・エスカレーション

### 緊急時の連絡先
- セキュリティインシデント発生時の連絡先を記載
- エスカレーション手順の明記

### 参考資料
- [OWASP Top 10 2021](https://owasp.org/www-project-top-ten/)
- [Supabase Security Best Practices](https://supabase.com/docs/guides/auth/security)
- [React Security Best Practices](https://react.dev/learn/security)

---

## 🚨 最終結論とリスク評価

### 📊 包括的な脆弱性評価結果

**調査方法**: 5つの観点（全体調査、ウイルス侵入経路、全ページ機能、依存関係、API通信）から徹底調査

**発見された脆弱性**: **計33件**
- 🔴 **重大リスク**: 10件（認証バイパス、XSS、情報漏洩、CVE対応等）
- 🟡 **高リスク**: 18件（ファイル偽装、API認証なし、入力検証不足等）
- 🟢 **低リスク**: 5件（セキュリティヘッダー、ライブラリ更新等）

### 🎯 最も危険な脆弱性（緊急対応必要）

1. **SEC-002**: 認証システムの完全バイパス
2. **SEC-022**: API認証システムの不在
3. **SEC-001, SEC-015, SEC-016**: 複数箇所でのXSS脆弱性
4. **SEC-020**: FastAPI DoS攻撃脆弱性（CVE-2024-24762）
5. **SEC-021**: esbuild任意リクエスト送信脆弱性
6. **SEC-034**: 危険なRLS無効化ファイル（全データベース影響）
7. **SEC-037**: 緩いRLSポリシー（認証バイパス可能）
8. **SEC-038**: モック認証の本番環境実行（認証システム無効化）
9. **SEC-045**: DOM操作でのinnerHTMLの危険な使用（XSS攻撃）
10. **SEC-046**: CORS設定の過度な許可（外部攻撃リスク）
11. **SEC-047**: localStorage機密情報保存（認証情報漏洩）

### 🏁 総合的なリスク評価

**現在の状況**: 
- **本番環境での使用は絶対に避けるべき**
- **開発環境でも機密データの取り扱いは危険**
- **攻撃の実行難易度は低く、大きな被害が予想される**

**予想される被害**:
- 全ユーザーの投資データ・個人情報の漏洩
- システム全体の制御権奪取
- 悪意のあるコードの実行・拡散
- 企業の信頼失墜と法的責任

**緊急対応事項**:
1. 本番環境の即座停止
2. 認証システムの完全見直し
3. 全入力フィールドのサニタイゼーション
4. 外部ライブラリの緊急更新
5. セキュリティ専門家による包括的監査

**推奨スケジュール**:
- **24時間以内**: 重大リスク10件の対応
- **1週間以内**: 高リスク18件の対応
- **1ヶ月以内**: 低リスク5件の対応
- **継続的**: 定期的なセキュリティ監査の実施

## 📋 各課題の影響範囲と検証範囲一覧（初心者向け）

### 🔴 重大リスク課題（10件）

| 課題ID | 課題名 | 影響範囲 | 検証が必要な機能 | 検証時間目安 |
|-------|--------|----------|------------------|-------------|
| SEC-001 | XSS攻撃対策 | コメント機能のみ | コメント投稿・表示・共有 | 30分 |
| SEC-002 | モック認証の本番無効化 | 全システム | 全機能（ログイン・保存・共有・計算） | 2時間 |
| SEC-003 | CORS設定の厳密化 | 外部API通信 | シミュレーター・検索・アップロード | 1時間 |
| SEC-010 | 画像アップロード偽装攻撃 | 画像機能のみ | 画像アップロード・表示 | 30分 |
| SEC-011 | URL入力でのスクリプト実行 | URL入力フィールド | 物件URL入力・外部リンク | 15分 |
| SEC-015 | 物件名・場所フィールドXSS | 物件情報入力 | 物件情報入力・表示・保存 | 30分 |
| SEC-016 | メモフィールドXSS | メモ機能 | メモ入力・表示・保存 | 15分 |
| SEC-020 | FastAPI DoS攻撃脆弱性 | 外部API通信 | シミュレーター計算・API応答 | 30分 |
| SEC-021 | esbuild任意リクエスト送信 | 開発環境 | 開発サーバー・ビルド | 30分 |
| SEC-022 | API認証システムの不在 | 外部API通信 | 全API呼び出し | 1時間 |

### 🟡 高リスク課題（18件）

| 課題ID | 課題名 | 影響範囲 | 検証が必要な機能 | 検証時間目安 |
|-------|--------|----------|------------------|-------------|
| SEC-004 | CSRF対策の実装 | 状態変更操作 | データ保存・更新・削除 | 45分 |
| SEC-005 | セッション管理の強化 | 認証システム | ログイン・セッション・認証 | 30分 |
| SEC-006 | ファイルアップロード検証 | 画像機能 | 画像アップロード・検証 | 30分 |
| SEC-007 | 環境変数管理の改善 | システム設定 | 全機能（設定依存） | 15分 |
| SEC-012 | シミュレーター入力フィールドXSS | 計算入力 | シミュレーター入力・表示 | 30分 |
| SEC-013 | 数値入力フィールドの範囲検証 | 数値入力 | 全数値入力・計算 | 45分 |
| SEC-014 | ファイル名パストラバーサル | ファイル処理 | ファイルアップロード・処理 | 15分 |
| SEC-017 | 数値フィールド範囲外入力 | 数値入力 | 全数値フィールド・計算 | 45分 |
| SEC-018 | 借入額と購入価格の論理検証 | 計算ロジック | 融資計算・エラーチェック | 30分 |
| SEC-019 | 実効税率・空室率の範囲検証 | 税率・空室率 | 税率・空室率入力・計算 | 30分 |
| SEC-023 | 機密情報のログ出力 | システム全体 | 全機能（ログ確認） | 30分 |
| SEC-024 | jsPDF脆弱性 | PDF機能 | PDFエクスポート | 15分 |
| SEC-025 | レート制限の不在 | API通信 | 連続API呼び出し | 30分 |
| SEC-026 | エラー情報の詳細漏洩 | エラーハンドリング | エラー発生時の表示 | 30分 |
| SEC-027 | ポリグロットファイル攻撃 | ファイル処理 | ファイル内容検証 | 30分 |
| SEC-028 | 外部URL検証不備 | URL処理 | URL入力・リダイレクト | 15分 |
| SEC-029 | innerHTML使用によるXSS | PDF表示 | PDF印刷・表示 | 15分 |
| SEC-030 | 機密データ平文保存 | データ保存 | データ保存・暗号化 | 45分 |

### 🟢 低リスク課題（5件）

| 課題ID | 課題名 | 影響範囲 | 検証が必要な機能 | 検証時間目安 |
|-------|--------|----------|------------------|-------------|
| SEC-008 | デバッグ情報の漏洩対策 | ログ出力 | ログ出力・本番ビルド | 30分 |
| SEC-009 | セキュリティヘッダーの追加 | HTTP通信 | 全HTTP通信・セキュリティ | 15分 |
| SEC-031 | 古いライブラリバージョン | 依存関係 | 全機能（互換性確認） | 1時間 |
| SEC-032 | SRIの未実装 | 外部リソース | 外部リソース読み込み | 15分 |
| SEC-033 | Certificate Pinningの不在 | 通信セキュリティ | HTTPS通信・証明書 | 30分 |

### 📊 検証時間の合計

- **重大リスク**: 約6時間
- **高リスク**: 約9時間
- **低リスク**: 約2.5時間
- **総合計**: 約17.5時間

### 🚨 重要な注意事項

1. **SEC-002（モック認証）は最も影響が大きい** - 全システムの動作確認が必要
2. **数値検証系（SEC-013, SEC-017）は計算精度に影響** - 計算結果の詳細確認が必要
3. **認証関連の修正後は必ずユーザーデータの整合性確認** - データ損失の可能性
4. **段階的なリリース** - 本番環境では段階的に修正を適用し、影響を最小化

## 🧪 セキュリティ課題修正後のシナリオテスト（初心者向け）

### 📋 テストの進め方

**1. 修正前の動作確認**
- 修正前の現在の動作を記録
- 問題のある動作を確認・スクリーンショット保存

**2. 修正後の基本動作確認**
- 修正した部分の動作確認
- 問題が解決されているか確認

**3. 関連機能のテスト**
- 修正によって影響を受ける可能性のある機能をテスト

**4. ユーザーシナリオテスト**
- 実際のユーザーの使用パターンでテスト

---

### 🔴 重大リスク課題のシナリオテスト

#### SEC-001: XSS攻撃対策のシナリオテスト

**📝 テストシナリオ1: 悪意のあるコメント投稿**
```
1. ログイン
2. 物件を共有
3. コメント欄に以下を入力して投稿:
   - `<script>alert('XSS')</script>`
   - `<img src=x onerror=alert('XSS')>`
   - `<div onmouseover=alert('XSS')>テスト</div>`
4. 【期待結果】: スクリプトが実行されず、テキストとして表示される
5. 他のユーザーでログインして同じコメントを表示
6. 【期待結果】: 他のユーザーでも悪意のあるコードが実行されない
```

**📝 テストシナリオ2: 通常のコメント投稿**
```
1. ログイン
2. 物件を共有
3. コメント欄に以下を入力して投稿:
   - 通常の文字列
   - **太字**、*斜体*（許可されたHTMLタグ）
   - 改行を含む長文
4. 【期待結果】: 通常のコメントが正常に表示される
5. 既存のコメントも正常に表示される
6. 【期待結果】: 書式設定（太字・斜体）が正しく表示される
```

**📝 テストシナリオ3: 共有機能でのコメント表示**
```
1. コメント付きの物件を共有
2. 共有リンクを別のブラウザで開く
3. 【期待結果】: コメントが安全に表示される
4. 共有先でもコメント投稿を試す
5. 【期待結果】: 共有先でも悪意のあるコードが実行されない
```

#### SEC-002: モック認証の本番無効化のシナリオテスト

**📝 テストシナリオ1: 不正ログインの防止**
```
1. ログイン画面で以下を試す:
   - 任意のメールアドレス（test@example.com）
   - 適当なパスワード（password123）
2. 【期待結果】: ログインが拒否される
3. demo@ooya-dx.com / demo123 を試す
4. 【期待結果】: 本番環境ではログインが拒否される
```

**📝 テストシナリオ2: 正常なログイン・ログアウト**
```
1. 正式なアカウントでログイン
2. 【期待結果】: ログイン成功
3. 全機能の動作確認:
   - シミュレーター使用
   - データ保存・読み込み
   - 物件共有
   - コメント投稿
4. ログアウト
5. 【期待結果】: ログアウト後は認証が必要なページにアクセス不可
```

**📝 テストシナリオ3: セッション管理**
```
1. ログイン
2. 別のタブでも同じサイトを開く
3. 【期待結果】: 両方のタブでログイン状態が保持される
4. 一方のタブでログアウト
5. 【期待結果】: 両方のタブでログアウト状態になる
```

#### SEC-003: CORS設定の厳密化のシナリオテスト

**📝 テストシナリオ1: シミュレーター計算**
```
1. ログイン
2. シミュレーター画面で物件情報を入力
3. 「計算実行」ボタンをクリック
4. 【期待結果】: 計算が正常に実行される
5. 計算結果が正しく表示される
6. 【期待結果】: エラーメッセージが表示されない
```

**📝 テストシナリオ2: 不動産情報検索**
```
1. 物件検索画面で検索条件を入力
2. 検索実行
3. 【期待結果】: 検索結果が正常に表示される
4. 検索結果をクリック
5. 【期待結果】: 物件詳細が表示される
```

**📝 テストシナリオ3: 画像アップロード**
```
1. 物件登録画面で画像をアップロード
2. 【期待結果】: アップロードが成功する
3. アップロードした画像が表示される
4. 【期待結果】: 画像が正しく表示される
```

#### SEC-010: 画像アップロード偽装攻撃のシナリオテスト

**📝 テストシナリオ1: 不正ファイルのアップロード拒否**
```
1. 以下の不正ファイルをアップロード:
   - .htmlファイルに.jpg拡張子
   - .jsファイルに.png拡張子
   - 実行ファイル
2. 【期待結果】: アップロードが拒否される
3. 適切なエラーメッセージが表示される
```

**📝 テストシナリオ2: 正常な画像ファイルのアップロード**
```
1. 正常な画像ファイルをアップロード:
   - JPEG画像
   - PNG画像
   - WebP画像
2. 【期待結果】: アップロードが成功する
3. 画像が正しく表示される
4. 【期待結果】: 画像の品質が保持される
```

#### SEC-011: URL入力でのスクリプト実行のシナリオテスト

**📝 テストシナリオ1: 悪意のあるURL入力の拒否**
```
1. 物件URL入力欄に以下を入力:
   - `javascript:alert('XSS')`
   - `data:text/html,<script>alert('XSS')</script>`
   - `vbscript:msgbox("XSS")`
2. 【期待結果】: 入力が拒否される
3. 適切なエラーメッセージが表示される
```

**📝 テストシナリオ2: 正常なURL入力**
```
1. 正常なURLを入力:
   - `https://suumo.jp/jj/chintai/...`
   - `https://www.homes.co.jp/...`
2. 【期待結果】: 入力が受け入れられる
3. URLリンクが正常に動作する
```

### 🟡 高リスク課題のシナリオテスト

#### SEC-013: 数値入力フィールドの範囲検証のシナリオテスト

**📝 テストシナリオ1: 極端な値の入力拒否**
```
1. シミュレーター画面で以下を入力:
   - 購入価格: -1000000（負の値）
   - 月額賃料: 999999999999（極端に大きな値）
   - 空室率: 150%（100%超）
   - 金利: -5%（負の金利）
2. 【期待結果】: 入力が拒否される
3. 適切なエラーメッセージが表示される
4. 計算が実行されない
```

**📝 テストシナリオ2: 正常な範囲の値で計算**
```
1. 正常な範囲の値を入力:
   - 購入価格: 50000000円
   - 月額賃料: 200000円
   - 空室率: 5%
   - 金利: 2.5%
2. 【期待結果】: 入力が受け入れられる
3. 計算が正常に実行される
4. 計算結果が正しく表示される
```

#### SEC-018: 借入額と購入価格の論理検証のシナリオテスト

**📝 テストシナリオ1: 論理的に不正な値の入力**
```
1. 以下の値を入力:
   - 購入価格: 50000000円
   - 借入額: 60000000円（購入価格を超える）
2. 【期待結果】: 適切な警告メッセージが表示される
3. 「借入額は購入価格を超えることはできません」のメッセージ
4. 計算は実行されるが警告が表示される
```

**📝 テストシナリオ2: 論理的に正しい値での計算**
```
1. 以下の値を入力:
   - 購入価格: 50000000円
   - 借入額: 40000000円（購入価格以下）
2. 【期待結果】: 警告メッセージが表示されない
3. 計算が正常に実行される
```

### 🟢 低リスク課題のシナリオテスト

#### SEC-008: デバッグ情報の漏洩対策のシナリオテスト

**📝 テストシナリオ1: 本番環境でのログ出力確認**
```
1. ブラウザの開発者ツールを開く
2. 全機能を使用（ログイン・シミュレーター・共有・保存）
3. 【期待結果】: 機密情報がコンソールに出力されない
4. パスワード・トークン・個人情報がログに含まれない
```

---

### 🔄 統合シナリオテスト

**📝 エンドツーエンドテスト: 不動産投資シミュレーション**
```
1. 【ユーザー登録・ログイン】
   - 新規ユーザー登録
   - ログイン・ログアウト
   - Remember Me機能

2. 【物件情報入力】
   - 物件基本情報入力
   - 数値データ入力（価格・賃料・面積等）
   - 画像アップロード
   - 物件URL入力

3. 【シミュレーション実行】
   - 計算実行
   - 結果表示
   - グラフ表示
   - PDF出力

4. 【データ保存・読み込み】
   - シミュレーション結果保存
   - 保存データ読み込み
   - データ一覧表示

5. 【共有機能】
   - 物件共有
   - コメント投稿
   - 共有リンクアクセス
   - 招待機能

6. 【セキュリティ確認】
   - 悪意のある入力の拒否
   - 不正ファイルアップロード拒否
   - 権限外アクセス拒否
```

### 📊 テスト完了チェックリスト

**各課題修正後に確認すべき項目:**

**✅ セキュリティ機能の確認**
- [ ] 悪意のある入力が適切に拒否される
- [ ] 不正なファイルアップロードが拒否される
- [ ] 権限外のアクセスが拒否される
- [ ] エラーメッセージに機密情報が含まれない

**✅ 既存機能の動作確認**
- [ ] ログイン・ログアウト
- [ ] データ保存・読み込み
- [ ] シミュレーション計算
- [ ] 共有機能
- [ ] コメント機能

**✅ パフォーマンス確認**
- [ ] ページの読み込み速度
- [ ] 計算処理の速度
- [ ] 大量データの処理

**✅ ユーザビリティ確認**
- [ ] エラーメッセージの分かりやすさ
- [ ] 操作の直感性
- [ ] レスポンシブデザイン

このシナリオテストにより、セキュリティ対策後も既存機能が正常に動作し、かつセキュリティが強化されていることを確認できます。
# セキュリティ要件定義書（統合版）

作成日: 2025年8月1日  
対象フェーズ: MVPリリース（初回リリース）

---

## 📑 目次

1. [概要](#1-概要)
2. [セキュリティ要件（技術仕様）](#2-セキュリティ要件技術仕様)
3. [初心者向け解説](#3-初心者向け解説)
4. [実装ガイド](#4-実装ガイド)
5. [テスト項目](#5-テスト項目)
6. [今後の強化計画](#6-今後の強化計画)

---

## 1. 概要

### 1.1 基本方針

本ドキュメントは、不動産投資シミュレーターのMVPリリースに向けたセキュリティ要件を定義します。

**原則：**
- ✅ シンプルで確実な実装を優先
- ✅ 既存機能を壊さない
- ✅ 段階的な強化を前提
- ❌ 過度に複雑なセキュリティ機能は避ける

### 1.2 なぜセキュリティが必要？（初心者向け）

不動産投資シミュレーターには重要な情報が含まれます：
- 物件の投資計画
- 個人の資産情報
- ログイン情報

これらを悪意のある攻撃から守るため、以下のような対策が必要です。

**例え話：**
- 🔐 **認証** = 家の鍵（正しい人だけが入れる）
- 🚪 **入力値検証** = ドアのサイズ制限（大きすぎる物は入れない）
- 🚨 **エラー処理** = 防犯ブザー（異常を検知）

---

## 2. セキュリティ要件（技術仕様）

### 2.1 認証・認可 ✅実装済み

| 項目 | 現状 | 対応 |
|------|------|------|
| ユーザー認証 | Supabase Auth | 維持 |
| アクセス制御 | RLS（Row Level Security） | 維持 |
| セッション管理 | Supabaseデフォルト | 維持 |

### 2.2 データ保護

| 項目 | 要件 | 実装状況 | 対応内容 |
|------|------|----------|----------|
| HTTPS通信 | 必須 | ✅完了 | Vercel/Render自動対応 |
| 環境変数管理 | 必須 | ✅完了 | .env.local使用 |
| XSS対策 | 必須 | ⚠️要確認 | React標準＋追加確認 |
| SQLインジェクション | 必須 | ✅完了 | Supabase自動対応 |

### 2.3 入力値検証（詳細仕様）

#### 2.3.1 数値入力の制限

| フィールド | 最小値 | 最大値 | 単位 | 制限理由 |
|------------|--------|--------|------|----------|
| 購入価格 | 100 | 1,000,000 | 万円 | 100万円未満は非現実的、10億超は範囲外 |
| 月額賃料 | 10,000 | 100,000,000 | 円 | 最低賃料〜高額物件まで対応 |
| 借入額 | 0 | 1,000,000 | 万円 | 購入価格を超えない範囲 |
| 金利 | 0.01 | 20.0 | % | マイナス金利・高利は除外 |
| 返済期間 | 1 | 50 | 年 | 一般的な融資期間 |
| 保有年数 | 1 | 50 | 年 | 長期保有の上限 |
| 空室率 | 0 | 100 | % | 0〜100%の範囲 |

#### 2.3.2 文字列入力の制限

| フィールド | 最大文字数 | 追加制限 | 制限理由 |
|------------|------------|----------|----------|
| 物件名 | 100 | HTMLタグ不可 | DB容量・表示崩れ防止 |
| 所在地 | 200 | HTMLタグ不可 | 住所の一般的な長さ |
| メモ | 1,000 | HTMLタグ不可 | 適度な情報量 |
| URL | 500 | URL形式のみ | セキュリティ確保 |

### 2.4 エラーハンドリング方針

```typescript
// ❌ 悪い例（詳細を露出）
throw new Error(`Database error: Table 'users' not found at line 42`);

// ✅ 良い例（抽象化）
throw new Error('システムエラーが発生しました。時間をおいて再度お試しください。');
```

---

## 3. 初心者向け解説

### 3.1 各対策の意味と重要性

#### 🔐 ログイン機能（認証）
**何これ？**  
正しいメールアドレスとパスワードを持つ人だけがシステムを使えるようにする仕組み。

**なぜ必要？**  
- 太郎さんのデータを花子さんが見られないようにする
- 自分の投資計画を他人に変更されないようにする

#### 🔒 データの暗号化（HTTPS）
**何これ？**  
インターネット上でデータを送る時に、内容を暗号化する仕組み。

**なぜ必要？**  
- カフェのWi-Fiでも安全に使える
- パスワードが盗み見られない

#### ✅ 入力チェック（バリデーション）
**何これ？**  
入力された値が「おかしくないか」確認する仕組み。

**なぜ必要？**  
```
❌ 購入価格: -1000万円 → マイナスはおかしい！
❌ 金利: 999% → ありえない金利！
✅ 購入価格: 5000万円 → OK！
```

---

## 4. 実装ガイド

### 4.1 フロントエンド実装例

```typescript
// utils/securityValidation.ts
export const validateNumericInput = (
  value: number,
  field: string
): { isValid: boolean; error?: string } => {
  const limits: Record<string, { min: number; max: number; unit: string }> = {
    purchasePrice: { min: 100, max: 1000000, unit: '万円' },
    monthlyRent: { min: 10000, max: 100000000, unit: '円' },
    interestRate: { min: 0.01, max: 20, unit: '%' }
  };

  const limit = limits[field];
  if (!limit) return { isValid: true };

  if (value < limit.min || value > limit.max) {
    return {
      isValid: false,
      error: `${limit.min}${limit.unit}から${limit.max}${limit.unit}の範囲で入力してください`
    };
  }

  return { isValid: true };
};
```

### 4.2 サーバーサイド実装例（Python/FastAPI）

```python
from pydantic import BaseModel, Field, validator

class SimulationRequest(BaseModel):
    purchase_price: float = Field(..., ge=1000000, le=10000000000)
    monthly_rent: float = Field(..., ge=10000, le=100000000)
    interest_rate: float = Field(..., ge=0.01, le=20.0)
    
    @validator('property_name')
    def validate_property_name(cls, v):
        if len(v) > 100:
            raise ValueError('物件名は100文字以内で入力してください')
        if '<' in v or '>' in v:
            raise ValueError('HTMLタグは使用できません')
        return v
```

### 4.3 XSS対策の確認方法

```bash
# プロジェクト内を検索
grep -r "dangerouslySetInnerHTML" ./src/
grep -r "href={" ./src/
grep -r "src={" ./src/

# URLサニタイズ関数
const sanitizeUrl = (url: string): string => {
  if (!url) return '#';
  if (url.match(/^(javascript|data|vbscript):/i)) return '#';
  return url;
};
```

---

## 5. テスト項目

### 5.1 境界値テスト

| テスト項目 | 入力値 | 期待結果 |
|------------|--------|----------|
| 購入価格（最小値未満） | 99万円 | エラー表示 |
| 購入価格（最小値） | 100万円 | 正常処理 |
| 購入価格（最大値） | 10億円 | 正常処理 |
| 購入価格（最大値超） | 10億1円 | エラー表示 |

### 5.2 セキュリティテスト

| テスト種別 | テスト内容 | 確認項目 |
|------------|------------|----------|
| XSS | `<script>alert('XSS')</script>` を入力 | スクリプトが実行されない |
| 巨大値 | 999999999999 を入力 | 適切にエラー処理 |
| 特殊文字 | `'; DROP TABLE--` を入力 | 正常に処理（Supabase対応） |

### 5.3 エラーハンドリングテスト

1. APIサーバー停止時の動作
2. ネットワークエラー時の表示
3. 不正なデータ送信時の応答

---

## 6. 今後の強化計画

### Phase 1: MVPリリース（現在）
- ✅ 基本的な認証・認可
- ✅ HTTPS通信
- ⚠️ 入力値検証（実装予定）
- ⚠️ XSS対策確認（実装予定）

### Phase 2: リリース後1ヶ月
- レート制限（1分間に60回まで）
- 詳細なアクセスログ
- セキュリティヘッダー追加

### Phase 3: リリース後3ヶ月  
- 2段階認証オプション
- IPアドレス制限機能
- 監査ログの実装

### Phase 4: 成長期（1年後）
- WAF（Web Application Firewall）導入
- ペネトレーションテスト実施
- SOC2準拠を目指す

---

## 📝 Geminiからのフィードバックと対応

### 評価サマリー
> 「MVPとして非常に堅実でバランスが取れています。シンプルかつ確実な実装という方針が明確で素晴らしい」

### 追加推奨事項と対応

1. **サーバーサイド検証の重要性**
   - 対応: FastAPIでのバリデーション実装を必須項目に追加

2. **XSS対策の詳細確認**
   - 対応: dangerouslySetInnerHTML、href属性の総点検を実施

3. **環境変数の本番対応**
   - 対応: Vercel/Renderの環境変数機能を使用

---

## 🎯 まとめ

### 実装の心得
1. **完璧を求めない** - 60点のセキュリティでリリースOK
2. **ユーザーファースト** - 使いやすさを犠牲にしない  
3. **段階的アプローチ** - まず基本から、少しずつ強化
4. **テストは必須** - 実装したら必ず動作確認

### 成功の指標
- 基本的な攻撃を防げる
- ユーザーが安心して使える
- 開発者が保守しやすい

---
最終更新: 2025年8月1日  
次回更新: 実装完了時
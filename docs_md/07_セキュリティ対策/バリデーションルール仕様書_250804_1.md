# バリデーションルール仕様書

作成日: 2025年8月4日  
バージョン: 1.0  
対象: 大家DXシミュレーター

## 📋 概要

本書は、大家DXシミュレーターのフロントエンドおよびバックエンドで実装されているバリデーションルールを定義します。

## 🔍 バリデーション実装箇所

1. **フロントエンド**: `/bolt_front/src/utils/securityValidation.ts`
2. **バックエンド**: `/backend/simulator-api/validations.py`

## 📊 フィールド別バリデーションルール

### 1. 文字列フィールド

| フィールド名 | 最大文字数 | 必須 | HTMLタグ | 備考 |
|------------|-----------|------|---------|------|
| propertyName（物件名） | 100 | ✅ | ❌ | HTMLタグ禁止 |
| location（住所） | 200 | ✅ | ❌ | HTMLタグ禁止 |
| propertyUrl（物件URL） | 500 | - | ❌ | javascript:等の危険なプロトコル禁止 |
| propertyMemo（メモ） | 1000 | - | ❌ | HTMLタグ禁止 |

### 2. 数値フィールド（金額関連）

| フィールド名 | 最小値 | 最大値 | 単位 | 備考 |
|------------|--------|--------|------|------|
| purchasePrice（購入価格） | 1 | 100,000 | 万円 | 1万円〜10億円 |
| monthlyRent（月額賃料） | 0 | 100,000,000 | 円 | 0〜1億円/月 |
| managementFee（管理費） | 0 | 10,000,000 | 円 | 0〜1000万円/月 |
| propertyTax（固定資産税） | 0 | 5,000 | 万円 | 0〜5億円/年 |
| majorRepairCost（大規模修繕費用） | 0 | 50,000 | 万円 | 0〜50億円 |
| buildingPriceForDepreciation（建物価格） | 0 | 100,000 | 万円 | 0〜10億円 |

### 3. 数値フィールド（割合・期間）

| フィールド名 | 最小値 | 最大値 | 単位 | 備考 |
|------------|--------|--------|------|------|
| downPaymentRatio（頭金比率） | 0 | 100 | % | |
| interestRate（借入金利） | 0 | 20 | % | |
| loanYears（ローン期間） | 1 | 50 | 年 | |
| holdingYears（保有年数） | 1 | 50 | 年 | |
| depreciationYears（減価償却年数） | 1 | 50 | 年 | |

### 4. 数値フィールド（面積・築年）

| フィールド名 | 最小値 | 最大値 | 単位 | 備考 |
|------------|--------|--------|------|------|
| buildingArea（建物面積） | 1 | 100,000 | ㎡ | |
| landArea（土地面積） | 0 | 100,000 | ㎡ | |
| yearBuilt（築年） | 1900 | 現在年+10 | 年 | 将来の物件も考慮 |

### 5. 画像フィールド

| フィールド名 | 形式 | 最大サイズ | 許可形式 |
|------------|------|-----------|----------|
| propertyImageBase64 | Base64 | 5MB | jpeg, jpg, png, gif, webp* |

*webp: モダンブラウザでサポート。IE11非対応

## 🛡️ セキュリティ検証

### HTMLタグ検出パターン
```regex
/<[a-zA-Z][^>]*>|<\/[a-zA-Z][^>]*>/
```
- 開始タグ: `<div>`, `<script>`, `<img src="...">`
- 終了タグ: `</div>`, `</script>`
- 単純な不等号（`1 < 2`）は許可

### 危険なURLプロトコル
以下のプロトコルはブロックされます：
- `javascript:`
- `data:` （画像を除く）
- `vbscript:`
- `file:`

## 📱 エラーメッセージ例

### フロントエンド
```javascript
// 数値範囲エラー
"月額賃料（円）は10000000以下で入力してください"

// 文字数超過
"物件名は100文字以下で入力してください"

// HTMLタグ検出
"物件名にHTMLタグは使用できません"

// 必須項目
"物件名は必須項目です"
```

### バックエンド（API）
```json
{
  "error": "入力値にエラーがあります",
  "details": [
    "purchasePrice（万円）は100000以下で入力してください",
    "propertyNameにHTMLタグは使用できません"
  ],
  "status_code": 400
}
```

## 🔄 市場分析API専用ルール

| フィールド名 | 最小値 | 最大値 | 単位 | 必須 | 備考 |
|------------|--------|--------|------|------|------|
| location | - | 200文字 | - | ✅ | HTMLタグ禁止 |
| land_area | 0 | 100,000 | ㎡ | ✅ | |
| year_built | 1900 | 現在年+10 | 年 | ✅ | |
| purchase_price | 1 | 100,000 | 万円 | ✅ | |

## ⚠️ 注意事項

1. **単位の統一性**
   - 金額は基本的に「万円」単位
   - ただし、月額賃料と管理費は「円」単位
   - UIに表示される単位と一致させること

2. **最大値の設定根拠**
   - 購入価格: 10億円（高額物件対応）
   - 月額賃料: 1億円/月（超高級物件・商業ビル対応）
   - 管理費: 1000万円/月（大規模物件対応）
   - 保有年数: 50年（長期保有対応）

3. **バリデーションの順序**
   1. 必須チェック
   2. 型チェック（数値/文字列）
   3. 範囲/長さチェック
   4. セキュリティチェック（HTMLタグ、URL）

## 📝 更新履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2025/08/04 | 1.0 | 初版作成 |
| 2025/08/04 | 1.1 | monthlyRent, managementFeeの単位を円に修正 |
| 2025/08/04 | 1.2 | monthlyRent上限を1億円、managementFee上限を1000万円に拡張 |

---
最終更新: 2025年8月4日
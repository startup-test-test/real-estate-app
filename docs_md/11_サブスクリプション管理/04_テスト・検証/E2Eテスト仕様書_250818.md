# E2E（エンドツーエンド）テスト仕様書

作成日: 2025年8月18日  
対象システム: Stripeサブスクリプション管理  
テストフレームワーク: Playwright

---

## 📖 E2Eテストとは

**E2E（End-to-End）テスト** = ユーザーの実際の操作を最初から最後まで自動で再現するテスト

### 特徴
- 🤖 ブラウザを自動操作
- 👤 実際のユーザー視点でテスト
- 🔄 全体の流れを確認
- 🐛 統合的なバグを発見

---

## 🎯 テストシナリオ一覧

### 優先度: 🔴 高（必須） / 🟡 中（推奨） / 🟢 低（オプション）

| No | シナリオ名 | 優先度 | カバー範囲 |
|----|-----------|--------|-----------|
| 1 | 新規ユーザー完全フロー | 🔴 | 登録→購入→解約→再加入 |
| 2 | プレミアム会員の操作制限 | 🔴 | 二重購入防止 |
| 3 | 解約・取り消しフロー | 🔴 | 解約→取り消し→再解約 |
| 4 | エラーハンドリング | 🔴 | 各種エラーケース |
| 5 | 利用制限の動作 | 🟡 | 無料プラン5回制限 |
| 6 | 決済エラーパターン | 🟡 | カード拒否等 |
| 7 | マルチデバイス同時操作 | 🟡 | 競合状態テスト |
| 8 | セッション管理 | 🟢 | タイムアウト等 |
| 9 | ブラウザ互換性 | 🟢 | Chrome/Safari/Firefox |
| 10 | パフォーマンステスト | 🟢 | 応答速度測定 |

---

## 📝 詳細テストケース

### シナリオ1: 新規ユーザー完全フロー 🔴

```gherkin
Feature: 新規ユーザーがサービスを利用開始から解約まで

  Background:
    Given 新規ユーザーとしてアクセス
    
  Scenario: 無料会員登録からプレミアム会員になり解約する
    # 1. アカウント作成
    When トップページにアクセス
    And "新規登録"をクリック
    And メールアドレス"test@example.com"を入力
    And パスワード"Test123!@#"を入力
    And "登録"をクリック
    Then ダッシュボードが表示される
    
    # 2. 無料プラン利用
    When シミュレーターページへ移動
    Then "残り5回"と表示される
    When シミュレーションを5回実行
    Then "本日の利用回数に達しました"と表示
    
    # 3. プレミアムプラン購入
    When プレミアムプランページへ移動
    And "プランを選択"をクリック
    And カード番号"4242424242424242"を入力
    And 有効期限"12/25"を入力
    And CVC"123"を入力
    And "購入する"をクリック
    Then "プレミアム会員になりました"と表示
    
    # 4. プレミアム機能確認
    When シミュレーターページへ移動
    Then "無制限"と表示される
    And PDF出力ボタンが有効
    
    # 5. 解約処理
    When プレミアムプランページへ移動
    And "プランを解約"をクリック
    Then 解約確認モーダルが表示
    And "2025年9月14日まで利用可能"と表示
    When "解約する"をクリック
    Then "解約が完了しました"と表示
    And "解約予定"ステータスが表示
    
    # 6. 解約取り消し
    When "解約を取り消す"をクリック
    And 確認ダイアログで"OK"をクリック
    Then "解約が取り消されました"と表示
    And "プレミアム会員"ステータスが表示
```

### シナリオ2: 二重購入防止テスト 🔴

```gherkin
Feature: プレミアム会員の二重購入防止

  Background:
    Given プレミアム会員としてログイン済み
    
  Scenario: 既存会員が購入を試みる
    When プレミアムプランページにアクセス
    Then "プランを選択"ボタンが表示されない
    And "プランを解約"ボタンが表示される
    And "現在のプラン"バッジが表示される
    
  Scenario: 複数タブで同時購入を試みる
    Given 2つのブラウザタブを開く
    When 両方のタブでプレミアムプランページを開く
    And タブ1で解約処理を実行
    And タブ2で購入を試みる
    Then "すでにプレミアムプランをご利用中です"エラーが表示
```

### シナリオ3: エラーハンドリングテスト 🔴

```gherkin
Feature: 各種エラー状況での動作確認

  Scenario: ネットワークエラー
    Given プレミアムプランページを開いている
    When ネットワークを切断
    And "プランを選択"をクリック
    Then "ネットワークエラーが発生しました"と表示
    And "インターネット接続を確認してください"と表示
    
  Scenario: 二重解約エラー
    Given 解約処理を実行済み
    When 別タブで再度解約を試みる
    Then "この操作はすでに処理済みです"と表示
    And "ページを更新してください"と表示
    
  Scenario: セッション切れ
    Given 24時間経過したセッション
    When 操作を試みる
    Then "セッションの有効期限が切れました"と表示
    And "再度ログインしてください"と表示
```

### シナリオ4: 決済エラーパターン 🟡

```gherkin
Feature: Stripe決済のエラーケース

  Scenario Outline: 各種カードエラー
    When カード番号 "<card_number>" を入力
    And 購入処理を実行
    Then "<error_message>" が表示される
    
    Examples:
      | card_number         | error_message |
      | 4000000000000002   | カードが拒否されました |
      | 4000000000009995   | 残高不足です |
      | 4000002500003155   | 3D認証が必要です |
      | 4000000000000069   | カードの有効期限が切れています |
```

---

## 🤖 Playwrightテストコード実装

### セットアップ

```bash
# インストール
npm install -D @playwright/test

# ブラウザのインストール
npx playwright install

# 設定ファイル作成
npx playwright init
```

### テスト実装例

```typescript
// tests/subscription-e2e.spec.ts
import { test, expect, Page } from '@playwright/test';

const TEST_USER = {
  email: 'e2e-test@example.com',
  password: 'TestPass123!',
  card: '4242424242424242',
  expiry: '12/25',
  cvc: '123'
};

test.describe('サブスクリプション管理 E2Eテスト', () => {
  let page: Page;

  test.beforeEach(async ({ browser }) => {
    page = await browser.newPage();
    await page.goto('http://localhost:5173');
  });

  test('新規ユーザーの完全フロー', async () => {
    // ログイン
    await login(page, TEST_USER.email, TEST_USER.password);
    
    // 無料プラン制限確認
    await page.goto('/simulator');
    await expect(page.locator('.usage-status')).toContainText('残り5回');
    
    // プレミアムプラン購入
    await purchasePremium(page);
    
    // プレミアム状態確認
    await expect(page.locator('.usage-status')).toContainText('無制限');
    
    // 解約処理
    await cancelSubscription(page);
    
    // 解約取り消し
    await resumeSubscription(page);
  });

  test('二重購入防止', async () => {
    // プレミアム会員でログイン
    await loginAsPremium(page);
    
    // 購入ボタンが表示されないことを確認
    await page.goto('/premium-plan');
    await expect(page.locator('button:has-text("プランを選択")')).not.toBeVisible();
    await expect(page.locator('button:has-text("プランを解約")')).toBeVisible();
  });

  test('エラーメッセージの日本語表示', async () => {
    await login(page, TEST_USER.email, TEST_USER.password);
    
    // ネットワークをオフラインに
    await page.context().setOffline(true);
    
    await page.goto('/premium-plan');
    await page.click('button:has-text("プランを選択")');
    
    // エラーメッセージ確認
    await expect(page.locator('.alert')).toContainText('ネットワークエラー');
  });
});

// ヘルパー関数
async function login(page: Page, email: string, password: string) {
  await page.goto('/login');
  await page.fill('input[type="email"]', email);
  await page.fill('input[type="password"]', password);
  await page.click('button[type="submit"]');
  await page.waitForURL('/mypage');
}

async function purchasePremium(page: Page) {
  await page.goto('/premium-plan');
  await page.click('button:has-text("プランを選択")');
  
  // Stripe要素の入力
  const stripeFrame = page.frameLocator('iframe').first();
  await stripeFrame.locator('[placeholder*="Card"]').fill(TEST_USER.card);
  await stripeFrame.locator('[placeholder*="MM"]').fill(TEST_USER.expiry);
  await stripeFrame.locator('[placeholder*="CVC"]').fill(TEST_USER.cvc);
  
  await page.click('button:has-text("購入")');
  await expect(page.locator('.success')).toBeVisible();
}

async function cancelSubscription(page: Page) {
  await page.goto('/premium-plan');
  await page.click('button:has-text("プランを解約")');
  
  // モーダル確認
  await expect(page.locator('.modal')).toContainText('解約しますか');
  await page.click('button:has-text("解約する")');
  
  await expect(page.locator('.alert')).toContainText('解約が完了');
}

async function resumeSubscription(page: Page) {
  await page.click('button:has-text("解約を取り消す")');
  await page.click('button:has-text("OK")');
  await expect(page.locator('.alert')).toContainText('取り消されました');
}
```

---

## 📊 テスト実行と結果

### 実行コマンド

```bash
# 全テスト実行
npx playwright test

# 特定のファイルのみ
npx playwright test subscription-e2e

# UIモードで実行（デバッグ用）
npx playwright test --ui

# ヘッドフルモード（ブラウザを表示）
npx playwright test --headed

# レポート生成
npx playwright test --reporter=html
```

### 期待される結果

| テスト項目 | 期待結果 | タイムアウト |
|-----------|---------|------------|
| ログイン | 成功 | 5秒 |
| 購入フロー | 成功 | 30秒 |
| 解約処理 | 成功 | 10秒 |
| エラー表示 | 日本語表示 | 5秒 |

---

## 🔍 CI/CD統合

### GitHub Actions設定例

```yaml
name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          cd bolt_front
          npm ci
          npx playwright install --with-deps
          
      - name: Start application
        run: |
          cd bolt_front
          npm run dev &
          npx wait-on http://localhost:5173
          
      - name: Run E2E tests
        run: |
          cd bolt_front
          npx playwright test
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: bolt_front/playwright-report/
```

---

## 📈 メトリクス目標

### カバレッジ目標
- **Critical Path**: 100%（必須機能）
- **Happy Path**: 90%（正常系）
- **Error Cases**: 80%（エラー系）
- **Edge Cases**: 60%（境界値）

### パフォーマンス目標
- テスト実行時間: < 5分
- 並列実行: 4プロセス
- 失敗時の再試行: 2回

---

## 🚨 トラブルシューティング

### よくある問題と対処法

| 問題 | 原因 | 対処法 |
|------|------|--------|
| Stripe要素が見つからない | iframe読み込み待機不足 | waitForSelector追加 |
| タイムアウト | サーバー起動待ち不足 | wait-on使用 |
| 認証エラー | セッション管理 | storageState使用 |
| 並行実行エラー | データ競合 | テストデータ分離 |

---

## 📝 チェックリスト

### E2Eテスト導入前
- [ ] Playwrightインストール
- [ ] テスト環境構築
- [ ] テストデータ準備
- [ ] 環境変数設定

### テスト実装
- [ ] 正常系シナリオ作成
- [ ] エラー系シナリオ作成
- [ ] ヘルパー関数作成
- [ ] アサーション追加

### 実行・検証
- [ ] ローカル実行成功
- [ ] CI/CD統合
- [ ] レポート生成
- [ ] カバレッジ測定

---

作成日: 2025年8月18日  
更新日: 2025年8月18日  
バージョン: 1.0.0
# サブスクリプション管理システム デプロイ手順書

作成日: 2025年8月14日  
バージョン: 2.0.0 (統合版)  
更新日: 2025年8月14日

## 📋 目次

1. [事前準備](#1-事前準備)
2. [クイックセットアップ](#2-クイックセットアップ)
3. [段階的デプロイメント](#3-段階的デプロイメント)
4. [初回セットアップ](#4-初回セットアップ)
5. [更新デプロイ](#5-更新デプロイ)
6. [ロールバック手順](#6-ロールバック手順)
7. [動作確認](#7-動作確認)
8. [トラブルシューティング](#8-トラブルシューティング)
9. [運用手順](#9-運用手順)

---

## 1. 事前準備

### 1.1 必要なアカウント・ツール

#### Stripeアカウント設定
1. **Stripeアカウント作成**
   - https://stripe.com/jp にアクセス
   - アカウント作成（日本の事業者として登録）

2. **テスト環境設定**
   - ダッシュボードで「テストモード」をON
   - APIキーをメモ（公開可能キー、シークレットキー）

3. **商品・価格の作成**
   ```
   商品名: 大家DX プレミアムプラン
   価格: 2,980円/月
   請求期間: 月額
   通貨: JPY
   無料プラン: 月3回まで利用可能
   ```

#### Supabaseプロジェクト設定
1. **プロジェクト確認**
   - プロジェクトID: `gtnzhnsbdmkadfawuzmc`
   - URL: `https://gtnzhnsbdmkadfawuzmc.supabase.co`

2. **Edge Functions有効化**
3. **必要な権限確認**

#### 開発環境
- Node.js 18以上
- Supabase CLI
- Git

---

## 2. 🚀 クイックセットアップ（即座実行用）

緊急時やホットフィックスのための最速デプロイ手順

### Step 1: Supabaseダッシュボードアクセス

1. https://supabase.com/dashboard にアクセス
2. プロジェクト `gtnzhnsbdmkadfawuzmc` を選択

### Step 2: データベーススキーマ確認

**SQL Editor**タブで以下のテーブルが存在することを確認：

```sql
-- 必要テーブルの存在確認
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('user_usage', 'subscriptions', 'usage_history');
```

### Step 3: Edge Functionデプロイ

ターミナルで以下を実行：

```bash
# 1. Supabase CLIにログイン
npx supabase login

# 2. プロジェクトをリンク
npx supabase link --project-ref gtnzhnsbdmkadfawuzmc

# 3. Edge Functionをデプロイ（JWTチェックなし）
npx supabase functions deploy cancel-subscription --no-verify-jwt
```

### Step 4: 環境変数設定

1. Supabaseダッシュボードで **Edge Functions** を開く
2. `cancel-subscription` 関数を選択
3. **Settings** タブで環境変数を追加：

| 変数名 | 値 |
|--------|-----|
| STRIPE_SECRET_KEY | `sk_test_...` または `sk_live_...` |

### Step 5: フロントエンド設定

`.env.local`ファイルを確認・作成：

```bash
# /workspaces/real-estate-app/bolt_front/.env.local
VITE_SUPABASE_URL=https://gtnzhnsbdmkadfawuzmc.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx
VITE_STRIPE_PRICE_ID=price_xxxxx
```

### Step 6: 開発サーバー再起動

```bash
cd /workspaces/real-estate-app/bolt_front
npm run dev
```

---

## 3. 段階的デプロイメント（推奨）

### Phase 1: 基盤構築（1日目）

#### 1.1 データベースセットアップ

```sql
-- ユーザー利用状況テーブル
CREATE TABLE user_usage (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  usage_count INTEGER DEFAULT 0,
  period_start_date TIMESTAMP DEFAULT NOW(),
  period_end_date TIMESTAMP DEFAULT (NOW() + INTERVAL '30 days'),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id)
);

-- サブスクリプション管理テーブル
CREATE TABLE subscriptions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  stripe_customer_id TEXT UNIQUE,
  stripe_subscription_id TEXT UNIQUE,
  status TEXT DEFAULT 'inactive',
  current_period_end TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id)
);

-- 利用履歴テーブル
CREATE TABLE usage_history (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  feature_type TEXT NOT NULL,
  feature_data JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 1.2 セキュリティ設定

```sql
-- インデックス作成
CREATE INDEX idx_user_usage_user_id ON user_usage(user_id);
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_usage_history_user_id ON usage_history(user_id);

-- RLS有効化
ALTER TABLE user_usage ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE usage_history ENABLE ROW LEVEL SECURITY;

-- ポリシー設定
CREATE POLICY "Users can view own usage" ON user_usage
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can view own subscription" ON subscriptions
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can view own history" ON usage_history
  FOR SELECT USING (auth.uid() = user_id);
```

#### 1.3 ビジネスロジック関数

```sql
-- 期間チェック関数（30日ごとの自動リセット）
CREATE OR REPLACE FUNCTION check_and_reset_usage(p_user_id UUID)
RETURNS TABLE(current_count INTEGER, period_end TIMESTAMP) AS $$
DECLARE
  v_usage RECORD;
BEGIN
  SELECT * INTO v_usage FROM user_usage WHERE user_id = p_user_id;
  
  IF NOT FOUND THEN
    INSERT INTO user_usage (user_id)
    VALUES (p_user_id)
    RETURNING usage_count, period_end_date INTO current_count, period_end;
    RETURN NEXT;
    RETURN;
  END IF;
  
  IF v_usage.period_end_date < NOW() THEN
    UPDATE user_usage 
    SET usage_count = 0,
        period_start_date = NOW(),
        period_end_date = NOW() + INTERVAL '30 days',
        updated_at = NOW()
    WHERE user_id = p_user_id
    RETURNING usage_count, period_end_date INTO current_count, period_end;
  ELSE
    current_count := v_usage.usage_count;
    period_end := v_usage.period_end_date;
  END IF;
  
  RETURN NEXT;
END;
$$ LANGUAGE plpgsql;
```

### Phase 2: バックエンド実装（2日目）

#### 2.1 Edge Functions作成

```bash
# Checkout Session作成用
supabase functions new create-checkout-session

# サブスクリプション解約用
supabase functions new cancel-subscription

# Webhook処理用
supabase functions new stripe-webhook
```

#### 2.2 Edge Functionデプロイ

```bash
# 全Edge Functionsを一括デプロイ
supabase functions deploy create-checkout-session
supabase functions deploy cancel-subscription
supabase functions deploy stripe-webhook
```

#### 2.3 環境変数設定

各Edge Functionに必要な環境変数を設定：

```bash
# Supabaseダッシュボード > Edge Functions > Settings
STRIPE_SECRET_KEY=sk_test_xxxxx
STRIPE_PRICE_ID=price_xxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxx
```

### Phase 3: フロントエンド実装（3-4日目）

#### 3.1 依存関係インストール

```bash
cd bolt_front
npm install @stripe/stripe-js
```

#### 3.2 環境変数設定

```bash
# .env.local
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx
VITE_STRIPE_PRICE_ID=price_xxxxx
VITE_SUPABASE_URL=https://gtnzhnsbdmkadfawuzmc.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### 3.3 ビルド・デプロイ

```bash
# 開発環境確認
npm run dev

# プロダクションビルド
npm run build

# デプロイ（該当サービスに応じて）
npm run deploy
```

### Phase 4: テスト・調整（5日目）

#### 4.1 機能テスト

1. **ユーザー登録・ログイン**
2. **無料プラン利用制限（3回）**
3. **決済フロー**
4. **サブスクリプション管理**
5. **解約フロー**

#### 4.2 決済テスト

Stripeテストカードを使用：
```
カード番号: 4242 4242 4242 4242
有効期限: 任意の未来日付（例：12/25）
CVC: 任意の3桁（例：123）
```

### Phase 5: 本番リリース（6日目）

#### 5.1 本番環境設定

```bash
# 本番用Stripe APIキーに変更
VITE_STRIPE_PUBLISHABLE_KEY=pk_live_xxxxx
STRIPE_SECRET_KEY=sk_live_xxxxx
STRIPE_PRICE_ID=price_xxxxx（本番価格ID）
```

#### 5.2 最終チェック

- [ ] 全環境変数が本番用に更新済み
- [ ] Webhookエンドポイントが正しく設定済み
- [ ] SSL証明書が有効
- [ ] 監視・ログ設定が完了

---

## 4. 初回セットアップ

### 4.1 前提条件確認

```bash
# Node.jsバージョン確認
node --version  # 18.x以上

# Supabase CLIインストール確認
supabase --version

# プロジェクトディレクトリに移動
cd /workspaces/real-estate-app
```

### 4.2 認証・プロジェクトリンク

```bash
# Supabaseにログイン
supabase login

# 既存プロジェクトとリンク
supabase link --project-ref gtnzhnsbdmkadfawuzmc
```

### 4.3 初期データベースセットアップ

```bash
# データベース状態確認
supabase db diff

# マイグレーション実行（必要に応じて）
supabase db push
```

---

## 5. 更新デプロイ

### 5.1 段階的更新手順

#### Step 1: 変更内容の確認
```bash
# Git差分確認
git diff HEAD~1

# 影響範囲の分析
# - データベーススキーマ変更
# - Edge Functions変更
# - フロントエンド変更
```

#### Step 2: データベース更新（必要時のみ）
```bash
# スキーマ変更がある場合
supabase db diff --schema public > migration.sql
supabase db push
```

#### Step 3: Edge Functions更新
```bash
# 変更された関数のみ更新
supabase functions deploy cancel-subscription

# または全関数を更新
supabase functions deploy
```

#### Step 4: フロントエンド更新
```bash
cd bolt_front

# 依存関係更新（必要時のみ）
npm install

# ビルド
npm run build

# デプロイ
npm run deploy
```

### 5.2 段階的リリース

1. **ステージング環境でテスト**
2. **カナリアリリース（一部ユーザー向け）**
3. **全体リリース**

---

## 6. ロールバック手順

### 6.1 緊急ロールバック（15分以内）

#### データベースロールバック
```bash
# 直前のバックアップから復元
supabase db reset --linked

# 特定時点への復元
supabase db reset --linked --timestamp "2025-08-14T10:00:00Z"
```

#### Edge Functionsロールバック
```bash
# 前バージョンの関数を再デプロイ
git checkout HEAD~1 supabase/functions/
supabase functions deploy
```

#### フロントエンドロールバック
```bash
# 前バージョンをデプロイ
git checkout HEAD~1
npm run build
npm run deploy
```

### 6.2 段階的ロールバック

1. **影響範囲の特定**
2. **優先度付けされた復旧**
3. **段階的な機能復活**

---

## 7. ✅ 動作確認

### 7.1 基本機能確認

1. **ユーザー認証**
   - [ ] 新規登録
   - [ ] ログイン
   - [ ] ログアウト

2. **無料プラン制限**
   - [ ] 月3回制限の動作
   - [ ] 制限到達時の表示
   - [ ] 期間リセット機能

3. **決済機能**
   - [ ] Checkout Session作成
   - [ ] 決済完了
   - [ ] サブスクリプション作成

4. **サブスクリプション管理**
   - [ ] ステータス表示
   - [ ] 解約機能
   - [ ] 再開機能（必要に応じて）

### 7.2 統合テストシナリオ

#### シナリオ1: 新規ユーザーのプレミアム登録
```
1. 新規ユーザー登録
2. 3回まで無料利用
3. 4回目でプレミアムプラン案内
4. 決済完了
5. 無制限利用開始
```

#### シナリオ2: 既存プレミアムユーザーの解約
```
1. プレミアムユーザーでログイン
2. /premium-plan ページにアクセス
3. 「プランを解約」ボタンクリック
4. モーダルで「解約する」クリック
5. 解約完了確認
```

### 7.3 エラーケースの確認

- [ ] ネットワークエラー時の処理
- [ ] 決済失敗時の処理
- [ ] 認証エラー時の処理
- [ ] CORS エラー対応

---

## 8. 🔍 トラブルシューティング

### 8.1 よくあるエラーと解決方法

| 問題 | 症状 | 原因 | 解決方法 |
|------|------|------|----------|
| Edge Function 404 | 関数が見つからない | デプロイ未完了 | `supabase functions deploy` 実行 |
| 認証エラー | 401 Unauthorized | JWTトークン無効 | ログイン し直し |
| Stripeエラー | 決済処理失敗 | APIキー設定ミス | 環境変数 `STRIPE_SECRET_KEY` 確認 |
| CORSエラー | フロントエンド接続失敗 | CORS設定不備 | Edge FunctionのCORS設定確認 |
| 利用回数リセット未動作 | 月次リセットされない | 期間計算バグ | `check_and_reset_usage` 関数確認 |
| RLSエラー | データベースアクセス拒否 | ポリシー設定ミス | RLSポリシー確認 |

### 8.2 ログ確認方法

#### Supabaseログ
```bash
# Edge Functions ログ
supabase functions logs cancel-subscription

# データベースログ
# Supabaseダッシュボード > Logs & monitoring
```

#### アプリケーションログ
```bash
# フロントエンド
# ブラウザ Developer Tools > Console

# バックエンド
# Supabase Dashboard > Edge Functions > Logs
```

### 8.3 緊急時対応

#### サービス停止時
1. **影響範囲の特定**
2. **一時的な機能無効化**
3. **ロールバック実行**
4. **ユーザー通知**

#### 決済トラブル時
1. **Stripeダッシュボード確認**
2. **重複決済の確認**
3. **返金処理（必要に応じて）**
4. **顧客対応**

---

## 9. 運用手順

### 9.1 日次確認項目

- [ ] **エラー監視**
  - Edge Functions エラー率
  - 決済失敗率
  - 認証エラー率

- [ ] **パフォーマンス監視**
  - レスポンス時間
  - データベース接続数
  - API使用量

### 9.2 週次確認項目

- [ ] **使用状況分析**
  - アクティブユーザー数
  - 無料枠使い切り率
  - コンバージョン率

- [ ] **セキュリティチェック**
  - 不審なアクセス確認
  - APIキー有効性確認

### 9.3 月次確認項目

- [ ] **売上確認**
  - MRR（Monthly Recurring Revenue）計算
  - チャーン率分析
  - ARPU（Average Revenue Per User）

- [ ] **システムヘルス**
  - データベースサイズ確認
  - パフォーマンス最適化
  - 不要データの削除

### 9.4 顧客対応

#### 決済失敗時
1. **カード有効期限切れ通知**
2. **別の決済方法案内**
3. **猶予期間設定（3日間）**

#### 解約時
1. **解約理由ヒアリング**
2. **改善点の記録**
3. **再開案内メール**

### 9.5 重要な設定値

#### 利用制限
```typescript
// 月次利用制限
const FREE_USAGE_LIMIT = 3;

// 猶予期間
const GRACE_PERIOD_DAYS = 3;

// 期間リセット
const RESET_PERIOD_DAYS = 30;
```

#### パフォーマンス考慮
```typescript
// 使用状況キャッシュ（5分間）
const CACHE_DURATION = 5 * 60 * 1000;

// API レート制限
const RATE_LIMIT_RPM = 100;
```

---

## 📚 関連ドキュメント

- [Stripe連携仕様書](/docs_md/11_サブスクリプション管理/01_仕様書/Stripe連携仕様書.md)
- [二重決済防止仕様書](/docs_md/11_サブスクリプション管理/01_仕様書/二重決済防止仕様書.md)
- [Edge Functions実装ガイド](/docs_md/11_サブスクリプション管理/02_実装ガイド/Edge_Functions実装ガイド.md)
- [環境構築ガイド](/docs_md/11_サブスクリプション管理/02_実装ガイド/環境構築ガイド.md)

---

## 🎯 チェックリスト

### デプロイ前チェック

#### 開発環境
- [ ] データベーステーブル作成完了
- [ ] RLS設定完了
- [ ] Edge Functions動作確認
- [ ] フロントエンド動作確認
- [ ] テスト決済動作確認

#### 本番環境準備
- [ ] 本番用Stripe APIキー設定
- [ ] Webhook URL設定
- [ ] 環境変数全て設定
- [ ] SSL証明書有効
- [ ] 監視設定完了

#### セキュリティ
- [ ] APIキーが環境変数で管理
- [ ] Webhook署名検証実装
- [ ] ユーザー認証チェック実装
- [ ] SQLインジェクション対策

#### 法的要件
- [ ] 特定商取引法表記
- [ ] 返金ポリシー明記
- [ ] 利用規約更新
- [ ] プライバシーポリシー更新

### デプロイ後チェック

#### 基本機能
- [ ] ユーザー登録・ログイン
- [ ] 月3回制限動作
- [ ] 決済フロー
- [ ] サブスクリプション管理
- [ ] 解約機能

#### パフォーマンス
- [ ] ページ読み込み時間 < 3秒
- [ ] API レスポンス時間 < 1秒
- [ ] エラー率 < 1%

---

**最終更新**: 2025年8月14日  
**次回レビュー予定**: 2025年9月14日
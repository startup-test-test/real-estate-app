# サブスクリプション管理 テスト手順書

作成日: 2025年8月14日  
バージョン: 1.0  
対象範囲: サブスクリプション管理全般（登録・解約・解約取り消し・二重決済防止）

---

## 📋 テスト概要

本ドキュメントは、サブスクリプション管理システム全体のテスト手順を包括的にまとめたものです。単体テスト、統合テスト、E2Eテスト、本番テストまで、段階的なテストアプローチを採用しています。

### 対象機能
- プレミアムプラン登録（Stripe連携）
- プラン解約機能
- 解約取り消し機能
- 二重決済防止システム
- ユーザー状態管理

---

## 1. 単体テスト（Unit Tests）

### 1.1 実施済みテスト ✅

#### subscriptionHelpers.test.ts
- **テスト数**: 28テスト（全て成功）
- **テスト対象**:
  - 残日数計算ロジック
  - 日付フォーマット機能
  - ステータス判定ロジック

#### CancelSubscriptionModal.test.tsx
- **テスト数**: 19テスト（全て成功）
- **テスト対象**:
  - モーダル表示/非表示制御
  - ユーザーインタラクション処理
  - ローディング状態管理
  - ESCキー処理

### 1.2 テスト実行コマンド

```bash
# 全ての単体テスト実行
npm test

# 特定のテストファイル実行
npm test -- src/utils/__tests__/subscriptionHelpers.test.ts --run
npm test -- src/components/__tests__/CancelSubscriptionModal.test.tsx --run

# カバレッジ付き実行
npm test -- --coverage
```

---

## 2. テストデータ作成手順

### 2.1 Stripe テストデータ作成

#### 方法1: Stripe CLIを使用（推奨）

```bash
# Stripe CLIのインストール
# macOS
brew install stripe/stripe-cli/stripe

# Linux/WSL
curl -s https://packages.stripe.dev/api/security/keypair/stripe-cli-gpg/public | gpg --dearmor | sudo tee /usr/share/keyrings/stripe.gpg
echo "deb [signed-by=/usr/share/keyrings/stripe.gpg] https://packages.stripe.dev/stripe-cli-debian-local stable main" | sudo tee -a /etc/apt/sources.list.d/stripe.list
sudo apt update
sudo apt install stripe

# Stripeにログイン
stripe login

# テスト顧客を作成
stripe customers create \
  --email="test@example.com" \
  --name="Test User"

# テストサブスクリプションを作成
stripe subscriptions create \
  --customer=[CUSTOMER_ID] \
  --items[0][price]=[PRICE_ID]
```

#### 方法2: Stripeダッシュボードで手動作成

1. **Stripeダッシュボード** → **Customers**
2. **+ Add customer** をクリック
3. メールアドレスを入力（例：test@example.com）
4. **Add customer** をクリック
5. 作成した顧客を開く
6. **Subscriptions** タブ → **+ Create subscription**
7. プランを選択し **Start subscription** をクリック
8. 作成されたサブスクリプションID（`sub_...`）と顧客ID（`cus_...`）をコピー

### 2.2 データベース テストデータ設定

```sql
-- ユーザーIDを確認
SELECT id, email FROM auth.users WHERE email = 'your-email@example.com';

-- プレミアム会員状態にする
UPDATE subscriptions 
SET 
    status = 'active',
    cancel_at_period_end = false,
    cancel_at = NULL,
    stripe_customer_id = 'cus_実際のID',
    stripe_subscription_id = 'sub_実際のID'
WHERE user_id = 'YOUR_USER_ID';

-- 解約予定状態にする
UPDATE subscriptions 
SET 
    status = 'active',
    cancel_at_period_end = true,
    cancel_at = NOW() + INTERVAL '30 days',
    current_period_end = NOW() + INTERVAL '30 days'
WHERE user_id = 'YOUR_USER_ID';

-- 無料会員状態に戻す
DELETE FROM subscriptions WHERE user_id = 'YOUR_USER_ID';
```

### 2.3 テスト用クレジットカード

| カード番号 | 説明 |
|-----------|------|
| 4242 4242 4242 4242 | 成功するカード |
| 4000 0000 0000 0002 | 拒否されるカード |
| 4000 0025 0000 3155 | 3D認証が必要 |

- 有効期限：任意の未来の日付
- CVC：任意の3桁
- 郵便番号：任意の5桁

---

## 3. 統合テスト（Integration Tests）

### 3.1 テスト前準備

1. **環境設定**
   - Stripeテストモードを有効化
   - Edge Functionをデプロイ
   - 環境変数を設定
   - データベースマイグレーション適用

2. **テストデータ準備**
   - テスト用ユーザーアカウント作成
   - Stripeテスト用サブスクリプション作成

### 3.2 シナリオ1: 正常系 - サブスクリプション管理フロー

| No | テスト項目 | 期待結果 | 結果 |
|----|-----------|----------|------|
| 1-1 | プレミアムプランページにアクセス | ページが正常に表示される | ⬜ |
| 1-2 | 無料会員でログイン | 「プランを選択」ボタンが表示 | ⬜ |
| 1-3 | プラン選択から決済まで | Stripe決済フローが完了する | ⬜ |
| 1-4 | 決済完了後の状態確認 | プレミアム会員状態に更新される | ⬜ |
| 1-5 | 「プランを解約」ボタンをクリック | 解約確認モーダルが表示される | ⬜ |
| 1-6 | モーダルに残日数が表示される | 正しい残日数が計算・表示される | ⬜ |
| 1-7 | 「解約する」ボタンをクリック | 処理中表示 → 成功メッセージ | ⬜ |
| 1-8 | 解約後の表示確認 | 「解約予定」状態が表示される | ⬜ |
| 1-9 | ヘッダーの表示確認 | 「プレミアム会員（あとX日）」と表示 | ⬜ |
| 1-10 | 「解約を取り消す」ボタンクリック | 取り消し確認ダイアログが表示 | ⬜ |
| 1-11 | 解約取り消し実行 | プレミアム会員状態に復帰 | ⬜ |

### 3.3 シナリオ2: 異常系 - エラーハンドリング

| No | テスト項目 | 期待結果 | 結果 |
|----|-----------|----------|------|
| 2-1 | ネットワークエラー時 | エラーメッセージが表示される | ⬜ |
| 2-2 | 認証エラー時 | ログイン画面へリダイレクト | ⬜ |
| 2-3 | すでに解約済みの場合 | 「すでに解約予定です」エラー | ⬜ |
| 2-4 | Stripe APIエラー | 適切なエラーメッセージ表示 | ⬜ |
| 2-5 | 無効なサブスクリプション | 「プランが見つかりません」エラー | ⬜ |
| 2-6 | 決済エラー（カード拒否） | 決済エラーメッセージが表示される | ⬜ |
| 2-7 | セッションタイムアウト | 再ログイン要求が表示される | ⬜ |

### 3.4 シナリオ3: UI/UX確認

| No | テスト項目 | 期待結果 | 結果 |
|----|-----------|----------|------|
| 3-1 | ESCキーでモーダルを閉じる | モーダルが閉じる | ⬜ |
| 3-2 | 背景クリックでモーダルを閉じる | モーダルが閉じる | ⬜ |
| 3-3 | ローディング中の操作制限 | ボタンが無効化される | ⬜ |
| 3-4 | レスポンシブデザイン | SP/タブレット/PCで正常表示 | ⬜ |
| 3-5 | アニメーション | モーダルがスムーズに表示/非表示 | ⬜ |

---

## 4. 二重決済防止テスト

### 4.1 ローカル環境でのテスト

#### A. フロントエンド防止機能のテスト

1. **既存会員の重複購入防止**
   ```
   1. プレミアム会員でログイン
   2. ブラウザの開発者ツールでコンソールを開く
   3. UpgradeModalで購入を試みる
   4. 「すでにプレミアムプランに登録されています」エラーが表示されることを確認
   ```

2. **ボタン二重クリック防止**
   ```
   1. 購入ボタンを素早く2回クリック
   2. 1回目で「処理中...」に変わることを確認
   3. 2回目のクリックが無効化されることを確認
   ```

#### B. データベース制約のテスト

```sql
-- 同じユーザーで2つのアクティブなサブスクリプションを作成しようとする
INSERT INTO subscriptions (
    user_id,
    stripe_subscription_id,
    stripe_customer_id,
    status,
    cancel_at_period_end
) VALUES 
    ('USER_ID', 'sub_test_1', 'cus_test_1', 'active', false),
    ('USER_ID', 'sub_test_2', 'cus_test_2', 'active', false);

-- エラーが発生すれば制約が機能している
```

```sql
-- 解約予定のサブスクリプションは複数作成可能であることを確認
INSERT INTO subscriptions (
    user_id,
    stripe_subscription_id,
    stripe_customer_id,
    status,
    cancel_at_period_end
) VALUES 
    ('USER_ID', 'sub_test_3', 'cus_test_3', 'active', true);
-- これは成功するはず
```

### 4.2 ユーザー状態別テスト

#### 未ログイン状態
- プレミアムプランページで「プランを選択」ボタンが表示される
- クリックすると「ログインが必要です」アラートが表示される

#### 無料会員状態
- ログイン後、プレミアムプランページで「プランを選択」ボタンが表示される
- 決済フローに進める

#### プレミアム会員状態
- 「プランを解約」ボタンが表示される
- 新規購入ボタンは表示されない

#### 解約予定状態
- 「解約を取り消す」ボタンが表示される
- 残り日数が表示される
- 新規購入ボタンは表示されない

---

## 5. エンドツーエンド（E2E）テスト

### 5.1 完全サブスクリプションフローテスト

```typescript
// E2Eテストの例（Playwright使用想定）
describe('サブスクリプション管理E2Eテスト', () => {
  test('完全なサブスクリプション管理フローが動作する', async ({ page }) => {
    // 1. ログイン
    await page.goto('/login');
    await page.fill('[name="email"]', 'test@example.com');
    await page.fill('[name="password"]', 'password');
    await page.click('button[type="submit"]');
    
    // 2. プレミアムプランページへ移動
    await page.goto('/premium-plan');
    
    // 3. プランを選択（無料会員状態から開始）
    await page.click('text=プランを選択');
    
    // 4. 決済情報を入力
    await page.fill('[name="cardNumber"]', '4242424242424242');
    await page.fill('[name="expiry"]', '12/25');
    await page.fill('[name="cvc"]', '123');
    
    // 5. 決済を完了
    await page.click('text=購入する');
    await expect(page.locator('text=プレミアム会員になりました')).toBeVisible();
    
    // 6. 解約ボタンをクリック
    await page.click('text=プランを解約');
    
    // 7. 解約モーダルが表示されることを確認
    await expect(page.locator('text=プランを解約しますか？')).toBeVisible();
    
    // 8. 解約を実行
    await page.click('text=解約する');
    
    // 9. 成功メッセージを確認
    await expect(page.locator('text=解約が完了しました')).toBeVisible();
    
    // 10. ステータスが更新されることを確認
    await expect(page.locator('text=解約予定')).toBeVisible();
    
    // 11. 解約取り消しをテスト
    await page.click('text=解約を取り消す');
    await page.click('text=取り消す');
    await expect(page.locator('text=解約を取り消しました')).toBeVisible();
  });

  test('二重決済防止が機能する', async ({ page }) => {
    // プレミアム会員でログイン
    await loginAsPremiumUser(page);
    
    // プレミアムプランページへ移動
    await page.goto('/premium-plan');
    
    // 購入ボタンが表示されていないことを確認
    await expect(page.locator('text=プランを選択')).not.toBeVisible();
    await expect(page.locator('text=プランを解約')).toBeVisible();
  });
});
```

---

## 6. 本番環境テスト

### 6.1 環境設定チェックリスト

- [ ] Stripe本番APIキーが設定されている
- [ ] Edge Functionが本番環境にデプロイされている
- [ ] CORS設定が本番ドメインを許可している
- [ ] データベースマイグレーションが適用されている
- [ ] SSL証明書が有効
- [ ] 本番ドメインでの動作確認

### 6.2 機能テストチェックリスト

#### サブスクリプション登録
- [ ] 本番Stripeダッシュボードで新規登録が反映される
- [ ] メール通知が送信される（設定している場合）
- [ ] プレミアム機能へのアクセスが有効になる
- [ ] データベースに正しく記録される

#### サブスクリプション解約
- [ ] 本番Stripeダッシュボードで解約が反映される
- [ ] 解約後も期限まで機能が使える
- [ ] 期限後に無料プランに戻る
- [ ] 解約予定状態の表示が正しい

#### 解約取り消し
- [ ] Stripeで解約がキャンセルされる
- [ ] プレミアム会員状態に復帰する
- [ ] 継続して機能が使用できる

### 6.3 セキュリティテスト

- [ ] 他ユーザーのサブスクリプションを操作できない
- [ ] 不正なリクエストが拒否される
- [ ] XSS攻撃への対策が機能している
- [ ] CSRF対策が有効
- [ ] SQLインジェクション攻撃への対策
- [ ] 認証トークンの適切な管理

### 6.4 パフォーマンステスト

- [ ] サブスクリプション登録が10秒以内に完了する
- [ ] 解約処理が3秒以内に完了する
- [ ] 同時アクセス時の動作確認
- [ ] エラー時のリトライ処理
- [ ] レスポンス時間の測定

---

## 7. Edge Functions ローカルテスト

### 7.1 前提条件

```bash
# Supabase CLIがインストールされていること
npm install -g supabase
```

### 7.2 ローカル環境起動

```bash
# Supabaseローカル環境を起動
supabase start

# Edge Functionsをローカルで起動
supabase functions serve
```

### 7.3 各Edge Functionのテスト

#### create-checkout-session

```bash
curl -X POST http://localhost:54321/functions/v1/create-checkout-session \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"priceId": "price_test_123"}'
```

#### cancel-subscription

```bash
curl -X POST http://localhost:54321/functions/v1/cancel-subscription \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json"
```

#### resume-subscription

```bash
curl -X POST http://localhost:54321/functions/v1/resume-subscription \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json"
```

---

## 8. リグレッションテスト

### 8.1 影響範囲の確認

| 機能 | 影響有無 | テスト必要性 | 結果 |
|------|----------|-------------|------|
| ログイン/認証 | なし | 低 | ⬜ |
| プラン登録（アップグレード） | あり | 高 | ⬜ |
| 利用制限チェック | あり | 高 | ⬜ |
| ダッシュボード表示 | あり | 中 | ⬜ |
| 決済処理 | あり | 高 | ⬜ |
| プロフィール管理 | なし | 低 | ⬜ |
| 物件検索機能 | なし | 低 | ⬜ |

### 8.2 回帰テスト項目

- [ ] 既存機能に影響がないことを確認
- [ ] パフォーマンス劣化がないことを確認
- [ ] UIレイアウトに崩れがないことを確認
- [ ] 他の決済フローに影響がないことを確認

---

## 9. テスト実施記録

| 実施日 | 実施者 | 環境 | テスト種別 | バージョン | 結果 | 備考 |
|--------|--------|------|------------|------------|------|------|
| 2025/8/13 | - | 開発 | 単体テスト | v1.0 | ✅ | 47テスト全て成功 |
| 2025/8/14 | - | 開発 | 統合テスト | v1.0 | 🔄 | 実施中 |
| - | - | ステージング | E2Eテスト | - | ⬜ | 未実施 |
| - | - | 本番 | 本番テスト | - | ⬜ | 未実施 |

---

## 10. 不具合管理

| No | 発見日 | 内容 | 優先度 | ステータス | 修正日 | 担当者 |
|----|--------|------|--------|------------|--------|--------|
| - | - | - | - | - | - | - |

---

## 11. テスト完了基準

### 11.1 必須項目（リリース前に完了必須）

- ✅ 全ての単体テストが成功
- ⬜ 正常系シナリオが全て成功
- ⬜ 異常系の主要ケースでエラーハンドリング確認
- ⬜ 二重決済防止機能の動作確認
- ⬜ Stripe本番環境での動作確認
- ⬜ セキュリティテストの実施
- ⬜ データベース制約の動作確認

### 11.2 推奨項目（品質向上のため）

- ⬜ E2Eテストの自動化
- ⬜ パフォーマンステストの実施
- ⬜ 負荷テストの実施
- ⬜ ユーザビリティテストの実施
- ⬜ アクセシビリティテストの実施

---

## 12. トラブルシューティング

### 12.1 UI表示関連

**問題**: ボタンが正しく表示されない
1. ブラウザのキャッシュをクリア
2. 開発サーバーを再起動
3. subscriptionsテーブルのデータを確認
4. ローカルストレージをクリア

### 12.2 Edge Function関連

**問題**: Edge Functionが動作しない
1. Supabaseローカル環境が起動しているか確認
2. 環境変数が設定されているか確認
3. ログを確認: `supabase functions logs <function-name>`
4. CORS設定を確認

### 12.3 データベース関連

**問題**: データベース制約エラー
1. マイグレーションが適用されているか確認
2. 既存の重複データがないか確認
3. 制約の定義を確認
4. データベース接続設定を確認

### 12.4 Stripe連携関連

**問題**: Stripe決済が失敗する
1. APIキーが正しく設定されているか確認
2. テストモード/本番モードの設定確認
3. Stripeダッシュボードでログを確認
4. Webhook設定を確認

---

## 13. 次のステップ

### 13.1 短期的なアクション

1. **統合テストの実施**
   - 開発環境でシナリオ1-3を実行
   - エラーハンドリングの動作確認

2. **Edge Functionsの本番デプロイ**
   - cancel-subscription, resume-subscription, create-checkout-session
   - デプロイ後の動作確認

3. **E2Eテストの実装**
   - Playwrightを使用した自動テストの作成
   - CI/CDパイプラインへの組み込み

### 13.2 長期的な改善

1. **監視・アラートシステムの導入**
   - 決済エラー率の監視
   - パフォーマンス指標の追跡

2. **ユーザーフィードバックの収集**
   - 決済フローの改善点を把握
   - ユーザビリティの向上

3. **テスト自動化の拡張**
   - 単体テストのカバレッジ向上
   - 統合テストの自動化

---

## 14. 関連ドキュメント

- [Stripe連携仕様書](/workspaces/real-estate-app/docs_md/11_サブスクリプション管理/01_仕様書/Stripe連携仕様書.md)
- [ダウングレード・解約仕様書](/workspaces/real-estate-app/docs_md/11_サブスクリプション管理/01_仕様書/ダウングレード・解約仕様書.md)
- [二重決済防止仕様書](/workspaces/real-estate-app/docs_md/11_サブスクリプション管理/01_仕様書/二重決済防止仕様書.md)
- [Edge Functions実装ガイド](/workspaces/real-estate-app/docs_md/11_サブスクリプション管理/02_実装ガイド/Edge_Functions実装ガイド.md)
- [デプロイ手順書](/workspaces/real-estate-app/docs_md/11_サブスクリプション管理/03_運用手順/デプロイ手順書.md)

---

このテスト手順書は、サブスクリプション管理システムの品質を保証し、ユーザーに安全で信頼性の高いサービスを提供するための包括的なガイドです。段階的にテストを進めることで、リスクを最小化しながら確実な品質向上を実現できます。
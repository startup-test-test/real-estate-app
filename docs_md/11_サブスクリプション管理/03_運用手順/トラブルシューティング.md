# サブスクリプション管理システム トラブルシューティングガイド

## 目次
1. [Stripeエラー](#stripeエラー)
2. [Supabaseエラー](#supabaseエラー)
3. [Edge Functionsエラー](#edge-functionsエラー)
4. [フロントエンドエラー](#フロントエンドエラー)
5. [デバッグ手順](#デバッグ手順)
6. [予防措置](#予防措置)

---

## Stripeエラー

### 1. Webhook署名検証エラー
**エラー内容:**
```
Webhook signature verification failed: Error: SubtleCryptoProvider cannot be used in a synchronous context.
```

**原因:**
- Stripe webhookの署名検証がDeno環境で非同期処理されていない
- webhook設定のエンドポイントシークレットが正しく設定されていない

**解決策:**
1. Edge Function内でStripe署名検証を非同期で実装
```javascript
// 修正例
const sig = request.headers.get('stripe-signature')!;
const body = await request.text();

try {
  const event = await stripe.webhooks.constructEventAsync(
    body,
    sig,
    webhookSecret
  );
  // 処理続行
} catch (err) {
  console.error('Webhook signature verification failed:', err.message);
  return new Response('Webhook signature verification failed', { status: 400 });
}
```

2. 環境変数の確認
```bash
# Stripe webhook secret が正しく設定されているか確認
STRIPE_WEBHOOK_SECRET=whsec_xxx
```

### 2. カスタマー・サブスクリプション取得エラー
**エラー内容:**
```
No such customer: cus_xxx
No such subscription: sub_xxx
```

**原因:**
- Stripe側にカスタマーやサブスクリプションが存在しない
- テスト環境と本番環境のデータ混在

**解決策:**
1. Stripeダッシュボードで該当リソースの存在確認
2. 正しいAPIキー（テスト用/本番用）が使用されているか確認
3. データベースとStripeのデータ整合性確認

---

## Supabaseエラー

### 1. スキーマキャッシュエラー
**エラー内容:**
```
Error saving subscription: { code: "PGRST204", details: null, hint: null, message: "Could not find the 'current_period_start' column of 'subscriptions' in the schema cache" }
```

**原因:**
- データベースカラムが存在しない、または名前が異なる
- PostgRESTのスキーマキャッシュが古い

**解決策:**
1. データベーススキーマ確認
```sql
-- subscriptionsテーブルの構造確認
\d subscriptions;
```

2. 必要なカラムの追加
```sql
-- current_period_startカラムがない場合
ALTER TABLE subscriptions 
ADD COLUMN current_period_start TIMESTAMP WITH TIME ZONE;

-- current_period_endカラムがない場合
ALTER TABLE subscriptions 
ADD COLUMN current_period_end TIMESTAMP WITH TIME ZONE;
```

3. PostgRESTスキーマキャッシュのリフレッシュ
```sql
-- スキーマキャッシュをリロード
NOTIFY pgrst, 'reload schema';
```

### 2. ユーザーIDデータ不整合エラー
**エラー内容:**
```
Error: Active subscription not found for user
```

**原因:**
- `user_id`が空白またはNULLのレコードが存在
- 複数のサブスクリプションレコードが存在し、データが不整合

**解決策:**
1. データ整合性チェック
```sql
-- 問題のあるレコードを確認
SELECT id, user_id, stripe_customer_id, stripe_subscription_id, status 
FROM subscriptions 
WHERE user_id IS NULL OR user_id = '';

-- ユーザーの正しいIDを確認
SELECT id, email FROM auth.users 
WHERE email = 'user@example.com';
```

2. データクリーンアップ
```sql
-- 空のuser_idレコードを削除
DELETE FROM subscriptions 
WHERE user_id IS NULL OR user_id = '';

-- または正しいuser_idに修正
UPDATE subscriptions 
SET user_id = '正しいuser_id'
WHERE user_id IS NULL OR user_id = '';
```

3. 重複データの解決
```sql
-- 同一ユーザーの重複サブスクリプション確認
SELECT user_id, COUNT(*) 
FROM subscriptions 
GROUP BY user_id 
HAVING COUNT(*) > 1;

-- 最新のレコード以外を削除
WITH ranked_subscriptions AS (
  SELECT id, ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY updated_at DESC) as rn
  FROM subscriptions
)
DELETE FROM subscriptions 
WHERE id IN (
  SELECT id FROM ranked_subscriptions WHERE rn > 1
);
```

---

## Edge Functionsエラー

### 1. 関数デプロイエラー
**エラー内容:**
```
Error: failed to create the graph
The module's source code could not be parsed: Expected ';', '}' or <eof> at file:///path/to/index.ts:178:3
```

**原因:**
- TypeScriptの構文エラー
- 不正なコメントやファイル終端

**解決策:**
1. 構文エラーの修正
```typescript
// エラー箇所の確認と修正
// 行178:3付近のコードをチェック

// 不正なコメント例
})# Deploy trigger Thu Aug 14 04:04:53 AM UTC 2025
// ↑ このような不正なコメントを削除

// 正しい記述
}) // Deploy trigger Thu Aug 14 04:04:53 AM UTC 2025
```

2. ファイル検証
```bash
# TypeScriptファイルのチェック
npx tsc --noEmit path/to/index.ts
```

### 2. Edge Function 500エラー
**エラー内容:**
```
Failed to load resource: the server responded with a status of 500 ()
FunctionsHttpError: Edge Function returned a non-2xx status code
```

**原因:**
- 関数内でのランタイムエラー
- 環境変数の未設定
- データベース接続エラー

**解決策:**
1. Supabaseダッシュボードでログ確認
   - Edge Functions → 対象関数 → Logs タブ
   - エラーの詳細メッセージを確認

2. 環境変数確認
```bash
# 必要な環境変数が設定されているか確認
SUPABASE_URL=xxx
SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx
STRIPE_SECRET_KEY=xxx
STRIPE_WEBHOOK_SECRET=xxx
```

3. ローカルテストでデバッグ
```bash
# Supabase CLIでローカル実行
supabase functions serve --env-file .env.local
```

---

## フロントエンドエラー

### 1. React属性警告
**エラー内容:**
```
Warning: Received `true` for a non-boolean attribute `jsx`.
If you want to write it to the DOM, pass a string instead: jsx="true" or jsx={value.toString()}.
```

**原因:**
- DOM要素に不正な属性が渡されている
- JSXの属性指定ミス

**解決策:**
1. 該当コンポーネントの修正
```tsx
// 修正前（不正）
<style jsx={true}>

// 修正後（正しい）
<style jsx>
// または
<style jsx="true">
```

### 2. 認証状態の無限ループ
**エラー内容:**
```
ProtectedRoute状態: 
ProtectedRoute: 認証ローディング中
（無限に繰り返される）
```

**原因:**
- 認証状態の管理ロジックに問題
- useEffectの依存関係設定ミス

**解決策:**
1. useEffectの依存関係を適切に設定
```tsx
useEffect(() => {
  // 認証状態チェック
}, []); // 空の依存関係配列で初回のみ実行
```

2. 認証状態の適切な管理
```tsx
const [authState, setAuthState] = useState({
  loading: true,
  user: null
});
```

---

## デバッグ手順

### 1. 基本デバッグフロー
1. **エラーの分類**
   - フロントエンド（ブラウザコンソール）
   - バックエンド（Edge Functions）
   - データベース（Supabase）
   - 外部API（Stripe）

2. **ログ確認の優先順位**
   ```
   1. ブラウザコンソール（最初に確認）
   2. Supabase Edge Functions ログ
   3. Supabaseデータベースログ
   4. Stripe webhookログ
   ```

3. **段階的な切り分け**
   ```
   1. 認証状態の確認
   2. データベース接続の確認
   3. API呼び出しの確認
   4. 外部サービス連携の確認
   ```

### 2. ログ分析方法

#### Supabase Edge Functionsログ
```
アクセス方法:
1. Supabaseダッシュボード
2. Edge Functions → 対象関数
3. Logs タブ
4. 時系列でエラーを追跡
```

#### Stripeログ
```
アクセス方法:
1. Stripe Dashboard
2. Developers → Webhooks
3. 対象エンドポイント
4. Recent deliveries
```

### 3. テスト環境でのデバッグ
1. **ローカル環境構築**
```bash
# Supabase ローカル開発環境
supabase start
supabase functions serve

# フロントエンド開発サーバー
npm run dev
```

2. **テストデータの作成**
```sql
-- テスト用ユーザーとサブスクリプション作成
INSERT INTO subscriptions (
  id,
  user_id,
  stripe_customer_id,
  stripe_subscription_id,
  status,
  current_period_end,
  cancel_at_period_end,
  created_at,
  updated_at
) VALUES (
  gen_random_uuid(),
  (SELECT id FROM auth.users WHERE email = 'test@example.com'),
  'cus_test_example',
  'sub_test_example',
  'active',
  NOW() + INTERVAL '30 days',
  false,
  NOW(),
  NOW()
);
```

---

## 予防措置

### 1. データ整合性の維持
1. **定期的なデータ整合性チェック**
```sql
-- 日次チェッククエリ例
SELECT 
  COUNT(*) as total_subscriptions,
  COUNT(CASE WHEN user_id IS NULL OR user_id = '' THEN 1 END) as invalid_user_ids,
  COUNT(CASE WHEN stripe_customer_id IS NULL THEN 1 END) as missing_customer_ids
FROM subscriptions;
```

2. **データベース制約の追加**
```sql
-- NOT NULL制約の追加
ALTER TABLE subscriptions 
ALTER COLUMN user_id SET NOT NULL;

-- 外部キー制約の追加
ALTER TABLE subscriptions 
ADD CONSTRAINT fk_user 
FOREIGN KEY (user_id) REFERENCES auth.users(id) 
ON DELETE CASCADE;
```

### 2. エラーハンドリングの強化
1. **包括的なtry-catch実装**
```typescript
try {
  const result = await stripeOperation();
  // 成功処理
} catch (error) {
  console.error('Stripe operation failed:', error);
  // 具体的なエラーメッセージをログに記録
  return new Response(
    JSON.stringify({ error: 'Payment processing failed' }), 
    { status: 500 }
  );
}
```

2. **ヘルスチェック機能の実装**
```typescript
// Edge Function用ヘルスチェック
export async function healthCheck() {
  try {
    // データベース接続確認
    const { data, error } = await supabase.from('subscriptions').select('count').limit(1);
    if (error) throw error;
    
    // Stripe接続確認
    await stripe.customers.list({ limit: 1 });
    
    return { status: 'healthy' };
  } catch (error) {
    return { status: 'unhealthy', error: error.message };
  }
}
```

### 3. 監視とアラート
1. **重要メトリクスの監視**
   - Edge Function実行エラー率
   - データベース接続エラー
   - Stripe API呼び出しエラー
   - ユーザー認証エラー

2. **アラート設定**
   - エラー率が閾値を超えた場合の通知
   - 重要な機能の異常検知
   - パフォーマンス低下の検知

### 4. バックアップとリカバリ
1. **定期バックアップ**
```bash
# データベースバックアップ（例）
supabase db dump --data-only > backup_$(date +%Y%m%d).sql
```

2. **ロールバック手順の準備**
   - 各デプロイメントのバージョン管理
   - 迅速なロールバック手順の文書化
   - 緊急時の連絡体制確立

---

## よくある問題と解決策

### Q1: サブスクリプション解約ボタンを押しても反応しない
**A1:** 
1. ブラウザコンソールでJavaScriptエラーを確認
2. ネットワークタブでAPI呼び出しの状態を確認
3. Edge Functionのログを確認
4. データベースの該当レコードの存在を確認

### Q2: Stripe webhookが受信されない
**A2:**
1. Stripeダッシュボードでwebhook設定を確認
2. エンドポイントURLが正しいか確認
3. webhook署名シークレットが正しく設定されているか確認
4. Edge Functionがデプロイされているか確認

### Q3: 認証後にページが無限ループする
**A3:**
1. AuthProviderの実装を確認
2. useEffectの依存関係を確認
3. 認証状態の更新ロジックを確認
4. ローカルストレージの認証データを一度クリア

### Q4: データベースの更新が反映されない
**A4:**
1. トランザクションが正常にコミットされているか確認
2. Row Level Security (RLS) ポリシーを確認
3. 権限設定を確認
4. PostgRESTのスキーマキャッシュをリフレッシュ

---

## 緊急時の対応手順

### レベル1: サービス停止
1. **即座の対応**
   - 影響範囲の特定
   - サービスの一時停止判断
   - ユーザーへの緊急告知

2. **復旧作業**
   - 前回のヘルシーな状態への一時的ロールバック
   - 根本原因の特定
   - 修正版のデプロイ

### レベル2: 機能の一部不具合
1. **一時的な回避策の実装**
   - 簡易版機能への切り替え
   - エラー処理の強化

2. **段階的な修復**
   - 影響の小さい部分から修正
   - 段階的なデプロイメント

### 連絡体制
- **開発チーム**: 即座の技術的対応
- **運用チーム**: ユーザー対応とコミュニケーション
- **マネジメント**: 意思決定と外部対応

---

*最終更新日: 2025年8月14日*
*バージョン: 1.0*
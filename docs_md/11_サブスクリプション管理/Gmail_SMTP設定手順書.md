# Gmail SMTP設定手順書

作成日: 2025年8月20日  
目的: Supabaseのメール送信制限（1時間3通）をGmail SMTPで解決

---

## 📊 Gmail SMTPを選んだ理由

### メリット
- **設定時間: 10分** （最も簡単）
- **500通/日** の無料枠（小規模〜中規模には十分）
- **追加費用なし**
- **Googleの高い信頼性**
- **迷惑メールフィルタ回避率が高い**

### デメリット
- 大規模サービス（500通/日以上）には不向き
- ビジネス用途ではGoogle Workspace推奨

---

## 🔐 事前準備: Googleアカウントの設定

### ステップ1: 2段階認証を有効化

1. [Googleアカウント設定](https://myaccount.google.com/security) にアクセス
2. 「2段階認証プロセス」をクリック
3. 画面の指示に従って設定（未設定の場合）
   - 電話番号を入力
   - 確認コードを受信
   - 2段階認証を有効化

### ステップ2: アプリパスワードの生成

1. [アプリパスワード設定ページ](https://myaccount.google.com/apppasswords) にアクセス
2. アプリ名を入力: `Supabase SMTP` （任意の名前でOK）
3. 「作成」をクリック
4. **16文字のパスワードが表示される**

⚠️ **重要**: このパスワードは一度しか表示されません！必ずメモしてください。

```
例: abcd efgh ijkl mnop （スペースは無視してOK）
```

---

## 🚀 開発環境での設定（推奨）

### ステップ1: 開発環境のSupabaseプロジェクトを確認

```bash
# 開発環境のSupabaseダッシュボードURL
https://app.supabase.com/project/[開発環境のproject-ref]
```

### ステップ2: Supabase SMTP設定

1. Supabaseダッシュボードにログイン
2. **開発環境のプロジェクト**を選択
3. 左メニュー: `Settings` → `Auth`
4. 下にスクロールして `SMTP Settings` セクション
5. `Enable Custom SMTP` をONに切り替え

### ステップ3: Gmail SMTP情報を入力

```
Host: smtp.gmail.com
Port: 587
Username: あなたのGmailアドレス（例: ooya.dx.mail@gmail.com）
Password: 生成した16文字のアプリパスワード
Sender email: あなたのGmailアドレス（同上）
Sender name: 大家DX開発環境
```

6. `Save` ボタンをクリック

---

## ✅ テスト手順（開発環境）

### 1. 新規ユーザー登録テスト

```bash
# 開発環境のURLでテスト
1. 開発環境のアプリにアクセス
2. 新規アカウント作成
3. 確認メールが届くことを確認
```

### 2. パスワードリセットテスト

```bash
1. ログイン画面で「パスワードを忘れた方」
2. メールアドレスを入力
3. リセットメールが届くことを確認
```

### 3. 確認項目チェックリスト

- [ ] 確認メールが1分以内に届く
- [ ] メールの送信者名が正しい
- [ ] メール内のリンクが動作する
- [ ] 1時間に4通以上送信できる（制限解除の確認）
- [ ] 迷惑メールフォルダに入らない

---

## 📝 メールテンプレートの日本語化

### Supabaseダッシュボードで設定

1. `Authentication` → `Email Templates`
2. 各テンプレートを日本語に更新

#### 確認メール（Confirm signup）

```html
<h2>大家DXへようこそ</h2>
<p>この度は大家DXにご登録いただき、ありがとうございます。</p>
<p>以下のボタンをクリックして、メールアドレスの確認を完了してください：</p>
<p><a href="{{ .ConfirmationURL }}">メールアドレスを確認</a></p>
<p>このリンクは24時間有効です。</p>
```

#### パスワードリセット（Reset Password）

```html
<h2>パスワードリセットのご案内</h2>
<p>パスワードリセットのリクエストを受け付けました。</p>
<p>以下のボタンをクリックして、新しいパスワードを設定してください：</p>
<p><a href="{{ .ConfirmationURL }}">パスワードをリセット</a></p>
<p>このリンクは1時間有効です。</p>
```

---

## 🎯 本番環境への適用

### 開発環境でテスト成功後

1. **本番環境のSupabaseプロジェクト**で同じ設定を適用
2. `Sender name` を `大家DX` に変更（本番用）
3. 少数のテストユーザーで動作確認
4. 問題なければ本格運用開始

---

## 🔍 トラブルシューティング

### よくある問題と解決方法

#### 1. 「認証に失敗しました」エラー

```
原因: アプリパスワードが正しくない
解決: 
- スペースを含めずに16文字を入力
- 新しいアプリパスワードを生成し直す
```

#### 2. メールが届かない

```
原因: 2段階認証が無効
解決: Googleアカウントで2段階認証を有効化
```

#### 3. 「安全性の低いアプリ」エラー

```
原因: 古い設定方法を使用
解決: アプリパスワードを使用（通常のパスワードではない）
```

#### 4. 送信制限エラー（500通/日超過）

```
原因: Gmail SMTPの制限
解決: 
- 翌日まで待つ（制限は24時間でリセット）
- SendGridやAmazon SESへの移行を検討
```

---

## 📊 運用監視

### Gmail側での確認

1. Gmailの送信済みフォルダで送信履歴確認
2. エラーメールの有無をチェック

### Supabase側での確認

1. Supabaseダッシュボード → `Authentication` → `Users`
2. ユーザーのメール確認状態をチェック

---

## 🚀 将来の拡張計画

### ユーザー数増加時の対応

| ユーザー数 | 推奨サービス | 理由 |
|-----------|-------------|------|
| 〜500人/日 | Gmail SMTP | 無料で十分 |
| 500〜3000人/日 | SendGrid Free | 100通/日の無料枠 |
| 3000人以上 | Amazon SES | 最もコスパが良い |

---

## 📚 参考リンク

- [Google アプリパスワード設定](https://myaccount.google.com/apppasswords)
- [Supabase Custom SMTP Guide](https://supabase.com/docs/guides/auth/auth-smtp)
- [Gmail 送信制限について](https://support.google.com/mail/answer/22839)

---

## ⚠️ セキュリティ注意事項

1. **アプリパスワードの管理**
   - GitHubにコミットしない
   - 定期的に再生成（3ヶ月ごと推奨）
   - 不要になったら削除

2. **専用Gmailアカウントの推奨**
   - 個人用とは別のアカウントを作成
   - 例: `ooya.dx.noreply@gmail.com`

3. **送信ログの確認**
   - 不正な送信がないか定期的にチェック
   - 送信済みフォルダを監視

---

作成: Claude Code Assistant  
最終更新: 2025年8月20日  
ステータス: 開発環境でテスト待ち
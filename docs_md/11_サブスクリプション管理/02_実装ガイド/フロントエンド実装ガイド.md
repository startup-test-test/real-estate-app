# フロントエンド実装ガイド - サブスクリプション管理

作成日: 2025年8月14日  
バージョン: 1.0.0

## 1. 概要

このガイドでは、Stripeを使用したサブスクリプション管理機能のフロントエンド実装について詳しく説明します。
フリーミアムモデル（無料5回/月、プレミアム無制限）をReact + TypeScriptで実現する方法を包括的にカバーします。

### 1.1 技術スタック
- **フロントエンド**: React + TypeScript
- **決済**: Stripe + Supabase Edge Functions
- **状態管理**: React Hooks + Context API
- **UI**: Tailwind CSS

### 1.2 主要機能
- 使用状況の表示とリアルタイム更新
- 利用制限のチェックと警告表示
- アップグレードモーダル
- プレミアムプラン表示
- エラーハンドリングとユーザーフィードバック

## 2. 状態管理とカスタムフック

### 2.1 使用状況管理フック（useUsageStatus）

```typescript
// hooks/useUsageStatus.ts
import { useState, useEffect } from 'react';
import { useAuthContext } from '@/contexts/AuthContext';
import { checkUsageLimit, incrementUsage } from '@/utils/usageLimit';

interface UsageStatus {
  canUse: boolean;
  currentCount: number;
  limit: number;
  isSubscribed: boolean;
  periodEndDate: Date | null;
  daysLeft: number;
}

export const useUsageStatus = () => {
  const { user } = useAuthContext();
  const [usage, setUsage] = useState<UsageStatus | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (user) {
      loadUsageStatus();
    }
  }, [user]);

  const loadUsageStatus = async () => {
    try {
      setError(null);
      const status = await checkUsageLimit(user.id);
      setUsage(status);
    } catch (error) {
      console.error('Failed to load usage status:', error);
      setError('使用状況の取得に失敗しました');
    } finally {
      setLoading(false);
    }
  };

  const refetch = () => {
    setLoading(true);
    loadUsageStatus();
  };

  return { 
    usage, 
    loading, 
    error,
    refetch 
  };
};
```

### 2.2 サブスクリプション状態管理

```typescript
// hooks/useSubscriptionStatus.ts
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { useAuthContext } from '@/contexts/AuthContext';

interface Subscription {
  id: string;
  status: 'active' | 'inactive' | 'cancelled' | 'past_due';
  current_period_start: Date;
  current_period_end: Date;
  stripe_subscription_id: string;
}

export const useSubscriptionStatus = () => {
  const { user } = useAuthContext();
  const [subscription, setSubscription] = useState<Subscription | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (user) {
      loadSubscription();
    }
  }, [user]);

  const loadSubscription = async () => {
    try {
      const { data, error } = await supabase
        .from('subscriptions')
        .select('*')
        .eq('user_id', user.id)
        .eq('status', 'active')
        .single();

      if (!error && data) {
        setSubscription({
          ...data,
          current_period_start: new Date(data.current_period_start),
          current_period_end: new Date(data.current_period_end)
        });
      }
    } catch (error) {
      console.error('Failed to load subscription:', error);
    } finally {
      setLoading(false);
    }
  };

  return { subscription, loading, refetch: loadSubscription };
};
```

## 3. 使用制限管理ユーティリティ

### 3.1 usageLimit.ts

```typescript
// utils/usageLimit.ts
import { supabase } from '@/lib/supabase';

export interface UsageStatus {
  canUse: boolean;
  currentCount: number;
  limit: number;
  isSubscribed: boolean;
  periodEndDate: Date | null;
  daysLeft: number;
}

export const checkUsageLimit = async (userId: string): Promise<UsageStatus> => {
  try {
    // 1. サブスクリプション確認（プレミアム会員チェック）
    const { data: subscriptions, error: subError } = await supabase
      .from('subscriptions')
      .select('status')
      .eq('user_id', userId)
      .eq('status', 'active')
      .limit(1);

    if (subError) throw subError;

    // プレミアム会員は無制限利用
    if (subscriptions && subscriptions.length > 0) {
      return {
        canUse: true,
        currentCount: 0,
        limit: -1, // -1は無制限を表す
        isSubscribed: true,
        periodEndDate: null,
        daysLeft: -1
      };
    }

    // 2. 無料プランの使用状況確認（自動リセット付き）
    const { data, error } = await supabase
      .rpc('check_and_reset_usage', { 
        p_user_id: userId 
      });

    if (error) throw error;

    const usageData = Array.isArray(data) ? data[0] : data;
    const periodEnd = new Date(usageData.period_end);
    const daysLeft = Math.ceil((periodEnd.getTime() - Date.now()) / (1000 * 60 * 60 * 24));

    return {
      canUse: usageData.current_count < 5,
      currentCount: usageData.current_count,
      limit: 5,
      isSubscribed: false,
      periodEndDate: periodEnd,
      daysLeft: Math.max(0, daysLeft)
    };

  } catch (error) {
    console.error('Usage limit check failed:', error);
    // エラー時は安全側に倒して利用不可とする
    return {
      canUse: false,
      currentCount: 5,
      limit: 5,
      isSubscribed: false,
      periodEndDate: null,
      daysLeft: 0
    };
  }
};

export const incrementUsage = async (userId: string, featureType: string) => {
  try {
    // 使用履歴に記録
    const { error: historyError } = await supabase
      .from('usage_history')
      .insert({
        user_id: userId,
        feature_type: featureType,
        feature_data: { timestamp: new Date().toISOString() }
      });

    if (historyError) throw historyError;

    // 使用回数を増加
    const { error: updateError } = await supabase
      .from('user_usage')
      .update({ 
        usage_count: supabase.sql`usage_count + 1`,
        updated_at: new Date().toISOString()
      })
      .eq('user_id', userId);

    if (updateError) throw updateError;

  } catch (error) {
    console.error('Failed to increment usage:', error);
    throw error;
  }
};

// 日付フォーマット用ヘルパー
export const formatDate = (date: Date): string => {
  return date.toLocaleDateString('ja-JP', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

export const calculateDaysLeft = (endDate: string): number => {
  const end = new Date(endDate);
  const now = new Date();
  const diffTime = end.getTime() - now.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return Math.max(0, diffDays);
};
```

## 4. UIコンポーネント実装

### 4.1 使用状況表示バー（UsageStatusBar）

```typescript
// components/UsageStatusBar.tsx
import React from 'react';
import { Calendar, Star, AlertTriangle, XCircle } from 'lucide-react';
import { useUsageStatus } from '@/hooks/useUsageStatus';
import { formatDate } from '@/utils/usageLimit';

export const UsageStatusBar: React.FC = () => {
  const { usage, loading } = useUsageStatus();

  if (loading) {
    return (
      <div className="bg-gray-50 border-b border-gray-200 px-4 py-3">
        <div className="max-w-7xl mx-auto">
          <div className="h-4 bg-gray-200 rounded animate-pulse"></div>
        </div>
      </div>
    );
  }

  if (!usage) return null;

  // プレミアム会員表示
  if (usage.isSubscribed) {
    return (
      <div className="bg-gradient-to-r from-purple-50 to-blue-50 border-b border-purple-200 px-4 py-3">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="flex items-center gap-2">
              <Star className="h-5 w-5 text-yellow-500 fill-current" />
              <span className="text-sm font-medium text-purple-800">
                プレミアムプラン
              </span>
            </div>
            <span className="text-sm text-gray-600">
              全機能が無制限でご利用いただけます
            </span>
          </div>
          <Link 
            to="/account/billing" 
            className="text-sm text-purple-600 hover:text-purple-700 font-medium"
          >
            プラン管理 →
          </Link>
        </div>
      </div>
    );
  }

  const remaining = usage.limit - usage.currentCount;
  const percentage = (usage.currentCount / usage.limit) * 100;

  // 制限到達時のエラー表示
  if (remaining <= 0) {
    return (
      <div className="bg-red-50 border-b border-red-200 px-4 py-3">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-2">
            <XCircle className="h-5 w-5 text-red-600" />
            <div>
              <p className="text-sm font-medium text-red-800">
                今月の無料利用枠を使い切りました
              </p>
              <p className="text-xs text-red-600">
                プレミアムプランで引き続きご利用いただけます
              </p>
            </div>
          </div>
          <button 
            onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
            className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center gap-2 text-sm font-medium"
          >
            アップグレードして続ける
          </button>
        </div>
      </div>
    );
  }

  // 警告表示（残り1-2回）
  if (remaining <= 2) {
    return (
      <div className="bg-yellow-50 border-b border-yellow-200 px-4 py-3">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-2">
            <AlertTriangle className="h-5 w-5 text-yellow-600" />
            <p className="text-sm font-medium text-yellow-800">
              利用可能回数が残り{remaining}回です
            </p>
          </div>
          <button 
            onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
            className="px-4 py-1.5 bg-yellow-600 text-white text-sm rounded-md hover:bg-yellow-700 font-medium"
          >
            今すぐアップグレード
          </button>
        </div>
      </div>
    );
  }

  // 通常表示
  return (
    <div className="bg-white border-b border-gray-200 px-4 py-3">
      <div className="max-w-7xl mx-auto flex items-center justify-between">
        <div className="flex items-center gap-4">
          {/* プログレスバー */}
          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-600">利用状況:</span>
            <div className="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div 
                className={`h-full transition-all duration-300 ${
                  percentage >= 80 ? 'bg-red-500' : 
                  percentage >= 60 ? 'bg-yellow-500' : 
                  'bg-blue-500'
                }`}
                style={{ width: `${percentage}%` }}
              />
            </div>
            <span className="text-sm font-medium">
              {usage.currentCount}/{usage.limit}回
            </span>
          </div>
          
          {/* リセット日表示 */}
          {usage.periodEndDate && (
            <div className="flex items-center gap-1 text-sm text-gray-500">
              <Calendar className="h-4 w-4" />
              <span>
                次回リセット: {formatDate(usage.periodEndDate)} 
                （あと{usage.daysLeft}日）
              </span>
            </div>
          )}
        </div>
        
        {/* アップグレードCTA */}
        {remaining <= 2 && (
          <button 
            onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
            className="text-sm text-blue-600 hover:text-blue-700 font-medium"
          >
            プレミアムプランで無制限利用 →
          </button>
        )}
      </div>
    </div>
  );
};
```

### 4.2 シミュレーター実行ボタン

```typescript
// components/SimulatorExecuteButton.tsx
import React, { useState } from 'react';
import { PlayCircle, Loader2, Lock, Star } from 'lucide-react';
import { useUsageStatus } from '@/hooks/useUsageStatus';
import { useAuthContext } from '@/contexts/AuthContext';
import { incrementUsage } from '@/utils/usageLimit';
import { toast } from 'react-hot-toast';

interface ButtonProps {
  onExecute: () => Promise<void>;
  isLoading?: boolean;
  disabled?: boolean;
}

export const SimulatorExecuteButton: React.FC<ButtonProps> = ({ 
  onExecute, 
  isLoading = false,
  disabled = false
}) => {
  const { usage, refetch } = useUsageStatus();
  const { user } = useAuthContext();
  const [executing, setExecuting] = useState(false);

  const handleClick = async () => {
    if (!user || !usage) return;

    // 利用制限チェック
    if (!usage.canUse && !usage.isSubscribed) {
      // アップグレードモーダルを表示
      window.dispatchEvent(new CustomEvent('show-upgrade-modal'));
      return;
    }

    setExecuting(true);
    
    try {
      // シミュレーション実行
      await onExecute();
      
      // 無料プランの場合、利用回数を増やす
      if (!usage.isSubscribed) {
        await incrementUsage(user.id, 'simulator');
        // 利用状況を再取得
        await refetch();
        
        // 使用回数の更新を通知
        const newCount = usage.currentCount + 1;
        if (newCount >= usage.limit) {
          toast.success('シミュレーションが完了しました。今月の無料利用枠を使い切りました。');
        } else {
          toast.success(`シミュレーションが完了しました。残り${usage.limit - newCount}回利用可能です。`);
        }
      } else {
        toast.success('シミュレーションが完了しました。');
      }
    } catch (error) {
      console.error('Simulation execution failed:', error);
      toast.error('シミュレーションの実行に失敗しました。');
    } finally {
      setExecuting(false);
    }
  };

  const isButtonLoading = isLoading || executing;
  const isButtonDisabled = disabled || isButtonLoading;

  // プレミアム会員
  if (usage?.isSubscribed) {
    return (
      <button
        onClick={handleClick}
        disabled={isButtonDisabled}
        className="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium rounded-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all"
      >
        {isButtonLoading ? (
          <>
            <Loader2 className="h-5 w-5 animate-spin" />
            <span>実行中...</span>
          </>
        ) : (
          <>
            <Star className="h-5 w-5" />
            <span>シミュレーション実行</span>
          </>
        )}
      </button>
    );
  }

  // 無料プラン（利用可能）
  if (usage?.canUse) {
    const remaining = usage.limit - usage.currentCount;
    
    return (
      <div className="space-y-2">
        <button
          onClick={handleClick}
          disabled={isButtonDisabled}
          className="w-full px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all"
        >
          {isButtonLoading ? (
            <>
              <Loader2 className="h-5 w-5 animate-spin" />
              <span>実行中...</span>
            </>
          ) : (
            <>
              <PlayCircle className="h-5 w-5" />
              <span>シミュレーション実行</span>
              <span className="text-xs opacity-80 ml-1">
                （残り{remaining}回）
              </span>
            </>
          )}
        </button>
        
        {/* 残り回数が少ない場合の注意表示 */}
        {remaining <= 2 && (
          <p className="text-xs text-gray-500 text-center">
            💡 プレミアムプランで無制限利用が可能です
          </p>
        )}
      </div>
    );
  }

  // 無料プラン（制限到達）
  return (
    <button
      onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
      className="w-full px-6 py-3 bg-gray-400 text-white font-medium rounded-lg cursor-pointer flex items-center justify-center gap-2 hover:bg-gray-500 transition-all"
    >
      <Lock className="h-5 w-5" />
      <span>利用制限に到達 - アップグレードが必要</span>
    </button>
  );
};
```

### 4.3 アップグレードモーダル

```typescript
// components/UpgradeModal.tsx
import React, { useState, useEffect } from 'react';
import { X, AlertCircle, Check, CreditCard, Loader2, Shield } from 'lucide-react';
import { loadStripe } from '@stripe/stripe-js';
import { useAuthContext } from '@/contexts/AuthContext';
import { supabase } from '@/lib/supabase';
import { toast } from 'react-hot-toast';

const stripePromise = loadStripe(import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY);

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
}

export const UpgradeModal: React.FC<ModalProps> = ({ isOpen, onClose }) => {
  const [isLoading, setIsLoading] = useState(false);
  const { user, session } = useAuthContext();

  const handleUpgrade = async () => {
    if (!user || !session) {
      toast.error('ログインが必要です');
      return;
    }

    setIsLoading(true);
    
    try {
      // Checkout Session作成
      const response = await fetch(
        `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/smart-service`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
          },
          body: JSON.stringify({
            priceId: import.meta.env.VITE_STRIPE_PRICE_ID,
            userId: user.id,
          }),
        }
      );

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || '決済セッションの作成に失敗しました');
      }

      const data = await response.json();
      
      // Stripeへリダイレクト
      if (data.url) {
        window.location.href = data.url;
      } else if (data.sessionId) {
        const stripe = await stripePromise;
        const result = await stripe?.redirectToCheckout({ 
          sessionId: data.sessionId 
        });
        
        if (result?.error) {
          throw new Error(result.error.message);
        }
      } else {
        throw new Error('決済URLの取得に失敗しました');
      }
      
    } catch (error) {
      console.error('Upgrade error:', error);
      toast.error(error instanceof Error ? error.message : 'エラーが発生しました');
    } finally {
      setIsLoading(false);
    }
  };

  // モーダル外クリックで閉じる
  const handleBackdropClick = (e: React.MouseEvent) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  // ESCキーで閉じる
  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        onClose();
      }
    };

    if (isOpen) {
      document.addEventListener('keydown', handleEscape);
      document.body.style.overflow = 'hidden';
    }

    return () => {
      document.removeEventListener('keydown', handleEscape);
      document.body.style.overflow = 'unset';
    };
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return (
    <div 
      className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
      onClick={handleBackdropClick}
    >
      <div className="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto animate-in fade-in-0 zoom-in-95 duration-200">
        {/* ヘッダー */}
        <div className="p-6 border-b border-gray-200">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-bold text-gray-900">
              プレミアムプランにアップグレード
            </h2>
            <button
              onClick={onClose}
              disabled={isLoading}
              className="p-1 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50"
              aria-label="モーダルを閉じる"
            >
              <X className="h-5 w-5 text-gray-500" />
            </button>
          </div>
        </div>
        
        {/* アラート */}
        <div className="mx-6 mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
          <div className="flex gap-3">
            <AlertCircle className="h-5 w-5 text-amber-600 flex-shrink-0 mt-0.5" />
            <div>
              <p className="text-sm font-medium text-amber-800">
                今月の無料利用枠（5回）を使い切りました
              </p>
              <p className="text-xs text-amber-600 mt-1">
                プレミアムプランで全機能を無制限にご利用いただけます
              </p>
            </div>
          </div>
        </div>
        
        {/* プラン詳細 */}
        <div className="p-6">
          <div className="border-2 border-purple-200 rounded-lg p-6 bg-gradient-to-br from-purple-50 to-blue-50">
            {/* 価格 */}
            <div className="flex items-end justify-between mb-6">
              <div>
                <p className="text-sm text-gray-600">プレミアムプラン</p>
                <div className="flex items-baseline gap-1 mt-1">
                  <span className="text-3xl font-bold text-gray-900">
                    ¥2,980
                  </span>
                  <span className="text-gray-500 text-lg">/月</span>
                </div>
                <p className="text-xs text-gray-500 mt-1">（税込）</p>
              </div>
              <div className="px-3 py-1 bg-purple-600 text-white text-xs font-medium rounded-full">
                おすすめ
              </div>
            </div>
            
            {/* 特典リスト */}
            <div className="space-y-3">
              <div className="flex items-start gap-3">
                <Check className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-900">
                    全機能が無制限で利用可能
                  </p>
                  <p className="text-xs text-gray-500">
                    シミュレーター、分析機能など
                  </p>
                </div>
              </div>
              
              <div className="flex items-start gap-3">
                <Check className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-900">
                    優先サポート
                  </p>
                  <p className="text-xs text-gray-500">
                    メールでの迅速な対応
                  </p>
                </div>
              </div>
              
              <div className="flex items-start gap-3">
                <Check className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-900">
                    新機能への早期アクセス
                  </p>
                  <p className="text-xs text-gray-500">
                    開発中の機能を先行利用
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        {/* アクションボタン */}
        <div className="p-6 border-t border-gray-200 space-y-3">
          <button
            onClick={handleUpgrade}
            disabled={isLoading}
            className="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium rounded-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all"
          >
            {isLoading ? (
              <>
                <Loader2 className="h-5 w-5 animate-spin" />
                <span>処理中...</span>
              </>
            ) : (
              <>
                <CreditCard className="h-5 w-5" />
                <span>今すぐアップグレード</span>
              </>
            )}
          </button>
          
          <button
            onClick={onClose}
            disabled={isLoading}
            className="w-full px-6 py-2 text-gray-600 hover:text-gray-800 disabled:opacity-50 font-medium transition-colors"
          >
            後で決める
          </button>
        </div>
        
        {/* セキュリティ表示 */}
        <div className="px-6 pb-6">
          <div className="flex items-center justify-center gap-4 text-xs text-gray-500">
            <div className="flex items-center gap-1">
              <Shield className="h-4 w-4" />
              <span>SSL暗号化通信</span>
            </div>
            <div className="flex items-center gap-1">
              <CreditCard className="h-4 w-4" />
              <span>Powered by Stripe</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// グローバルモーダル制御フック
export const useUpgradeModal = () => {
  const [isOpen, setIsOpen] = useState(false);

  useEffect(() => {
    const handleShowModal = () => setIsOpen(true);
    window.addEventListener('show-upgrade-modal', handleShowModal);
    return () => window.removeEventListener('show-upgrade-modal', handleShowModal);
  }, []);

  return {
    isOpen,
    onClose: () => setIsOpen(false)
  };
};
```

### 4.4 課金設定ページコンポーネント

```typescript
// components/BillingSettings.tsx
import React, { useState } from 'react';
import { Star, User, CreditCard, Loader2 } from 'lucide-react';
import { useSubscriptionStatus } from '@/hooks/useSubscriptionStatus';
import { useUsageStatus } from '@/hooks/useUsageStatus';
import { useUpgradeModal } from '@/components/UpgradeModal';
import { supabase } from '@/lib/supabase';
import { toast } from 'react-hot-toast';
import { formatDate } from '@/utils/usageLimit';

export const BillingSettings: React.FC = () => {
  const { subscription, loading: subLoading } = useSubscriptionStatus();
  const { usage, loading: usageLoading } = useUsageStatus();
  const { isOpen: showUpgradeModal, onClose: closeUpgradeModal } = useUpgradeModal();
  const [isManaging, setIsManaging] = useState(false);

  const handleManageSubscription = async () => {
    setIsManaging(true);
    
    try {
      // Stripe Customer Portalへリダイレクト
      const { data, error } = await supabase.functions.invoke(
        'create-portal-session',
        { 
          body: { 
            returnUrl: window.location.href 
          }
        }
      );
      
      if (error) throw error;
      
      if (data?.url) {
        window.location.href = data.url;
      } else {
        throw new Error('ポータルURLの取得に失敗しました');
      }
    } catch (error) {
      console.error('Portal session creation failed:', error);
      toast.error('プラン管理ページの表示に失敗しました');
    } finally {
      setIsManaging(false);
    }
  };

  if (subLoading || usageLoading) {
    return (
      <div className="bg-white rounded-lg shadow p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-4 bg-gray-200 rounded w-1/4"></div>
          <div className="h-16 bg-gray-200 rounded"></div>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg shadow">
      <div className="p-6 border-b border-gray-200">
        <h3 className="text-lg font-medium text-gray-900">
          プラン・お支払い
        </h3>
      </div>
      
      <div className="p-6 space-y-6">
        {/* 現在のプラン */}
        <div>
          <label className="text-sm font-medium text-gray-700 block mb-2">
            現在のプラン
          </label>
          <div className="p-4 bg-gray-50 rounded-lg">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                {subscription?.status === 'active' ? (
                  <>
                    <Star className="h-6 w-6 text-yellow-500 fill-current" />
                    <div>
                      <p className="font-medium text-gray-900">
                        プレミアムプラン
                      </p>
                      <p className="text-sm text-gray-500">
                        ¥2,980/月（税込）
                      </p>
                    </div>
                  </>
                ) : (
                  <>
                    <User className="h-6 w-6 text-gray-400" />
                    <div>
                      <p className="font-medium text-gray-900">
                        無料プラン
                      </p>
                      <p className="text-sm text-gray-500">
                        月5回まで利用可能
                      </p>
                    </div>
                  </>
                )}
              </div>
              
              {subscription?.status === 'active' ? (
                <button
                  onClick={handleManageSubscription}
                  disabled={isManaging}
                  className="px-4 py-2 text-sm text-blue-600 hover:text-blue-700 font-medium disabled:opacity-50 flex items-center gap-2"
                >
                  {isManaging ? (
                    <>
                      <Loader2 className="h-4 w-4 animate-spin" />
                      <span>処理中...</span>
                    </>
                  ) : (
                    'プラン管理'
                  )}
                </button>
              ) : (
                <button
                  onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
                  className="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium transition-colors"
                >
                  アップグレード
                </button>
              )}
            </div>
          </div>
        </div>
        
        {/* 利用状況（無料プランのみ） */}
        {!subscription?.status && usage && (
          <div>
            <label className="text-sm font-medium text-gray-700 block mb-2">
              今月の利用状況
            </label>
            <div className="space-y-3">
              <div className="flex items-center justify-between">
                <span className="text-sm text-gray-600">
                  {usage.currentCount} / {usage.limit} 回使用
                </span>
                <span className="text-sm text-gray-500">
                  {Math.round((usage.currentCount / usage.limit) * 100)}%
                </span>
              </div>
              
              <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  className={`h-full transition-all duration-300 ${
                    usage.currentCount >= usage.limit ? 'bg-red-500' :
                    usage.currentCount >= usage.limit * 0.8 ? 'bg-yellow-500' :
                    'bg-blue-600'
                  }`}
                  style={{ width: `${Math.min((usage.currentCount / usage.limit) * 100, 100)}%` }}
                />
              </div>
              
              {usage.periodEndDate && (
                <p className="text-xs text-gray-500">
                  次回リセット: {formatDate(usage.periodEndDate)} （あと{usage.daysLeft}日）
                </p>
              )}
            </div>
          </div>
        )}
        
        {/* 次回請求日（プレミアム会員のみ） */}
        {subscription?.current_period_end && (
          <div>
            <label className="text-sm font-medium text-gray-700 block mb-1">
              次回請求日
            </label>
            <p className="text-gray-900">
              {formatDate(subscription.current_period_end)}
            </p>
          </div>
        )}

        {/* アップグレード促進（無料プランかつ使用量が多い場合） */}
        {!subscription?.status && usage && usage.currentCount >= 3 && (
          <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div className="flex items-start gap-3">
              <Star className="h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5" />
              <div className="flex-1">
                <p className="text-sm font-medium text-blue-800 mb-1">
                  プレミアムプランで無制限利用
                </p>
                <p className="text-xs text-blue-600 mb-3">
                  月額2,980円で全機能が使い放題になります
                </p>
                <button
                  onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
                  className="px-3 py-1 bg-blue-600 text-white text-xs rounded-md hover:bg-blue-700 transition-colors"
                >
                  詳細を見る
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};
```

## 5. モバイル対応

### 5.1 レスポンシブ使用状況バー

```typescript
// components/MobileUsageBar.tsx
import React from 'react';
import { useUsageStatus } from '@/hooks/useUsageStatus';

export const MobileUsageBar: React.FC = () => {
  const { usage } = useUsageStatus();
  
  // プレミアム会員または利用状況がない場合は非表示
  if (!usage || usage.isSubscribed) return null;
  
  const remaining = usage.limit - usage.currentCount;
  const percentage = (usage.currentCount / usage.limit) * 100;

  return (
    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 md:hidden z-40 safe-area-inset-bottom">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-24 h-1.5 bg-gray-200 rounded-full overflow-hidden">
            <div 
              className={`h-full transition-all duration-300 ${
                percentage >= 100 ? 'bg-red-500' :
                percentage >= 80 ? 'bg-yellow-500' : 
                'bg-blue-600'
              }`}
              style={{ width: `${Math.min(percentage, 100)}%` }}
            />
          </div>
          <span className="text-xs text-gray-600">
            残り{remaining}回
          </span>
        </div>
        
        {remaining <= 2 && (
          <button 
            onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
            className="text-xs text-blue-600 font-medium px-2 py-1 rounded hover:bg-blue-50 transition-colors"
          >
            アップグレード
          </button>
        )}
      </div>
    </div>
  );
};
```

### 5.2 モバイル用モーダル調整

```css
/* globals.css - モバイル対応用のスタイル */
@media (max-width: 768px) {
  .upgrade-modal {
    margin: 1rem;
    max-height: calc(100vh - 2rem);
  }
  
  /* iOS Safari の安全領域対応 */
  .safe-area-inset-bottom {
    padding-bottom: env(safe-area-inset-bottom);
  }
  
  /* モバイルでのボタンサイズ調整 */
  .mobile-button {
    min-height: 44px; /* タップしやすい最小サイズ */
  }
}
```

## 6. エラーハンドリングとユーザーフィードバック

### 6.1 エラーハンドリング戦略

```typescript
// utils/errorHandler.ts
import { toast } from 'react-hot-toast';

export class PaymentError extends Error {
  constructor(message: string, public code?: string) {
    super(message);
    this.name = 'PaymentError';
  }
}

export class UsageError extends Error {
  constructor(message: string, public code?: string) {
    super(message);
    this.name = 'UsageError';
  }
}

export const handleError = (error: unknown, context?: string) => {
  console.error(`Error in ${context}:`, error);
  
  if (error instanceof PaymentError) {
    switch (error.code) {
      case 'card_declined':
        toast.error('カードが承認されませんでした。別のカードをお試しください。');
        break;
      case 'insufficient_funds':
        toast.error('残高不足です。お支払い方法を確認してください。');
        break;
      default:
        toast.error('決済処理に失敗しました。もう一度お試しください。');
    }
  } else if (error instanceof UsageError) {
    toast.error('利用状況の更新に失敗しました。');
  } else if (error instanceof Error) {
    if (error.message.includes('network') || error.message.includes('fetch')) {
      toast.error('ネットワークエラーが発生しました。接続を確認してください。');
    } else {
      toast.error('予期しないエラーが発生しました。');
    }
  } else {
    toast.error('システムエラーが発生しました。');
  }
};
```

### 6.2 ローディング状態の管理

```typescript
// hooks/useAsyncOperation.ts
import { useState } from 'react';
import { handleError } from '@/utils/errorHandler';

export const useAsyncOperation = <T = any>() => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const execute = async (
    operation: () => Promise<T>,
    onSuccess?: (result: T) => void,
    onError?: (error: unknown) => void,
    context?: string
  ) => {
    setLoading(true);
    setError(null);
    
    try {
      const result = await operation();
      onSuccess?.(result);
      return result;
    } catch (err) {
      setError(err instanceof Error ? err.message : 'エラーが発生しました');
      onError?.(err);
      handleError(err, context);
      throw err;
    } finally {
      setLoading(false);
    }
  };

  return { loading, error, execute };
};
```

### 6.3 ユーザーフィードバック

```typescript
// components/FeedbackMessages.tsx
import React from 'react';
import { CheckCircle, AlertCircle, XCircle, Info } from 'lucide-react';

type MessageType = 'success' | 'warning' | 'error' | 'info';

interface FeedbackMessageProps {
  type: MessageType;
  title: string;
  message?: string;
  onClose?: () => void;
}

export const FeedbackMessage: React.FC<FeedbackMessageProps> = ({
  type,
  title,
  message,
  onClose
}) => {
  const config = {
    success: {
      icon: CheckCircle,
      bgColor: 'bg-green-50',
      borderColor: 'border-green-200',
      iconColor: 'text-green-600',
      titleColor: 'text-green-800',
      messageColor: 'text-green-600'
    },
    warning: {
      icon: AlertCircle,
      bgColor: 'bg-yellow-50',
      borderColor: 'border-yellow-200',
      iconColor: 'text-yellow-600',
      titleColor: 'text-yellow-800',
      messageColor: 'text-yellow-600'
    },
    error: {
      icon: XCircle,
      bgColor: 'bg-red-50',
      borderColor: 'border-red-200',
      iconColor: 'text-red-600',
      titleColor: 'text-red-800',
      messageColor: 'text-red-600'
    },
    info: {
      icon: Info,
      bgColor: 'bg-blue-50',
      borderColor: 'border-blue-200',
      iconColor: 'text-blue-600',
      titleColor: 'text-blue-800',
      messageColor: 'text-blue-600'
    }
  };

  const { icon: Icon, ...styles } = config[type];

  return (
    <div className={`p-4 rounded-lg border ${styles.bgColor} ${styles.borderColor}`}>
      <div className="flex items-start gap-3">
        <Icon className={`h-5 w-5 ${styles.iconColor} flex-shrink-0 mt-0.5`} />
        <div className="flex-1">
          <p className={`text-sm font-medium ${styles.titleColor}`}>
            {title}
          </p>
          {message && (
            <p className={`text-xs mt-1 ${styles.messageColor}`}>
              {message}
            </p>
          )}
        </div>
        {onClose && (
          <button
            onClick={onClose}
            className={`p-1 hover:bg-white/50 rounded ${styles.iconColor}`}
          >
            <XCircle className="h-4 w-4" />
          </button>
        )}
      </div>
    </div>
  );
};
```

## 7. パフォーマンス最適化

### 7.1 コンポーネントの最適化

```typescript
// React.memoとuseMemoの活用例
import React, { memo, useMemo, useCallback } from 'react';

export const UsageStatusBar = memo(() => {
  const { usage, loading } = useUsageStatus();

  // 計算の最適化
  const statusInfo = useMemo(() => {
    if (!usage) return null;
    
    const remaining = usage.limit - usage.currentCount;
    const percentage = (usage.currentCount / usage.limit) * 100;
    const isWarning = remaining <= 2 && remaining > 0;
    const isError = remaining <= 0;
    
    return { remaining, percentage, isWarning, isError };
  }, [usage]);

  // イベントハンドラーの最適化
  const handleUpgradeClick = useCallback(() => {
    window.dispatchEvent(new CustomEvent('show-upgrade-modal'));
  }, []);

  if (loading || !usage || !statusInfo) return <LoadingSkeleton />;

  // JSXの返却...
});

// 表示名の設定（デバッグ時に便利）
UsageStatusBar.displayName = 'UsageStatusBar';
```

### 7.2 データの定期更新

```typescript
// hooks/usePeriodicRefresh.ts
import { useEffect, useRef } from 'react';

export const usePeriodicRefresh = (
  callback: () => void,
  intervalMs: number = 5 * 60 * 1000, // デフォルト5分
  enabled: boolean = true
) => {
  const callbackRef = useRef(callback);
  const intervalRef = useRef<NodeJS.Timeout>();

  // コールバックの最新版を保持
  useEffect(() => {
    callbackRef.current = callback;
  });

  useEffect(() => {
    if (!enabled) {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
      return;
    }

    // 初回実行
    callbackRef.current();

    // 定期実行の設定
    intervalRef.current = setInterval(() => {
      callbackRef.current();
    }, intervalMs);

    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
    };
  }, [intervalMs, enabled]);
};

// 使用例
export const useUsageStatus = () => {
  const { user } = useAuthContext();
  const [usage, setUsage] = useState<UsageStatus | null>(null);
  
  const loadUsageStatus = useCallback(async () => {
    if (user) {
      const status = await checkUsageLimit(user.id);
      setUsage(status);
    }
  }, [user]);

  // 5分ごとに使用状況を更新（無料プランのみ）
  usePeriodicRefresh(
    loadUsageStatus,
    5 * 60 * 1000,
    user && !usage?.isSubscribed // プレミアム会員は定期更新不要
  );

  return { usage, refetch: loadUsageStatus };
};
```

## 8. アクセシビリティ対応

### 8.1 ARIA属性とキーボードナビゲーション

```typescript
// アクセシビリティを考慮したボタン実装
export const AccessibleUpgradeButton: React.FC = () => {
  const [isPressed, setIsPressed] = useState(false);

  return (
    <button
      onClick={handleUpgrade}
      onKeyDown={(e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          setIsPressed(true);
          handleUpgrade();
        }
      }}
      onKeyUp={() => setIsPressed(false)}
      aria-label="プレミアムプランにアップグレードする"
      aria-describedby="upgrade-benefits"
      aria-pressed={isPressed}
      role="button"
      tabIndex={0}
      className="focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
    >
      アップグレード
    </button>
  );
};

// スクリーンリーダー用の追加情報
const UpgradeDescription: React.FC = () => (
  <div id="upgrade-benefits" className="sr-only">
    プレミアムプランでは月額2980円で全機能が無制限で利用できます。
    無料プランは月5回までの制限があります。
  </div>
);
```

### 8.2 フォーカス管理

```typescript
// モーダルのフォーカストラップ
import { useEffect, useRef } from 'react';

export const useModalFocus = (isOpen: boolean) => {
  const modalRef = useRef<HTMLDivElement>(null);
  const previousFocusRef = useRef<HTMLElement | null>(null);

  useEffect(() => {
    if (isOpen) {
      // 現在のフォーカス要素を保存
      previousFocusRef.current = document.activeElement as HTMLElement;
      
      // モーダル内の最初のフォーカス可能な要素にフォーカス
      const focusableElements = modalRef.current?.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      
      if (focusableElements && focusableElements.length > 0) {
        (focusableElements[0] as HTMLElement).focus();
      }
    } else {
      // モーダルが閉じられたら元の要素にフォーカスを戻す
      previousFocusRef.current?.focus();
    }
  }, [isOpen]);

  return modalRef;
};
```

## 9. テスト実装例

### 9.1 単体テスト

```typescript
// __tests__/components/UsageStatusBar.test.tsx
import React from 'react';
import { render, screen } from '@testing-library/react';
import { UsageStatusBar } from '@/components/UsageStatusBar';
import { useUsageStatus } from '@/hooks/useUsageStatus';

// モックの設定
jest.mock('@/hooks/useUsageStatus');
const mockUseUsageStatus = useUsageStatus as jest.MockedFunction<typeof useUsageStatus>;

describe('UsageStatusBar', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('プレミアム会員の場合、適切に表示される', () => {
    mockUseUsageStatus.mockReturnValue({
      usage: {
        canUse: true,
        currentCount: 0,
        limit: -1,
        isSubscribed: true,
        periodEndDate: null,
        daysLeft: -1
      },
      loading: false,
      error: null,
      refetch: jest.fn()
    });

    render(<UsageStatusBar />);
    
    expect(screen.getByText('プレミアムプラン')).toBeInTheDocument();
    expect(screen.getByText('全機能が無制限でご利用いただけます')).toBeInTheDocument();
  });

  it('無料プランで制限に達している場合、エラー表示される', () => {
    mockUseUsageStatus.mockReturnValue({
      usage: {
        canUse: false,
        currentCount: 5,
        limit: 5,
        isSubscribed: false,
        periodEndDate: new Date('2025-09-01'),
        daysLeft: 7
      },
      loading: false,
      error: null,
      refetch: jest.fn()
    });

    render(<UsageStatusBar />);
    
    expect(screen.getByText('今月の無料利用枠を使い切りました')).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /アップグレードして続ける/ })).toBeInTheDocument();
  });
});
```

### 9.2 統合テスト

```typescript
// __tests__/integration/subscription-flow.test.tsx
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { SimulatorExecuteButton } from '@/components/SimulatorExecuteButton';
import { UpgradeModal } from '@/components/UpgradeModal';
import { checkUsageLimit, incrementUsage } from '@/utils/usageLimit';

// モックの設定
jest.mock('@/utils/usageLimit');
const mockCheckUsageLimit = checkUsageLimit as jest.MockedFunction<typeof checkUsageLimit>;
const mockIncrementUsage = incrementUsage as jest.MockedFunction<typeof incrementUsage>;

describe('Subscription Flow Integration', () => {
  it('無料プラン制限到達時のフロー', async () => {
    // 制限到達の状態を模擬
    mockCheckUsageLimit.mockResolvedValue({
      canUse: false,
      currentCount: 5,
      limit: 5,
      isSubscribed: false,
      periodEndDate: new Date(),
      daysLeft: 7
    });

    const mockOnExecute = jest.fn();
    
    render(
      <>
        <SimulatorExecuteButton onExecute={mockOnExecute} />
        <UpgradeModal isOpen={true} onClose={() => {}} />
      </>
    );

    // 実行ボタンをクリック
    const executeButton = screen.getByRole('button', { name: /利用制限に到達/ });
    fireEvent.click(executeButton);

    // アップグレードモーダルが表示されることを確認
    await waitFor(() => {
      expect(screen.getByText('プレミアムプランにアップグレード')).toBeInTheDocument();
    });

    // 実行関数は呼ばれていないことを確認
    expect(mockOnExecute).not.toHaveBeenCalled();
  });
});
```

## 10. 本番環境への展開

### 10.1 環境変数の設定

```bash
# .env.production
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
VITE_STRIPE_PUBLISHABLE_KEY=pk_live_...
VITE_STRIPE_PRICE_ID=price_live_...
```

### 10.2 Build時の最適化

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          stripe: ['@stripe/stripe-js'],
          supabase: ['@supabase/supabase-js']
        }
      }
    }
  }
});
```

### 10.3 デプロイメント後のチェックリスト

- [ ] Stripe本番環境での決済テスト
- [ ] サブスクリプション作成・更新・解約の動作確認
- [ ] 使用制限の正常動作確認
- [ ] モバイルデバイスでのUI確認
- [ ] アクセシビリティチェック
- [ ] パフォーマンス測定
- [ ] エラーログの監視設定

## 11. まとめ

このフロントエンド実装ガイドでは、以下の要素を包括的にカバーしました：

1. **状態管理**: カスタムフックを使った効率的な状態管理
2. **UIコンポーネント**: 再利用可能でアクセシブルなコンポーネント設計
3. **エラーハンドリング**: ユーザーフレンドリーなエラー処理とフィードバック
4. **パフォーマンス**: メモ化と最適化による高速なUI
5. **アクセシビリティ**: WCAG準拠のインクルーシブな設計
6. **テスト**: 信頼性の高い自動テスト実装
7. **モバイル対応**: レスポンシブでタッチフレンドリーなUI

これらの実装により、ユーザーにとって使いやすく、開発者にとって保守しやすいサブスクリプション管理システムが実現できます。

---

**次のステップ**: 
1. コンポーネントの段階的実装
2. テストの追加と実行
3. パフォーマンス測定と最適化
4. ユーザビリティテストの実施
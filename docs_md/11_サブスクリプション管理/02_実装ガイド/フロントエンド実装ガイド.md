# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ã‚¬ã‚¤ãƒ‰ - ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†

ä½œæˆæ—¥: 2025å¹´8æœˆ14æ—¥  
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0.0

## 1. æ¦‚è¦

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€Stripeã‚’ä½¿ç”¨ã—ãŸã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†æ©Ÿèƒ½ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚
ãƒ•ãƒªãƒ¼ãƒŸã‚¢ãƒ ãƒ¢ãƒ‡ãƒ«ï¼ˆç„¡æ–™5å›/æœˆã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç„¡åˆ¶é™ï¼‰ã‚’React + TypeScriptã§å®Ÿç¾ã™ã‚‹æ–¹æ³•ã‚’åŒ…æ‹¬çš„ã«ã‚«ãƒãƒ¼ã—ã¾ã™ã€‚

### 1.1 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: React + TypeScript
- **æ±ºæ¸ˆ**: Stripe + Supabase Edge Functions
- **çŠ¶æ…‹ç®¡ç†**: React Hooks + Context API
- **UI**: Tailwind CSS

### 1.2 ä¸»è¦æ©Ÿèƒ½
- ä½¿ç”¨çŠ¶æ³ã®è¡¨ç¤ºã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
- åˆ©ç”¨åˆ¶é™ã®ãƒã‚§ãƒƒã‚¯ã¨è­¦å‘Šè¡¨ç¤º
- ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«
- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³è¡¨ç¤º
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

## 2. çŠ¶æ…‹ç®¡ç†ã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯

### 2.1 ä½¿ç”¨çŠ¶æ³ç®¡ç†ãƒ•ãƒƒã‚¯ï¼ˆuseUsageStatusï¼‰

```typescript
// hooks/useUsageStatus.ts
import { useState, useEffect } from 'react';
import { useAuthContext } from '@/contexts/AuthContext';
import { checkUsageLimit, incrementUsage } from '@/utils/usageLimit';

interface UsageStatus {
  canUse: boolean;
  currentCount: number;
  limit: number;
  isSubscribed: boolean;
  periodEndDate: Date | null;
  daysLeft: number;
}

export const useUsageStatus = () => {
  const { user } = useAuthContext();
  const [usage, setUsage] = useState<UsageStatus | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (user) {
      loadUsageStatus();
    }
  }, [user]);

  const loadUsageStatus = async () => {
    try {
      setError(null);
      const status = await checkUsageLimit(user.id);
      setUsage(status);
    } catch (error) {
      console.error('Failed to load usage status:', error);
      setError('ä½¿ç”¨çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  };

  const refetch = () => {
    setLoading(true);
    loadUsageStatus();
  };

  return { 
    usage, 
    loading, 
    error,
    refetch 
  };
};
```

### 2.2 ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†

```typescript
// hooks/useSubscriptionStatus.ts
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { useAuthContext } from '@/contexts/AuthContext';

interface Subscription {
  id: string;
  status: 'active' | 'inactive' | 'cancelled' | 'past_due';
  current_period_start: Date;
  current_period_end: Date;
  stripe_subscription_id: string;
}

export const useSubscriptionStatus = () => {
  const { user } = useAuthContext();
  const [subscription, setSubscription] = useState<Subscription | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (user) {
      loadSubscription();
    }
  }, [user]);

  const loadSubscription = async () => {
    try {
      const { data, error } = await supabase
        .from('subscriptions')
        .select('*')
        .eq('user_id', user.id)
        .eq('status', 'active')
        .single();

      if (!error && data) {
        setSubscription({
          ...data,
          current_period_start: new Date(data.current_period_start),
          current_period_end: new Date(data.current_period_end)
        });
      }
    } catch (error) {
      console.error('Failed to load subscription:', error);
    } finally {
      setLoading(false);
    }
  };

  return { subscription, loading, refetch: loadSubscription };
};
```

## 3. ä½¿ç”¨åˆ¶é™ç®¡ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

### 3.1 usageLimit.ts

```typescript
// utils/usageLimit.ts
import { supabase } from '@/lib/supabase';

export interface UsageStatus {
  canUse: boolean;
  currentCount: number;
  limit: number;
  isSubscribed: boolean;
  periodEndDate: Date | null;
  daysLeft: number;
}

export const checkUsageLimit = async (userId: string): Promise<UsageStatus> => {
  try {
    // 1. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèªï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ãƒã‚§ãƒƒã‚¯ï¼‰
    const { data: subscriptions, error: subError } = await supabase
      .from('subscriptions')
      .select('status')
      .eq('user_id', userId)
      .eq('status', 'active')
      .limit(1);

    if (subError) throw subError;

    // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã¯ç„¡åˆ¶é™åˆ©ç”¨
    if (subscriptions && subscriptions.length > 0) {
      return {
        canUse: true,
        currentCount: 0,
        limit: -1, // -1ã¯ç„¡åˆ¶é™ã‚’è¡¨ã™
        isSubscribed: true,
        periodEndDate: null,
        daysLeft: -1
      };
    }

    // 2. ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®ä½¿ç”¨çŠ¶æ³ç¢ºèªï¼ˆè‡ªå‹•ãƒªã‚»ãƒƒãƒˆä»˜ãï¼‰
    const { data, error } = await supabase
      .rpc('check_and_reset_usage', { 
        p_user_id: userId 
      });

    if (error) throw error;

    const usageData = Array.isArray(data) ? data[0] : data;
    const periodEnd = new Date(usageData.period_end);
    const daysLeft = Math.ceil((periodEnd.getTime() - Date.now()) / (1000 * 60 * 60 * 24));

    return {
      canUse: usageData.current_count < 5,
      currentCount: usageData.current_count,
      limit: 5,
      isSubscribed: false,
      periodEndDate: periodEnd,
      daysLeft: Math.max(0, daysLeft)
    };

  } catch (error) {
    console.error('Usage limit check failed:', error);
    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å®‰å…¨å´ã«å€’ã—ã¦åˆ©ç”¨ä¸å¯ã¨ã™ã‚‹
    return {
      canUse: false,
      currentCount: 5,
      limit: 5,
      isSubscribed: false,
      periodEndDate: null,
      daysLeft: 0
    };
  }
};

export const incrementUsage = async (userId: string, featureType: string) => {
  try {
    // ä½¿ç”¨å±¥æ­´ã«è¨˜éŒ²
    const { error: historyError } = await supabase
      .from('usage_history')
      .insert({
        user_id: userId,
        feature_type: featureType,
        feature_data: { timestamp: new Date().toISOString() }
      });

    if (historyError) throw historyError;

    // ä½¿ç”¨å›æ•°ã‚’å¢—åŠ 
    const { error: updateError } = await supabase
      .from('user_usage')
      .update({ 
        usage_count: supabase.sql`usage_count + 1`,
        updated_at: new Date().toISOString()
      })
      .eq('user_id', userId);

    if (updateError) throw updateError;

  } catch (error) {
    console.error('Failed to increment usage:', error);
    throw error;
  }
};

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
export const formatDate = (date: Date): string => {
  return date.toLocaleDateString('ja-JP', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

export const calculateDaysLeft = (endDate: string): number => {
  const end = new Date(endDate);
  const now = new Date();
  const diffTime = end.getTime() - now.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return Math.max(0, diffDays);
};
```

## 4. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…

### 4.1 ä½¿ç”¨çŠ¶æ³è¡¨ç¤ºãƒãƒ¼ï¼ˆUsageStatusBarï¼‰

```typescript
// components/UsageStatusBar.tsx
import React from 'react';
import { Calendar, Star, AlertTriangle, XCircle } from 'lucide-react';
import { useUsageStatus } from '@/hooks/useUsageStatus';
import { formatDate } from '@/utils/usageLimit';

export const UsageStatusBar: React.FC = () => {
  const { usage, loading } = useUsageStatus();

  if (loading) {
    return (
      <div className="bg-gray-50 border-b border-gray-200 px-4 py-3">
        <div className="max-w-7xl mx-auto">
          <div className="h-4 bg-gray-200 rounded animate-pulse"></div>
        </div>
      </div>
    );
  }

  if (!usage) return null;

  // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡è¡¨ç¤º
  if (usage.isSubscribed) {
    return (
      <div className="bg-gradient-to-r from-purple-50 to-blue-50 border-b border-purple-200 px-4 py-3">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="flex items-center gap-2">
              <Star className="h-5 w-5 text-yellow-500 fill-current" />
              <span className="text-sm font-medium text-purple-800">
                ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³
              </span>
            </div>
            <span className="text-sm text-gray-600">
              å…¨æ©Ÿèƒ½ãŒç„¡åˆ¶é™ã§ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™
            </span>
          </div>
          <Link 
            to="/account/billing" 
            className="text-sm text-purple-600 hover:text-purple-700 font-medium"
          >
            ãƒ—ãƒ©ãƒ³ç®¡ç† â†’
          </Link>
        </div>
      </div>
    );
  }

  const remaining = usage.limit - usage.currentCount;
  const percentage = (usage.currentCount / usage.limit) * 100;

  // åˆ¶é™åˆ°é”æ™‚ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
  if (remaining <= 0) {
    return (
      <div className="bg-red-50 border-b border-red-200 px-4 py-3">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-2">
            <XCircle className="h-5 w-5 text-red-600" />
            <div>
              <p className="text-sm font-medium text-red-800">
                ä»Šæœˆã®ç„¡æ–™åˆ©ç”¨æ ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸ
              </p>
              <p className="text-xs text-red-600">
                ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã§å¼•ãç¶šãã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™
              </p>
            </div>
          </div>
          <button 
            onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
            className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center gap-2 text-sm font-medium"
          >
            ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ç¶šã‘ã‚‹
          </button>
        </div>
      </div>
    );
  }

  // è­¦å‘Šè¡¨ç¤ºï¼ˆæ®‹ã‚Š1-2å›ï¼‰
  if (remaining <= 2) {
    return (
      <div className="bg-yellow-50 border-b border-yellow-200 px-4 py-3">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-2">
            <AlertTriangle className="h-5 w-5 text-yellow-600" />
            <p className="text-sm font-medium text-yellow-800">
              åˆ©ç”¨å¯èƒ½å›æ•°ãŒæ®‹ã‚Š{remaining}å›ã§ã™
            </p>
          </div>
          <button 
            onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
            className="px-4 py-1.5 bg-yellow-600 text-white text-sm rounded-md hover:bg-yellow-700 font-medium"
          >
            ä»Šã™ãã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
          </button>
        </div>
      </div>
    );
  }

  // é€šå¸¸è¡¨ç¤º
  return (
    <div className="bg-white border-b border-gray-200 px-4 py-3">
      <div className="max-w-7xl mx-auto flex items-center justify-between">
        <div className="flex items-center gap-4">
          {/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */}
          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-600">åˆ©ç”¨çŠ¶æ³:</span>
            <div className="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div 
                className={`h-full transition-all duration-300 ${
                  percentage >= 80 ? 'bg-red-500' : 
                  percentage >= 60 ? 'bg-yellow-500' : 
                  'bg-blue-500'
                }`}
                style={{ width: `${percentage}%` }}
              />
            </div>
            <span className="text-sm font-medium">
              {usage.currentCount}/{usage.limit}å›
            </span>
          </div>
          
          {/* ãƒªã‚»ãƒƒãƒˆæ—¥è¡¨ç¤º */}
          {usage.periodEndDate && (
            <div className="flex items-center gap-1 text-sm text-gray-500">
              <Calendar className="h-4 w-4" />
              <span>
                æ¬¡å›ãƒªã‚»ãƒƒãƒˆ: {formatDate(usage.periodEndDate)} 
                ï¼ˆã‚ã¨{usage.daysLeft}æ—¥ï¼‰
              </span>
            </div>
          )}
        </div>
        
        {/* ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰CTA */}
        {remaining <= 2 && (
          <button 
            onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
            className="text-sm text-blue-600 hover:text-blue-700 font-medium"
          >
            ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã§ç„¡åˆ¶é™åˆ©ç”¨ â†’
          </button>
        )}
      </div>
    </div>
  );
};
```

### 4.2 ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼å®Ÿè¡Œãƒœã‚¿ãƒ³

```typescript
// components/SimulatorExecuteButton.tsx
import React, { useState } from 'react';
import { PlayCircle, Loader2, Lock, Star } from 'lucide-react';
import { useUsageStatus } from '@/hooks/useUsageStatus';
import { useAuthContext } from '@/contexts/AuthContext';
import { incrementUsage } from '@/utils/usageLimit';
import { toast } from 'react-hot-toast';

interface ButtonProps {
  onExecute: () => Promise<void>;
  isLoading?: boolean;
  disabled?: boolean;
}

export const SimulatorExecuteButton: React.FC<ButtonProps> = ({ 
  onExecute, 
  isLoading = false,
  disabled = false
}) => {
  const { usage, refetch } = useUsageStatus();
  const { user } = useAuthContext();
  const [executing, setExecuting] = useState(false);

  const handleClick = async () => {
    if (!user || !usage) return;

    // åˆ©ç”¨åˆ¶é™ãƒã‚§ãƒƒã‚¯
    if (!usage.canUse && !usage.isSubscribed) {
      // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      window.dispatchEvent(new CustomEvent('show-upgrade-modal'));
      return;
    }

    setExecuting(true);
    
    try {
      // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
      await onExecute();
      
      // ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®å ´åˆã€åˆ©ç”¨å›æ•°ã‚’å¢—ã‚„ã™
      if (!usage.isSubscribed) {
        await incrementUsage(user.id, 'simulator');
        // åˆ©ç”¨çŠ¶æ³ã‚’å†å–å¾—
        await refetch();
        
        // ä½¿ç”¨å›æ•°ã®æ›´æ–°ã‚’é€šçŸ¥
        const newCount = usage.currentCount + 1;
        if (newCount >= usage.limit) {
          toast.success('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ä»Šæœˆã®ç„¡æ–™åˆ©ç”¨æ ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸã€‚');
        } else {
          toast.success(`ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ®‹ã‚Š${usage.limit - newCount}å›åˆ©ç”¨å¯èƒ½ã§ã™ã€‚`);
        }
      } else {
        toast.success('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
      }
    } catch (error) {
      console.error('Simulation execution failed:', error);
      toast.error('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    } finally {
      setExecuting(false);
    }
  };

  const isButtonLoading = isLoading || executing;
  const isButtonDisabled = disabled || isButtonLoading;

  // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡
  if (usage?.isSubscribed) {
    return (
      <button
        onClick={handleClick}
        disabled={isButtonDisabled}
        className="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium rounded-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all"
      >
        {isButtonLoading ? (
          <>
            <Loader2 className="h-5 w-5 animate-spin" />
            <span>å®Ÿè¡Œä¸­...</span>
          </>
        ) : (
          <>
            <Star className="h-5 w-5" />
            <span>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</span>
          </>
        )}
      </button>
    );
  }

  // ç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼ˆåˆ©ç”¨å¯èƒ½ï¼‰
  if (usage?.canUse) {
    const remaining = usage.limit - usage.currentCount;
    
    return (
      <div className="space-y-2">
        <button
          onClick={handleClick}
          disabled={isButtonDisabled}
          className="w-full px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all"
        >
          {isButtonLoading ? (
            <>
              <Loader2 className="h-5 w-5 animate-spin" />
              <span>å®Ÿè¡Œä¸­...</span>
            </>
          ) : (
            <>
              <PlayCircle className="h-5 w-5" />
              <span>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</span>
              <span className="text-xs opacity-80 ml-1">
                ï¼ˆæ®‹ã‚Š{remaining}å›ï¼‰
              </span>
            </>
          )}
        </button>
        
        {/* æ®‹ã‚Šå›æ•°ãŒå°‘ãªã„å ´åˆã®æ³¨æ„è¡¨ç¤º */}
        {remaining <= 2 && (
          <p className="text-xs text-gray-500 text-center">
            ğŸ’¡ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã§ç„¡åˆ¶é™åˆ©ç”¨ãŒå¯èƒ½ã§ã™
          </p>
        )}
      </div>
    );
  }

  // ç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼ˆåˆ¶é™åˆ°é”ï¼‰
  return (
    <button
      onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
      className="w-full px-6 py-3 bg-gray-400 text-white font-medium rounded-lg cursor-pointer flex items-center justify-center gap-2 hover:bg-gray-500 transition-all"
    >
      <Lock className="h-5 w-5" />
      <span>åˆ©ç”¨åˆ¶é™ã«åˆ°é” - ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¿…è¦</span>
    </button>
  );
};
```

### 4.3 ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«

```typescript
// components/UpgradeModal.tsx
import React, { useState, useEffect } from 'react';
import { X, AlertCircle, Check, CreditCard, Loader2, Shield } from 'lucide-react';
import { loadStripe } from '@stripe/stripe-js';
import { useAuthContext } from '@/contexts/AuthContext';
import { supabase } from '@/lib/supabase';
import { toast } from 'react-hot-toast';

const stripePromise = loadStripe(import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY);

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
}

export const UpgradeModal: React.FC<ModalProps> = ({ isOpen, onClose }) => {
  const [isLoading, setIsLoading] = useState(false);
  const { user, session } = useAuthContext();

  const handleUpgrade = async () => {
    if (!user || !session) {
      toast.error('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
      return;
    }

    setIsLoading(true);
    
    try {
      // Checkout Sessionä½œæˆ
      const response = await fetch(
        `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/smart-service`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
          },
          body: JSON.stringify({
            priceId: import.meta.env.VITE_STRIPE_PRICE_ID,
            userId: user.id,
          }),
        }
      );

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const data = await response.json();
      
      // Stripeã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      if (data.url) {
        window.location.href = data.url;
      } else if (data.sessionId) {
        const stripe = await stripePromise;
        const result = await stripe?.redirectToCheckout({ 
          sessionId: data.sessionId 
        });
        
        if (result?.error) {
          throw new Error(result.error.message);
        }
      } else {
        throw new Error('æ±ºæ¸ˆURLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
    } catch (error) {
      console.error('Upgrade error:', error);
      toast.error(error instanceof Error ? error.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  const handleBackdropClick = (e: React.MouseEvent) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  // ESCã‚­ãƒ¼ã§é–‰ã˜ã‚‹
  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        onClose();
      }
    };

    if (isOpen) {
      document.addEventListener('keydown', handleEscape);
      document.body.style.overflow = 'hidden';
    }

    return () => {
      document.removeEventListener('keydown', handleEscape);
      document.body.style.overflow = 'unset';
    };
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return (
    <div 
      className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
      onClick={handleBackdropClick}
    >
      <div className="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto animate-in fade-in-0 zoom-in-95 duration-200">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="p-6 border-b border-gray-200">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-bold text-gray-900">
              ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
            </h2>
            <button
              onClick={onClose}
              disabled={isLoading}
              className="p-1 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50"
              aria-label="ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹"
            >
              <X className="h-5 w-5 text-gray-500" />
            </button>
          </div>
        </div>
        
        {/* ã‚¢ãƒ©ãƒ¼ãƒˆ */}
        <div className="mx-6 mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
          <div className="flex gap-3">
            <AlertCircle className="h-5 w-5 text-amber-600 flex-shrink-0 mt-0.5" />
            <div>
              <p className="text-sm font-medium text-amber-800">
                ä»Šæœˆã®ç„¡æ–™åˆ©ç”¨æ ï¼ˆ5å›ï¼‰ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸ
              </p>
              <p className="text-xs text-amber-600 mt-1">
                ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã§å…¨æ©Ÿèƒ½ã‚’ç„¡åˆ¶é™ã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™
              </p>
            </div>
          </div>
        </div>
        
        {/* ãƒ—ãƒ©ãƒ³è©³ç´° */}
        <div className="p-6">
          <div className="border-2 border-purple-200 rounded-lg p-6 bg-gradient-to-br from-purple-50 to-blue-50">
            {/* ä¾¡æ ¼ */}
            <div className="flex items-end justify-between mb-6">
              <div>
                <p className="text-sm text-gray-600">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³</p>
                <div className="flex items-baseline gap-1 mt-1">
                  <span className="text-3xl font-bold text-gray-900">
                    Â¥2,980
                  </span>
                  <span className="text-gray-500 text-lg">/æœˆ</span>
                </div>
                <p className="text-xs text-gray-500 mt-1">ï¼ˆç¨è¾¼ï¼‰</p>
              </div>
              <div className="px-3 py-1 bg-purple-600 text-white text-xs font-medium rounded-full">
                ãŠã™ã™ã‚
              </div>
            </div>
            
            {/* ç‰¹å…¸ãƒªã‚¹ãƒˆ */}
            <div className="space-y-3">
              <div className="flex items-start gap-3">
                <Check className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-900">
                    å…¨æ©Ÿèƒ½ãŒç„¡åˆ¶é™ã§åˆ©ç”¨å¯èƒ½
                  </p>
                  <p className="text-xs text-gray-500">
                    ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã€åˆ†ææ©Ÿèƒ½ãªã©
                  </p>
                </div>
              </div>
              
              <div className="flex items-start gap-3">
                <Check className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-900">
                    å„ªå…ˆã‚µãƒãƒ¼ãƒˆ
                  </p>
                  <p className="text-xs text-gray-500">
                    ãƒ¡ãƒ¼ãƒ«ã§ã®è¿…é€Ÿãªå¯¾å¿œ
                  </p>
                </div>
              </div>
              
              <div className="flex items-start gap-3">
                <Check className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-900">
                    æ–°æ©Ÿèƒ½ã¸ã®æ—©æœŸã‚¢ã‚¯ã‚»ã‚¹
                  </p>
                  <p className="text-xs text-gray-500">
                    é–‹ç™ºä¸­ã®æ©Ÿèƒ½ã‚’å…ˆè¡Œåˆ©ç”¨
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}
        <div className="p-6 border-t border-gray-200 space-y-3">
          <button
            onClick={handleUpgrade}
            disabled={isLoading}
            className="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium rounded-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all"
          >
            {isLoading ? (
              <>
                <Loader2 className="h-5 w-5 animate-spin" />
                <span>å‡¦ç†ä¸­...</span>
              </>
            ) : (
              <>
                <CreditCard className="h-5 w-5" />
                <span>ä»Šã™ãã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</span>
              </>
            )}
          </button>
          
          <button
            onClick={onClose}
            disabled={isLoading}
            className="w-full px-6 py-2 text-gray-600 hover:text-gray-800 disabled:opacity-50 font-medium transition-colors"
          >
            å¾Œã§æ±ºã‚ã‚‹
          </button>
        </div>
        
        {/* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¡¨ç¤º */}
        <div className="px-6 pb-6">
          <div className="flex items-center justify-center gap-4 text-xs text-gray-500">
            <div className="flex items-center gap-1">
              <Shield className="h-4 w-4" />
              <span>SSLæš—å·åŒ–é€šä¿¡</span>
            </div>
            <div className="flex items-center gap-1">
              <CreditCard className="h-4 w-4" />
              <span>Powered by Stripe</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ãƒ•ãƒƒã‚¯
export const useUpgradeModal = () => {
  const [isOpen, setIsOpen] = useState(false);

  useEffect(() => {
    const handleShowModal = () => setIsOpen(true);
    window.addEventListener('show-upgrade-modal', handleShowModal);
    return () => window.removeEventListener('show-upgrade-modal', handleShowModal);
  }, []);

  return {
    isOpen,
    onClose: () => setIsOpen(false)
  };
};
```

### 4.4 èª²é‡‘è¨­å®šãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// components/BillingSettings.tsx
import React, { useState } from 'react';
import { Star, User, CreditCard, Loader2 } from 'lucide-react';
import { useSubscriptionStatus } from '@/hooks/useSubscriptionStatus';
import { useUsageStatus } from '@/hooks/useUsageStatus';
import { useUpgradeModal } from '@/components/UpgradeModal';
import { supabase } from '@/lib/supabase';
import { toast } from 'react-hot-toast';
import { formatDate } from '@/utils/usageLimit';

export const BillingSettings: React.FC = () => {
  const { subscription, loading: subLoading } = useSubscriptionStatus();
  const { usage, loading: usageLoading } = useUsageStatus();
  const { isOpen: showUpgradeModal, onClose: closeUpgradeModal } = useUpgradeModal();
  const [isManaging, setIsManaging] = useState(false);

  const handleManageSubscription = async () => {
    setIsManaging(true);
    
    try {
      // Stripe Customer Portalã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      const { data, error } = await supabase.functions.invoke(
        'create-portal-session',
        { 
          body: { 
            returnUrl: window.location.href 
          }
        }
      );
      
      if (error) throw error;
      
      if (data?.url) {
        window.location.href = data.url;
      } else {
        throw new Error('ãƒãƒ¼ã‚¿ãƒ«URLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Portal session creation failed:', error);
      toast.error('ãƒ—ãƒ©ãƒ³ç®¡ç†ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsManaging(false);
    }
  };

  if (subLoading || usageLoading) {
    return (
      <div className="bg-white rounded-lg shadow p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-4 bg-gray-200 rounded w-1/4"></div>
          <div className="h-16 bg-gray-200 rounded"></div>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg shadow">
      <div className="p-6 border-b border-gray-200">
        <h3 className="text-lg font-medium text-gray-900">
          ãƒ—ãƒ©ãƒ³ãƒ»ãŠæ”¯æ‰•ã„
        </h3>
      </div>
      
      <div className="p-6 space-y-6">
        {/* ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ */}
        <div>
          <label className="text-sm font-medium text-gray-700 block mb-2">
            ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³
          </label>
          <div className="p-4 bg-gray-50 rounded-lg">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                {subscription?.status === 'active' ? (
                  <>
                    <Star className="h-6 w-6 text-yellow-500 fill-current" />
                    <div>
                      <p className="font-medium text-gray-900">
                        ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³
                      </p>
                      <p className="text-sm text-gray-500">
                        Â¥2,980/æœˆï¼ˆç¨è¾¼ï¼‰
                      </p>
                    </div>
                  </>
                ) : (
                  <>
                    <User className="h-6 w-6 text-gray-400" />
                    <div>
                      <p className="font-medium text-gray-900">
                        ç„¡æ–™ãƒ—ãƒ©ãƒ³
                      </p>
                      <p className="text-sm text-gray-500">
                        æœˆ5å›ã¾ã§åˆ©ç”¨å¯èƒ½
                      </p>
                    </div>
                  </>
                )}
              </div>
              
              {subscription?.status === 'active' ? (
                <button
                  onClick={handleManageSubscription}
                  disabled={isManaging}
                  className="px-4 py-2 text-sm text-blue-600 hover:text-blue-700 font-medium disabled:opacity-50 flex items-center gap-2"
                >
                  {isManaging ? (
                    <>
                      <Loader2 className="h-4 w-4 animate-spin" />
                      <span>å‡¦ç†ä¸­...</span>
                    </>
                  ) : (
                    'ãƒ—ãƒ©ãƒ³ç®¡ç†'
                  )}
                </button>
              ) : (
                <button
                  onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
                  className="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium transition-colors"
                >
                  ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                </button>
              )}
            </div>
          </div>
        </div>
        
        {/* åˆ©ç”¨çŠ¶æ³ï¼ˆç„¡æ–™ãƒ—ãƒ©ãƒ³ã®ã¿ï¼‰ */}
        {!subscription?.status && usage && (
          <div>
            <label className="text-sm font-medium text-gray-700 block mb-2">
              ä»Šæœˆã®åˆ©ç”¨çŠ¶æ³
            </label>
            <div className="space-y-3">
              <div className="flex items-center justify-between">
                <span className="text-sm text-gray-600">
                  {usage.currentCount} / {usage.limit} å›ä½¿ç”¨
                </span>
                <span className="text-sm text-gray-500">
                  {Math.round((usage.currentCount / usage.limit) * 100)}%
                </span>
              </div>
              
              <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  className={`h-full transition-all duration-300 ${
                    usage.currentCount >= usage.limit ? 'bg-red-500' :
                    usage.currentCount >= usage.limit * 0.8 ? 'bg-yellow-500' :
                    'bg-blue-600'
                  }`}
                  style={{ width: `${Math.min((usage.currentCount / usage.limit) * 100, 100)}%` }}
                />
              </div>
              
              {usage.periodEndDate && (
                <p className="text-xs text-gray-500">
                  æ¬¡å›ãƒªã‚»ãƒƒãƒˆ: {formatDate(usage.periodEndDate)} ï¼ˆã‚ã¨{usage.daysLeft}æ—¥ï¼‰
                </p>
              )}
            </div>
          </div>
        )}
        
        {/* æ¬¡å›è«‹æ±‚æ—¥ï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã®ã¿ï¼‰ */}
        {subscription?.current_period_end && (
          <div>
            <label className="text-sm font-medium text-gray-700 block mb-1">
              æ¬¡å›è«‹æ±‚æ—¥
            </label>
            <p className="text-gray-900">
              {formatDate(subscription.current_period_end)}
            </p>
          </div>
        )}

        {/* ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä¿ƒé€²ï¼ˆç„¡æ–™ãƒ—ãƒ©ãƒ³ã‹ã¤ä½¿ç”¨é‡ãŒå¤šã„å ´åˆï¼‰ */}
        {!subscription?.status && usage && usage.currentCount >= 3 && (
          <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div className="flex items-start gap-3">
              <Star className="h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5" />
              <div className="flex-1">
                <p className="text-sm font-medium text-blue-800 mb-1">
                  ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã§ç„¡åˆ¶é™åˆ©ç”¨
                </p>
                <p className="text-xs text-blue-600 mb-3">
                  æœˆé¡2,980å††ã§å…¨æ©Ÿèƒ½ãŒä½¿ã„æ”¾é¡Œã«ãªã‚Šã¾ã™
                </p>
                <button
                  onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
                  className="px-3 py-1 bg-blue-600 text-white text-xs rounded-md hover:bg-blue-700 transition-colors"
                >
                  è©³ç´°ã‚’è¦‹ã‚‹
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};
```

## 5. ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ

### 5.1 ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ä½¿ç”¨çŠ¶æ³ãƒãƒ¼

```typescript
// components/MobileUsageBar.tsx
import React from 'react';
import { useUsageStatus } from '@/hooks/useUsageStatus';

export const MobileUsageBar: React.FC = () => {
  const { usage } = useUsageStatus();
  
  // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã¾ãŸã¯åˆ©ç”¨çŠ¶æ³ãŒãªã„å ´åˆã¯éè¡¨ç¤º
  if (!usage || usage.isSubscribed) return null;
  
  const remaining = usage.limit - usage.currentCount;
  const percentage = (usage.currentCount / usage.limit) * 100;

  return (
    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 md:hidden z-40 safe-area-inset-bottom">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-24 h-1.5 bg-gray-200 rounded-full overflow-hidden">
            <div 
              className={`h-full transition-all duration-300 ${
                percentage >= 100 ? 'bg-red-500' :
                percentage >= 80 ? 'bg-yellow-500' : 
                'bg-blue-600'
              }`}
              style={{ width: `${Math.min(percentage, 100)}%` }}
            />
          </div>
          <span className="text-xs text-gray-600">
            æ®‹ã‚Š{remaining}å›
          </span>
        </div>
        
        {remaining <= 2 && (
          <button 
            onClick={() => window.dispatchEvent(new CustomEvent('show-upgrade-modal'))}
            className="text-xs text-blue-600 font-medium px-2 py-1 rounded hover:bg-blue-50 transition-colors"
          >
            ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
          </button>
        )}
      </div>
    </div>
  );
};
```

### 5.2 ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«èª¿æ•´

```css
/* globals.css - ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
@media (max-width: 768px) {
  .upgrade-modal {
    margin: 1rem;
    max-height: calc(100vh - 2rem);
  }
  
  /* iOS Safari ã®å®‰å…¨é ˜åŸŸå¯¾å¿œ */
  .safe-area-inset-bottom {
    padding-bottom: env(safe-area-inset-bottom);
  }
  
  /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ */
  .mobile-button {
    min-height: 44px; /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„æœ€å°ã‚µã‚¤ã‚º */
  }
}
```

## 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

### 6.1 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥

```typescript
// utils/errorHandler.ts
import { toast } from 'react-hot-toast';

export class PaymentError extends Error {
  constructor(message: string, public code?: string) {
    super(message);
    this.name = 'PaymentError';
  }
}

export class UsageError extends Error {
  constructor(message: string, public code?: string) {
    super(message);
    this.name = 'UsageError';
  }
}

export const handleError = (error: unknown, context?: string) => {
  console.error(`Error in ${context}:`, error);
  
  if (error instanceof PaymentError) {
    switch (error.code) {
      case 'card_declined':
        toast.error('ã‚«ãƒ¼ãƒ‰ãŒæ‰¿èªã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ã‚«ãƒ¼ãƒ‰ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
        break;
      case 'insufficient_funds':
        toast.error('æ®‹é«˜ä¸è¶³ã§ã™ã€‚ãŠæ”¯æ‰•ã„æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        break;
      default:
        toast.error('æ±ºæ¸ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  } else if (error instanceof UsageError) {
    toast.error('åˆ©ç”¨çŠ¶æ³ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  } else if (error instanceof Error) {
    if (error.message.includes('network') || error.message.includes('fetch')) {
      toast.error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    } else {
      toast.error('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    }
  } else {
    toast.error('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
  }
};
```

### 6.2 ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ç®¡ç†

```typescript
// hooks/useAsyncOperation.ts
import { useState } from 'react';
import { handleError } from '@/utils/errorHandler';

export const useAsyncOperation = <T = any>() => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const execute = async (
    operation: () => Promise<T>,
    onSuccess?: (result: T) => void,
    onError?: (error: unknown) => void,
    context?: string
  ) => {
    setLoading(true);
    setError(null);
    
    try {
      const result = await operation();
      onSuccess?.(result);
      return result;
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      onError?.(err);
      handleError(err, context);
      throw err;
    } finally {
      setLoading(false);
    }
  };

  return { loading, error, execute };
};
```

### 6.3 ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

```typescript
// components/FeedbackMessages.tsx
import React from 'react';
import { CheckCircle, AlertCircle, XCircle, Info } from 'lucide-react';

type MessageType = 'success' | 'warning' | 'error' | 'info';

interface FeedbackMessageProps {
  type: MessageType;
  title: string;
  message?: string;
  onClose?: () => void;
}

export const FeedbackMessage: React.FC<FeedbackMessageProps> = ({
  type,
  title,
  message,
  onClose
}) => {
  const config = {
    success: {
      icon: CheckCircle,
      bgColor: 'bg-green-50',
      borderColor: 'border-green-200',
      iconColor: 'text-green-600',
      titleColor: 'text-green-800',
      messageColor: 'text-green-600'
    },
    warning: {
      icon: AlertCircle,
      bgColor: 'bg-yellow-50',
      borderColor: 'border-yellow-200',
      iconColor: 'text-yellow-600',
      titleColor: 'text-yellow-800',
      messageColor: 'text-yellow-600'
    },
    error: {
      icon: XCircle,
      bgColor: 'bg-red-50',
      borderColor: 'border-red-200',
      iconColor: 'text-red-600',
      titleColor: 'text-red-800',
      messageColor: 'text-red-600'
    },
    info: {
      icon: Info,
      bgColor: 'bg-blue-50',
      borderColor: 'border-blue-200',
      iconColor: 'text-blue-600',
      titleColor: 'text-blue-800',
      messageColor: 'text-blue-600'
    }
  };

  const { icon: Icon, ...styles } = config[type];

  return (
    <div className={`p-4 rounded-lg border ${styles.bgColor} ${styles.borderColor}`}>
      <div className="flex items-start gap-3">
        <Icon className={`h-5 w-5 ${styles.iconColor} flex-shrink-0 mt-0.5`} />
        <div className="flex-1">
          <p className={`text-sm font-medium ${styles.titleColor}`}>
            {title}
          </p>
          {message && (
            <p className={`text-xs mt-1 ${styles.messageColor}`}>
              {message}
            </p>
          )}
        </div>
        {onClose && (
          <button
            onClick={onClose}
            className={`p-1 hover:bg-white/50 rounded ${styles.iconColor}`}
          >
            <XCircle className="h-4 w-4" />
          </button>
        )}
      </div>
    </div>
  );
};
```

## 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 7.1 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æœ€é©åŒ–

```typescript
// React.memoã¨useMemoã®æ´»ç”¨ä¾‹
import React, { memo, useMemo, useCallback } from 'react';

export const UsageStatusBar = memo(() => {
  const { usage, loading } = useUsageStatus();

  // è¨ˆç®—ã®æœ€é©åŒ–
  const statusInfo = useMemo(() => {
    if (!usage) return null;
    
    const remaining = usage.limit - usage.currentCount;
    const percentage = (usage.currentCount / usage.limit) * 100;
    const isWarning = remaining <= 2 && remaining > 0;
    const isError = remaining <= 0;
    
    return { remaining, percentage, isWarning, isError };
  }, [usage]);

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æœ€é©åŒ–
  const handleUpgradeClick = useCallback(() => {
    window.dispatchEvent(new CustomEvent('show-upgrade-modal'));
  }, []);

  if (loading || !usage || !statusInfo) return <LoadingSkeleton />;

  // JSXã®è¿”å´...
});

// è¡¨ç¤ºåã®è¨­å®šï¼ˆãƒ‡ãƒãƒƒã‚°æ™‚ã«ä¾¿åˆ©ï¼‰
UsageStatusBar.displayName = 'UsageStatusBar';
```

### 7.2 ãƒ‡ãƒ¼ã‚¿ã®å®šæœŸæ›´æ–°

```typescript
// hooks/usePeriodicRefresh.ts
import { useEffect, useRef } from 'react';

export const usePeriodicRefresh = (
  callback: () => void,
  intervalMs: number = 5 * 60 * 1000, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†
  enabled: boolean = true
) => {
  const callbackRef = useRef(callback);
  const intervalRef = useRef<NodeJS.Timeout>();

  // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®æœ€æ–°ç‰ˆã‚’ä¿æŒ
  useEffect(() => {
    callbackRef.current = callback;
  });

  useEffect(() => {
    if (!enabled) {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
      return;
    }

    // åˆå›å®Ÿè¡Œ
    callbackRef.current();

    // å®šæœŸå®Ÿè¡Œã®è¨­å®š
    intervalRef.current = setInterval(() => {
      callbackRef.current();
    }, intervalMs);

    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
    };
  }, [intervalMs, enabled]);
};

// ä½¿ç”¨ä¾‹
export const useUsageStatus = () => {
  const { user } = useAuthContext();
  const [usage, setUsage] = useState<UsageStatus | null>(null);
  
  const loadUsageStatus = useCallback(async () => {
    if (user) {
      const status = await checkUsageLimit(user.id);
      setUsage(status);
    }
  }, [user]);

  // 5åˆ†ã”ã¨ã«ä½¿ç”¨çŠ¶æ³ã‚’æ›´æ–°ï¼ˆç„¡æ–™ãƒ—ãƒ©ãƒ³ã®ã¿ï¼‰
  usePeriodicRefresh(
    loadUsageStatus,
    5 * 60 * 1000,
    user && !usage?.isSubscribed // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã¯å®šæœŸæ›´æ–°ä¸è¦
  );

  return { usage, refetch: loadUsageStatus };
};
```

## 8. ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ

### 8.1 ARIAå±æ€§ã¨ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
// ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ã—ãŸãƒœã‚¿ãƒ³å®Ÿè£…
export const AccessibleUpgradeButton: React.FC = () => {
  const [isPressed, setIsPressed] = useState(false);

  return (
    <button
      onClick={handleUpgrade}
      onKeyDown={(e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          setIsPressed(true);
          handleUpgrade();
        }
      }}
      onKeyUp={() => setIsPressed(false)}
      aria-label="ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹"
      aria-describedby="upgrade-benefits"
      aria-pressed={isPressed}
      role="button"
      tabIndex={0}
      className="focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
    >
      ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
    </button>
  );
};

// ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ã®è¿½åŠ æƒ…å ±
const UpgradeDescription: React.FC = () => (
  <div id="upgrade-benefits" className="sr-only">
    ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã§ã¯æœˆé¡2980å††ã§å…¨æ©Ÿèƒ½ãŒç„¡åˆ¶é™ã§åˆ©ç”¨ã§ãã¾ã™ã€‚
    ç„¡æ–™ãƒ—ãƒ©ãƒ³ã¯æœˆ5å›ã¾ã§ã®åˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚
  </div>
);
```

### 8.2 ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†

```typescript
// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒˆãƒ©ãƒƒãƒ—
import { useEffect, useRef } from 'react';

export const useModalFocus = (isOpen: boolean) => {
  const modalRef = useRef<HTMLDivElement>(null);
  const previousFocusRef = useRef<HTMLElement | null>(null);

  useEffect(() => {
    if (isOpen) {
      // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¦ç´ ã‚’ä¿å­˜
      previousFocusRef.current = document.activeElement as HTMLElement;
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®æœ€åˆã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯èƒ½ãªè¦ç´ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      const focusableElements = modalRef.current?.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      
      if (focusableElements && focusableElements.length > 0) {
        (focusableElements[0] as HTMLElement).focus();
      }
    } else {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰å…ƒã®è¦ç´ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
      previousFocusRef.current?.focus();
    }
  }, [isOpen]);

  return modalRef;
};
```

## 9. ãƒ†ã‚¹ãƒˆå®Ÿè£…ä¾‹

### 9.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

```typescript
// __tests__/components/UsageStatusBar.test.tsx
import React from 'react';
import { render, screen } from '@testing-library/react';
import { UsageStatusBar } from '@/components/UsageStatusBar';
import { useUsageStatus } from '@/hooks/useUsageStatus';

// ãƒ¢ãƒƒã‚¯ã®è¨­å®š
jest.mock('@/hooks/useUsageStatus');
const mockUseUsageStatus = useUsageStatus as jest.MockedFunction<typeof useUsageStatus>;

describe('UsageStatusBar', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã®å ´åˆã€é©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹', () => {
    mockUseUsageStatus.mockReturnValue({
      usage: {
        canUse: true,
        currentCount: 0,
        limit: -1,
        isSubscribed: true,
        periodEndDate: null,
        daysLeft: -1
      },
      loading: false,
      error: null,
      refetch: jest.fn()
    });

    render(<UsageStatusBar />);
    
    expect(screen.getByText('ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³')).toBeInTheDocument();
    expect(screen.getByText('å…¨æ©Ÿèƒ½ãŒç„¡åˆ¶é™ã§ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™')).toBeInTheDocument();
  });

  it('ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§åˆ¶é™ã«é”ã—ã¦ã„ã‚‹å ´åˆã€ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã•ã‚Œã‚‹', () => {
    mockUseUsageStatus.mockReturnValue({
      usage: {
        canUse: false,
        currentCount: 5,
        limit: 5,
        isSubscribed: false,
        periodEndDate: new Date('2025-09-01'),
        daysLeft: 7
      },
      loading: false,
      error: null,
      refetch: jest.fn()
    });

    render(<UsageStatusBar />);
    
    expect(screen.getByText('ä»Šæœˆã®ç„¡æ–™åˆ©ç”¨æ ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸ')).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ç¶šã‘ã‚‹/ })).toBeInTheDocument();
  });
});
```

### 9.2 çµ±åˆãƒ†ã‚¹ãƒˆ

```typescript
// __tests__/integration/subscription-flow.test.tsx
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { SimulatorExecuteButton } from '@/components/SimulatorExecuteButton';
import { UpgradeModal } from '@/components/UpgradeModal';
import { checkUsageLimit, incrementUsage } from '@/utils/usageLimit';

// ãƒ¢ãƒƒã‚¯ã®è¨­å®š
jest.mock('@/utils/usageLimit');
const mockCheckUsageLimit = checkUsageLimit as jest.MockedFunction<typeof checkUsageLimit>;
const mockIncrementUsage = incrementUsage as jest.MockedFunction<typeof incrementUsage>;

describe('Subscription Flow Integration', () => {
  it('ç„¡æ–™ãƒ—ãƒ©ãƒ³åˆ¶é™åˆ°é”æ™‚ã®ãƒ•ãƒ­ãƒ¼', async () => {
    // åˆ¶é™åˆ°é”ã®çŠ¶æ…‹ã‚’æ¨¡æ“¬
    mockCheckUsageLimit.mockResolvedValue({
      canUse: false,
      currentCount: 5,
      limit: 5,
      isSubscribed: false,
      periodEndDate: new Date(),
      daysLeft: 7
    });

    const mockOnExecute = jest.fn();
    
    render(
      <>
        <SimulatorExecuteButton onExecute={mockOnExecute} />
        <UpgradeModal isOpen={true} onClose={() => {}} />
      </>
    );

    // å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    const executeButton = screen.getByRole('button', { name: /åˆ©ç”¨åˆ¶é™ã«åˆ°é”/ });
    fireEvent.click(executeButton);

    // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await waitFor(() => {
      expect(screen.getByText('ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰')).toBeInTheDocument();
    });

    // å®Ÿè¡Œé–¢æ•°ã¯å‘¼ã°ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
    expect(mockOnExecute).not.toHaveBeenCalled();
  });
});
```

## 10. æœ¬ç•ªç’°å¢ƒã¸ã®å±•é–‹

### 10.1 ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

```bash
# .env.production
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
VITE_STRIPE_PUBLISHABLE_KEY=pk_live_...
VITE_STRIPE_PRICE_ID=price_live_...
```

### 10.2 Buildæ™‚ã®æœ€é©åŒ–

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          stripe: ['@stripe/stripe-js'],
          supabase: ['@supabase/supabase-js']
        }
      }
    }
  }
});
```

### 10.3 ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå¾Œã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] Stripeæœ¬ç•ªç’°å¢ƒã§ã®æ±ºæ¸ˆãƒ†ã‚¹ãƒˆ
- [ ] ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆãƒ»æ›´æ–°ãƒ»è§£ç´„ã®å‹•ä½œç¢ºèª
- [ ] ä½¿ç”¨åˆ¶é™ã®æ­£å¸¸å‹•ä½œç¢ºèª
- [ ] ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã§ã®UIç¢ºèª
- [ ] ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç›£è¦–è¨­å®š

## 11. ã¾ã¨ã‚

ã“ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ã‚¬ã‚¤ãƒ‰ã§ã¯ã€ä»¥ä¸‹ã®è¦ç´ ã‚’åŒ…æ‹¬çš„ã«ã‚«ãƒãƒ¼ã—ã¾ã—ãŸï¼š

1. **çŠ¶æ…‹ç®¡ç†**: ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½¿ã£ãŸåŠ¹ç‡çš„ãªçŠ¶æ…‹ç®¡ç†
2. **UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: å†åˆ©ç”¨å¯èƒ½ã§ã‚¢ã‚¯ã‚»ã‚·ãƒ–ãƒ«ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ
3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼å‡¦ç†ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ãƒ¡ãƒ¢åŒ–ã¨æœ€é©åŒ–ã«ã‚ˆã‚‹é«˜é€ŸãªUI
5. **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**: WCAGæº–æ‹ ã®ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ã‚·ãƒ–ãªè¨­è¨ˆ
6. **ãƒ†ã‚¹ãƒˆ**: ä¿¡é ¼æ€§ã®é«˜ã„è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè£…
7. **ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ**: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã§ã‚¿ãƒƒãƒãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªUI

ã“ã‚Œã‚‰ã®å®Ÿè£…ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ä½¿ã„ã‚„ã™ãã€é–‹ç™ºè€…ã«ã¨ã£ã¦ä¿å®ˆã—ã‚„ã™ã„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒå®Ÿç¾ã§ãã¾ã™ã€‚

---

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: 
1. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ®µéšçš„å®Ÿè£…
2. ãƒ†ã‚¹ãƒˆã®è¿½åŠ ã¨å®Ÿè¡Œ
3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šã¨æœ€é©åŒ–
4. ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½
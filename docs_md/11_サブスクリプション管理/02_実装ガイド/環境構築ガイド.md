# 環境構築ガイド

## 概要

このガイドでは、サブスクリプション管理システム（Stripe決済・解約機能）の環境構築について説明します。ローカル開発環境から本番環境まで、段階的にセットアップを進めます。

## 必要なサービス・アカウント

- Supabase アカウント
- Stripe アカウント（テスト・本番両方）
- Google OAuth クライアント（任意）
- GitHub リポジトリ（CI/CD用）

## 環境別設定

### ローカル開発環境

#### 1. フロントエンド環境変数（.env.local）

プロジェクトルートに `.env.local` ファイルを作成：

```bash
# Supabase設定
VITE_SUPABASE_URL=https://[your-project-ref].supabase.co
VITE_SUPABASE_ANON_KEY=[your-anon-key]

# Stripe設定（テスト環境）
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_51Q6nvOP8K6BRPPRIiO3jBLDc5EibQ5S3nv8DF8bwxBhAoiKx2QdmMjGQaPhfYiKsBRLgQy6K5wTOTUFToCKXJLqj00QdBbGkQx
VITE_STRIPE_PRICE_ID=price_1Q6oC4P8K6BRPPRIWmwxDwHW

# Google OAuth設定（任意）
VITE_GOOGLE_CLIENT_ID=[your-google-client-id]
```

#### 2. 動作確認

```bash
# 依存関係をインストール
npm install

# 開発サーバー起動
npm run dev

# ブラウザでアクセス
# http://localhost:5173
```

### Supabase Edge Functions設定

#### 1. 必要な環境変数

Supabaseダッシュボードの **Edge Functions > Secrets** で設定：

| 環境変数名 | 説明 | 取得方法 |
|-----------|------|---------|
| `STRIPE_SECRET_KEY` | Stripe APIシークレットキー | Stripeダッシュボード > API keys |
| `STRIPE_WEBHOOK_SECRET` | Webhook署名シークレット | Stripeダッシュボード > Webhooks |
| `SUPABASE_URL` | SupabaseプロジェクトURL | 自動設定（通常変更不要） |
| `SUPABASE_SERVICE_ROLE_KEY` | サービスロールキー | 自動設定（通常変更不要） |

#### 2. Edge Functionsデプロイ

```bash
# Supabase CLIのインストール
npm install -g supabase

# ログイン
supabase login

# プロジェクトのリンク
supabase link --project-ref [your-project-ref]

# Edge Functionsのデプロイ
supabase functions deploy create-checkout-session
supabase functions deploy handle-stripe-webhook
supabase functions deploy cancel-subscription

# 環境変数の設定
supabase secrets set STRIPE_SECRET_KEY=sk_test_xxxxx
supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_xxxxx
```

### ステージング環境

#### 1. GitHub Repository Secrets

GitHub リポジトリの **Settings > Secrets and variables > Actions** で設定：

```bash
# 開発環境用
DEV_SUPABASE_URL=https://[dev-project-ref].supabase.co
DEV_SUPABASE_ANON_KEY=[dev-anon-key]
DEV_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx
DEV_STRIPE_PRICE_ID=price_xxxxx
DEV_GOOGLE_CLIENT_ID=[dev-google-client-id]

# ステージング環境用
STAGING_SUPABASE_URL=https://[staging-project-ref].supabase.co
STAGING_SUPABASE_ANON_KEY=[staging-anon-key]
STAGING_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx
STAGING_STRIPE_PRICE_ID=price_xxxxx
STAGING_GOOGLE_CLIENT_ID=[staging-google-client-id]
```

#### 2. Edge Functions設定

ステージング用Supabaseプロジェクトで：

```bash
# ステージング環境用Edge Functions
supabase secrets set STRIPE_SECRET_KEY=sk_test_xxxxx --project-ref [staging-ref]
supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_xxxxx --project-ref [staging-ref]
```

### 本番環境

#### 1. 本番用環境変数

```bash
# GitHub Secrets（本番環境用）
PROD_SUPABASE_URL=https://[prod-project-ref].supabase.co
PROD_SUPABASE_ANON_KEY=[prod-anon-key]
PROD_STRIPE_PUBLISHABLE_KEY=pk_live_xxxxx
PROD_STRIPE_PRICE_ID=price_xxxxx
PROD_GOOGLE_CLIENT_ID=[prod-google-client-id]
```

#### 2. Stripe本番設定

```bash
# 本番環境用Edge Functions
supabase secrets set STRIPE_SECRET_KEY=sk_live_xxxxx --project-ref [prod-ref]
supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_xxxxx --project-ref [prod-ref]
```

## 外部サービス設定

### Stripe設定

#### 1. APIキーの取得

1. [Stripe Dashboard](https://dashboard.stripe.com/) にアクセス
2. **開発者** → **APIキー** から取得
   - 公開可能キー: `pk_test_` で始まる（テスト環境）
   - シークレットキー: `sk_test_` で始まる（テスト環境）
   - 本番環境: `pk_live_` および `sk_live_` で始まる

#### 2. 商品と価格の作成

1. **商品** → **新規作成**
2. 商品名: "大家DX プレミアムプラン"
3. **価格を追加**:
   - 価格: ¥2,980
   - 請求間隔: 月次
   - 価格IDをコピー（`price_xxxxx`）

#### 3. Webhookエンドポイントの設定

1. **開発者** → **Webhooks** → **エンドポイントを追加**
2. URL: `https://[your-project-ref].supabase.co/functions/v1/handle-stripe-webhook`
3. 送信するイベント:
   - `checkout.session.completed`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`
4. 署名シークレットをコピー（`whsec_xxxxx`）

### Supabase設定

#### 1. プロジェクト設定

1. [Supabase Dashboard](https://app.supabase.com) にアクセス
2. **プロジェクト設定** → **API** から取得:
   - Project URL: `VITE_SUPABASE_URL`
   - anon public: `VITE_SUPABASE_ANON_KEY`
   - service_role: `SUPABASE_SERVICE_ROLE_KEY`（Edge Functions用）

#### 2. 認証設定

1. **Authentication** → **Providers**
2. Google OAuth有効化（任意）
3. リダイレクトURLの設定

#### 3. データベース設定

1. **Database** → **Tables** でRLSポリシー確認
2. **Database** → **Migrations** で最新のマイグレーション適用確認

## 環境設定チェックリスト

### ローカル開発環境
- [ ] `.env.local` ファイルの作成と設定
- [ ] 依存関係のインストール（`npm install`）
- [ ] 開発サーバーの起動確認（`npm run dev`）
- [ ] Stripe決済フローの動作確認

### Supabase設定
- [ ] Edge Functions の作成とデプロイ
- [ ] 環境変数（Secrets）の設定
- [ ] 認証プロバイダーの設定
- [ ] RLSポリシーの確認

### Stripe設定
- [ ] APIキーの取得と設定
- [ ] 商品・価格の作成
- [ ] Webhookエンドポイントの設定
- [ ] テスト決済の実行

### GitHub Actions / CI/CD
- [ ] Repository Secretsの設定
- [ ] デプロイワークフローの確認
- [ ] 環境別ビルドの動作確認

## 動作確認とテスト

### 1. ローカル環境での確認

```bash
# 環境変数設定後
npm run dev
```

#### テスト手順：
1. ブラウザでダッシュボードにアクセス
2. シミュレーターを5回実行
3. アップグレードモーダルが表示されることを確認
4. 「今すぐアップグレード」をクリック
5. Stripe Checkout画面に遷移することを確認

### 2. 決済テスト

#### テスト用カード番号：
- **成功**: `4242 4242 4242 4242`
- **失敗**: `4000 0000 0000 0002`
- **3Dセキュア**: `4000 0000 0000 3220`

#### カード情報：
- 有効期限: 任意の将来の日付
- CVC: 任意の3桁の数字
- 郵便番号: 任意の5桁の数字

### 3. 解約機能テスト

#### 簡易テスト（開発環境）：
1. `/premium-plan` ページへ移動
2. 「プランを解約」ボタンをクリック
3. 確認モーダルで「解約する」をクリック
4. 解約完了メッセージの表示確認

#### テスト用データ作成：
```sql
-- SQL Editorで実行（テスト用データ作成）
INSERT INTO subscriptions (
  user_id,
  stripe_customer_id,
  stripe_subscription_id,
  status,
  current_period_end,
  created_at,
  updated_at
) VALUES (
  auth.uid(), -- 現在ログイン中のユーザーID
  'cus_test_' || gen_random_uuid(),
  'sub_test_' || gen_random_uuid(),
  'active',
  NOW() + INTERVAL '30 days',
  NOW(),
  NOW()
);
```

## トラブルシューティング

### よくあるエラーと解決方法

#### 1. "Stripe is not defined"
- **原因**: Stripe.jsが読み込まれていない
- **解決**: `VITE_STRIPE_PUBLISHABLE_KEY`が正しく設定されているか確認

#### 2. "Invalid API Key provided"
- **原因**: APIキーが無効
- **解決**: Stripeダッシュボードから正しいキーをコピー

#### 3. "No such price"
- **原因**: 価格IDが存在しない
- **解決**: Stripeダッシュボードで価格を作成し、IDを更新

#### 4. Webhook署名の検証エラー
- **原因**: Webhook署名シークレットが不一致
- **解決**: Stripeダッシュボードから正しい署名をコピー

#### 5. 環境変数が読み込まれない

```bash
# フロントエンド環境変数確認
npm run build
# ビルド時に環境変数が埋め込まれているか確認

# Edge Functions環境変数確認
npx supabase functions logs cancel-subscription
# ログで環境変数の存在を確認
```

#### 6. CORS エラー

Edge Function内で確認：
```javascript
const corsHeaders = {
  'Access-Control-Allow-Origin': '*', // 本番では特定のドメインに制限
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
};
```

### デバッグ方法

#### Edge Functionログ確認：
1. Supabaseダッシュボード → **Edge Functions**
2. 対象の関数 → **Logs** タブ

#### ブラウザコンソール確認：
1. F12キーで開発者ツールを開く
2. **Console** タブでエラーメッセージを確認

#### Stripe接続デバッグ：
```javascript
// デバッグコード（本番では削除）
console.log('Stripe key exists:', !!Deno.env.get('STRIPE_SECRET_KEY'));
```

## セキュリティ注意事項

### 絶対に守るべきルール

❌ **してはいけないこと**：
- シークレットキー（`sk_`）をフロントエンドで使用する
- 環境変数をGitにコミットする
- 本番環境でテスト用キーを使用する

✅ **必須の対応**：
- `.env.local` を `.gitignore` に含める
- 本番環境では本番用のキーを使用する
- Webhook署名を必ず検証する
- APIキーの定期的なローテーション
- 不要な環境変数の削除

### 環境別セキュリティ設定

1. **開発環境**：テストキーのみ使用
2. **ステージング**：専用のテストキー使用
3. **本番環境**：本番キーのみ使用

## 本番環境への移行手順

1. **Stripe設定更新**：
   - Stripeダッシュボードで本番環境に切り替え
   - 本番用のAPIキーを取得
   - 本番用の商品・価格を作成

2. **環境変数更新**：
   - 全ての環境変数を本番用に更新
   - Webhookエンドポイントを本番URLに設定

3. **最終確認**：
   - 決済フロー全体のテスト
   - 解約機能のテスト
   - エラーハンドリングの確認

このガイドに従って設定を進めることで、開発から本番まで一貫したサブスクリプション管理システムを構築できます。
# 修正後の検証テスト計画書

## 🎯 検証の目的
Webhook修正後、決済からプレミアムプラン反映までの一連の流れが正常に動作することを確認する

## 📋 事前準備チェックリスト

### 1. 環境準備
- [ ] Stripeテストモード確認
- [ ] テスト用カード番号準備（4242 4242 4242 4242）
- [ ] Supabase Dashboard アクセス準備
- [ ] Stripe Dashboard アクセス準備
- [ ] ブラウザの開発者ツール準備

### 2. 修正適用確認
- [ ] handle-stripe-webhook/index.ts が修正済み
- [ ] constructEventAsync を使用している
- [ ] cryptoProvider が設定されている
- [ ] stripe_price_id がコメントアウトされている
- [ ] Edge Function がデプロイ済み

## 🧪 検証テスト手順

### Phase 1: ログ監視の準備（5分）

#### 1-1. Supabase Functions ログ監視
```bash
# ターミナル1: リアルタイムログ監視
supabase functions logs handle-stripe-webhook --tail

# または Supabase Dashboard で確認
# Functions → handle-stripe-webhook → Logs
```

#### 1-2. Stripe Webhook監視
```
1. Stripe Dashboard → Developers → Webhooks
2. エンドポイントをクリック
3. "Webhook attempts" タブを開く
```

#### 1-3. データベース監視
```sql
-- subscriptions テーブルを監視
SELECT * FROM subscriptions 
WHERE user_id = 'あなたのuser_id'
ORDER BY created_at DESC;

-- user_usage テーブルも確認
SELECT * FROM user_usage 
WHERE user_id = 'あなたのuser_id';
```

### Phase 2: 基本動作テスト（10分）

#### Test 1: 新規ユーザーの決済テスト
```
【手順】
1. 無料プランのユーザーでログイン
2. マイページで現在の状態を確認
   - 期待値: "無料プラン（0/5回）"
3. "アップグレード"ボタンをクリック
4. Stripeページでテストカード入力
   - カード番号: 4242 4242 4242 4242
   - 有効期限: 任意の未来日
   - CVC: 任意の3桁
5. 決済完了を確認

【確認ポイント】
□ Stripe Dashboard: payment_intent.succeeded イベント
□ Supabase Logs: "Processing webhook event: checkout.session.completed"
□ Supabase Logs: "Checkout completed for user: [user_id]"
□ Supabase Logs: "Subscription created/updated for user: [user_id]"
□ Database: subscriptions テーブルに新規レコード作成
□ Database: status = 'active'
□ Frontend: "プレミアムプラン（無制限）"表示
```

#### Test 2: Webhook署名検証の確認
```
【確認ポイント】
□ エラーなし: "Webhook signature verification failed" が出ない
□ エラーなし: "SubtleCryptoProvider cannot be used" が出ない
□ Stripe Dashboard: Response = 200 OK
```

### Phase 3: エラーケーステスト（15分）

#### Test 3: 重複決済のテスト
```
【手順】
1. 既にプレミアムプランのユーザーで再度決済
2. エラーが出ないことを確認

【確認ポイント】
□ duplicate key error が出ない（onConflict設定確認）
□ 既存のsubscriptionが更新される
```

#### Test 4: Webhook再送テスト
```
【手順】
1. Stripe Dashboard → Webhooks → Recent deliveries
2. 過去のイベントを選択
3. "Resend" ボタンをクリック

【確認ポイント】
□ 重複処理でエラーが出ない
□ データの整合性が保たれる
```

### Phase 4: UI/UX確認テスト（10分）

#### Test 5: リアルタイム反映テスト
```
【手順】
1. 決済完了後、マイページにリダイレクト
2. PaymentResult コンポーネントの動作確認

【確認ポイント】
□ "決済処理中..." 表示
□ 10秒以内に "プレミアムプラン" に切り替わる
□ エラーメッセージが出ない
```

#### Test 6: 使用制限解除の確認
```
【手順】
1. プレミアムプラン状態で機能を使用
2. 5回以上使用してみる

【確認ポイント】
□ 6回目以降も使用可能
□ カウンター表示が "∞" または非表示
□ 制限メッセージが出ない
```

## 📊 検証結果記録表

| テスト項目 | 結果 | 確認時刻 | 備考 |
|-----------|------|----------|------|
| Test 1: 新規決済 | ⬜ OK / ⬜ NG | | |
| Test 2: Webhook検証 | ⬜ OK / ⬜ NG | | |
| Test 3: 重複決済 | ⬜ OK / ⬜ NG | | |
| Test 4: Webhook再送 | ⬜ OK / ⬜ NG | | |
| Test 5: UI反映 | ⬜ OK / ⬜ NG | | |
| Test 6: 制限解除 | ⬜ OK / ⬜ NG | | |

## 🚨 トラブルシューティング

### もし失敗した場合の確認項目

#### 1. Webhook署名検証エラーの場合
```bash
# 環境変数確認
supabase secrets list

# STRIPE_WEBHOOK_SECRET が正しいか確認
# Stripe Dashboard の値と一致しているか
```

#### 2. データベースエラーの場合
```sql
-- テーブル構造確認
\d subscriptions

-- 必要なカラムがあるか確認
-- stripe_price_id がない場合は正常（コメントアウト済み）
```

#### 3. ログが出ない場合
```bash
# Edge Function の状態確認
supabase functions list

# 再デプロイ
supabase functions deploy handle-stripe-webhook
```

## 📈 パフォーマンス測定

### 応答時間の目安
- Webhook処理: < 3秒
- DB更新: < 1秒  
- UI反映: < 10秒（ポーリング含む）

### 監視すべきメトリクス
1. Webhook成功率（目標: 99.9%）
2. 平均応答時間（目標: < 2秒）
3. エラー率（目標: < 0.1%）

## ✅ 最終確認チェックリスト

### 本番環境デプロイ前
- [ ] dev環境ですべてのテスト合格
- [ ] エラーログがクリーン
- [ ] Webhook成功率100%
- [ ] UI/UXが期待通り

### 本番環境デプロイ後
- [ ] 本番Stripeモードで1件テスト決済
- [ ] ログ監視（最初の24時間）
- [ ] ユーザーからのフィードバック確認

## 📝 検証完了基準

以下がすべて満たされたら検証完了：
1. ✅ Webhook署名検証エラーが発生しない
2. ✅ 決済後、subscriptionsテーブルのstatusが'active'になる
3. ✅ UIで「プレミアムプラン」が表示される
4. ✅ 使用制限が解除される（無制限になる）
5. ✅ エラーログが出ない

## 🎯 期待される最終結果

```
ユーザー体験:
1. 決済ボタンクリック
2. Stripeで支払い
3. 自動的にマイページへ
4. 10秒以内にプレミアム表示
5. すぐに無制限で利用開始
```
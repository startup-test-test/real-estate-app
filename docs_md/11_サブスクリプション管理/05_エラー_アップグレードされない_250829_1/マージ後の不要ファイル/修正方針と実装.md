# Stripe Webhook エラー修正方針と実装

## 🔴 問題の要約

### 現在の症状
- Stripe決済は成功する
- しかし、アプリケーション上でプレミアムプランとして認識されない
- 「無料利用枠（月5回）を使い切りました」のメッセージが表示され続ける

### エラーの原因
1. **Webhook署名検証の失敗**（昨日の修正が原因）
   - `constructEvent`（同期版）を使用していた
   - Deno環境では`constructEventAsync`（非同期版）が必要

2. **データベーススキーマの不整合**
   - `stripe_price_id`カラムが存在しない

## ✅ 修正方針

### 1. Supabase公式仕様（2024-2025）に準拠

**公式実装の要点**:
- Stripe SDK: v14.0.0
- API Version: 2023-10-16 または 2024-11-20
- **重要**: `cryptoProvider`を明示的に作成する必要がある
- `constructEventAsync`に5つのパラメータを渡す

### 2. 修正手順

#### Step 1: Webhook Handlerの修正

現在の誤った実装:
```typescript
// ❌ エラーになる
event = stripe.webhooks.constructEvent(body, signature, webhookSecret)
```

修正後:
```typescript
// ✅ 正しい実装
const cryptoProvider = Stripe.createSubtleCryptoProvider()

event = await stripe.webhooks.constructEventAsync(
  body,
  signature,
  webhookSecret,
  undefined,
  cryptoProvider  // 重要
)
```

#### Step 2: データベース対応

**オプション1**: stripe_price_idカラムを追加
```sql
ALTER TABLE subscriptions 
ADD COLUMN IF NOT EXISTS stripe_price_id TEXT;
```

**オプション2**: コードから stripe_price_id の保存を削除（推奨）
```typescript
// stripe_price_id: subscription.items.data[0].price.id, // コメントアウト
```

### 3. テスト手順

1. **開発環境でのテスト**
   ```bash
   # ローカルでテスト
   supabase functions serve handle-stripe-webhook
   
   # Stripe CLIでWebhookをテスト
   stripe listen --forward-to http://localhost:54321/functions/v1/handle-stripe-webhook
   ```

2. **本番環境へのデプロイ**
   ```bash
   # Edge Functionをデプロイ
   supabase functions deploy handle-stripe-webhook
   ```

3. **動作確認**
   - Stripe Dashboard → Webhooks → イベントログを確認
   - Supabase Dashboard → Functions → Logsを確認
   - テスト決済を実行

## 📁 関連ファイル

- `index_fixed.ts` - 修正済みのWebhook Handler
- `webhook_error_analysis_report.md` - 詳細なエラー分析
- `エラー内容.md` - Supabaseのエラーログ

## 🎯 期待される結果

修正後:
1. Webhook署名検証が成功
2. サブスクリプション情報がデータベースに保存
3. ユーザーがプレミアムプランとして認識される
4. 使用状況が「無制限」と表示される
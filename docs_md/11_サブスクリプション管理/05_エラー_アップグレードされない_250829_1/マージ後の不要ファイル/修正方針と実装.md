# Stripe Webhook ã‚¨ãƒ©ãƒ¼ä¿®æ­£æ–¹é‡ã¨å®Ÿè£…

## ğŸ”´ å•é¡Œã®è¦ç´„

### ç¾åœ¨ã®ç—‡çŠ¶
- Stripeæ±ºæ¸ˆã¯æˆåŠŸã™ã‚‹
- ã—ã‹ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸Šã§ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã¨ã—ã¦èªè­˜ã•ã‚Œãªã„
- ã€Œç„¡æ–™åˆ©ç”¨æ ï¼ˆæœˆ5å›ï¼‰ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œç¶šã‘ã‚‹

### ã‚¨ãƒ©ãƒ¼ã®åŸå› 
1. **Webhookç½²åæ¤œè¨¼ã®å¤±æ•—**ï¼ˆæ˜¨æ—¥ã®ä¿®æ­£ãŒåŸå› ï¼‰
   - `constructEvent`ï¼ˆåŒæœŸç‰ˆï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ãŸ
   - Denoç’°å¢ƒã§ã¯`constructEventAsync`ï¼ˆéåŒæœŸç‰ˆï¼‰ãŒå¿…è¦

2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®ä¸æ•´åˆ**
   - `stripe_price_id`ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„

## âœ… ä¿®æ­£æ–¹é‡

### 1. Supabaseå…¬å¼ä»•æ§˜ï¼ˆ2024-2025ï¼‰ã«æº–æ‹ 

**å…¬å¼å®Ÿè£…ã®è¦ç‚¹**:
- Stripe SDK: v14.0.0
- API Version: 2023-10-16 ã¾ãŸã¯ 2024-11-20
- **é‡è¦**: `cryptoProvider`ã‚’æ˜ç¤ºçš„ã«ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- `constructEventAsync`ã«5ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã™

### 2. ä¿®æ­£æ‰‹é †

#### Step 1: Webhook Handlerã®ä¿®æ­£

ç¾åœ¨ã®èª¤ã£ãŸå®Ÿè£…:
```typescript
// âŒ ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
event = stripe.webhooks.constructEvent(body, signature, webhookSecret)
```

ä¿®æ­£å¾Œ:
```typescript
// âœ… æ­£ã—ã„å®Ÿè£…
const cryptoProvider = Stripe.createSubtleCryptoProvider()

event = await stripe.webhooks.constructEventAsync(
  body,
  signature,
  webhookSecret,
  undefined,
  cryptoProvider  // é‡è¦
)
```

#### Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¯¾å¿œ

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³1**: stripe_price_idã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
```sql
ALTER TABLE subscriptions 
ADD COLUMN IF NOT EXISTS stripe_price_id TEXT;
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³2**: ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ stripe_price_id ã®ä¿å­˜ã‚’å‰Šé™¤ï¼ˆæ¨å¥¨ï¼‰
```typescript
// stripe_price_id: subscription.items.data[0].price.id, // ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
```

### 3. ãƒ†ã‚¹ãƒˆæ‰‹é †

1. **é–‹ç™ºç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ**
   ```bash
   # ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆ
   supabase functions serve handle-stripe-webhook
   
   # Stripe CLIã§Webhookã‚’ãƒ†ã‚¹ãƒˆ
   stripe listen --forward-to http://localhost:54321/functions/v1/handle-stripe-webhook
   ```

2. **æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤**
   ```bash
   # Edge Functionã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
   supabase functions deploy handle-stripe-webhook
   ```

3. **å‹•ä½œç¢ºèª**
   - Stripe Dashboard â†’ Webhooks â†’ ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã‚’ç¢ºèª
   - Supabase Dashboard â†’ Functions â†’ Logsã‚’ç¢ºèª
   - ãƒ†ã‚¹ãƒˆæ±ºæ¸ˆã‚’å®Ÿè¡Œ

## ğŸ“ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `index_fixed.ts` - ä¿®æ­£æ¸ˆã¿ã®Webhook Handler
- `webhook_error_analysis_report.md` - è©³ç´°ãªã‚¨ãƒ©ãƒ¼åˆ†æ
- `ã‚¨ãƒ©ãƒ¼å†…å®¹.md` - Supabaseã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹çµæœ

ä¿®æ­£å¾Œ:
1. Webhookç½²åæ¤œè¨¼ãŒæˆåŠŸ
2. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹
4. ä½¿ç”¨çŠ¶æ³ãŒã€Œç„¡åˆ¶é™ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹
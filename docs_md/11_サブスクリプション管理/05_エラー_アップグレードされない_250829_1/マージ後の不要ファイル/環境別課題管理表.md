# 環境別課題管理表

最終更新: 2025年8月29日

## 📊 環境比較表

| 項目 | dev環境 | 本番環境 | 統一目標 |
|------|---------|----------|----------|
| **URL** | Supabase Dashboard | dev.ooya.tech | - |
| **Deno std** | @0.168.0 | @0.177.1 | @0.177.1 |
| **Stripe SDK** | v13.10.0 | v13.10.0 | v14.0.0 |
| **Stripe API Version** | 2023-10-16 | 2023-10-16 | 2023-10-16 |
| **Webhook検証方法** | constructEventAsync ✅ | constructEvent ❌ | constructEventAsync |
| **CryptoProvider** | なし ⚠️ | なし ❌ | あり（必須） |
| **stripe_price_id カラム** | あり？ | なし | 要確認 |
| **onConflict設定** | なし | user_id | user_id |

## 🔴 本番環境の課題（優先度：高）

| # | 課題 | 影響度 | 現状 | 対策 | 期限 |
|---|------|--------|------|------|------|
| 1 | **Webhook署名検証失敗** | 致命的 | すべての決済が無効 | constructEventAsync + cryptoProvider | 即座 |
| 2 | **stripe_price_id カラム欠落** | 高 | データ保存エラー | カラム追加 or コード修正 | 本日中 |
| 3 | **event loop error** | 低 | 警告のみ | Deno std更新で解決 | 次回更新 |

### 詳細な対応内容

#### 1. Webhook署名検証の修正
```typescript
// 現在（エラー）
event = stripe.webhooks.constructEvent(body, signature, webhookSecret)

// 修正後
const cryptoProvider = Stripe.createSubtleCryptoProvider()
event = await stripe.webhooks.constructEventAsync(
  body, signature, webhookSecret, undefined, cryptoProvider
)
```

#### 2. stripe_price_id対応
```sql
-- オプション1: カラム追加
ALTER TABLE subscriptions ADD COLUMN IF NOT EXISTS stripe_price_id TEXT;

-- オプション2: コードから削除（推奨）
// stripe_price_id: subscription.items.data[0].price.id, // コメントアウト
```

## 🟡 dev環境の課題（優先度：中）

| # | 課題 | 影響度 | 現状 | 対策 | 期限 |
|---|------|--------|------|------|------|
| 1 | **CryptoProvider未設定** | 中 | 将来的にエラーの可能性 | 追加実装 | 本日中 |
| 2 | **duplicate key error** | 低 | 重複決済時のみ | onConflict追加 | 本日中 |
| 3 | **Deno std古い** | 低 | 警告が出る | @0.177.1に更新 | 次回更新 |
| 4 | **Stripe SDK古い** | 低 | 機能制限 | v14.0.0に更新 | 次回更新 |

### 詳細な対応内容

#### 1. CryptoProvider追加
```typescript
const cryptoProvider = Stripe.createSubtleCryptoProvider()
```

#### 2. upsert修正
```typescript
.upsert({
  // データ
}, {
  onConflict: 'user_id'  // 追加
})
```

## 🟢 共通の改善点（優先度：低）

| # | 項目 | 現状 | 改善案 | 効果 |
|---|------|------|--------|------|
| 1 | **ログ出力** | 基本的なログのみ | 詳細なログ追加 | デバッグ効率向上 |
| 2 | **エラーハンドリング** | 単純なcatch | 詳細なエラー分類 | 問題特定が容易 |
| 3 | **リトライ機能** | なし | 失敗時の再試行 | 信頼性向上 |
| 4 | **テスト環境** | 手動テスト | 自動テスト追加 | 品質保証 |

## 📅 実装スケジュール

### 今すぐ（〜1時間以内）
- [ ] 本番環境のconstructEventAsync修正
- [ ] stripe_price_idの対応決定

### 本日中（〜8時間以内）
- [ ] dev環境のCryptoProvider追加
- [ ] 両環境のコード統一
- [ ] テスト決済での動作確認

### 今週中
- [ ] Deno stdバージョン統一
- [ ] Stripe SDKアップグレード
- [ ] データベーススキーマ整理

### 来週以降
- [ ] ログ機能の強化
- [ ] 自動テストの実装
- [ ] ドキュメント整備

## 🔍 動作確認チェックリスト

### 本番環境
- [ ] Webhook署名検証成功
- [ ] subscriptionsテーブルにデータ保存
- [ ] ユーザーがプレミアムプランとして認識
- [ ] 使用状況が「無制限」表示

### dev環境
- [ ] エラーログの減少
- [ ] 重複エラーの解消
- [ ] 安定した決済処理

## 📝 メモ

### 成功ログの例
```
Processing webhook event: checkout.session.completed
Checkout completed for user: [user_id]
Subscription created/updated for user: [user_id]
```

### 環境変数の確認
- `STRIPE_SECRET_KEY`
- `STRIPE_WEBHOOK_SECRET`
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`

### Stripe Dashboard確認項目
- Webhookエンドポイントの状態
- イベントログ（200 OK確認）
- 署名シークレットの一致

## 🚨 緊急連絡先

- Supabase Support: https://supabase.com/support
- Stripe Support: https://support.stripe.com/
- 開発チーム: [内部連絡先]
# 現状分析と修正方針

## 📊 現在の環境状況

### dev環境（開発環境）
- **コード状態**: `constructEventAsync`を使用（非同期版）✅
- **Deno std**: @0.168.0（古いバージョン）
- **Stripe SDK**: v13.10.0
- **動作状況**: 
  - Webhookイベントは処理されている
  - しかし`stripe_price_id`エラーは発生していない（カラムが存在？）
  - 一部成功しているケースあり

### 本番環境
- **コード状態**: `constructEvent`を使用（同期版）❌ 
- **Deno std**: @0.177.1（新しいバージョン）
- **動作状況**: Webhook署名検証で完全に失敗

## 🔍 エラーパターンの分析

### 1. event loop error（両環境で発生）
```
Error: Deno.core.runMicrotasks() is not supported in this environment
```
- **影響**: 軽微（処理は継続）
- **原因**: Deno stdのバージョン不整合

### 2. duplicate key error（dev環境のみ）
```
duplicate key value violates unique constraint "subscriptions_stripe_customer_id_key"
```
- **影響**: 新規ユーザーの重複作成時のみ
- **原因**: `upsert`の`onConflict`設定が不適切

### 3. Invalid Stripe API version（dev環境で1回）
```
Error: Invalid Stripe API version: 2025-01-27
```
- **影響**: 一時的なエラー
- **原因**: 間違ったAPIバージョンの指定

### 4. Webhook署名検証失敗（本番環境のみ）
```
SubtleCryptoProvider cannot be used in a synchronous context
```
- **影響**: 致命的（すべてのWebhookが失敗）
- **原因**: 同期版の使用

## 🎯 修正方針

### Phase 1: 緊急修正（本番環境の復旧）

1. **Webhook署名検証の修正**
   - `constructEventAsync`に戻す
   - `cryptoProvider`を追加

2. **stripe_price_idの対応**
   - 一時的にコメントアウト

### Phase 2: 環境統一化

1. **Denoバージョンの統一**
   ```typescript
   // 両環境で統一
   import { serve } from 'https://deno.land/std@0.177.1/http/server.ts'
   ```

2. **Stripe SDKの更新**
   ```typescript
   import Stripe from 'https://esm.sh/stripe@14.0.0?target=deno'
   ```

3. **upsert の修正**
   ```typescript
   .upsert({
     // データ
   }, {
     onConflict: 'user_id'  // user_idで重複判定
   })
   ```

## 📝 統一版コード（推奨）

```typescript
import { serve } from 'https://deno.land/std@0.177.1/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3'
import Stripe from 'https://esm.sh/stripe@14.0.0?target=deno'

const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY') || '', {
  apiVersion: '2023-10-16',
  httpClient: Stripe.createFetchHttpClient(),
})

// 重要: CryptoProviderを追加
const cryptoProvider = Stripe.createSubtleCryptoProvider()

// ... 中略 ...

// Webhook署名検証
event = await stripe.webhooks.constructEventAsync(
  body,
  signature,
  webhookSecret,
  undefined,
  cryptoProvider  // 5番目のパラメータ
)

// ... 中略 ...

// upsertの修正
.upsert({
  user_id: userId,
  stripe_subscription_id: subscription.id,
  stripe_customer_id: subscription.customer as string,
  // stripe_price_id: subscription.items.data[0].price.id, // 一時的に無効化
  status: 'active',
  // ...
}, {
  onConflict: 'user_id'  // user_idベースで重複チェック
})
```

## ✅ 期待される結果

1. **本番環境**: Webhook署名検証が成功し、決済が有効化される
2. **dev環境**: エラーが減少し、安定動作
3. **両環境**: 仕様が統一され、同じ動作を保証

## 🚀 実装手順

1. まず本番環境の`constructEventAsync`修正を優先
2. dev環境も同じコードに統一
3. テスト決済で動作確認
4. 必要に応じてデータベーススキーマを調整
# 即座の修正手順

## 🚀 今すぐ実行すべき修正

### 1. 現在のindex.tsをバックアップ
```bash
cd /workspaces/real-estate-app
cp supabase/functions/handle-stripe-webhook/index.ts \
   supabase/functions/handle-stripe-webhook/index_backup_20250829.ts
```

### 2. 修正版を適用

**オプションA: index_fixed.tsをコピー**
```bash
cp docs_md/11_サブスクリプション管理/05_エラー_アップグレードされない_250829_1/index_fixed.ts \
   supabase/functions/handle-stripe-webhook/index.ts
```

**オプションB: 最小限の修正（推奨）**

`supabase/functions/handle-stripe-webhook/index.ts`の以下の部分のみ修正:

#### Line 3: Stripeのインポートを更新
```typescript
// 変更前
import Stripe from 'https://esm.sh/stripe@13.10.0?target=deno'

// 変更後
import Stripe from 'https://esm.sh/stripe@14.0.0?target=deno'
```

#### Line 8の後に追加: CryptoProvider
```typescript
// Line 8の後に追加
const cryptoProvider = Stripe.createSubtleCryptoProvider()
```

#### Line 38-39: constructEventの修正
```typescript
// 変更前
event = stripe.webhooks.constructEvent(body, signature, webhookSecret)

// 変更後
event = await stripe.webhooks.constructEventAsync(
  body,
  signature,
  webhookSecret,
  undefined,
  cryptoProvider
)
```

#### Line 78: stripe_price_idをコメントアウト
```typescript
// 変更前
stripe_price_id: subscription.items.data[0].price.id,

// 変更後（コメントアウト）
// stripe_price_id: subscription.items.data[0].price.id,
```

### 3. デプロイ

#### 開発環境でテスト
```bash
# ローカルでテスト
supabase functions serve handle-stripe-webhook

# 別ターミナルで
stripe listen --forward-to http://localhost:54321/functions/v1/handle-stripe-webhook
```

#### 本番環境にデプロイ
```bash
supabase functions deploy handle-stripe-webhook
```

### 4. 動作確認

1. **Supabase Dashboard**
   - Functions → Logs → handle-stripe-webhook
   - エラーが解消されているか確認

2. **Stripe Dashboard**
   - Developers → Webhooks → イベントログ
   - 200 OKが返されているか確認

3. **テスト決済**
   - テストモードで決済を実行
   - プレミアムプランとして認識されるか確認

## ⚠️ 注意事項

- 修正後も`stripe_price_id`関連のエラーは出る可能性がありますが、他のフィールドは正常に保存されます
- 完全な解決にはデータベースマイグレーションが必要ですが、まずはWebhook署名検証の修正を優先してください

## 🔍 確認ポイント

修正後、以下のログメッセージが表示されることを確認:
- ✅ `Processing webhook event: checkout.session.completed`
- ✅ `Checkout completed for user: [user_id]`
- ✅ `Subscription created/updated for user: [user_id]`

エラーメッセージが消えることを確認:
- ❌ `Webhook signature verification failed`
- ❌ `SubtleCryptoProvider cannot be used in a synchronous context`
# アップグレード機能問題 調査レポート

## 発生日時
2025年8月28日 18:00 JST頃

## 問題の概要
Stripeでテスト決済を完了しても、アプリケーション上でプレミアムプランとして認識されない。
「無料利用枠（月5回）を使い切りました」のメッセージが表示され続ける。

## 発生環境
- **Codespaces環境**: 初期は環境特有の問題と推測
- **dev.ooya.tech**: 同じ問題が発生（本番環境でも再現）

## 調査結果

### 1. フロントエンド側の確認
#### 決済フローの流れ
1. ユーザーが「アップグレード」ボタンをクリック
2. Stripe Checkoutセッションが作成される
3. Stripeの決済ページで支払い完了
4. `/mypage?payment=success`にリダイレクト
5. `PaymentResult.tsx`で10秒間サブスクリプション状態を確認
6. `useUsageStatus`フックで使用状況を取得

#### 問題点
- `checkUsageLimit`関数が`subscriptions`テーブルから`status: 'active'`のレコードを見つけられない
- 結果として無料プラン扱いのまま

### 2. バックエンド側の確認

#### Webhook処理の流れ（`handle-stripe-webhook/index.ts`）
```typescript
// Line 55-91: checkout.session.completed イベント処理
case 'checkout.session.completed': {
  const session = event.data.object as Stripe.Checkout.Session
  const userId = session.metadata?.user_id  // ← ここで user_id を取得
  
  if (!userId) {
    console.error('User ID not found in session metadata')
    break  // ← user_id がない場合は処理を中断
  }
  
  // サブスクリプション情報をSupabaseに保存
  const { error: insertError } = await supabase
    .from('subscriptions')
    .upsert({
      user_id: userId,
      status: 'active',
      // ... その他のフィールド
    })
}
```

#### Checkoutセッション作成（`create-checkout-session/index.ts`）
```typescript
// Line 111-118: metadata の設定
const session = await stripe.checkout.sessions.create({
  metadata: {
    user_id: userId,  // ← 正しく設定されている
  },
  subscription_data: {
    metadata: {
      user_id: userId,  // ← こちらも設定済み
    },
  },
})
```

### 3. 環境による違い

#### Codespaces環境の制約
- **動的URL**: 再起動のたびにURLが変わる
- **外部アクセス制限**: StripeからのWebhookが届かない可能性
- **結論**: 開発環境での制約として理解

#### dev.ooya.tech環境
- **固定URL**: Webhookエンドポイントが安定
- **問題**: それでも同じエラーが発生
- **結論**: Webhook処理自体に問題がある可能性

## 確認が必要な項目

### 1. Stripe Dashboard での確認
**場所**: Developers → Webhooks

- [ ] Webhookエンドポイントが正しく設定されているか
  - URL: `https://[your-supabase-url]/functions/v1/handle-stripe-webhook`
- [ ] `checkout.session.completed`イベントが送信されているか
- [ ] レスポンスステータスコード（200 OK or エラー）
- [ ] エラーメッセージの内容

### 2. Supabase Dashboard での確認
**場所**: Functions → Logs

確認すべきログメッセージ：
- [ ] `Processing webhook event: checkout.session.completed`
- [ ] `User ID not found in session metadata`（エラー）
- [ ] `Checkout completed for user: [userId]`
- [ ] `Subscription created/updated for user: [userId]`
- [ ] その他のエラーメッセージ

### 3. Supabase Database での確認
**場所**: Table Editor → subscriptions

- [ ] テスト決済後にレコードが作成されているか
- [ ] `status`フィールドが`'active'`になっているか
- [ ] `user_id`が正しく設定されているか
- [ ] `stripe_subscription_id`が存在するか

## 考えられる原因と対処法

### 原因1: Webhook署名の検証失敗
**症状**: `Webhook signature verification failed`エラー
**対処法**: 
- Stripe DashboardのWebhook署名シークレットを確認
- Supabaseの環境変数`STRIPE_WEBHOOK_SECRET`を更新

### 原因2: user_idがmetadataに含まれていない
**症状**: `User ID not found in session metadata`エラー
**対処法**:
- フロントエンドのCheckoutセッション作成時のパラメータを確認
- `userId`が正しく渡されているか確認

### 原因3: Supabaseのテーブル権限問題
**症状**: subscriptionsテーブルへの書き込み失敗
**対処法**:
- Service Roleキーが正しく設定されているか確認
- RLSポリシーの確認

### 原因4: Stripeのサブスクリプション取得エラー
**症状**: Line 67-69でサブスクリプション情報が取得できない
**対処法**:
- `session.subscription`がnullでないか確認
- Stripe APIキーの権限確認

## 一時的な回避策

### 開発環境での対処
1. Supabase SQLエディタで直接サブスクリプションを有効化：
```sql
INSERT INTO subscriptions (
  user_id, 
  status,
  stripe_subscription_id,
  stripe_customer_id,
  created_at,
  updated_at
) VALUES (
  'your-user-id',
  'active',
  'sub_test_' || gen_random_uuid(),
  'cus_test_' || gen_random_uuid(),
  NOW(),
  NOW()
)
ON CONFLICT (user_id) 
DO UPDATE SET 
  status = 'active',
  updated_at = NOW();
```

### 本番環境での緊急対応
1. Supabase Edge Functionのログを確認
2. エラーメッセージに基づいて対処
3. 必要に応じてWebhook処理を手動実行

## 次のアクション

1. **即座に確認**
   - Stripe Webhookのイベントログ
   - Supabase Edge Functionのログ
   - subscriptionsテーブルの内容

2. **ログに基づいた対処**
   - エラーメッセージに応じた修正
   - 環境変数の確認・更新

3. **テスト**
   - 修正後に再度テスト決済を実行
   - ログを監視しながら動作確認

## 関連ファイル
- `/supabase/functions/handle-stripe-webhook/index.ts` - Webhook処理
- `/supabase/functions/create-checkout-session/index.ts` - Checkout作成
- `/bolt_front/src/utils/usageLimit.ts` - 使用制限チェック
- `/bolt_front/src/pages/PaymentResult.tsx` - 決済結果処理

## 更新履歴
- 2025-08-28 19:00 - 初版作成
# Stripe Webhook エラー対応 統合マスタードキュメント
最終更新: 2025年8月29日

## 📌 エグゼクティブサマリー

### 問題の概要
- **症状**: Stripe決済は成功するが、プレミアムプランとして認識されない
- **原因**: Webhook署名検証の失敗（constructEvent使用によるエラー）
- **影響**: すべての有料ユーザーが無料プラン扱いのまま

### 解決方法
1. `constructEventAsync` + `cryptoProvider`を使用する
2. `stripe_price_id`をコメントアウト
3. 環境を統一化する

---

## 🔴 Part 1: 即座に実行すべき修正

### 1.1 コード修正箇所

**ファイル**: `supabase/functions/handle-stripe-webhook/index.ts`

#### 修正1: Stripeインポート更新（Line 3）
```typescript
// 変更前
import Stripe from 'https://esm.sh/stripe@13.10.0?target=deno'

// 変更後
import Stripe from 'https://esm.sh/stripe@14.0.0?target=deno'
```

#### 修正2: CryptoProvider追加（Line 8の後）
```typescript
const cryptoProvider = Stripe.createSubtleCryptoProvider()
```

#### 修正3: Webhook検証修正（Line 38-39）
```typescript
// 変更前
event = stripe.webhooks.constructEvent(body, signature, webhookSecret)

// 変更後
event = await stripe.webhooks.constructEventAsync(
  body, signature, webhookSecret, undefined, cryptoProvider
)
```

#### 修正4: stripe_price_id削除（Line 78）
```typescript
// stripe_price_id: subscription.items.data[0].price.id, // コメントアウト
```

### 1.2 デプロイコマンド
```bash
# バックアップ
cp supabase/functions/handle-stripe-webhook/index.ts \
   supabase/functions/handle-stripe-webhook/index_backup_$(date +%Y%m%d).ts

# デプロイ
supabase functions deploy handle-stripe-webhook
```

---

## 📊 Part 2: 環境別の現状と課題

### 2.1 環境比較表

| 項目 | dev環境 | 本番環境 | 修正後目標 |
|------|---------|----------|------------|
| Webhook検証 | constructEventAsync ✅ | constructEvent ❌ | constructEventAsync |
| CryptoProvider | なし ⚠️ | なし ❌ | あり |
| stripe_price_id | エラーなし | エラーあり | コメントアウト |
| 動作状況 | 部分的成功 | 完全失敗 | 完全成功 |

### 2.2 エラー優先度

| 優先度 | エラー | 環境 | 対応 |
|--------|--------|------|------|
| 🔴高 | Webhook署名検証失敗 | 本番 | 即座に修正 |
| 🟡中 | stripe_price_id欠落 | 本番 | コメントアウト |
| 🟢低 | event loop error | 両方 | 次回更新時 |

---

## 🎯 Part 3: システム仕様とあるべき姿

### 3.1 決済フロー（正常時）

```
1. ユーザー：アップグレードボタンクリック
   ↓
2. システム：Stripe Checkoutセッション作成
   ↓
3. ユーザー：カード情報入力（4242 4242 4242 4242）
   ↓
4. Stripe：Webhook送信
   ↓
5. Edge Function：
   - constructEventAsync で検証 ✅
   - subscriptions テーブル更新 ✅
   - status = 'active' 設定 ✅
   ↓
6. Frontend：プレミアムプラン表示 ✅
```

### 3.2 データベース状態変化

#### 無料ユーザー
```
subscriptions: レコードなし
user_usage: usage_count = 3/5
表示: "無料プラン（3/5回）"
```

#### 有料ユーザー（決済後）
```
subscriptions: status = 'active'
user_usage: 参照されない
表示: "プレミアムプラン（無制限）"
```

### 3.3 使用制限ロジック

```
checkUsageLimit()
├─ subscriptions.status == 'active'?
│  ├─ YES → 無制限（return true）
│  └─ NO → user_usage確認
│          ├─ usage_count < 5 → 利用可能
│          └─ usage_count >= 5 → 制限到達
```

---

## 🧪 Part 4: 検証テスト手順

### 4.1 事前準備
- [ ] Stripeテストモード確認
- [ ] Supabase/Stripe Dashboardアクセス
- [ ] 修正コードのデプロイ完了

### 4.2 必須テスト項目

#### Test 1: 基本決済フロー（10分）
```bash
# ログ監視開始
supabase functions logs handle-stripe-webhook --tail
```

1. 無料ユーザーでログイン
2. アップグレードボタンクリック
3. テストカード入力: 4242 4242 4242 4242
4. 決済完了確認

**確認項目**:
- [ ] Webhook: 200 OK
- [ ] ログ: "Subscription created/updated"
- [ ] DB: status = 'active'
- [ ] UI: "プレミアムプラン"表示

#### Test 2: エラーケース（5分）
1. Webhook再送テスト
2. 重複決済テスト

**確認項目**:
- [ ] エラーログなし
- [ ] データ整合性維持

### 4.3 成功基準
✅ Webhook署名検証成功
✅ DB更新完了
✅ UI自動更新（10秒以内）
✅ 無制限利用可能

---

## 📝 Part 5: アクションアイテム

### 今すぐ（1時間以内）
1. [ ] 本番環境のコード修正
2. [ ] Edge Functionデプロイ
3. [ ] テスト決済実行
4. [ ] ログ確認

### 本日中
1. [ ] dev環境も同じコードに統一
2. [ ] 全テスト項目実施
3. [ ] ドキュメント更新

### 今週中
1. [ ] Denoバージョン統一（@0.177.1）
2. [ ] Stripe SDK更新（v14.0.0）
3. [ ] 自動テスト実装

---

## 🚨 Part 6: トラブルシューティング

### よくあるエラーと対処法

| エラーメッセージ | 原因 | 対処法 |
|-----------------|------|--------|
| Webhook signature verification failed | 同期版使用 | constructEventAsync使用 |
| SubtleCryptoProvider cannot be used | cryptoProvider未設定 | cryptoProvider追加 |
| stripe_price_id column not found | カラム欠落 | コメントアウト |
| duplicate key error | onConflict未設定 | onConflict: 'user_id'追加 |

### 緊急時の連絡先
- Supabase Support: https://supabase.com/support
- Stripe Support: https://support.stripe.com/

---

## 📚 Part 7: 関連ファイル一覧

### コードファイル
- `/supabase/functions/handle-stripe-webhook/index.ts` - Webhook処理
- `/supabase/functions/create-checkout-session/index.ts` - Checkout作成
- `/bolt_front/src/utils/usageLimit.ts` - 使用制限チェック

### ドキュメント（このフォルダ内）
- `dev_handle-stript_code.md` - dev環境のコード
- `dev_handle-stripe-webhook_エラー内容.md` - dev環境のエラーログ
- `エラー内容.md` - 本番環境のエラーログ
- `index_fixed.ts` - 修正済みコード

---

## ✅ 最終チェックリスト

修正完了の確認:
- [ ] constructEventAsync使用
- [ ] cryptoProvider設定
- [ ] stripe_price_idコメントアウト
- [ ] デプロイ完了
- [ ] テスト決済成功
- [ ] プレミアムプラン表示
- [ ] 無制限利用可能

すべてチェックできたら対応完了です。🎉
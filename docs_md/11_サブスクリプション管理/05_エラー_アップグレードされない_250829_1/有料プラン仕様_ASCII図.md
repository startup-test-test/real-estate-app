# 有料プランアップグレード仕様（ASCII図解）

## 1. アップグレードフロー全体図

```ascii
┌─────────────────────────────────────────────────────────────────────────┐
│                        有料プランアップグレードフロー                        │
└─────────────────────────────────────────────────────────────────────────┘

【ユーザー側】                【システム側】                    【外部サービス】

   User                    Frontend                Backend              Stripe
    │                         │                      │                    │
    ├─[1]アップグレード────────>│                      │                    │
    │   ボタンクリック          │                      │                    │
    │                         ├─[2]セッション作成──────>│                    │
    │                         │   (user_id付き)       │                    │
    │                         │                      ├─[3]Checkout────────>│
    │                         │                      │   Session作成      │
    │                         │<─────[4]URL返却───────┤                    │
    │<────[5]Stripeページ──────┤                      │                    │
    │   へリダイレクト          │                      │                    │
    │                         │                      │                    │
    ├─[6]カード情報入力─────────────────────────────────────────────────────>│
    │                         │                      │                    │
    │<─[7]決済完了─────────────────────────────────────────────────────────┤
    │  (/mypage?payment=       │                      │                    │
    │   success)               │                      │                    │
    │                         │                      │<──[8]Webhook───────┤
    │                         │                      │  (checkout.session │
    │                         │                      │   .completed)      │
    │                         │                      │                    │
    │                         │                      ├─[9]DB更新          │
    │                         │                      │  subscriptions     │
    │                         │                      │  テーブル          │
    │                         │<────[10]状態確認──────┤                    │
    ├─[11]プレミアム表示───────>│   (ポーリング)       │                    │
    │                         │                      │                    │
```

## 2. データベーステーブルの変化

### 【初期状態】無料ユーザー

```ascii
┌─────────────────────────────────────────────────────────────────┐
│ subscriptions テーブル                                           │
├─────────────────────────────────────────────────────────────────┤
│ user_id | status | stripe_subscription_id | stripe_customer_id │
├─────────────────────────────────────────────────────────────────┤
│  (なし)  |   -    |           -            |         -          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ user_usage テーブル                                              │
├─────────────────────────────────────────────────────────────────┤
│ user_id | usage_count | period_end_date                          │
├─────────────────────────────────────────────────────────────────┤
│ user123 |     3       | 2025-09-15      (月5回制限)             │
└─────────────────────────────────────────────────────────────────┘
```

### 【決済直後】Webhookが正常に処理された場合

```ascii
┌─────────────────────────────────────────────────────────────────┐
│ subscriptions テーブル                                           │
├─────────────────────────────────────────────────────────────────┤
│ user_id | status  | stripe_subscription_id | stripe_customer_id │
├─────────────────────────────────────────────────────────────────┤
│ user123 | active  | sub_1S12xxxx          | cus_Sxxxx          │
└─────────────────────────────────────────────────────────────────┘
        ↑
    【重要】statusが'active'になる

┌─────────────────────────────────────────────────────────────────┐
│ user_usage テーブル                                              │
├─────────────────────────────────────────────────────────────────┤
│ user_id | usage_count | period_end_date                          │
├─────────────────────────────────────────────────────────────────┤
│ user123 |     3       | 2025-09-15      (カウントは継続)        │
└─────────────────────────────────────────────────────────────────┘
        ↑
    【注意】usage_countはリセットされない（別処理）
```

## 3. 使用制限チェックロジック

```ascii
┌──────────────────────────────────────────────────────────────┐
│              checkUsageLimit 関数の処理フロー                  │
└──────────────────────────────────────────────────────────────┘

                    [START]
                       │
                       ▼
              ┌─────────────────┐
              │ ユーザーIDで      │
              │ subscriptions    │
              │ テーブル検索      │
              └─────────────────┘
                       │
                       ▼
                  ◆─────────◆
                 ／           ＼
               ／  status =     ＼      YES
             ／    'active'?      ＼─────────┐
             ＼                   ／          │
               ＼               ／            ▼
                 ◆───────────◆        ┌──────────────┐
                       │NO             │ プレミアム     │
                       ▼               │ ユーザー      │
              ┌─────────────────┐      │              │
              │ user_usage       │      │ 制限: 無制限  │
              │ テーブル確認      │      │ 表示: ∞      │
              └─────────────────┘      └──────────────┘
                       │                      │
                       ▼                      │
                  ◆─────────◆                 │
                 ／           ＼               │
               ／  usage_count  ＼             │
             ／      >= 5?       ＼            │
             ＼                   ／            │
               ＼               ／              │
                 ◆───────────◆                │
                   YES│  │NO                   │
                      ▼  ▼                    ▼
              ┌────────┐ ┌────────┐      ┌─────────┐
              │ 制限到達│ │利用可能 │      │ SUCCESS │
              │ false  │ │ true   │      │  true   │
              └────────┘ └────────┘      └─────────┘
```

## 4. あるべき姿（理想の状態）

```ascii
┌──────────────────────────────────────────────────────────────┐
│                    理想的なシステム構成                         │
└──────────────────────────────────────────────────────────────┘

【決済成功後の即座の反映】
    Stripe決済
        ↓ (1秒以内)
    Webhook受信
        ↓ (即座)
    DB更新（status='active'）
        ↓ (即座)
    フロントエンド更新
        ↓
    「プレミアムプラン」表示

【データベース状態の整合性】
┌────────────────────────────────────────────────────────┐
│ ✅ subscriptions: 決済情報と完全同期                    │
│ ✅ user_usage: プレミアムユーザーは参照しない           │
│ ✅ usage_history: 全ユーザーの利用履歴を保存           │
└────────────────────────────────────────────────────────┘

【使用制限の明確な分離】
┌─────────────────────┬──────────────────────────────┐
│    無料ユーザー       │      プレミアムユーザー         │
├─────────────────────┼──────────────────────────────┤
│ • 月5回制限          │ • 無制限                      │
│ • カウンター表示      │ • "∞"表示                    │
│ • 期限表示あり        │ • 期限表示なし                │
│ • アップグレード促進   │ • 解約オプション表示           │
└─────────────────────┴──────────────────────────────┘

【エラーハンドリング】
┌────────────────────────────────────────────────────────┐
│ Webhook失敗時:                                         │
│   → リトライ機能（3回まで）                             │
│   → 失敗ログをSlack通知                               │
│   → 手動復旧用の管理画面                              │
│                                                       │
│ DB不整合時:                                           │
│   → 定期的な整合性チェック（1時間ごと）                 │
│   → Stripe APIと照合                                  │
│   → 自動修復機能                                      │
└────────────────────────────────────────────────────────┘
```

## 5. 現在の問題点と理想のギャップ

```ascii
┌──────────────────────────────────────────────────────────────┐
│                    現状 vs 理想                              │
└──────────────────────────────────────────────────────────────┘

【Webhook処理】
現状: constructEvent (同期) → エラー ❌
理想: constructEventAsync + cryptoProvider → 成功 ✅

【データベース】
現状: stripe_price_id カラムなし → エラー ❌
理想: 必要なカラムのみ保存 → 成功 ✅

【状態反映】
現状: Webhook失敗 → プレミアム未反映 ❌
理想: 即座に反映 → UI更新 ✅

【エラー処理】
現状: エラーログのみ → 手動対応必要 ❌
理想: 自動リトライ → 自己修復 ✅
```

## 6. 修正後の期待される動作

```ascii
User: "アップグレード"クリック
  ↓
System: Stripe Checkoutへリダイレクト
  ↓
User: カード情報入力・決済
  ↓
Stripe: Webhook送信
  ↓
Edge Function: 
  - constructEventAsync で検証 ✅
  - subscriptions テーブル更新 ✅
  - status = 'active' 設定 ✅
  ↓
Frontend:
  - checkUsageLimit()実行
  - status='active'を検出
  - "プレミアムプラン（無制限）"表示 ✅
  ↓
User: 無制限で機能利用可能 🎉
```
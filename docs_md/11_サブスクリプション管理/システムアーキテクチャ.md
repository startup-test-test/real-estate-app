# サブスクリプション管理システム統合アーキテクチャ

## 概要
大家DXの有料課金システムは、Stripe決済とSupabase Edge Functionsを組み合わせた堅牢なサブスクリプション管理システムです。本システムは使用制限管理、決済処理、解約・退会処理を統合的に管理し、二重決済防止とセキュリティを重視した設計となっています。

## 統合システム構成図

```mermaid
graph TB
    subgraph "フロントエンド層 (React)"
        subgraph "使用状況管理"
            UI[UsageStatusBar<br/>使用状況表示]
            Hook[useUsageStatus<br/>カスタムフック]
        end
        
        subgraph "プラン管理"
            PlanUI[PremiumPlan.tsx<br/>プラン選択・管理画面]
            Modal[UpgradeModal.tsx<br/>アップグレードモーダル]
            SubHook[useSubscription Hook<br/>サブスクリプション状態管理]
        end
    end

    subgraph "Supabase Platform"
        subgraph "認証・セキュリティ"
            Auth[Authentication<br/>JWT認証システム]
            RLS[Row Level Security<br/>行レベルセキュリティ]
        end
        
        subgraph "Edge Functions (Deno Runtime)"
            EF1[create-checkout-session<br/>決済セッション作成]
            EF2[handle-stripe-webhook<br/>Webhook処理]
            EF3[cancel-subscription<br/>解約処理]
            EF4[resume-subscription<br/>解約取消]
            EF5[smart-service<br/>統合サービス]
        end
        
        subgraph "データベース (PostgreSQL)"
            subgraph "ユーザー関連"
                Users[(users<br/>ユーザー情報)]
                Usage[(user_usage<br/>使用状況)]
                History[(usage_history<br/>使用履歴)]
            end
            
            subgraph "サブスクリプション管理"
                Subs[(subscriptions<br/>サブスクリプション情報)]
                Constraints[UNIQUE制約<br/>重複防止システム]
            end
        end
    end

    subgraph "Stripe Platform"
        subgraph "決済処理"
            Checkout[Stripe Checkout<br/>決済画面]
            Customer[Customer Management<br/>顧客管理]
            Payment[Payment Methods<br/>支払い方法管理]
        end
        
        subgraph "サブスクリプション管理"
            StripeSub[Subscription API<br/>サブスクリプション管理]
            Invoice[Invoice Management<br/>請求書管理]
        end
        
        subgraph "イベント通知"
            Webhook[Webhook Events<br/>リアルタイム通知]
        end
    end

    %% フロントエンド接続
    UI --> Hook
    Modal --> Hook
    Hook --> Auth
    Hook --> Usage
    
    PlanUI --> SubHook
    Modal --> SubHook
    SubHook --> Auth
    SubHook --> Subs
    
    %% 決済フロー
    Modal --> EF1
    EF1 --> Checkout
    Checkout --> Customer
    Customer --> StripeSub
    
    %% サブスクリプション管理フロー
    PlanUI --> EF3
    PlanUI --> EF4
    EF3 --> StripeSub
    EF4 --> StripeSub
    
    %% Webhook処理
    Webhook --> EF2
    EF2 --> Subs
    EF2 --> Users
    
    %% 使用状況管理
    EF5 --> Usage
    EF5 --> History
    
    %% セキュリティ
    Auth --> RLS
    RLS --> Users
    RLS --> Usage
    RLS --> History
    RLS --> Subs
    
    %% データベース制約
    Subs --> Constraints
    
    %% Stripe連携
    StripeSub --> Invoice
    Invoice --> Webhook
```

## 詳細アーキテクチャ図

### 1. 使用制限管理フロー

```mermaid
graph TD
    subgraph "使用制限チェックシステム"
        Start([サービス利用開始]) --> AuthCheck{認証確認}
        AuthCheck -->|認証OK| SubCheck{サブスクリプション<br/>ステータス確認}
        AuthCheck -->|認証NG| LoginPrompt[ログイン画面]
        
        SubCheck -->|Active| Premium[無制限利用許可]
        SubCheck -->|Inactive/None| UsageCheck{使用回数確認}
        
        UsageCheck -->|< 5回| AllowUsage[利用許可<br/>カウンター更新]
        UsageCheck -->|>= 5回| ShowLimit[利用制限表示]
        
        ShowLimit --> UpgradePrompt[アップグレード促進]
        UpgradePrompt --> Modal[UpgradeModal表示]
        
        AllowUsage --> LogUsage[使用履歴記録]
        Premium --> LogUsage
        LogUsage --> End([処理完了])
    end
```

### 2. 決済処理詳細フロー

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Frontend as React App
    participant EdgeFunc as Edge Functions
    participant StripeAPI as Stripe API
    participant Database as Supabase DB
    participant Webhook as Stripe Webhook

    Note over User,Webhook: 新規サブスクリプション購入フロー
    
    User->>Frontend: 「今すぐアップグレード」クリック
    Frontend->>Frontend: 既存サブスクリプション確認
    Frontend->>EdgeFunc: POST /create-checkout-session
    
    Note over EdgeFunc: セキュリティ検証
    EdgeFunc->>Database: ユーザー認証・重複チェック
    Database-->>EdgeFunc: 認証結果・既存データ
    
    EdgeFunc->>StripeAPI: Create Checkout Session
    Note over StripeAPI: 決済セッション生成
    StripeAPI-->>EdgeFunc: Session URL + Session ID
    EdgeFunc-->>Frontend: Redirect URL
    
    Frontend->>User: Stripe決済画面へリダイレクト
    User->>StripeAPI: カード情報入力・決済実行
    StripeAPI->>User: 決済完了・アプリへリダイレクト
    
    Note over Webhook: 非同期Webhook処理
    StripeAPI->>Webhook: checkout.session.completed
    Webhook->>EdgeFunc: POST /handle-stripe-webhook
    
    EdgeFunc->>EdgeFunc: 署名検証
    EdgeFunc->>Database: サブスクリプション情報保存/更新
    EdgeFunc-->>Webhook: 200 OK
    
    Note over Frontend,Database: 状態同期
    Frontend->>Database: サブスクリプション状態確認
    Database-->>Frontend: プレミアムステータス
    Frontend->>User: 無制限利用可能通知
```

### 3. 解約・退会処理フロー

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Frontend as React App
    participant EdgeFunc as Edge Functions
    participant StripeAPI as Stripe API
    participant Database as Supabase DB

    Note over User,Database: 解約処理フロー
    
    User->>Frontend: 解約ボタンクリック
    Frontend->>Frontend: 解約確認ダイアログ
    User->>Frontend: 解約実行確認
    
    Frontend->>EdgeFunc: POST /cancel-subscription
    EdgeFunc->>Database: アクティブなサブスクリプション取得
    Database-->>EdgeFunc: サブスクリプション情報
    
    EdgeFunc->>StripeAPI: Update subscription (cancel_at_period_end: true)
    StripeAPI-->>EdgeFunc: 更新完了・期間終了日
    
    EdgeFunc->>Database: cancel_at_period_end = true 更新
    EdgeFunc-->>Frontend: 解約予定日返却
    
    Frontend->>User: 解約完了・期間終了日表示
    
    Note over User,Database: 解約取消フロー
    
    User->>Frontend: 解約取消ボタンクリック
    Frontend->>EdgeFunc: POST /resume-subscription
    
    EdgeFunc->>Database: 解約予定サブスクリプション取得
    Database-->>EdgeFunc: サブスクリプション情報
    
    EdgeFunc->>StripeAPI: Update subscription (cancel_at_period_end: false)
    StripeAPI-->>EdgeFunc: 取消完了
    
    EdgeFunc->>Database: cancel_at_period_end = false 更新
    EdgeFunc-->>Frontend: 取消完了通知
    
    Frontend->>User: 解約取消完了表示
```

## データベース設計詳細

### ER図（Entity Relationship Diagram）

```mermaid
erDiagram
    users ||--o{ user_usage : "has"
    users ||--o{ subscriptions : "has" 
    users ||--o{ usage_history : "has"
    
    users {
        uuid id PK "Primary Key"
        string email "ユーザーメールアドレス"
        string full_name "フルネーム"
        string avatar_url "アバター画像URL"
        timestamp created_at "作成日時"
        timestamp updated_at "更新日時"
    }
    
    user_usage {
        uuid id PK "Primary Key"
        uuid user_id FK "ユーザーID (外部キー)"
        int usage_count "月間使用回数"
        timestamp period_start_date "集計期間開始日"
        timestamp period_end_date "集計期間終了日"
        timestamp updated_at "最終更新日時"
        
        constraint "period_start < period_end"
        index "idx_user_period ON (user_id, period_start_date)"
    }
    
    subscriptions {
        uuid id PK "Primary Key"
        uuid user_id FK "ユーザーID (外部キー)"
        string status "サブスクリプション状態"
        string stripe_subscription_id "Stripe サブスクリプションID"
        string stripe_customer_id "Stripe 顧客ID"
        string stripe_price_id "Stripe 価格ID"
        timestamp current_period_start "現在の課金期間開始日"
        timestamp current_period_end "現在の課金期間終了日"
        boolean cancel_at_period_end "期間終了時解約フラグ"
        timestamp cancel_at "解約実行日時"
        timestamp canceled_at "解約完了日時"
        timestamp created_at "作成日時"
        timestamp updated_at "更新日時"
        
        constraint "UNIQUE INDEX idx_one_active_subscription_per_user ON (user_id) WHERE (status = 'active' AND cancel_at_period_end = false)"
    }
    
    usage_history {
        uuid id PK "Primary Key"
        uuid user_id FK "ユーザーID (外部キー)"
        string feature_type "使用機能タイプ"
        jsonb feature_data "機能利用データ (JSON)"
        string session_id "セッションID"
        timestamp created_at "利用日時"
        
        index "idx_user_feature_date ON (user_id, feature_type, created_at)"
        index "idx_created_at ON (created_at DESC)"
    }
```

### テーブル定義とセキュリティ

```sql
-- サブスクリプションテーブル作成
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    stripe_customer_id TEXT NOT NULL,
    stripe_subscription_id TEXT UNIQUE NOT NULL,
    stripe_price_id TEXT NOT NULL,
    status TEXT NOT NULL CHECK (status IN ('active', 'canceled', 'past_due', 'unpaid', 'trialing')),
    current_period_start TIMESTAMPTZ,
    current_period_end TIMESTAMPTZ,
    cancel_at_period_end BOOLEAN DEFAULT false,
    cancel_at TIMESTAMPTZ,
    canceled_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 重複防止のUNIQUE制約（アクティブなサブスクリプションは1ユーザー1つまで）
CREATE UNIQUE INDEX idx_one_active_subscription_per_user 
ON subscriptions(user_id) 
WHERE status = 'active' AND cancel_at_period_end = false;

-- Row Level Security (RLS) 設定
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;

-- ユーザーは自分のサブスクリプションのみアクセス可能
CREATE POLICY "Users can only access their own subscriptions" 
ON subscriptions FOR ALL 
USING (auth.uid() = user_id);

-- サービスロールは全アクセス可能（Edge Functions用）
CREATE POLICY "Service role can access all subscriptions" 
ON subscriptions FOR ALL 
USING (auth.role() = 'service_role');
```

## コンポーネント詳細仕様

### 1. フロントエンド層

#### UsageStatusBar.tsx
```typescript
interface UsageStatusBarProps {
  currentUsage: number;
  maxUsage: number;
  subscriptionStatus: 'active' | 'inactive' | null;
  onUpgradeClick: () => void;
}

// 主要機能:
// - リアルタイム使用状況表示
// - 使用制限アラート
// - プログレスバー表示
// - プレミアム状態表示
```

#### PremiumPlan.tsx
```typescript
interface PremiumPlanProps {
  subscription: Subscription | null;
  onPurchase: (priceId: string) => Promise<void>;
  onCancel: () => Promise<void>;
  onResume: () => Promise<void>;
}

// 主要機能:
// - 料金プラン表示（月額・年額）
// - サブスクリプション状態管理
// - 解約・解約取消操作
// - 残り日数・次回請求日表示
```

#### useSubscription Hook
```typescript
export interface UseSubscriptionReturn {
  subscription: Subscription | null;
  isLoading: boolean;
  error: Error | null;
  refetch: () => Promise<void>;
  hasActiveSubscription: boolean;
  cancelAtPeriodEnd: boolean;
  nextBillingDate: Date | null;
  daysRemaining: number | null;
}

// 機能:
// - リアルタイム状態監視
// - キャッシュ管理
// - エラーハンドリング
// - 自動再取得
```

### 2. Edge Functions層

#### create-checkout-session
```typescript
// 処理フロー:
// 1. JWT認証検証
// 2. 既存サブスクリプション重複チェック
// 3. Stripe顧客作成/取得
// 4. Checkout Session作成
// 5. メタデータ設定（user_id, price_id）
// 6. 成功/キャンセルURL設定

interface CreateCheckoutRequest {
  priceId: string;
  successUrl?: string;
  cancelUrl?: string;
}

interface CreateCheckoutResponse {
  url: string;
  sessionId: string;
}
```

#### handle-stripe-webhook
```typescript
// 処理イベント:
// - checkout.session.completed: 新規購入完了
// - customer.subscription.updated: サブスクリプション更新
// - customer.subscription.deleted: サブスクリプション削除  
// - invoice.payment_succeeded: 支払い成功
// - invoice.payment_failed: 支払い失敗

// セキュリティ:
// - Stripe署名検証必須
// - 重複処理防止（idempotency）
// - トランザクション処理
```

#### cancel-subscription
```typescript
// 処理フロー:
// 1. JWT認証検証
// 2. アクティブなサブスクリプション取得
// 3. Stripe API: 期間終了時解約設定
// 4. データベース更新
// 5. キャンセル日時・期間終了日返却

interface CancelSubscriptionResponse {
  success: boolean;
  cancelAtPeriodEnd: boolean;
  periodEndDate: string;
  message: string;
}
```

#### resume-subscription  
```typescript
// 処理フロー:
// 1. JWT認証検証
// 2. 解約予定サブスクリプション取得
// 3. Stripe API: 解約取消
// 4. データベース状態リセット
// 5. 継続確認返却

interface ResumeSubscriptionResponse {
  success: boolean;
  cancelAtPeriodEnd: boolean;
  nextBillingDate: string;
  message: string;
}
```

## セキュリティアーキテクチャ

### 多層防御システム

```mermaid
graph TB
    subgraph "セキュリティレイヤー構成"
        subgraph "Layer 1: フロントエンド"
            ClientAuth[クライアント認証<br/>JWT Token検証]
            InputValidation[入力値バリデーション<br/>XSS/SQLi対策]
            CSRF[CSRF保護<br/>Token検証]
        end
        
        subgraph "Layer 2: API Gateway"
            CORS[CORS設定<br/>オリジン制限]
            RateLimit[レート制限<br/>DoS攻撃防止]
            IPFilter[IP制限<br/>地域制限対応]
        end
        
        subgraph "Layer 3: Edge Functions"
            JWTVerify[JWT署名検証<br/>改ざん検出]
            AuthZ[認可チェック<br/>リソースアクセス制御]
            DataValidation[データ検証<br/>型・範囲チェック]
        end
        
        subgraph "Layer 4: Database"
            RLS[Row Level Security<br/>行レベル制御]
            Encryption[暗号化<br/>データ保護]
            Audit[監査ログ<br/>アクセス追跡]
        end
        
        subgraph "Layer 5: External API"
            WebhookSig[Webhook署名検証<br/>Stripe通信検証]
            APIKey[API Key管理<br/>秘匿情報保護]
            TLS[TLS/SSL通信<br/>通信路暗号化]
        end
    end
    
    ClientAuth --> CORS
    InputValidation --> RateLimit  
    CSRF --> IPFilter
    
    CORS --> JWTVerify
    RateLimit --> AuthZ
    IPFilter --> DataValidation
    
    JWTVerify --> RLS
    AuthZ --> Encryption
    DataValidation --> Audit
    
    RLS --> WebhookSig
    Encryption --> APIKey
    Audit --> TLS
```

### セキュリティ実装詳細

#### 1. 認証・認可
```typescript
// JWT認証実装
const verifyAuth = async (request: Request): Promise<User> => {
  const token = request.headers.get('Authorization')?.replace('Bearer ', '');
  if (!token) throw new Error('Authentication required');
  
  const { data: user, error } = await supabase.auth.getUser(token);
  if (error) throw new Error('Invalid token');
  
  return user;
};

// Row Level Security ポリシー
CREATE POLICY "subscription_access_policy" ON subscriptions
FOR ALL USING (
  auth.uid() = user_id OR 
  auth.role() = 'service_role'
);
```

#### 2. Webhook セキュリティ
```typescript
// Stripe Webhook 署名検証
const verifyStripeSignature = (
  payload: string,
  signature: string,
  secret: string
): boolean => {
  const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY')!);
  try {
    stripe.webhooks.constructEvent(payload, signature, secret);
    return true;
  } catch (error) {
    console.error('Webhook signature verification failed:', error);
    return false;
  }
};
```

#### 3. 二重決済防止システム
```mermaid
graph TD
    subgraph "二重決済防止アーキテクチャ"
        subgraph "検証レイヤー1: UI制御"
            A[ボタン無効化<br/>Loading状態]
            B[購入前確認<br/>モーダル表示]
            C[既存プラン表示<br/>状態可視化]
        end
        
        subgraph "検証レイヤー2: API検証"
            D[リクエスト時<br/>重複チェック]
            E[トランザクション<br/>排他制御]
            F[Stripe API<br/>Customer検証]
        end
        
        subgraph "検証レイヤー3: DB制約"
            G[UNIQUE制約<br/>構造的防止]
            H[ステータス検証<br/>論理的防止]
            I[定期チェック<br/>整合性確認]
        end
    end
    
    A --> D
    B --> E  
    C --> F
    
    D --> G
    E --> H
    F --> I
    
    style A fill:#e1f5fe
    style D fill:#fff3e0
    style G fill:#f3e5f5
```

## 監視・運用アーキテクチャ

### ログ管理システム

```mermaid
graph TB
    subgraph "ログ収集・分析システム"
        subgraph "ログ生成"
            FELog[フロントエンド<br/>Error Boundary]
            EFLog[Edge Functions<br/>構造化ログ]
            DBLog[Database<br/>Audit Log]
            StripeLog[Stripe<br/>Event Log]
        end
        
        subgraph "ログ集約"
            Collector[Supabase<br/>Log Collector]
            Aggregator[ログ集約<br/>分析処理]
        end
        
        subgraph "監視・アラート"
            Monitor[リアルタイム監視<br/>異常検知]
            Alert[アラート通知<br/>Slack/Email]
            Dashboard[ダッシュボード<br/>可視化]
        end
    end
    
    FELog --> Collector
    EFLog --> Collector  
    DBLog --> Collector
    StripeLog --> Collector
    
    Collector --> Aggregator
    Aggregator --> Monitor
    Monitor --> Alert
    Monitor --> Dashboard
```

### パフォーマンス監視

```typescript
// Edge Functions パフォーマンス計測
const performanceMonitor = {
  startTime: performance.now(),
  
  logExecutionTime: (functionName: string) => {
    const endTime = performance.now();
    const executionTime = endTime - this.startTime;
    
    console.log(`[PERFORMANCE] ${functionName}: ${executionTime}ms`);
    
    // 閾値チェック（3秒）
    if (executionTime > 3000) {
      console.warn(`[SLOW_EXECUTION] ${functionName}: ${executionTime}ms`);
    }
  }
};
```

### メトリクス定義

| メトリクス名 | 説明 | 正常値 | アラート条件 |
|-------------|------|--------|-------------|
| 決済成功率 | 決済完了/決済試行 | >95% | <90% |
| チャーン率 | 月次解約率 | <5% | >10% |
| API応答時間 | Edge Functions実行時間 | <2秒 | >3秒 |
| エラー率 | エラー/総リクエスト | <1% | >5% |
| Webhook遅延 | イベント受信〜処理完了 | <10秒 | >30秒 |
| DB接続率 | DB接続成功率 | >99% | <95% |

## デプロイメント・CI/CDアーキテクチャ

### デプロイメントパイプライン

```mermaid
graph TB
    subgraph "Development Environment"
        DevCode[開発コード<br/>feature/branch]
        DevTest[ローカルテスト<br/>Jest/Deno Test]
        DevDB[開発DB<br/>Test Data]
    end
    
    subgraph "CI/CD Pipeline"
        GitHubAction[GitHub Actions<br/>自動化ワークフロー]
        
        subgraph "テストステージ"
            UnitTest[単体テスト<br/>Edge Functions]
            IntegrationTest[統合テスト<br/>Stripe Test Mode]
            E2ETest[E2Eテスト<br/>Playwright]
        end
        
        subgraph "デプロイステージ"  
            BuildStage[ビルド<br/>TypeScript/React]
            EdgeDeploy[Edge Functions<br/>デプロイ]
            FrontDeploy[フロントエンド<br/>デプロイ]
        end
    end
    
    subgraph "Production Environment"
        ProdApp[本番アプリ<br/>Vercel/Netlify]
        ProdDB[本番DB<br/>Supabase Prod]
        ProdStripe[Stripe Live<br/>本番決済]
    end
    
    DevCode --> GitHubAction
    DevTest --> UnitTest
    DevDB -.-> IntegrationTest
    
    GitHubAction --> UnitTest
    UnitTest --> IntegrationTest  
    IntegrationTest --> E2ETest
    
    E2ETest --> BuildStage
    BuildStage --> EdgeDeploy
    BuildStage --> FrontDeploy
    
    EdgeDeploy --> ProdApp
    FrontDeploy --> ProdApp
    ProdApp --> ProdDB
    ProdApp --> ProdStripe
```

### GitHub Actions ワークフロー

```yaml
name: Deploy Subscription System
on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'supabase/functions/**'
      - 'package.json'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      # フロントエンドテスト
      - name: Run Frontend Tests
        run: |
          npm ci
          npm run test:coverage
          
      # Edge Functions テスト
      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x
          
      - name: Run Edge Function Tests
        run: |
          cd supabase/functions
          deno test --allow-all
          
  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      # Supabase Edge Functions デプロイ
      - uses: supabase/setup-cli@v1
        with:
          version: latest
          
      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase functions deploy create-checkout-session --project-ref $SUPABASE_PROJECT_ID
          supabase functions deploy handle-stripe-webhook --project-ref $SUPABASE_PROJECT_ID
          supabase functions deploy cancel-subscription --project-ref $SUPABASE_PROJECT_ID
          supabase functions deploy resume-subscription --project-ref $SUPABASE_PROJECT_ID
          
      # フロントエンドデプロイ
      - name: Deploy Frontend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          npx vercel --prod --token $VERCEL_TOKEN
```

## 拡張可能性・将来計画

### Phase 1（実装完了）
- ✅ 基本サブスクリプション機能
- ✅ 解約・解約取消機能
- ✅ 二重決済防止システム
- ✅ 使用制限管理
- ✅ セキュリティ実装

### Phase 2（計画中）
- [ ] 多段階プラン対応
- [ ] クーポン・割引機能
- [ ] 使用量ベース課金
- [ ] アナリティクス強化

### Phase 3（将来）
- [ ] 請求書発行システム
- [ ] 法人向け一括請求
- [ ] 国際決済対応
- [ ] 税務計算自動化

### 拡張アーキテクチャ

```mermaid
graph TB
    subgraph "現在のシステム"
        CurrentSub[Basic Subscription<br/>月額/年額プラン]
        CurrentUsage[使用制限管理<br/>5回/月制限]
        CurrentSec[セキュリティ<br/>基本認証・RLS]
    end
    
    subgraph "Phase 2 拡張"
        MultiPlan[多段階プラン<br/>Basic/Pro/Enterprise]
        Coupon[クーポンシステム<br/>割引・プロモーション]
        UsageBased[使用量課金<br/>従量課金制]
        Analytics[分析システム<br/>ユーザー行動分析]
    end
    
    subgraph "Phase 3 拡張"
        Invoice[請求書システム<br/>自動発行・送付]
        Corporate[法人機能<br/>一括請求・管理]
        Global[国際対応<br/>多通貨・税務]
        AI[AI機能<br/>予測・最適化]
    end
    
    CurrentSub --> MultiPlan
    CurrentUsage --> UsageBased
    CurrentSec --> Analytics
    
    MultiPlan --> Invoice
    Coupon --> Corporate
    UsageBased --> Global
    Analytics --> AI
```

## トラブルシューティング

### 一般的な問題と解決策

| 問題 | 症状 | 原因 | 解決策 |
|------|------|------|--------|
| 決済失敗 | Stripe Checkout エラー | APIキー無効・ネットワーク | 環境変数確認・キー再生成 |
| 重複購入エラー | 「既にサブスクリプション存在」 | UNIQUE制約違反 | 既存プラン確認・状態リセット |
| Webhook遅延 | サブスクリプション状態が更新されない | Edge Function処理時間超過 | 非同期処理最適化・タイムアウト調整 |
| 認証エラー | 401 Unauthorized | JWTトークン期限切れ・無効 | トークン再取得・認証フロー確認 |
| DB接続エラー | 503 Service Unavailable | Supabase接続制限・障害 | 接続プール設定・リトライ機構 |

### デバッグ手順

```typescript
// 1. ログ確認
console.log('Debug Info:', {
  userId: user?.id,
  subscriptionId: subscription?.stripe_subscription_id,
  timestamp: new Date().toISOString(),
  environment: Deno.env.get('ENVIRONMENT')
});

// 2. Stripe イベント確認
const stripeEvents = await stripe.events.list({
  limit: 10,
  types: ['customer.subscription.*']
});

// 3. データベース状態確認
const { data: dbSubscription } = await supabase
  .from('subscriptions')
  .select('*')
  .eq('user_id', userId)
  .single();
```

## 関連ドキュメント

### 技術仕様書
- [Stripe連携仕様書](/workspaces/real-estate-app/docs_md/11_サブスクリプション管理/01_仕様書/Stripe連携仕様書.md)
- [二重決済防止仕様書](/workspaces/real-estate-app/docs_md/11_サブスクリプション管理/01_仕様書/二重決済防止仕様書.md)
- [データベース設計](/workspaces/real-estate-app/docs_md/11_サブスクリプション管理/02_実装ガイド/データベース設計.md)

### 運用ガイド
- [デプロイ手順書](/workspaces/real-estate-app/docs_md/11_サブスクリプション管理/03_運用手順/デプロイ手順書.md)
- [トラブルシューティング](/workspaces/real-estate-app/docs_md/11_サブスクリプション管理/03_運用手順/トラブルシューティング.md)
- [テスト手順書](/workspaces/real-estate-app/docs_md/11_サブスクリプション管理/03_運用手順/テスト手順書.md)

### 外部リソース
- [Stripe API Documentation](https://stripe.com/docs/api)
- [Supabase Edge Functions Guide](https://supabase.com/docs/guides/functions)
- [PostgreSQL Row Level Security](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)

---

**作成日**: 2025年8月14日  
**最終更新**: 2025年8月14日  
**バージョン**: 2.0.0  
**作成者**: システム統合チーム
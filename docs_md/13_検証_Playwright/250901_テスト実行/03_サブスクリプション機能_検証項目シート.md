# サブスクリプション機能 検証項目シート

作成日: 2025-08-31  
バージョン: 1.0.0

## 1. 機能概要

Stripeを使用したサブスクリプション管理機能です。
無料プラン（月5回制限）とプレミアムプラン（月額2,980円・無制限）の2プラン構成で、
決済処理、プラン変更、解約処理を管理します。

## 2. 検証項目

### 2.1 プラン表示・選択

| No | 検証項目 | 検証内容 | 期待結果 | 優先度 | 状態 |
|----|---------|---------|---------|--------|------|
| D001 | プラン一覧表示 | 料金プランページの表示 | 2プラン正しく表示 | 高 | [ ] |
| D002 | 現在プラン表示 | ログインユーザーの現在プラン | 正しいプラン表示 | 高 | [ ] |
| D003 | 価格表示 | 料金の表示形式 | 税込2,980円表示 | 高 | [ ] |
| D004 | 特典表示 | 各プランの特典説明 | 正しい内容表示 | 中 | [ ] |
| D005 | 比較表表示 | プラン比較表の表示 | 見やすい比較表 | 低 | [ ] |
| D006 | モバイル表示 | スマートフォンでの表示 | レスポンシブ対応 | 中 | [ ] |

### 2.2 アップグレード処理

| No | 検証項目 | 検証内容 | 期待結果 | 優先度 | 状態 |
|----|---------|---------|---------|--------|------|
| U001 | Stripe Checkout起動 | アップグレードボタンクリック | Checkout画面遷移 | 高 | [ ] |
| U002 | カード情報入力 | テストカード番号入力 | 入力受付 | 高 | [ ] |
| U003 | 決済処理成功 | 正常なカード情報で決済 | 決済完了、プラン更新 | 高 | [ ] |
| U004 | 決済処理失敗 | 無効なカード情報で決済 | エラーメッセージ表示 | 高 | [ ] |
| U005 | 残高不足 | 残高不足カードで決済 | エラーメッセージ表示 | 高 | [ ] |
| U006 | 3Dセキュア認証 | 認証必要カードで決済 | 認証画面表示 | 中 | [ ] |
| U007 | 即時プラン反映 | 決済完了後のプラン状態 | 即座にプレミアム化 | 高 | [ ] |
| U008 | 利用制限解除 | アップグレード後の利用 | 無制限で利用可能 | 高 | [ ] |
| U009 | 決済完了メール | 決済完了通知 | メール受信 | 中 | [ ] |
| U010 | 二重課金防止 | 連続してアップグレード操作 | 二重課金されない | 高 | [ ] |

### 2.3 Webhook処理

| No | 検証項目 | 検証内容 | 期待結果 | 優先度 | 状態 |
|----|---------|---------|---------|--------|------|
| W001 | 決済成功Webhook | checkout.session.completed | DBのプラン更新 | 高 | [ ] |
| W002 | サブスク作成Webhook | customer.subscription.created | サブスクリプション記録 | 高 | [ ] |
| W003 | サブスク更新Webhook | customer.subscription.updated | ステータス更新 | 高 | [ ] |
| W004 | 決済失敗Webhook | payment_intent.payment_failed | エラー記録 | 高 | [ ] |
| W005 | 署名検証 | Webhook署名の検証 | 不正リクエスト拒否 | 高 | [ ] |
| W006 | 重複処理防止 | 同一イベントの重複受信 | 重複処理されない | 高 | [ ] |
| W007 | エラーハンドリング | Webhook処理エラー | 適切にエラー処理 | 高 | [ ] |
| W008 | リトライ処理 | Webhook失敗時の再送 | 正しく処理 | 中 | [ ] |

### 2.4 ダウングレード・解約処理

| No | 検証項目 | 検証内容 | 期待結果 | 優先度 | 状態 |
|----|---------|---------|---------|--------|------|
| C001 | 解約画面表示 | 解約ボタンクリック | 確認画面表示 | 高 | [ ] |
| C002 | 解約理由選択 | 解約理由の入力 | 理由記録 | 低 | [ ] |
| C003 | 解約確認 | 解約の最終確認 | 確認ダイアログ表示 | 高 | [ ] |
| C004 | 解約処理実行 | 解約確定 | サブスクリプション停止 | 高 | [ ] |
| C005 | 期間満了まで利用 | 解約後の当月利用 | プレミアム機能継続 | 高 | [ ] |
| C006 | 次月から無料プラン | 期間満了後のステータス | 無料プランに変更 | 高 | [ ] |
| C007 | 解約完了メール | 解約通知メール | メール受信 | 中 | [ ] |
| C008 | 再登録可能 | 解約後の再アップグレード | 正常に再登録 | 中 | [ ] |
| C009 | 解約撤回 | 期間内の解約キャンセル | サブスク継続 | 低 | [ ] |

### 2.5 利用状況管理

| No | 検証項目 | 検証内容 | 期待結果 | 優先度 | 状態 |
|----|---------|---------|---------|--------|------|
| S001 | 利用回数表示 | 現在の利用回数表示 | 正しいカウント表示 | 高 | [ ] |
| S002 | 残り回数表示 | 無料プランの残り回数 | 5-使用回数を表示 | 高 | [ ] |
| S003 | リセット日表示 | 次回リセット日 | 30日後の日付表示 | 中 | [ ] |
| S004 | 利用履歴表示 | 過去の利用履歴 | 正しい履歴表示 | 低 | [ ] |
| S005 | 制限到達通知 | 残り1回時の警告 | 警告メッセージ表示 | 高 | [ ] |
| S006 | 制限超過時動作 | 6回目の実行試行 | アップグレード促進 | 高 | [ ] |
| S007 | カウントリセット | 30日経過後 | カウント0にリセット | 高 | [ ] |
| S008 | プレミアム時表示 | 有料プランの表示 | "無制限"表示 | 中 | [ ] |

### 2.6 請求・支払い管理

| No | 検証項目 | 検証内容 | 期待結果 | 優先度 | 状態 |
|----|---------|---------|---------|--------|------|
| B001 | 初回請求 | 登録時の請求 | 即時請求処理 | 高 | [ ] |
| B002 | 定期請求 | 月次の自動請求 | 正しい日に請求 | 高 | [ ] |
| B003 | 請求書表示 | 請求履歴の確認 | Stripeの請求書表示 | 中 | [ ] |
| B004 | 支払い方法変更 | カード情報の更新 | 新カードで決済 | 高 | [ ] |
| B005 | 支払い失敗時 | カード決済失敗 | リトライ処理 | 高 | [ ] |
| B006 | 猶予期間 | 支払い失敗後の猶予 | 3日間の猶予 | 中 | [ ] |
| B007 | 自動ダウングレード | 猶予期間後 | 無料プランへ変更 | 高 | [ ] |
| B008 | 領収書発行 | 領収書のダウンロード | PDF形式で取得 | 低 | [ ] |

### 2.7 セキュリティ・コンプライアンス

| No | 検証項目 | 検証内容 | 期待結果 | 優先度 | 状態 |
|----|---------|---------|---------|--------|------|
| SEC001 | PCI DSS準拠 | カード情報の取扱い | Stripeで処理（直接扱わない） | 高 | [ ] |
| SEC002 | SSL/TLS通信 | 決済情報の送信 | HTTPS通信確認 | 高 | [ ] |
| SEC003 | トークン管理 | Stripeトークンの保護 | 安全に管理 | 高 | [ ] |
| SEC004 | 環境変数管理 | APIキーの管理 | 環境変数で管理 | 高 | [ ] |
| SEC005 | 特商法表記 | 必要事項の表示 | 法的要件充足 | 高 | [ ] |
| SEC006 | 利用規約同意 | 決済前の同意確認 | 同意チェック必須 | 高 | [ ] |
| SEC007 | 個人情報保護 | 決済情報の取扱い | プライバシーポリシー準拠 | 高 | [ ] |

## 3. テスト用カード番号（Stripe）

| カード番号 | 用途 | 結果 |
|-----------|------|------|
| 4242 4242 4242 4242 | 正常な決済 | 成功 |
| 4000 0000 0000 9995 | 残高不足 | 失敗 |
| 4000 0000 0000 0002 | カード拒否 | 失敗 |
| 4000 0025 0000 3155 | 3Dセキュア認証必要 | 認証画面 |

## 4. Edge Functions一覧

| 関数名 | 用途 | エンドポイント |
|--------|------|---------------|
| create-checkout-session | Checkout作成 | /api/create-checkout-session |
| handle-stripe-webhook | Webhook処理 | /api/handle-stripe-webhook |
| cancel-subscription | 解約処理 | /api/cancel-subscription |
| resume-subscription | 再開処理 | /api/resume-subscription |

## 5. 検証結果サマリー

| 分類 | 総項目数 | 完了 | 未完了 | 完了率 |
|------|---------|------|--------|--------|
| プラン表示 | 6 | 0 | 6 | 0% |
| アップグレード | 10 | 0 | 10 | 0% |
| Webhook | 8 | 0 | 8 | 0% |
| ダウングレード | 9 | 0 | 9 | 0% |
| 利用状況 | 8 | 0 | 8 | 0% |
| 請求管理 | 8 | 0 | 8 | 0% |
| セキュリティ | 7 | 0 | 7 | 0% |
| **合計** | **56** | **0** | **56** | **0%** |

## 6. 既知の問題

- 日割り計算は未実装（月額固定）
- 年間プランは未実装
- 法人向けプランは未実装

## 7. 備考

- Stripe CLIを使用したローカルテストが可能
- 本番環境では実際の決済が発生するため注意
- Webhookのテストには ngrok 等のツールが必要

## 8. 更新履歴

| 日付 | バージョン | 更新内容 |
|------|-----------|---------|
| 2025-08-31 | 1.0.0 | 初版作成 |
# ブラウザ自動起動防止ガイドライン

## 重要な注意事項

**絶対にブラウザを無限に起動させないでください。**

## Playwright以外でのブラウザ自動起動の原因と対策

### 1. Puppeteerによる自動起動

```javascript
// ❌ 危険: Puppeteerでもブラウザが起動し続ける
const puppeteer = require('puppeteer');
// 無限ループや不適切な処理でブラウザが増殖

// ✅ 対策: Puppeteerも必ずheadlessモードとtry-finallyを使用
const browser = await puppeteer.launch({ 
  headless: true,
  args: ['--no-sandbox', '--disable-setuid-sandbox']
});
try {
  // 処理
} finally {
  await browser.close();
}
```

### 2. Seleniumによる自動起動

```javascript
// ❌ 危険: WebDriverの不適切な使用
const { Builder } = require('selenium-webdriver');
const driver = new Builder().forBrowser('chrome').build();
// ドライバーが閉じられない

// ✅ 対策: 必ずquitを呼ぶ
try {
  const driver = await new Builder()
    .forBrowser('chrome')
    .setChromeOptions(new chrome.Options().headless())
    .build();
  // 処理
} finally {
  await driver.quit();
}
```

### 3. child_processでの直接ブラウザ起動

```javascript
// ❌ 絶対禁止: 直接ブラウザプロセスを起動
const { spawn, exec } = require('child_process');
spawn('chromium-browser', ['http://example.com']);
exec('open -a "Google Chrome" http://example.com');

// ✅ 代替案: 必要な場合はヘッドレスモードで起動
spawn('chromium-browser', ['--headless', '--disable-gpu', 'http://example.com']);
```

### 4. npm scriptsやシェルスクリプトでの起動

```json
// ❌ package.jsonでの危険な設定
{
  "scripts": {
    "test": "chromium-browser test.html"
  }
}
```

```bash
# ❌ 危険なシェルスクリプト
#!/bin/bash
while true; do
  open -a "Google Chrome" http://localhost:3000
done
```

### 5. VS CodeやIDEの拡張機能による自動起動

- Live Server拡張機能の「Open with Live Server」
- Preview拡張機能の自動ブラウザ起動
- デバッガーの自動ブラウザ起動

**対策**: 
- 拡張機能の自動起動設定を無効化
- `settings.json`で明示的に制御

```json
{
  "liveServer.settings.NoBrowser": true,
  "debug.javascript.debugByLinkOptions": "off"
}
```

### 6. ビルドツールによる自動起動

```javascript
// ❌ webpack-dev-serverの危険な設定
module.exports = {
  devServer: {
    open: true,  // 自動でブラウザを開く
  }
};

// ✅ 対策: 自動起動を無効化
module.exports = {
  devServer: {
    open: false,
  }
};
```

### 7. テストランナーによる自動起動

```javascript
// ❌ Karmaの危険な設定
module.exports = function(config) {
  config.set({
    browsers: ['Chrome'],
    singleRun: false,  // 継続的に実行
  });
};

// ✅ 対策: ヘッドレスモードとシングルラン
module.exports = function(config) {
  config.set({
    browsers: ['ChromeHeadless'],
    singleRun: true,
  });
};
```

## 必須ルール

### 1. Playwrightテスト実行時の必須設定

```javascript
// 必ずheadlessモードを使用
const browser = await chromium.launch({
  headless: true,  // 必須: GUIブラウザを起動しない
  timeout: 30000   // タイムアウトを設定
});
```

### 2. ブラウザインスタンスの確実な終了

```javascript
let browser;
try {
  browser = await chromium.launch({ headless: true });
  // テスト処理
} finally {
  // 必ずブラウザを閉じる
  if (browser) {
    await browser.close();
  }
}
```

### 3. 無限ループの防止

```javascript
// ❌ 絶対にやってはいけない例
while (true) {
  const browser = await chromium.launch();
  // ブラウザが閉じられない
}

// ✅ 正しい例
const MAX_RETRIES = 3;
for (let i = 0; i < MAX_RETRIES; i++) {
  let browser;
  try {
    browser = await chromium.launch({ headless: true });
    // 処理
    break; // 成功したらループを抜ける
  } catch (error) {
    console.error(`Attempt ${i + 1} failed:`, error);
  } finally {
    if (browser) await browser.close();
  }
}
```

### 4. プロセス終了時の処理

```javascript
// プロセス終了時にもブラウザを確実に閉じる
process.on('SIGINT', async () => {
  if (browser) await browser.close();
  process.exit(0);
});

process.on('SIGTERM', async () => {
  if (browser) await browser.close();
  process.exit(0);
});
```

## 禁止事項

1. **GUI モードでの実行禁止**
   - `headless: false` は開発時のデバッグのみ
   - 自動テストでは絶対に使用しない

2. **無限ループでのブラウザ起動禁止**
   - リトライは最大3回まで
   - 各試行後は必ずブラウザを閉じる

3. **エラー時のブラウザ放置禁止**
   - try-finally を必ず使用
   - エラーが発生してもブラウザは閉じる

## 推奨設定

```javascript
// playwright.config.js
module.exports = {
  use: {
    headless: true,
    viewport: { width: 1280, height: 720 },
    ignoreHTTPSErrors: true,
    video: 'off',  // ビデオ録画を無効化
  },
  
  // グローバルタイムアウト
  timeout: 30000,
  
  // テスト全体のタイムアウト
  globalTimeout: 600000,
  
  // 並列実行を制限
  workers: 1,
  
  // リトライを制限
  retries: 0,
};
```

## チェックリスト

テスト実行前に必ず確認：

- [ ] `headless: true` が設定されている
- [ ] try-finally でブラウザクローズが保証されている
- [ ] 無限ループが存在しない
- [ ] リトライ回数が制限されている
- [ ] タイムアウトが適切に設定されている
- [ ] プロセス終了ハンドラーが設定されている

## トラブルシューティング

### ブラウザプロセスが残っている場合

```bash
# Chromiumプロセスを確認
ps aux | grep chromium

# Chromeプロセスを確認
ps aux | grep -i chrome

# すべてのブラウザプロセスを確認
ps aux | grep -E "(chromium|chrome|firefox|safari)"

# 強制終了（緊急時のみ）
pkill -f chromium
pkill -f chrome
killall chromium-browser
killall "Google Chrome"
```

### テスト実行前の確認コマンド

```bash
# 既存のブラウザプロセスがないことを確認
pgrep -f chromium || echo "No chromium processes found"
pgrep -f chrome || echo "No chrome processes found"
```

### ブラウザが大量に起動してしまった場合の緊急対処

```bash
# すべてのブラウザプロセスを一括終了（注意: 作業中のブラウザも閉じられます）
pkill -9 -f "chromium|chrome"

# システムリソースの確認
top -b -n 1 | head -20
free -h
```

## 重要

**このガイドラインは必ず守ってください。ブラウザの無限起動はシステムリソースを枯渇させ、作業環境を破壊する可能性があります。**
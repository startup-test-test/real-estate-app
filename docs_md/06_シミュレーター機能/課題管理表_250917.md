# 詳細キャッシュフロー分析 課題管理表
作成日：2025年9月17日
最終更新：2025年9月17日（ChatGPT指摘反映版）

## 1. 現状の課題一覧

### 優先度：高

#### 1.1 売却関連列の再構成 🔴
**問題点**
- 売却純利益の定義が不明瞭（会計益なのかCFなのか曖昧）
- 売却コストの内訳（仲介手数料、譲渡税等）が表示されていない
- 売却時累計CFのラベルが誤解を招く（自己資金を差し引いているのに「累計CF」と表記）

**影響範囲**
- ユーザーの投資判断の精度
- IRR計算の透明性
- 売却時の手取り金額の理解

**対応状況**
- 未着手

---

### 優先度：中

#### 1.2 既存データとの互換性対応 🟡
**問題点**
- Supabaseに保存された既存データには売却コストフィールドがない
- 新規実行分と既存データで表示項目が異なる可能性

**影響範囲**
- 過去のシミュレーション結果の表示
- データの一貫性

**対応状況**
- 未着手

#### 1.3 計算ロジックのドキュメント不足 🟡
**問題点**
- 各計算項目の詳細な計算式がユーザーに見えない
- 税率や減価償却の計算根拠が不明瞭

**影響範囲**
- ユーザーの理解度
- サポート対応の効率

**対応状況**
- 一部ドキュメント化済み（計算ロジックの課題管理表_250916.md）

---

## 2. 具体的な変更内容

### 2.1 詳細キャッシュフロー分析テーブルの列変更

#### 【削除する列】
1. **売却純利益**
   - 理由：定義が曖昧で誤解を招く
   - 現在の計算：売却時累計CF - 累計CF（冗長）

2. **売却時累計CF**
   - 理由：自己資金を差し引いているのに「累計CF」と表記
   - 移行：KPIバッジで「売却時投資純利益」として表示

#### 【追加する列】
1. **売却費用（仲介＋税金）**
   - 表示内容：仲介手数料 + 譲渡税の合計
   - ツールチップ：内訳を表示
   - 計算：`brokerage_fee * 10000 + transfer_tax`

2. **売却時ネットCF（手取り）**
   - 表示内容：実際の手取り金額
   - 計算：`sale_amount - (brokerage_fee + other_costs) * 10000 - transfer_tax - remaining_loan * 10000`
   - 用途：IRR計算に使用

### 2.2 内部データ構造の変更

#### バックエンド（calculations.py）の修正内容
```python
# 現在のフィールド構造
{
    '売却純利益': sale_net_profit,      # 削除
    '売却時累計CF': sale_cumulative_cf,  # 削除
}

# 新しいフィールド構造
{
    'schema_version': 'v2.0.0',           # 新規追加
    'broker_fee': brokerage_fee,          # 新規追加（内部保持）
    'other_disposal_fee': other_sale_costs,# 新規追加（内部保持）
    'transfer_tax': transfer_tax,         # 新規追加（内部保持）
    '売却費用': brokerage_fee * 10000 + transfer_tax,  # 新規追加（表示用）
    '売却時ネットCF': net_sale_proceeds,   # 新規追加（表示用）
}
```

### 2.3 フロントエンド（Simulator.tsx）の修正内容

#### テーブルヘッダーの変更
```typescript
// 現在のヘッダー（売却年のみ表示）
['売却金額', '売却純利益', '期末残債', '売却時累計CF']

// 新しいヘッダー（売却年のみ表示）
['売却金額', '売却費用（仲介＋税金）', '期末残債', '売却時ネットCF（手取り）']
```

#### 既存データの互換性対応
```typescript
// schema_versionで新旧判定
if (!row.schema_version || row.schema_version === 'v1.0.0') {
    // 旧データの近似補完
    const salePriceMan = row['売却金額'] / 10000;
    const brokerApprox = calculateBrokerageFee(salePriceMan);
    const otherApprox = salePriceMan * 0.01;
    // ... 譲渡税の近似計算

    row['売却費用'] = brokerApprox * 10000 + transferTaxApprox;
    row['売却時ネットCF'] = row['売却金額'] - row['売却費用'] - row['期末残債'];

    // 注意書き表示フラグ
    showLegacyDataNotice = true;
}
```

### 2.4 KPIバッジの追加内容

#### 売却年に表示する新規KPI
1. **キャピタルゲイン（税前）**
   - 計算：売却金額 - 譲渡費用（仲介＋その他） - 取得簿価
   - 表示位置：テーブル上部のKPIエリア

2. **売却後累計CF**
   - 計算：累計CF + 売却時ネットCF
   - 表示位置：テーブル上部のKPIエリア

3. **売却時投資純利益（初期投資差引後）**
   - 計算：売却後累計CF - 初期自己資金
   - 表示位置：テーブル上部のKPIエリア（旧「売却時累計CF」の代替）

### 2.5 年次キャッシュフロー詳細グラフの変更

#### 現在のグラフ構成（CashFlowChart.tsx）
```typescript
// 現在の積み上げグラフの構成
datasets: [
  {
    label: '①累計CF',
    data: cumulativeCashFlowBar,  // 累計CF
    type: 'bar',
    stack: 'Stack 0'
  },
  {
    label: '②売却純利益',
    data: saleNetProfit,  // 売却時累計CF - 累計CF
    type: 'bar',
    stack: 'Stack 0'
  },
  {
    label: '③売却時累計CF',
    data: saleCumulativeCF,  // 線グラフ
    type: 'line'
  }
]
```

#### 新しいグラフ構成
```typescript
// 新しい積み上げグラフの構成
datasets: [
  {
    label: '①累計CF',
    data: cumulativeCashFlowBar,  // 累計CFはそのまま
    type: 'bar',
    stack: 'Stack 0'
  },
  {
    label: '②売却時ネットCF',  // 名称変更
    data: saleNetCF,  // 売却時ネットCF（手取り）を使用
    type: 'bar',
    stack: 'Stack 0'
  },
  {
    label: '③売却後累計CF',  // 名称変更
    data: saleAfterCumulativeCF,  // 累計CF + 売却時ネットCF
    type: 'line'
  }
]
```

#### 修正内容
1. **売却純利益** → **売却時ネットCF**に変更
   - 計算：売却金額 - 売却費用 - 期末残債
   - より直感的な「手取り金額」を表示

2. **売却時累計CF** → **売却後累計CF**に変更
   - 計算：累計CF + 売却時ネットCF
   - 自己資金の差し引きを削除（純粋な累計を表示）

3. **ツールチップの修正**
   - 売却時ネットCFの説明を追加
   - 計算根拠を明確に表示

### 2.6 計算ロジックの修正箇所

#### calculations.py（596-632行目）の修正
```python
# 現在のコード（削除対象）
sale_cumulative_cf = cum + net_sale_proceeds - basic_metrics['self_funding'] * 10000
sale_net_profit = sale_cumulative_cf - cum

# 新しいコード
row_data['schema_version'] = 'v2.0.0'
row_data['broker_fee'] = brokerage_fee  # 万円単位
row_data['other_disposal_fee'] = other_sale_costs  # 万円単位
row_data['transfer_tax'] = transfer_tax  # 円単位
row_data['売却費用'] = brokerage_fee * 10000 + transfer_tax  # 表示用（円単位）
row_data['売却時ネットCF'] = net_sale_proceeds  # 円単位

# 旧フィールドは削除（互換性のため一時的にNullで残すことも検討）
# row_data['売却純利益'] = None
# row_data['売却時累計CF'] = None
```

---

## 3. 改善案と実装計画

### フェーズ1：売却関連列の再構成（2日間）

#### Day 1：バックエンド改修
**作業内容**
1. `calculate_cash_flow_table`関数の修正
   - 売却費用（仲介＋税金）フィールドの追加
   - 売却時ネットCF（手取り）の計算ロジック実装
   - 売却純利益と売却時累計CFフィールドの削除準備

**実装詳細**
```python
# 新規フィールド（内部は内訳保持、表は集約表示）
'broker_fee': broker,                          # 仲介手数料（階段式×1.10）
'other_disposal_fee': other,                   # その他費用（売価×1%）
'transfer_tax': cap_tax,                       # 譲渡税
'disposal_cost': broker + other,               # 譲渡費用（課税ベース）
'売却費用(表示)': broker + cap_tax,             # 表の1列（仲介＋税金）

# 核心値
'売却時ネットCF': sale_price - (broker + other) - cap_tax - loan_balance_t,

# 旧フィールド
'売却純利益': None,
'売却時累計CF': None,
'schema_version': 'v2.0.0',  # ⭐ 新規追加：バージョン管理
```

#### Day 2：フロントエンド改修
**作業内容**
1. テーブル表示の更新（Simulator.tsx）
   - 新規列の追加と旧列の非表示化
   - ツールチップで売却費用の内訳表示
   - 既存データの互換性対応（フロントエンドで逆算）

2. グラフの更新（CashFlowChart.tsx）
   - 売却純利益 → 売却時ネットCFに変更
   - 売却時累計CF → 売却後累計CFに変更
   - データ取得ロジックの修正

**テーブル構成（改修後）**
| 既存列 | 新規列 | 削除列 |
|--------|--------|--------|
| 売却金額 | 売却費用（仲介＋税金） | 売却純利益 |
| 期末残債 | 売却時ネットCF（手取り） | 売却時累計CF |
| 累計CF | | |

---

### フェーズ2：既存データの互換性対応（1日間）

#### 実装方針
1. **バックエンド側**
   - 新規計算時は新フィールドを含めて保存
   - APIレスポンスで新旧両方のフィールドを返す（移行期間）

2. **フロントエンド側**
   - 売却費用が存在しない場合の近似補完（⚠️ 直接逆算は避ける）
   ```typescript
   // 近似補完（注意書き表示を必ず）
   if (!data.schema_version || data.schema_version === 'v1.0.0') {
     const brokerApprox = stairBrokerFee(salePrice) * 1.10;
     const otherApprox = salePrice * 0.01;
     const disposalCostApprox = brokerApprox + otherApprox;

     const capGainPreApprox = salePrice - disposalCostApprox - adjustedBasisApprox;
     const capTaxApprox = Math.max(0, capGainPreApprox) * capTaxRate;

     data.売却費用 = brokerApprox + capTaxApprox; // 表示用のみ
     data.売却時ネットCF = salePrice - (brokerApprox + capTaxApprox) - loanBalanceT;

     // UIに注記表示
     showNotice('※旧データは売却費用を概算で補完しています');
   }
   ```

3. **データ移行計画**
   - 3ヶ月の移行期間を設定
   - 新規データは新フォーマットで保存
   - 既存データは読み取り時に変換

---

### フェーズ3：UIの改善とドキュメント整備（1日間）

#### UI改善項目
1. **KPIバッジの追加**（テーブル上部）
   - 売却後累計CF（= 累計CF + 売却時ネットCF）
   - キャピタルゲイン（税前）（= 売却価格 - 譲渡費用 - 簿価）
   - 最終損益（初期投資差引後）
   - 投資効率（ROI）

2. **ツールチップの充実**
   - 売却費用の内訳表示
   - 計算式の説明
   - 税率の根拠

#### ドキュメント整備
1. ユーザー向け説明文の作成
2. 計算ロジックの詳細仕様書の完成
3. FAQ・トラブルシューティングガイド

---

## 3. 技術的考慮事項

### データベース構造
- `simulations`テーブルの`result_data`列（JSONB型）
- スキーマレスなため、フィールドの追加・削除が柔軟
- マイグレーション不要

### パフォーマンス
- 売却費用の逆算処理は軽量（クライアント側で実行）
- 既存データの変換はキャッシュを活用

### テスト項目
1. 新規シミュレーションの動作確認
2. 既存データの表示確認（schema_version判定）
3. 売却費用の計算精度検証（その他費用の反映確認）
4. IRR計算の整合性確認
5. 恒等式によるバグ検出
   - `売却価格 === 売却時ネットCF + 期末残債 + 譲渡費用 + 譲渡税`
   - `(売却時累計CF - 売却直前累計CF - その年の通常CF) === 売却時ネットCF`
6. 譲渡税の二重計上チェック（年次税金と分離確認）

---

## 4. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 既存データの表示崩れ | 高 | フロントエンドで互換性レイヤーを実装 |
| 計算ロジックの不整合 | 高 | バグ検知用の恒等式チェックを実装 |
| ユーザーの混乱 | 中 | 変更内容の事前告知とヘルプ追加 |
| パフォーマンス低下 | 低 | 逆算処理の最適化とキャッシュ活用 |

---

## 5. スケジュール

```
9/17（火）：課題整理・設計完了 ✅
9/18（水）：バックエンド改修
9/19（木）：フロントエンド改修
9/20（金）：互換性対応・テスト
9/21（土）：UI改善・ドキュメント整備
9/22（日）：最終確認・リリース準備
```

---

## 6. 成功指標

1. **機能面**
   - 売却費用の透明性向上
   - IRR計算の理解しやすさ改善
   - 既存データの正常表示

2. **品質面**
   - バグゼロでのリリース
   - パフォーマンス劣化なし
   - ユーザーからの問い合わせ減少

3. **運用面**
   - スムーズなデータ移行
   - ドキュメントの充実
   - 保守性の向上

---

## 7. 決定事項

1. **列構成の変更**
   - 削除：売却純利益、売却時累計CF
   - 追加：売却費用（仲介＋税金）、売却時ネットCF（手取り）

2. **ラベル変更**
   - 「売却時累計CF」→「売却時投資純利益（初期投資差引後）」（将来的に）

3. **計算式の統一**
   - IRR：t=0で-自己資金、各年で税引後CF、最終年で売却時ネットCF
   - 譲渡費用（課税ベース）：仲介手数料＋その他費用
   - 売却費用（表示）：仲介手数料（税込）＋譲渡税
   - 売却時ネットCF：売却金額 - 譲渡費用 - 譲渡税 - 期末残債
   - キャピタルゲイン（税前）：売却金額 - 譲渡費用 - 調整簿価

---

## 8. 未決定事項

1. 移行期間の具体的な長さ（3ヶ月を想定）
2. 旧フィールドの完全削除時期
3. ユーザーへの告知方法・タイミング

---

## 9. 参考資料

- [開発日報_250916_1.md](./開発日報_250916_1.md)
- [計算ロジックの課題管理表_250916.md](./計算ロジックの課題管理表_250916.md)
- ChatGPTからのフィードバック（2025年9月16日）

---

## 10. 既存の計算ロジック（活用必須）

### 現在実装済みの計算ロジック

#### 仲介手数料計算（calculations.py: calculate_brokerage_fee関数）
```python
def calculate_brokerage_fee(sale_price_man: float) -> float:
    """売却時の仲介手数料を計算（万円単位、消費税込み）"""
    sale_price_yen = sale_price_man * 10000
    # 宅建業法の上限手数料率に基づく計算
    if sale_price_yen <= 2000000:
        fee = sale_price_yen * 0.05
    elif sale_price_yen <= 4000000:
        fee = sale_price_yen * 0.04 + 20000
    else:
        fee = sale_price_yen * 0.03 + 60000

    # 消費税10%を加算
    fee_with_tax = fee * 1.10
    return fee_with_tax / 10000  # 万円単位で返す
```

#### その他費用（既に実装済み）
```python
other_sale_costs = sale_price_man * 0.01  # その他費用（登記費用、印紙税等）約1%
```

#### 譲渡所得税の計算（既に実装済み）
```python
# 個人の場合
if i <= 5:  # 短期譲渡（5年以内）
    transfer_tax = capital_gain * 0.40
else:       # 長期譲渡（6年以降）
    transfer_tax = capital_gain * 0.20

# 法人の場合
transfer_tax = capital_gain * (effective_tax_rate / 100)
```

### 既存ロジックを活用した改修方針

1. **仲介手数料**：`calculate_brokerage_fee`関数をそのまま使用
2. **その他費用**：現在の1%設定を維持（sale_price × 0.01）
3. **譲渡税率**：個人（短期40%、長期20%）、法人（実効税率）の既存ロジックを維持
4. **取得費計算**：購入価格 + 改装費 + 諸経費の既存計算を維持

---

## 11. ChatGPT指摘事項の反映（重要）

### 最優先で対応すべき3点

1. **その他費用の考慮漏れ対応**
   - 売却費用に「その他費用（売価×1%）」を必ず含める
   - 譲渡所得の計算時に譲渡費用として控除する
   - 内部では内訳を保持し、表示では集約

2. **既存データの逆算回避**
   - 旧「売却純利益」からの直接逆算は危険（定義が不明確）
   - schema_versionによる新旧判定を実装
   - 近似補完を使用し、注意書きを表示

3. **譲渡税の二重計上防止**
   - 年次の「税金」列は運用益の税のみ
   - 譲渡税は売却ブロックにのみ計上
   - 明確な分離で透明性向上

### 実装時の計算式（既存ロジック活用版）
```python
# バックエンド実装（既存関数を活用）
brokerage_fee = calculate_brokerage_fee(sale_price_man)  # 既存関数をそのまま使用
other_sale_costs = sale_price_man * 0.01                 # 既存の1%設定を維持
disposal_cost = brokerage_fee + other_sale_costs         # 譲渡費用（課税ベース）

# 譲渡所得の計算
acquisition_cost = (purchase_price + renovation_cost + other_costs) * 10000
capital_gain = max(0, sale_amount - acquisition_cost - disposal_cost * 10000)

# 譲渡税（既存ロジックを維持）
if owner_type == '個人':
    if year <= 5:
        transfer_tax = capital_gain * 0.40  # 短期
    else:
        transfer_tax = capital_gain * 0.20  # 長期
else:
    transfer_tax = capital_gain * (effective_tax_rate / 100)  # 法人

# 売却時ネットCF
net_sale_proceeds = sale_amount - remaining_loan * 10000 - disposal_cost * 10000 - transfer_tax
```

---

## 12. 本番環境へのリリース方法

### 環境構成
| 環境 | フロントエンド | バックエンド | データベース |
|------|--------------|------------|------------|
| 開発環境（develop） | GitHub Codespaces | Render（テスト） | Supabase（テスト） |
| 本番環境（main） | Vercel/Netlify | Render（本番） | Supabase（本番） |

### リリース手順

#### Phase 1: テスト環境での検証（develop環境）
1. **バックエンドの更新**
   ```bash
   # developブランチで作業
   git checkout develop

   # calculations.pyの修正を実装
   # - 売却費用、売却時ネットCFのフィールド追加
   # - schema_version追加

   # テスト環境のRenderへ自動デプロイ（developブランチpush時）
   git add -A
   git commit -m "feat: 売却関連列の再構成（v2.0.0）"
   git push origin develop
   ```

2. **フロントエンドの更新**
   ```bash
   # Simulator.tsxの修正を実装
   # - テーブル列の変更
   # - 互換性対応ロジック追加

   # テスト環境での動作確認
   npm run dev  # ローカルで確認
   ```

3. **Supabaseテスト環境での確認**
   - 新規シミュレーション実行（v2.0.0データ）
   - 既存データの表示確認（v1.0.0データ）
   - 互換性の検証

#### Phase 2: 本番環境へのリリース準備
1. **データベースの準備**
   - Supabase本番環境への影響確認
   - 既存データのバックアップ取得
   - ロールバック計画の準備

2. **リリースノート作成**
   ```markdown
   ## v2.0.0 売却関連列の再構成

   ### 変更内容
   - 売却純利益、売却時累計CF列を削除
   - 売却費用（仲介＋税金）列を追加
   - 売却時ネットCF（手取り）列を追加

   ### 互換性
   - 既存データ（v1.0.0）は自動で近似補完
   - 新規データはv2.0.0形式で保存
   ```

#### Phase 3: 本番リリース
1. **バックエンドのリリース（Render本番）**
   ```bash
   # mainブランチへマージ
   git checkout main
   git merge develop --no-ff

   # タグ付け
   git tag -a v2.0.0 -m "売却関連列の再構成リリース"

   # 本番環境のRenderへ自動デプロイ
   git push origin main
   git push origin --tags
   ```

2. **フロントエンドのリリース**
   ```bash
   # ビルド確認
   npm run build

   # 本番環境へのデプロイ（Vercel/Netlifyの場合は自動）
   # mainブランチpush時に自動デプロイ
   ```

3. **リリース後の確認**
   - 本番環境での動作確認
   - 既存ユーザーのデータ表示確認
   - エラーログの監視

### ロールバック手順
```bash
# 問題発生時のロールバック
git checkout main
git revert HEAD
git push origin main

# または前バージョンのタグにリセット
git checkout v1.x.x
git branch -f main v1.x.x
git push origin main --force
```

### 段階的リリース（推奨）
1. **Week 1**: バックエンドのみリリース（新旧両フィールドを返す）
2. **Week 2**: フロントエンドをリリース（新フィールドを表示）
3. **Week 3**: 旧フィールドの削除（3ヶ月後）

### モニタリング項目
- Renderのログ監視
- Supabaseのクエリパフォーマンス
- ユーザーからのフィードバック
- エラー率の確認

---

## 13. 更新履歴

| 日付 | 更新者 | 更新内容 |
|------|--------|----------|
| 2025/09/17 | Claude AI | 初版作成 |
| 2025/09/17 | Claude AI | ChatGPT指摘事項を反映 |
| 2025/09/17 | Claude AI | 既存計算ロジックの活用方法を追加 |
| 2025/09/17 | Claude AI | 本番環境へのリリース方法を追加 |
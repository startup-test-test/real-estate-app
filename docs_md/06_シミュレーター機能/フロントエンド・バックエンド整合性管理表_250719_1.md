# フロントエンド・バックエンド整合性管理表

## 概要
このドキュメントは、大家DXシミュレーター機能のフロントエンドとバックエンドAPIの整合性を管理し、今後の実装計画を明確にするものです。

**最終更新日**: 2025年7月18日

## 現在の不整合項目一覧

### 1. 計算ロジック関連

| 項目 | フロントエンド | バックエンドAPI | 優先度 | 対応方針 |
|------|---------------|----------------|---------|----------|
| 実質利回り | ✅ 表示あり | ❌ 未計算 | 高 | APIに計算ロジック追加 |
| 年間価値下落率 | ✅ 入力欄追加済 | ❌ 未対応 | 高 | APIパラメータ追加、計算ロジック実装 |
| 売却価格の経年変化 | ✅ UI準備済 | ❌ 固定値 | 中 | キャッシュフローテーブルに年次売却価格追加 |
| 建物/土地比率 | ✅ 入力可能 | ⚠️ 簡易計算 | 中 | より詳細な計算ロジック実装 |
| 減価償却計算 | ✅ 詳細設定可能 | ❌ 未使用 | 低 | 税務計算の精緻化 |

### 2. 税務・会計関連

| 項目 | フロントエンド | バックエンドAPI | 優先度 | 対応方針 |
|------|---------------|----------------|---------|----------|
| 所有形態（個人/法人） | ✅ 選択可能 | ❌ 未考慮 | 中 | 税率計算に反映 |
| 実効税率 | ✅ 入力可能 | ❌ 未使用 | 中 | 売却益計算に反映 |
| 譲渡所得税 | ❌ 未実装 | ❌ 未実装 | 中 | 長期/短期譲渡の区分追加 |

### 3. 物件情報関連

| 項目 | フロントエンド | バックエンドAPI | 優先度 | 対応方針 |
|------|---------------|----------------|---------|----------|
| 建物構造 | ✅ 選択可能 | ❌ 未使用 | 低 | 減価償却年数の自動設定 |
| 築年数 | ✅ 入力可能 | ⚠️ 一部使用 | 中 | 残存耐用年数の計算 |
| 物件ステータス | ✅ 管理可能 | ❌ 不要 | - | フロントのみで管理 |
| 物件URL/メモ | ✅ 入力可能 | ❌ 不要 | - | フロントのみで管理 |
| 物件画像 | ✅ アップロード可能 | ❌ 不要 | - | フロントのみで管理 |

### 4. ローン・金融関連

| 項目 | フロントエンド | バックエンドAPI | 優先度 | 対応方針 |
|------|---------------|----------------|---------|----------|
| 変動金利対応 | ❌ 未実装 | ❌ 未実装 | 低 | 将来的に実装検討 |
| 繰上返済 | ❌ 未実装 | ❌ 未実装 | 低 | 将来的に実装検討 |

## 実装計画

### Phase 1: 即座に対応可能（フロントエンドのみ）
**期限目安**: 1週間以内

1. **実質利回りの計算**
   ```typescript
   const netYield = ((annualRent - annualExpenses) / totalInvestment) * 100;
   ```

2. **売却価格の表示調整**
   ```typescript
   const depreciatedValue = initialValue * Math.pow(1 - depreciationRate/100, year);
   ```

3. **メタデータの管理**
   - 物件URL、メモ、画像はSupabaseで管理継続

### Phase 2: 短期対応（API軽微な修正）
**期限目安**: 2-3週間

1. **APIレスポンスに追加**
   - 実質利回り（%）
   - 各年次の想定売却価格

2. **APIリクエストに追加**
   - annual_depreciation_rate
   - ownership_type
   - effective_tax_rate

3. **計算ロジックの更新**
   ```python
   # 実質利回り
   net_yield = (annual_rent - annual_expenses) / total_investment * 100
   
   # 売却価格の経年変化
   sale_price_year_n = initial_value * (1 - depreciation_rate/100) ** n
   ```

### Phase 3: 中期対応（API本格改修）
**期限目安**: 1-2ヶ月

1. **税務計算の精緻化**
   - 個人/法人の税率差異
   - 長期/短期譲渡所得税
   - 減価償却の詳細計算

2. **キャッシュフローテーブルの拡張**
   - 各年の想定売却価格
   - 売却時の税引後手取り
   - 累積減価償却額

3. **新規指標の追加**
   - 税引後IRR
   - 実質ROI
   - Break Even Point

## 実装時の注意事項

### バックエンド更新時
1. **後方互換性の維持**
   - 新規パラメータはオプショナルに
   - デフォルト値の設定

2. **バージョニング**
   - エンドポイント: `/api/v2/simulate`
   - 段階的な移行期間を設定

### フロントエンド更新時
1. **フォールバック処理**
   ```typescript
   const netYield = response.results['実質利回り（%）'] || calculateNetYield(data);
   ```

2. **プログレッシブエンハンスメント**
   - 基本機能は現行APIで動作
   - 拡張機能は新APIで有効化

## テスト計画

1. **単体テスト**
   - 各計算ロジックのテストケース作成
   - エッジケースの確認

2. **統合テスト**
   - フロント・バックエンド間の連携確認
   - 既存機能への影響確認

3. **回帰テスト**
   - 既存のシミュレーション結果との比較
   - 計算精度の検証

## 今後追加予定の機能要件

### 検討中の項目
- [ ] 複数物件の比較機能
- [ ] シナリオ分析（楽観・中立・悲観）
- [ ] 為替・金利変動シミュレーション
- [ ] エリア別市場分析
- [ ] AIによる投資判断サポート

### ユーザーからの要望
- [ ] Excel/CSVエクスポート機能
- [ ] より詳細なグラフ表示
- [ ] カスタム指標の追加

## 更新履歴

| 日付 | 更新内容 | 更新者 |
|------|---------|--------|
| 2025/07/18 | 初版作成 | Claude Code |
| - | 年間価値下落率機能の追加に伴う整理 | - |

---

**Note**: このドキュメントは継続的に更新されます。新機能の追加や要件変更があった場合は、必ずこのドキュメントを更新してください。
# 売却関連列の再構成 実行タスク表
実行日：2025年9月17日

## 📊 実行タスクリスト

### 1️⃣ バックエンド修正タスク

| No | ファイル | 行番号 | 作業内容 | 優先度 | ステータス |
|-----|----------|--------|----------|--------|-----------|
| B-1 | calculations.py | 596-632 | `schema_version: 'v2.0.0'`を追加 | 🔴高 | ⬜未着手 |
| B-2 | calculations.py | 596-632 | `broker_fee`（仲介手数料）フィールド追加 | 🔴高 | ⬜未着手 |
| B-3 | calculations.py | 596-632 | `other_disposal_fee`（その他費用）フィールド追加 | 🔴高 | ⬜未着手 |
| B-4 | calculations.py | 596-632 | `transfer_tax`（譲渡税）フィールド追加 | 🔴高 | ⬜未着手 |
| B-5 | calculations.py | 596-632 | `売却費用`（表示用）フィールド追加<br>`brokerage_fee * 10000 + transfer_tax` | 🔴高 | ⬜未着手 |
| B-6 | calculations.py | 596-632 | `売却時ネットCF`フィールド追加<br>`net_sale_proceeds`をそのまま使用 | 🔴高 | ⬜未着手 |
| B-7 | calculations.py | 626-632 | `売却純利益`の計算削除（コメントアウト） | 🟡中 | ⬜未着手 |
| B-8 | calculations.py | 626-632 | `売却時累計CF`の計算削除（コメントアウト） | 🟡中 | ⬜未着手 |

### 2️⃣ フロントエンド修正タスク（Simulator.tsx）

| No | ファイル | 行番号 | 作業内容 | 優先度 | ステータス |
|-----|----------|--------|----------|--------|-----------|
| F-1 | Simulator.tsx | 3484-3490 | 「売却純利益」のヘッダー削除 | 🔴高 | ⬜未着手 |
| F-2 | Simulator.tsx | 3484付近 | 「売却費用（仲介＋税金）」ヘッダー追加 | 🔴高 | ⬜未着手 |
| F-3 | Simulator.tsx | 3520 | 「売却時累計CF」のヘッダー削除 | 🔴高 | ⬜未着手 |
| F-4 | Simulator.tsx | 3520付近 | 「売却時ネットCF（手取り）」ヘッダー追加 | 🔴高 | ⬜未着手 |
| F-5 | Simulator.tsx | 3519 | 売却純利益のデータ表示削除 | 🔴高 | ⬜未着手 |
| F-6 | Simulator.tsx | 3519付近 | 売却費用のデータ表示追加 | 🔴高 | ⬜未着手 |
| F-7 | Simulator.tsx | 3520 | 売却時累計CFのデータ表示削除 | 🔴高 | ⬜未着手 |
| F-8 | Simulator.tsx | 3520付近 | 売却時ネットCFのデータ表示追加 | 🔴高 | ⬜未着手 |
| F-9 | Simulator.tsx | 新規追加 | schema_version判定ロジック追加 | 🔴高 | ⬜未着手 |
| F-10 | Simulator.tsx | 新規追加 | 旧データの近似補完ロジック追加 | 🔴高 | ⬜未着手 |
| F-11 | Simulator.tsx | 新規追加 | 旧データ表示時の注意書き表示 | 🟡中 | ⬜未着手 |

### 3️⃣ グラフ修正タスク（CashFlowChart.tsx）

| No | ファイル | 行番号 | 作業内容 | 優先度 | ステータス |
|-----|----------|--------|----------|--------|-----------|
| G-1 | CashFlowChart.tsx | 51-56 | `saleNetProfit`を`saleNetCF`に変更 | 🔴高 | ⬜未着手 |
| G-2 | CashFlowChart.tsx | 53-55 | 売却時ネットCFの計算に変更<br>`row['売却時ネットCF'] \|\| 0` | 🔴高 | ⬜未着手 |
| G-3 | CashFlowChart.tsx | 58-59 | `saleCumulativeCF`を`saleAfterCumulativeCF`に変更 | 🔴高 | ⬜未着手 |
| G-4 | CashFlowChart.tsx | 59 | 売却後累計CFの計算に変更<br>`cumCF + saleNetCF` | 🔴高 | ⬜未着手 |
| G-5 | CashFlowChart.tsx | 97 | ラベルを「②売却純利益」→「②売却時ネットCF」 | 🔴高 | ⬜未着手 |
| G-6 | CashFlowChart.tsx | 98 | dataを`saleNetProfit`→`saleNetCF` | 🔴高 | ⬜未着手 |
| G-7 | CashFlowChart.tsx | 線グラフ | ラベルを「③売却時累計CF」→「③売却後累計CF」 | 🔴高 | ⬜未着手 |
| G-8 | CashFlowChart.tsx | 線グラフ | dataを`saleCumulativeCF`→`saleAfterCumulativeCF` | 🔴高 | ⬜未着手 |

### 4️⃣ 売却時指標追加タスク（保留・要検討）

| No | ファイル | 行番号 | 作業内容 | 優先度 | ステータス |
|-----|----------|--------|----------|--------|-----------|
| K-1 | Simulator.tsx | 2910-3095 | 「📊 評価額と投資指標」セクションに売却時指標を追加<br>※売却年選択時のみ表示する条件付き実装 | 🟢低 | 🔶保留 |

**追加内容（検討中）：**
- 売却時ネットCF（手取り金額）
- 売却後累計CF（累計CF + 売却時ネットCF）
- 投資純利益（売却後累計CF - 初期自己資金）
- 投資倍率（売却後累計CF ÷ 初期自己資金）

**実装場所：**
既存の「📊 評価額と投資指標」セクション内の最下部に追加
（新規セクションは作らない）

---

## 🔧 実装手順

### Step 1: バックエンド修正（30分）
1. calculations.pyのバックアップを取得
2. B-1〜B-8のタスクを順次実装
3. テスト環境での動作確認

### Step 2: フロントエンド修正（45分）
1. Simulator.tsxのバックアップを取得
2. F-1〜F-11のタスクを順次実装
3. 既存データの表示確認

### Step 3: グラフ修正（20分）
1. CashFlowChart.tsxのバックアップを取得
2. G-1〜G-8のタスクを順次実装
3. グラフの表示確認

### Step 4: KPIバッジ追加（15分）
1. K-1〜K-3のタスクを実装（オプション）

### Step 5: 総合テスト（30分）
1. 新規シミュレーション実行
2. 既存データの表示確認
3. エラーチェック

---

## ✅ テストチェックリスト

| No | テスト項目 | 確認内容 | 結果 |
|-----|----------|----------|-------|
| T-1 | 新規データ | v2.0.0形式でデータが保存される | ⬜ |
| T-2 | 既存データ | v1.0.0データが正常に表示される | ⬜ |
| T-3 | 売却費用 | 仲介手数料＋譲渡税が正しく計算される | ⬜ |
| T-4 | 売却時ネットCF | 手取り金額が正しく計算される | ⬜ |
| T-5 | グラフ表示 | 積み上げグラフが正しく表示される | ⬜ |
| T-6 | 恒等式チェック | 売却価格 = ネットCF + 残債 + 費用 | ⬜ |
| T-7 | 注意書き | 旧データ表示時に注意書きが出る | ⬜ |
| T-8 | エラー | コンソールエラーがない | ⬜ |

---

## 🚀 デプロイ手順

### テスト環境
```bash
git add -A
git commit -m "feat: 売却関連列の再構成（v2.0.0）"
git push origin develop
```

### 本番環境（承認後）
```bash
git checkout main
git merge develop --no-ff
git tag -a v2.0.0 -m "売却関連列の再構成"
git push origin main --tags
```

---

## 📝 備考

- **重要**: `その他費用（売価×1%）`を必ず含めること
- **注意**: 旧データの直接逆算は避け、近似補完を使用
- **確認**: 譲渡税は売却ブロックのみに計上（二重計上防止）

---

## 完了時刻記録

| 作業 | 開始時刻 | 終了時刻 | 所要時間 |
|------|----------|----------|----------|
| バックエンド修正 | | | |
| フロントエンド修正 | | | |
| グラフ修正 | | | |
| テスト | | | |
| **合計** | | | |
# チュートリアル課題管理表_251009_1

## 📅 基本情報
- **作成日**: 2025年10月9日
- **最終更新**: 2025年10月9日
- **対象機能**: マイページ・シミュレーターのチュートリアル機能
- **関連ファイル**:
  - `bolt_front/src/pages/MyPage.tsx`
  - `bolt_front/src/pages/Simulator.tsx`
  - `bolt_front/src/data/sampleProperty.ts`

---

## 📊 課題一覧

| No. | 課題項目 | 詳細説明 | 優先度 | ステータス | 担当者 | 工数(h) |
|-----|---------|----------|--------|-----------|--------|---------|
| 1 | チュートリアルとアップグレードモーダルの表示競合 | チュートリアル表示中に「今すぐアップグレード」を押すと、モーダルの上にチュートリアルが被る | 高 | 🟢完了 | - | 1.0 |
| 2 | チュートリアル自動起動時にsessionStorage未設定 | マイページで自動起動したチュートリアルがページ遷移後に継続しない | 致命的 | 🟢完了 | - | 0.5 |
| 3 | ステップ2でターゲット要素が見つからず次へボタンが動作しない | Simulator画面でチュートリアルステップ2の「次へ」を押しても反応しない | 致命的 | 🟢完了 | - | 1.0 |

---

## 🎯 課題詳細

### No.1 チュートリアルとアップグレードモーダルの表示競合

#### 課題内容
マイページでチュートリアル自動起動中に「今すぐアップグレード」ボタンをクリックすると、アップグレードモーダルが表示されるが、チュートリアルのポップアップ（Joyride）がモーダルの上に重なって表示され、ユーザーがモーダルの内容を読めない。

#### 現状の問題点
1. **z-indexの競合**
   - チュートリアル（Joyride）: `z-index: 10000`
   - アップグレードモーダル: z-indexが10000未満の可能性

2. **状態管理の不備**
   - チュートリアル実行中にモーダルが開いても、チュートリアルが自動で一時停止しない

3. **UXの問題**
   - ユーザーがアップグレードモーダルを見られず、混乱する

#### 解決方法

##### 解決案A: モーダル表示時にチュートリアルを一時停止（推奨）

**実装箇所**: `MyPage.tsx`

```tsx
// 1. チュートリアル一時停止用のstate追加
const [runTutorial, setRunTutorial] = React.useState(false);
const [pauseTutorial, setPauseTutorial] = React.useState(false);

// 2. アップグレードモーダルの開閉に連動
const handleUpgradeClick = () => {
  if (runTutorial) {
    setPauseTutorial(true);  // チュートリアル一時停止
  }
  setShowUpgradeModal(true);
};

const handleUpgradeClose = () => {
  setShowUpgradeModal(false);
  if (pauseTutorial) {
    setPauseTutorial(false);  // チュートリアル再開
  }
};

// 3. Joyride設定を修正
<Joyride
  steps={tutorialSteps}
  run={runTutorial && !pauseTutorial}  // 一時停止フラグを追加
  // ... 他の設定
/>

// 4. UsageStatusBarコンポーネントでのクリックハンドラ修正
<UsageStatusBar onUpgradeClick={handleUpgradeClick} />
```

##### 解決案B: z-indexの調整

**実装箇所**: `UpgradeModal.tsx` または CSS

```tsx
// モーダルのz-indexをチュートリアルより高く設定
<div className="fixed inset-0 z-[10001] ...">
  {/* モーダルコンテンツ */}
</div>
```

ただし、この方法ではチュートリアルが完全に隠れてしまい、ユーザーがチュートリアル中であることを忘れる可能性があります。

##### 解決案C: チュートリアル中はアップグレードボタンを無効化

```tsx
// チュートリアル中はボタンをグレーアウト
<UsageStatusBar
  onUpgradeClick={handleUpgradeClick}
  disabled={runTutorial}  // チュートリアル中は無効
/>
```

**非推奨**: ユーザーの自由な操作を制限するため、UX的に良くない

#### 推奨実装: 解決案A（一時停止）

**理由**:
- ユーザーの意図を尊重（アップグレードしたい→見せる）
- チュートリアルの進行状態を保持
- 操作の自由度を保つ

#### 影響範囲
- `MyPage.tsx`: チュートリアル一時停止ロジック追加
- `UsageStatusBar.tsx`: クリックハンドラの引数変更（必要に応じて）
- ユーザー体験の改善

#### 工数見積もり
- **実装**: 0.5時間
- **テスト**: 0.3時間
- **レビュー**: 0.2時間
- **合計**: 1.0時間

---

### No.2 チュートリアル自動起動時にsessionStorage未設定

#### 課題内容
マイページでチュートリアルが自動起動した際、`sessionStorage.setItem('tutorial_in_progress', 'true')` が実行されないため、「シミュレーション結果を見る」ボタンを押してSimulator画面に遷移しても、チュートリアルが継続されない。

#### 現状の問題点

**なぜ「使い方を確認」ボタンを手動で押すと動くのか？**

手動ボタンクリック時は `sessionStorage.setItem('tutorial_in_progress', 'true')` が実行されるため、その後「シミュレーション結果を見る」をクリックすると、Simulator画面で正常にチュートリアルが継続されます。

**手動起動時（正常動作）**:
1. 「使い方を確認」ボタンクリック
2. `sessionStorage.setItem('tutorial_in_progress', 'true')` が実行される ✅
3. チュートリアルステップ1表示
4. 「シミュレーション結果を見る」クリック
5. Simulator画面に遷移
6. `sessionStorage.getItem('tutorial_in_progress')` が `'true'` を返す ✅
7. チュートリアル継続処理が実行される ✅

**自動起動時（問題発生）**:
1. マイページに初回アクセス
2. 1.5秒後にチュートリアル自動起動（sessionStorage未設定）❌
3. チュートリアルステップ1表示
4. 「シミュレーション結果を見る」クリック
5. Simulator画面に遷移
6. `sessionStorage.getItem('tutorial_in_progress')` が `null` を返す ❌
7. チュートリアル継続処理がスキップされる ❌
8. 結果エリアに自動スクロールされるが、チュートリアルは表示されない

---

**MyPage.tsx (642-656行目)**:
```tsx
// 初回サンプル物件表示時に自動でチュートリアルを開始
React.useEffect(() => {
  if (!hasSeenTutorial && !loading) {
    const onlyHasSample = simulations.length === 0 ||
      (simulations.length === 1 && hasSampleInDB);

    if (onlyHasSample) {
      setTimeout(() => {
        setRunTutorial(true);  // ⚠️ sessionStorageを設定していない！
      }, 1500);
    }
  }
}, [hasSeenTutorial, simulations.length, hasSampleInDB, loading]);
```

**対照: 手動起動の場合 (627-638行目)**:
```tsx
const handleStartTutorial = () => {
  console.log('チュートリアル開始');
  sessionStorage.setItem('tutorial_in_progress', 'true');  // ✅ 正しく設定されている
  setRunTutorial(false);
  setTimeout(() => {
    setRunTutorial(true);
  }, 100);
};
```

**結果**:
1. マイページでチュートリアル表示される（正常）
2. ボタンをクリックしてSimulator画面に遷移
3. Simulator側で `sessionStorage.getItem('tutorial_in_progress')` が `null` を返す
4. チュートリアル継続処理がスキップされる
5. 結果表示エリアに自動スクロールされるが、チュートリアルは表示されない

#### 解決方法

**MyPage.tsx の自動起動処理を修正**:

```tsx
// 初回サンプル物件表示時に自動でチュートリアルを開始
React.useEffect(() => {
  if (!hasSeenTutorial && !loading) {
    const onlyHasSample = simulations.length === 0 ||
      (simulations.length === 1 && hasSampleInDB);

    if (onlyHasSample) {
      setTimeout(() => {
        // sessionStorageにフラグをセット（追加）
        sessionStorage.setItem('tutorial_in_progress', 'true');
        setRunTutorial(true);
      }, 1500);
    }
  }
}, [hasSeenTutorial, simulations.length, hasSampleInDB, loading]);
```

#### 影響範囲
- `MyPage.tsx`: 自動起動処理の1行追加のみ
- Simulator画面: 変更なし（既存のチュートリアル継続処理が正常動作するようになる）

#### 検証方法
1. ブラウザのLocalStorageをクリア
2. 新規ユーザーとしてマイページにアクセス
3. 1.5秒後にチュートリアルが自動起動することを確認
4. 「シミュレーション結果を見る」ボタンをクリック
5. Simulator画面に遷移後、チュートリアルのステップ2が表示されることを確認

#### 工数見積もり
- **実装**: 0.1時間（1行追加）
- **テスト**: 0.3時間
- **レビュー**: 0.1時間
- **合計**: 0.5時間

---

### No.3 ステップ2でターゲット要素が見つからず次へボタンが動作しない

#### 課題内容
Simulator画面でチュートリアルステップ2が表示された後、「次へ」ボタンを押しても何も起きず、次のステップに進まない。

#### 現状の問題点と技術的理由

**React Joyrideの動作原理**

React Joyrideは以下の順序で動作します：
1. `target` プロパティで指定されたCSSセレクタを使ってDOM要素を検索
2. 要素が見つかったら、その要素の位置を取得（`getBoundingClientRect()`）
3. 要素の周りにスポットライト（ハイライト）を表示
4. ツールチップ（説明文）を適切な位置に配置
5. 要素が**画面内に表示されている**場合のみ、正常に次のステップへ進める

**問題1: ターゲット要素は存在するが、画面外にある**

Simulator.tsx (1854行目):
```tsx
<div data-field="propertyName">  // ✅ 要素は存在する
  <label>物件名</label>
  <input ... />
</div>
```

しかし、サンプル物件から遷移した時：
1. データが自動入力される
2. **結果が既に表示される**（loadExistingData内で `setSimulationResults` が実行）
3. ページが結果エリアに自動スクロールされる
4. 入力フォーム（`data-field="propertyName"`）が**画面外（上部）**に隠れる

**Joyrideの制約**:
- ターゲット要素が画面外にある場合、Joyrideは要素の位置を正確に取得できない
- `getBoundingClientRect()` は取得できるが、ツールチップの配置位置が不正確になる
- 結果として「次へ」ボタンが正常に機能しないことがある

**問題2: disableScrolling の設定**

Simulator.tsx (88行目):
```tsx
disableScrolling: false,  // スクロールを有効化
```

この設定により：
- Joyrideは自動的にターゲット要素へスクロールしようとする
- しかし、**結果エリアの自動スクロール処理と競合**する
- 2つのスクロール処理が同時に実行され、正しい位置に移動できない

**問題3: チュートリアルステップの開始位置が不適切**

サンプル物件から遷移した時、既に結果が表示されているにも関わらず、ステップ2（入力フォーム説明）から開始している。

Simulator.tsx (572行目):
```tsx
setTimeout(() => {
  setRunTutorial(true);
  setTutorialStep(0); // ステップ2（インデックス0）から開始
}, 500);
```

この時点で：
- サンプル物件のデータは既にロード済み
- **結果も既に表示されている**（801行目の `setSimulationResults` が実行済み）
- 入力フォームは画面外（上部）
- チュートリアルは画面外の要素を指している

**なぜ「次へ」ボタンが動作しないのか？まとめ**

1. **ターゲット要素が画面外**: `data-field="propertyName"` は存在するが、ページが結果エリアにスクロール済み
2. **Joyrideのレンダリング問題**: 画面外の要素に対してツールチップを配置しようとして失敗
3. **スクロール競合**: チュートリアルのスクロール処理と結果エリアへの自動スクロールが競合
4. **次へボタンのイベントハンドラが正常に機能しない**: 要素の位置が不正確なため、次のステップへの遷移が失敗

#### 解決方法

**解決案A: ターゲット要素を確実に存在する要素に変更（推奨）**

```tsx
// Before: 存在しない可能性がある
target: '[data-field="propertyName"]',

// After: 確実に存在するコンテナを指定
target: '.property-form-container',  // または '.property-info-section'
```

**解決案B: サンプル物件の場合は結果ステップから開始**

```tsx
// サンプル物件からの遷移時
if (fromTutorial === 'true') {
  // 既に結果が表示されているかチェック
  if (simulation.results) {
    // ステップ4（評価額と投資指標）から開始
    setTimeout(() => {
      setRunTutorial(true);
      setTutorialStep(2); // インデックス2 = ステップ4
    }, 500);
  } else {
    // 結果がない場合のみステップ2から
    setTimeout(() => {
      setRunTutorial(true);
      setTutorialStep(0);
    }, 500);
  }
}
```

**解決案C: ターゲット要素の存在確認を追加**

```tsx
const tutorialSteps = React.useMemo<Step[]>(() => {
  const steps: Step[] = [];

  // ターゲット要素の存在確認
  const hasPropertyForm = document.querySelector('[data-field="propertyName"]') !== null;

  if (hasPropertyForm) {
    // ステップ2を追加
    steps.push({
      target: '[data-field="propertyName"]',
      // ...
    });
  }

  // ...残りのステップ
}, [simulationResults]); // 依存配列に simulationResults を追加
```

#### 推奨実装: 解決案A + 解決案B の組み合わせ

1. **ターゲット要素を確実に存在する要素に変更**
2. **サンプル物件表示時は結果の有無で開始ステップを判定**

#### 影響範囲
- `Simulator.tsx`:
  - tutorialSteps の target セレクタ変更（75行目）
  - サンプル物件遷移時のチュートリアル開始ロジック修正（549-609行目）

#### 検証方法
1. マイページで「使い方を確認」ボタンをクリック
2. チュートリアルステップ1表示を確認
3. 「シミュレーション結果を見る」ボタンをクリック
4. Simulator画面に遷移
5. チュートリアルステップ2が表示されることを確認
6. **「次へ」ボタンをクリック**
7. ステップ3（シミュレーション実行ボタン）に進むことを確認

#### 工数見積もり
- **実装**: 0.5時間
- **テスト**: 0.3時間
- **レビュー**: 0.2時間
- **合計**: 1.0時間

---

## ステータス凡例
- 🔴 未着手
- 🟡 進行中
- 🟢 完了
- 🔵 レビュー中
- ⚫ 保留

## 優先度凡例
- **高**: 即対応必要
- **中**: 次回スプリント
- **低**: 時間があれば対応

---

---

## 🧪 検証準備（新規ユーザー状態の再現）

### LocalStorage/SessionStorageのクリア手順

課題を検証するには、新規ユーザーの状態を再現する必要があります。

**方法1: ブラウザの開発者ツールを使用（推奨）**

1. **開発者ツールを開く**
   - Chrome/Edge: `F12` または `Ctrl+Shift+I`
   - Firefox: `F12`

2. **Applicationタブ（Chromeの場合）/ Storageタブ（Firefoxの場合）を開く**

3. **LocalStorageをクリア**
   - 左メニューから「Local Storage」→ サイトのURLを選択
   - 以下のキーを削除：
     - `tutorial_completed_{user.id}` （ユーザーIDは実際の値）
     - `hasCompletedTutorial` （旧バージョン互換）
     - `simulations_cache_{user.id}`
     - `simulations_cache_timestamp_{user.id}`
   - または「Clear All」で全削除

4. **SessionStorageをクリア**
   - 左メニューから「Session Storage」→ サイトのURLを選択
   - `tutorial_in_progress` を削除
   - または「Clear All」で全削除

5. **ページをリロード**: `Ctrl+R` または `F5`

**方法2: コンソールからクリア（簡単）**

開発者ツールのConsoleタブで以下を実行：

```javascript
// LocalStorageを全削除
localStorage.clear();

// SessionStorageを全削除
sessionStorage.clear();

// ページをリロード
location.reload();
```

**方法3: シークレットモード/プライベートウィンドウ（最も確実）**

- Chrome: `Ctrl+Shift+N`
- Firefox: `Ctrl+Shift+P`
- Edge: `Ctrl+Shift+N`

シークレットモードでは、LocalStorage/SessionStorageが空の状態で開始されます。

---

### 検証前のチェックリスト

実装後、以下の順序で検証してください：

#### ✅ 課題No.2の検証
1. [ ] LocalStorage/SessionStorageをクリア
2. [ ] マイページにアクセス
3. [ ] 1.5秒後にチュートリアルが自動起動することを確認
4. [ ] ブラウザの開発者ツールで `sessionStorage.getItem('tutorial_in_progress')` が `'true'` であることを確認
5. [ ] 「シミュレーション結果を見る」ボタンをクリック
6. [ ] Simulator画面でチュートリアルステップ2が表示されることを確認

#### ✅ 課題No.3の検証
1. [ ] Simulator画面でステップ2が表示される
2. [ ] ターゲット要素が画面内に表示されている
3. [ ] 「次へ」ボタンをクリック
4. [ ] ステップ3（シミュレーション実行ボタン）に正常に進む
5. [ ] 以降のステップも正常に進む

#### ✅ 課題No.1の検証
1. [ ] チュートリアル表示中に「今すぐアップグレード」ボタンをクリック
2. [ ] アップグレードモーダルが正常に表示される
3. [ ] チュートリアルが一時停止される
4. [ ] モーダルを閉じる
5. [ ] チュートリアルが再開される

---

## 📝 課題記録エリア

<!-- 以下に課題を記載してください -->


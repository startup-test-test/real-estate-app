# 開発日報 2025年8月10日（第2報）

## 1. 本日の追加作業概要

### 🎯 主要タスク
シナリオテストで発見された17件のバグ修正作業を実施。特にCCR計算バグとNOI計算問題に対応。

### 📊 作業統計
- **作業時間**: 約4時間（第1報から追加）
- **コミット数**: 5件追加
- **対応したバグ**: CCR自己資金計算バグ（BUG_019関連）、NOI計算問題
- **修正したファイル**: backend/simulator-api/app.py, shared/calculations.py, bolt_front/src/pages/Simulator.tsx
- **作成したテスト**: 3ファイル（test_amanuma_direct.py, test_amanuma_api.py, test_ccr_issue.py）

## 2. CCR自己資金計算バグの修正

### 🔍 問題の詳細
ChatGPTの分析により17件のバグが特定され、「CCR自己資金計算バグ_課題管理表.md」として管理。

### 主要な修正内容

#### 1. **CCR計算のN/A表示対応**
- **問題**: 自己資金がマイナスまたはゼロの場合でも0.00%と表示
- **修正内容**:
  ```python
  # backend/simulator-api/shared/calculations.py
  def calculate_ccr_first_year(first_year_cf: float, self_funding: float) -> Optional[float]:
      if self_funding <= 0:
          return None  # 自己資金≤0の場合はNone（N/A）
      return (first_year_cf / (self_funding * 10000)) * 100
  ```
- **フロントエンド対応**:
  ```typescript
  // CCR表示部分
  {simulationResults?.results['CCR（初年度）（%）'] !== null && 
   simulationResults?.results['CCR（初年度）（%）'] !== undefined 
     ? `${simulationResults.results['CCR（初年度）（%）'].toFixed(2)}%` 
     : 'N/A'}
  ```
- **結果**: ✅ 天沼物件でN/A表示確認済み

#### 2. **NOI計算の固定資産税反映問題**
- **問題**: NOIが285万円（固定資産税15万円が引かれていない）
- **期待値**: 270万円（300万円 - 管理費15万円 - 固定資産税15万円）
- **原因**: フロントエンドからバックエンドへのパラメータ名不一致
  - フロントエンド: キャメルケース（propertyTax）
  - バックエンド: スネークケース（property_tax）

### 修正実装

#### バックエンドのパラメータ変換処理追加
```python
# backend/simulator-api/app.py
# キャメルケースからスネークケースへの変換
if 'propertyTax' in property_data:
    property_data['property_tax'] = property_data.get('propertyTax', 0)
if 'fixedCost' in property_data:
    property_data['fixed_cost'] = property_data.get('fixedCost', 0)
if 'managementFee' in property_data:
    property_data['management_fee'] = property_data.get('managementFee', 0)
# ... 他のパラメータも同様に変換
```

追加変換パラメータ:
- buildingPriceForDepreciation → building_price
- exitCapRate → exit_cap_rate
- priceDeclineRate → price_decline_rate
- rentDecline → rent_decline
- majorRepairCycle → major_repair_cycle
- majorRepairCost → major_repair_cost

## 3. テスト実施状況

### 🧪 作成したテストスクリプト

#### 1. **test_amanuma_direct.py**
天沼物件の直接計算テスト
- キャメルケース変換なし: NOI 0円（エラー）
- 手動変換後: NOI 270万円（正常）
- ✅ ローカルで正常動作確認

#### 2. **test_amanuma_api.py**
API経由での天沼物件テスト
- キャメルケースでAPIに送信
- NOI: 270万円（期待通り）
- CCR: None（N/A表示）
- ✅ APIレベルで正常動作確認

#### 3. **test_ccr_issue.py**
木崎物件のCCR計算問題調査
- 自己資金: 600万円（正しく計算）
- CCR（初年度）: -11.18%（バックエンド正常）
- フロントエンド表示: -67.06%（表示バグ）

### curlテストによる検証
```bash
curl -X POST https://real-estate-app-rwf1.onrender.com/api/simulate \
  -H "Content-Type: application/json" \
  -d '{"property_name": "天沼物件テスト", ...}'
```
結果: NOI = 2700000（270万円）✅

## 4. デプロイと本番環境の状況

### 🚀 デプロイ履歴
1. **commit 88b3b86**: キャメルケース変換の追加実装
2. **commit cf6381f**: TypeScriptエラー修正
3. **commit 09d534d**: デバッグログ追加

### 📊 本番環境（Render）の状況
- **バックエンドAPI**: ✅ 正常動作（curlテストで確認）
- **フロントエンド表示**:
  - CCR: ✅ N/A表示（修正完了）
  - NOI: ❌ 285万円のまま（未反映）

## 5. 課題と対応状況

### 🔍 現在の問題

#### NOI計算問題の原因分析
1. **バックエンドAPI**: ✅ 正しく270万円を返す
2. **フロントエンドコード**: ✅ 正しくproperty_taxを送信
3. **問題の可能性**:
   - Vercelのデプロイが最新版でない
   - ブラウザキャッシュの問題
   - フロントエンドビルドの遅延

### 確認事項
開発者ツールで以下を確認必要:
- Networkタブ: property_taxの送信値
- Consoleタブ: デバッグログの出力
- Payloadの内容確認

## 6. 技術的な改善点

### 🔧 実装した改善

1. **型安全性の向上**
   - Optional[float]型の活用でNone値を適切に扱う
   - TypeScriptでのnullチェック強化

2. **デバッグ機能の追加**
   ```typescript
   // フロントエンドのログ出力
   console.log('入力値（inputs）:', {
     propertyTax: inputs.propertyTax,
     managementFee: inputs.managementFee
   });
   console.log('API送信データ:', apiData);
   console.log('CCR（初年度）:', result.results?.['CCR（初年度）（%）']);
   ```

3. **テスト基盤の構築**
   - 単体テストスクリプトの作成
   - API統合テストの実装
   - curlによる本番環境テスト

## 7. 成果と残課題

### ✅ 完了した修正
1. CCR自己資金≤0時のN/A表示
2. バックエンドのキャメルケース変換処理
3. テストスクリプトの作成と実行
4. デバッグログの追加

### ❌ 未解決の課題
1. **NOI表示問題**: フロントエンドで285万円表示（期待値270万円）
2. **木崎物件CCR表示**: -67.06%（期待値-11.18%）
3. **Vercelデプロイ状況**: 最新版の反映確認必要

### 📝 次のアクション
1. Vercelのデプロイログ確認
2. ブラウザキャッシュのクリア指示
3. 開発者ツールでのデバッグ情報収集
4. 必要に応じてVercelの再デプロイ

## 8. まとめ

本日は17件のシナリオテストバグのうち、特に重要なCCR計算とNOI計算の問題に取り組みました。

### 🎯 主な成果
1. **CCR N/A表示**: 完全修正済み
2. **バックエンドAPI**: 正常動作確認済み
3. **テスト環境**: 整備完了
4. **デバッグ体制**: 構築済み

### 📈 進捗状況
- シナリオテストバグ: 2/17件対応中
- バックエンド修正: 完了
- フロントエンド反映: 確認中

### 💡 学んだこと
1. キャメルケース/スネークケース変換の重要性
2. 本番環境とローカル環境の差異への対処
3. 段階的なデバッグアプローチの有効性

本番環境への反映確認が完了すれば、主要なバグ修正は完了となります。

---
作成日時: 2025年8月10日 18:00  
作成者: 開発チーム
# Edge Function エラー詳細分析

## エラーが発生する根本原因

### 1. **Stripeテストデータの不一致** (主原因)
- **問題の詳細**:
  - DBに保存されているstripe_subscription_id: `sub_test_123`
  - これは開発時に作成したダミーID
  - Stripeの実際のAPIには存在しない
  - Stripe APIを呼び出すと「No such subscription」エラー

### 2. **データベースの不整合**
- **発見された問題**:
  - user_idが空白のレコードが存在していた（削除済み）
  - 複数のsubscriptionレコードが混在
  - auth.uid()がSQL Editor経由では正しく動作しない

### 3. **Edge Functionの設計問題**
- **現在の実装**:
  ```javascript
  // Stripe APIを必ず呼び出す設計
  const stripeSubscription = await stripe.subscriptions.update(
    subscription.stripe_subscription_id,  // sub_test_123
    { cancel_at_period_end: true }
  )
  ```
- **問題点**:
  - テストデータの場合の分岐処理がない
  - Stripeエラーを想定したフォールバック処理がない

## なぜこのエラーが起きているか

### 実行フロー:
1. ユーザーが「プランを解約」ボタンをクリック
2. フロントエンドがEdge Function `cancel-subscription`を呼び出し
3. Edge FunctionがDBから`sub_test_123`を取得
4. Stripe APIに`sub_test_123`の更新をリクエスト
5. **Stripeが「そんなサブスクリプションは存在しない」とエラーを返す** ← ここでエラー
6. Edge Functionが500エラーを返す
7. フロントエンドに「Edge Function returned a non-2xx status code」が表示

## 解決策

### 短期的解決策（すぐできる）:
1. **簡易版Edge Functionに戻す**
   - Stripe連携を一時的に無効化
   - DBの更新のみ行う

2. **テストモード判定を追加**
   ```javascript
   if (subscription.stripe_subscription_id.startsWith('sub_test_')) {
     // テストデータの場合はStripeをスキップ
     // DBのみ更新
   } else {
     // 本番データの場合はStripe APIを呼ぶ
   }
   ```

### 長期的解決策:
1. **実際のStripeサブスクリプションを作成**
   - Stripeダッシュボードでテスト顧客を作成
   - 実際のサブスクリプションIDを取得
   - DBを更新

2. **エラーハンドリングの改善**
   - Stripeエラーを適切にキャッチ
   - ユーザーフレンドリーなエラーメッセージ
   - フォールバック処理の実装

## テスト環境の現状

```sql
-- 現在のDBの状態
subscriptions テーブル:
- id: [UUID]
- user_id: [実際のユーザーID]
- stripe_customer_id: 'cus_test_123'  -- 存在しない
- stripe_subscription_id: 'sub_test_123'  -- 存在しない
- status: 'active'
- cancel_at_period_end: false
```

## 推奨アクション

1. **即座の対応**: 簡易版Edge Functionに戻す
2. **次のステップ**: テストモード判定を実装
3. **最終目標**: 実際のStripe統合テスト環境の構築
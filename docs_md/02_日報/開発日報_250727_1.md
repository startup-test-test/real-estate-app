# 開発日報 2025年7月27日

## 1. 本日の作業概要

### 🎯 主要タスク
本日は、Xserverへの自動デプロイシステムの構築に取り組みました。GitHub ActionsとFTPを組み合わせて、開発環境（dev.ooya.tech）への自動デプロイパイプラインを完成させました。

### 📊 作業統計
- **作業時間**: 約3時間
- **コミット数**: 15件
- **解決した課題**: 5件
- **作成したドキュメント**: 7件

## 2. 実装内容

### 🚀 CI/CDパイプラインの構築

#### 1. **GitHub Actions ワークフローの作成**
```yaml
# 主要なワークフロー
- deploy-to-xserver-dev.yml     # 開発環境への自動デプロイ
- deploy-to-xserver.yml         # 本番環境用（今後使用）
- manual-deploy.yml            # 手動デプロイ用
- test-ftp-connection.yml      # FTP接続テスト用
```

#### 2. **環境変数管理システムの整備**
- GitHub Secretsの設定
  - FTP接続情報（HOST、USERNAME、PASSWORD、PORT）
  - 開発環境用環境変数（DEV_SUPABASE_URL、DEV_SUPABASE_ANON_KEY、DEV_API_BASE_URL）
- ビルド時の環境変数埋め込み処理

#### 3. **デプロイプロセスの最適化**
```
developブランチへのpush
    ↓
GitHub Actions起動
    ↓
環境変数設定 + ビルド
    ↓
FTPで自動アップロード
    ↓
dev.ooya.techに反映
```

### 📁 ドキュメント整備

#### 作成したドキュメント
1. **本番環境アップロード手順書** → **Xserver本番環境デプロイ完全ガイド**（統合版）
2. **Xserverアップロードファイル一覧**（上記に統合）
3. **Xserver仕様確認チェックリスト**
4. **GitHub_Secrets設定ガイド**
5. **環境変数設定完全ガイド**（4ファイルを統合）
6. **Render_API仕様書**
7. **Supabase認証とセキュリティの仕組み**

#### ドキュメントの再構成
- `98_環境変数/` フォルダに環境変数関連ドキュメントを集約
- `99_サーバーにアップロード方法/` フォルダにデプロイ関連ドキュメントを集約

## 3. 解決した技術的課題

### 🔧 課題と解決策

#### 1. **サブドメインのディレクトリ構造問題**
- **問題**: デプロイ先が `/public_html/dev/` ではなく `/ooya.tech/public_html/dev.ooya.tech/` だった
- **解決**: FTPアクションのserver-dirパスを正しく修正

#### 2. **403 Forbiddenエラー**
- **問題**: ファイルアップロード後、アクセス時に403エラー
- **解決**: .htaccessにアクセス許可とDirectoryIndex設定を追加

#### 3. **ファイルが部分的にしかアップロードされない**
- **問題**: .htaccessのみアップロードされ、distフォルダの中身が無視される
- **解決**: FTP同期状態ファイルをリセット、dangerous-clean-slateオプションを使用

#### 4. **環境変数が読み込まれない**
- **問題**: Supabase URLが無効でアプリケーションがエラー
- **解決**: GitHub Secretsの値を修正、ビルド時に正しく埋め込まれるよう確認

#### 5. **GitHub Actionsの手動実行ボタンが表示されない**
- **問題**: workflow_dispatchを設定してもRun workflowボタンが出ない
- **解決**: 自動デプロイを一時的に有効化して対応

### 🛠️ 技術的な学び

#### Xserverの仕様理解
- サブドメインは独自のディレクトリ構造を持つ
- 静的ファイルホスティングのみ対応（Node.js/Python非対応）
- .htaccessでSPAルーティングとキャッシュ制御が可能

#### Viteビルドとデプロイの仕組み
- 環境変数はビルド時にJavaScriptに埋め込まれる
- 公開可能なキー（Anon Key）のみフロントエンドで使用
- Service Keyはバックエンド専用で秘匿

## 4. セキュリティに関する重要な理解

### 🔐 Supabaseのセキュリティモデル
1. **3種類のキー**
   - URL: 公開可能（APIエンドポイント）
   - Anon Key: 公開可能（RLSで保護）
   - Service Key: 秘匿（管理者権限）

2. **なぜAnon Keyを公開しても安全か**
   - Anon Key単体ではデータアクセス不可
   - ユーザー認証（メール/パスワード）が必須
   - Row Level Security (RLS) でデータを保護

3. **実装されたセキュリティ**
   - すべてのテーブルでRLS有効
   - ユーザーは自分のデータのみアクセス可能
   - SQLインジェクション対策も自動的に適用

## 5. 今後の課題と改善点

### 📋 残タスク
1. **本番環境のデプロイ設定**
   - mainブランチ → ooya.tech への自動デプロイ
   - 本番用環境変数の設定

2. **APIセキュリティの強化**
   - 現在のRender APIは認証なし
   - CORS設定またはSupabase認証連携を検討

3. **モニタリングとログ**
   - デプロイ成功/失敗の通知設定
   - エラーログの収集と分析

### 🎯 次回の作業予定
1. 本番環境のデプロイパイプライン構築
2. Basic認証の設定（開発環境保護）
3. パフォーマンス最適化（画像圧縮、CDN検討）

### 📌 残課題
1. **テスト環境のXserver連携**
   - 現在はdev.ooya.techへの基本的なデプロイのみ完了
   - 詳細な連携設定やカスタマイズが必要
   
2. **API仕様書の整理**
   - Render APIとSupabase APIの仕様書は作成済み
   - より詳細な整理と実装例の追加が必要
   
3. **テスト環境でのデバッグ**
   - dev.ooya.techでの動作確認とデバッグツールの設定
   - ログ収集とエラー監視の仕組み構築

## 6. コミット履歴

### 午前の作業（環境構築とドキュメント作成）
```
08:30-09:30  環境変数とデプロイ手順のドキュメント作成
09:30-10:30  GitHub ActionsとFTP設定
10:30-11:00  デプロイテストと問題解決
```

### 午後の作業（デバッグと最適化）
```
14:00-15:00  サブドメインディレクトリ問題の調査と修正
15:00-16:00  403エラーとファイルアップロード問題の解決
16:00-16:30  環境変数設定とテスト
```

### 主要コミット
- `b24f317` - feat: 環境変数管理とXserver連携の設定を改善
- `946de73` - fix: Xserverの正しいサブドメインディレクトリに修正
- `2407966` - fix: 403エラーを解決するためアクセス許可を追加
- `5022f6c` - fix: FTP同期状態をリセットして全ファイルを再アップロード
- `96a571e` - fix: 環境変数を修正して再デプロイ

## 7. 成果物

### ✅ 完成したもの
1. **開発環境の自動デプロイシステム**
   - GitHub Actions によるCI/CDパイプライン
   - developブランチへのpushで自動デプロイ

2. **包括的なドキュメント群**
   - デプロイ手順の完全ガイド
   - 環境変数設定の詳細説明
   - トラブルシューティングガイド

3. **セキュアな環境変数管理**
   - GitHub Secretsによる秘密情報の管理
   - ビルド時の環境変数埋め込み
   - 公開/非公開情報の適切な分離

### 📊 プロジェクトの現状
- **開発環境**: https://dev.ooya.tech/ （正常稼働）
- **本番環境**: 未設定（次回作業予定）
- **バックエンドAPI**: Render.comで稼働中
- **データベース**: Supabaseで運用中

## 8. まとめ

本日は、Xserverへの自動デプロイシステムの構築に成功しました。いくつかの技術的な課題に直面しましたが、すべて解決し、安定した開発環境のCI/CDパイプラインを確立できました。

特に重要な成果として、環境変数の管理方法とセキュリティモデルについての理解を深め、それを分かりやすくドキュメント化できたことが挙げられます。これにより、今後の開発作業がより効率的になることが期待されます。

次回は本番環境のデプロイ設定と、さらなるセキュリティ強化に取り組む予定です。

---
作成日時: 2025年7月27日
作成者: 開発チーム
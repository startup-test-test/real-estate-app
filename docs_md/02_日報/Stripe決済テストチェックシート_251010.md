# Stripe決済フロー 実機テストチェックシート

**テスト日**: 2025年10月10日
**テスト環境**: dev.ooya.tech
**テスト実施者**: 東後様
**テストアカウント**: togo@startup-marketing.co.jp / gomesu

---

## テスト前の確認事項

### Stripe環境確認
- [ ] テスト環境のStripe Publishable Keyがテストモード（pk_test_...）であることを確認
- [ ] Stripe Price IDがテストモード価格であることを確認
- [ ] Stripe Webhookが開発環境URL向けに設定されていることを確認

### テストカード情報（Stripe公式）
| 用途 | カード番号 | 有効期限 | CVC | 備考 |
|------|-----------|---------|-----|------|
| **正常決済** | `4242 4242 4242 4242` | 任意の未来日 | 任意の3桁 | 最も基本的な成功パターン |
| **3Dセキュア成功** | `4000 0027 6000 3184` | 任意の未来日 | 任意の3桁 | 追加認証画面が表示される |
| **カード拒否** | `4000 0000 0000 0002` | 任意の未来日 | 任意の3桁 | 一般的なカード拒否エラー |
| **残高不足** | `4000 0000 0000 9995` | 任意の未来日 | 任意の3桁 | 残高不足エラー |
| **CVCエラー** | `4000 0000 0000 0127` | 任意の未来日 | 任意の3桁 | CVCチェック失敗 |

---

## 1. 正常系テスト（必須）

### 1-1. 【最重要】新規登録→即時アップグレード
**目的**: 最も基本的な決済フローの確認

**手順**:
1. [ ] `dev.ooya.tech` にアクセス
2. [ ] ログイン: `togo@startup-marketing.co.jp` / `gomesu`
3. [ ] ダッシュボードが表示されることを確認
4. [ ] UsageStatusBarに「今月の利用状況: X/5回」と表示されているか確認
5. [ ] 「今すぐアップグレード」ボタンをクリック
6. [ ] Stripe Checkoutページが表示されることを確認
7. [ ] テストカード `4242 4242 4242 4242` を入力
   - 有効期限: `12/30`（任意の未来日）
   - CVC: `123`（任意の3桁）
   - 郵便番号: `100-0001`（任意）
8. [ ] 「支払う」ボタンをクリック
9. [ ] 決済完了後、MyPageにリダイレクトされることを確認
10. [ ] UsageStatusBarに「ベーシックプラン」「全機能が無制限でご利用いただけます」と表示されるか確認

**期待結果**:
- [ ] 決済が正常に完了
- [ ] ベーシックプランに変更されている
- [ ] AI市場分析・収益シミュレーション・公示地価検索が無制限で利用可能

**実際の結果**:
```
（ここにテスト結果を記入）


```

---

### 1-2. 【重要】無料プランで5回使用→制限到達→アップグレード
**目的**: 使用制限とアップグレード促進の動作確認

**手順**:
1. [ ] 無料プランの状態を確認（「X/5回」表示）
2. [ ] AI市場分析で任意の住所を入力して実行（例: 東京都渋谷区）
3. [ ] 実行後、カウントが増えることを確認（「X+1/5回」）
4. [ ] 合計5回実行する
5. [ ] 6回目の実行時に「無料利用枠を使い切りました」モーダルが表示されるか確認
6. [ ] 「今すぐアップグレード」ボタンからStripe Checkoutへ遷移
7. [ ] テストカードで決済完了
8. [ ] 即座に機能が無制限で利用可能になるか確認

**期待結果**:
- [ ] 5回まで正常に実行可能
- [ ] 6回目で制限到達モーダル表示
- [ ] 決済後、即座に無制限利用可能

**実際の結果**:
```
（ここにテスト結果を記入）


```

---

### 1-3. 3Dセキュア認証テスト
**目的**: 追加認証フローの動作確認

**手順**:
1. [ ] 「今すぐアップグレード」から決済画面へ
2. [ ] テストカード `4000 0027 6000 3184` を入力
3. [ ] 3Dセキュア認証画面が表示されることを確認
4. [ ] 「Complete authentication」または「認証を完了」ボタンをクリック
5. [ ] 決済が完了することを確認

**期待結果**:
- [ ] 3Dセキュア認証画面が表示される
- [ ] 認証完了後、正常に決済完了

**実際の結果**:
```
（ここにテスト結果を記入）


```

---

## 2. 異常系テスト（推奨）

### 2-1. カード拒否エラー
**目的**: エラーメッセージの表示確認

**手順**:
1. [ ] アップグレード画面でテストカード `4000 0000 0000 0002` を入力
2. [ ] 決済実行
3. [ ] エラーメッセージが日本語で表示されるか確認
4. [ ] 「カードが拒否されました」等のメッセージが表示されるか

**期待結果**:
- [ ] わかりやすい日本語エラーメッセージ表示
- [ ] 再試行可能な状態

**実際の結果**:
```
（ここにテスト結果を記入）


```

---

### 2-2. 決済キャンセル
**目的**: キャンセルフローの確認

**手順**:
1. [ ] Stripe Checkoutページを開く
2. [ ] 左上の「←」戻るボタンをクリック
3. [ ] 元のページ（MyPage）に戻ることを確認
4. [ ] 無料プランのままであることを確認

**期待結果**:
- [ ] エラーなく元のページに戻る
- [ ] プラン変更なし

**実際の結果**:
```
（ここにテスト結果を記入）


```

---

## 3. サブスクリプション管理テスト（重要）

### 3-1. プラン解約
**目的**: 解約機能の動作確認

**手順**:
1. [ ] ベーシックプラン契約中の状態を確認
2. [ ] MyPage → 「プラン管理」 または 「設定」
3. [ ] 「プランを解約」ボタンをクリック
4. [ ] 確認モーダルで「解約する」を選択
5. [ ] UsageStatusBarに「解約予定」「利用期限: YYYY/MM/DD（あとN日）」と表示されるか確認

**期待結果**:
- [ ] 解約予定状態に変更
- [ ] 期限まで全機能が利用可能
- [ ] 「解約を取り消す」ボタンが表示される

**実際の結果**:
```
（ここにテスト結果を記入）


```

---

### 3-2. 解約取り消し（再開）
**目的**: 解約取り消し機能の確認

**手順**:
1. [ ] 解約予定状態を確認
2. [ ] UsageStatusBarの「解約を取り消す」ボタンをクリック
3. [ ] 「ベーシックプランを継続します」アラートが表示されるか確認
4. [ ] 通常のベーシックプラン表示に戻るか確認

**期待結果**:
- [ ] 解約が取り消される
- [ ] 通常のベーシックプラン表示に戻る

**実際の結果**:
```
（ここにテスト結果を記入）


```

---

## 4. 統合カウントテスト（必須）

### 4-1. 複数機能での統合カウント確認
**目的**: AI市場分析・収益シミュレーション・公示地価検索が統合カウントされることを確認

**手順**:
1. [ ] 無料プランの状態を確認（「0/5回」）
2. [ ] AI市場分析を1回実行 → 「1/5回」表示を確認
3. [ ] 収益シミュレーションを1回実行 → 「2/5回」表示を確認
4. [ ] 公示地価検索を1回実行 → 「3/5回」表示を確認
5. [ ] カウントが統合されていることを確認

**期待結果**:
- [ ] 3つの機能が同一カウントで管理される
- [ ] 合計5回まで利用可能

**実際の結果**:
```
（ここにテスト結果を記入）


```

---

## 5. UI/UX確認（推奨）

### 5-1. モバイル対応（スマホ）
**手順**:
1. [ ] iPhoneまたはAndroidで `dev.ooya.tech` にアクセス
2. [ ] ログイン → アップグレード → 決済完了まで実行
3. [ ] 表示崩れがないか確認
4. [ ] ボタンがタップしやすいか確認

**期待結果**:
- [ ] 表示崩れなし
- [ ] 操作しやすいUI

**実際の結果**:
```
（ここにテスト結果を記入）


```

---

## 6. Webhook動作確認（技術的確認）

### 6-1. Stripe Webhookログ確認
**手順**:
1. [ ] Stripeダッシュボード → Webhooks → イベントログ
2. [ ] 以下のイベントが記録されているか確認:
   - `checkout.session.completed` - 決済完了時
   - `customer.subscription.created` - サブスクリプション作成時
   - `customer.subscription.updated` - 解約・再開時
3. [ ] すべて200 OKで処理されているか確認

**期待結果**:
- [ ] 全イベントが200 OKで処理されている
- [ ] エラーログがない

**実際の結果**:
```
（ここにテスト結果を記入）


```

---

## テスト結果サマリー

### 正常系
- [ ] 1-1. 新規登録→即時アップグレード: ✅ / ❌
- [ ] 1-2. 制限到達→アップグレード: ✅ / ❌
- [ ] 1-3. 3Dセキュア認証: ✅ / ❌

### 異常系
- [ ] 2-1. カード拒否エラー: ✅ / ❌
- [ ] 2-2. 決済キャンセル: ✅ / ❌

### サブスクリプション管理
- [ ] 3-1. プラン解約: ✅ / ❌
- [ ] 3-2. 解約取り消し: ✅ / ❌

### 統合カウント
- [ ] 4-1. 統合カウント確認: ✅ / ❌

### UI/UX
- [ ] 5-1. モバイル対応: ✅ / ❌

### Webhook
- [ ] 6-1. Webhookログ確認: ✅ / ❌

---

## 発見した問題・改善点

```
（テスト中に気づいた問題や改善すべき点を記入）



```

---

## 次のアクション

- [ ] テスト結果を検証シートに反映
- [ ] 問題があれば修正対応
- [ ] 本番環境デプロイ前の最終確認

---

## 備考

- Stripeテストモードでは実際のお金は動きません
- テストカードは何度でも使用可能です
- 問題が発生した場合は、ブラウザのコンソールログをスクリーンショットで保存してください

# シミュレーターの計算ロジック

## 1. 入力パラメータ

### 1.1 物件基本情報
- `purchase_price`: 購入価格（万円）
- `land_area`: 土地面積（㎡）
- `building_area`: 建物面積（㎡）
- `road_price`: 路線価（円/㎡）
- `year_built`: 建築年
- `property_type`: 物件構造（木造/鉄骨造/鉄筋造/RC/SRC）

### 1.2 収益関連
- `monthly_rent`: 月額賃料（円）
- `vacancy_rate`: 空室率（%）
- `rent_decline`: 賃料下落率（%/年）
- `management_fee`: 管理費（円/月）
- `fixed_cost`: その他固定費（円/月）
- `property_tax`: 固定資産税（円/年）

### 1.3 借入条件
- `loan_amount`: 借入額（万円）
- `interest_rate`: 金利（%）
- `loan_years`: 返済期間（年）
- `loan_type`: 返済方式（元利均等/元金均等）

### 1.4 初期費用
- `other_costs`: 諸経費（万円）
- `renovation_cost`: 改装費（万円）

### 1.5 出口戦略
- `holding_years`: 保有期間（年）
- `expected_sale_price`: 想定売却価格（万円）
- `exit_cap_rate`: 売却時Cap Rate（%）
- `price_decline_rate`: 年間価格下落率（%）

### 1.6 税務関連
- `effective_tax_rate`: 実効税率（%）
- `building_price`: 建物価格（万円）- 減価償却対象
- `depreciation_years`: 償却期間（年）

### 1.7 大規模修繕
- `major_repair_cycle`: 修繕周期（年）
- `major_repair_cost`: 修繕費用（万円）

---

## 2. 基本指標の計算

### 2.1 自己資金
```
self_funding = purchase_price - loan_amount + other_costs + renovation_cost
```
**意味**: 投資に必要な初期自己資金
- 頭金（購入価格 - 借入額）
- 諸経費
- 改装費

### 2.2 年間家賃収入
```
annual_rent = monthly_rent × 12 × (1 - vacancy_rate / 100)
```
**単位**: 万円
**意味**: 空室率を考慮した実質年間家賃収入

### 2.3 表面利回り
```
gross_yield = (monthly_rent × 12) / purchase_price × 100
```
**単位**: %
**重要**: 業界標準では満室想定（空室率を考慮しない）で計算

### 2.4 NOI（Net Operating Income）
```
noi = annual_rent × 10000 - (management_fee × 12 + fixed_cost × 12 + property_tax)
```
**単位**: 円
**意味**: 営業純利益（家賃収入から運営費を差し引いた額）

### 2.5 実質利回り
```
net_yield = (noi - tax) / (purchase_price × 10000) × 100
```
**単位**: %
**意味**: 税引き後NOIベースの利回り

---

## 3. ローン計算

### 3.1 月額返済額（元利均等）
```
if interest_rate > 0:
    r = interest_rate / 100 / 12  # 月利
    n = loan_years × 12           # 返済回数
    monthly_loan = loan_amount × 10000 × (r × (1 + r)^n) / ((1 + r)^n - 1)
else:
    monthly_loan = loan_amount × 10000 / (loan_years × 12)
```

### 3.2 残債計算
```
if loan_type == "元利均等":
    if r == 0:
        remaining = principal × (n - m) / n
    else:
        remaining = principal × ((1 + r)^n - (1 + r)^m) / ((1 + r)^n - 1)
else:  # 元金均等
    monthly_principal = principal / n
    remaining = principal - (monthly_principal × m)
```
- `n`: 総返済回数（月）
- `m`: 経過回数
- `principal`: 借入元本（円）

### 3.3 DSCR（Debt Service Coverage Ratio）
```
dscr = noi / annual_loan
```
**意味**: 返済余力指標（1.0以上が健全）

---

## 4. 税務計算

### 4.1 減価償却費
```
# 建物分
if i <= depreciation_years:
    building_depreciation = building_price × 10000 / depreciation_years

# 初期改装費
if renovation_cost > 0 and i <= depreciation_years:
    renovation_depreciation = renovation_cost × 10000 / depreciation_years

# 大規模修繕（20万円以上）
capital_repairs_depreciation = Σ(各修繕費 × 10000 / depreciation_years)
```

### 4.2 不動産所得
```
real_estate_income = 家賃収入 - 経費 - 減価償却費
```

### 4.3 税金（繰越欠損金考慮）
```
if income <= 0:
    # 赤字の場合、繰越欠損金に蓄積
    accumulated_loss = accumulated_loss + |income|
    tax = 0
else:
    # 黒字の場合、繰越欠損金と相殺
    taxable_income = max(0, income - accumulated_loss)
    tax = taxable_income × (effective_tax_rate / 100)
    accumulated_loss = max(0, accumulated_loss - income)
```

---

## 5. キャッシュフロー計算

### 5.1 年間キャッシュフロー
```
cf = 家賃収入 - 経費 - ローン返済 - 修繕費 - 初期改装費 - 税金
```
**重要**: 
- 減価償却費は含まない（非現金費用）
- 大規模修繕は発生年に全額計上

### 5.2 累計キャッシュフロー
```
cumulative_cf = Σ(各年のcf)
```

### 5.3 自己資金推移（回収状況）
```
1年目: self_funding_balance = -self_funding × 10000 + cf_1
2年目以降: self_funding_balance = cumulative_cf - self_funding × 10000
```
**意味**: 
- マイナス: 投資額未回収
- ゼロ: 投資額回収完了
- プラス: 利益創出

### 5.4 自己資金回収率
```
recovery_rate = cumulative_cf / (self_funding × 10000) × 100
```

---

## 6. 投資指標

### 6.1 CCR（Cash on Cash Return）

#### 初年度CCR
```
ccr_first_year = first_year_cf / (self_funding × 10000) × 100
```
**重要**: first_year_cfは初年度のキャッシュフロー（改装費込み）

#### 全期間CCR
```
ccr_full_period = (final_cumulative_cf / (self_funding × 10000) / years) × 100
```

### 6.2 ROI（Return on Investment）

#### 初年度ROI
```
roi_first_year = first_year_cf / (total_investment × 10000) × 100
total_investment = purchase_price + other_costs + renovation_cost
```

#### 全期間ROI
```
roi_full_period = (final_cumulative_cf / (total_investment × 10000) / years) × 100
```

### 6.3 IRR（Internal Rate of Return）
```
# 簡易計算式
annual_cf_after_debt = annual_cf - annual_loan
total_cf = annual_cf_after_debt × years + sale_profit × 10000
total_return = total_cf / (self_funding × 10000)
irr = ((total_return)^(1/years) - 1) × 100
```

### 6.4 LTV（Loan to Value）
```
ltv = loan_amount / assessed_total × 100
assessed_total = land_eval + building_eval
```

---

## 7. 物件評価

### 7.1 積算評価

#### 土地評価
```
land_eval = land_area × road_price / 10000
```

#### 建物評価（法定耐用年数）
```
# 再調達単価（万円/㎡）
木造: 15、鉄骨造: 18、鉄筋造: 20、RC: 22、SRC: 25

# 法定耐用年数
木造: 22年、鉄骨造: 27年、鉄筋造: 34年、RC: 47年、SRC: 47年

# 計算
building_age = current_year - year_built
remaining_years = useful_life - building_age

if remaining_years <= 0:
    building_eval = 0
else:
    residual_rate = (remaining_years / useful_life) × 0.9 + 0.1
    building_eval = building_area × unit_price × residual_rate
```

#### 積算評価額合計
```
assessed_total = land_eval + building_eval
```

### 7.2 収益還元評価
```
cap_rate_eval = noi / (exit_cap_rate / 100) / 10000
```

---

## 8. 売却時処理

### 8.1 売却価格の決定
最も高い価格を採用する3つの評価方法：
1. **想定売却価格**（価格下落考慮）
2. **収益還元価格**（NOI ÷ Cap Rate）
3. **土地価格**（購入価格 - 建物価格）

### 8.2 売却諸経費

#### 仲介手数料（宅建業法準拠）
```
売却価格 ≤ 200万円: 手数料 = 売却価格 × 5%
200万円 < 売却価格 ≤ 400万円: 手数料 = 売却価格 × 4% + 2万円
売却価格 > 400万円: 手数料 = 売却価格 × 3% + 6万円

仲介手数料（税込） = 手数料 × 1.1
```

#### その他費用
```
other_costs = 売却価格 × 0.01  # 印紙税、登記費用等（約1%）
sale_cost = 仲介手数料 + other_costs
```

### 8.3 譲渡所得税
```
取得費 = purchase_price + renovation_cost + other_costs
売却益 = 売却価格 - 取得費 - (減価償却累計額)

if 売却益 > 0:
    if 保有期間 ≤ 5年:
        譲渡所得税 = 売却益 × 0.40  # 短期譲渡
    else:
        譲渡所得税 = 売却益 × 0.20  # 長期譲渡
```

### 8.4 売却後純収益
```
net_sale_proceeds = 売却価格 - 残債 - 売却諸経費 - 譲渡所得税
```

### 8.5 売却後累計CF（最終収益）
```
sale_cumulative_cf = 累計CF + 売却後純収益 - 残債
```

---

## 9. 修繕費の処理・分類

### 9.1 分類基準
- **20万円以上**: 大規模修繕として処理
  - 資本的支出として計上（減価償却対象）
  - キャッシュフロー計算では支出年に全額計上
  - 税務計算上は減価償却処理され、償却期間にわたって費用化
  
- **20万円未満**: 通常修繕費として処理
  - 経費として即時計上
  - その年の税金計算で全額控除

### 9.2 処理方法
```
if 修繕費 >= 20万円:
    # 大規模修繕
    キャッシュフロー -= 修繕費（全額）
    減価償却費 += 修繕費 / 償却期間（各年）
else:
    # 通常修繕費
    経費 += 修繕費
    キャッシュフロー -= 修繕費
```

---

## 10. 単位の取り扱い

### 基本ルール
- **入力値**: 万円単位（購入価格、借入額等）、円単位（月額賃料、管理費等）
- **計算時**: 全て円単位で統一
- **出力値**: 円単位または万円単位（表示に応じて）

### 変換
```
万円 → 円: value × 10000
円 → 万円: value / 10000
```

---

## 11. エラー処理

### ゼロ除算対策
```
if denominator > 0:
    result = numerator / denominator
else:
    result = 0
```

### 例外処理対策
```
try:
    result = calculation()
except (ValueError, ArithmeticError, TypeError, ZeroDivisionError):
    result = None or 0
```

---

## 12. 重要な前提

1. **改装費の扱い**
   - 初期改装費は資本的支出として処理
   - 1年目のキャッシュフローに全額計上
   - 減価償却費として償却期間にわたって費用化

2. **ローン返済の処理**
   - 返済額は元利合計で毎年一定（元利均等の場合）
   - 借入残高はゼロになるまで返済

3. **繰越欠損金**
   - 赤字の場合、損失を翌年以降に繰り越し
   - 黒字の場合、10年以内の繰越欠損金と相殺（税金軽減効果）

4. **価格下落の考慮**
   - 売却価格は毎年一定率で下落
   - `売却価格 = 想定売却価格 × (1 - 価格下落率/100)^(期間-1)`
# 環境変数設定ガイド

## Supabase Edge Functions環境変数

### cancel-subscription関数

| 環境変数名 | 説明 | 取得方法 |
|-----------|------|---------|
| `STRIPE_SECRET_KEY` | Stripe APIシークレットキー | Stripeダッシュボード > API keys |
| `SUPABASE_URL` | SupabaseプロジェクトURL | 自動設定（変更不要） |
| `SUPABASE_SERVICE_ROLE_KEY` | サービスロールキー | 自動設定（変更不要） |

### smart-service関数（既存）

| 環境変数名 | 説明 | 取得方法 |
|-----------|------|---------|
| `STRIPE_SECRET_KEY` | Stripe APIシークレットキー | Stripeダッシュボード > API keys |
| `STRIPE_PRICE_ID` | プレミアムプランの価格ID | Stripeダッシュボード > Products |
| `STRIPE_WEBHOOK_SECRET` | Webhook署名シークレット | Stripeダッシュボード > Webhooks |

## フロントエンド環境変数（.env）

```env
# Supabase設定
VITE_SUPABASE_URL=https://[your-project-ref].supabase.co
VITE_SUPABASE_ANON_KEY=[your-anon-key]

# Stripe設定
VITE_STRIPE_PRICE_ID=price_1RvChRR8rkVVzR7nAeDvfiur

# Google OAuth設定
VITE_GOOGLE_CLIENT_ID=[your-google-client-id]
```

## 本番環境設定チェックリスト

### Supabaseダッシュボード

- [ ] Edge Functions > cancel-subscription > Settings で環境変数設定
- [ ] Authentication > Providers でGoogle OAuth有効化
- [ ] Database > Tables でRLSポリシー確認
- [ ] Database > Migrations で最新のマイグレーション適用確認

### Stripeダッシュボード

- [ ] 本番用APIキーの取得と設定
- [ ] Webhook エンドポイントの設定
- [ ] 商品（Products）と価格（Prices）の作成
- [ ] 決済リンクのテスト

### GitHub Actions / Vercel環境変数

```yaml
# GitHub Secrets に追加（開発環境用）
DEV_SUPABASE_URL: ${{ secrets.DEV_SUPABASE_URL }}
DEV_SUPABASE_ANON_KEY: ${{ secrets.DEV_SUPABASE_ANON_KEY }}
DEV_STRIPE_PRICE_ID: ${{ secrets.DEV_STRIPE_PRICE_ID }}
DEV_GOOGLE_CLIENT_ID: ${{ secrets.DEV_GOOGLE_CLIENT_ID }}

# GitHub Secrets に追加（本番環境用）
PROD_SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
PROD_SUPABASE_ANON_KEY: ${{ secrets.PROD_SUPABASE_ANON_KEY }}
PROD_STRIPE_PRICE_ID: ${{ secrets.PROD_STRIPE_PRICE_ID }}
PROD_GOOGLE_CLIENT_ID: ${{ secrets.PROD_GOOGLE_CLIENT_ID }}
```

## セキュリティ注意事項

1. **絶対にコミットしない**
   - `.env`ファイル
   - シークレットキー
   - サービスロールキー

2. **環境ごとに分離**
   - 開発環境：テストキー使用
   - 本番環境：本番キー使用
   - ステージング：専用キー使用

3. **定期的な更新**
   - APIキーの定期的なローテーション
   - 不要な環境変数の削除

## トラブルシューティング

### 環境変数が読み込まれない

```bash
# フロントエンド
npm run build
# ビルド時に環境変数が埋め込まれているか確認

# Edge Functions
npx supabase functions logs cancel-subscription
# ログで環境変数の存在を確認
```

### Stripe接続エラー

```javascript
// デバッグコード（本番では削除）
console.log('Stripe key exists:', !!Deno.env.get('STRIPE_SECRET_KEY'));
```

### CORS エラー

```javascript
// Edge Function内で確認
const corsHeaders = {
  'Access-Control-Allow-Origin': '*', // 本番では特定のドメインに制限
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
};
```
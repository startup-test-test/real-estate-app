# シナリオテスト実施記録（二重決済防止システム）

実施日: 2025年8月14日
テスター: togo@startup-marketing.co.jp
環境: GitHub Codespaces / Supabase / Stripe

## テスト結果サマリー

| テスト項目 | 状態 | 結果 | 備考 |
|-----------|------|------|------|
| 1. 解約機能 | ✅ 完了 | 成功 | 2025/9/12まで利用可能と表示 |
| 2. 解約取り消し | ⏸️ 保留 | - | Edge Function未デプロイ |
| 3. 二重購入防止 | 🔄 未実施 | - | - |
| 4. UI状態管理 | 🔄 未実施 | - | - |

## 詳細テストシナリオ

### ✅ シナリオ1: プレミアムプラン解約
**目的**: 解約機能が正常に動作することを確認

**手順**:
1. プレミアム会員（togo@startup-marketing.co.jp）でログイン
2. プレミアムプランページにアクセス
3. 「プランを解約」ボタンをクリック
4. 確認モーダルで「解約する」を選択

**期待結果**:
- ✅ 「解約が完了しました」メッセージ表示
- ✅ 「2025/9/12まで全機能をご利用いただけます（あと30日）」表示
- ✅ UIが解約予定状態に変更
- ✅ Stripeで「09/12でキャンセル」確認

**実際の結果**: **成功**
- 正しくStripe IDで解約処理実行
- データベースとStripeが同期

---

### ⏸️ シナリオ2: 解約取り消し
**目的**: 解約を取り消せることを確認

**現状**: 
- Edge Function `resume-subscription` が未デプロイ
- エラー: `Failed to send a request to the Edge Function`

**対応方法**:

#### A. Edge Functionをデプロイする場合
```bash
# Supabaseトークンを設定
export SUPABASE_ACCESS_TOKEN="sbp_xxxxx..."

# プロジェクトをリンク
npx supabase link --project-ref gtnzhnsbdmkadfawuzmc

# デプロイ
npx supabase functions deploy resume-subscription
```

#### B. 手動で解決する場合
1. **Stripeダッシュボード**:
   - サブスクリプション `sub_1RvHDWR8rkVVzR7nDhGM2d8Q` を開く
   - 「キャンセルを取り消す」をクリック

2. **Supabase SQL Editor**:
```sql
UPDATE subscriptions 
SET 
    cancel_at_period_end = false,
    cancel_at = NULL,
    updated_at = NOW()
WHERE user_id = '591142c5-738a-4bfd-bf01-638da0b1453f';
```

---

### 🔄 シナリオ3: 二重購入防止
**目的**: プレミアム会員が重複購入できないことを確認

**手順**:
1. プレミアム会員の状態でプレミアムプランページにアクセス
2. 別のブラウザタブを開いて同じページにアクセス
3. 購入を試みる

**期待結果**:
- フロントエンドで「すでにプレミアムプランに登録されています」エラー
- 購入ボタンが無効化または非表示

**テスト方法**:
```javascript
// ブラウザのコンソールで実行してテスト
// 購入ボタンの状態を確認
document.querySelector('button:contains("プランを選択")');
```

---

### 🔄 シナリオ4: UI状態管理
**目的**: ユーザー状態に応じて正しいボタンが表示されることを確認

**テストケース**:

| ユーザー状態 | 期待されるボタン | 確認方法 |
|-------------|----------------|----------|
| 未ログイン | 「プランを選択」 | ログアウトして確認 |
| 無料会員 | 「プランを選択」 | 新規ユーザーで確認 |
| プレミアム会員 | 「プランを解約」 | 現在の状態 |
| 解約予定 | 「解約を取り消す」 | 解約後の状態 |

---

## 次のアクション

### 優先度: 高
1. **解約取り消し機能を完成させる**
   - Edge Functionをデプロイ
   - または手動で状態を戻す

2. **二重購入防止テスト**
   - 別タブでテスト
   - エラーメッセージ確認

### 優先度: 中
3. **負荷テスト**
   - 連打テスト
   - 同時アクセステスト

4. **エラーハンドリング**
   - ネットワークエラー時の動作
   - タイムアウト時の動作

---

## 現在の課題

### 1. Edge Function未デプロイ
- `resume-subscription` が404エラー
- Supabaseトークンが必要

### 2. 複数サブスクリプションの残骸
- Stripeに10個のサブスクリプションが作成された経緯
- 9個はキャンセル済み（要確認）

---

## 推奨事項

### 即座に対応すべきこと
1. 解約を手動で取り消す（Stripe + DB）
2. 二重購入防止のテスト実施

### 本番環境前に対応すべきこと
1. Edge Functions全てをデプロイ
2. Webhookの動作確認
3. データベース制約の適用
4. 全シナリオの再テスト

---

## テスト環境情報

- **アプリURL**: https://ominous-happiness-q7r697r6gq93xjxq-5173.app.github.dev
- **Supabase Project**: gtnzhnsbdmkadfawuzmc
- **Stripe Subscription ID**: sub_1RvHDWR8rkVVzR7nDhGM2d8Q
- **User ID**: 591142c5-738a-4bfd-bf01-638da0b1453f
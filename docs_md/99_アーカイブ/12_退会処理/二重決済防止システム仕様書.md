# 二重決済防止システム仕様書

## 概要
ユーザーが誤って複数のサブスクリプションを作成することを防ぐ多層防御システム

## システム構成

### 1. データベース設計

#### subscriptionsテーブルの状態管理
```sql
-- ユーザーの契約状態
status: 'active' | 'cancelled' | 'past_due'
cancel_at_period_end: boolean  -- 解約予定フラグ
cancel_at: timestamp           -- 解約予定日
current_period_end: timestamp  -- 現在の契約期間終了日
```

### 2. ユーザー状態の判定ロジック

```javascript
// ユーザーの契約状態を判定する関数
function getUserSubscriptionState(subscription) {
  if (!subscription) {
    return 'NO_SUBSCRIPTION' // 未契約
  }
  
  if (subscription.status === 'active') {
    if (subscription.cancel_at_period_end) {
      return 'CANCELING' // 解約予定（有効期間中）
    }
    return 'ACTIVE' // アクティブ
  }
  
  return 'INACTIVE' // 非アクティブ
}
```

## 画面表示仕様

### プレミアムプランページ（PremiumPlan.tsx）

#### 状態別の表示内容

| ユーザー状態 | 表示されるボタン | メッセージ |
|------------|---------------|-----------|
| 未契約 | 「プレミアムプランに登録」 | 月額2,980円で全機能が無制限 |
| アクティブ | 「プランを解約」 | プレミアム会員として全機能をご利用中 |
| 解約予定 | 「解約を取り消す」 | 8/31まで利用可能（あと17日） |
| 非アクティブ | 「プレミアムプランに登録」 | プランを再開する |

### 実装コード

#### 1. PremiumPlan.tsx のボタン表示ロジック

```tsx
const renderActionButton = () => {
  const state = getUserSubscriptionState(subscription);
  
  switch(state) {
    case 'NO_SUBSCRIPTION':
    case 'INACTIVE':
      return (
        <Button onClick={handleSubscribe}>
          プレミアムプランに登録
        </Button>
      );
      
    case 'ACTIVE':
      return (
        <Button onClick={() => setIsModalOpen(true)} variant="danger">
          プランを解約
        </Button>
      );
      
    case 'CANCELING':
      return (
        <div>
          <Alert>
            {formatCancelDate(subscription.cancel_at)}まで利用可能
            （{calculateRemainingDays(subscription.cancel_at)}）
          </Alert>
          <Button onClick={handleResumeSubscription} variant="primary">
            解約を取り消す
          </Button>
        </div>
      );
  }
};
```

#### 2. 解約取り消し機能（ResumeSubscription）

```tsx
const handleResumeSubscription = async () => {
  try {
    const { data, error } = await supabase.functions.invoke('resume-subscription', {
      headers: {
        Authorization: `Bearer ${session.access_token}`
      }
    });
    
    if (error) throw error;
    
    // サブスクリプション情報を再取得
    await fetchSubscription();
    
    alert('解約が取り消されました。プレミアムプランを継続します。');
  } catch (error) {
    alert('解約の取り消しに失敗しました');
  }
};
```

## 多層防御の実装

### 第1層：フロントエンド（ボタン制御）
```tsx
// UpgradeModal.tsx
const [isLoading, setIsLoading] = useState(false);

<Button 
  disabled={isLoading || hasActiveSubscription}
  onClick={handleUpgrade}
>
  {isLoading ? '処理中...' : 'プレミアムプランに登録'}
</Button>
```

### 第2層：フロントエンド（事前チェック）
```tsx
// 購入処理前の確認
const { data: existingSubscription } = await supabase
  .from('subscriptions')
  .select('*')
  .eq('user_id', user.id)
  .eq('status', 'active')
  .single();

if (existingSubscription && !existingSubscription.cancel_at_period_end) {
  setError('すでにプレミアムプランに登録されています');
  return;
}
```

### 第3層：Edge Function（サーバー側検証）
```typescript
// create-checkout-session/index.ts
const { data: existingSubscription } = await supabase
  .from('subscriptions')
  .select('*')
  .eq('user_id', userId)
  .eq('status', 'active')
  .single();

if (existingSubscription && !existingSubscription.cancel_at_period_end) {
  throw new Error('すでにプレミアムプランに登録されています。複数のサブスクリプションは作成できません。');
}
```

### 第4層：データベース制約
```sql
-- アクティブなサブスクリプションは1ユーザー1つまで
CREATE UNIQUE INDEX idx_one_active_subscription_per_user 
ON subscriptions(user_id) 
WHERE status = 'active' AND cancel_at_period_end = false;
```

### 第5層：Stripe Webhook検証
```typescript
// handle-stripe-webhook/index.ts
case 'checkout.session.completed': {
  // 既存のアクティブなサブスクリプションがあれば更新、なければ作成
  await supabase
    .from('subscriptions')
    .upsert({
      user_id: userId,
      stripe_subscription_id: subscription.id,
      // ... その他のフィールド
    }, {
      onConflict: 'user_id'
    });
}
```

## エラーメッセージ一覧

| エラーケース | メッセージ | 表示場所 |
|------------|-----------|---------|
| 既にアクティブな契約がある | すでにプレミアムプランに登録されています | UpgradeModal |
| 解約予定中に新規購入を試みた | 現在の契約期間が残っています。解約を取り消してください | UpgradeModal |
| 二重クリック | 処理中... | ボタンテキスト |
| Edge Functionでの重複検知 | 複数のサブスクリプションは作成できません | アラート |

## テストシナリオ

### シナリオ1：新規ユーザーの購入
1. 未契約ユーザーがログイン
2. プレミアムプランページで「プレミアムプランに登録」ボタンが表示
3. クリックして決済完了
4. ボタンが「プランを解約」に変わる

### シナリオ2：解約と取り消し
1. プレミアム会員が「プランを解約」をクリック
2. 解約確認モーダルで「解約する」を選択
3. ボタンが「解約を取り消す」に変わる
4. 残り日数が表示される
5. 「解約を取り消す」をクリック
6. ボタンが「プランを解約」に戻る

### シナリオ3：二重購入の防止
1. プレミアム会員が別のブラウザでログイン
2. 「プレミアムプランに登録」ボタンをクリック
3. 「すでにプレミアムプランに登録されています」エラー表示
4. 決済画面には遷移しない

### シナリオ4：連打防止
1. 「プレミアムプランに登録」ボタンを素早く2回クリック
2. 1回目のクリックでボタンが「処理中...」に変わる
3. 2回目のクリックは無視される
4. 1つの購入処理のみ実行

## 実装チェックリスト

- [x] PremiumPlan.tsx でユーザー状態に応じたボタン表示
- [x] 解約予定時は「解約を取り消す」ボタンのみ表示
- [x] UpgradeModal.tsx で重複チェック実装
- [x] create-checkout-session Edge Function で重複チェック
- [x] resume-subscription Edge Function の作成
- [x] データベースにUNIQUE制約追加（マイグレーションファイル作成済み）
- [x] ボタンの二重クリック防止（isLoadingフラグ実装済み）
- [x] エラーメッセージの実装
- [ ] Edge Functionsのデプロイ
- [ ] データベースマイグレーションの適用
- [ ] 全シナリオのテスト実施

## 移行計画

### Phase 1（即座対応）
1. フロントエンドの重複チェック実装
2. ボタンの状態管理改善

### Phase 2（1日以内）
1. Edge Functionの重複チェック追加
2. 解約取り消し機能の実装

### Phase 3（1週間以内）
1. データベース制約の追加
2. Webhook処理の改善
3. 総合テストの実施

## 監視項目

- 重複サブスクリプションの発生数（目標: 0件）
- エラーメッセージの表示回数
- 解約取り消しの利用率
- ユーザーからの問い合わせ数

## 関連ドキュメント

- [プラン解約機能の統合実装仕様書](./統合実装仕様書_プラン解約機能.md)
- [Edge Function デプロイ手順](./Edge_Function_デプロイ手順.md)
- [Stripe連携実装手順](./Stripe連携実装手順.md)
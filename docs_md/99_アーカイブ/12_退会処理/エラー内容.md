# Edge Function エラー詳細

## 発生日時
2025年8月13日

## エラー内容

### コンソールエラー
```
Failed to load resource: the server responded with a status of 500 ()
gtnzhnsbdmkadfawuzmc.supabase.co/functions/v1/cancel-subscription

Cancel subscription error: FunctionsHttpError: Edge Function returned a non-2xx status code
```

## 問題の原因分析

### 1. データベースの問題
- user_idが空白のレコードが存在
- 2件のsubscriptionレコードがあり、1つはuser_idが空

### 2. Edge Functionの問題
- user_idでの検索に失敗している可能性
- 「アクティブなプランが見つかりません」エラーの可能性

## 解決手順

### Step 1: データベースを修正

```sql
-- 1. あなたのuser_idを確認
SELECT id, email FROM auth.users 
WHERE email = 'あなたのメールアドレス';

-- 2. user_idが空のレコードを削除または修正
DELETE FROM subscriptions 
WHERE user_id IS NULL OR user_id = '';

-- または、正しいuser_idを設定
UPDATE subscriptions 
SET user_id = '取得したuser_id'
WHERE user_id IS NULL OR user_id = '';

-- 3. 正しいレコードの状態を確認
SELECT * FROM subscriptions 
WHERE user_id = '取得したuser_id';
```

### Step 2: Edge Functionのログを確認

Supabaseダッシュボード:
1. Edge Functions → cancel-subscription
2. Logs タブ
3. 最新のエラーログを確認

### Step 3: テスト用の正しいデータを作成

```sql
-- 既存のレコードをクリーンアップ
DELETE FROM subscriptions 
WHERE user_id IS NULL OR user_id = '';

-- 新しいテストレコードを作成
INSERT INTO subscriptions (
  id,
  user_id,
  stripe_customer_id,
  stripe_subscription_id,
  status,
  current_period_end,
  cancel_at_period_end,
  cancel_at,
  created_at,
  updated_at
) VALUES (
  gen_random_uuid(),
  (SELECT id FROM auth.users WHERE email = 'あなたのメールアドレス'),
  'cus_test_' || substr(gen_random_uuid()::text, 1, 14),
  'sub_test_' || substr(gen_random_uuid()::text, 1, 14),
  'active',
  NOW() + INTERVAL '30 days',
  false,
  NULL,
  NOW(),
  NOW()
) ON CONFLICT (user_id) DO UPDATE SET
  status = 'active',
  cancel_at_period_end = false,
  cancel_at = NULL,
  updated_at = NOW();
```

## 一時的な回避策

### 簡易版Edge Functionに戻す

1. Supabaseダッシュボード → Edge Functions
2. cancel-subscription → Edit
3. 簡易版のコードに置き換え
4. Deploy

これで基本的な解約機能は動作します（Stripe連携なし）。
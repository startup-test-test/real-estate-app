# 🚀 解約機能の簡単設定ガイド

## ✅ 完了済み
- データベースのカラム追加（cancel_at_period_end, cancel_at, current_period_start）

## 📋 次にやること

### 1. Edge Function を作成

1. Supabaseダッシュボード → **Edge Functions** タブ
2. **New Function** ボタンをクリック  
3. 関数名: `cancel-subscription`
4. `/docs_md/12_退会処理/edge_function_simple.txt` の内容をコピペ
5. **Deploy** ボタンをクリック

### 2. テスト用データの準備（任意）

もしテスト用のサブスクリプションデータがない場合：

```sql
-- SQL Editorで実行（テスト用データ作成）
INSERT INTO subscriptions (
  user_id,
  stripe_customer_id,
  stripe_subscription_id,
  status,
  current_period_end,
  created_at,
  updated_at
) VALUES (
  auth.uid(), -- 現在ログイン中のユーザーID
  'cus_test_' || gen_random_uuid(),
  'sub_test_' || gen_random_uuid(),
  'active',
  NOW() + INTERVAL '30 days',
  NOW(),
  NOW()
);
```

### 3. 動作確認

1. 開発環境にアクセス：https://ominous-happiness-q7r697r6gq93xjxq-5173.app.github.dev
2. ログイン
3. `/premium-plan` ページへ移動
4. 「プランを解約」ボタンをクリック
5. モーダルで「解約する」をクリック

## 🎯 確認ポイント

### Edge Function が正しくデプロイされているか確認

Supabaseダッシュボード → Edge Functions → cancel-subscription
- Status: Active になっているか
- Last deployed: 日時が表示されているか

### エラーが出た場合

1. **認証エラー**: ログインし直す
2. **プランが見つかりません**: subscriptionsテーブルにデータがあるか確認
3. **404エラー**: Edge Functionの名前が正しいか確認（cancel-subscription）

## 💡 デバッグ方法

Edge Functionのログを確認：
1. Supabaseダッシュボード → Edge Functions
2. cancel-subscription → Logs タブ

ブラウザのコンソールでエラーを確認：
1. F12キーで開発者ツールを開く
2. Consoleタブでエラーメッセージを確認

## 🎉 成功したら

解約が成功すると：
- 「解約が完了しました」というメッセージが表示
- プランのステータスが「解約予定」に変更
- ヘッダーに「プレミアム会員（あと30日）」と表示

## 📝 メモ

この簡易版では：
- Stripe連携なし（テスト用）
- 解約日は常に30日後に設定
- 実際の決済処理はなし

本番環境では：
- Stripe APIキーの設定が必要
- 実際のサブスクリプション期限を使用
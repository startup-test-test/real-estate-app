# プラン解約機能 テストシナリオ

作成日: 2025年8月13日  
バージョン: 1.0

---

## 📋 テスト概要

プラン解約機能の動作確認と品質保証のためのテストシナリオです。

---

## 1. 単体テスト ✅ 完了

### 実施済みテスト
- `subscriptionHelpers.test.ts`: 28テスト全て成功
  - 残日数計算ロジック
  - 日付フォーマット機能
  - ステータス判定ロジック
- `CancelSubscriptionModal.test.tsx`: 19テスト全て成功
  - モーダル表示/非表示
  - ユーザーインタラクション
  - ローディング状態
  - ESCキー処理

### テスト実行コマンド
```bash
# 全ての単体テスト実行
npm test

# 特定のテストファイル実行
npm test -- src/utils/__tests__/subscriptionHelpers.test.ts --run
npm test -- src/components/__tests__/CancelSubscriptionModal.test.tsx --run
```

---

## 2. 統合テストシナリオ

### テスト前準備
1. Stripeテストモードを有効化
2. テスト用のサブスクリプションを作成
3. Edge Functionをデプロイ
4. 環境変数を設定

### シナリオ1: 正常系 - 解約フロー

| No | テスト項目 | 期待結果 | 結果 |
|----|-----------|----------|------|
| 1-1 | プレミアムプランページにアクセス | ページが正常に表示される | ⬜ |
| 1-2 | プレミアム会員でログイン | 「現在のプラン」と「プランを解約」ボタンが表示 | ⬜ |
| 1-3 | 「プランを解約」ボタンをクリック | 解約確認モーダルが表示される | ⬜ |
| 1-4 | モーダルに残日数が表示される | 正しい残日数が計算・表示される | ⬜ |
| 1-5 | 「解約する」ボタンをクリック | 処理中表示 → 成功メッセージ | ⬜ |
| 1-6 | 解約後の表示確認 | 「解約予定」状態が表示される | ⬜ |
| 1-7 | ヘッダーの表示確認 | 「プレミアム会員（あとX日）」と表示 | ⬜ |

### シナリオ2: 異常系 - エラーハンドリング

| No | テスト項目 | 期待結果 | 結果 |
|----|-----------|----------|------|
| 2-1 | ネットワークエラー時 | エラーメッセージが表示される | ⬜ |
| 2-2 | 認証エラー時 | ログイン画面へリダイレクト | ⬜ |
| 2-3 | すでに解約済みの場合 | 「すでに解約予定です」エラー | ⬜ |
| 2-4 | Stripe APIエラー | 適切なエラーメッセージ表示 | ⬜ |
| 2-5 | 無効なサブスクリプション | 「プランが見つかりません」エラー | ⬜ |

### シナリオ3: UI/UX確認

| No | テスト項目 | 期待結果 | 結果 |
|----|-----------|----------|------|
| 3-1 | ESCキーでモーダルを閉じる | モーダルが閉じる | ⬜ |
| 3-2 | 背景クリックでモーダルを閉じる | モーダルが閉じる | ⬜ |
| 3-3 | ローディング中の操作制限 | ボタンが無効化される | ⬜ |
| 3-4 | レスポンシブデザイン | SP/タブレット/PCで正常表示 | ⬜ |
| 3-5 | アニメーション | モーダルがスムーズに表示/非表示 | ⬜ |

---

## 3. エンドツーエンド（E2E）テスト

### テストケース: 完全な解約フロー

```typescript
// E2Eテストの例（Playwright使用想定）
describe('プラン解約E2Eテスト', () => {
  test('プレミアム会員が解約を完了できる', async ({ page }) => {
    // 1. ログイン
    await page.goto('/login');
    await page.fill('[name="email"]', 'test@example.com');
    await page.fill('[name="password"]', 'password');
    await page.click('button[type="submit"]');
    
    // 2. プレミアムプランページへ移動
    await page.goto('/premium-plan');
    
    // 3. 解約ボタンをクリック
    await page.click('text=プランを解約');
    
    // 4. モーダルが表示されることを確認
    await expect(page.locator('text=プランを解約しますか？')).toBeVisible();
    
    // 5. 解約を実行
    await page.click('text=解約する');
    
    // 6. 成功メッセージを確認
    await expect(page.locator('text=解約が完了しました')).toBeVisible();
    
    // 7. ステータスが更新されることを確認
    await expect(page.locator('text=解約予定')).toBeVisible();
  });
});
```

---

## 4. 本番環境テスト

### チェックリスト

#### 環境設定
- [ ] Stripe本番APIキーが設定されている
- [ ] Edge Functionが本番環境にデプロイされている
- [ ] CORS設定が本番ドメインを許可している
- [ ] データベースマイグレーションが適用されている

#### 機能テスト
- [ ] 本番Stripeダッシュボードで解約が反映される
- [ ] メール通知が送信される（設定している場合）
- [ ] 解約後も期限まで機能が使える
- [ ] 期限後に無料プランに戻る

#### セキュリティテスト
- [ ] 他ユーザーのサブスクリプションを解約できない
- [ ] 不正なリクエストが拒否される
- [ ] XSS攻撃への対策が機能している
- [ ] CSRF対策が有効

#### パフォーマンステスト
- [ ] 解約処理が3秒以内に完了する
- [ ] 同時アクセス時の動作確認
- [ ] エラー時のリトライ処理

---

## 5. リグレッションテスト

### 影響範囲の確認

| 機能 | 影響有無 | テスト必要性 | 結果 |
|------|----------|-------------|------|
| ログイン/認証 | なし | 低 | ⬜ |
| プラン登録（アップグレード） | あり | 高 | ⬜ |
| 利用制限チェック | あり | 高 | ⬜ |
| ダッシュボード表示 | あり | 中 | ⬜ |
| 決済処理 | なし | 低 | ⬜ |

---

## 6. テスト実施記録

| 実施日 | 実施者 | 環境 | バージョン | 結果 | 備考 |
|--------|--------|------|------------|------|------|
| 2025/8/13 | - | 開発 | v1.0 | - | 単体テスト実施済み |
| - | - | - | - | - | - |

---

## 7. 不具合管理

| No | 発見日 | 内容 | 優先度 | ステータス | 修正日 |
|----|--------|------|--------|------------|--------|
| - | - | - | - | - | - |

---

## 8. テスト完了基準

### 必須項目
- ✅ 全ての単体テストが成功
- ⬜ 正常系シナリオが全て成功
- ⬜ 異常系の主要ケースでエラーハンドリング確認
- ⬜ Stripe本番環境での動作確認
- ⬜ セキュリティテストの実施

### 推奨項目
- ⬜ E2Eテストの自動化
- ⬜ パフォーマンステストの実施
- ⬜ 負荷テストの実施

---

## 9. 次のステップ

1. **Edge Functionのデプロイ**
   - `/docs_md/12_退会処理/Edge_Function_デプロイ手順.md`を参照

2. **環境変数の設定**
   - `/docs_md/12_退会処理/環境変数設定.md`を参照

3. **統合テストの実施**
   - 開発環境でシナリオ1-3を実行

4. **本番デプロイ**
   - 全テスト合格後に実施
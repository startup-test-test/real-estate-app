# Stripe決済 UI仕様書

作成日: 2025年8月12日  
バージョン: 1.0.0 (MVP版)

## 1. 概要

Stripe決済機能に関連するすべてのUI要素の仕様を定義します。
ユーザー体験を最優先に、シンプルで分かりやすいインターフェースを提供します。

## 2. UI構成要素

### 2.1 全体構成

```
┌─────────────────────────────────┐
│ ヘッダー                         │
│ ├─ ロゴ                         │
│ └─ プレミアムバッジ（会員のみ）    │
├─────────────────────────────────┤
│ 利用状況バー                      │
├─────────────────────────────────┤
│ メインコンテンツ                  │
│ ├─ シミュレーター                │
│ └─ 実行ボタン（状態変化）         │
├─────────────────────────────────┤
│ アップグレードモーダル（必要時）    │
└─────────────────────────────────┘
```

## 3. コンポーネント詳細設計

### 3.1 利用状況表示バー (UsageStatusBar)

#### 3.1.1 無料プラン - 通常状態

```typescript
// components/UsageStatusBar.tsx
export const UsageStatusBar: React.FC = () => {
  const { usage } = useUsageStatus();
  
  if (usage.isSubscribed) return <PremiumStatusBar />;
  
  const remaining = usage.limit - usage.currentCount;
  const percentage = (usage.currentCount / usage.limit) * 100;
  
  return (
    <div className="bg-white border-b border-gray-200 px-4 py-3">
      <div className="max-w-7xl mx-auto flex items-center justify-between">
        <div className="flex items-center gap-4">
          {/* プログレスバー */}
          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-600">利用状況:</span>
            <div className="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div 
                className={`h-full transition-all ${
                  percentage >= 80 ? 'bg-red-500' : 
                  percentage >= 60 ? 'bg-yellow-500' : 
                  'bg-blue-500'
                }`}
                style={{ width: `${percentage}%` }}
              />
            </div>
            <span className="text-sm font-medium">
              {usage.currentCount}/{usage.limit}回
            </span>
          </div>
          
          {/* リセット日表示 */}
          <div className="flex items-center gap-1 text-sm text-gray-500">
            <Calendar className="h-4 w-4" />
            <span>
              次回リセット: {formatDate(usage.periodEndDate)} 
              （あと{usage.daysLeft}日）
            </span>
          </div>
        </div>
        
        {/* アップグレードCTA（残り2回以下で表示） */}
        {remaining <= 2 && (
          <button 
            onClick={openUpgradeModal}
            className="text-sm text-blue-600 hover:text-blue-700 font-medium"
          >
            プレミアムプランで無制限利用 →
          </button>
        )}
      </div>
    </div>
  );
};
```

#### 3.1.2 無料プラン - 警告状態（残り1-2回）

```typescript
// 警告バナー表示
<div className="bg-yellow-50 border-b border-yellow-200 px-4 py-3">
  <div className="max-w-7xl mx-auto flex items-center justify-between">
    <div className="flex items-center gap-2">
      <AlertTriangle className="h-5 w-5 text-yellow-600" />
      <p className="text-sm font-medium text-yellow-800">
        利用可能回数が残り{remaining}回です
      </p>
    </div>
    <button className="px-4 py-1.5 bg-yellow-600 text-white text-sm 
                     rounded-md hover:bg-yellow-700">
      今すぐアップグレード
    </button>
  </div>
</div>
```

#### 3.1.3 無料プラン - エラー状態（利用制限到達）

```typescript
// エラーバナー表示
<div className="bg-red-50 border-b border-red-200 px-4 py-3">
  <div className="max-w-7xl mx-auto flex items-center justify-between">
    <div className="flex items-center gap-2">
      <XCircle className="h-5 w-5 text-red-600" />
      <div>
        <p className="text-sm font-medium text-red-800">
          今月の無料利用枠を使い切りました
        </p>
        <p className="text-xs text-red-600">
          プレミアムプランで引き続きご利用いただけます
        </p>
      </div>
    </div>
    <button className="px-4 py-2 bg-red-600 text-white rounded-md 
                     hover:bg-red-700 flex items-center gap-2">
      <CreditCard className="h-4 w-4" />
      アップグレードして続ける
    </button>
  </div>
</div>
```

#### 3.1.4 プレミアム会員表示

```typescript
// プレミアムステータスバー
<div className="bg-gradient-to-r from-purple-50 to-blue-50 border-b 
              border-purple-200 px-4 py-3">
  <div className="max-w-7xl mx-auto flex items-center justify-between">
    <div className="flex items-center gap-3">
      <div className="flex items-center gap-2">
        <Star className="h-5 w-5 text-yellow-500 fill-current" />
        <span className="text-sm font-medium text-purple-800">
          プレミアムプラン
        </span>
      </div>
      <span className="text-sm text-gray-600">
        全機能が無制限でご利用いただけます
      </span>
    </div>
    <Link 
      to="/account/billing" 
      className="text-sm text-purple-600 hover:text-purple-700"
    >
      プラン管理 →
    </Link>
  </div>
</div>
```

### 3.2 シミュレーター実行ボタン

#### 3.2.1 ボタン状態管理

```typescript
// components/SimulatorExecuteButton.tsx
interface ButtonProps {
  onExecute: () => void;
  isLoading?: boolean;
}

export const SimulatorExecuteButton: React.FC<ButtonProps> = ({ 
  onExecute, 
  isLoading 
}) => {
  const { usage } = useUsageStatus();
  const [showUpgradeModal, setShowUpgradeModal] = useState(false);
  
  const handleClick = async () => {
    // 利用制限チェック
    if (!usage.canUse && !usage.isSubscribed) {
      setShowUpgradeModal(true);
      return;
    }
    
    // 実行処理
    await onExecute();
    
    // 無料プランの場合、利用回数を増やす
    if (!usage.isSubscribed) {
      await incrementUsage(user.id, 'simulator');
      // 利用状況を再取得
      await refetchUsage();
    }
  };
  
  // プレミアム会員
  if (usage.isSubscribed) {
    return (
      <button
        onClick={handleClick}
        disabled={isLoading}
        className="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 
                 text-white font-medium rounded-lg hover:opacity-90
                 disabled:opacity-50 disabled:cursor-not-allowed
                 flex items-center justify-center gap-2"
      >
        {isLoading ? (
          <Loader2 className="h-5 w-5 animate-spin" />
        ) : (
          <>
            <Star className="h-5 w-5" />
            <span>シミュレーション実行</span>
          </>
        )}
      </button>
    );
  }
  
  // 無料プラン（利用可能）
  if (usage.canUse) {
    return (
      <>
        <button
          onClick={handleClick}
          disabled={isLoading}
          className="w-full px-6 py-3 bg-blue-600 text-white font-medium 
                   rounded-lg hover:bg-blue-700 disabled:opacity-50
                   flex items-center justify-center gap-2"
        >
          {isLoading ? (
            <Loader2 className="h-5 w-5 animate-spin" />
          ) : (
            <>
              <PlayCircle className="h-5 w-5" />
              <span>シミュレーション実行</span>
              <span className="text-xs opacity-80">
                （残り{usage.limit - usage.currentCount}回）
              </span>
            </>
          )}
        </button>
        
        {/* 残り回数が少ない場合の注意表示 */}
        {usage.limit - usage.currentCount <= 2 && (
          <p className="mt-2 text-xs text-gray-500 text-center">
            💡 プレミアムプランで無制限利用が可能です
          </p>
        )}
      </>
    );
  }
  
  // 無料プラン（制限到達）
  return (
    <>
      <button
        onClick={() => setShowUpgradeModal(true)}
        className="w-full px-6 py-3 bg-gray-400 text-white font-medium 
                 rounded-lg cursor-not-allowed flex items-center 
                 justify-center gap-2"
      >
        <Lock className="h-5 w-5" />
        <span>利用制限に到達</span>
      </button>
      
      <UpgradeModal 
        isOpen={showUpgradeModal}
        onClose={() => setShowUpgradeModal(false)}
      />
    </>
  );
};
```

### 3.3 アップグレードモーダル

#### 3.3.1 モーダル実装

```typescript
// components/UpgradeModal.tsx
import { loadStripe } from '@stripe/stripe-js';

const stripePromise = loadStripe(import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY);

export const UpgradeModal: React.FC<ModalProps> = ({ isOpen, onClose }) => {
  const [isLoading, setIsLoading] = useState(false);
  const { user } = useAuthContext();
  
  const handleUpgrade = async () => {
    setIsLoading(true);
    
    try {
      // Checkout Session作成
      const { data, error } = await supabase.functions.invoke(
        'create-checkout-session',
        {
          body: { 
            priceId: import.meta.env.VITE_STRIPE_PRICE_ID,
            userId: user.id 
          }
        }
      );
      
      if (error) throw error;
      
      // Stripeへリダイレクト
      const stripe = await stripePromise;
      await stripe?.redirectToCheckout({ 
        sessionId: data.sessionId 
      });
    } catch (error) {
      console.error('Upgrade error:', error);
      toast.error('エラーが発生しました');
    } finally {
      setIsLoading(false);
    }
  };
  
  if (!isOpen) return null;
  
  return (
    <div className="fixed inset-0 bg-black/50 flex items-center 
                  justify-center z-50 p-4">
      <div className="bg-white rounded-xl max-w-md w-full max-h-[90vh] 
                    overflow-y-auto">
        {/* ヘッダー */}
        <div className="p-6 border-b border-gray-200">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-bold text-gray-900">
              プレミアムプランにアップグレード
            </h2>
            <button
              onClick={onClose}
              className="p-1 hover:bg-gray-100 rounded-lg"
            >
              <X className="h-5 w-5 text-gray-500" />
            </button>
          </div>
        </div>
        
        {/* アラート */}
        <div className="mx-6 mt-6 p-4 bg-amber-50 border border-amber-200 
                      rounded-lg">
          <div className="flex gap-3">
            <AlertCircle className="h-5 w-5 text-amber-600 flex-shrink-0" />
            <div>
              <p className="text-sm font-medium text-amber-800">
                今月の無料利用枠（5回）を使い切りました
              </p>
              <p className="text-xs text-amber-600 mt-1">
                プレミアムプランで全機能を無制限にご利用いただけます
              </p>
            </div>
          </div>
        </div>
        
        {/* プラン詳細 */}
        <div className="p-6">
          <div className="border-2 border-purple-200 rounded-lg p-6 
                        bg-gradient-to-br from-purple-50 to-blue-50">
            {/* 価格 */}
            <div className="flex items-end justify-between mb-6">
              <div>
                <p className="text-sm text-gray-600">プレミアムプラン</p>
                <div className="flex items-baseline gap-1 mt-1">
                  <span className="text-3xl font-bold text-gray-900">
                    ¥2,980
                  </span>
                  <span className="text-gray-500">/月</span>
                </div>
              </div>
              <div className="px-3 py-1 bg-purple-600 text-white text-xs 
                            font-medium rounded-full">
                おすすめ
              </div>
            </div>
            
            {/* 特典リスト */}
            <div className="space-y-3">
              <div className="flex items-start gap-3">
                <Check className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-900">
                    全機能が無制限で利用可能
                  </p>
                  <p className="text-xs text-gray-500">
                    シミュレーター、分析機能など
                  </p>
                </div>
              </div>
              
              <div className="flex items-start gap-3">
                <Check className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-900">
                    優先サポート
                  </p>
                  <p className="text-xs text-gray-500">
                    メールでの迅速な対応
                  </p>
                </div>
              </div>
              
              <div className="flex items-start gap-3">
                <Check className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-900">
                    新機能への早期アクセス
                  </p>
                  <p className="text-xs text-gray-500">
                    開発中の機能を先行利用
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        {/* アクションボタン */}
        <div className="p-6 border-t border-gray-200 space-y-3">
          <button
            onClick={handleUpgrade}
            disabled={isLoading}
            className="w-full px-6 py-3 bg-gradient-to-r from-blue-600 
                     to-purple-600 text-white font-medium rounded-lg
                     hover:opacity-90 disabled:opacity-50 
                     disabled:cursor-not-allowed flex items-center 
                     justify-center gap-2"
          >
            {isLoading ? (
              <>
                <Loader2 className="h-5 w-5 animate-spin" />
                <span>処理中...</span>
              </>
            ) : (
              <>
                <CreditCard className="h-5 w-5" />
                <span>今すぐアップグレード</span>
              </>
            )}
          </button>
          
          <button
            onClick={onClose}
            disabled={isLoading}
            className="w-full px-6 py-2 text-gray-600 hover:text-gray-800 
                     disabled:opacity-50"
          >
            後で決める
          </button>
        </div>
        
        {/* セキュリティ表示 */}
        <div className="px-6 pb-6">
          <div className="flex items-center justify-center gap-4 text-xs 
                        text-gray-500">
            <div className="flex items-center gap-1">
              <Shield className="h-4 w-4" />
              <span>SSL暗号化通信</span>
            </div>
            <div className="flex items-center gap-1">
              <CreditCard className="h-4 w-4" />
              <span>Powered by Stripe</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};
```

### 3.4 アカウント設定ページ

#### 3.4.1 課金管理セクション

```typescript
// components/BillingSettings.tsx
export const BillingSettings: React.FC = () => {
  const { usage, subscription } = useSubscriptionStatus();
  const [isLoading, setIsLoading] = useState(false);
  
  const handleManageSubscription = async () => {
    setIsLoading(true);
    
    try {
      // Stripe Customer Portalへリダイレクト
      const { data } = await supabase.functions.invoke(
        'create-portal-session',
        { body: { returnUrl: window.location.href } }
      );
      
      window.location.href = data.url;
    } catch (error) {
      toast.error('エラーが発生しました');
    } finally {
      setIsLoading(false);
    }
  };
  
  return (
    <div className="bg-white rounded-lg shadow">
      <div className="p-6 border-b border-gray-200">
        <h3 className="text-lg font-medium text-gray-900">
          プラン・お支払い
        </h3>
      </div>
      
      <div className="p-6 space-y-6">
        {/* 現在のプラン */}
        <div>
          <label className="text-sm font-medium text-gray-700">
            現在のプラン
          </label>
          <div className="mt-2 p-4 bg-gray-50 rounded-lg">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                {subscription?.status === 'active' ? (
                  <>
                    <Star className="h-6 w-6 text-yellow-500 fill-current" />
                    <div>
                      <p className="font-medium text-gray-900">
                        プレミアムプラン
                      </p>
                      <p className="text-sm text-gray-500">
                        ¥2,980/月（税込）
                      </p>
                    </div>
                  </>
                ) : (
                  <>
                    <User className="h-6 w-6 text-gray-400" />
                    <div>
                      <p className="font-medium text-gray-900">
                        無料プラン
                      </p>
                      <p className="text-sm text-gray-500">
                        月5回まで利用可能
                      </p>
                    </div>
                  </>
                )}
              </div>
              
              {subscription?.status === 'active' ? (
                <button
                  onClick={handleManageSubscription}
                  disabled={isLoading}
                  className="px-4 py-2 text-sm text-blue-600 hover:text-blue-700 
                           font-medium disabled:opacity-50"
                >
                  プラン管理
                </button>
              ) : (
                <button
                  onClick={() => setShowUpgradeModal(true)}
                  className="px-4 py-2 text-sm bg-blue-600 text-white 
                           rounded-md hover:bg-blue-700"
                >
                  アップグレード
                </button>
              )}
            </div>
          </div>
        </div>
        
        {/* 利用状況 */}
        {!subscription?.status && (
          <div>
            <label className="text-sm font-medium text-gray-700">
              今月の利用状況
            </label>
            <div className="mt-2">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-gray-600">
                  {usage.currentCount} / {usage.limit} 回使用
                </span>
                <span className="text-sm text-gray-500">
                  {Math.round((usage.currentCount / usage.limit) * 100)}%
                </span>
              </div>
              <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-blue-600 transition-all"
                  style={{ width: `${(usage.currentCount / usage.limit) * 100}%` }}
                />
              </div>
              <p className="mt-2 text-xs text-gray-500">
                次回リセット: {formatDate(usage.periodEndDate)}
              </p>
            </div>
          </div>
        )}
        
        {/* 次回請求日（プレミアム会員のみ） */}
        {subscription?.current_period_end && (
          <div>
            <label className="text-sm font-medium text-gray-700">
              次回請求日
            </label>
            <p className="mt-1 text-gray-900">
              {formatDate(subscription.current_period_end)}
            </p>
          </div>
        )}
      </div>
    </div>
  );
};
```

## 4. モバイル対応

### 4.1 レスポンシブデザイン

```typescript
// モバイル用利用状況表示（画面下部固定）
const MobileUsageBar: React.FC = () => {
  const { usage } = useUsageStatus();
  
  if (usage.isSubscribed) return null;
  
  const remaining = usage.limit - usage.currentCount;
  
  return (
    <div className="fixed bottom-0 left-0 right-0 bg-white border-t 
                  border-gray-200 p-3 md:hidden z-40">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div className="w-24 h-1.5 bg-gray-200 rounded-full overflow-hidden">
            <div 
              className="h-full bg-blue-600"
              style={{ width: `${(usage.currentCount / usage.limit) * 100}%` }}
            />
          </div>
          <span className="text-xs text-gray-600">
            残り{remaining}回
          </span>
        </div>
        {remaining <= 2 && (
          <button className="text-xs text-blue-600 font-medium">
            アップグレード
          </button>
        )}
      </div>
    </div>
  );
};
```

## 5. 状態管理

### 5.1 カスタムフック

```typescript
// hooks/useUsageStatus.ts
export const useUsageStatus = () => {
  const { user } = useAuthContext();
  const [usage, setUsage] = useState<UsageStatus | null>(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    if (user) {
      loadUsageStatus();
    }
  }, [user]);
  
  const loadUsageStatus = async () => {
    try {
      const status = await checkUsageLimit(user.id);
      setUsage(status);
    } catch (error) {
      console.error('Failed to load usage status:', error);
    } finally {
      setLoading(false);
    }
  };
  
  const refetch = () => loadUsageStatus();
  
  return { usage, loading, refetch };
};
```

## 6. エラー処理

### 6.1 エラー表示パターン

```typescript
// 決済エラー時のトースト表示
toast.error('決済処理に失敗しました。もう一度お試しください。');

// ネットワークエラー時
toast.error('ネットワークエラーが発生しました。接続を確認してください。');

// 認証エラー時
toast.error('ログインが必要です。');
```

## 7. アニメーション

### 7.1 トランジション

```css
/* プログレスバーのアニメーション */
.progress-bar {
  transition: width 0.3s ease-in-out;
}

/* モーダルの表示アニメーション */
.modal-enter {
  animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}
```

## 8. アクセシビリティ

### 8.1 ARIA属性

```typescript
<button
  aria-label="プレミアムプランにアップグレード"
  aria-describedby="upgrade-benefits"
  role="button"
>
  アップグレード
</button>

<div role="alert" aria-live="polite">
  利用制限に到達しました
</div>
```

## 9. テスト項目

### 9.1 UIテストケース

- [ ] 無料プラン: 利用回数が正しく表示される
- [ ] 無料プラン: 残り回数に応じて警告が表示される
- [ ] 無料プラン: 制限到達時にボタンが無効化される
- [ ] プレミアム会員: バッジが表示される
- [ ] プレミアム会員: 利用制限が表示されない
- [ ] モーダル: 正しく開閉する
- [ ] モバイル: レスポンシブ表示が正しい

## 10. パフォーマンス最適化

### 10.1 最適化項目

```typescript
// 利用状況の定期更新（5分ごと）
useEffect(() => {
  const interval = setInterval(() => {
    refetchUsage();
  }, 5 * 60 * 1000);
  
  return () => clearInterval(interval);
}, []);

// コンポーネントのメモ化
const UsageStatusBar = React.memo(UsageStatusBarComponent);
```

---

**次のステップ**: このUI仕様書に基づいて実装を進める
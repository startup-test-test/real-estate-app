# Stripeæ±ºæ¸ˆæ©Ÿèƒ½ å®Ÿè£…æ‰‹é †æ›¸

ä½œæˆæ—¥: 2025å¹´8æœˆ12æ—¥  
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.1.0 (æœˆ3å›åˆ¶é™ç‰ˆ)  
æ›´æ–°æ—¥: 2025å¹´8æœˆ12æ—¥

## 1. äº‹å‰æº–å‚™

### 1.1 Stripeã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š

1. **Stripeã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ**
   - https://stripe.com/jp ã«ã‚¢ã‚¯ã‚»ã‚¹
   - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼ˆæ—¥æœ¬ã®äº‹æ¥­è€…ã¨ã—ã¦ç™»éŒ²ï¼‰

2. **ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š**
   - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã€Œãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã€ã‚’ON
   - APIã‚­ãƒ¼ã‚’ãƒ¡ãƒ¢ï¼ˆå…¬é–‹å¯èƒ½ã‚­ãƒ¼ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ï¼‰

3. **å•†å“ãƒ»ä¾¡æ ¼ã®ä½œæˆ**
   ```
   å•†å“å: å¤§å®¶DX ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³
   ä¾¡æ ¼: 2,980å††/æœˆ
   è«‹æ±‚æœŸé–“: æœˆé¡
   é€šè²¨: JPY
   ç„¡æ–™ãƒ—ãƒ©ãƒ³: æœˆ3å›ã¾ã§åˆ©ç”¨å¯èƒ½
   ```

### 1.2 Supabaseè¨­å®š

1. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ**ï¼ˆæ—¢å­˜ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
2. **Edge Functionsæœ‰åŠ¹åŒ–**
3. **ç’°å¢ƒå¤‰æ•°è¨­å®š**

## 2. å®Ÿè£…ã®é€²ã‚æ–¹

### Phase 1: åŸºç›¤æ§‹ç¯‰ï¼ˆ1æ—¥ç›®ï¼‰

#### 1.1 Stripeã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š
- å•†å“ãƒ»ä¾¡æ ¼ä½œæˆï¼ˆÂ¥2,980/æœˆï¼‰
- Webhookè¨­å®š

#### 1.2 Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ©ç”¨çŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE user_usage (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  usage_count INTEGER DEFAULT 0,
  period_start_date TIMESTAMP DEFAULT NOW(),
  period_end_date TIMESTAMP DEFAULT (NOW() + INTERVAL '30 days'),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id)
);

-- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE subscriptions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  stripe_customer_id TEXT UNIQUE,
  stripe_subscription_id TEXT UNIQUE,
  status TEXT DEFAULT 'inactive',
  current_period_end TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id)
);

-- åˆ©ç”¨å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE usage_history (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  feature_type TEXT NOT NULL,
  feature_data JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_user_usage_user_id ON user_usage(user_id);
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_usage_history_user_id ON usage_history(user_id);

-- RLSæœ‰åŠ¹åŒ–
ALTER TABLE user_usage ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE usage_history ENABLE ROW LEVEL SECURITY;

-- ãƒãƒªã‚·ãƒ¼è¨­å®š
CREATE POLICY "Users can view own usage" ON user_usage
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can view own subscription" ON subscriptions
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can view own history" ON usage_history
  FOR SELECT USING (auth.uid() = user_id);

-- æœŸé–“ãƒã‚§ãƒƒã‚¯é–¢æ•°ï¼ˆ30æ—¥ã”ã¨ã®è‡ªå‹•ãƒªã‚»ãƒƒãƒˆï¼‰
CREATE OR REPLACE FUNCTION check_and_reset_usage(p_user_id UUID)
RETURNS TABLE(current_count INTEGER, period_end TIMESTAMP) AS $$
DECLARE
  v_usage RECORD;
BEGIN
  SELECT * INTO v_usage FROM user_usage WHERE user_id = p_user_id;
  
  IF NOT FOUND THEN
    INSERT INTO user_usage (user_id)
    VALUES (p_user_id)
    RETURNING usage_count, period_end_date INTO current_count, period_end;
    RETURN NEXT;
    RETURN;
  END IF;
  
  IF v_usage.period_end_date < NOW() THEN
    UPDATE user_usage 
    SET usage_count = 0,
        period_start_date = NOW(),
        period_end_date = NOW() + INTERVAL '30 days',
        updated_at = NOW()
    WHERE user_id = p_user_id
    RETURNING usage_count, period_end_date INTO current_count, period_end;
  ELSE
    current_count := v_usage.usage_count;
    period_end := v_usage.period_end_date;
  END IF;
  
  RETURN NEXT;
END;
$$ LANGUAGE plpgsql;
```

### Phase 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆ2æ—¥ç›®ï¼‰

#### 2.1 å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# bolt_frontãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œ
cd bolt_front
npm install @stripe/stripe-js
```

#### 2.2 ç’°å¢ƒå¤‰æ•°è¨­å®š

```bash
# .env.local
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx
VITE_STRIPE_PRICE_ID=price_xxxxx
```

#### 2.3 ä½¿ç”¨åˆ¶é™ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

`bolt_front/src/utils/usageLimit.ts`:
```typescript
import { supabase } from '../lib/supabase';

interface UsageStatus {
  canUse: boolean;
  currentCount: number;
  limit: number;
  isSubscribed: boolean;
  periodEndDate: Date | null;
  daysLeft: number;
}

export const checkUsageLimit = async (userId: string): Promise<UsageStatus> => {
  // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèª
  const { data: subscription } = await supabase
    .from('subscriptions')
    .select('status')
    .eq('user_id', userId)
    .single();

  if (subscription?.status === 'active') {
    return {
      canUse: true,
      currentCount: 0,
      limit: -1,
      isSubscribed: true,
      periodEndDate: null,
      daysLeft: -1
    };
  }

  // ä½¿ç”¨çŠ¶æ³ç¢ºèªï¼ˆè‡ªå‹•ãƒªã‚»ãƒƒãƒˆè¾¼ã¿ï¼‰
  const { data } = await supabase
    .rpc('check_and_reset_usage', { p_user_id: userId });

  const usage = data?.[0] || { current_count: 0, period_end: new Date() };
  const periodEnd = new Date(usage.period_end);
  const daysLeft = Math.ceil((periodEnd.getTime() - Date.now()) / (1000 * 60 * 60 * 24));

  return {
    canUse: usage.current_count < 3,  // æœˆ3å›åˆ¶é™
    currentCount: usage.current_count,
    limit: 3,
    isSubscribed: false,
    periodEndDate: periodEnd,
    daysLeft: Math.max(0, daysLeft)
  };
};

export const incrementUsage = async (userId: string, featureType: string) => {
  // å±¥æ­´è¨˜éŒ²
  await supabase.from('usage_history').insert({
    user_id: userId,
    feature_type: featureType,
    feature_data: { timestamp: new Date().toISOString() }
  });

  // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
  const { data } = await supabase
    .from('user_usage')
    .select('usage_count')
    .eq('user_id', userId)
    .single();

  const newCount = (data?.usage_count || 0) + 1;

  await supabase
    .from('user_usage')
    .update({ 
      usage_count: newCount,
      updated_at: new Date().toISOString()
    })
    .eq('user_id', userId);

  return newCount;
};
```

#### 2.4 Supabase Edge Functions

```bash
supabase functions new create-checkout-session
```

`supabase/functions/create-checkout-session/index.ts`:
```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import Stripe from 'https://esm.sh/stripe@12.0.0?target=deno';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.7.1';

const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY')!, {
  apiVersion: '2023-10-16',
});

const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
);

serve(async (req) => {
  try {
    const authHeader = req.headers.get('Authorization')!;
    const token = authHeader.replace('Bearer ', '');
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
    const { data: { user }, error: authError } = await supabase.auth.getUser(token);
    if (authError || !user) {
      return new Response(JSON.stringify({ error: 'Unauthorized' }), {
        status: 401,
        headers: { 'Content-Type': 'application/json' },
      });
    }

    // Stripeã‚«ã‚¹ã‚¿ãƒãƒ¼ä½œæˆ/å–å¾—
    let customerId;
    const { data: sub } = await supabase
      .from('subscriptions')
      .select('stripe_customer_id')
      .eq('user_id', user.id)
      .single();

    if (sub?.stripe_customer_id) {
      customerId = sub.stripe_customer_id;
    } else {
      const customer = await stripe.customers.create({
        email: user.email,
        metadata: { user_id: user.id }
      });
      customerId = customer.id;

      await supabase.from('subscriptions').upsert({
        user_id: user.id,
        stripe_customer_id: customerId
      });
    }

    // Checkout Sessionä½œæˆ
    const session = await stripe.checkout.sessions.create({
      customer: customerId,
      payment_method_types: ['card'],
      line_items: [{
        price: Deno.env.get('STRIPE_PRICE_ID')!,
        quantity: 1
      }],
      mode: 'subscription',
      success_url: `${req.headers.get('origin')}/payment-success`,
      cancel_url: `${req.headers.get('origin')}/`,
    });

    return new Response(JSON.stringify({ sessionId: session.id }), {
      headers: { 'Content-Type': 'application/json' },
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 400,
      headers: { 'Content-Type': 'application/json' },
    });
  }
});
```

### Phase 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆ3-4æ—¥ç›®ï¼‰

#### 3.1 ä½¿ç”¨çŠ¶æ³è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

`bolt_front/src/components/UsageStatus.tsx`:
```typescript
import React, { useEffect, useState } from 'react';
import { useAuthContext } from './AuthProvider';
import { checkUsageLimit } from '../utils/usageLimit';
import { Calendar, AlertCircle } from 'lucide-react';

export const UsageStatus: React.FC = () => {
  const { user } = useAuthContext();
  const [usage, setUsage] = useState<any>(null);

  useEffect(() => {
    if (user) {
      loadUsage();
    }
  }, [user]);

  const loadUsage = async () => {
    if (!user) return;
    const status = await checkUsageLimit(user.id);
    setUsage(status);
  };

  if (!usage || usage.isSubscribed) return null;

  const remainingCount = usage.limit - usage.currentCount;
  const isWarning = remainingCount <= 1;
  const isError = remainingCount === 0;

  return (
    <div className={`p-3 rounded-lg border ${
      isError ? 'bg-red-50 border-red-200' :
      isWarning ? 'bg-yellow-50 border-yellow-200' :
      'bg-blue-50 border-blue-200'
    }`}>
      <div className="flex items-start gap-2">
        <AlertCircle className={`h-5 w-5 mt-0.5 ${
          isError ? 'text-red-500' :
          isWarning ? 'text-yellow-500' :
          'text-blue-500'
        }`} />
        <div className="flex-1">
          <p className={`text-sm font-medium ${
            isError ? 'text-red-800' :
            isWarning ? 'text-yellow-800' :
            'text-blue-800'
          }`}>
            {isError 
              ? 'ç„¡æ–™åˆ©ç”¨æ ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸ'
              : `ä»Šæœˆã®åˆ©ç”¨å¯èƒ½å›æ•°: ${remainingCount}/${usage.limit}å›`
            }
          </p>
          <div className="flex items-center gap-1 mt-1">
            <Calendar className="h-3 w-3 text-gray-500" />
            <p className="text-xs text-gray-600">
              æ¬¡å›ãƒªã‚»ãƒƒãƒˆ: {usage.periodEndDate?.toLocaleDateString('ja-JP')} 
              ï¼ˆã‚ã¨{usage.daysLeft}æ—¥ï¼‰
            </p>
          </div>
          {(isWarning || isError) && (
            <button className="text-xs text-blue-600 hover:text-blue-700 font-medium mt-2">
              ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ â†’
            </button>
          )}
        </div>
      </div>
    </div>
  );
};
```

#### 3.2 ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼å®Ÿè¡Œãƒœã‚¿ãƒ³

`bolt_front/src/components/SimulatorExecuteButton.tsx`:
```typescript
import React, { useState } from 'react';
import { useAuthContext } from './AuthProvider';
import { checkUsageLimit, incrementUsage } from '../utils/usageLimit';
import { PlayCircle, Lock, Star, Loader2 } from 'lucide-react';
import { UpgradeModal } from './UpgradeModal';

export const SimulatorExecuteButton: React.FC<{ onExecute: () => void }> = ({ onExecute }) => {
  const { user } = useAuthContext();
  const [usage, setUsage] = useState<any>(null);
  const [showUpgradeModal, setShowUpgradeModal] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  useEffect(() => {
    if (user) {
      loadUsage();
    }
  }, [user]);

  const loadUsage = async () => {
    const status = await checkUsageLimit(user.id);
    setUsage(status);
  };

  const handleClick = async () => {
    if (!usage.canUse && !usage.isSubscribed) {
      setShowUpgradeModal(true);
      return;
    }

    setIsLoading(true);
    await onExecute();
    
    if (!usage.isSubscribed) {
      await incrementUsage(user.id, 'simulator');
      await loadUsage();
    }
    setIsLoading(false);
  };

  // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡
  if (usage?.isSubscribed) {
    return (
      <button
        onClick={handleClick}
        disabled={isLoading}
        className="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 
                 text-white font-medium rounded-lg hover:opacity-90
                 disabled:opacity-50 disabled:cursor-not-allowed
                 flex items-center justify-center gap-2"
      >
        {isLoading ? (
          <Loader2 className="h-5 w-5 animate-spin" />
        ) : (
          <>
            <Star className="h-5 w-5" />
            <span>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</span>
          </>
        )}
      </button>
    );
  }

  // ç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼ˆåˆ©ç”¨å¯èƒ½ï¼‰
  if (usage?.canUse) {
    return (
      <>
        <button
          onClick={handleClick}
          disabled={isLoading}
          className="w-full px-6 py-3 bg-blue-600 text-white font-medium 
                   rounded-lg hover:bg-blue-700 disabled:opacity-50
                   flex items-center justify-center gap-2"
        >
          {isLoading ? (
            <Loader2 className="h-5 w-5 animate-spin" />
          ) : (
            <>
              <PlayCircle className="h-5 w-5" />
              <span>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</span>
              <span className="text-xs opacity-80">
                ï¼ˆæ®‹ã‚Š{usage.limit - usage.currentCount}å›ï¼‰
              </span>
            </>
          )}
        </button>
        
        {/* æ®‹ã‚Šå›æ•°ãŒå°‘ãªã„å ´åˆã®æ³¨æ„è¡¨ç¤º */}
        {usage.limit - usage.currentCount <= 1 && (
          <p className="mt-2 text-xs text-gray-500 text-center">
            ğŸ’¡ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã§ç„¡åˆ¶é™åˆ©ç”¨ãŒå¯èƒ½ã§ã™
          </p>
        )}
      </>
    );
  }

  // ç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼ˆåˆ¶é™åˆ°é”ï¼‰
  return (
    <>
      <button
        onClick={() => setShowUpgradeModal(true)}
        className="w-full px-6 py-3 bg-gray-400 text-white font-medium 
                 rounded-lg cursor-not-allowed flex items-center 
                 justify-center gap-2"
      >
        <Lock className="h-5 w-5" />
        <span>åˆ©ç”¨åˆ¶é™ã«åˆ°é”</span>
      </button>
      
      <UpgradeModal 
        isOpen={showUpgradeModal}
        onClose={() => setShowUpgradeModal(false)}
      />
    </>
  );
};
```

### Phase 4: ãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´ï¼ˆ5æ—¥ç›®ï¼‰

#### 4.1 ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ

1. **ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ**
2. **ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼3å›å®Ÿè¡Œ**
3. **4å›ç›®ã§åˆ¶é™ç”»é¢è¡¨ç¤ºç¢ºèª**
4. **Stripeãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã§æ±ºæ¸ˆ**
   - ã‚«ãƒ¼ãƒ‰ç•ªå·: 4242 4242 4242 4242
   - æœ‰åŠ¹æœŸé™: ä»»æ„ã®æœªæ¥æ—¥ä»˜
   - CVC: ä»»æ„ã®3æ¡

#### 4.2 ã‚¨ãƒ©ãƒ¼å‡¦ç†ç¢ºèª

- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
- æ±ºæ¸ˆå¤±æ•—
- Webhookå¤±æ•—

### Phase 5: æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹ï¼ˆ6æ—¥ç›®ï¼‰

1. **Stripeæœ¬ç•ªã‚­ãƒ¼è¨­å®š**
2. **ç’°å¢ƒå¤‰æ•°æ›´æ–°**
3. **Edge Functionsãƒ‡ãƒ—ãƒ­ã‚¤**
4. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤**

## 3. ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### é–‹ç™ºå®Œäº†ç¢ºèª

- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] RLSè¨­å®š
- [ ] æœˆ3å›åˆ¶é™æ©Ÿèƒ½å®Ÿè£…
- [ ] ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ç”»é¢å®Ÿè£…
- [ ] Stripe Checkoutçµ±åˆ
- [ ] Webhookå‡¦ç†å®Ÿè£…
- [ ] 30æ—¥ã”ã¨ã®è‡ªå‹•ãƒªã‚»ãƒƒãƒˆå‹•ä½œç¢ºèª
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèª

- [ ] APIã‚­ãƒ¼ãŒç’°å¢ƒå¤‰æ•°ã§ç®¡ç†
- [ ] Webhookç½²åæ¤œè¨¼
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒã‚§ãƒƒã‚¯
- [ ] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

### æ³•çš„è¦ä»¶ç¢ºèª

- [ ] ç‰¹å®šå•†å–å¼•æ³•è¡¨è¨˜
- [ ] è¿”é‡‘ãƒãƒªã‚·ãƒ¼æ˜è¨˜
- [ ] åˆ©ç”¨è¦ç´„æ›´æ–°
- [ ] ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼æ›´æ–°

## 4. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| æ±ºæ¸ˆç”»é¢ãŒè¡¨ç¤ºã•ã‚Œãªã„ | Stripeã‚­ãƒ¼ã®è¨­å®šãƒŸã‚¹ | ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª |
| WebhookãŒå‹•ä½œã—ãªã„ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLé–“é•ã„ | Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç¢ºèª |
| ä½¿ç”¨å›æ•°ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œãªã„ | æœŸé–“è¨ˆç®—ã®ãƒã‚° | check_and_reset_usageé–¢æ•°ã‚’ç¢ºèª |
| RLSã‚¨ãƒ©ãƒ¼ | ãƒãƒªã‚·ãƒ¼è¨­å®šãƒŸã‚¹ | Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç¢ºèª |
| 3å›åˆ¶é™ãŒåŠ¹ã‹ãªã„ | ã‚«ã‚¦ãƒ³ãƒˆå‡¦ç†ã®ä¸å…·åˆ | incrementUsageé–¢æ•°ã‚’ç¢ºèª |

## 5. é‹ç”¨æ‰‹é †

### æœˆæ¬¡ç¢ºèªé …ç›®

1. **å£²ä¸Šç¢ºèª**
   - Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç¢ºèª
   - MRRè¨ˆç®—

2. **ä½¿ç”¨çŠ¶æ³åˆ†æ**
   - ç„¡æ–™æ ï¼ˆ3å›ï¼‰ä½¿ã„åˆ‡ã‚Šç‡
   - ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ï¼ˆç›®æ¨™10-15%ï¼‰

3. **ã‚¨ãƒ©ãƒ¼ç›£è¦–**
   - æ±ºæ¸ˆå¤±æ•—ç‡
   - Webhookã‚¨ãƒ©ãƒ¼

### é¡§å®¢å¯¾å¿œ

1. **æ±ºæ¸ˆå¤±æ•—æ™‚**
   - ã‚«ãƒ¼ãƒ‰æœ‰åŠ¹æœŸé™åˆ‡ã‚Œé€šçŸ¥
   - åˆ¥ã®æ±ºæ¸ˆæ–¹æ³•æ¡ˆå†…

2. **è§£ç´„æ™‚**
   - è§£ç´„ç†ç”±ãƒ’ã‚¢ãƒªãƒ³ã‚°
   - å†é–‹æ¡ˆå†…

## 6. é‡è¦ãªå®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ

### 6.1 ã‚«ã‚¦ãƒ³ãƒˆå¯¾è±¡ã®æ˜ç¢ºåŒ–
```typescript
// ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹æ“ä½œ
- âœ… æ–°è¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- âœ… æ–°è¦åˆ†æå®Ÿè¡Œï¼ˆä»Šå¾Œå®Ÿè£…ï¼‰

// ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„æ“ä½œ
- âŒ éå»ã®çµæœé–²è¦§
- âŒ PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ï¼‰
- âŒ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
- âŒ ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
```

### 6.2 ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®å‡¦ç†
```typescript
// æœŸé–“çµ‚äº†æ—¥ã‚’ã¾ãŸãå‡¦ç†
if (usage.periodEndDate < new Date()) {
  // è‡ªå‹•ãƒªã‚»ãƒƒãƒˆå‡¦ç†
  await resetUsageCount(userId);
}

// æ±ºæ¸ˆå¤±æ•—æ™‚ã®å‡¦ç†
if (paymentFailed) {
  // 3æ—¥é–“ã®çŒ¶äºˆæœŸé–“
  await setGracePeriod(userId, 3);
}
```

### 6.3 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®
```typescript
// ä½¿ç”¨çŠ¶æ³ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ5åˆ†é–“ï¼‰
const CACHE_DURATION = 5 * 60 * 1000;
let cachedUsage = null;
let cacheTime = null;

if (cachedUsage && Date.now() - cacheTime < CACHE_DURATION) {
  return cachedUsage;
}
```

---

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: ã“ã®æ‰‹é †æ›¸ã«å¾“ã£ã¦å®Ÿè£…ã‚’é€²ã‚ã€å®Œäº†å¾Œã¯é‹ç”¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§æ—¥ã€…ã®é‹ç”¨ã‚’ç¢ºèª
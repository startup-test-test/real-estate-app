# Stripe環境変数設定ガイド

## 必要な環境変数

### 1. フロントエンド用（.env.local）

```bash
# Stripe公開可能キー（テスト環境）
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_51Q6nvOP8K6BRPPRIiO3jBLDc5EibQ5S3nv8DF8bwxBhAoiKx2QdmMjGQaPhfYiKsBRLgQy6K5wTOTUFToCKXJLqj00QdBbGkQx

# Stripe価格ID（月額2,980円のプラン）
VITE_STRIPE_PRICE_ID=price_1Q6oC4P8K6BRPPRIWmwxDwHW
```

### 2. Supabase Edge Functions用

Supabaseダッシュボードで設定：

1. **プロジェクト設定** → **Edge Functions** → **Secrets**

```bash
# Stripeシークレットキー（テスト環境）
STRIPE_SECRET_KEY=sk_test_xxxxx

# Stripe Webhook署名シークレット
STRIPE_WEBHOOK_SECRET=whsec_xxxxx
```

### 3. GitHub Repository Secrets（CI/CD用）

GitHub リポジトリの Settings → Secrets and variables → Actions：

```bash
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=xxxxx
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx
VITE_STRIPE_PRICE_ID=price_xxxxx
```

## 環境変数の取得方法

### Stripe関連

1. [Stripe Dashboard](https://dashboard.stripe.com/test/apikeys) にアクセス
2. **開発者** → **APIキー** から取得
   - 公開可能キー: `pk_test_` で始まる
   - シークレットキー: `sk_test_` で始まる

3. **商品と価格の作成**:
   - 商品 → 新規作成
   - 名前: "大家DX プレミアムプラン"
   - 価格: ¥2,980/月
   - 価格IDをコピー

4. **Webhook エンドポイントの設定**:
   - 開発者 → Webhooks → エンドポイントを追加
   - URL: `https://xxxxx.supabase.co/functions/v1/handle-stripe-webhook`
   - イベント選択:
     - `checkout.session.completed`
     - `customer.subscription.updated`
     - `customer.subscription.deleted`
     - `invoice.payment_succeeded`
     - `invoice.payment_failed`
   - 署名シークレットをコピー

### Supabase関連

1. [Supabase Dashboard](https://app.supabase.com) にアクセス
2. プロジェクト設定 → API から取得
   - Project URL: `VITE_SUPABASE_URL`
   - anon public: `VITE_SUPABASE_ANON_KEY`
   - service_role: `SUPABASE_SERVICE_ROLE_KEY`（Edge Functions用）

## Edge Functionsのデプロイ

```bash
# Supabase CLIのインストール
npm install -g supabase

# ログイン
supabase login

# プロジェクトのリンク
supabase link --project-ref your-project-ref

# Edge Functionsのデプロイ
supabase functions deploy create-checkout-session
supabase functions deploy handle-stripe-webhook

# 環境変数の設定
supabase secrets set STRIPE_SECRET_KEY=sk_test_xxxxx
supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_xxxxx
```

## 動作確認

### 1. ローカル環境での確認

```bash
# .env.localに環境変数を設定後
npm run dev
```

1. ブラウザでダッシュボードにアクセス
2. シミュレーターを5回実行
3. アップグレードモーダルが表示されることを確認
4. 「今すぐアップグレード」をクリック
5. Stripe Checkout画面に遷移することを確認

### 2. テスト用カード番号

Stripe Checkoutでのテスト用カード番号：

- **成功**: `4242 4242 4242 4242`
- **失敗**: `4000 0000 0000 0002`
- **3Dセキュア**: `4000 0000 0000 3220`

有効期限: 任意の将来の日付
CVC: 任意の3桁の数字
郵便番号: 任意の5桁の数字

## トラブルシューティング

### よくあるエラー

1. **"Stripe is not defined"**
   - 原因: Stripe.jsが読み込まれていない
   - 解決: `VITE_STRIPE_PUBLISHABLE_KEY`が正しく設定されているか確認

2. **"Invalid API Key provided"**
   - 原因: APIキーが無効
   - 解決: Stripeダッシュボードから正しいキーをコピー

3. **"No such price"**
   - 原因: 価格IDが存在しない
   - 解決: Stripeダッシュボードで価格を作成し、IDを更新

4. **Webhook署名の検証エラー**
   - 原因: Webhook署名シークレットが不一致
   - 解決: Stripeダッシュボードから正しい署名をコピー

## セキュリティ注意事項

- ❌ シークレットキー（`sk_`）をフロントエンドで使用しない
- ❌ 環境変数をGitにコミットしない
- ✅ `.env.local`は`.gitignore`に含める
- ✅ 本番環境では本番用のキーを使用する
- ✅ Webhook署名を必ず検証する

## 本番環境への移行

1. Stripeダッシュボードで本番環境に切り替え
2. 本番用のAPIキーを取得
3. 本番用の価格を作成
4. 環境変数を本番用に更新
5. Webhookエンドポイントを本番URLに設定
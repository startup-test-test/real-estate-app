# 環境変数必要性 徹底調査結果

作成日: 2025年8月17日  
調査目的: 全環境変数の実際の使用状況を確認し、不要なものを特定

## 🔍 調査サマリー

- **調査対象**: GitHub Repository Secrets 14個 + Codespaces Secrets 2個
- **実際に使用中**: 15個
- **削除可能**: 6個
- **要修正**: 3個

## ✅ 実際に使用されている環境変数

### GitHub Actions ワークフロー

| 環境変数名 | 使用ファイル | 必要性 |
|-----------|------------|--------|
| **DEV_SUPABASE_URL** | deploy-to-xserver-dev.yml:39 | ✅ 必須 |
| **DEV_SUPABASE_ANON_KEY** | deploy-to-xserver-dev.yml:40 | ✅ 必須 |
| **DEV_API_BASE_URL** | deploy-to-xserver-dev.yml:41<br>manual-deploy.yml:38 | ⚠️ 使用中だが改善余地あり |
| **FTP_HOST** | 全FTPデプロイワークフロー | ✅ 必須 |
| **FTP_USERNAME** | 全FTPデプロイワークフロー | ✅ 必須 |
| **FTP_PASSWORD** | 全FTPデプロイワークフロー | ✅ 必須 |
| **FTP_PORT** | 全FTPデプロイワークフロー | ✅ 必須 |
| **SUPABASE_ACCESS_TOKEN** | deploy-edge-functions.yml:25,36 | ✅ 必須 |
| **STRIPE_SECRET_KEY** | deploy-edge-functions.yml:37,41 | ✅ 必須 |
| **STRIPE_WEBHOOK_SECRET_DEV** | deploy-edge-functions.yml:38 | ✅ 必須 |
| **VITE_GOOGLE_CLIENT_ID** | deploy-to-xserver.yml:34 | ✅ 必須 |

### Supabase Edge Functions

| 環境変数名 | 使用場所 | 実際の参照コード |
|-----------|---------|---------------|
| **STRIPE_SECRET_KEY** | cancel-subscription/index.ts:28<br>resume-subscription/index.ts:28 | `Deno.env.get('STRIPE_SECRET_KEY')` |
| **DEV_STRIPE_SECRET_KEY** | create-checkout-session/index.ts:6<br>handle-stripe-webhook/index.ts:5 | `Deno.env.get('DEV_STRIPE_SECRET_KEY')` |
| **DEV_STRIPE_WEBHOOK_SECRET** | handle-stripe-webhook/index.ts:12 | `Deno.env.get('DEV_STRIPE_WEBHOOK_SECRET')` |

### フロントエンドコード

| 環境変数名 | 使用場所 | 必要性 |
|-----------|---------|--------|
| **VITE_SUPABASE_URL** | lib/supabase.ts:3 | ✅ 必須（Codespaces用） |
| **VITE_SUPABASE_ANON_KEY** | lib/supabase.ts:4 | ✅ 必須（Codespaces用） |

## ❌ 削除可能な環境変数

### 1. 重複している環境変数

| 削除対象 | 理由 |
|---------|------|
| **DEV_STRIPE_WEBHOOK_SECRET** | `STRIPE_WEBHOOK_SECRET_DEV`と重複。Edge Functionsでは後者のみ使用 |

### 2. 未使用の環境変数

| 削除対象 | 調査結果 |
|---------|---------|
| **STRIPE_PRICE_ID** | Repository Secretsには存在するが、どこからも参照されていない |
| **VITE_STRIPE_PUBLISHABLE_KEY** | Repository Secretsには存在するが、フロントエンドで使用されていない |

## ⚠️ 問題のある実装

### 1. DEV_API_BASE_URL の現状

**問題点**:
- GitHub Actionsで`.env.production`に書き込まれる（deploy-to-xserver-dev.yml:41）
- しかし、最新の実装（api.ts）ではURLがハードコードされている
- `api.config.ts`は存在するが使用されていない

**推奨対応**:
```yaml
# deploy-to-xserver-dev.yml の該当行を削除可能
# Line 41: echo "VITE_API_BASE_URL=${{ secrets.DEV_API_BASE_URL }}" >> .env.production
```

### 2. ハードコードされた値

**PremiumPlan.tsx:324, UpgradeModal.tsx:54**:
```typescript
// 問題のコード
const priceId = import.meta.env.VITE_STRIPE_PRICE_ID || 'price_1RvChRR8rkVVzR7nAeDvfiur';

// 推奨修正
const priceId = import.meta.env.VITE_STRIPE_PRICE_ID;
if (!priceId) {
  throw new Error('VITE_STRIPE_PRICE_ID is not configured');
}
```

## 📊 最終結論

### 削除推奨リスト

1. **即座に削除可能**:
   - `DEV_STRIPE_WEBHOOK_SECRET` （未使用）
   - `STRIPE_PRICE_ID` （未使用）
   - `VITE_STRIPE_PUBLISHABLE_KEY` （未使用）

2. **コード修正後に削除可能**:
   - `DEV_API_BASE_URL` （api.tsでハードコード済み）

### 保持すべき環境変数

| 分類 | 環境変数名 | 理由 |
|------|-----------|------|
| **Supabase** | DEV_SUPABASE_URL<br>DEV_SUPABASE_ANON_KEY<br>SUPABASE_ACCESS_TOKEN | デプロイ・認証に必須 |
| **Stripe** | STRIPE_SECRET_KEY<br>STRIPE_WEBHOOK_SECRET_DEV | 決済処理に必須 |
| **FTP** | FTP_HOST<br>FTP_USERNAME<br>FTP_PASSWORD<br>FTP_PORT | Xserverデプロイに必須 |
| **OAuth** | VITE_GOOGLE_CLIENT_ID | Google認証に必須 |
| **Codespaces** | VITE_SUPABASE_URL<br>VITE_SUPABASE_ANON_KEY | 開発環境に必須 |

## 🎯 アクションアイテム

1. [ ] 不要な環境変数を GitHub Secrets から削除
2. [ ] deploy-to-xserver-dev.yml から DEV_API_BASE_URL の行を削除
3. [ ] PremiumPlan.tsx と UpgradeModal.tsx のハードコード修正
4. [ ] api.config.ts ファイルの削除検討
5. [ ] 環境変数の命名規則統一（FTP_* → XSERVER_FTP_*）

---

調査完了: 2025/08/17
# 本番リリースチェックシート

作成日: 2025年8月17日  
リリース予定日: ___________  
担当者: ___________  

## 📝 環境判定の仕組み

### コードは同じ、環境変数で切り替え

**その通りです！**
```
developブランチ → dev.ooya.tech（開発環境変数を使用）
mainブランチ → ooya.tech（本番環境変数を使用）
同じソースコード、異なる環境変数
```

### 現在の環境判定ロジック

1. **フロントエンド**（`bolt_front/src/config/environment.ts`）
```typescript
// ホスト名で自動判定
- ooya.tech → 本番環境
- dev.ooya.tech → 開発環境
- localhost → 開発環境
- *.app.github.dev → Codespaces
```

2. **GitHub Actions**
```yaml
# ブランチで自動判定
- developブランチ → deploy-to-xserver-dev.yml起動
- mainブランチ → deploy-to-xserver.yml起動
```

3. **環境変数**
```bash
# ビルド時に.env.productionに書き込まれる
開発: DEV_SUPABASE_URL, DEV_API_BASE_URL
本番: PROD_SUPABASE_URL, PROD_API_BASE_URL
```

---

## ✅ Phase 1: 事前準備（リリース1週間前）

### インフラ・外部サービス
- [ ] **Supabase本番プロジェクト作成**
  - [ ] プロジェクト作成完了
  - [ ] URL: _____________________
  - [ ] Anon Key: 取得済み

- [ ] **Stripe本番設定**（課金機能を使う場合）
  - [ ] 本番モード有効化
  - [ ] 商品・価格設定
  - [ ] Price ID: _____________________
  - [ ] Webhook設定

- [ ] **Google OAuth設定**（ソーシャルログインを使う場合）
  - [ ] 本番用Client ID作成
  - [ ] リダイレクトURI設定（https://ooya.tech/callback）
  - [ ] Client ID: _____________________

### ドメイン・サーバー
- [ ] **ooya.tech DNS設定**
  - [ ] Aレコード設定確認
  - [ ] SSL証明書有効
  - [ ] https://ooya.tech でアクセス可能

- [ ] **Xserver設定**
  - [ ] /public_html/ ディレクトリ準備
  - [ ] .htaccess設定（必要な場合）
  - [ ] PHPバージョン確認

---

## ✅ Phase 2: データベース構築（リリース3日前）

### Supabaseデータベース
- [ ] **テーブル作成**
  ```sql
  -- 必須テーブル
  - [ ] users
  - [ ] properties
  - [ ] subscription_status
  - [ ] usage_logs
  - [ ] その他: _____________________
  ```

- [ ] **RLS（Row Level Security）設定**
  - [ ] 各テーブルのRLS有効化
  - [ ] ポリシー設定完了
  - [ ] セキュリティテスト実施

- [ ] **Edge Functions**
  - [ ] create-checkout-session
  - [ ] handle-stripe-webhook
  - [ ] cancel-subscription
  - [ ] resume-subscription
  - [ ] デプロイ確認

- [ ] **初期データ**
  - [ ] マスタデータ投入
  - [ ] テストユーザー作成（必要な場合）

### データ移行（必要な場合）
- [ ] 開発環境からのデータエクスポート
- [ ] 本番環境へのインポート
- [ ] データ整合性確認

---

## ✅ Phase 3: 環境変数設定（リリース2日前）

### GitHub Repository Secrets
- [ ] **Supabase関連**
  - [ ] PROD_SUPABASE_URL（または MAIN_SUPABASE_URL）
  - [ ] PROD_SUPABASE_ANON_KEY（または MAIN_SUPABASE_ANON_KEY）
  - [ ] 値の確認: _____________________

- [ ] **Stripe関連**（課金機能を使う場合）
  - [ ] STRIPE_SECRET_KEY（本番用）
  - [ ] STRIPE_WEBHOOK_SECRET（本番用）
  - [ ] STRIPE_PRICE_ID（本番用）

- [ ] **その他**
  - [ ] PROD_API_BASE_URL（Render API）
  - [ ] VITE_GOOGLE_CLIENT_ID（必要な場合）

### 設定ファイル更新
- [ ] deploy-to-xserver.yml の環境変数確認
- [ ] Edge Functions の環境変数確認

---

## ✅ Phase 4: コード最終確認（リリース1日前）

### ソースコード
- [ ] **mainブランチの準備**
  ```bash
  git checkout main
  git merge develop
  git push origin main
  ```

- [ ] **ハードコーディングチェック**
  - [ ] APIエンドポイント
  - [ ] 環境固有の値
  - [ ] デバッグコード削除

- [ ] **セキュリティ確認**
  - [ ] console.log削除
  - [ ] エラーハンドリング
  - [ ] 機密情報の非表示

### ビルド確認
- [ ] **ローカルビルド**
  ```bash
  cd bolt_front
  npm run build
  # エラーがないこと確認
  ```

- [ ] **本番用環境変数でテスト**
  - [ ] .env.production作成
  - [ ] 本番APIに接続確認

---

## ✅ Phase 5: デプロイ前テスト（リリース当日）

### ステージングテスト（dev.ooya.techを活用）
- [ ] **本番環境変数でdev.ooya.techにデプロイ**
  - [ ] 一時的に環境変数を本番用に変更
  - [ ] 全機能動作確認

### 機能テストチェックリスト
- [ ] **認証機能**
  - [ ] ユーザー登録
  - [ ] ログイン/ログアウト
  - [ ] パスワードリセット
  - [ ] Googleログイン（設定した場合）

- [ ] **メイン機能**
  - [ ] 不動産シミュレーター計算
  - [ ] 結果表示
  - [ ] グラフ表示
  - [ ] PDFダウンロード

- [ ] **課金機能**（Stripe設定した場合）
  - [ ] プラン選択
  - [ ] 決済フロー
  - [ ] サブスクリプション管理
  - [ ] 解約処理

- [ ] **データ永続性**
  - [ ] データ保存
  - [ ] データ読み込み
  - [ ] ユーザー間のデータ分離

---

## ✅ Phase 6: 本番デプロイ（リリース実施）

### デプロイ実行
- [ ] **mainブランチにpush**
  ```bash
  git checkout main
  git push origin main
  # GitHub Actionsが自動起動
  ```

- [ ] **GitHub Actions確認**
  - [ ] ワークフロー正常終了
  - [ ] エラーログ確認
  - [ ] デプロイ完了通知

### デプロイ直後の確認
- [ ] **アクセス確認**
  - [ ] https://ooya.tech でページ表示
  - [ ] HTTPSが有効
  - [ ] 証明書エラーなし

- [ ] **スモークテスト**
  - [ ] トップページ表示
  - [ ] ログイン可能
  - [ ] 基本機能動作

---

## ✅ Phase 7: リリース後の確認（リリース後1時間）

### モニタリング
- [ ] **エラー監視**
  - [ ] ブラウザコンソールエラー
  - [ ] ネットワークエラー
  - [ ] 500エラーなし

- [ ] **パフォーマンス**
  - [ ] ページ読み込み速度
  - [ ] API応答速度
  - [ ] 画像読み込み

### ユーザーフィードバック
- [ ] テストユーザーからの報告
- [ ] 不具合報告の収集
- [ ] 緊急対応の必要性判断

---

## 🚨 緊急時の対応

### ロールバック手順
```bash
# 前のバージョンに戻す
git checkout main
git reset --hard [前のコミットハッシュ]
git push --force origin main
```

### 緊急連絡先
- 開発者: _____________________
- インフラ担当: _____________________
- Supabaseサポート: _____________________

---

## 📋 最終チェック

### リリース判定
- [ ] **全必須項目完了**
- [ ] **テスト合格**
- [ ] **ステークホルダー承認**

### リリース実施
- **実施日時**: _____________________
- **実施者**: _____________________
- **立会者**: _____________________

### リリース完了
- **完了時刻**: _____________________
- **結果**: □ 成功 / □ 失敗 / □ 一部成功
- **特記事項**: _____________________

---

## 📝 備考・申し送り事項

_____________________
_____________________
_____________________

---

## 🎯 次回アクション

- [ ] 不要な環境変数の削除
- [ ] 命名規則の統一（PROD → MAIN）
- [ ] ドキュメント更新
- [ ] パフォーマンス最適化

---

作成: 2025/08/17  
最終確認: _____________________
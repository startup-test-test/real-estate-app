# 環境変数設定完全ガイド

## 目次
1. [環境変数の基本概念（初心者向け）](#環境変数の基本概念初心者向け)
2. [開発環境での設定（Codespace）](#開発環境での設定codespace)
3. [本番環境での設定（Xserver）](#本番環境での設定xserver)
4. [セキュリティベストプラクティス](#セキュリティベストプラクティス)
5. [トラブルシューティング](#トラブルシューティング)

---

## 環境変数の基本概念（初心者向け）

### 🤔 環境変数とは？
環境変数は、アプリケーションの設定値を管理する仕組みです。パスワードやAPIキーなど、環境によって異なる値を安全に管理できます。

### なぜ環境変数の扱いが複雑なのか？

#### 1. Codespaces（開発環境）の場合
```
[GitHub Secrets] → [Codespace起動] → [環境変数として利用可能]
```
- **動的に読み込める**（リアルタイムで値を取得）
- 例：`process.env.VITE_API_URL`で直接アクセス可能

#### 2. Xserver（本番環境）の場合
```
[ビルド時に.envファイル読込] → [JavaScriptに埋め込み] → [静的ファイルとして配信]
```
- **ビルド時に固定される**（後から変更不可）
- 静的ホスティングなので、サーバー側の環境変数は存在しない

### 📝 具体的な例

#### ビルド前のコード
```javascript
const apiUrl = import.meta.env.VITE_API_URL;
// 開発時：環境変数から動的に取得
// ビルド時：.env.productionの値に置換
```

#### ビルド後のコード（実際にXserverに配置されるもの）
```javascript
const apiUrl = "https://real-estate-app-1-iii4.onrender.com";
// 文字列として埋め込まれている！
```

### 🔑 重要なポイント

#### 公開しても安全な情報のみ
- ✅ API URL（エンドポイント）
- ✅ Supabase URL
- ✅ Supabase anon key（RLSで保護されている）
- ❌ 秘密のAPIキー
- ❌ データベースのパスワード

---

## 開発環境での設定（Codespace）

### 1. Codespaceシークレットの設定（推奨）

1. GitHubの設定ページへアクセス
   - `https://github.com/settings/codespaces`

2. 「Codespace secrets」セクションで「New secret」をクリック

3. 以下のシークレットを追加：
   ```
   # API関連
   VITE_API_URL_DEV
   VITE_API_URL_PROD
   VITE_SUPABASE_URL
   VITE_SUPABASE_ANON_KEY
   
   # 本番環境FTP
   PROD_FTP_SERVER
   PROD_FTP_USERNAME
   PROD_FTP_PASSWORD
   
   # 開発環境FTP
   DEV_FTP_SERVER
   DEV_FTP_USERNAME
   DEV_FTP_PASSWORD
   
   # ステージング環境FTP
   STAGING_FTP_SERVER
   STAGING_FTP_USERNAME
   STAGING_FTP_PASSWORD
   ```

4. リポジトリを選択して保存

### 2. ローカル.envファイルの使用（開発時のみ）

1. `.env`ファイルを作成（.gitignoreに追加済み）
   ```bash
   cp .env.example .env
   ```

2. 実際の値を設定
   ```bash
   # .env
   VITE_API_URL=https://dev-api.onrender.com
   VITE_SUPABASE_URL=https://dev-project.supabase.co
   VITE_SUPABASE_ANON_KEY=dev-anon-key
   
   PROD_FTP_SERVER=your-actual-server.xserver.jp
   PROD_FTP_USERNAME=your-actual-username
   PROD_FTP_PASSWORD=your-actual-password
   ```

### 3. 環境変数の確認方法

```bash
# 環境変数が設定されているか確認（値は表示しない）
echo "PROD_FTP_SERVER: ${PROD_FTP_SERVER:+[SET]}"
echo "PROD_FTP_USERNAME: ${PROD_FTP_USERNAME:+[SET]}"
echo "PROD_FTP_PASSWORD: ${PROD_FTP_PASSWORD:+[SET]}"
```

### 4. ビルドコマンドが環境を決定

```bash
npm run build          # .env.productionを使用
npm run build:dev      # .env.developmentを使用
npm run dev            # Codespace環境変数を使用
```

---

## 本番環境での設定（Xserver）

### 1. 環境構成の推奨設計

#### 開発環境（develop）
```
ブランチ: develop
Xserver: dev.your-domain.com
Supabase: 開発用プロジェクト（無料プラン）
Render: 開発用API（無料プラン）
```

#### 本番環境（main）
```
ブランチ: main  
Xserver: your-domain.com
Supabase: 本番用プロジェクト（必要に応じて有料プラン）
Render: 本番用API（必要に応じて有料プラン）
```

### 2. GitHub Actions Secretsの設定

GitHubリポジトリの Settings > Secrets and variables > Actions で以下のシークレットを設定：

#### 本番環境（mainブランチ）
- `PROD_FTP_SERVER`: 本番FTPサーバーアドレス（例: your-domain.xserver.jp）
- `PROD_FTP_USERNAME`: 本番FTPユーザー名
- `PROD_FTP_PASSWORD`: 本番FTPパスワード

#### 開発環境（developブランチ）
- `DEV_FTP_SERVER`: 開発FTPサーバーアドレス（例: dev.your-domain.xserver.jp）
- `DEV_FTP_USERNAME`: 開発FTPユーザー名
- `DEV_FTP_PASSWORD`: 開発FTPパスワード

### 3. デプロイ先ディレクトリ構成

```
/home/username/
├── public_html/          # 本番環境（main）
│   └── index.html
├── public_html/dev/      # 開発環境（develop）
│   └── index.html
└── public_html/staging/  # ステージング環境（staging）
    └── index.html
```

### 4. Xserverでの設定

#### サブドメインの作成（オプション）
1. Xserverサーバーパネルにログイン
2. 「ドメイン設定」→「サブドメイン設定」
3. 以下のサブドメインを作成：
   - `dev.your-domain.com` → `/home/username/public_html/dev/`
   - `staging.your-domain.com` → `/home/username/public_html/staging/`

#### FTPアカウントの分離（推奨）
1. 「FTPアカウント設定」から環境別アカウントを作成
2. 各アカウントに適切なディレクトリ権限を設定

### 5. 環境別URL

- **本番**: https://your-domain.com
- **開発**: https://dev.your-domain.com
- **ステージング**: https://staging.your-domain.com

### 6. 手動デプロイコマンド

```bash
# 開発環境へデプロイ
./scripts/deploy-to-xserver.sh develop

# 本番環境へデプロイ
./scripts/deploy-to-xserver.sh main

# ステージング環境へデプロイ
./scripts/deploy-to-xserver.sh staging
```

### 7. 環境変数の管理

各環境で異なるAPIエンドポイントを使用する場合：

```javascript
// .env.production
VITE_API_URL=https://api.your-domain.com

// .env.development
VITE_API_URL=https://dev-api.your-domain.com

// .env.staging
VITE_API_URL=https://staging-api.your-domain.com
```

### 8. デプロイフロー

1. **開発**: developブランチにプッシュ → 自動的に開発環境へデプロイ
2. **テスト**: developからstagingへPR → マージ後ステージング環境へデプロイ
3. **本番**: stagingからmainへPR → マージ後本番環境へデプロイ

### 9. 実際の運用フロー

#### 開発時（Codespace）
1. Codespace Secretsに設定
2. 自動的に環境変数として利用可能
3. コード変更なしで値を変更可能

#### 本番デプロイ時（Xserver）
1. `.env.production`に本番用の値を設定
2. `npm run build`でビルド
3. ビルド済みファイルをXserverにアップロード
4. **値はJavaScriptファイルに埋め込まれている**

---

## セキュリティベストプラクティス

### ❌ やってはいけないこと
- パスワードをコードに直接記述
- .envファイルをGitにコミット
- MDファイルに認証情報を記載
- 秘密のAPIキーをフロントエンドで使用
- データベースのパスワードをブラウザに送信

### ✅ 推奨される方法
- Codespaceシークレット使用
- GitHub Actions Secretsの活用
- .envファイルは.gitignoreに追加
- パスワードは定期的に変更
- 環境別にアカウントを分離
- 最小権限の原則を適用

### .envファイルの権限設定
```bash
chmod 600 .env  # 所有者のみ読み書き可能
```

### 🚨 重要な注意事項

1. **パスワードは絶対にコードやドキュメントに記載しない**
2. **Secretsは一度設定すると値は表示されない**（更新は可能）
3. **設定後はCodespaceの再起動が必要な場合がある**
4. **公開される前提で.envファイルを作成する**

---

## トラブルシューティング

### 環境変数が読み込まれない場合

#### Codespaceの場合
```bash
# Codespaceを再起動
# または
source ~/.bashrc
```

#### ビルド時の場合
```bash
# 環境変数ファイルの存在確認
ls -la .env*

# ビルドコマンドの確認
npm run build -- --mode production
```

### FTP接続エラー

#### 確認項目
- Xserverのファイアウォール設定を確認
- FTPSを使用する場合はポート21が開いているか確認
- FTPアカウントの権限設定を確認

#### パーミッションエラー
```bash
# デプロイ後に実行権限を付与
chmod 755 /home/username/public_html/
chmod 644 /home/username/public_html/*.html
```

### キャッシュの問題
- CloudflareやXserverのキャッシュをクリア
- ブラウザのハードリロード（Ctrl+F5）
- ビルドキャッシュのクリア：`npm run clean && npm run build`

### 環境変数の値が反映されない

#### 開発環境
1. 環境変数名がVITE_で始まっているか確認
2. Codespaceの再起動
3. ターミナルの再起動

#### 本番環境
1. ビルド時に正しい.envファイルが使用されているか確認
2. ビルド成果物を確認（distフォルダ内のJSファイルを検索）
3. デプロイが正常に完了しているか確認

## まとめ

### 🎯 環境による違いを理解する

- **Codespace**: サーバーがあるので環境変数が使える
- **Xserver**: 静的ファイルのみなので、ビルド時に値を埋め込む必要がある
- **セキュリティ**: 公開される前提で.envファイルを作成する

### 💰 コスト削減のポイント

個人開発では以下がおすすめ：
1. Xserver: 1契約（サブドメイン利用）
2. Supabase: 2プロジェクト（両方無料プラン）
3. Render: 2つのAPI（両方無料プラン）

これで月額コストを最小限に抑えつつ、適切な環境分離が実現できます。

---
作成日: 2025年7月27日
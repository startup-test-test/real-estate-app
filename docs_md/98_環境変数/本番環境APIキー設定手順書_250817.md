# 本番環境APIキー設定手順書

作成日: 2025年8月17日  
目的: 本番環境（ooya.tech）用のAPIキーを作成し、開発環境と分離する

## 📋 設定が必要なAPIキー一覧

### 1. 必須（本番動作に必要）

| サービス | 現在の状況 | 新規作成 | 環境変数名 |
|---------|-----------|---------|-----------|
| **Supabase** | 開発と共通 | ✅ 必要 | `MAIN_SUPABASE_URL`<br>`MAIN_SUPABASE_ANON_KEY` |
| **Stripe** | 一部設定済み | ✅ 必要 | `MAIN_STRIPE_SECRET_KEY`<br>`MAIN_STRIPE_WEBHOOK_SECRET`<br>`MAIN_STRIPE_PRICE_ID` |
| **Google OAuth** | 開発と共通 | ✅ 推奨 | `MAIN_GOOGLE_CLIENT_ID` |
| **Render API** | URLのみ | ❌ 不要 | `MAIN_RENDER_API_URL` (URLのみ) |

### 2. Codespaces Secrets について

**答え: 場合によっては必要です**

#### Codespaces Secretsが必要なケース
- Codespacesでmainブランチに切り替えて作業する場合
- Codespacesから本番環境のデバッグを行う場合
- `npm run dev`で本番APIに接続してテストする場合

#### 推奨設定
```bash
# Codespaces Secrets（本番テスト用）
MAIN_VITE_SUPABASE_URL=https://xxxxx.supabase.co
MAIN_VITE_SUPABASE_ANON_KEY=eyJhbGc...
```

#### 運用方法
1. **通常時**: developブランチで開発（DEV環境変数を使用）
2. **本番テスト時**: mainブランチに切り替え
   - 環境変数を手動で切り替えるか
   - ブランチ判定で自動切り替え

**注意**: Codespaces SecretsとRepository Secretsは別物
- Codespaces Secrets: 開発時の環境変数（`npm run dev`で使用）
- Repository Secrets: GitHub Actionsのデプロイ時に使用

## 🔧 各サービスの設定手順

### 1. Supabase - 本番プロジェクト作成

#### Step 1: 新規プロジェクト作成
1. [Supabase Dashboard](https://supabase.com)にログイン
2. 「New Project」をクリック
3. プロジェクト名: `real-estate-prod`（例）
4. データベースパスワード: 強力なものを生成
5. リージョン: Northeast Asia (Tokyo)を選択

#### Step 2: APIキー取得
1. Settings → API
2. 以下をコピー：
   - Project URL: `https://xxxxx.supabase.co`
   - anon public: `eyJhbGc...`

#### Step 3: データベース設定
```sql
-- 開発環境と同じテーブル構造を作成
-- 既存のスキーマをエクスポートして適用
```

#### Step 4: RLS (Row Level Security) 設定
- 開発環境と同じポリシーを適用
- 本番環境では特に厳格に設定

### 2. Stripe - 本番環境設定

#### Step 1: 本番モード切り替え
1. [Stripe Dashboard](https://dashboard.stripe.com)にログイン
2. 「テストモード」を「本番モード」に切り替え
3. ⚠️ **重要**: 本番モードは実際の決済が発生

#### Step 2: 本番用APIキー取得
1. 開発者 → APIキー
2. 以下をコピー：
   - 公開可能キー: `pk_live_...`
   - シークレットキー: `sk_live_...`

#### Step 3: 商品・価格設定
1. 商品 → 新規作成
2. プラン名: 「プレミアムプラン」
3. 価格: ¥980/月
4. Price IDをコピー: `price_...`

#### Step 4: Webhook設定
1. 開発者 → Webhook
2. エンドポイント追加:
   - URL: `https://xxxxx.supabase.co/functions/v1/handle-stripe-webhook`
3. イベント選択:
   - `checkout.session.completed`
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
4. Webhook署名シークレットをコピー: `whsec_...`

### 3. Google OAuth - 本番用Client ID作成

#### Step 1: Google Cloud Console設定
1. [Google Cloud Console](https://console.cloud.google.com)
2. プロジェクト選択または新規作成
3. APIとサービス → 認証情報

#### Step 2: OAuth 2.0 クライアントID作成
1. 「認証情報を作成」→「OAuth クライアント ID」
2. アプリケーションの種類: ウェブアプリケーション
3. 名前: `Real Estate App - Production`

#### Step 3: 承認済みURI設定
```
承認済みのJavaScript生成元:
- https://ooya.tech

承認済みのリダイレクトURI:
- https://ooya.tech/callback
- https://xxxxx.supabase.co/auth/v1/callback
```

#### Step 4: Client ID取得
- クライアントID: `xxxxx.apps.googleusercontent.com`をコピー

### 4. Render API - URL設定

#### 本番用サービス確認
1. [Render Dashboard](https://dashboard.render.com)にログイン
2. 本番用サービス: `real-estate-app-1-iii4`
3. URL: `https://real-estate-app-1-iii4.onrender.com`

**注意**: これはAPIキーではなくURLなので、秘密情報ではない

## 📝 GitHub Secrets設定

### Repository Secretsに追加

```bash
# Supabase（本番）
MAIN_SUPABASE_URL=https://xxxxx.supabase.co
MAIN_SUPABASE_ANON_KEY=eyJhbGc...

# Stripe（本番）
MAIN_STRIPE_SECRET_KEY=sk_live_...
MAIN_STRIPE_PUBLISHABLE_KEY=pk_live_...
MAIN_STRIPE_WEBHOOK_SECRET=whsec_...
MAIN_STRIPE_PRICE_ID=price_...

# Google OAuth（本番）
MAIN_GOOGLE_CLIENT_ID=xxxxx.apps.googleusercontent.com

# Render API（本番）
MAIN_RENDER_API_URL=https://real-estate-app-1-iii4.onrender.com
```

## 🔄 切り分け処理が必要なファイル

### 1. GitHub Actions ワークフロー

#### `/workspaces/real-estate-app/.github/workflows/deploy-to-xserver.yml`
```yaml
# 現在（PROD_を使用）
echo "VITE_SUPABASE_URL=${{ secrets.PROD_SUPABASE_URL }}" > .env.production
echo "VITE_SUPABASE_ANON_KEY=${{ secrets.PROD_SUPABASE_ANON_KEY }}" >> .env.production

# 変更後（MAIN_を使用）
echo "VITE_SUPABASE_URL=${{ secrets.MAIN_SUPABASE_URL }}" > .env.production
echo "VITE_SUPABASE_ANON_KEY=${{ secrets.MAIN_SUPABASE_ANON_KEY }}" >> .env.production
echo "VITE_GOOGLE_CLIENT_ID=${{ secrets.MAIN_GOOGLE_CLIENT_ID }}" >> .env.production
echo "VITE_STRIPE_PUBLISHABLE_KEY=${{ secrets.MAIN_STRIPE_PUBLISHABLE_KEY }}" >> .env.production
```

### 2. Edge Functions デプロイ

#### 新規作成: `/workspaces/real-estate-app/.github/workflows/deploy-edge-functions-prod.yml`
```yaml
name: Deploy Edge Functions (Production)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: supabase/setup-cli@v1
        with:
          version: latest
          
      - run: |
          supabase functions deploy --project-ref ${{ secrets.MAIN_SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          STRIPE_SECRET_KEY: ${{ secrets.MAIN_STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.MAIN_STRIPE_WEBHOOK_SECRET }}
```

### 3. フロントエンドコード（修正不要な箇所）

#### `/workspaces/real-estate-app/bolt_front/src/config/api.ts`
```typescript
// すでに環境判定で切り分け済み
const API_URLS = {
  [Environment.PRODUCTION]: 'https://real-estate-app-1-iii4.onrender.com',  // 本番
  [Environment.DEVELOPMENT]: 'https://real-estate-app-rwf1.onrender.com',   // 開発
}
```

### 4. 環境変数読み込み

#### `/workspaces/real-estate-app/bolt_front/src/lib/supabase.ts`
```typescript
// 現在のコード（環境変数から自動読み込み）
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

// 変更不要（ビルド時に適切な値が設定される）
```

## ⚠️ 重要な注意事項

### セキュリティ
1. **本番のシークレットキーは絶対に公開しない**
   - `MAIN_STRIPE_SECRET_KEY`
   - `MAIN_STRIPE_WEBHOOK_SECRET`
   - Supabase Service Role Key（もし使う場合）

2. **本番環境では必ずHTTPS**
   - ooya.techはHTTPS必須
   - リダイレクトURIもHTTPSのみ

3. **アクセス制限**
   - Supabase: RLSを有効化
   - Stripe: Webhook署名を検証
   - Google OAuth: 承認済みURIを厳格に設定

### テスト方針
1. まず開発環境（dev.ooya.tech）で動作確認
2. ステージング環境があれば、そこでテスト
3. 最後に本番環境（ooya.tech）にデプロイ

## 📅 実装スケジュール案

### Phase 1: 準備（リリース前）
- [ ] この手順書の確認
- [ ] 必要なアカウント・権限の確認

### Phase 2: APIキー作成（リリース後）
- [ ] Supabase本番プロジェクト作成
- [ ] Stripe本番設定
- [ ] Google OAuth本番Client ID作成

### Phase 3: GitHub Secrets設定
- [ ] MAIN_プレフィックスで新規追加
- [ ] 既存のPROD_は一旦残す

### Phase 4: ワークフロー更新
- [ ] deploy-to-xserver.ymlを更新
- [ ] Edge Functions本番用ワークフロー作成

### Phase 5: 動作確認
- [ ] mainブランチにテストデプロイ
- [ ] 各機能の動作確認
- [ ] 問題なければPROD_プレフィックスの環境変数を削除

## 🎯 まとめ

### 今すぐ必要な作業
- なし（現在のPROD_設定で動作中）

### リリース後の作業
1. 本番用APIキーの作成（Supabase, Stripe, Google）
2. GitHub SecretsにMAIN_プレフィックスで追加
3. ワークフローを段階的に更新
4. テスト後、古い環境変数を削除

---

作成: 2025/08/17  
次回更新予定: 本番環境構築時
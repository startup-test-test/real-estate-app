# 環境変数管理一覧表

作成日: 2025年8月17日  
目的: 環境変数の整理と命名規則統一のための現状把握

## 📋 現在の環境変数一覧

### 1. GitHub Repository Secrets

| 環境変数名 | 種類 | 用途 | 使用場所 | 最終更新 | 新命名規則案 |
|-----------|------|------|----------|----------|-------------|
| **DEV_API_BASE_URL** | Render API | 開発環境のバックエンドAPIエンドポイント | - GitHub Actions (deploy-to-xserver-dev.yml)<br>- 開発環境ビルド時 | 3週間前 | DEV_RENDER_API_URL 
| **DEV_STRIPE_WEBHOOK_SECRET** | Stripe | 開発環境のStripe Webhookシークレット | Supabase Edge Functions | 5日前 | そのまま |
| **DEV_SUPABASE_ANON_KEY** | Supabase | 開発環境のSupabase公開APIキー | - GitHub Actions<br>- 開発環境ビルド時 | 3週間前 | そのまま |
| **DEV_SUPABASE_URL** | Supabase | 開発環境のSupabaseプロジェクトURL | - GitHub Actions<br>- 開発環境ビルド時 | 3週間前 | そのまま |
| **FTP_HOST** | Xserver | FTPサーバーホスト名 | GitHub Actions (FTPデプロイ) | 3週間前 | XSERVER_FTP_HOST |
| **FTP_PASSWORD** | Xserver | FTPパスワード | GitHub Actions (FTPデプロイ) | 3週間前 | XSERVER_FTP_PASSWORD |
| **FTP_PORT** | Xserver | FTPポート番号 | GitHub Actions (FTPデプロイ) | 3週間前 | XSERVER_FTP_PORT |
| **FTP_USERNAME** | Xserver | FTPユーザー名 | GitHub Actions (FTPデプロイ) | 3週間前 | XSERVER_FTP_USERNAME |
| **STRIPE_PRICE_ID** | Stripe | StripeのプランPrice ID | Supabase Edge Functions (checkout) | 5日前 | MAIN_STRIPE_PRICE_ID |
| **STRIPE_SECRET_KEY** | Stripe | Stripeの秘密キー | Supabase Edge Functions | 5日前 | MAIN_STRIPE_SECRET_KEY |
| **STRIPE_WEBHOOK_SECRET_DEV** | Stripe | 開発環境のWebhookシークレット（重複？） | Edge Functions | 5日前 | 削除候補（DEV_STRIPE_WEBHOOK_SECRETと重複） |
| **SUPABASE_ACCESS_TOKEN** | Supabase | Supabase CLIアクセストークン | GitHub Actions (Edge Functionsデプロイ) | 5日前 | そのまま |
| **VITE_GOOGLE_CLIENT_ID** | Google OAuth | Google OAuth クライアントID | フロントエンド（Google認証） | 5日前 | そのまま（公開情報） |
| **VITE_STRIPE_PUBLISHABLE_KEY** | Stripe | Stripe公開可能キー | フロントエンド（決済UI） | 5日前 | そのまま（公開情報） |

### 2. Codespaces Secrets

| 環境変数名 | 種類 | 用途 | 使用場所 | 最終更新 | 新命名規則案 |
|-----------|------|------|----------|----------|-------------|
| **VITE_SUPABASE_ANON_KEY** | Supabase | Supabase公開APIキー | Codespaces開発環境 | 2ヶ月前 | DEV_VITE_SUPABASE_ANON_KEY |
| **VITE_SUPABASE_URL** | Supabase | SupabaseプロジェクトURL | Codespaces開発環境 | 2ヶ月前 | DEV_VITE_SUPABASE_URL |

## 🔍 環境変数の詳細説明

### Supabase関連
- **URL**: Supabaseプロジェクトのエンドポイント（例: `https://xxxxx.supabase.co`）
- **Anon Key**: Row Level Security (RLS)で保護された公開APIキー
- **Access Token**: Supabase CLIでのデプロイ用認証トークン

### Stripe関連
- **Secret Key**: サーバーサイドでの決済処理用秘密キー（**絶対公開禁止**）
- **Publishable Key**: フロントエンドで使用する公開可能キー
- **Webhook Secret**: Stripeからのイベント検証用シークレット
- **Price ID**: サブスクリプションプランのID

### Render API関連
- **API Base URL**: Render.comにデプロイされたバックエンドAPIのURL

### Xserver FTP関連
- **FTP認証情報**: GitHub ActionsからXserverへの自動デプロイ用

### Google OAuth関連
- **Client ID**: Google OAuth認証用のクライアントID（公開情報）

## 🎯 命名規則の提案

### 基本ルール
1. **環境プレフィックス**
   - `DEV_` : 開発環境（developブランチ）
   - `MAIN_` : 本番環境（mainブランチ）

2. **サービスプレフィックス**
   - `SUPABASE_` : Supabase関連
   - `STRIPE_` : Stripe関連
   - `XSERVER_` : Xserver関連
   - `RENDER_` : Render.com関連

3. **フロントエンド変数**
   - `VITE_` : Viteビルド時に使用される環境変数は必須

### 命名例
```
# 開発環境（developブランチ）
DEV_SUPABASE_URL
DEV_SUPABASE_ANON_KEY
DEV_STRIPE_SECRET_KEY
DEV_RENDER_API_URL

# 本番環境（mainブランチ）
MAIN_SUPABASE_URL
MAIN_SUPABASE_ANON_KEY
MAIN_STRIPE_SECRET_KEY
MAIN_RENDER_API_URL

# 共通（環境に依存しない）
XSERVER_FTP_HOST
XSERVER_FTP_USERNAME
SUPABASE_ACCESS_TOKEN
VITE_GOOGLE_CLIENT_ID
```

## 📌 新命名規則案 - 完全版

### 現在の環境変数 → 新命名規則への変換表

| 現在の名前 | 新命名規則 | 理由 |
|-----------|-----------|------|
| **開発環境用** | | |
| DEV_API_BASE_URL | `DEV_RENDER_API_URL` | Render.comのAPIであることを明確化 |
| DEV_STRIPE_WEBHOOK_SECRET | そのまま | 既に適切な命名 |
| DEV_SUPABASE_ANON_KEY | そのまま | 既に適切な命名 |
| DEV_SUPABASE_URL | そのまま | 既に適切な命名 |
| **本番環境用（新規追加）** | | |
| - | `MAIN_RENDER_API_URL` | 本番用Render API |
| - | `MAIN_STRIPE_WEBHOOK_SECRET` | 本番用Stripe Webhook |
| - | `MAIN_SUPABASE_ANON_KEY` | 本番用Supabase APIキー |
| - | `MAIN_SUPABASE_URL` | 本番用Supabase URL |
| - | `MAIN_STRIPE_SECRET_KEY` | 本番用Stripe秘密キー |
| **共通インフラ** | | |
| FTP_HOST | `XSERVER_FTP_HOST` | Xserver固有であることを明確化 |
| FTP_PASSWORD | `XSERVER_FTP_PASSWORD` | Xserver固有であることを明確化 |
| FTP_PORT | `XSERVER_FTP_PORT` | Xserver固有であることを明確化 |
| FTP_USERNAME | `XSERVER_FTP_USERNAME` | Xserver固有であることを明確化 |
| **Stripe関連** | | |
| STRIPE_PRICE_ID | `MAIN_STRIPE_PRICE_ID` | 本番環境のPrice ID |
| STRIPE_SECRET_KEY | `MAIN_STRIPE_SECRET_KEY` | 本番環境の秘密キー |
| STRIPE_WEBHOOK_SECRET_DEV | そのまま（Edge Functions用） | Edge Functionsデプロイで使用中 |
| **その他（変更不要）** | | |
| SUPABASE_ACCESS_TOKEN | そのまま | CLIトークンは環境共通 |
| VITE_GOOGLE_CLIENT_ID | そのまま | 公開情報、環境共通 |
| VITE_STRIPE_PUBLISHABLE_KEY | そのまま | 公開情報、環境共通 |
| **Codespaces Secrets** | | |
| VITE_SUPABASE_ANON_KEY | そのまま | Codespaces専用 |
| VITE_SUPABASE_URL | そのまま | Codespaces専用 |

## 🔍 Render APIについての説明

### DEV_API_BASE_URL（DEV_RENDER_API_URL）とは？

**これはAPIキーではありません！URLです。**

- **内容**: `https://real-estate-app-rwf1.onrender.com` のようなURL
- **取得方法**: 
  1. Render.comにログイン
  2. デプロイ済みのサービスを選択
  3. サービスのダッシュボードに表示されているURLをコピー

### ⚠️ 重要：DEV_API_BASE_URLの現状

**調査結果（2025/08/17）**：

1. **3週間前（2025/07/27）の実装**:
   - `api.config.ts`を作成して環境変数`VITE_API_URL_DEV`を参照
   - GitHub Secretsの`DEV_API_BASE_URL`を`.env.production`に書き込む設定

2. **最新の実装（2025/08/16）**:
   - `api.ts`で環境判定ロジックを実装
   - URLを直接ハードコード（環境変数不要）
   - `api.config.ts`は現在**使われていない**

3. **結論**:
   - `DEV_API_BASE_URL`は**現在使われていない可能性が高い**
   - ただし、GitHub Actionsのワークフローには残っている
   - 削除する場合は、ワークフローの修正も必要
  
**Render.comとは**:
- PaaS（Platform as a Service）でアプリケーションをホスティング
- このプロジェクトでは、Python FastAPIで作った不動産シミュレーターAPIが動いている
- 無料プランでも使用可能

**なぜURLを環境変数にするのか**:
- 開発環境と本番環境で異なるAPIサーバーを使うため
- ハードコーディングを避けるため
- 環境ごとに適切なAPIエンドポイントに接続するため

### 環境ごとのRender API設定

| 環境 | Render サービス名 | URL | 環境変数名 |
|------|-----------------|-----|-----------|
| 開発 | real-estate-app-rwf1 | https://real-estate-app-rwf1.onrender.com | DEV_RENDER_API_URL |
| 本番 | real-estate-app-1-iii4 | https://real-estate-app-1-iii4.onrender.com | MAIN_RENDER_API_URL |

## 📝 移行計画

### Phase 1: 重複の削除
- [ ] `STRIPE_WEBHOOK_SECRET_DEV` と `DEV_STRIPE_WEBHOOK_SECRET` の統合

### Phase 2: 本番環境変数の追加
- [ ] `MAIN_SUPABASE_URL`
- [ ] `MAIN_SUPABASE_ANON_KEY`
- [ ] `MAIN_RENDER_API_URL`
- [ ] `MAIN_STRIPE_SECRET_KEY`
- [ ] `MAIN_STRIPE_WEBHOOK_SECRET`

### Phase 3: 既存環境変数のリネーム
1. GitHub Actionsワークフローの更新
2. Edge Functionsの環境変数参照の更新
3. フロントエンドコードの更新
4. ドキュメントの更新

### Phase 4: テスト実施
- [ ] 開発環境デプロイテスト
- [ ] Edge Functionsデプロイテスト
- [ ] Stripe Webhook動作確認
- [ ] 本番環境デプロイテスト

## ⚠️ 注意事項

### セキュリティ
- **絶対に公開してはいけない環境変数**:
  - `*_STRIPE_SECRET_KEY`
  - `*_STRIPE_WEBHOOK_SECRET`
  - `XSERVER_FTP_PASSWORD`
  - `SUPABASE_ACCESS_TOKEN`

### 公開しても安全な環境変数
- `VITE_*` プレフィックスの環境変数（フロントエンドビルド用）
- `*_SUPABASE_URL`
- `*_SUPABASE_ANON_KEY`（RLSで保護）
- `VITE_GOOGLE_CLIENT_ID`
- `VITE_STRIPE_PUBLISHABLE_KEY`

## ❓ 重複している環境変数の調査結果

### 1. STRIPE_WEBHOOK_SECRET_DEV vs DEV_STRIPE_WEBHOOK_SECRET
**調査結果**: **重複していません**
- `STRIPE_WEBHOOK_SECRET_DEV`: deploy-edge-functions.ymlで使用（Edge Functionsデプロイ用）
- `DEV_STRIPE_WEBHOOK_SECRET`: 現在未使用（将来の開発環境用に予約？）
- **推奨**: `STRIPE_WEBHOOK_SECRET_DEV`を使用継続、`DEV_STRIPE_WEBHOOK_SECRET`は削除可能

### 2. Codespaces Secrets vs Repository Secrets (Supabase)
**調査結果**: **用途が異なるため重複ではありません**
- **Codespaces Secrets** (`VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`):
  - Codespaces内での開発時に環境変数として直接利用
  - `npm run dev`時に自動的に読み込まれる
  
- **Repository Secrets** (`DEV_SUPABASE_URL`, `DEV_SUPABASE_ANON_KEY`):
  - GitHub Actionsでのビルド・デプロイ時に使用
  - `.env.production`ファイルに書き込まれる

**重要**: 両方必要です。Codespaces用とGitHub Actions用で別々に管理されています。

## 🔄 更新履歴
- 2025/08/17: 初版作成、重複調査結果追加
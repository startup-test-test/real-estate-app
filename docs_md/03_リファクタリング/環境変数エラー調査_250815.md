# 環境変数エラー調査報告書
## 作成日: 2025年8月15日

## 🔴 問題の概要
Codespacesで設定した環境変数`VITE_DEV_RENDER_SIMULATOR_API`がViteアプリケーションのブラウザ側で認識されない問題

### エラーメッセージ
```
Simulator.tsx:794 シミュレーターAPIのURLが設定されていません。
環境変数VITE_DEV_RENDER_SIMULATOR_APIを設定してください。
```

## 🔍 調査結果

### 1. 環境変数の状態
| 場所 | 状態 | 値 |
|------|------|-----|
| Codespacesシステム環境変数 | ✅ 正常 | `https://real-estate-app-1-iii4.onrender.com` |
| Node.js (process.env) | ✅ 正常 | 正しく読み取れる |
| Viteサーバー内部 | ✅ 正常 | デバッグログで確認済み |
| ブラウザ (import.meta.env) | ❌ エラー | undefined |

### 2. 確認されたCodespaces Secrets

**GitHub Settings → Codespaces → Repository secretsで設定済み:**
```
Development environment secrets are environment variables that are encrypted. 
Secrets are not passed to forks.

Repository secrets:
- VITE_SUPABASE_URL (2ヶ月前に設定)
- VITE_SUPABASE_ANON_KEY (2ヶ月前に設定)  
- VITE_DEV_RENDER_SIMULATOR_API (本日38分前に新規追加)
```

**実際の値:**
```bash
VITE_SUPABASE_URL=https://gtnzhnsbdmkadfawuzmc.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbG...（省略）
VITE_DEV_RENDER_SIMULATOR_API=https://real-estate-app-1-iii4.onrender.com
```

**重要:** Codespacesを再作成した後でも、新しく追加したVITE_DEV_RENDER_SIMULATOR_APIがブラウザ側で認識されない問題が発生

### 3. 問題の原因
**Viteの環境変数読み込み優先順位:**
1. `.env.local`
2. `.env.[mode]` (例: `.env.development`)
3. `.env`
4. **システム環境変数（最低優先度）**

Codespacesのシークレットはシステム環境変数として設定されるため、`.env`ファイルが存在しない場合でも、Viteがブラウザに環境変数を渡さない仕様があることが判明。

## 🛠️ 試みた解決策

### 1. ✅ 起動スクリプトの作成
**ファイル:** `scripts/dev-with-env.js`
- Codespacesの環境変数を読み取り
- `.env.development.local`を自動生成
- Viteサーバーを起動

**結果:** ファイルは正しく生成されるが、ブラウザ側では認識されず

### 2. ✅ package.jsonの更新
```json
"scripts": {
  "dev": "node scripts/dev-with-env.js",
  "vite": "vite",
  "dev:direct": "vite"
}
```

### 3. ✅ .gitignoreの更新
`.env.development.local`を追加してGit管理外に

## 📊 テスト結果

### APIサーバー状態
- Render APIサーバー: ✅ 稼働中
- CORS設定: ✅ dev.ooya.tech許可済み
- エンドポイント `/api/simulate`: ⚠️ 500エラー（別問題）

### ブラウザテスト
- 環境変数読み込み: ❌ 失敗
- キャッシュクリア後: ❌ 改善なし
- ハードリロード後: ❌ 改善なし

## 🚨 根本的な問題
Viteの環境変数システムとCodespacesのシークレット管理の間に互換性の問題が存在する可能性がある。

## 💡 推奨される対応

### 短期的対応（即座に実装）
1. **ハードコーディングへの一時的な戻し**
   - `Simulator.tsx`でAPIのURLを直接記載
   - 開発を継続可能にする

### 中長期的対応
1. **環境変数管理の見直し**
   - GitHub ActionsのSecretsとの統合
   - ビルド時の環境変数注入
   
2. **代替案の検討**
   - 環境変数プロキシサーバーの実装
   - ランタイム設定ファイルの使用

## 📝 学んだこと
1. Viteは`.env`ファイルを強く優先する設計
2. Codespacesのシークレットは直接Viteアプリに渡すには追加の工夫が必要
3. 開発環境と本番環境で環境変数の扱いが異なる

## 🔗 関連ファイル
- `/workspaces/real-estate-app/bolt_front/src/pages/Simulator.tsx`
- `/workspaces/real-estate-app/bolt_front/scripts/dev-with-env.js`
- `/workspaces/real-estate-app/bolt_front/.env.development.local`
- `/workspaces/real-estate-app/docs_md/02_日報/開発日報_250815_1.md`

---
## 次のステップ
ハードコーディングに戻して開発を継続する
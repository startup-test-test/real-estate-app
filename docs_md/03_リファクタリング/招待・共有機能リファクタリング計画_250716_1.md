# 招待・共有機能リファクタリング計画 - 2025年07月16日

## 📊 リファクタリング分析サマリー

| 優先度 | ファイル名 | 現在行数 | 問題箇所 | 分割後行数 | 削減量 | 削減率 |
|--------|------------|----------|----------|------------|--------|--------|
| 🔴 最優先 | usePropertyShare.ts | 1,100行 | 10個の大関数、重複エラー処理 | 850行 | **250行** | 22.7% |
| 🟠 高優先 | CommentSection.tsx | 633行 | 内部コンポーネント、重複タグ処理 | 353行 | **280行** | 44.2% |
| 🟡 中優先 | CollaborationView.tsx | 387行 | 140行のloadShareData関数 | 287行 | **100行** | 25.8% |
| 🟢 低優先 | ShareView.tsx | 306行 | PDF生成、データ表示混在 | 216行 | **90行** | 29.4% |
| 🟢 低優先 | InviteModal.tsx | 217行 | 74行のhandleSendInvitation | 167行 | **50行** | 23.0% |

**📈 総計: 2,643行 → 1,873行（770行削減、29.1%削減）**

---

## 🔧 1. usePropertyShare.ts（最優先・250行削減）

### 現在の問題点
- **総行数**: 1,100行（プロジェクト最大のファイル）
- **主要関数**:
  - `createShare`: 102行 (17-118)
  - `sendInvitationEmail`: 68行 (128-195)
  - `sendInvitation`: 80行 (199-278)
  - `postComment`: 154行 (352-505)
  - `fetchComments`: 123行 (507-629)
  - `fetchOrCreateShareByPropertyId`: 100行 (831-930)
  - `fetchShareByPropertyId`: 64行 (933-996)

### 重複・冗長な箇所
- エラーハンドリングパターンが全関数で重複
- console.logによるデバッグ出力が散在（50箇所以上）
- fetchShare系の3つの関数で類似ロジック
- Supabaseエラー処理が各所で重複

### 分割案（6つのファイルに分割）

| ファイル名 | 責任 | 予想行数 | 主要機能 |
|------------|------|----------|----------|
| `useShareCRUD.ts` | 基本CRUD操作 | 200行 | create, read, update, delete |
| `useShareInvitation.ts` | 招待機能 | 150行 | 招待送信、URL生成 |
| `useShareComments.ts` | コメント機能 | 200行 | コメント投稿、取得、削除 |
| `useShareReactions.ts` | リアクション機能 | 100行 | いいね、リアクション管理 |
| `shareErrorHandler.ts` | エラー処理 | 50行 | 統一エラーハンドリング |
| `shareLogger.ts` | ログ処理 | 30行 | デバッグ出力統一 |

### リファクタリング例

**Before（現在）:**
```typescript
const createShare = async () => {
  try {
    // 処理...
  } catch (error) {
    console.error('Error in createShare:', error);
    setError(error.message || '共有の作成に失敗しました');
    return null;
  }
};

const sendInvitation = async () => {
  try {
    // 処理...
  } catch (error) {
    console.error('Error in sendInvitation:', error);
    setError(error.message || '招待の送信に失敗しました');
    return false;
  }
};
```

**After（リファクタリング後）:**
```typescript
// shareErrorHandler.ts
export const handleSupabaseError = (error: any, operation: string): string => {
  const errorMessage = error.message || `${operation}に失敗しました`;
  console.error(`Error in ${operation}:`, error);
  return errorMessage;
};

// useShareCRUD.ts
import { handleSupabaseError } from '../utils/shareErrorHandler';

const createShare = async () => {
  try {
    // 処理...
  } catch (error) {
    const errorMessage = handleSupabaseError(error, '共有の作成');
    setError(errorMessage);
    return null;
  }
};
```

### さらなる分割案
```typescript
// utils/shareValidation.ts (30行)
export const validateShareData = (data: ShareData): ValidationResult => {
  // バリデーションロジック
};

// utils/shareUrl.ts (40行)
export const generateInviteUrl = (token: string, type: 'simple' | 'full'): string => {
  const basePath = type === 'simple' ? '/simple-collaboration' : '/collaboration';
  return `${window.location.origin}${basePath}/${token}`;
};

// hooks/useShareState.ts (50行)
export const useShareState = () => {
  // loading, error, success状態の管理
};
```

---

## 🔧 2. CommentSection.tsx（高優先・280行削減）

### 現在の問題点
- **総行数**: 633行
- **内部構造**:
  - `CommentCard`コンポーネント: 195行 (272-466)
  - メインロジック: 271行
  - レンダリング部分: 167行

### 重複・冗長な部分
- タグ処理ロジックが2箇所で重複
- リアクションハンドリングの冗長な処理
- `showOnlyComments`モードで別レンダリング
- モックデータ生成が内部に混在

### 分割案（5つのファイルに分割）

| ファイル名 | 責任 | 予想行数 | 主要機能 |
|------------|------|----------|----------|
| `CommentCard.tsx` | 個別コメント表示 | 150行 | 単一コメントの表示・操作 |
| `CommentList.tsx` | コメント一覧 | 100行 | コメント一覧表示ロジック |
| `CommentForm.tsx` | コメント投稿 | 80行 | 新規コメント投稿フォーム |
| `useCommentTags.ts` | タグ処理 | 40行 | @メンションなどのタグ処理 |
| `CommentSection.tsx` | メインコンテナ | 120行 | 全体の統合・状態管理 |

### リファクタリング例

**Before（現在）:**
```typescript
// CommentSection.tsx内に195行のCommentCard
const CommentCard = ({ comment, onReaction, onReply }) => {
  // 195行の処理...
};

export const CommentSection = () => {
  // メインロジック + CommentCard定義
  return (
    <div>
      {comments.map(comment => 
        <CommentCard key={comment.id} comment={comment} />
      )}
    </div>
  );
};
```

**After（リファクタリング後）:**
```typescript
// components/comment/CommentCard.tsx
export const CommentCard = ({ comment, onReaction, onReply }) => {
  // 150行の処理（共通機能を分離）
};

// components/comment/CommentList.tsx
export const CommentList = ({ comments }) => {
  return (
    <div>
      {comments.map(comment => 
        <CommentCard key={comment.id} comment={comment} />
      )}
    </div>
  );
};

// CommentSection.tsx
import { CommentList } from './comment/CommentList';
import { CommentForm } from './comment/CommentForm';

export const CommentSection = () => {
  // シンプルな統合ロジックのみ
  return (
    <div>
      <CommentForm onSubmit={handleSubmit} />
      <CommentList comments={comments} />
    </div>
  );
};
```

### さらなる分割案
```typescript
// components/comment/CommentReactions.tsx (60行)
export const CommentReactions = ({ reactions, onReaction }) => {
  // いいね、返信ボタンなど
};

// components/comment/CommentMeta.tsx (40行)
export const CommentMeta = ({ author, createdAt, isEdited }) => {
  // 投稿者、日時表示
};

// hooks/useCommentActions.ts (50行)
export const useCommentActions = () => {
  // 投稿、削除、編集のアクション
};
```

---

## 🔧 3. CollaborationView.tsx（中優先・100行削減）

### 現在の問題点
- **総行数**: 387行
- **`loadShareData`関数**: 140行 (40-179)
  - 認証チェック: 約30行
  - 共有データ取得: 約50行
  - モックデータ生成: 約40行
  - エラーハンドリング: 約20行

### 分割案（4つのファイルに分割）

| ファイル名 | 責任 | 予想行数 | 主要機能 |
|------------|------|----------|----------|
| `useCollaborationAuth.ts` | 認証処理 | 60行 | 認証チェック、リダイレクト |
| `useCollaborationData.ts` | データ取得 | 80行 | 共有データのフェッチ |
| `collaborationMocks.ts` | モックデータ | 50行 | テスト用データ生成 |
| `CollaborationView.tsx` | UIコンポーネント | 150行 | 表示のみに専念 |

### リファクタリング例

**Before（現在）:**
```typescript
const loadShareData = async (token: string) => {
  // 140行の巨大関数
  // 認証チェック
  if (!user) {
    // 認証処理...
  }
  
  // データ取得
  const shareData = await fetchShare(token);
  
  // モックデータ生成
  if (!shareData) {
    const mockData = {
      // 40行のモックデータ...
    };
  }
  
  // エラーハンドリング
  // ...
};
```

**After（リファクタリング後）:**
```typescript
// hooks/useCollaborationAuth.ts
export const useCollaborationAuth = () => {
  const checkAuth = () => { /* 認証チェック */ };
  const handleRedirect = () => { /* リダイレクト処理 */ };
  return { checkAuth, handleRedirect };
};

// hooks/useCollaborationData.ts
export const useCollaborationData = () => {
  const fetchData = async (token: string) => { /* データ取得 */ };
  return { fetchData, loading, error };
};

// CollaborationView.tsx
const CollaborationView = () => {
  const { checkAuth } = useCollaborationAuth();
  const { fetchData } = useCollaborationData();
  
  // シンプルな統合ロジック
};
```

---

## 🔧 4. ShareView.tsx（低優先・90行削減）

### 現在の問題点
- **総行数**: 306行
- **PDF生成部分**: 40行 (59-99)
- **データ表示部分**: 171-285行が長大

### 分割案（3つのファイルに分割）

| ファイル名 | 責任 | 予想行数 | 主要機能 |
|------------|------|----------|----------|
| `ShareMetrics.tsx` | メトリクス表示 | 120行 | シミュレーション結果表示 |
| `usePdfGenerator.ts` | PDF生成 | 60行 | PDF生成ロジック |
| `ShareView.tsx` | メインビュー | 126行 | レイアウト統合 |

---

## 🔧 5. InviteModal.tsx（低優先・50行削減）

### 現在の問題点
- **総行数**: 217行
- **`handleSendInvitation`関数**: 74行 (38-111)
- 重複したエラーハンドリングとURL生成

### 分割案（2つのファイルに分割）

| ファイル名 | 責任 | 予想行数 | 主要機能 |
|------------|------|----------|----------|
| `useInvitationSender.ts` | 招待送信ロジック | 80行 | ビジネスロジック |
| `InviteModal.tsx` | モーダルUI | 87行 | UI表示のみ |

---

## 📋 追加の最適化提案

### A. 型定義の統合（50行削減）
```typescript
// types/share.ts - すべての共有関連型を統合
export interface ShareData {
  id: string;
  propertyId: string;
  ownerId: string;
  title?: string;
  description?: string;
}

export interface InvitationData {
  shareId: string;
  email: string;
  role: 'viewer' | 'commenter';
}

export interface CommentData {
  id: string;
  shareId: string;
  content: string;
  authorId: string;
}
```

### B. 定数の外部化（30行削減）
```typescript
// constants/shareConstants.ts
export const SHARE_ERRORS = {
  CREATE_FAILED: '共有の作成に失敗しました',
  INVITATION_FAILED: '招待の送信に失敗しました',
  NOT_FOUND: '共有が見つかりません',
} as const;

export const INVITATION_TYPES = {
  SIMPLE: 'simple',
  FULL: 'full',
} as const;

export const COMMENT_LIMITS = {
  MAX_LENGTH: 1000,
  MAX_TAGS: 5,
} as const;
```

### C. 共通ユーティリティ（100行削減）
```typescript
// utils/shareValidators.ts
export const validateEmail = (email: string): boolean => { /* ... */ };
export const validateShareTitle = (title: string): boolean => { /* ... */ };

// utils/shareFormatters.ts
export const formatDate = (date: Date): string => { /* ... */ };
export const formatUserName = (user: User): string => { /* ... */ };

// utils/shareHelpers.ts
export const generateShareToken = (): string => { /* ... */ };
export const parseShareToken = (token: string): ShareTokenData => { /* ... */ };
```

---

## 🎯 リファクタリング実行計画

### Phase 1: 基盤整備（1-2日）
1. **共通ユーティリティの作成**
   - `shareErrorHandler.ts`
   - `shareLogger.ts`
   - `shareConstants.ts`

### Phase 2: 大型ファイルの分割（3-5日）
1. **usePropertyShare.ts の分割**（最優先）
2. **CommentSection.tsx の分割**（高優先）

### Phase 3: 中小ファイルの最適化（2-3日）
1. **CollaborationView.tsx の分割**
2. **ShareView.tsx の分割**
3. **InviteModal.tsx の分割**

### Phase 4: 品質向上（1-2日）
1. **型定義の統合**
2. **テストの追加**
3. **ドキュメントの更新**

---

## 📊 最終予想効果

### コード削減効果
- **基本削減**: 770行（29.1%削減）
- **追加最適化**: 180行（6.8%削減）
- **総削減量**: 950行（36%削減）

### 品質向上効果
- **保守性**: 関数サイズの縮小、責任の明確化
- **可読性**: ファイル構造の整理、命名の統一
- **テスタビリティ**: 小さな関数への分割、依存関係の分離
- **再利用性**: コンポーネントの独立化、共通処理の抽出

### 開発効率向上
- **デバッグ容易性**: エラー箇所の特定が容易
- **機能追加**: 既存コードへの影響を最小化
- **チーム開発**: 責任範囲の明確化でコンフリクト減少

---

**💡 最終予想削減量: 950行（36%削減）**  
**🎯 推奨開始優先度: usePropertyShare.ts → CommentSection.tsx → CollaborationView.tsx**

---

**作成者**: Claude  
**作成日時**: 2025年07月16日  
**レビュー状況**: 未レビュー  
**実装予定**: Phase 1から順次実行予定
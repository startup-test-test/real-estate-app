# 大家DX 技術移行方針・システム設計書

**作成日**: 2025年1月6日
**目的**: Vite + Supabase構成からNext.js + Neon構成への移行

---

## 目次

1. [移行概要](#1-移行概要)
2. [システム全体構造](#2-システム全体構造)
3. [ユーザーフロー](#3-ユーザーフロー)
4. [データベース設計](#4-データベース設計)
5. [URL・ドメイン構成](#5-urlドメイン構成)
6. [技術スタック](#6-技術スタック)
7. [フォルダ構造](#7-フォルダ構造)
8. [移行ステップ](#8-移行ステップ)
9. [進捗状況](#9-進捗状況)
10. [課金設計](#10-課金設計)

---

## 1. 移行概要

### 移行前（bolt_front）

| 項目 | 技術 |
|------|------|
| フレームワーク | React 18 + Vite |
| ルーティング | React Router |
| データベース | Supabase |
| 認証 | Supabase Auth |
| 決済 | Stripe（部分実装） |
| CSS | Tailwind CSS 3 |
| デプロイ | Render |

### 移行後（ooya-dx_2026）

| 項目 | 技術 |
|------|------|
| フレームワーク | **Next.js 16** (App Router) |
| ルーティング | **ファイルベース（Next.js）** |
| データベース | **Neon (PostgreSQL)** |
| 認証 | **Neon Auth** |
| ORM | **Prisma** |
| 決済 | **Stripe（実装済み）** |
| CSS | Tailwind CSS 4 |
| デプロイ | **Vercel** |

### 移行理由

- Viteを廃止し、Next.jsに統一（SSR対応、SEO向上）
- Supabaseを廃止し、Neonに移行（コスト・パフォーマンス改善）
- startpackテンプレートを活用（認証・決済が実装済み）
- 将来の複数サービス展開に対応できる構造

---

## 2. システム全体構造

```
┌────────────────────────────────────────────────────────────────────┐
│                         ooya.tech                                   │
│                     （統合プラットフォーム）                          │
└────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌────────────────────────────────────────────────────────────────────┐
│                        Neon Auth（認証）                            │
│                      ユーザー登録・ログイン                          │
│                         【1回だけ】                                 │
└────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌────────────────────────────────────────────────────────────────────┐
│                      ダッシュボード（マイページ）                     │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐               │
│  │ シミュレーター │ │  サービスB   │ │  サービスC   │               │
│  │  月額1,000円  │ │  月額500円   │ │  月額2,000円 │               │
│  │   ✅ 契約中   │ │  ✅ 契約中   │ │  ⬜ 未契約   │               │
│  └──────────────┘ └──────────────┘ └──────────────┘               │
└────────────────────────────────────────────────────────────────────┘
         │                    │                    │
         ▼                    ▼                    ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  /simulator  │    │ /service-b   │    │ /service-c   │
│ シミュレーター │    │  サービスB   │    │  サービスC   │
│    機能      │    │    機能      │    │    機能      │
└──────────────┘    └──────────────┘    └──────────────┘
         │                    │                    │
         ▼                    ▼                    ▼
┌────────────────────────────────────────────────────────────────────┐
│                        Neon DB（データベース）                       │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐               │
│  │ simulations  │ │service_b_data│ │service_c_data│               │
│  │ テーブル     │ │ テーブル     │ │ テーブル     │               │
│  └──────────────┘ └──────────────┘ └──────────────┘               │
│                                                                    │
│  ┌──────────────┐ ┌──────────────┐                                │
│  │    users     │ │subscriptions │  ← 共通テーブル                 │
│  │  テーブル    │ │  テーブル    │                                │
│  └──────────────┘ └──────────────┘                                │
└────────────────────────────────────────────────────────────────────┘
```

### 設計のポイント

| 項目 | 方針 | 理由 |
|------|------|------|
| 認証 | **1つに統合**（Neon Auth） | ユーザーは1回登録で全サービス利用可能 |
| startpack | **1つ**で全サービス管理 | 管理が楽、コード共有可能 |
| DB | **1つ**（テーブルは分離） | 統一管理、ユーザーデータ共有 |
| 課金 | Stripeで**プランごと**に管理 | 複数サービスの契約に対応 |

---

## 3. ユーザーフロー

### 新規ユーザー（Aさん）の例

```
【新規ユーザー Aさん】

    ①                    ②                     ③
 サイト訪問    →    無料会員登録     →    ダッシュボード
ooya.tech          メール/パスワード         マイページ表示
                   （1回だけ）

                                                │
                         ┌──────────────────────┼──────────────────────┐
                         ▼                      ▼                      ▼
                        ④                     ⑤                      ⑥
                シミュレーター          サービスBを           サービスCは
                 を無料で試す            契約する              まだ契約しない
                         │                      │
                         ▼                      ▼
                        ⑦                     ⑧
                  「便利！契約     →    Stripe決済
                   しよう」             月額500円
                         │
                         ▼
                        ⑨
                  Stripe決済
                  月額1,000円
                         │
                         ▼
┌────────────────────────────────────────────────────────────────────┐
│                     【Aさんの状態】                                  │
│                                                                    │
│  ログイン: 1つ（メールアドレス）                                    │
│  契約中:                                                           │
│    ├── シミュレーター: 月額1,000円                                  │
│    └── サービスB: 月額500円                                        │
│  月額請求: 合計 1,500円（Stripe）                                   │
│  保存データ:                                                       │
│    ├── simulations テーブル → シミュレーション結果                  │
│    └── service_b_data テーブル → サービスBのデータ                  │
└────────────────────────────────────────────────────────────────────┘
```

### シミュレーション保存フロー

```
    Aさん              シミュレーター画面           Neon DB
      │                       │                      │
      │  ①物件情報入力        │                      │
      │ ────────────────────▶│                      │
      │                       │                      │
      │  ②シミュレーション実行│                      │
      │ ────────────────────▶│                      │
      │                       │                      │
      │  ③結果表示            │                      │
      │ ◀────────────────────│                      │
      │                       │                      │
      │  ④「保存」ボタン     │                      │
      │ ────────────────────▶│                      │
      │                       │                      │
      │                       │  ⑤データ保存        │
      │                       │ ───────────────────▶│
      │                       │                      │  simulations
      │                       │                      │  テーブルに保存
      │                       │                      │
      │  ⑥保存完了           │                      │
      │ ◀────────────────────│                      │
      ▼                       ▼                      ▼
```

---

## 4. データベース設計

### Prisma スキーマ

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// 共通テーブル
// ========================================

// 契約情報（複数サービス対応）
model Subscription {
  id                   String   @id @default(cuid())
  userId               String
  serviceName          String   // "simulator", "service_b", "service_c"
  stripeCustomerId     String
  stripeSubscriptionId String   @unique
  status               SubscriptionStatus
  currentPeriodEnd     DateTime?
  cancelAt             DateTime?
  cancelAtPeriodEnd    Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([userId, serviceName])  // 1ユーザー1サービス1契約
}

enum SubscriptionStatus {
  active
  trialing
  past_due
  canceled
  incomplete
  unpaid
}

// ========================================
// シミュレーター専用テーブル
// ========================================

model Simulation {
  id           String   @id @default(cuid())
  userId       String
  propertyName String
  data         Json     // シミュレーション結果全体
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ========================================
// サービスB専用テーブル（将来用）
// ========================================

// model ServiceBData {
//   id        String   @id @default(cuid())
//   userId    String
//   // サービスB固有のフィールド
//   createdAt DateTime @default(now())
// }
```

### テーブル構造

| テーブル | 用途 | 備考 |
|----------|------|------|
| `subscriptions` | 契約管理 | 共通、複数サービス対応 |
| `simulations` | シミュレーション結果 | シミュレーター専用 |
| `service_b_data` | サービスBのデータ | 将来追加 |
| `service_c_data` | サービスCのデータ | 将来追加 |

---

## 5. URL・ドメイン構成

### URL構造

```
ooya.tech/                    ← トップページ（ランディング）
ooya.tech/auth/signin         ← ログイン
ooya.tech/auth/signup         ← 新規登録
ooya.tech/dashboard           ← マイページ（契約管理）
ooya.tech/billing             ← 課金管理
│
├── ooya.tech/simulator       ← シミュレーター（月額1,000円）
│
├── ooya.tech/service-b       ← サービスB（月額500円）※将来
│
└── ooya.tech/service-c       ← サービスC（月額2,000円）※将来
```

### ドメイン構成

| URL | 用途 | 移行後 |
|-----|------|--------|
| ooya.tech | メインサービス | Next.js (Vercel) |
| ooya.media/media/ | WordPress | 変更なし |

---

## 6. 技術スタック

```
┌─────────────────────────────────────────────────────────────────┐
│                        ooya.tech                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│   │  Next.js 16 │    │   Vercel    │    │ Tailwind 4  │        │
│   │  (React 19) │    │  (ホスティング)│   │   CSS      │        │
│   └─────────────┘    └─────────────┘    └─────────────┘        │
│                                                                  │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│   │  Neon DB    │    │  Neon Auth  │    │   Prisma    │        │
│   │ (PostgreSQL)│    │   (認証)    │    │   (ORM)     │        │
│   └─────────────┘    └─────────────┘    └─────────────┘        │
│                                                                  │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│   │   Stripe    │    │   Resend    │    │  Chart.js   │        │
│   │   (決済)    │    │  (メール)   │    │ (グラフ)    │        │
│   └─────────────┘    └─────────────┘    └─────────────┘        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. フォルダ構造

### 移行後の構造（ooya-dx_2026）

```
ooya-dx_2026/
├── app/                          ← ページ（Next.js App Router）
│   ├── page.tsx                  ← トップ（LandingPage）
│   ├── layout.tsx                ← 共通レイアウト
│   ├── globals.css
│   │
│   ├── simulator/                ← シミュレーター
│   │   ├── page.tsx
│   │   └── SimulatorClient.tsx
│   │
│   ├── dashboard/                ← マイページ
│   │   └── page.tsx
│   │
│   ├── faq/                      ← FAQ
│   │   └── page.tsx
│   │
│   ├── guide/                    ← ユーザーガイド
│   │   └── page.tsx
│   │
│   ├── auth/                     ← 認証（startpack既存）
│   │   ├── signin/
│   │   ├── signup/
│   │   ├── forgot-password/
│   │   └── password-reset/
│   │
│   ├── legal/                    ← 法的ページ（startpack既存）
│   │   ├── privacy/
│   │   ├── terms/
│   │   └── tokushoho/
│   │
│   ├── billing/                  ← 課金管理（startpack既存）
│   │   └── page.tsx
│   │
│   └── api/                      ← APIルート（startpack既存）
│       ├── auth/
│       ├── stripe/
│       └── contact/
│
├── components/                   ← コンポーネント
│   ├── simulator/                ← シミュレーター用
│   │   ├── CashFlowChart.tsx
│   │   ├── MetricCard.tsx
│   │   └── ...
│   ├── landing/                  ← ランディング用
│   ├── shared/                   ← 共通
│   ├── header.tsx               ← startpack既存
│   └── footer.tsx               ← startpack既存
│
├── lib/                          ← ライブラリ・ロジック
│   ├── auth/                     ← 認証（startpack既存）
│   ├── utils/                    ← ユーティリティ（移植済み）
│   ├── constants/                ← 定数（移植済み）
│   ├── config/                   ← 設定（移植済み）
│   ├── prisma.ts                ← Prismaクライアント
│   └── stripe.ts                ← Stripeクライアント
│
├── hooks/                        ← カスタムフック（移植済み）
├── types/                        ← 型定義
│   └── simulation/              ← シミュレーター用（移植済み）
├── data/                         ← サンプルデータ（移植済み）
├── prisma/
│   └── schema.prisma            ← DBスキーマ
├── public/                       ← 静的ファイル
├── .env                          ← 環境変数
├── package.json
├── tsconfig.json
└── next.config.mjs
```

### 移植対応表

| 元（bolt_front/src） | 先（ooya-dx_2026） | 状態 |
|---------------------|-------------------|------|
| `pages/LandingPage.tsx` | `app/page.tsx` | ⬜ 未移植 |
| `pages/Simulator.tsx` | `app/simulator/SimulatorClient.tsx` | 🔄 移植中 |
| `pages/MyPage.tsx` | `app/dashboard/page.tsx` | ⬜ 未移植 |
| `pages/FAQ.tsx` | `app/faq/page.tsx` | ⬜ 未移植 |
| `pages/UserGuide.tsx` | `app/guide/page.tsx` | ⬜ 未移植 |
| `pages/Login.tsx` | startpack既存を使用 | ✅ |
| `pages/Signup.tsx` | startpack既存を使用 | ✅ |
| `pages/Privacy.tsx` | startpack既存を使用 | ✅ |
| `pages/Terms.tsx` | startpack既存を使用 | ✅ |
| `pages/Tokushoho.tsx` | startpack既存を使用 | ✅ |
| `components/*` | `components/simulator/*` | ✅ 移植済み |
| `utils/*` | `lib/utils/*` | ✅ 移植済み |
| `constants/*` | `lib/constants/*` | ✅ 移植済み |
| `config/*` | `lib/config/*` | ✅ 移植済み |
| `types/*` | `types/simulation/*` | ✅ 移植済み |
| `hooks/*` | `hooks/*` | ✅ 移植済み |
| `data/*` | `data/*` | ✅ 移植済み |

---

## 8. 移行ステップ

### Phase 1: 環境構築 ✅ 完了

| タスク | 状態 | 備考 |
|--------|------|------|
| 新フォルダ作成 | ✅ | `/Users/tetzlow/real-estate-app/ooya-dx_2026/` |
| startpackコピー | ✅ | Next.js 16 + React 19 ベース |
| Neon DB作成 | ✅ | `ep-sparkling-tooth-a1qgnjkc` |
| 環境変数設定 | ✅ | `.env` に DATABASE_URL, NEON_AUTH_URL 設定済み |
| npm install | ✅ | 依存関係インストール完了 |
| Prisma設定 | ✅ | `prisma db push` でスキーマ反映済み |
| 開発サーバー起動 | ✅ | `http://localhost:3003` で動作確認済み |
| Neon Auth | ✅ | 認証画面表示確認済み |

### Phase 2: ファイル移植 🔄 進行中

| タスク | 状態 | 備考 |
|--------|------|------|
| utils移植 | ✅ | `lib/utils/` |
| constants移植 | ✅ | `lib/constants/` |
| config移植 | ✅ | `lib/config/` |
| types移植 | ✅ | `types/simulation/` |
| hooks移植 | ✅ | `hooks/` |
| コンポーネント移植 | ✅ | `components/simulator/` |
| シミュレーター移植 | 🔄 | インポートパス修正中 |
| ランディングページ | ⬜ | 未着手 |
| マイページ | ⬜ | 未着手 |
| FAQ | ⬜ | 未着手 |
| ユーザーガイド | ⬜ | 未着手 |

### Phase 3: エラー修正 ⬜ 未着手

| タスク | 状態 |
|--------|------|
| インポートパス修正 | ⬜ |
| TypeScriptエラー解消 | ⬜ |
| 認証フック統合 | ⬜ |

### Phase 4: 動作検証 ⬜ 未着手

| タスク | 状態 |
|--------|------|
| シミュレーター動作確認 | ⬜ |
| 認証フロー確認 | ⬜ |
| データ保存確認 | ⬜ |

### Phase 5: デプロイ ⬜ 未着手

| タスク | 状態 |
|--------|------|
| Vercel設定 | ⬜ |
| 環境変数設定 | ⬜ |
| DNS切り替え | ⬜ |

---

## 9. 進捗状況

### 現在の状態（2025/01/06）

```
Phase 1: 環境構築     [██████████] 100% ✅
Phase 2: ファイル移植  [██████░░░░]  60% 🔄
Phase 3: エラー修正   [░░░░░░░░░░]   0% ⬜
Phase 4: 動作検証     [░░░░░░░░░░]   0% ⬜
Phase 5: デプロイ     [░░░░░░░░░░]   0% ⬜
```

### 次のアクション

1. **残りのページを移植**
   - LandingPage.tsx → app/page.tsx
   - MyPage.tsx → app/dashboard/page.tsx
   - FAQ.tsx → app/faq/page.tsx
   - UserGuide.tsx → app/guide/page.tsx

2. **エラー修正**
   - インポートパスを`@/`形式に統一
   - TypeScriptエラー解消
   - 認証フックをNeon Authに統合

3. **動作検証**
   - 各ページの表示確認
   - シミュレーション実行確認
   - データ保存確認

### 開発サーバー起動方法

```bash
cd /Users/tetzlow/real-estate-app/ooya-dx_2026
npm run dev
# → http://localhost:3003
```

---

## 10. 課金設計

### Stripe商品構成

| 商品名 | 価格 | price_id | 状態 |
|--------|------|----------|------|
| シミュレーター | 月額1,000円 | price_xxx | 設定予定 |
| サービスB | 月額500円 | price_yyy | 将来 |
| サービスC | 月額2,000円 | price_zzz | 将来 |

### 契約フロー

```
未契約ユーザー          契約ページ            Stripe           契約完了
     │                    │                   │                 │
     │   ①契約ボタン     │                   │                 │
     │ ───────────────▶  │                   │                 │
     │                    │  ②決済リクエスト │                 │
     │                    │ ────────────────▶│                 │
     │                    │                   │                 │
     │                    │  ③決済画面表示   │                 │
     │  ◀─────────────────────────────────────│                 │
     │                    │                   │                 │
     │   ④カード情報入力  │                   │                 │
     │ ──────────────────────────────────────▶│                 │
     │                    │                   │                 │
     │                    │  ⑤Webhook通知    │                 │
     │                    │ ◀────────────────│                 │
     │                    │                   │                 │
     │                    │  ⑥DBに契約保存   │                 │
     │                    │ ─────────────────────────────────▶ │
     │                    │                   │                 │
     │   ⑦契約完了画面    │                   │                 │
     │  ◀─────────────────────────────────────────────────────  │
     ▼                    ▼                   ▼                 ▼
```

---

## 補足: 注意事項

### react-joyride
- React 19 に非対応のため、一時的にダミーコンポーネント化
- チュートリアル機能は後日対応

### 認証移行
- useAuthContext → Neon Auth のセッション管理に移行必要
- useSupabaseData → Prisma + Neon に移行必要

### 環境変数
- `import.meta.env` (Vite) → `process.env` (Next.js) に変更済み

---

## 関連ドキュメント

- `docs_md/システム構造図_250106.md` - 詳細な図解

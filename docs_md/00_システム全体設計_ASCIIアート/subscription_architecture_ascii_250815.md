# 📊 Supabase/Stripe 月額課金システムアーキテクチャ（ASCII図版）

作成日: 2025-08-15  
最終更新: 2025-08-15

## 🏗️ システム全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Frontend (React/Vite)                          │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐  │
│  │ 料金プラン   │  │  解約モーダル │  │  再開ボタン  │  │ Dashboard│  │
│  │   ページ     │  │              │  │              │  │          │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └─────┬────┘  │
└─────────┼──────────────────┼─────────────────┼────────────────┼────────┘
          │                  │                 │                │
          ▼                  ▼                 ▼                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              Supabase                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        Edge Functions                            │  │
│  ├──────────────────────────────────────────────────────────────────┤  │
│  │ ┌────────────────┐ ┌────────────────┐ ┌────────────────┐       │  │
│  │ │create-checkout │ │cancel-         │ │resume-         │       │  │
│  │ │-session        │ │subscription    │ │subscription    │       │  │
│  │ └────────┬───────┘ └────────┬───────┘ └────────┬───────┘       │  │
│  │          │                  │                   │                │  │
│  │ ┌────────▼──────────────────▼───────────────────▼────────┐      │  │
│  │ │              handle-stripe-webhook                      │      │  │
│  │ └─────────────────────────┬───────────────────────────────┘      │  │
│  └───────────────────────────┼──────────────────────────────────────┘  │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                         Database                                 │  │
│  ├──────────────────────────────────────────────────────────────────┤  │
│  │  ┌──────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────┐ │  │
│  │  │  users   │  │subscriptions │  │usage_limits  │  │properties│ │  │
│  │  └──────────┘  └──────────────┘  └──────────────┘  └─────────┘ │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                               Stripe                                    │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  API     │  │  Checkout    │  │  Customer    │  │ Subscription │  │
│  │          │◄─┤  Session     │──►│              │──►│              │  │
│  └──────────┘  └──────────────┘  └──────────────┘  └──────────────┘  │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                         Webhook Events                           │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

## 💳 新規プラン購入フロー

```
┌──────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ User │     │ Frontend │     │ Supabase │     │  Stripe  │     │ Webhook  │
└──┬───┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
   │              │                 │                 │                 │
   │ 1.プラン選択 │                 │                 │                 │
   ├─────────────►│                 │                 │                 │
   │              │ 2.認証確認      │                 │                 │
   │              ├────────────────►│                 │                 │
   │              │                 │                 │                 │
   │              │ 3.create-checkout-session         │                 │
   │              ├────────────────►│                 │                 │
   │              │                 │ 4.セッション作成│                 │
   │              │                 ├────────────────►│                 │
   │              │                 │                 │                 │
   │              │ 5.リダイレクトURL│                 │                 │
   │              │◄────────────────┤                 │                 │
   │              │                 │                 │                 │
   │ 6.Stripe画面 │                 │                 │                 │
   │◄─────────────┤                 │                 │                 │
   │              │                 │                 │                 │
   │ 7.カード入力 │                 │                 │                 │
   ├──────────────┼─────────────────┼────────────────►│                 │
   │              │                 │                 │                 │
   │              │                 │                 │ 8.payment成功   │
   │              │                 │                 ├────────────────►│
   │              │                 │                 │                 │
   │              │                 │ 9.webhook受信  │                 │
   │              │                 │◄────────────────┼─────────────────┤
   │              │                 │                 │                 │
   │              │                 │ 10.DB更新      │                 │
   │              │                 ├─────┐          │                 │
   │              │                 │     │          │                 │
   │              │                 │◄────┘          │                 │
   │              │                 │                 │                 │
   │ 11.完了画面  │                 │                 │                 │
   │◄─────────────┼─────────────────┼─────────────────┤                 │
   │              │                 │                 │                 │
```

## 🔄 月次更新フロー

```
毎月1日 0:00 (JST)
────────────────────────────────────────────────────────────────────

┌──────────┐                    ┌──────────┐                ┌──────────┐
│  Stripe  │                    │ Supabase │                │   User   │
└────┬─────┘                    └────┬─────┘                └────┬─────┘
     │                                │                           │
     │ 1. invoice.payment_succeeded  │                           │
     ├───────────────────────────────►│                           │
     │                                │                           │
     │                                │ 2. subscriptions更新      │
     │                                ├─────┐                     │
     │                                │     │ current_period更新  │
     │                                │◄────┘                     │
     │                                │                           │
     │                                │ 3. usage_limits更新       │
     │                                ├─────┐                     │
     │                                │     │ monthly_count = 0  │
     │                                │◄────┘                     │
     │                                │                           │
     │                                │                           │
     │                                │ 4. ユーザーアクセス時     │
     │                                │◄──────────────────────────┤
     │                                │                           │
     │                                │ 5. check_and_reset_usage()│
     │                                ├─────┐                     │
     │                                │     │ 自動リセット確認   │
     │                                │◄────┘                     │
     │                                │                           │
     │                                │ 6. 新制限値を返す        │
     │                                ├──────────────────────────►│
     │                                │                           │
```

## ❌ 解約フロー

```
┌──────────────────────────────────────────────────────────────────────┐
│                            解約処理の流れ                            │
└──────────────────────────────────────────────────────────────────────┘

    ユーザー          Frontend        Edge Function       Stripe         DB
       │                 │                 │               │            │
       │ 1.解約ボタン    │                 │               │            │
       ├────────────────►│                 │               │            │
       │                 │                 │               │            │
       │ 2.確認モーダル  │                 │               │            │
       │◄────────────────┤                 │               │            │
       │                 │                 │               │            │
       │ 3.解約確認      │                 │               │            │
       ├────────────────►│                 │               │            │
       │                 │ 4.cancel-subscription           │            │
       │                 ├────────────────►│               │            │
       │                 │                 │ 5.期間終了設定│            │
       │                 │                 ├──────────────►│            │
       │                 │                 │               │            │
       │                 │                 │ 6.更新完了    │            │
       │                 │                 │◄──────────────┤            │
       │                 │                 │               │            │
       │                 │                 │ 7.DB更新      │            │
       │                 │                 ├───────────────┼───────────►│
       │                 │                 │               │  status:   │
       │                 │                 │               │ canceling  │
       │                 │ 8.解約予定設定  │               │            │
       │                 │◄────────────────┤               │            │
       │                 │                 │               │            │
       │ 9.解約予定表示  │                 │               │            │
       │◄────────────────┤                 │               │            │
       │                 │                 │               │            │
       
       ▼ 期間終了日になると...
       
       │                 │                 │               │            │
       │                 │                 │ 10.解約完了通知│            │
       │                 │                 │◄──────────────┤            │
       │                 │                 │ (subscription.deleted)     │
       │                 │                 │               │            │
       │                 │                 │ 11.status更新  │            │
       │                 │                 ├───────────────┼───────────►│
       │                 │                 │               │  status:   │
       │                 │                 │               │  cancelled │
```

## 📊 データベース構造

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         データベーステーブル関係図                       │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐          ┌──────────────────────┐
│     users        │          │   subscriptions      │
├──────────────────┤          ├──────────────────────┤
│ id (PK)          │──────────│ id (PK)              │
│ email            │    1:1   │ user_id (FK)         │
│ created_at       │          │ stripe_customer_id   │
│ updated_at       │          │ stripe_subscription_id│
└──────────────────┘          │ status               │
         │                    │ price_id             │
         │                    │ current_period_end   │
         │                    │ current_period_start │
         │                    │ cancel_at_period_end │
         │                    │ canceled_at          │
         │                    └──────────────────────┘
         │
         │ 1:1                        1:N
         ▼                            ▼
┌──────────────────┐          ┌──────────────────┐
│   usage_limits   │          │    properties    │
├──────────────────┤          ├──────────────────┤
│ id (PK)          │          │ id (PK)          │
│ user_id (FK)     │          │ user_id (FK)     │
│ plan_type        │          │ name             │
│ max_properties   │          │ data (JSON)      │
│ monthly_count    │          │ created_at       │
│ reset_date       │          │ updated_at       │
└──────────────────┘          └──────────────────┘
```

## 🎯 プラン別制限管理表

```
┌────────────────────────────────────────────────────────────────────────┐
│                           プラン比較表                                 │
├────────────┬──────────┬──────────────┬────────────────┬──────────────┤
│  プラン    │  月額    │  物件登録数  │ シミュレーション│  リセット    │
├────────────┼──────────┼──────────────┼────────────────┼──────────────┤
│ 無料プラン │    ¥0    │    3件まで   │    制限なし    │   毎月1日    │
├────────────┼──────────┼──────────────┼────────────────┼──────────────┤
│ ベーシック │   ¥500   │   10件まで   │    制限なし    │   毎月1日    │
├────────────┼──────────┼──────────────┼────────────────┼──────────────┤
│ プレミアム │  ¥1,500  │    無制限    │    制限なし    │      -       │
└────────────┴──────────┴──────────────┴────────────────┴──────────────┘

物件登録時の制限チェックフロー：

                    ┌─────────────┐
                    │ 物件登録開始 │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │ プラン確認   │
                    └──────┬──────┘
                           │
            ┌──────────────┼──────────────┐
            ▼              ▼              ▼
     ┌──────────┐   ┌──────────┐   ┌──────────┐
     │   無料   │   │ベーシック│   │プレミアム│
     │  (3件)   │   │  (10件)  │   │  (無制限)│
     └─────┬────┘   └────┬─────┘   └────┬─────┘
           └──────────────┼──────────────┘
                          │
                   ┌──────▼──────┐
                   │ 登録数確認   │
                   └──────┬──────┘
                          │
                ┌─────────┴─────────┐
                ▼                   ▼
         ┌──────────┐        ┌──────────┐
         │ 制限内   │        │ 制限超過 │
         └────┬─────┘        └────┬─────┘
              │                    │
         ┌────▼─────┐        ┌────▼──────┐
         │ 登録許可 │        │アップグレード│
         └──────────┘        │    促進     │
                             └─────────────┘
```

## 🔐 セキュリティ構成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          セキュリティレイヤー                           │
└─────────────────────────────────────────────────────────────────────────┘

    Frontend                 Edge Functions              Database
        │                          │                        │
   ┌────▼────┐              ┌─────▼─────┐           ┌─────▼─────┐
   │JWT Token│              │CORS設定   │           │    RLS    │
   └────┬────┘              └─────┬─────┘           │ポリシー   │
        │                          │                 └─────┬─────┘
        │                   ┌──────▼──────┐                │
        └──────────────────►│ 認証チェック │◄───────────────┘
                           └──────┬──────┘
                                  │
                           ┌──────▼──────┐
                           │ 入力検証    │
                           └──────┬──────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ▼                           ▼
            ┌──────────────┐           ┌──────────────┐
            │Stripe API Key│           │Webhook Secret│
            └──────────────┘           └──────────────┘
            
環境変数管理：
┌────────────────────────────────────────────────────────────────┐
│ VITE_SUPABASE_URL      : Supabase プロジェクトURL             │
│ VITE_SUPABASE_ANON_KEY : Supabase 公開用匿名キー             │
│ STRIPE_SECRET_KEY      : Stripe シークレットキー              │
│ STRIPE_WEBHOOK_SECRET  : Webhook エンドポイントシークレット   │
└────────────────────────────────────────────────────────────────┘
```

## 🚨 エラーハンドリングフロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         エラー処理フロー                                │
└─────────────────────────────────────────────────────────────────────────┘

Frontend エラー:
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│ネットワーク  │────►│ リトライ処理  │────►│フォールバック│
│   エラー     │     │  (3回まで)   │     │   表示       │
└──────────────┘     └──────────────┘     └──────────────┘

┌──────────────┐                           ┌──────────────┐
│   認証       │─────────────────────────►│ ログイン画面 │
│  エラー      │                           │  リダイレクト│
└──────────────┘                           └──────────────┘

┌──────────────┐                           ┌──────────────┐
│   検証       │─────────────────────────►│エラーメッセージ│
│  エラー      │                           │     表示      │
└──────────────┘                           └──────────────┘

Backend エラー:
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Stripe API  │────►│ エラーログ   │────►│  管理者通知  │
│   エラー     │     │    記録      │     │   (重大時)   │
└──────────────┘     └──────────────┘     └──────────────┘
                            │
                            ▼
                     ┌──────────────┐
                     │ユーザー通知  │
                     │ (一般メッセージ)│
                     └──────────────┘
```

## 📝 実装チェックリスト

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        実装必須項目チェックリスト                       │
├─────────────────────────────────────────────────────────────────────────┤
│ □ Webhook処理の冪等性実装                                              │
│   └─ 同じイベントIDの重複処理防止                                      │
│                                                                         │
│ □ 月次リセット処理                                                     │
│   ├─ check_and_reset_usage関数の実装                                  │
│   └─ JSTタイムゾーン考慮                                              │
│                                                                         │
│ □ プラン変更時の日割り計算                                            │
│   └─ Stripeの自動日割り設定確認                                       │
│                                                                         │
│ □ 解約時の挙動                                                        │
│   ├─ 期間終了まで利用可能の実装                                       │
│   └─ 解約取り消し可能期間の設定                                       │
│                                                                         │
│ □ エラー時のフォールバック                                            │
│   ├─ Stripeエラー時の既存プラン維持                                   │
│   └─ ユーザーへの適切なフィードバック                                 │
│                                                                         │
│ □ セキュリティ対策                                                    │
│   ├─ RLSポリシーの適切な設定                                         │
│   ├─ Webhook署名の検証                                               │
│   └─ 環境変数の安全な管理                                            │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔧 環境別設定

```
┌────────────┬────────────────┬──────────────────┬────────────────────┐
│    環境    │     Stripe     │    Supabase      │        URL         │
├────────────┼────────────────┼──────────────────┼────────────────────┤
│   開発     │  テストモード  │  開発プロジェクト │  localhost:5173    │
├────────────┼────────────────┼──────────────────┼────────────────────┤
│ステージング│  テストモード  │  開発プロジェクト │  dev.ooya.tech     │
├────────────┼────────────────┼──────────────────┼────────────────────┤
│   本番     │   本番モード   │  本番プロジェクト │  ooya.tech         │
└────────────┴────────────────┴──────────────────┴────────────────────┘
```

---

## 🏠 物件シミュレーションシステムアーキテクチャ

### 物件シミュレーション実行フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     物件シミュレーション実行プロセス                     │
└─────────────────────────────────────────────────────────────────────────┘

    ユーザー        Frontend          APIサーバー        Supabase         
       │               │                  │                │              
       │ 1.物件情報入力│                  │                │              
       ├──────────────►│                  │                │              
       │               │                  │                │              
       │               │ 2.入力検証       │                │              
       │               ├─────┐            │                │              
       │               │     │            │                │              
       │               │◄────┘            │                │              
       │               │                  │                │              
       │ 3.計算実行   │                  │                │              
       ├──────────────►│                  │                │              
       │               │ 4.APIリクエスト  │                │              
       │               ├─────────────────►│                │              
       │               │                  │                │              
       │               │                  │ 5.計算処理    │              
       │               │                  ├─────┐          │              
       │               │                  │     │          │              
       │               │                  │ ・表面利回り  │              
       │               │                  │ ・実質利回り  │              
       │               │                  │ ・CF計算     │              
       │               │                  │ ・ROI算出    │              
       │               │                  │◄────┘          │              
       │               │                  │                │              
       │               │ 6.計算結果       │                │              
       │               │◄─────────────────┤                │              
       │               │                  │                │              
       │ 7.結果表示    │                  │                │              
       │◄──────────────┤                  │                │              
       │               │                  │                │              
       │ 8.保存ボタン  │                  │                │              
       ├──────────────►│                  │                │              
       │               │ 9.保存リクエスト │                │              
       │               ├──────────────────┼───────────────►│              
       │               │                  │                │              
       │               │                  │        10.DBに保存           
       │               │                  │           ┌────▼────┐        
       │               │                  │           │properties│        
       │               │                  │           └─────────┘        
       │               │                  │           ┌────▼────┐        
       │               │                  │           │simulations       
       │               │                  │           └─────────┘        
       │               │                  │                │              
       │               │ 11.保存完了      │                │              
       │               │◄─────────────────┼────────────────┤              
       │               │                  │                │              
       │ 12.完了通知   │                  │                │              
       │◄──────────────┤                  │                │              
       │               │                  │                │              
```

### データベース構造（シミュレーション関連）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    シミュレーションデータ構造                           │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐          ┌──────────────────────┐
│     users        │          │    properties        │
├──────────────────┤          ├──────────────────────┤
│ id (PK)          │──────────│ id (PK)              │
│ email            │    1:N   │ user_id (FK)         │
│ created_at       │          │ name                 │
└──────────────────┘          │ price                │
                              │ address              │
                              │ building_age         │
                              │ structure            │
                              │ land_area            │
                              │ building_area        │
                              │ created_at           │
                              │ updated_at           │
                              └──────────┬───────────┘
                                        │ 1:N
                                        ▼
                              ┌──────────────────────┐
                              │   simulations        │
                              ├──────────────────────┤
                              │ id (PK)              │
                              │ property_id (FK)     │
                              │ purchase_price       │
                              │ annual_income        │
                              │ expenses             │
                              │ loan_amount          │
                              │ interest_rate        │
                              │ loan_term            │
                              │ surface_yield        │
                              │ real_yield           │
                              │ cash_flow            │
                              │ roi                  │
                              │ simulation_date      │
                              │ created_at           │
                              └──────────────────────┘
```

### マイページ表示フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        マイページ（Dashboard）表示                      │
└─────────────────────────────────────────────────────────────────────────┘

  ユーザー          Frontend            Supabase           表示内容
     │                 │                   │                   
     │ 1.ログイン      │                   │                   
     ├────────────────►│                   │                   
     │                 │ 2.認証確認        │                   
     │                 ├──────────────────►│                   
     │                 │                   │                   
     │                 │ 3.ユーザーID返却  │                   
     │                 │◄──────────────────┤                   
     │                 │                   │                   
     │ 4.マイページ    │                   │                   
     ├────────────────►│                   │                   
     │                 │                   │                   
     │                 │ 5.データ取得要求  │                   
     │                 ├──────────────────►│                   
     │                 │                   │                   
     │                 │            ┌──────┴──────┐            
     │                 │            │   RLSチェック│            
     │                 │            │  (user_id)  │            
     │                 │            └──────┬──────┘            
     │                 │                   │                   
     │                 │      6.物件一覧取得│                   
     │                 │◄──────────────────┤                   
     │                 │                   │                   
     │                 ├─────┐             │                   
     │                 │     │ 7.表示準備  │                   
     │                 │◄────┘             │                   
     │                 │                   │                   
     │ 8.物件一覧表示  │                   │     ┌─────────────────┐
     │◄────────────────┤                   │     │ 物件カード表示  │
     │                 │                   │     ├─────────────────┤
     │                 │                   │     │ ・物件名        │
     │                 │                   │     │ ・住所          │
     │                 │                   │     │ ・価格          │
     │                 │                   │     │ ・利回り        │
     │                 │                   │     │ [詳細][編集][削除]
     │                 │                   │     └─────────────────┘
```

### 物件詳細表示・編集・削除フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         物件操作フロー                                   │
└─────────────────────────────────────────────────────────────────────────┘

【詳細表示】
  ユーザー     Frontend      Supabase
     │            │             │
     │ 詳細ボタン │             │
     ├───────────►│             │
     │            │ property取得│
     │            ├────────────►│
     │            │             │
     │            │ simulation  │
     │            │    取得     │
     │            ├────────────►│
     │            │             │
     │  詳細画面  │◄────────────┤
     │◄───────────┤             │
                  │             │
     ┌──────────────────────────┐
     │    詳細表示内容          │
     ├──────────────────────────┤
     │ ■基本情報               │
     │  物件名、住所、価格      │
     │ ■建物情報               │
     │  築年数、構造、面積      │
     │ ■シミュレーション結果   │
     │  表面利回り: XX%        │
     │  実質利回り: XX%        │
     │  月間CF: ¥XXX,XXX      │
     │  ROI: XX%              │
     └──────────────────────────┘

【編集フロー】
  ユーザー     Frontend      Supabase
     │            │             │
     │ 編集ボタン │             │
     ├───────────►│             │
     │            │             │
     │ 編集画面   │             │
     │◄───────────┤             │
     │            │             │
     │ 内容変更   │             │
     ├───────────►│             │
     │            │             │
     │ 保存ボタン │             │
     ├───────────►│             │
     │            │ 更新リクエスト
     │            ├────────────►│
     │            │             │
     │            │        ┌────▼────┐
     │            │        │  UPDATE  │
     │            │        │properties│
     │            │        └─────────┘
     │            │             │
     │            │ 更新完了    │
     │            │◄────────────┤
     │ 完了通知   │             │
     │◄───────────┤             │

【削除フロー】
  ユーザー     Frontend      Supabase
     │            │             │
     │ 削除ボタン │             │
     ├───────────►│             │
     │            │             │
     │ 確認ダイアログ          │
     │◄───────────┤             │
     │ ┌─────────────────┐     │
     │ │ 本当に削除？    │     │
     │ │ [はい] [いいえ] │     │
     │ └─────────────────┘     │
     │            │             │
     │ はい選択   │             │
     ├───────────►│             │
     │            │ 削除リクエスト
     │            ├────────────►│
     │            │             │
     │            │        ┌────▼────┐
     │            │        │  DELETE  │
     │            │        │simulations
     │            │        └────┬────┘
     │            │             │
     │            │        ┌────▼────┐
     │            │        │  DELETE  │
     │            │        │properties│
     │            │        └─────────┘
     │            │             │
     │            │ 削除完了    │
     │            │◄────────────┤
     │ リスト更新 │             │
     │◄───────────┤             │
```

### シミュレーション再実行フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      シミュレーション再実行                             │
└─────────────────────────────────────────────────────────────────────────┘

  ユーザー        Frontend         APIサーバー        Supabase
     │               │                 │                │
     │ 1.物件詳細開く│                 │                │
     ├──────────────►│                 │                │
     │               │                 │                │
     │               │ 2.既存データ取得 │                │
     │               ├─────────────────┼───────────────►│
     │               │                 │                │
     │               │                 │         ┌──────▼──────┐
     │               │                 │         │ properties  │
     │               │                 │         │ simulations │
     │               │                 │         └──────┬──────┘
     │               │                 │                │
     │ 3.パラメータ  │◄────────────────┼────────────────┤
     │   変更画面    │                 │                │
     │◄──────────────┤                 │                │
     │               │                 │                │
     │ 4.値を変更    │                 │                │
     ├──────────────►│                 │                │
     │ (金利,期間等) │                 │                │
     │               │                 │                │
     │ 5.再計算ボタン│                 │                │
     ├──────────────►│                 │                │
     │               │ 6.再計算リクエスト               │
     │               ├────────────────►│                │
     │               │                 │                │
     │               │                 │ 7.新規計算     │
     │               │                 ├─────┐          │
     │               │                 │     │          │
     │               │                 │◄────┘          │
     │               │                 │                │
     │               │ 8.新結果       │                │
     │               │◄────────────────┤                │
     │               │                 │                │
     │ 9.比較表示    │                 │                │
     │◄──────────────┤                 │                │
     │               │                 │                │
     │  ┌────────────────────────┐    │                │
     │  │   シミュレーション比較  │    │                │
     │  ├────────────────────────┤    │                │
     │  │        前回    今回     │    │                │
     │  │ 利回り  8%     9.5%    │    │                │
     │  │ CF    +5万    +8万     │    │                │
     │  │ ROI    12%     15%     │    │                │
     │  └────────────────────────┘    │                │
     │               │                 │                │
     │ 10.保存する？ │                 │                │
     ├──────────────►│                 │                │
     │               │ 11.新規保存     │                │
     │               ├─────────────────┼───────────────►│
     │               │                 │         ┌──────▼──────┐
     │               │                 │         │  INSERT     │
     │               │                 │         │ simulations │
     │               │                 │         └─────────────┘
```

### キャッシュフロー詳細計算フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    キャッシュフロー計算ロジック                         │
└─────────────────────────────────────────────────────────────────────────┘

入力パラメータ                    計算プロセス                     出力結果
─────────────                    ─────────────                   ─────────
                                       │
┌──────────────┐                     ▼
│ 物件価格      │──────────►┌─────────────────────┐
│ ¥10,000,000   │           │   年間家賃収入計算   │
└──────────────┘           │  賃料 × 12ヶ月      │
                            └──────────┬──────────┘
┌──────────────┐                     │
│ 月額賃料      │──────────►          ▼
│ ¥100,000      │           ┌─────────────────────┐      ┌──────────────┐
└──────────────┘           │    経費計算         │      │ 表面利回り   │
                            │ ・管理費            │─────►│    12.0%     │
┌──────────────┐           │ ・修繕積立金        │      └──────────────┘
│ 管理費等      │──────────►│ ・固定資産税        │
│ ¥20,000/月    │           │ ・その他経費        │
└──────────────┘           └──────────┬──────────┘
                                       │
┌──────────────┐                     ▼
│ ローン条件    │           ┌─────────────────────┐      ┌──────────────┐
│ ・借入額      │──────────►│   ローン返済計算    │      │ 実質利回り   │
│ ・金利        │           │  元利均等返済       │─────►│    8.5%      │
│ ・期間        │           └──────────┬──────────┘      └──────────────┘
└──────────────┘                     │
                                       ▼
                            ┌─────────────────────┐      ┌──────────────┐
                            │  月間CF計算         │      │ 月間CF       │
                            │  収入 - 経費 - 返済  │─────►│  ¥15,000     │
                            └─────────────────────┘      └──────────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐      ┌──────────────┐
                            │    ROI計算          │      │ ROI          │
                            │  年間CF ÷ 自己資金  │─────►│    18%       │
                            └─────────────────────┘      └──────────────┘
```

### エラーハンドリング（シミュレーション系）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    シミュレーションエラー処理                           │
└─────────────────────────────────────────────────────────────────────────┘

【入力エラー】
  ユーザー入力 ──► 検証
                    │
                    ├─ 数値以外 ──► "数値を入力してください"
                    ├─ 負の値 ────► "正の値を入力してください"
                    ├─ 範囲外 ────► "1～100の間で入力してください"
                    └─ 必須項目 ──► "この項目は必須です"

【計算エラー】
  API呼び出し ──► エラー
                   │
                   ├─ タイムアウト ──► リトライ(3回) ──► "しばらく待ってから再試行"
                   ├─ 500エラー ────► "サーバーエラー。管理者に連絡"
                   └─ 計算不能 ─────► "入力値を確認してください"

【保存エラー】
  DB保存 ──► エラー
             │
             ├─ 容量超過 ──► "プランの上限に達しました"
             ├─ 認証切れ ──► ログイン画面へ
             └─ 通信エラー ──► リトライ ──► "保存に失敗しました"

【削除エラー】
  削除処理 ──► エラー
               │
               ├─ 権限なし ──► "この物件は削除できません"
               ├─ 依存関係 ──► "関連データがあるため削除できません"
               └─ 通信エラー ──► "削除に失敗しました。再試行してください"
```

### データフロー全体像

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        データフロー全体像                                │
└─────────────────────────────────────────────────────────────────────────┘

     入力              処理              保存              表示
      │                │                 │                 │
  ┌───▼───┐      ┌────▼────┐      ┌────▼────┐      ┌────▼────┐
  │ユーザー│      │Frontend │      │Supabase │      │Dashboard│
  │  入力  │─────►│  検証   │─────►│   DB    │─────►│  一覧   │
  └───┬───┘      └────┬────┘      └────┬────┘      └────┬────┘
      │                │                 │                 │
      │           ┌────▼────┐           │            ┌────▼────┐
      │           │   API   │           │            │  詳細   │
      └──────────►│  計算   │──────────►│            │  画面   │
                  └─────────┘           │            └─────────┘
                                        │
                                   ┌────▼────┐
                                   │  RLS    │
                                   │ セキュリティ
                                   └─────────┘
```

---

作成者: Claude Code  
作成日: 2025-08-15  
バージョン: ASCII図版 v1.1（シミュレーション機能追加）
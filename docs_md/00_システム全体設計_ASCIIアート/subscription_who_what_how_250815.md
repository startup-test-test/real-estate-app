# 📚 月額課金システム - 誰が何をどうするか詳細説明

作成日: 2025-08-15  
最終更新: 2025-08-15

## 🎯 概要
このシステムは「不動産投資シミュレーター」の有料プラン機能です。ユーザーが月額料金を支払うことで、より多くの物件を登録できるようになります。

---

## 👥 登場人物（誰が）

### 1. **ユーザー（お客様）**
- 不動産投資に興味がある個人投資家
- 物件の収益シミュレーションをしたい人
- 無料プラン利用者 or 有料プラン利用者

### 2. **システム管理者**
- このアプリケーションの運営者
- 料金プランの設定者
- トラブル対応者

### 3. **システム（自動処理）**
- Frontend（React製のWebアプリ）
- Supabase（データベース＋認証）
- Stripe（決済サービス）
- Edge Functions（サーバーレス関数）

---

## 📋 シナリオ別「誰が何をどうする」

## 1️⃣ 新規会員登録シナリオ

### 【ユーザーがすること】
1. **メールアドレスとパスワードを入力する**
   - トップページの「新規登録」ボタンをクリック
   - メールアドレスとパスワード（8文字以上）を入力
   - 「登録」ボタンをクリック

### 【システムが自動ですること】
1. **アカウントを作成する**
   - Supabaseがユーザー情報を保存
   - 確認メールを送信
   - 無料プランとして初期設定（物件3件まで）

### 【結果】
- ユーザーは無料プランで物件を3件まで登録可能になる

---

## 2️⃣ 有料プラン申し込みシナリオ

### 【きっかけ】
ユーザーが「もっと物件を登録したい」と思ったとき

### 【ユーザーがすること】
1. **料金プランページを開く**
   - ダッシュボードの「プランをアップグレード」をクリック
   
2. **プランを選ぶ**
   - ベーシック（月500円・10件まで）
   - プレミアム（月1,500円・無制限）
   - 希望プランの「申し込む」ボタンをクリック

3. **クレジットカード情報を入力する**
   - Stripeの決済画面に移動
   - カード番号、有効期限、CVVを入力
   - 「支払う」ボタンをクリック

### 【システムが自動ですること】
1. **決済処理を実行する**
   ```
   Edge Function (create-checkout-session)が：
   - Stripeに決済セッションを作成依頼
   - 決済画面のURLを生成
   - ユーザーをStripeページへ誘導
   ```

2. **決済完了を確認する**
   ```
   Stripe Webhookが：
   - 決済成功通知を受信
   - Edge Function (handle-stripe-webhook)を起動
   ```

3. **プランを有効化する**
   ```
   Edge Functionが：
   - データベースのsubscriptionsテーブルを更新
   - usage_limitsテーブルの制限値を変更
   - ステータスを「active」に設定
   ```

### 【結果】
- ユーザーは即座に選んだプランの制限数まで物件登録可能
- 月額料金が自動引き落とし設定される

---

## 3️⃣ 物件登録シナリオ

### 【ユーザーがすること】
1. **新規物件ボタンをクリック**
2. **物件情報を入力**
   - 物件名、価格、住所など
3. **保存ボタンをクリック**

### 【システムが自動ですること】
1. **現在の登録数をチェック**
   ```
   システムが確認：
   - 現在のプラン（無料/ベーシック/プレミアム）
   - 今月の登録済み件数
   - 登録可能な残り件数
   ```

2. **制限チェック**
   ```
   もし制限超過なら：
   - エラーメッセージ表示
   - アップグレード案内を表示
   
   制限内なら：
   - 物件データを保存
   - monthly_countを+1
   ```

### 【結果】
- 制限内：物件が保存される
- 制限超過：アップグレードを促される

---

## 4️⃣ 月次自動更新シナリオ（毎月1日）

### 【システムが自動ですること】

1. **Stripeが月額料金を請求**
   ```
   毎月同じ日に：
   - 登録されたカードに請求
   - 成功/失敗を判定
   ```

2. **請求成功の場合**
   ```
   Webhookが通知：
   - invoice.payment_succeeded イベント
   - Edge Functionが受信
   ```

3. **データベース更新**
   ```
   自動処理：
   - 課金期間を1ヶ月延長
   - 無料・ベーシックプランの登録数をリセット
   - monthly_count = 0 に戻す
   ```

### 【ユーザーは何もしなくてOK】
- 自動的にプランが継続
- 物件登録数がリセットされる

---

## 5️⃣ 解約シナリオ

### 【ユーザーがすること】
1. **設定ページを開く**
2. **「プランを解約」ボタンをクリック**
3. **解約理由を選択**（任意）
   - 料金が高い
   - 使わなくなった
   - その他
4. **「解約を確定」ボタンをクリック**

### 【システムが自動ですること】
1. **解約予約を設定**
   ```
   Edge Function (cancel-subscription)が：
   - Stripeに解約予約を送信
   - 期間終了日まで利用可能に設定
   ```

2. **ステータス更新**
   ```
   データベース更新：
   - status = 'canceling'（解約予定）
   - cancel_at_period_end = true
   - 解約日時を記録
   ```

3. **期間終了日になったら**
   ```
   自動処理：
   - status = 'canceled'（解約完了）
   - 無料プランに戻す
   - max_properties = 3 に変更
   ```

### 【結果】
- 期間終了まで有料プラン継続
- 期間終了後、自動的に無料プランへ

---

## 6️⃣ 解約取り消しシナリオ

### 【前提】
解約予定だが、まだ期間が残っている状態

### 【ユーザーがすること】
1. **設定ページで「解約を取り消す」ボタンをクリック**

### 【システムが自動ですること】
1. **解約予約をキャンセル**
   ```
   Edge Function (resume-subscription)が：
   - Stripeの解約予約を取り消し
   - 通常の継続課金に戻す
   ```

2. **ステータスを戻す**
   ```
   データベース更新：
   - status = 'active'（有効）
   - cancel_at_period_end = false
   ```

### 【結果】
- プランが継続される
- 次回も自動更新される

---

## 7️⃣ カード決済失敗シナリオ

### 【発生タイミング】
月次更新時にカードの有効期限切れや残高不足

### 【Stripeが自動ですること】
1. **再試行を実施**
   - 3日後に再度請求
   - 7日後にもう一度請求
   - メールで通知

### 【ユーザーがすること】
1. **メールを確認**
2. **カード情報を更新**
   - Stripeの管理画面へアクセス
   - 新しいカード情報を登録

### 【システムが自動ですること】
1. **支払い成功したら**
   - プラン継続
   - 通常通り利用可能

2. **最終的に失敗したら**
   - プラン解約処理
   - 無料プランへ移行

---

## 8️⃣ プラン変更シナリオ

### 【例】ベーシック→プレミアムへ変更

### 【ユーザーがすること】
1. **料金プランページで上位プランを選択**
2. **「プラン変更」ボタンをクリック**

### 【システムが自動ですること】
1. **Stripeが日割り計算**
   ```
   自動計算：
   - 残り日数分のベーシック料金を返金
   - プレミアム料金を日割りで請求
   - 差額を計算して請求/返金
   ```

2. **即座にプラン切り替え**
   ```
   データベース更新：
   - 新しいprice_idを設定
   - max_propertiesを変更
   ```

### 【結果】
- すぐに新プランの制限値で利用可能
- 料金は自動的に調整

---

## ⚠️ エラー発生時の動作

### 【ネットワークエラーの場合】
```
ユーザーの操作 → エラー発生
↓
システム：3回まで自動リトライ
↓
成功：正常処理 / 失敗：エラーメッセージ表示
```

### 【認証エラーの場合】
```
ユーザーの操作 → 認証切れ
↓
システム：ログイン画面へ誘導
↓
ユーザー：再ログイン → 元の操作を再実行
```

### 【決済エラーの場合】
```
カード決済 → 失敗
↓
システム：エラー理由を表示
（残高不足、有効期限切れ、など）
↓
ユーザー：カード情報を修正 → 再試行
```

---

## 📊 料金とタイミングまとめ

| イベント | タイミング | 料金発生 | ユーザーの操作 |
|---------|-----------|---------|--------------|
| **新規登録** | 即時 | なし | メール/パスワード入力 |
| **プラン申込** | 即時 | 初回請求 | カード情報入力 |
| **月次更新** | 毎月同日 | 月額料金 | なし（自動） |
| **プラン変更** | 即時 | 差額調整 | プラン選択 |
| **解約** | 期間終了時 | なし | 解約ボタン |
| **解約取消** | 即時 | 継続 | 取消ボタン |

---

## 🔑 重要なポイント

### ユーザーにとって
1. **料金は前払い** - 先に1ヶ月分支払い
2. **解約しても期間終了まで使える** - 損しない
3. **プラン変更は即反映** - すぐに使える
4. **自動更新** - 毎月手続き不要

### システムにとって
1. **すべて自動処理** - 人の手を介さない
2. **エラー時は自動リトライ** - 可能な限り成功させる
3. **ログを記録** - トラブル時の調査用
4. **セキュリティ重視** - カード情報は保存しない

---

作成者: Claude Code  
バージョン: 1.0
# 📊 Supabase データベース全体設計仕様書（ASCII版）

作成日: 2025-08-15  
最終更新: 2025-08-15

## 🏗️ システム全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Supabase プラットフォーム                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │
│  │   認証 (Auth)    │  │ Database (PG)   │  │ Edge Functions  │      │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤      │
│  │ ・メール認証     │  │ ・PostgreSQL    │  │ ・TypeScript    │      │
│  │ ・OAuth         │  │ ・リアルタイム   │  │ ・Deno Runtime  │      │
│  │ ・JWT トークン  │  │ ・RLS          │  │ ・Webhook処理   │      │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘      │
│           │                     │                     │                │
│           └─────────────────────┼─────────────────────┘                │
│                                 ▼                                      │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │                     Row Level Security (RLS)                   │   │
│  │  ユーザーは自分のデータのみアクセス可能（auth.uid()で制御）      │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🗄️ データベーステーブル全体構成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         テーブル関係図（ER図）                          │
└─────────────────────────────────────────────────────────────────────────┘

                            ┌──────────────┐
                            │  auth.users  │
                            │  (Supabase)  │
                            └──────┬───────┘
                                   │ 1:1
                                   ▼
                            ┌──────────────┐
                            │  public.users│
                            │ （プロフィール）│
                            └──────┬───────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        │                          │                          │
        │ 1:N                      │ 1:1                      │ 1:N
        ▼                          ▼                          ▼
┌──────────────┐          ┌──────────────┐          ┌──────────────┐
│  properties  │          │subscriptions │          │ user_usage   │
│   （物件）    │          │（サブスク）   │          │（利用状況）   │
└──────┬───────┘          └──────────────┘          └──────────────┘
       │ 1:N                                                │
       ▼                                                    │ 1:N
┌──────────────┐                                           ▼
│ simulations  │                                    ┌──────────────┐
│（シミュレーション）│                                    │usage_history │
└──────────────┘                                    │ （利用履歴）  │
                                                    └──────────────┘
```

## 📑 テーブル詳細仕様

### 1. users テーブル（ユーザープロフィール）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            users テーブル                                │
├─────────────────────────────────────────────────────────────────────────┤
│ カラム名      │ データ型     │ 制約                │ 説明              │
├──────────────┼─────────────┼───────────────────┼──────────────────┤
│ id           │ UUID        │ PK, FK(auth.users)│ ユーザーID        │
│ email        │ TEXT        │ UNIQUE, NOT NULL  │ メールアドレス     │
│ full_name    │ TEXT        │                   │ フルネーム        │
│ avatar_url   │ TEXT        │                   │ アバター画像URL   │
│ created_at   │ TIMESTAMPTZ │ NOT NULL          │ 作成日時          │
│ updated_at   │ TIMESTAMPTZ │ NOT NULL          │ 更新日時          │
└─────────────────────────────────────────────────────────────────────────┘

用途: ユーザーの基本情報を保存
特徴: auth.usersと1:1で紐付き、プロフィール情報を拡張
```

### 2. properties テーブル（物件情報）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          properties テーブル                             │
├─────────────────────────────────────────────────────────────────────────┤
│ カラム名        │ データ型      │ 制約              │ 説明             │
├────────────────┼──────────────┼─────────────────┼─────────────────┤
│ id             │ UUID         │ PK              │ 物件ID          │
│ user_id        │ UUID         │ FK(users), NN   │ 所有者ID        │
│ name           │ TEXT         │ NOT NULL        │ 物件名          │
│ location       │ TEXT         │ NOT NULL        │ 所在地          │
│ purchase_price │ DECIMAL(15,2)│ NOT NULL        │ 購入価格        │
│ land_area      │ DECIMAL(10,2)│ NOT NULL        │ 土地面積(㎡)    │
│ building_area  │ DECIMAL(10,2)│ NOT NULL        │ 建物面積(㎡)    │
│ year_built     │ INTEGER      │ NOT NULL        │ 築年数          │
│ property_type  │ TEXT         │ NOT NULL        │ 物件タイプ      │
│ created_at     │ TIMESTAMPTZ  │ NOT NULL        │ 作成日時        │
│ updated_at     │ TIMESTAMPTZ  │ NOT NULL        │ 更新日時        │
└─────────────────────────────────────────────────────────────────────────┘

用途: 不動産物件の基本情報を保存
特徴: ユーザーごとに複数物件を登録可能（プラン制限あり）
```

### 3. simulations テーブル（シミュレーション結果）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        simulations テーブル                              │
├─────────────────────────────────────────────────────────────────────────┤
│ カラム名         │ データ型     │ 制約              │ 説明             │
├─────────────────┼─────────────┼─────────────────┼─────────────────┤
│ id              │ UUID        │ PK              │ シミュレーションID│
│ user_id         │ UUID        │ FK(users), NN   │ 実行者ID        │
│ property_id     │ UUID        │ FK(properties)  │ 対象物件ID      │
│ simulation_data │ JSONB       │ NOT NULL        │ 入力パラメータ   │
│ results         │ JSONB       │ NOT NULL        │ 計算結果        │
│ cash_flow_table │ JSONB       │                 │ CF詳細テーブル  │
│ created_at      │ TIMESTAMPTZ │ NOT NULL        │ 作成日時        │
│ updated_at      │ TIMESTAMPTZ │ NOT NULL        │ 更新日時        │
└─────────────────────────────────────────────────────────────────────────┘

用途: 投資シミュレーションの入力値と結果を保存
特徴: JSONB型で柔軟なデータ構造、物件と紐付けも可能

【simulation_data の構造】
{
  "purchase_price": 10000000,
  "down_payment": 2000000,
  "loan_amount": 8000000,
  "interest_rate": 2.5,
  "loan_term": 30,
  "monthly_rent": 100000,
  "management_fee": 10000,
  ...
}

【results の構造】
{
  "surface_yield": 12.0,     // 表面利回り
  "real_yield": 8.5,         // 実質利回り
  "monthly_cash_flow": 15000, // 月間CF
  "roi": 18.0,               // ROI
  "ccr": 22.5,               // CCR
  ...
}
```

### 4. subscriptions テーブル（サブスクリプション管理）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       subscriptions テーブル                             │
├─────────────────────────────────────────────────────────────────────────┤
│ カラム名               │ データ型     │ 制約          │ 説明           │
├───────────────────────┼─────────────┼──────────────┼───────────────┤
│ id                    │ UUID        │ PK           │ レコードID     │
│ user_id               │ UUID        │ FK, UNIQUE   │ ユーザーID     │
│ stripe_customer_id    │ TEXT        │ UNIQUE       │ Stripe顧客ID   │
│ stripe_subscription_id│ TEXT        │ UNIQUE       │ StripeサブスクID│
│ stripe_price_id       │ TEXT        │              │ 料金プランID   │
│ status                │ TEXT        │              │ ステータス      │
│ current_period_start  │ TIMESTAMP   │              │ 課金期間開始   │
│ current_period_end    │ TIMESTAMP   │              │ 課金期間終了   │
│ cancel_at_period_end  │ BOOLEAN     │              │ 解約予定フラグ │
│ canceled_at           │ TIMESTAMP   │              │ 解約申請日時   │
│ created_at            │ TIMESTAMP   │              │ 作成日時       │
│ updated_at            │ TIMESTAMP   │              │ 更新日時       │
└─────────────────────────────────────────────────────────────────────────┘

用途: Stripeと連携したサブスクリプション情報を管理
特徴: ユーザーごとに1レコードのみ（UNIQUE制約）

【status の値】
- 'active'     : 有効（支払い済み）
- 'canceling'  : 解約予定（期間終了まで利用可）
- 'cancelled'  : 解約済み
- 'past_due'   : 支払い遅延
- 'inactive'   : 非アクティブ
```

### 5. user_usage テーブル（利用状況管理）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         user_usage テーブル                              │
├─────────────────────────────────────────────────────────────────────────┤
│ カラム名          │ データ型     │ 制約          │ 説明              │
├──────────────────┼─────────────┼──────────────┼──────────────────┤
│ id               │ UUID        │ PK           │ レコードID        │
│ user_id          │ UUID        │ FK, UNIQUE   │ ユーザーID        │
│ usage_count      │ INTEGER     │ DEFAULT 0    │ 今月の利用回数    │
│ period_start_date│ TIMESTAMP   │              │ 期間開始日        │
│ period_end_date  │ TIMESTAMP   │              │ 期間終了日(30日後)│
│ created_at       │ TIMESTAMP   │              │ 作成日時          │
│ updated_at       │ TIMESTAMP   │              │ 更新日時          │
└─────────────────────────────────────────────────────────────────────────┘

用途: 無料プラン・ベーシックプランの月間利用制限を管理
特徴: 30日ごとに自動リセット、check_and_reset_usage()関数で制御

【プラン別制限】
- 無料プラン    : 3件/月
- ベーシック    : 10件/月  
- プレミアム    : 無制限
```

### 6. usage_history テーブル（利用履歴）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        usage_history テーブル                            │
├─────────────────────────────────────────────────────────────────────────┤
│ カラム名      │ データ型     │ 制約              │ 説明              │
├──────────────┼─────────────┼─────────────────┼──────────────────┤
│ id           │ UUID        │ PK              │ 履歴ID            │
│ user_id      │ UUID        │ FK(users)       │ ユーザーID        │
│ feature_type │ TEXT        │ NOT NULL        │ 機能タイプ        │
│ feature_data │ JSONB       │                 │ 詳細データ        │
│ created_at   │ TIMESTAMP   │                 │ 実行日時          │
└─────────────────────────────────────────────────────────────────────────┘

用途: ユーザーの機能利用履歴を記録（分析用）
特徴: 削除不可、追加のみ（イミュータブル）

【feature_type の値】
- 'property_create'  : 物件登録
- 'simulation_run'   : シミュレーション実行
- 'pdf_export'       : PDF出力
- 'property_delete'  : 物件削除
```

## 🔐 RLS（Row Level Security）ポリシー設計

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         RLSポリシー全体構成                             │
└─────────────────────────────────────────────────────────────────────────┘

基本原則: すべてのテーブルでRLSを有効化
認証方式: auth.uid() を使用してユーザーを識別

┌──────────────┬────────────────────────────────────────────────────────┐
│  テーブル     │                    ポリシー内容                        │
├──────────────┼────────────────────────────────────────────────────────┤
│              │ SELECT: auth.uid() = id                               │
│   users      │ UPDATE: auth.uid() = id                               │
│              │ INSERT: auth.uid() = id                               │
│              │ DELETE: 不可                                           │
├──────────────┼────────────────────────────────────────────────────────┤
│              │ SELECT: auth.uid() = user_id                          │
│ properties   │ INSERT: auth.uid() = user_id                          │
│              │ UPDATE: auth.uid() = user_id                          │
│              │ DELETE: auth.uid() = user_id                          │
├──────────────┼────────────────────────────────────────────────────────┤
│              │ SELECT: auth.uid() = user_id                          │
│ simulations  │ INSERT: auth.uid() = user_id                          │
│              │ UPDATE: auth.uid() = user_id                          │
│              │ DELETE: auth.uid() = user_id                          │
├──────────────┼────────────────────────────────────────────────────────┤
│              │ SELECT: auth.uid() = user_id                          │
│subscriptions │ INSERT: Service Role のみ（Edge Functions）            │
│              │ UPDATE: Service Role のみ（Edge Functions）            │
│              │ DELETE: 不可                                           │
├──────────────┼────────────────────────────────────────────────────────┤
│              │ SELECT: auth.uid() = user_id                          │
│ user_usage   │ INSERT: Service Role のみ（自動作成）                  │
│              │ UPDATE: Service Role のみ（関数経由）                  │
│              │ DELETE: 不可                                           │
├──────────────┼────────────────────────────────────────────────────────┤
│              │ SELECT: auth.uid() = user_id                          │
│usage_history │ INSERT: Service Role のみ（自動記録）                  │
│              │ UPDATE: 不可（イミュータブル）                          │
│              │ DELETE: 不可（監査ログ）                               │
└──────────────┴────────────────────────────────────────────────────────┘
```

### RLSポリシー実装例

```sql
-- usersテーブルのRLSポリシー
┌─────────────────────────────────────────────────────────────────────────┐
│ CREATE POLICY "Users can view their own profile"                       │
│   ON public.users FOR SELECT                                          │
│   USING (auth.uid() = id);                                           │
│                                                                        │
│ CREATE POLICY "Users can update their own profile"                    │
│   ON public.users FOR UPDATE                                          │
│   USING (auth.uid() = id);                                           │
└─────────────────────────────────────────────────────────────────────────┘

-- propertiesテーブルのRLSポリシー
┌─────────────────────────────────────────────────────────────────────────┐
│ CREATE POLICY "Users can manage their own properties"                  │
│   ON public.properties FOR ALL                                        │
│   USING (auth.uid() = user_id)                                       │
│   WITH CHECK (auth.uid() = user_id);                                 │
└─────────────────────────────────────────────────────────────────────────┘

-- subscriptionsテーブルのRLSポリシー（読み取りのみ）
┌─────────────────────────────────────────────────────────────────────────┐
│ CREATE POLICY "Users can view own subscription"                        │
│   ON public.subscriptions FOR SELECT                                  │
│   USING (auth.uid() = user_id);                                      │
│                                                                        │
│ -- 書き込みはService Roleのみ（Edge Functions経由）                     │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔄 データベース関数（Functions）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       主要なデータベース関数                             │
└─────────────────────────────────────────────────────────────────────────┘

1. check_and_reset_usage(user_id UUID)
   ┌────────────────────────────────────────────────────┐
   │ 機能: 利用制限の確認と月次リセット                  │
   │ 入力: user_id                                     │
   │ 出力: current_count, period_end                   │
   │ 処理:                                             │
   │  1. user_usageテーブルを確認                      │
   │  2. 期間終了していたらカウントリセット             │
   │  3. 現在の利用数と期限を返す                      │
   └────────────────────────────────────────────────────┘

2. increment_usage_count(user_id UUID)
   ┌────────────────────────────────────────────────────┐
   │ 機能: 利用回数のインクリメント                     │
   │ 入力: user_id                                     │
   │ 出力: new_count                                   │
   │ 処理:                                             │
   │  1. usage_count を +1                             │
   │  2. updated_at を更新                             │
   │  3. 新しいカウント数を返す                        │
   └────────────────────────────────────────────────────┘

3. check_subscription_status(user_id UUID)
   ┌────────────────────────────────────────────────────┐
   │ 機能: サブスクリプション状態確認                   │
   │ 入力: user_id                                     │
   │ 出力: is_active, plan_type                        │
   │ 処理:                                             │
   │  1. subscriptionsテーブル確認                     │
   │  2. statusがactiveか判定                          │
   │  3. プランタイプを返す                            │
   └────────────────────────────────────────────────────┘
```

## 🔍 インデックス設計

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         インデックス一覧                                 │
└─────────────────────────────────────────────────────────────────────────┘

テーブル: user_usage
├─ idx_user_usage_user_id       : user_id        (検索高速化)
└─ idx_user_usage_period_end    : period_end_date (期限チェック用)

テーブル: subscriptions  
├─ idx_subscriptions_user_id    : user_id        (ユーザー検索)
├─ idx_subscriptions_stripe_customer_id : stripe_customer_id
├─ idx_subscriptions_status     : status         (状態フィルタ)
└─ UNIQUE制約                   : user_id        (重複防止)

テーブル: usage_history
├─ idx_usage_history_user_id    : user_id        (ユーザー別集計)
├─ idx_usage_history_created_at : created_at     (期間検索)
└─ idx_usage_history_feature_type : feature_type (機能別分析)

テーブル: properties
├─ idx_properties_user_id       : user_id        (所有者検索)
└─ idx_properties_created_at    : created_at     (新着順表示)

テーブル: simulations
├─ idx_simulations_user_id      : user_id        (ユーザー検索)
└─ idx_simulations_property_id  : property_id    (物件別履歴)
```

## 🚀 トリガー設計

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         トリガー一覧                                     │
└─────────────────────────────────────────────────────────────────────────┘

1. updated_at 自動更新トリガー
   ┌────────────────────────────────────────────────────┐
   │ 対象テーブル: 全テーブル                           │
   │ タイミング: BEFORE UPDATE                         │
   │ 処理: updated_at = NOW()                         │
   └────────────────────────────────────────────────────┘

2. 利用履歴自動記録トリガー
   ┌────────────────────────────────────────────────────┐
   │ 対象テーブル: properties                          │
   │ タイミング: AFTER INSERT/DELETE                   │
   │ 処理: usage_historyに記録を追加                   │
   └────────────────────────────────────────────────────┘

3. 利用制限チェックトリガー
   ┌────────────────────────────────────────────────────┐
   │ 対象テーブル: properties                          │
   │ タイミング: BEFORE INSERT                         │
   │ 処理: プラン制限を超えていないか確認               │
   └────────────────────────────────────────────────────┘
```

## 📈 パフォーマンス最適化

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      パフォーマンス最適化戦略                            │
└─────────────────────────────────────────────────────────────────────────┘

1. クエリ最適化
   ├─ 必要なカラムのみSELECT（SELECT * を避ける）
   ├─ JOINよりもサブクエリを活用
   └─ LIMIT句で取得件数を制限

2. インデックス戦略
   ├─ 外部キーには自動的にインデックス
   ├─ 検索条件によく使うカラムにインデックス
   └─ 複合インデックスは左端から使用

3. JSONB最適化
   ├─ GINインデックスでJSONB検索を高速化
   ├─ 頻繁にアクセスする値は別カラムに
   └─ JSONBの深いネストを避ける

4. RLS最適化
   ├─ ポリシー条件をシンプルに保つ
   ├─ auth.uid()の呼び出しを最小限に
   └─ 複雑な条件は関数化してSECURITY DEFINER

5. 接続プール
   ├─ Supabase Poolerを使用
   ├─ Transaction modeで接続数を削減
   └─ 適切なタイムアウト設定
```

## 🔧 メンテナンス計画

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        メンテナンス計画                                  │
└─────────────────────────────────────────────────────────────────────────┘

日次メンテナンス
├─ usage_historyの古いレコード確認
├─ エラーログの確認
└─ パフォーマンス指標の確認

週次メンテナンス
├─ インデックスの使用状況確認
├─ スロークエリの分析
└─ ストレージ使用量の確認

月次メンテナンス
├─ テーブル統計情報の更新（ANALYZE）
├─ 不要なインデックスの削除
├─ バックアップの確認
└─ RLSポリシーの見直し

四半期メンテナンス
├─ データベース構造の最適化検討
├─ アーカイブ戦略の見直し
└─ セキュリティ監査
```

## 🚨 注意事項

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         重要な注意事項                                   │
└─────────────────────────────────────────────────────────────────────────┘

1. RLSは必ず有効化
   - 全テーブルでENABLE ROW LEVEL SECURITY
   - Service Roleキー使用時のみバイパス

2. 外部キー制約
   - ON DELETE CASCADEで親レコード削除時の整合性維持
   - NULL許可で柔軟性を確保

3. タイムゾーン
   - すべてTIMESTAMPTZ型を使用
   - JSTへの変換はアプリケーション層で

4. バックアップ
   - Supabaseの自動バックアップに依存
   - 重要な変更前は手動バックアップ

5. マイグレーション
   - 本番環境への適用は慎重に
   - ロールバック計画を準備
```

---

作成者: Claude Code  
作成日: 2025-08-15  
バージョン: 1.0
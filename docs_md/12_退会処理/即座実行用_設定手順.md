# 解約機能を今すぐ動作させる手順

## 🚀 クイックセットアップ

### Step 1: Supabaseダッシュボードにログイン

1. https://supabase.com/dashboard にアクセス
2. プロジェクト `gtnzhnsbdmkadfawuzmc` を選択

### Step 2: データベースマイグレーション実行

1. **SQL Editor**タブを開く
2. 以下のSQLを実行：

ERROR:  42601: syntax error at or near "```"
LINE 1: ```sql

### Step 3: Edge Functionをデプロイ

ターミナルで以下を実行：

```bash
# 1. Supabase CLIにログイン
npx supabase login

# 2. プロジェクトをリンク
npx supabase link --project-ref gtnzhnsbdmkadfawuzmc

# 3. Edge Functionをデプロイ
npx supabase functions deploy cancel-subscription --no-verify-jwt
```

### Step 4: 環境変数を設定

1. Supabaseダッシュボードで **Edge Functions** を開く
2. `cancel-subscription` 関数を選択
3. **Settings** タブで環境変数を追加：

| 変数名 | 値 |
|--------|-----|
| STRIPE_SECRET_KEY | Stripeダッシュボードから取得（sk_test_...またはsk_live_...） |

### Step 5: ローカル開発環境の設定

`.env.local`ファイルを作成：

```bash
# /workspaces/real-estate-app/bolt_front/.env.local
VITE_SUPABASE_URL=https://gtnzhnsbdmkadfawuzmc.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0bnpobnNiZG1rYWRmYXd1em1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2NTIzMzUsImV4cCI6MjA2NjIyODMzNX0.GHmfv3kYC1taYQs4szygp-YKv5VGKA1QWW3GY6uTvFg
```

### Step 6: 開発サーバーを再起動

```bash
# 一度停止（Ctrl+C）してから再起動
cd /workspaces/real-estate-app/bolt_front
npm run dev
```

## ✅ 動作確認

1. プレミアム会員でログイン
2. `/premium-plan` ページにアクセス
3. 「プランを解約」ボタンをクリック
4. モーダルで「解約する」をクリック
5. 解約が完了することを確認

## 🔍 トラブルシューティング

### Edge Functionが404エラーの場合
- デプロイが完了しているか確認
- 関数名が正しいか確認（cancel-subscription）

### 認証エラーの場合
- ログインし直す
- JWTトークンが有効か確認

### Stripeエラーの場合
- STRIPE_SECRET_KEYが正しく設定されているか確認
- Stripeダッシュボードでサブスクリプションの状態を確認

### CORSエラーの場合
- Edge FunctionのCORS設定を確認
- フロントエンドのURLが許可されているか確認
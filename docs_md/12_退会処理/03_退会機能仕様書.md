# 退会機能仕様書

## 概要
ユーザーがサービスから完全に退会（アカウント削除）するための機能仕様。
個人情報保護とデータ削除ポリシーを含む。

作成日: 2025年8月13日  
バージョン: 1.0

---

## 1. 退会機能の実装方針

### Phase 1: お問い合わせ対応（推奨）
- 退会はメールでの申請受付
- 手動での処理
- 本人確認後にデータ削除

### Phase 2: セルフサービス退会（将来実装）
- アプリ内から直接退会可能
- 自動データ削除処理

---

## 2. Phase 1: お問い合わせベースの退会

### 2.1 実装内容

#### フッターに退会案内リンク追加
```typescript
// Footer.tsx
<div className="footer-links">
  <a href="mailto:support@ooya-dx.com?subject=退会のお申し込み">
    退会をご希望の方
  </a>
</div>
```

#### 退会申請メールテンプレート
```
件名: 退会のお申し込み

退会を希望される場合は、以下の情報をお送りください：
1. 登録メールアドレス
2. お名前
3. 退会理由（任意）

3営業日以内に退会処理を完了し、ご連絡いたします。
```

### 2.2 運用フロー

1. **ユーザーからの退会申請**
   - メールで退会希望を受付

2. **本人確認**
   - 登録メールアドレスと照合
   - 必要に応じて追加確認

3. **データ削除処理**
   - 手動でデータ削除スクリプトを実行

4. **完了通知**
   - 退会完了メールを送信

---

## 3. データ削除ポリシー

### 3.1 削除タイミング

| データ種別 | 削除タイミング | 理由 |
|-----------|--------------|------|
| 個人情報 | 即時削除 | プライバシー保護 |
| 物件データ | 即時削除 | 個人資産情報 |
| シミュレーション結果 | 即時削除 | 個人の投資情報 |
| 利用ログ | 30日後に匿名化 | サービス改善分析 |
| 決済履歴 | 7年間保持後削除 | 法的要件（税法） |

### 3.2 削除対象テーブル

```sql
-- 即時削除
DELETE FROM properties WHERE user_id = ?;
DELETE FROM simulations WHERE user_id = ?;
DELETE FROM market_analyses WHERE user_id = ?;
DELETE FROM property_shares WHERE owner_id = ?;
DELETE FROM share_comments WHERE user_id = ?;
DELETE FROM comment_reactions WHERE user_id = ?;
DELETE FROM users WHERE id = ?;

-- 匿名化（30日後）
UPDATE usage_history SET user_id = 'deleted_user_' || gen_random_uuid() 
WHERE user_id = ? AND created_at < NOW() - INTERVAL '30 days';

-- 保持（決済情報）
-- subscriptionsテーブルのuser_idをNULLまたは匿名IDに更新
UPDATE subscriptions SET user_id = NULL WHERE user_id = ?;
```

---

## 4. Phase 2: セルフサービス退会（将来実装）

### 4.1 UI設計

#### アカウント設定ページ
```typescript
// AccountSettings.tsx
<div className="danger-zone">
  <h3>アカウントの削除</h3>
  <p>アカウントを削除すると、すべてのデータが失われます。</p>
  <button 
    onClick={handleDeleteAccount}
    className="btn-danger"
  >
    アカウントを削除
  </button>
</div>
```

#### 確認フロー（多段階確認）

1. **初回クリック**
```typescript
<Modal>
  <h2>本当にアカウントを削除しますか？</h2>
  <p>この操作は取り消せません。</p>
  <button>削除する</button>
  <button>キャンセル</button>
</Modal>
```

2. **最終確認**
```typescript
<Modal>
  <h2>最終確認</h2>
  <p>確認のため、メールアドレスを入力してください</p>
  <input type="email" placeholder="your@email.com" />
  <button>アカウントを完全に削除</button>
</Modal>
```

### 4.2 Edge Function実装

```typescript
// supabase/functions/delete-account/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'

serve(async (req) => {
  const { email } = await req.json()
  
  // 1. 認証確認
  const user = await authenticateUser(req.headers.get('Authorization'))
  
  // 2. メールアドレス確認
  if (user.email !== email) {
    return new Response('Email mismatch', { status: 400 })
  }
  
  // 3. プレミアム会員の場合は先に解約
  if (await hasActiveSubscription(user.id)) {
    await cancelSubscription(user.id)
  }
  
  // 4. データ削除
  await deleteUserData(user.id)
  
  // 5. Auth削除
  await supabase.auth.admin.deleteUser(user.id)
  
  return new Response(JSON.stringify({ success: true }))
})
```

---

## 5. 法的考慮事項

### 5.1 個人情報保護法対応
- データ削除の権利を保証
- 削除要求から30日以内に対応
- 削除証明書の発行（要求があれば）

### 5.2 保持が必要なデータ
- **決済履歴**: 税法により7年間保持
- **法的紛争関連**: 係争中のデータは保持
- **バックアップ**: 90日間はバックアップに残存

### 5.3 GDPR対応（将来的に）
- Right to be forgotten（忘れられる権利）
- データポータビリティ
- 削除要求から1ヶ月以内に対応

---

## 6. セキュリティ考慮事項

### 6.1 本人確認
- メールアドレスの照合
- 最近のログイン確認
- 不審な削除要求の検知

### 6.2 誤削除防止
- 多段階確認プロセス
- クーリングオフ期間（7日間）
- 削除前のデータエクスポート提供

### 6.3 悪用防止
- レート制限
- IPアドレス記録
- 異常パターンの検知

---

## 7. 実装優先度とコスト

| 実装方式 | 工数 | メリット | デメリット |
|---------|------|---------|-----------|
| Phase 1: メール対応 | 1時間 | 実装が簡単、人的確認あり | 手動対応が必要 |
| Phase 2: セルフサービス | 16時間 | 自動化、UX向上 | 実装が複雑、リスク高 |

**推奨**: Phase 1から開始し、退会数が増えたらPhase 2を検討

---

## 8. 退会防止施策

### 8.1 退会理由の分析
- アンケート実施
- 主要な退会理由の特定
- 改善施策の立案

### 8.2 リテンション施策
- 退会前の割引オファー
- 一時停止オプションの提供
- カスタマーサポートへの誘導

### 8.3 再入会の促進
- 退会後のメールマーケティング（許可がある場合）
- 特別オファーの提供
- データ復元オプション（30日以内）

---

## 9. メトリクスとKPI

### 追跡すべき指標
- 退会率（月次）
- 退会理由の分布
- 退会から再入会までの期間
- カスタマーライフタイムバリュー

### 目標値
- 月次退会率: 5%以下
- 退会撤回率: 10%以上
- 再入会率: 20%以上

---

## 10. FAQ

**Q: 退会後にデータを復元できますか？**  
A: 退会から30日以内であれば、サポートにご連絡いただければ復元可能です。

**Q: 退会理由を聞かれますか？**  
A: 任意でアンケートにご協力いただく場合がありますが、必須ではありません。

**Q: 決済情報はどうなりますか？**  
A: 法的要件により7年間保持されますが、個人を特定できない形で管理されます。

**Q: 再入会はできますか？**  
A: はい、いつでも再入会可能です。新規アカウントとして登録していただきます。

---

## 関連ドキュメント

- [ダウングレード機能仕様書](./01_ダウングレード機能仕様書.md)
- [Phase 1 最小限実装仕様書](./02_Phase1_最小限実装仕様書.md)
- [個人情報保護方針](/privacy-policy)

---

*このドキュメントは随時更新されます。*  
*Phase 1の実装を優先し、必要に応じてPhase 2を検討してください。*
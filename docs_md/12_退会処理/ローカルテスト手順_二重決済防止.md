# ローカルテスト手順（二重決済防止システム）

## 現在の実装状況

### ✅ 完了した実装
1. **PremiumPlan.tsx**
   - 状態に応じたボタン表示ロジック
   - 解約予定時は「解約を取り消す」ボタンのみ表示
   - handleResumeSubscription関数の追加

2. **UpgradeModal.tsx**
   - 既存サブスクリプションのチェック機能
   - 二重クリック防止（isLoadingフラグ）

3. **Edge Functions**
   - `cancel-subscription`: 解約処理
   - `resume-subscription`: 解約取り消し（新規作成）
   - `create-checkout-session`: 重複チェック追加

4. **データベース**
   - UNIQUE制約のマイグレーションファイル作成

## ローカルでテスト可能な機能

### 1. UI表示の確認

現在の開発サーバー（http://localhost:5173）で以下を確認：

#### A. 未ログイン状態
- プレミアムプランページで「プランを選択」ボタンが表示される
- クリックすると「ログインが必要です」アラートが表示される

#### B. 無料会員の状態
- ログイン後、プレミアムプランページで「プランを選択」ボタンが表示される

#### C. プレミアム会員の状態（データベースで手動設定）
```sql
-- テスト用：ユーザーをプレミアム会員にする
UPDATE subscriptions 
SET 
    status = 'active',
    cancel_at_period_end = false,
    cancel_at = NULL
WHERE user_id = 'YOUR_USER_ID';
```
- 「プランを解約」ボタンが表示される

#### D. 解約予定の状態（データベースで手動設定）
```sql
-- テスト用：解約予定状態にする
UPDATE subscriptions 
SET 
    status = 'active',
    cancel_at_period_end = true,
    cancel_at = NOW() + INTERVAL '30 days',
    current_period_end = NOW() + INTERVAL '30 days'
WHERE user_id = 'YOUR_USER_ID';
```
- 「解約を取り消す」ボタンが表示される
- 残り日数が表示される

### 2. 重複購入防止の確認

1. **フロントエンドでのブロック**
   - プレミアム会員でログイン
   - ブラウザの開発者ツールでコンソールを開く
   - UpgradeModalで購入を試みる
   - 「すでにプレミアムプランに登録されています」エラーが表示される

2. **ボタンの二重クリック防止**
   - 購入ボタンを素早く2回クリック
   - 1回目で「処理中...」に変わることを確認

## Edge Functionsのローカルテスト

### 前提条件
```bash
# Supabase CLIがインストールされていること
npm install -g supabase
```

### ローカルでEdge Functionsを起動
```bash
# Supabaseローカル環境を起動
supabase start

# Edge Functionsをローカルで起動
supabase functions serve
```

### テストリクエストの送信

#### 解約のテスト
```bash
curl -X POST http://localhost:54321/functions/v1/cancel-subscription \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json"
```

#### 解約取り消しのテスト
```bash
curl -X POST http://localhost:54321/functions/v1/resume-subscription \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json"
```

## データベースの動作確認

### 1. UNIQUE制約のテスト

```sql
-- 同じユーザーで2つのアクティブなサブスクリプションを作成しようとする
INSERT INTO subscriptions (
    user_id,
    stripe_subscription_id,
    stripe_customer_id,
    status,
    cancel_at_period_end
) VALUES 
    ('USER_ID', 'sub_test_1', 'cus_test_1', 'active', false),
    ('USER_ID', 'sub_test_2', 'cus_test_2', 'active', false);

-- エラーが発生すれば制約が機能している
```

### 2. 解約予定は複数許可されることを確認

```sql
-- 解約予定のサブスクリプションは複数作成可能
INSERT INTO subscriptions (
    user_id,
    stripe_subscription_id,
    stripe_customer_id,
    status,
    cancel_at_period_end
) VALUES 
    ('USER_ID', 'sub_test_3', 'cus_test_3', 'active', true);
-- これは成功するはず
```

## チェックリスト

### UI動作確認
- [ ] 未ログイン時の表示
- [ ] 無料会員時の表示
- [ ] プレミアム会員時の表示
- [ ] 解約予定時の表示
- [ ] 解約を取り消すボタンの動作

### 重複防止確認
- [ ] フロントエンドでのブロック
- [ ] ボタンの二重クリック防止
- [ ] エラーメッセージの表示

### Edge Functions確認（デプロイ後）
- [ ] cancel-subscriptionの動作
- [ ] resume-subscriptionの動作
- [ ] create-checkout-sessionの重複チェック

### データベース確認
- [ ] UNIQUE制約の動作
- [ ] 解約予定の複数作成許可

## トラブルシューティング

### 問題: ボタンが正しく表示されない
1. ブラウザのキャッシュをクリア
2. 開発サーバーを再起動
3. subscriptionsテーブルのデータを確認

### 問題: Edge Functionが動作しない
1. Supabaseローカル環境が起動しているか確認
2. 環境変数が設定されているか確認
3. ログを確認: `supabase functions logs <function-name>`

### 問題: データベース制約エラー
1. マイグレーションが適用されているか確認
2. 既存の重複データがないか確認
3. 制約の定義を確認

## 次のステップ

1. **本番環境へのデプロイ**
   - Edge Functionsのデプロイ
   - データベースマイグレーションの適用

2. **Stripeとの統合テスト**
   - 実際のStripe IDでのテスト
   - Webhookの動作確認

3. **負荷テスト**
   - 同時アクセス時の動作確認
   - エラーハンドリングの確認
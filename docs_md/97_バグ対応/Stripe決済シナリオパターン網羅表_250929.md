# 📊 Stripe決済シナリオパターン網羅表

## 📅 作成日
2025年9月29日

## 🎯 目的
Stripe決済システムの全シナリオパターンを網羅的に整理し、各ケースでの期待動作と潜在的な問題を明確化する

---

## 1️⃣ サブスクリプション作成パターン

| No | シナリオ | ユーザーアクション | Stripe API呼び出し | 期待される動作 | 課金タイミング | 潜在的な問題 | 対策状況 |
|----|---------|-------------------|------------------|--------------|-------------|------------|---------|
| 1-1 | 新規登録 | 無料会員登録 | なし | users/profilesテーブルにレコード作成 | なし | - | ✅ 正常 |
| 1-2 | 初回プラン契約 | プレミアムプラン申込 | `checkout.session.create` → `subscription.create` | subscriptionsテーブルに新規レコード作成 | 即時¥2,980 | Webhook重複で複数レコード作成 | ✅ 修正済(stripe_events) |
| 1-3 | 無料からアップグレード | 無料→プレミアム | `checkout.session.create` | 既存レコードをupdateまたは新規作成 | 即時¥2,980 | 既存レコードとの競合 | ⚠️ 要確認 |
| 1-4 | 支払い失敗後の再試行 | カード情報再入力 | `payment_method.attach` → `subscription.update` | statusを'active'に更新 | 成功時に課金 | 複数回の再試行で重複課金 | ⚠️ 要確認 |
| 1-5 | トライアル開始 | お試しプラン申込 | `subscription.create` with `trial_period_days` | status='trialing'で作成 | トライアル終了時 | トライアル終了時の自動課金失敗 | ⚠️ 要確認 |

---

## 2️⃣ サブスクリプション更新パターン

| No | シナリオ | ユーザーアクション | Stripe API呼び出し | 期待される動作 | 課金タイミング | 潜在的な問題 | 対策状況 |
|----|---------|-------------------|------------------|--------------|-------------|------------|---------|
| 2-1 | 月次自動更新 | なし（自動） | Stripeが`invoice.payment_succeeded`送信 | current_period_end更新 | 月次請求日 | Webhook重複で複数回DB更新 | ✅ 修正済(stripe_events) |
| 2-2 | カード情報更新 | 支払い方法変更 | `payment_method.update` | stripe_customer_id関連情報更新 | 次回請求時 | 更新中の課金失敗 | ⚠️ 要確認 |
| 2-3 | プラン変更 | プラン切替 | `subscription.update` with new price | stripe_price_id更新 | 即時差額請求 or 次回 | プロレーション計算ミス | ⚠️ 要確認 |
| 2-4 | 支払い失敗 | なし（カード期限切れ等） | `invoice.payment_failed` | status='past_due'に更新 | リトライ時 | 複数回のリトライで状態不整合 | ⚠️ 要確認 |
| 2-5 | 支払い成功（リトライ後） | なし（自動リトライ） | `invoice.payment_succeeded` | status='active'に復帰 | リトライ成功時 | 状態更新の競合 | ⚠️ 要確認 |

---

## 3️⃣ サブスクリプション解約パターン

| No | シナリオ | ユーザーアクション | Stripe API呼び出し | 期待される動作 | 課金タイミング | 潜在的な問題 | 対策状況 |
|----|---------|-------------------|------------------|--------------|-------------|------------|---------|
| 3-1 | 期間終了時解約 | 解約ボタンクリック | `subscription.update` with `cancel_at_period_end=true` | cancel_at_period_end=true, cancel_at設定 | なし | 複数回実行で状態不整合 | ✅ 正常 |
| 3-2 | 即時解約 | 即座に解約 | `subscription.delete` | status='cancelled' | なし（返金あり） | 返金処理の失敗 | ⚠️ 未実装 |
| 3-3 | 解約キャンセル | 解約取り消し | `subscription.update` with `cancel_at_period_end=false` | cancel_at_period_end=false, cancel_at=null | なし | **即時追加課金発生** | ✅ 修正済(proration_behavior) |
| 3-4 | 期限到達による自動解約 | なし（自動） | `customer.subscription.deleted` | status='cancelled' | なし | Webhook遅延で状態不整合 | ⚠️ 要確認 |
| 3-5 | 支払い失敗による強制解約 | なし（自動） | `subscription.deleted` after max retries | status='cancelled' | なし | ユーザーへの通知漏れ | ⚠️ 要確認 |

---

## 4️⃣ 返金・調整パターン

| No | シナリオ | ユーザーアクション | Stripe API呼び出し | 期待される動作 | 課金タイミング | 潜在的な問題 | 対策状況 |
|----|---------|-------------------|------------------|--------------|-------------|------------|---------|
| 4-1 | 全額返金 | サポート依頼 | `refund.create` | 返金処理、ステータス維持 | マイナス計上 | サブスクリプション状態との不整合 | ⚠️ 手動対応 |
| 4-2 | 部分返金 | サポート依頼 | `refund.create` with amount | 部分返金、継続 | 差額のみ | 次回請求額の計算ミス | ⚠️ 手動対応 |
| 4-3 | クレジット付与 | プロモーション | `customer.balance_transaction.create` | 次回請求から差引 | 次回請求時に相殺 | クレジット管理の複雑化 | ⚠️ 未実装 |
| 4-4 | 日割り計算 | プラン変更時 | 自動プロレーション | 差額の請求/返金 | 変更時 | 計算ロジックの誤り | ⚠️ 要確認 |
| 4-5 | 重複課金の返金 | バグ発生時 | `refund.create` | 重複分を返金 | 返金処理 | 返金対象の特定ミス | ✅ 手動対応中 |

---

## 5️⃣ Webhookイベントパターン

| No | イベント名 | トリガー | 処理内容 | DB更新 | 潜在的な問題 | 対策状況 |
|----|-----------|---------|---------|--------|------------|---------|
| 5-1 | checkout.session.completed | 初回決済成功 | サブスクリプション作成 | subscriptions INSERT | 重複処理 | ✅ 修正済(stripe_events) |
| 5-2 | customer.subscription.created | サブスクリプション作成 | DB同期 | subscriptions INSERT/UPDATE | 重複レコード | ✅ 修正済(stripe_events) |
| 5-3 | customer.subscription.updated | 各種更新 | ステータス同期 | subscriptions UPDATE | **複数回更新** | ✅ 修正済(stripe_events) |
| 5-4 | customer.subscription.deleted | 解約完了 | ステータス更新 | status='cancelled' | 遅延による不整合 | ✅ 修正済(stripe_events) |
| 5-5 | invoice.payment_succeeded | 支払い成功 | 期間更新 | current_period更新 | 重複更新 | ✅ 修正済(stripe_events) |
| 5-6 | invoice.payment_failed | 支払い失敗 | ステータス更新 | status='past_due' | リトライとの競合 | ⚠️ 要確認 |
| 5-7 | invoice.upcoming | 請求予定通知 | 通知のみ | なし | 不要な処理実行 | ✅ 処理なし |

---

## 6️⃣ エッジケース・異常系パターン

| No | シナリオ | 発生条件 | 期待される動作 | 現在の動作 | リスクレベル | 対策状況 |
|----|---------|---------|--------------|-----------|------------|---------|
| 6-1 | 同時複数デバイスからの操作 | 複数タブ/デバイスで同時操作 | 最後の操作のみ有効 | 全て処理される可能性 | 🔴 高 | ⚠️ 要対策 |
| 6-2 | Webhook受信順序の逆転 | ネットワーク遅延 | 時系列で処理 | 受信順で処理 | 🟡 中 | ⚠️ 要対策 |
| 6-3 | Stripeダウンタイム中の操作 | Stripe障害時 | エラー表示&リトライ | タイムアウトエラー | 🟡 中 | ⚠️ 要対策 |
| 6-4 | DBトランザクション失敗 | DB接続エラー | ロールバック&リトライ | 部分的更新の可能性 | 🔴 高 | ⚠️ 要対策 |
| 6-5 | 大量Webhookの同時受信 | 一括処理や障害復旧時 | キューイング処理 | 同時並行処理 | 🟡 中 | ⚠️ 要対策 |
| 6-6 | 削除済みユーザーへのWebhook | ユーザー退会後 | 無視またはログのみ | エラー発生 | 🟢 低 | ⚠️ 要対策 |
| 6-7 | 不正なWebhook署名 | 攻撃や設定ミス | 拒否&ログ記録 | 署名検証実施中 | 🟡 中 | ✅ 実装済 |
| 6-8 | プラン多重契約の試行 | バグや不正操作 | 拒否（1ユーザー1プラン） | DB制約で防止 | 🟢 低 | ✅ 実装済 |

---

## 7️⃣ 同期システムパターン

| No | システム | 実行タイミング | 処理内容 | 問題点 | 対策状況 |
|----|---------|--------------|---------|--------|---------|
| 7-1 | Stripe Webhook | リアルタイム | イベント受信&DB更新 | 重複処理 | ✅ 修正済(stripe_events) |
| 7-2 | GitHub Actions | 6時間毎（無効化済） | 全サブスクリプション同期 | Webhookとの競合 | ✅ 無効化済 |
| 7-3 | pg_cron | 1時間毎（削除済） | 期限切れクリーンアップ | 不要な負荷 | ✅ 削除済 |
| 7-4 | 手動同期 | 管理者実行時 | 強制同期 | 状態不整合リスク | ⚠️ 要注意 |
| 7-5 | バッチ復旧処理 | 障害復旧時 | 差分同期 | 大量更新による負荷 | ⚠️ 未実装 |

---

## 8️⃣ 料金・プロレーションパターン

| No | シナリオ | 計算方法 | 課金額 | 問題点 | 対策状況 |
|----|---------|---------|--------|--------|---------|
| 8-1 | 月初契約 | 満額請求 | ¥2,980 | なし | ✅ 正常 |
| 8-2 | 月中契約 | 日割りなし（満額） | ¥2,980 | ユーザー不満の可能性 | ⚠️ 仕様確認 |
| 8-3 | 月中解約 | 返金なし | ¥0 | 期間まで利用可能 | ✅ 正常 |
| 8-4 | プランアップグレード | - | - | 単一プランのため対象外 | 🟢 N/A |
| 8-5 | プランダウングレード | - | - | 単一プランのため対象外 | 🟢 N/A |
| 8-6 | 解約キャンセル | 追加請求なし | ¥0 | **バグで即時課金発生していた** | ✅ 修正済(proration_behavior) |
| 8-7 | 無料期間終了 | 自動課金開始 | ¥2,980 | 事前通知なしの課金 | ⚠️ 要確認 |

---

## 🔍 特定された主要な問題と対策

### ✅ 解決済みの問題

1. **Webhook重複処理**
   - 原因: イデンポテンシーチェックなし
   - 対策: stripe_eventsテーブルでイベントID管理
   - 状態: ✅ 2025-09-29実装完了

2. **解約キャンセル時の即時課金**
   - 原因: proration_behavior未指定
   - 対策: `proration_behavior: 'none'`追加
   - 状態: ✅ 2025-09-29実装完了

3. **複数同期システムの競合**
   - 原因: GitHub Actions、pg_cron、Webhookが並行実行
   - 対策: Webhookのみに一本化
   - 状態: ✅ 2025-09-29完了

### ⚠️ 要対応の課題

1. **同時実行制御**
   - リスク: 複数デバイスからの同時操作
   - 推奨対策: 楽観的ロックまたは分散ロック

2. **プラン変更時のプロレーション**
   - リスク: 意図しない課金額
   - 推奨対策: 明示的なproration_behavior設定

3. **エラーリトライ戦略**
   - リスク: 無限リトライによる負荷
   - 推奨対策: exponential backoffとdead letter queue

4. **監視・アラート体制**
   - リスク: 問題の発見遅れ
   - 推奨対策: 異常パターン自動検知システム

---

## 📋 テスト推奨シナリオ（優先順位順）

### 🔴 高優先度（バグ発生済み）

1. [ ] 解約→解約キャンセルのフロー
2. [ ] Webhook重複送信時の動作
3. [ ] 月次自動更新の正常処理

### 🟡 中優先度（リスクあり）

4. [ ] 支払い失敗→リトライ→成功
5. [ ] プラン変更（アップグレード/ダウングレード）
6. [ ] 同時複数デバイスからの操作

### 🟢 低優先度（定期確認）

7. [ ] 新規登録→初回課金
8. [ ] カード情報の更新
9. [ ] 通常の月次課金

---

## 📝 現在のシステム構成

### プラン構成
- **プレミアムプラン**: ¥2,980/月（単一プランのみ）
- その他のプラン: なし

### 返金対応
- Stripeダッシュボードで手動対応中
- システムによる自動返金: 未実装（現時点では不要）

---

## 🎯 今後の改善提案

### 短期対応（1週間以内）

1. **全API呼び出しにproration_behavior明示**
   ```typescript
   stripe.subscriptions.update(id, {
     proration_behavior: 'none', // 現在は単一プランのため'none'で統一
   })
   ```

2. **トランザクション管理の強化**
   ```typescript
   await db.transaction(async (trx) => {
     // Stripe API呼び出し
     // DB更新
     // ロールバック可能に
   })
   ```

3. **詳細ログの追加**
   - 全Stripe API呼び出しのリクエスト/レスポンス
   - タイムスタンプと実行時間
   - ユーザーIDとセッション情報

### 中期対応（1ヶ月以内）

1. **イベント処理のキューイング**
   - Webhook受信→キュー→順次処理
   - 優先度付きキュー実装

2. **包括的なE2Eテスト**
   - 全シナリオパターンの自動テスト
   - Stripe Test Clockを使用した時系列テスト

3. **監視ダッシュボード構築**
   - リアルタイム課金状況
   - 異常パターン検知
   - 自動アラート

### 長期対応（3ヶ月以内）

1. **決済システムの抽象化**
   - Stripe以外の決済手段対応準備
   - 決済プロバイダー切り替え可能な設計

2. **詳細な課金レポート機能**
   - ユーザー向け請求履歴
   - 管理者向け収益分析

3. **SLAの策定と保証**
   - 99.9%の可用性目標
   - 決済処理の応答時間保証

---

## 📚 参考資料

- [Stripe Webhook Events](https://stripe.com/docs/api/events)
- [Stripe Billing](https://stripe.com/docs/billing)
- [Idempotent Requests](https://stripe.com/docs/api/idempotent_requests)
- [Proration](https://stripe.com/docs/billing/subscriptions/prorations)
- [Stripe Test Clocks](https://stripe.com/docs/billing/testing/test-clocks)

---

## 🔄 更新履歴

- 2025-09-29: 初版作成（Webhook重複とproration_behavior問題を受けて）

---

*このドキュメントは継続的に更新してください*
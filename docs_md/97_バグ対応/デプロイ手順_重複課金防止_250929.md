# 🚀 重複課金防止機能 - 本番デプロイ手順

## 📅 実施日時
2025年9月29日

## 🎯 デプロイ対象
Stripe Webhook重複処理防止機能

---

## 1. 事前確認チェックリスト

### コード準備
- [x] `/supabase/functions/handle-stripe-webhook/index.ts` - 修正済み
- [x] `/supabase/migrations/20250929_add_stripe_events_table.sql` - 作成済み
- [x] `/.github/workflows/auto-sync-subscriptions.yml` - 無効化済み

### 環境確認
- [ ] Supabase Dashboard アクセス可能
- [ ] Stripe Dashboard アクセス可能
- [ ] 本番環境の環境変数確認

---

## 2. デプロイ手順

### Step 1: データベースマイグレーション（5分）

```bash
# 1. Supabase CLIでマイグレーション実行
supabase db push --db-url postgresql://postgres:[PASSWORD]@db.ulkuxysdohpgvgikqpoq.supabase.co:5432/postgres

# または Supabase Dashboard から実行
# SQL Editor → New Query → マイグレーションファイルの内容をペースト → Run
```

**確認SQL:**
```sql
-- テーブルが作成されたか確認
SELECT table_name, column_name, data_type
FROM information_schema.columns
WHERE table_name = 'stripe_events'
ORDER BY ordinal_position;

-- インデックスの確認
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'stripe_events';
```

### Step 2: Edge Function のデプロイ（10分）

```bash
# 1. Supabase Functions のデプロイ
supabase functions deploy handle-stripe-webhook \
  --project-ref ulkuxysdohpgvgikqpoq

# 2. 環境変数の確認
supabase secrets list --project-ref ulkuxysdohpgvgikqpoq
```

**重要:** デプロイ前に以下を確認
- STRIPE_SECRET_KEY が設定されている
- STRIPE_WEBHOOK_SECRET が正しい
- SUPABASE_SERVICE_ROLE_KEY が設定されている

### Step 3: GitHub Actions の確認（2分）

```bash
# 1. GitHub リポジトリで確認
git add .github/workflows/auto-sync-subscriptions.yml
git commit -m "fix: Disable auto-sync to prevent duplicate charges"
git push origin main

# 2. Actions タブで確認
# scheduled ワークフローが無効になっていることを確認
```

### Step 4: 本番環境での初期テスト（5分）

```bash
# Stripe CLI でテストイベントを送信
stripe trigger customer.subscription.updated \
  --api-key sk_live_xxx

# データベースで確認
```

```sql
-- イベントが記録されているか確認
SELECT * FROM stripe_events
ORDER BY processed_at DESC
LIMIT 5;
```

---

## 3. 段階的リリース戦略

### Phase 1: カナリアリリース（30分）

1. **10%のトラフィックで開始**
   - Supabase Edge Functions の設定で段階的有効化

2. **モニタリング項目**
   ```sql
   -- 重複イベントのチェック
   SELECT id, COUNT(*) as count
   FROM stripe_events
   WHERE processed_at >= NOW() - INTERVAL '30 minutes'
   GROUP BY id
   HAVING COUNT(*) > 1;
   ```

3. **ログ確認**
   - Supabase Dashboard → Functions → Logs
   - "Event already processed" のメッセージを確認

### Phase 2: 全体展開（1時間後）

1. **100%有効化**
2. **1時間のモニタリング継続**

---

## 4. デプロイ後の確認項目

### 即座に確認（5分以内）

```sql
-- 1. 新規イベントが処理されているか
SELECT event_type, COUNT(*) as count
FROM stripe_events
WHERE processed_at >= NOW() - INTERVAL '5 minutes'
GROUP BY event_type;

-- 2. エラーがないか
SELECT * FROM stripe_events
WHERE metadata->>'error' IS NOT NULL
ORDER BY processed_at DESC
LIMIT 10;
```

### 1時間後に確認

```sql
-- 3. 重複処理がないか
WITH duplicate_check AS (
  SELECT
    DATE_TRUNC('hour', processed_at) as hour,
    COUNT(DISTINCT id) as unique_events,
    COUNT(*) as total_processed
  FROM stripe_events
  WHERE processed_at >= NOW() - INTERVAL '1 hour'
  GROUP BY DATE_TRUNC('hour', processed_at)
)
SELECT * FROM duplicate_check
WHERE unique_events != total_processed;
```

### 24時間後に確認

```sql
-- 4. システム全体の健全性
SELECT
  DATE(processed_at) as date,
  event_type,
  COUNT(*) as event_count
FROM stripe_events
WHERE processed_at >= NOW() - INTERVAL '1 day'
GROUP BY DATE(processed_at), event_type
ORDER BY date DESC, event_count DESC;
```

---

## 5. ロールバック手順

### 緊急時のロールバック（5分以内）

```bash
# 1. 前バージョンのWebhookハンドラーに戻す
git revert HEAD
git push origin main

# 2. Supabase Functions を再デプロイ
supabase functions deploy handle-stripe-webhook \
  --project-ref ulkuxysdohpgvgikqpoq

# 3. 自動同期を再有効化（必要な場合）
# .github/workflows/auto-sync-subscriptions.yml のコメントを解除
```

---

## 6. コマンドまとめ

### デプロイコマンド一覧

```bash
# マイグレーション
supabase db push

# Functions デプロイ
supabase functions deploy handle-stripe-webhook

# ログ確認
supabase functions logs handle-stripe-webhook --tail

# 環境変数確認
supabase secrets list

# Git操作
git add .
git commit -m "fix: Add idempotency to prevent duplicate charges"
git push origin main
```

---

## 7. トラブルシューティング

### Q1: stripe_events テーブルが見つからない

```sql
-- マイグレーション再実行
\i /workspaces/real-estate-app/supabase/migrations/20250929_add_stripe_events_table.sql
```

### Q2: Webhookが502エラーを返す

```bash
# Functions のログを確認
supabase functions logs handle-stripe-webhook --tail

# 環境変数の再設定
supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_xxx
```

### Q3: "Event already processed" が出ない

```sql
-- stripe_events テーブルの権限確認
SELECT * FROM pg_policies
WHERE tablename = 'stripe_events';

-- 必要に応じて権限付与
GRANT ALL ON stripe_events TO service_role;
```

---

## 8. 成功基準

### デプロイ成功の判定

| 項目 | 基準 | 確認方法 |
|------|------|----------|
| テーブル作成 | stripe_eventsテーブルが存在 | SQL確認 |
| イベント記録 | 新規イベントが記録される | SELECT確認 |
| 重複防止 | 同一イベントIDが1件のみ | GROUP BY確認 |
| パフォーマンス | レスポンス < 1秒 | ログ確認 |
| エラー率 | < 0.1% | エラーログ確認 |

---

## 9. デプロイ後の連絡事項

### 関係者への通知

```
Subject: [完了] Stripe重複課金防止機能のデプロイ

デプロイ完了時刻: 2025-09-29 XX:XX
影響範囲: Stripe Webhook処理
ステータス: 正常稼働中

実装内容:
- stripe_eventsテーブルによるイデンポテンシー確保
- 重複イベントの自動スキップ
- 自動同期の一時停止

監視項目:
- 重複イベント: 0件
- エラー率: 0%
- 平均処理時間: XXms

問題があった場合は即座にご連絡ください。
```

---

## 10. 参考リンク

- [Supabase Dashboard](https://supabase.com/dashboard/project/ulkuxysdohpgvgikqpoq)
- [Stripe Dashboard](https://dashboard.stripe.com)
- [GitHub Actions](https://github.com/[your-repo]/actions)

---

*このドキュメントは実施後に結果を記録してください*
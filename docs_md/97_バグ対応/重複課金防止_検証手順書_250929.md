# 重複課金防止機能 - 検証手順書

## 📅 作成日
2025年9月29日

## 🎯 検証目的
Stripe Webhookの重複処理による多重課金を防止する機能が正しく動作することを確認する

---

## 1. 事前準備

### 必要なツール
- [ ] Stripe CLIのインストール
- [ ] Postmanまたはcurl
- [ ] Supabase Dashboard アクセス権
- [ ] Stripe Dashboard（テスト環境）アクセス権

### テストアカウント準備
```sql
-- テスト用ユーザーの作成
INSERT INTO auth.users (id, email, created_at)
VALUES ('test-user-001', 'test-duplicate@example.com', NOW())
ON CONFLICT DO NOTHING;
```

### 環境変数の確認
```bash
# .env.localの確認
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
VITE_STRIPE_PRICE_ID=price_xxx_test
```

---

## 2. ローカル環境での検証

### Step 1: Webhookハンドラーの起動
```bash
# Supabase Functions をローカルで起動
supabase functions serve handle-stripe-webhook --env-file .env.local

# 別ターミナルで
stripe listen --forward-to http://localhost:54321/functions/v1/handle-stripe-webhook
```

### Step 2: 重複イベント送信テスト

#### A. 同一イベントIDの3回送信
```bash
# テストスクリプトの作成
cat > test-duplicate-webhook.sh << 'EOF'
#!/bin/bash
EVENT_ID="evt_test_$(date +%s)"
TIMESTAMP=$(date +%s)

# 同じイベントを3回送信
for i in 1 2 3; do
  echo "Sending attempt $i with Event ID: $EVENT_ID"

  curl -X POST http://localhost:54321/functions/v1/handle-stripe-webhook \
    -H "Content-Type: application/json" \
    -H "stripe-signature: test_signature" \
    -d '{
      "id": "'$EVENT_ID'",
      "type": "customer.subscription.updated",
      "created": '$TIMESTAMP',
      "data": {
        "object": {
          "id": "sub_test_'$TIMESTAMP'",
          "customer": "cus_test_123",
          "status": "active",
          "current_period_start": '$TIMESTAMP',
          "current_period_end": '$(($TIMESTAMP + 2592000))',
          "items": {
            "data": [{
              "price": {
                "id": "price_test_123"
              }
            }]
          }
        }
      }
    }'

  sleep 2
done
EOF

chmod +x test-duplicate-webhook.sh
./test-duplicate-webhook.sh
```

#### B. 検証SQLクエリ
```sql
-- stripe_eventsテーブルの確認
SELECT
  id as event_id,
  event_type,
  processed_at,
  metadata
FROM stripe_events
WHERE id LIKE 'evt_test_%'
ORDER BY processed_at DESC;

-- Expected: 1件のみ表示される

-- subscriptionsテーブルの確認
SELECT
  stripe_subscription_id,
  status,
  updated_at
FROM subscriptions
WHERE stripe_subscription_id LIKE 'sub_test_%'
ORDER BY updated_at DESC;

-- Expected: 1件のみ表示される
```

### Step 3: ログ確認
```bash
# Supabase Functions のログを確認
supabase functions logs handle-stripe-webhook

# 以下のようなログが表示されるはず:
# "Event already processed: evt_test_xxx"
# "Duplicate event detected, skipping: evt_test_xxx"
```

---

## 3. Stripe Test環境での検証

### Step 1: Stripe Dashboardでテスト
1. Stripe Dashboard → Developers → Webhooks
2. 「Send test webhook」をクリック
3. Event type: `customer.subscription.updated`
4. 同じイベントを手動で3回送信

### Step 2: エラーシミュレーション
```javascript
// テスト用: Webhookハンドラーに一時的に追加
if (Math.random() < 0.5) {
  // 50%の確率でタイムアウトをシミュレート
  await new Promise(resolve => setTimeout(resolve, 35000));
}
```

### Step 3: Stripeの自動リトライ確認
- Webhookエンドポイントを一時的に停止
- Stripeがリトライを開始
- エンドポイントを再開
- 重複処理が防げているか確認

---

## 4. 本番環境デプロイ前の最終確認

### チェックリスト

#### A. データベース
- [ ] stripe_eventsテーブルが作成されている
- [ ] インデックスが正しく設定されている
- [ ] RLSポリシーが適用されている

#### B. コード確認
- [ ] イベントID重複チェックが実装されている
- [ ] エラーハンドリングが適切
- [ ] ログ出力が十分

#### C. パフォーマンステスト
```bash
# 負荷テスト（100イベントを並列送信）
for i in {1..100}; do
  (stripe trigger customer.subscription.updated &)
done
wait

# データベースで重複がないか確認
```

---

## 5. 本番環境での検証

### Step 1: カナリアデプロイ
1. 少数のユーザーのみ新バージョンに切り替え
2. 24時間モニタリング
3. 問題なければ全体展開

### Step 2: モニタリング項目
```sql
-- 1時間ごとに実行
WITH duplicate_check AS (
  SELECT
    DATE_TRUNC('hour', processed_at) as hour,
    COUNT(DISTINCT id) as unique_events,
    COUNT(*) as total_events
  FROM stripe_events
  WHERE processed_at >= NOW() - INTERVAL '1 hour'
  GROUP BY DATE_TRUNC('hour', processed_at)
)
SELECT * FROM duplicate_check
WHERE unique_events != total_events;

-- Expected: 0 rows (重複なし)
```

### Step 3: アラート設定
```sql
-- 重複検知クエリ（Cronで実行）
SELECT
  'ALERT: Duplicate payment detected' as message,
  u.email,
  COUNT(*) as duplicate_count
FROM subscriptions s
JOIN auth.users u ON s.user_id = u.id
WHERE DATE(s.updated_at) = CURRENT_DATE
GROUP BY u.email, DATE(s.updated_at)
HAVING COUNT(*) > 1;
```

---

## 6. ロールバック計画

### 問題発生時の対応
1. **即座にロールバック**
   ```bash
   git revert HEAD
   git push origin main
   ```

2. **影響調査**
   ```sql
   -- 影響を受けたユーザーの特定
   SELECT * FROM stripe_events
   WHERE processed_at >= 'deployment_time'
   ORDER BY processed_at DESC;
   ```

3. **返金処理**
   - Stripe Dashboardから手動返金
   - 影響ユーザーへの連絡

---

## 7. 検証結果記録テンプレート

### 検証実施記録
```markdown
## 検証日時: 2025-09-XX XX:XX

### 実施者: [名前]

### 検証環境
- [ ] ローカル
- [ ] ステージング
- [ ] 本番

### テスト結果
| テスト項目 | 期待値 | 実際の結果 | 合否 |
|-----------|--------|------------|------|
| 同一イベント3回送信 | 1回のみ処理 | | |
| タイムアウト後のリトライ | 重複なし | | |
| 並列100イベント | 全て正常処理 | | |
| エラーログ出力 | 適切に記録 | | |

### 発見された問題
- なし / あり（詳細：）

### 備考
```

---

## 8. よくある問題と対処法

### Q1: stripe_eventsテーブルにデータが入らない
```sql
-- RLSの確認
SELECT * FROM pg_policies WHERE tablename = 'stripe_events';

-- 権限の確認
GRANT ALL ON stripe_events TO service_role;
```

### Q2: "Event already processed"が出ない
```typescript
// コード確認ポイント
console.log('Checking for existing event:', event.id);
const { data: existingEvent } = await supabase
  .from('stripe_events')
  .select('id')
  .eq('id', event.id)
  .single();
console.log('Existing event result:', existingEvent);
```

### Q3: パフォーマンスが遅い
```sql
-- インデックスの確認
\d stripe_events

-- 必要に応じて追加
CREATE INDEX CONCURRENTLY idx_stripe_events_created_at
ON stripe_events(processed_at);
```

---

## 9. 成功基準

### 必須項目
- ✅ 同一イベントIDが複数回処理されない
- ✅ データベースに重複レコードが作成されない
- ✅ ユーザーが複数回課金されない
- ✅ 正常な処理には影響しない
- ✅ パフォーマンス劣化がない（処理時間 < 1秒）

### 推奨項目
- ✅ エラーログが適切に記録される
- ✅ モニタリングアラートが機能する
- ✅ ロールバックが30分以内に可能

---

## 10. 参考資料

- [Stripe Webhook Events](https://stripe.com/docs/api/events)
- [Testing Webhooks with Stripe CLI](https://stripe.com/docs/stripe-cli/webhooks)
- [Idempotent Requests](https://stripe.com/docs/api/idempotent_requests)

---

*この検証手順書は随時更新してください*
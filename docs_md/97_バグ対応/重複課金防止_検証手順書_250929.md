# é‡è¤‡èª²é‡‘é˜²æ­¢æ©Ÿèƒ½ - æ¤œè¨¼æ‰‹é †æ›¸

## ğŸ“… ä½œæˆæ—¥
2025å¹´9æœˆ29æ—¥

## ğŸ¯ æ¤œè¨¼ç›®çš„
Stripe Webhookã®é‡è¤‡å‡¦ç†ã«ã‚ˆã‚‹å¤šé‡èª²é‡‘ã‚’é˜²æ­¢ã™ã‚‹æ©Ÿèƒ½ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹

---

## 1. äº‹å‰æº–å‚™

### å¿…è¦ãªãƒ„ãƒ¼ãƒ«
- [ ] Stripe CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] Postmanã¾ãŸã¯curl
- [ ] Supabase Dashboard ã‚¢ã‚¯ã‚»ã‚¹æ¨©
- [ ] Stripe Dashboardï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒï¼‰ã‚¢ã‚¯ã‚»ã‚¹æ¨©

### ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆæº–å‚™
```sql
-- ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
INSERT INTO auth.users (id, email, created_at)
VALUES ('test-user-001', 'test-duplicate@example.com', NOW())
ON CONFLICT DO NOTHING;
```

### ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
```bash
# .env.localã®ç¢ºèª
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
VITE_STRIPE_PRICE_ID=price_xxx_test
```

---

## 2. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®æ¤œè¨¼

### Step 1: Webhookãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®èµ·å‹•
```bash
# Supabase Functions ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•
supabase functions serve handle-stripe-webhook --env-file .env.local

# åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§
stripe listen --forward-to http://localhost:54321/functions/v1/handle-stripe-webhook
```

### Step 2: é‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡ãƒ†ã‚¹ãƒˆ

#### A. åŒä¸€ã‚¤ãƒ™ãƒ³ãƒˆIDã®3å›é€ä¿¡
```bash
# ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ
cat > test-duplicate-webhook.sh << 'EOF'
#!/bin/bash
EVENT_ID="evt_test_$(date +%s)"
TIMESTAMP=$(date +%s)

# åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’3å›é€ä¿¡
for i in 1 2 3; do
  echo "Sending attempt $i with Event ID: $EVENT_ID"

  curl -X POST http://localhost:54321/functions/v1/handle-stripe-webhook \
    -H "Content-Type: application/json" \
    -H "stripe-signature: test_signature" \
    -d '{
      "id": "'$EVENT_ID'",
      "type": "customer.subscription.updated",
      "created": '$TIMESTAMP',
      "data": {
        "object": {
          "id": "sub_test_'$TIMESTAMP'",
          "customer": "cus_test_123",
          "status": "active",
          "current_period_start": '$TIMESTAMP',
          "current_period_end": '$(($TIMESTAMP + 2592000))',
          "items": {
            "data": [{
              "price": {
                "id": "price_test_123"
              }
            }]
          }
        }
      }
    }'

  sleep 2
done
EOF

chmod +x test-duplicate-webhook.sh
./test-duplicate-webhook.sh
```

#### B. æ¤œè¨¼SQLã‚¯ã‚¨ãƒª
```sql
-- stripe_eventsãƒ†ãƒ¼ãƒ–ãƒ«ã®ç¢ºèª
SELECT
  id as event_id,
  event_type,
  processed_at,
  metadata
FROM stripe_events
WHERE id LIKE 'evt_test_%'
ORDER BY processed_at DESC;

-- Expected: 1ä»¶ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹

-- subscriptionsãƒ†ãƒ¼ãƒ–ãƒ«ã®ç¢ºèª
SELECT
  stripe_subscription_id,
  status,
  updated_at
FROM subscriptions
WHERE stripe_subscription_id LIKE 'sub_test_%'
ORDER BY updated_at DESC;

-- Expected: 1ä»¶ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹
```

### Step 3: ãƒ­ã‚°ç¢ºèª
```bash
# Supabase Functions ã®ãƒ­ã‚°ã‚’ç¢ºèª
supabase functions logs handle-stripe-webhook

# ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãš:
# "Event already processed: evt_test_xxx"
# "Duplicate event detected, skipping: evt_test_xxx"
```

---

## 3. Stripe Testç’°å¢ƒã§ã®æ¤œè¨¼

### Step 1: Stripe Dashboardã§ãƒ†ã‚¹ãƒˆ
1. Stripe Dashboard â†’ Developers â†’ Webhooks
2. ã€ŒSend test webhookã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. Event type: `customer.subscription.updated`
4. åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‰‹å‹•ã§3å›é€ä¿¡

### Step 2: ã‚¨ãƒ©ãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```javascript
// ãƒ†ã‚¹ãƒˆç”¨: Webhookãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«ä¸€æ™‚çš„ã«è¿½åŠ 
if (Math.random() < 0.5) {
  // 50%ã®ç¢ºç‡ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
  await new Promise(resolve => setTimeout(resolve, 35000));
}
```

### Step 3: Stripeã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ç¢ºèª
- Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä¸€æ™‚çš„ã«åœæ­¢
- StripeãŒãƒªãƒˆãƒ©ã‚¤ã‚’é–‹å§‹
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å†é–‹
- é‡è¤‡å‡¦ç†ãŒé˜²ã’ã¦ã„ã‚‹ã‹ç¢ºèª

---

## 4. æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚ç¢ºèª

### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### A. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- [ ] stripe_eventsãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] RLSãƒãƒªã‚·ãƒ¼ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹

#### B. ã‚³ãƒ¼ãƒ‰ç¢ºèª
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆIDé‡è¤‡ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡
- [ ] ãƒ­ã‚°å‡ºåŠ›ãŒååˆ†

#### C. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
```bash
# è² è·ãƒ†ã‚¹ãƒˆï¼ˆ100ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸¦åˆ—é€ä¿¡ï¼‰
for i in {1..100}; do
  (stripe trigger customer.subscription.updated &)
done
wait

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§é‡è¤‡ãŒãªã„ã‹ç¢ºèª
```

---

## 5. æœ¬ç•ªç’°å¢ƒã§ã®æ¤œè¨¼

### Step 1: ã‚«ãƒŠãƒªã‚¢ãƒ‡ãƒ—ãƒ­ã‚¤
1. å°‘æ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ
2. 24æ™‚é–“ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
3. å•é¡Œãªã‘ã‚Œã°å…¨ä½“å±•é–‹

### Step 2: ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°é …ç›®
```sql
-- 1æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ
WITH duplicate_check AS (
  SELECT
    DATE_TRUNC('hour', processed_at) as hour,
    COUNT(DISTINCT id) as unique_events,
    COUNT(*) as total_events
  FROM stripe_events
  WHERE processed_at >= NOW() - INTERVAL '1 hour'
  GROUP BY DATE_TRUNC('hour', processed_at)
)
SELECT * FROM duplicate_check
WHERE unique_events != total_events;

-- Expected: 0 rows (é‡è¤‡ãªã—)
```

### Step 3: ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
```sql
-- é‡è¤‡æ¤œçŸ¥ã‚¯ã‚¨ãƒªï¼ˆCronã§å®Ÿè¡Œï¼‰
SELECT
  'ALERT: Duplicate payment detected' as message,
  u.email,
  COUNT(*) as duplicate_count
FROM subscriptions s
JOIN auth.users u ON s.user_id = u.id
WHERE DATE(s.updated_at) = CURRENT_DATE
GROUP BY u.email, DATE(s.updated_at)
HAVING COUNT(*) > 1;
```

---

## 6. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

### å•é¡Œç™ºç”Ÿæ™‚ã®å¯¾å¿œ
1. **å³åº§ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**
   ```bash
   git revert HEAD
   git push origin main
   ```

2. **å½±éŸ¿èª¿æŸ»**
   ```sql
   -- å½±éŸ¿ã‚’å—ã‘ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰¹å®š
   SELECT * FROM stripe_events
   WHERE processed_at >= 'deployment_time'
   ORDER BY processed_at DESC;
   ```

3. **è¿”é‡‘å‡¦ç†**
   - Stripe Dashboardã‹ã‚‰æ‰‹å‹•è¿”é‡‘
   - å½±éŸ¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€£çµ¡

---

## 7. æ¤œè¨¼çµæœè¨˜éŒ²ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### æ¤œè¨¼å®Ÿæ–½è¨˜éŒ²
```markdown
## æ¤œè¨¼æ—¥æ™‚: 2025-09-XX XX:XX

### å®Ÿæ–½è€…: [åå‰]

### æ¤œè¨¼ç’°å¢ƒ
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
- [ ] æœ¬ç•ª

### ãƒ†ã‚¹ãƒˆçµæœ
| ãƒ†ã‚¹ãƒˆé …ç›® | æœŸå¾…å€¤ | å®Ÿéš›ã®çµæœ | åˆå¦ |
|-----------|--------|------------|------|
| åŒä¸€ã‚¤ãƒ™ãƒ³ãƒˆ3å›é€ä¿¡ | 1å›ã®ã¿å‡¦ç† | | |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã®ãƒªãƒˆãƒ©ã‚¤ | é‡è¤‡ãªã— | | |
| ä¸¦åˆ—100ã‚¤ãƒ™ãƒ³ãƒˆ | å…¨ã¦æ­£å¸¸å‡¦ç† | | |
| ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ› | é©åˆ‡ã«è¨˜éŒ² | | |

### ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œ
- ãªã— / ã‚ã‚Šï¼ˆè©³ç´°ï¼šï¼‰

### å‚™è€ƒ
```

---

## 8. ã‚ˆãã‚ã‚‹å•é¡Œã¨å¯¾å‡¦æ³•

### Q1: stripe_eventsãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚‰ãªã„
```sql
-- RLSã®ç¢ºèª
SELECT * FROM pg_policies WHERE tablename = 'stripe_events';

-- æ¨©é™ã®ç¢ºèª
GRANT ALL ON stripe_events TO service_role;
```

### Q2: "Event already processed"ãŒå‡ºãªã„
```typescript
// ã‚³ãƒ¼ãƒ‰ç¢ºèªãƒã‚¤ãƒ³ãƒˆ
console.log('Checking for existing event:', event.id);
const { data: existingEvent } = await supabase
  .from('stripe_events')
  .select('id')
  .eq('id', event.id)
  .single();
console.log('Existing event result:', existingEvent);
```

### Q3: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒé…ã„
```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç¢ºèª
\d stripe_events

-- å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
CREATE INDEX CONCURRENTLY idx_stripe_events_created_at
ON stripe_events(processed_at);
```

---

## 9. æˆåŠŸåŸºæº–

### å¿…é ˆé …ç›®
- âœ… åŒä¸€ã‚¤ãƒ™ãƒ³ãƒˆIDãŒè¤‡æ•°å›å‡¦ç†ã•ã‚Œãªã„
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é‡è¤‡ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œãªã„
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°å›èª²é‡‘ã•ã‚Œãªã„
- âœ… æ­£å¸¸ãªå‡¦ç†ã«ã¯å½±éŸ¿ã—ãªã„
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–ãŒãªã„ï¼ˆå‡¦ç†æ™‚é–“ < 1ç§’ï¼‰

### æ¨å¥¨é …ç›®
- âœ… ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒé©åˆ‡ã«è¨˜éŒ²ã•ã‚Œã‚‹
- âœ… ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¢ãƒ©ãƒ¼ãƒˆãŒæ©Ÿèƒ½ã™ã‚‹
- âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒ30åˆ†ä»¥å†…ã«å¯èƒ½

---

## 10. å‚è€ƒè³‡æ–™

- [Stripe Webhook Events](https://stripe.com/docs/api/events)
- [Testing Webhooks with Stripe CLI](https://stripe.com/docs/stripe-cli/webhooks)
- [Idempotent Requests](https://stripe.com/docs/api/idempotent_requests)

---

*ã“ã®æ¤œè¨¼æ‰‹é †æ›¸ã¯éšæ™‚æ›´æ–°ã—ã¦ãã ã•ã„*
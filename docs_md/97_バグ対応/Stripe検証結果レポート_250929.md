# 📊 Stripe決済システム検証結果レポート

## 📅 検証日時
2025年9月29日

## 🎯 検証目的
Stripeシナリオパターン網羅表に基づく現在の実装状況の確認と問題点の洗い出し

---

## 🔍 検証結果サマリー

### ✅ 対策済み（3項目）

| No | 項目 | 対策内容 | 実装日 |
|----|------|---------|--------|
| 3-3 | 解約キャンセル時の追加課金 | `proration_behavior: 'none'`追加 | 2025-09-29 |
| 5-1〜5-7 | Webhook重複処理 | stripe_eventsテーブルによるイデンポテンシー | 2025-09-29 |
| 7-2,7-3 | 同期システム競合 | GitHub Actions/pg_cron無効化 | 2025-09-29 |

### ⚠️ 部分的対策（2項目）

| No | 項目 | 現在の実装 | 問題点 |
|----|------|-----------|--------|
| 1-3 | 無料→プレミアムアップグレード | 既存サブスクチェック有り | 解約予定中の場合、2重契約可能 |
| 1-4 | 支払い失敗後の再試行 | status更新のみ | リトライ戦略なし、Stripe依存 |

### ❌ 未実装（5項目）

| No | 項目 | リスクレベル | 推奨対策 | 備考 |
|----|------|------------|---------|------|
| 6-1 | 同時実行制御 | 🔴 高 | トランザクション/ロック機構必要 | 現在も発生リスクあり |
| 6-4 | DBトランザクション失敗 | 🔴 高 | ロールバック戦略必要 | 現在も発生リスクあり |
| 3-2 | 即時解約 | 🟢 低 | 返金は手動対応中 | 機能追加は任意 |
| 2-3 | プラン変更機能 | 🟢 将来 | 現在は単一プラン（¥2,980）のみ | 複数プラン導入時に実装 |
| 4-3 | クレジット管理 | 🟢 将来 | 将来的な拡張時に検討 | 現時点では不要 |

---

## 📝 詳細検証結果

### 1. サブスクリプション作成パターン

#### No.1-3: 無料→プレミアムアップグレード
**ファイル**: `/supabase/functions/create-checkout-session/index.ts`

**現在の実装**:
```typescript
// 67-77行目
const { data: existingSubscription } = await supabase
  .from('subscriptions')
  .select('*')
  .eq('user_id', userId)
  .eq('status', 'active')
  .single()

if (existingSubscription && !existingSubscription.cancel_at_period_end) {
  throw new Error('すでにプレミアムプランに登録されています')
}
```

**問題点**:
- 解約予定（`cancel_at_period_end = true`）の場合、新規作成可能
- 2つのアクティブサブスクリプションが並存するリスク

**推奨修正**:
```typescript
if (existingSubscription) {
  if (existingSubscription.cancel_at_period_end) {
    // 解約予定の場合は、解約をキャンセルする方が適切
    throw new Error('解約予定のプランがあります。先に解約をキャンセルしてください')
  } else {
    throw new Error('すでにプレミアムプランに登録されています')
  }
}
```

---

### 2. 支払い処理パターン

#### No.1-4: 支払い失敗後の再試行
**ファイル**: `/supabase/functions/handle-stripe-webhook/index.ts`

**現在の実装**:
```typescript
// 279-291行目
case 'invoice.payment_failed': {
  const invoice: any = event.data.object;
  if (invoice.subscription) {
    const { error } = await supabase
      .from('subscriptions')
      .update({
        status: 'past_due',
        updated_at: new Date().toISOString(),
      })
      .eq('stripe_subscription_id', String(invoice.subscription));
  }
}
```

**問題点**:
- ユーザーへの通知なし
- リトライ回数の管理なし
- 最終的な強制解約の処理なし

**推奨追加実装**:
```typescript
// ユーザーへの通知
await sendPaymentFailedEmail(userId, invoice);

// リトライ回数の記録
await supabase
  .from('payment_failures')
  .insert({
    user_id: userId,
    invoice_id: invoice.id,
    attempt_count: invoice.attempt_count,
    next_payment_attempt: invoice.next_payment_attempt
  });
```

---

### 3. 同時実行制御

#### No.6-1: 複数デバイスからの同時操作
**現在の状況**: 完全に未対策

**リスクシナリオ**:
1. デバイスA: 解約処理開始
2. デバイスB: 同時に解約処理開始
3. 両方とも成功判定 → データ不整合

**推奨実装案**:

```typescript
// Option 1: データベースレベルのロック
await supabase.rpc('acquire_subscription_lock', { user_id: userId });

try {
  // 処理実行
} finally {
  await supabase.rpc('release_subscription_lock', { user_id: userId });
}

// Option 2: 楽観的ロック with version
const { data, error } = await supabase
  .from('subscriptions')
  .update({ ...updateData, version: version + 1 })
  .eq('user_id', userId)
  .eq('version', version);

if (error) throw new Error('他の操作と競合しました。再試行してください');
```

---

## 🚨 優先対応推奨事項

### 🔴 高優先度（1週間以内）

1. **同時実行制御の実装**
   - 影響: データ不整合、重複課金
   - 対策: トランザクション制御またはロック機構

2. **全Stripe API呼び出しに`proration_behavior`明示**
   ```typescript
   // すべてのsubscription.updateに追加
   proration_behavior: 'none' // or 'create_prorations'
   ```

3. **DBトランザクション失敗時の処理**
   - Stripe API成功後のDB更新失敗への対処
   - ロールバック戦略の実装

### 🟡 中優先度（1ヶ月以内）

4. **支払い失敗時の通知システム**
   - メール通知
   - アプリ内通知
   - リトライスケジュール表示

5. **解約予定中の新規作成防止**
   - create-checkout-sessionの条件修正
   - ユーザーへの適切なガイダンス

### 🟢 低優先度（計画的に）

6. **即時解約機能**
   - 返金処理は手動対応で運用中
   - システム化は必要に応じて検討

7. **プラン変更機能**
   - 現在は単一プラン（¥2,980/月）のみ
   - 複数プラン導入時に実装
   - プロレーション設定の明確化

---

## 📊 リスク評価マトリックス

| リスク項目 | 発生可能性 | 影響度 | 総合評価 | 対策優先度 | 現在の状況 |
|-----------|-----------|--------|---------|-----------|-----------|
| 同時操作によるデータ不整合 | 高 | 高 | 🔴 Critical | 1 | 未対策 |
| DBトランザクション失敗 | 低 | 高 | 🔴 Critical | 2 | 未対策 |
| 解約キャンセル時の追加課金 | 低 | 高 | ✅ 解決済 | - | 2025-09-29対応済 |
| Webhook重複処理 | 中 | 高 | ✅ 解決済 | - | 2025-09-29対応済 |
| 支払い失敗の未通知 | 中 | 中 | 🟡 Medium | 3 | 未対策 |
| 解約予定中の新規作成 | 低 | 中 | 🟡 Medium | 4 | 未対策 |
| プラン変更時の課金ミス | - | - | 🟢 N/A | - | 単一プランのため対象外 |

---

## 🎯 アクションプラン

### 今週のタスク
- [ ] 同時実行制御の設計と実装
- [ ] proration_behavior の全API適用
- [ ] エラーハンドリングの強化

### 今月のタスク
- [ ] 支払い失敗通知システム
- [ ] 解約フローの改善
- [ ] 包括的なE2Eテスト作成

### 四半期のタスク
- [ ] 複数プラン対応準備
- [ ] 決済システムの抽象化
- [ ] 監視ダッシュボード構築

---

## 📚 参考資料

- [Stripe決済シナリオパターン網羅表](/docs_md/97_バグ対応/Stripe決済シナリオパターン網羅表_250929.md)
- [stripe_更新決済が何度もされる_250929_1.md](/docs_md/97_バグ対応/stripe_更新決済が何度もされる_250929_1.md)
- [resume_subscription重複課金_250929_2.md](/docs_md/97_バグ対応/resume_subscription重複課金_250929_2.md)

---

*最終更新: 2025-09-29*
# ベーシックプラン30回制限 - 仕様書と影響範囲

## 概要
ベーシックプランの利用制限を「無制限」から「月30回」に変更する仕様変更です。
シミュレーター機能とAI市場分析機能の利用回数を合計して制限します。

## 現在の仕様 vs 新仕様

### 現在の仕様
- **無料プラン**: 月5回制限
- **ベーシックプラン**: 無制限利用

### 新仕様
- **無料プラン**: 月5回制限（変更なし）
- **ベーシックプラン**: 月30回制限（シミュレーター + AI市場分析の合計）

## 制限対象機能

### 対象機能
1. **シミュレーター機能** (`/simulator`)
   - 不動産投資シミュレーション実行時
   - `featureType: 'simulator'`

2. **AI市場分析機能** (`/market-analysis`)
   - AI市場分析実行時
   - `featureType: 'market_analysis'`

### 共有プール方式
- 両機能の利用回数を合計して30回まで
- 例: シミュレーター15回 + AI市場分析15回 = 合計30回で制限到達

## 影響範囲詳細

### 1. フロントエンド修正ファイル

#### `bolt_front/src/utils/usageLimit.ts`
**修正箇所:**
- **37-49行目**: `checkUsageLimit()` 関数のベーシック会員処理
  ```typescript
  // 現在: 無制限で return
  if (subscription?.status === 'active') {
    return { canUse: true, limit: -1, isSubscribed: true, ... };
  }

  // 変更後: 30回制限チェック追加
  if (subscription?.status === 'active') {
    // ベーシック会員も使用状況をチェック（30回制限）
  }
  ```

- **73行目**: 制限回数の調整
  ```typescript
  // 現在: canUse: usage.current_count < 5  （無料プラン用）
  // 変更後: プランに応じた制限値を使用
  ```

#### `bolt_front/src/hooks/useUsageStatus.ts`
**修正箇所:**
- **63-67行目**: `executeWithLimit()` 関数
  ```typescript
  // 現在: ベーシック会員は制限なし
  if (usage.isSubscribed) {
    await callback();
    return true;
  }

  // 変更後: ベーシック会員も制限チェック実行
  ```

- **43行目**: エラー時のデフォルト値
  ```typescript
  // 現在: limit: 5
  // 変更後: limit: 30 （ベーシック会員用）
  ```

#### `bolt_front/src/hooks/useUsageStatus.ts`（表示関連）
**修正箇所:**
- **124行目**: `getUsageStatusMessage()` 関数
  ```typescript
  // 現在: 'ベーシック会員 - 無制限利用可能'
  // 変更後: '月間利用回数: X/30回'
  ```

### 2. コンポーネント修正

#### ヘッダー表示（UsageStatusBar.tsx）
**変更内容:**
- ベーシック会員の表示文言変更
- 使用回数の進捗表示追加

**表示例:**
```
現在: 「ベーシック会員 - 無制限利用可能」
変更後: 「月間利用回数: 15/30回」
制限到達時: 「月間利用枠（30回）を使い切りました」
```

### 3. 動作フロー

#### 機能実行時の処理順序
1. **事前チェック**: `executeWithLimit()` で残り回数確認
2. **制限判定**:
   - 無料プラン: 5回制限
   - ベーシックプラン: 30回制限
3. **機能実行**: 制限内の場合のみ実行
4. **カウント更新**: 使用回数をインクリメント
5. **表示更新**: ヘッダーの使用状況を更新

#### データベース操作
**テーブル（変更不要）:**
- `user_usage`: 使用回数管理
- `usage_history`: 機能別利用履歴
- `subscriptions`: サブスクリプション状態

**カウント方式:**
- シミュレーターと市場分析で同じ `usage_count` を共有
- `feature_type` で機能を区別して履歴記録

## 実装ステップ

### Step 1: 制限ロジック修正
- [ ] `usageLimit.ts` の制限チェック関数修正
- [ ] ベーシックプラン用の制限値（30回）設定

### Step 2: フック修正
- [ ] `useUsageStatus.ts` の実行制限ロジック修正
- [ ] 表示メッセージの変更

### Step 3: UI表示更新
- [ ] ヘッダー部分の使用状況表示修正
- [ ] 制限到達時のメッセージ変更

### Step 4: テスト
- [ ] 無料プラン（5回制限）の動作確認
- [ ] ベーシックプラン（30回制限）の動作確認
- [ ] 共有プール動作の確認

## 注意事項

### 既存ユーザーへの影響
- 現在のベーシック会員は即座に30回制限が適用される
- 使用履歴は保持されるため、既に30回を超えている場合は制限状態になる

### リセット処理
- 月次リセットは既存の仕組みを使用
- `check_and_reset_usage` 関数で自動リセット実行

### エラーハンドリング
- API エラー時はサービス継続性を優先
- デフォルト値でサービス利用可能状態を維持
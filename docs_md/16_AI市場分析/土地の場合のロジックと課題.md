# 土地検索の課題管理表

## 現状の課題一覧

| No | 課題内容 | 原因 | 対応状況 |
|----|---------|------|----------|
| 1 | マンションが入っている | 土地(propertyType='01')で検索しているのに、マンション物件が結果に含まれている | 🟡 一部対応 |
| 2 | ML分析の詳細が表示されない | 延床面積の計算が土地に対応していないため | 🔴 未対応 |
| 3 | 類似物件の取引事例が表示されない | フィルタリング条件が建物用のため、土地の場合にマッチしない | 🟢 対応済（1652-1663行目修正） |
| 4 | 「延べ床と価格」の表示 | 土地の場合は「土地面積と価格」に変更が必要 | 🟢 対応済 |
| 5 | 「延床面積別価格分布」の表示 | 土地の場合は「土地面積別価格分布」に変更が必要 | 🟢 対応済 |
| 6 | 「建築年別価格分布」の表示 | 土地の場合は非表示にする必要がある | 🟢 対応済 |
| 7 | 「建築年別価格分布（ヒートマップ）」の表示 | 土地の場合は非表示にする必要がある | 🟢 対応済 |

---

# 修正方針とロジック

## 実装タスク管理表

| No | タスク内容 | 対象ファイル | 優先度 | 対応状況 | 備考 |
|----|-----------|-------------|--------|----------|------|
| T1 | isLandフラグの追加 | MarketAnalysis.tsx:50 | 最高 | ✅ 実装済 | `const isLand = selectedPropertyType === '01'` |
| T2 | getArea関数の修正 | MarketAnalysis.tsx:44-51 | 最高 | ✅ 実装済 | 土地の場合は土地面積を取得 |
| T3 | 入力フォームのラベル変更 | MarketAnalysis.tsx:1142 | 最高 | ✅ 実装済 | 「延床面積」→「土地面積」 |
| T4 | 築年数入力フィールドの非表示 | MarketAnalysis.tsx:1171-1189 | 最高 | ✅ 実装済 | 土地の場合は非表示 |
| T5 | APIパラメータの条件分岐 | MarketAnalysis.tsx:検索処理 | 高 | 🔴 未実装 | area_min/max vs building_area_min/max |
| T6 | フィルタリングロジックの修正 | MarketAnalysis.tsx:270-304 | 高 | ✅ 実装済 | 土地は築年数フィルタをスキップ |
| T7 | 価格分布タイトルの変更 | MarketAnalysis.tsx:1448,1316 | 中 | ✅ 実装済 | 土地用のタイトル表示 |
| T8 | テーブルヘッダーの変更 | MarketAnalysis.tsx:1641-1643,1687-1689 | 中 | ✅ 実装済 | 土地面積/延床面積の切り替え |
| T9 | グラフタイトルの変更 | MarketAnalysis.tsx:1707,1842 | 中 | ✅ 実装済 | 「土地面積と価格」等 |
| T10 | 築年数グラフの非表示 | MarketAnalysis.tsx:1924,2036 | 中 | ✅ 実装済 | 土地の場合は非表示 |
| T11 | ML分析の土地対応 | MarketAnalysis.tsx:ML分析 | 低 | 🔴 未実装 | 土地用の特徴量設定 |
| T12 | Render APIのパラメータ追加 | backend/app.py | 低 | 🔴 未実装 | area_min/max等の追加 |

---

## 1. 基本方針
**戸建(02)とマンション(07)の動作は一切変更しない。土地(01)の場合のみ特別処理を追加する。**

## 2. 実装ロジック（詳細）

### 2.1 土地判定フラグの追加（MarketAnalysis.tsx:41行目付近）
```typescript
// 物件タイプの判定（土地の場合のみ特別処理）
const isLand = selectedPropertyType === '01';
```

### 2.2 ヘルパー関数の修正（MarketAnalysis.tsx:28-34行目）

#### getArea関数の修正
```typescript
const getArea = (item: any): number => {
  // 土地の場合のみ土地面積を取得、それ以外は従来通り
  if (selectedPropertyType === '01') {
    return item['土地面積（㎡）'] || item.land_area || item['土地面積'] || 0;
  }
  // 戸建・マンションは従来通り延床面積を取得
  return item['延べ床面積（㎡）'] || item.building_area || item.面積 || item.延床面積 || item.area || 0;
};
```

#### getBuildYear関数はそのまま（土地の場合は使用しない）
```typescript
const getBuildYear = (item: any): number => {
  return parseInt(item['建築年'] || item.build_year || item.建築年 || item.building_year || '0');
};
```

### 2.3 入力フォームの条件分岐（MarketAnalysis.tsx:1130-1160行目付近）

#### 面積入力フィールドのラベル変更
```typescript
<label className="block text-sm font-medium text-gray-700 mb-1">
  <Ruler className="inline-block w-4 h-4 mr-1" />
  {isLand ? '希望土地面積' : '希望延床面積'} (㎡) <span className="text-red-500">*</span>
</label>
```

#### 築年数入力フィールドの条件表示
```typescript
{!isLand && (
  <div>
    <label className="block text-sm font-medium text-gray-700 mb-1">
      <Calendar className="inline-block w-4 h-4 mr-1" />
      建築年 <span className="text-red-500">*</span>
    </label>
    <input
      type="number"
      className="w-full px-3 py-2 border border-gray-300 rounded-md"
      value={targetYear}
      onChange={(e) => setTargetYear(Number(e.target.value))}
      min={1950}
      max={new Date().getFullYear()}
      placeholder="例: 2015"
    />
  </div>
)}
```

### 2.4 APIパラメータの修正（検索実行時）

```typescript
// handleSearch関数内でAPIリクエスト時のパラメータ設定
const searchParams = {
  prefecture: selectedPrefecture,
  city: selectedCity,
  district: selectedDistrict,
  property_type: selectedPropertyType,
  // 土地の場合はarea_min/max、建物の場合はbuilding_area_min/max
  ...(isLand ? {
    area_min: targetArea - areaTolerance,
    area_max: targetArea + areaTolerance,
    // 築年数パラメータは含めない
  } : {
    building_area_min: targetArea - areaTolerance,
    building_area_max: targetArea + areaTolerance,
    build_year_min: targetYear - yearTolerance,
    build_year_max: targetYear + yearTolerance,
  })
};
```

### 2.5 フィルタリングロジックの修正（MarketAnalysis.tsx:262-275行目付近）

```typescript
// 面積フィルタ
if (targetArea > 0 && allData.length > 0) {
  const areaFiltered = allData.filter(item => {
    const area = getArea(item); // getAreaが既に土地/建物を判定
    return area >= targetArea - areaTolerance && area <= targetArea + areaTolerance;
  });

  // 築年数フィルタ（土地の場合はスキップ）
  if (!isLand && targetYear > 0) {
    const yearFiltered = areaFiltered.filter(item => {
      const buildYear = getBuildYear(item);
      return buildYear >= targetYear - yearTolerance && buildYear <= targetYear + yearTolerance;
    });
    setMarketData(yearFiltered);
  } else {
    setMarketData(areaFiltered);
  }
}
```

### 2.6 表示ラベルの動的変更

#### 価格分布タイトル（MarketAnalysis.tsx:1429行目付近）
```typescript
{isLand ?
  `土地価格分布 | 土地面積${targetArea}±${areaTolerance}㎡` :
  `${selectedPropertyType === '02' ? '戸建て' : 'マンション'}価格分布 | 延床面積${targetArea}±${areaTolerance}㎡・築年数${targetYear}±${yearTolerance}年`
}
```

#### テーブルヘッダー（MarketAnalysis.tsx:1618-1620行目付近）
```typescript
<th className="px-4 py-3 text-left text-sm font-bold text-gray-900">
  {isLand ? '土地面積(㎡)' : '延床面積(㎡)'}
</th>
{!isLand && (
  <th className="px-4 py-3 text-left text-sm font-bold text-gray-900">建築年</th>
)}
```

### 2.7 グラフ・分析セクションの表示制御

#### グラフタイトルの変更
```typescript
// 1. 面積と価格のグラフ
<h3 className="text-lg font-semibold mb-4">
  1. {isLand ? '土地面積' : '延床面積'}と価格
</h3>
```

#### 築年数関連グラフの非表示
```typescript
{/* 3. 建築年別価格分布 - 土地の場合は非表示 */}
{!isLand && (
  <div className="bg-white rounded-lg shadow-lg p-6">
    <h3 className="text-lg font-semibold mb-4">3. 建築年別価格分布</h3>
    {/* グラフ内容 */}
  </div>
)}

{/* 4. 建築年別価格分布（ヒートマップ） - 土地の場合は非表示 */}
{!isLand && (
  <div className="bg-white rounded-lg shadow-lg p-6">
    <h3 className="text-lg font-semibold mb-4">4. 建築年別価格分布（ヒートマップ）</h3>
    {/* グラフ内容 */}
  </div>
)}
```

## 3. 影響範囲の保証

### 3.1 条件分岐による影響範囲の限定
すべての修正は`isLand`（`selectedPropertyType === '01'`）の条件分岐内で実施するため：
- **propertyType='02'（戸建）の場合**：すべて従来通りの動作
- **propertyType='07'（マンション）の場合**：すべて従来通りの動作
- **propertyType='01'（土地）の場合のみ**：新しいロジックが適用

### 3.2 安全な実装のためのチェックポイント
1. **既存コードの維持**：戸建・マンション用のコードは削除・変更せず、条件分岐を追加するのみ
2. **デフォルト値の保持**：土地以外の場合は必ず従来の処理にフォールバック
3. **APIパラメータの分離**：土地用と建物用でパラメータを完全に分離

### 3.3 テスト確認項目
- [ ] 戸建(02)の検索が従来通り動作すること
- [ ] マンション(07)の検索が従来通り動作すること
- [ ] 土地(01)の検索で土地物件のみが表示されること
- [ ] 土地(01)の検索で築年数関連の項目が非表示になること
- [ ] 土地(01)の検索で面積が「土地面積」として表示されること

## 4. 実装優先順位

1. **【最優先】基本動作の修正**
   - isLandフラグの追加
   - getArea関数の修正
   - 入力フォームの条件分岐

2. **【高優先】データ取得の修正**
   - APIパラメータの条件分岐
   - フィルタリングロジックの修正

3. **【中優先】表示の最適化**
   - ラベル・タイトルの動的変更
   - グラフの表示/非表示制御

4. **【低優先】詳細調整**
   - ML分析の土地対応
   - エラーメッセージの最適化

---

## 5. RenderのAPI側の対応状況と必要な修正

### 5.1 現在のAPI仕様（app.py）
現在のRender APIは以下のパラメータを受け付けています：
- `min_area` / `max_area`: 一般的な面積フィルタ（土地・建物共通）
- `min_year` / `max_year`: 建築年フィルタ
- `property_type`: 物件種別（マンション/戸建/土地）

### 5.2 API側で必要な修正

#### ① パラメータの追加（app.py:195-205行目）
```python
async def search_properties(
    # 既存パラメータ
    prefecture: str = Query(...),
    city: Optional[str] = Query(None),
    district: Optional[str] = Query(None),
    property_type: str = Query("マンション"),

    # 土地・建物を区別するパラメータを追加
    area_min: Optional[float] = Query(None, description="土地面積の最小値（㎡）"),
    area_max: Optional[float] = Query(None, description="土地面積の最大値（㎡）"),
    building_area_min: Optional[float] = Query(None, description="延床面積の最小値（㎡）"),
    building_area_max: Optional[float] = Query(None, description="延床面積の最大値（㎡）"),
    build_year_min: Optional[int] = Query(None, description="建築年の最小値"),
    build_year_max: Optional[int] = Query(None, description="建築年の最大値"),

    # 既存の汎用パラメータは後方互換性のため残す
    min_area: Optional[float] = Query(None, deprecated=True),
    max_area: Optional[float] = Query(None, deprecated=True),
    min_year: Optional[int] = Query(None, deprecated=True),
    max_year: Optional[int] = Query(None, deprecated=True)
):
```

#### ② フィルタリングロジックの修正（real_estate_client.py）
```python
# 物件タイプ判定
is_land = property_type == "01" or property_type == "土地"

# フィルタリング処理
if is_land:
    # 土地の場合：土地面積でフィルタ
    if area_min or area_max:
        filtered = [item for item in data
                   if (not area_min or item['土地面積'] >= area_min) and
                      (not area_max or item['土地面積'] <= area_max)]
else:
    # 建物の場合：延床面積と築年数でフィルタ
    if building_area_min or building_area_max:
        filtered = [item for item in data
                   if (not building_area_min or item['延床面積'] >= building_area_min) and
                      (not building_area_max or item['延床面積'] <= building_area_max)]
    if build_year_min or build_year_max:
        filtered = [item for item in filtered
                   if (not build_year_min or item['建築年'] >= build_year_min) and
                      (not build_year_max or item['建築年'] <= build_year_max)]
```

#### ③ レスポンスデータの調整
```python
# ML分析用データの準備
if is_land:
    # 土地の場合は土地面積を使用
    for item in data:
        item['分析用面積'] = item.get('土地面積', 0)
        item['建築年'] = None  # 土地には建築年なし
else:
    # 建物の場合は延床面積を使用
    for item in data:
        item['分析用面積'] = item.get('延床面積', 0) or item.get('専有面積', 0)
```

### 5.3 フロントエンド側との連携
フロントエンド（MarketAnalysis.tsx）から送信するパラメータ：
```typescript
// 土地の場合
{
  property_type: '01',
  area_min: 100,
  area_max: 120,
  // building_area_min/max, build_year_min/maxは送信しない
}

// 戸建・マンションの場合
{
  property_type: '02', // または '07'
  building_area_min: 90,
  building_area_max: 110,
  build_year_min: 2010,
  build_year_max: 2020,
  // area_min/maxは送信しない
}
```

### 5.4 API修正の影響範囲
- **後方互換性維持**：既存の`min_area`/`max_area`パラメータは残すため、既存実装への影響なし
- **段階的移行**：新パラメータを優先的に使用し、なければ旧パラメータにフォールバック
- **明確な分離**：土地と建物で使用するパラメータを明確に分離
# 統合使用制限管理仕様書

## 📋 概要

### 機能概要
収益シミュレーターとAI市場分析の使用回数を統合管理し、フリーミアムモデルを実現する機能

### 作成日
2025年9月23日

### 最終更新
2025年9月23日

---

## 🎯 ビジネス要件

### フリーミアムモデル
- **無料プラン**: 基本機能を月5回まで無料提供
- **ベーシックプラン**: 月額2,980円で全機能無制限

### 収益化戦略
1. 無料ユーザーの獲得
2. 使用制限による有料プランへの誘導
3. 継続的な価値提供による解約率低減

---

## 🔧 技術仕様

### 統合カウント方式

#### 対象機能
1. **収益シミュレーター**
   - feature_type: `simulator`
   - パス: `/simulator`

2. **AI市場分析**
   - feature_type: `market_analysis`
   - パス: `/market-analysis`

#### カウント仕様
```
無料プラン: シミュレーター + AI市場分析 = 合計月5回
ベーシックプラン: 両機能とも無制限
```

### データベース設計

#### user_usageテーブル
```sql
CREATE TABLE user_usage (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id),
  usage_count INTEGER DEFAULT 0,  -- 統合カウンター
  period_start_date TIMESTAMP DEFAULT CURRENT_DATE,
  period_end_date TIMESTAMP DEFAULT (CURRENT_DATE + INTERVAL '30 days'),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### usage_historyテーブル
```sql
CREATE TABLE usage_history (
  id SERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  feature_type TEXT NOT NULL,  -- 'simulator' or 'market_analysis'
  feature_data JSONB,  -- 詳細データ
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Supabase RPC関数

#### check_and_reset_usage
```sql
CREATE OR REPLACE FUNCTION check_and_reset_usage(p_user_id UUID)
RETURNS TABLE(current_count INT, period_end TIMESTAMP) AS $$
BEGIN
  -- 期限切れの場合リセット
  UPDATE user_usage
  SET usage_count = 0,
      period_start_date = CURRENT_DATE,
      period_end_date = CURRENT_DATE + INTERVAL '30 days'
  WHERE user_id = p_user_id
    AND period_end_date < CURRENT_TIMESTAMP;

  -- 現在の使用状況を返す
  RETURN QUERY
  SELECT usage_count, period_end_date
  FROM user_usage
  WHERE user_id = p_user_id;
END;
$$ LANGUAGE plpgsql;
```

---

## 💻 フロントエンド実装

### カスタムフック: useUsageStatus

```typescript
// /bolt_front/src/hooks/useUsageStatus.ts
export const useUsageStatus = () => {
  // 使用状況の取得
  const fetchUsageStatus = async () => {
    const status = await checkUsageLimit(user.id);
    setUsage(status);
  };

  // 制限チェック付き実行
  const executeWithLimit = async (
    callback: () => Promise<void>,
    featureType: string = 'simulator'
  ): Promise<boolean> => {
    if (usage.isSubscribed) {
      await callback();  // ベーシック会員は制限なし
      return true;
    }

    if (!usage.canUse) {
      return false;  // 制限到達
    }

    await callback();
    await incrementUsage(user.id, featureType);
    await fetchUsageStatus();
    return true;
  };
};
```

### コンポーネント実装

#### UsageStatusBar
- 使用状況の可視化
- プログレスバー表示
- アップグレード促進

#### UpgradeModal
- 制限到達時の案内
- プラン比較表示
- 決済画面への導線

---

## 📊 使用状況の表示

### 無料プラン表示例
```
今月の利用状況: 3/5回
[███████████░░░░░░░░░] 残り2回
```

### ベーシックプラン表示例
```
✨ ベーシックプラン - 全機能無制限
```

### 制限到達時
```
⚠️ 無料利用枠（月5回）を使い切りました
→ ベーシックプランにアップグレード
```

---

## 🔄 リセット処理

### 自動リセット
- **タイミング**: 毎月1日 0:00
- **方式**: RPC関数による自動判定
- **対象**: 無料プランユーザーのみ

### 手動リセット（開発環境のみ）
```typescript
export const resetUsageCount = async (userId: string) => {
  if (process.env.NODE_ENV !== 'development') return;
  // リセット処理
};
```

---

## 📈 分析データ

### 使用履歴の活用
1. **機能別利用統計**
   - シミュレーター vs AI市場分析の利用比率
   - ユーザー別の利用パターン

2. **コンバージョン分析**
   - 制限到達からアップグレードまでの転換率
   - 機能別のアップグレード誘導効果

3. **解約分析**
   - 使用頻度と解約率の相関
   - 機能満足度の測定

---

## 🚀 今後の拡張予定

### Phase 1（実装済み）
- ✅ 統合カウント実装
- ✅ UsageStatusBar表示
- ✅ UpgradeModal実装

### Phase 2（2024年10月予定）
- [ ] AI事業計画書機能の統合
- [ ] プラン別の使用回数カスタマイズ
- [ ] 企業向けエンタープライズプラン

### Phase 3（2024年11月予定）
- [ ] 使用回数の繰り越し機能
- [ ] 追加回数購入オプション
- [ ] APIアクセス制限管理

---

## ⚠️ 注意事項

### セキュリティ考慮事項
1. **フロントエンド制限はバイパス可能**
   - 必ずバックエンドでも制限チェック
   - APIレベルでの制限実装必須

2. **使用回数の不正操作対策**
   - クライアント側での改竄防止
   - サーバーサイドでの整合性チェック

3. **同時実行制御**
   - 連続クリック対策
   - トランザクション管理

### 運用考慮事項
1. **サポート対応**
   - 使用回数の手動調整機能
   - 問い合わせ対応フロー

2. **監視項目**
   - 異常な使用パターンの検知
   - システムエラー時の対応

---

## 🔗 関連ドキュメント

- [AI市場分析機能仕様書](./AI市場分析機能仕様書.md)
- [永久的にベーシックプランになる課題_250923_1.md](/docs_md/02_日報/永久的にベーシックプランになる課題_250923_1.md)
- [シミュレーター_API_仕様書](/docs_md/06_シミュレーター機能/シミュレーター_API_仕様書.md)

---

## 📝 変更履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|-----------|---------|------|
| 2025/09/23 | 1.0.0 | 初版作成（統合カウント実装） | Claude |

---

*このドキュメントはフリーミアムモデルにおける使用制限管理の実装仕様を記録するものです。*
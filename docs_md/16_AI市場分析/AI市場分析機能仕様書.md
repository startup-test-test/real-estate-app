# AI市場分析機能仕様書

## 📋 概要

### 機能概要
AI市場分析機能は、不動産取引価格データをもとに機械学習を用いて市場動向を分析し、投資判断をサポートする機能です。

### 作成日
2025年9月23日

### 最終更新
2025年9月23日

---

## 🎯 機能の目的

1. **市場動向の可視化**: 選択エリアの不動産価格推移をグラフで表示
2. **類似物件分析**: 指定条件に合致する物件の価格分布を分析
3. **機械学習による洞察**: K-means++クラスタリングによる価格帯分析
4. **投資判断支援**: 統計データとAI分析により適正価格を提示

---

## 💼 ビジネス要件

### ターゲットユーザー
- 不動産投資家
- 物件購入検討者
- 不動産会社営業担当
- 金融機関融資担当者

### 提供価値
- データドリブンな投資判断
- 市場価格の透明性向上
- リスク評価の定量化
- 投資タイミングの最適化

---

## 🔧 技術仕様

### フロントエンド実装

#### ファイル構成
```
/bolt_front/src/pages/MarketAnalysis.tsx  # メインコンポーネント
/bolt_front/src/services/propertyApi.ts   # API通信
/bolt_front/src/utils/usageLimit.ts       # 使用制限管理
/bolt_front/src/hooks/useUsageStatus.ts   # 使用状況フック
```

#### 主要コンポーネント
- **MarketAnalysis.tsx**: メインページコンポーネント
- **UsageStatusBar**: 使用状況表示バー
- **UpgradeModal**: アップグレード促進モーダル

### バックエンド実装

#### エンドポイント
```python
# Render.com (FastAPI)
GET /api/ml/clustering  # クラスタリング分析
GET /api/properties/search  # 物件検索
GET /api/properties/prefectures  # 都道府県リスト
GET /api/properties/cities/{prefecture_code}  # 市区町村リスト
GET /api/properties/districts/{city_code}  # 地区リスト
```

### データベース

#### 使用テーブル
- `properties`: 物件データ（国土交通省不動産取引価格情報）
- `user_usage`: 使用回数カウント
- `usage_history`: 使用履歴記録

---

## 📊 機能詳細

### 1. エリア選択機能

#### 階層構造
1. 都道府県選択（必須）
2. 市区町村選択（必須）
3. 地区選択（任意）

#### データソース
- 国土交通省不動産取引価格情報API
- 2021年〜2024年の取引データ

### 2. 物件条件設定

#### 物件種別
- 土地
- 戸建て
- マンション

#### 希望条件
- **土地の場合**: 土地面積（㎡）
- **建物の場合**: 延床面積（㎡）、建築年

#### フィルタリング条件
- 面積: 指定値 ±10㎡
- 建築年: 指定値 ±5年
- 適応的フィルタリング（データ不足時は条件緩和）

### 3. 分析結果表示

#### 表示内容

##### 基本統計
- 平均価格
- 中央値（50%タイル）
- 価格分布（25%, 75%タイル）
- 取引件数

##### グラフ表示
1. **価格推移グラフ**: 年度別の価格変動
2. **価格分布ヒストグラム**: 価格帯別の物件数
3. **築年数vs価格散布図**: 築年数と価格の相関（建物のみ）
4. **ヒートマップ**: 築年数×価格帯の分布（建物のみ）

##### ML分析結果
- K-means++による3クラスタ分析
- クラスタ別の価格帯と特徴
- 外れ値検出と除外

---

## 🔒 使用制限

### 無料プラン
- **月間利用回数**: 5回（収益シミュレーターと合算）
- **リセット**: 毎月1日
- **カウント方式**: 統合カウント

### ベーシックプラン（月額2,980円）
- **利用回数**: 無制限
- **全機能利用可能**

### 使用回数管理

#### カウント仕様
```typescript
// 統合カウント実装
executeWithLimit(async () => {
  await performAnalysis();
}, 'market_analysis');  // feature_type: 'market_analysis'として記録
```

#### データベース構造
```sql
-- user_usageテーブル
user_id: UUID
usage_count: INTEGER  -- シミュレーター + AI市場分析の合計
period_start_date: TIMESTAMP
period_end_date: TIMESTAMP

-- usage_historyテーブル
user_id: UUID
feature_type: TEXT  -- 'simulator' or 'market_analysis'
feature_data: JSONB
created_at: TIMESTAMP
```

---

## 🎨 UI/UX設計

### レスポンシブデザイン
- PC/タブレット/スマートフォン対応
- Tailwind CSSによるスタイリング

### ローディング表示
- プログレスバー付きローディング画面
- 「1分〜3分かかる場合があります」の案内表示

### エラーハンドリング
- データ不足時の警告表示
- API エラー時のフォールバック
- 使用制限到達時のアップグレード促進

---

## 🚀 今後の拡張予定

### Phase 1（実装済み）
- ✅ 基本的な市場分析機能
- ✅ ML（K-means++）クラスタリング
- ✅ 統合カウント実装
- ✅ レスポンシブデザイン

### Phase 2（2024年10月予定）
- [ ] AI事業計画書生成機能との連携
- [ ] より高度な機械学習モデル（XGBoost等）
- [ ] 将来価格予測機能

### Phase 3（2024年11月予定）
- [ ] エリア比較機能
- [ ] ポートフォリオ分析
- [ ] レポートPDF出力機能

---

## 📈 パフォーマンス指標

### 応答時間
- 初期ローディング: < 3秒
- API レスポンス: < 10秒（大量データ時）
- ML分析処理: < 5秒

### データ量
- 最大表示物件数: 10,000件
- グラフ表示上限: 5,000件
- 詳細テーブル表示: 上位10件

---

## 🔗 関連ドキュメント

- [永久的にベーシックプランになる課題_250923_1.md](/docs_md/02_日報/永久的にベーシックプランになる課題_250923_1.md)
- [収益シミュレーター仕様書](/docs_md/15_収益シミュレーション/収益シミュレーター仕様書.md)
- [API仕様書](/docs_md/API仕様書.md)

---

## 📝 変更履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|-----------|---------|------|
| 2025/09/23 | 1.0.0 | 初版作成 | Claude |
| 2025/09/23 | 1.1.0 | 統合カウント機能追加 | Claude |

---

*このドキュメントはAI市場分析機能の実装仕様と今後の拡張計画を記録するものです。*
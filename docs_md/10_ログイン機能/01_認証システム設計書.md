# 認証システム設計書

作成日: 2025年8月12日  
バージョン: 2.0.0（統合版）

---

## 第1部：現状の認証システム

### 1.1 システム構成

| 項目 | 技術/ライブラリ | 用途 |
|------|---------------|------|
| 認証基盤 | Supabase Auth 2.50.2 | ユーザー認証管理 |
| フロントエンド | React 18.3.1 | UI実装 |
| 状態管理 | React Context API | 認証状態管理 |

### 1.2 ファイル構成

```
bolt_front/src/
├── pages/Login.tsx              # ログイン画面UI（407行）
├── components/AuthProvider.tsx  # 認証コンテキスト（52行）
├── hooks/useSupabaseAuth.ts    # Supabase認証フック（286行）
└── lib/supabase.ts             # Supabaseクライアント
```

### 1.3 実装済み機能

- ✅ メール/パスワード認証
- ✅ パスワードリセット
- ✅ Remember Me機能
- ✅ 招待リンク対応
- ✅ モック認証（開発環境）
- ⚠️ Google OAuth（関数のみ実装、UI未実装）

---

## 第2部：OAuth導入の影響範囲

### 2.1 直接影響を受けるファイル

| ファイル | 影響度 | 変更内容 |
|---------|--------|---------|
| Login.tsx | 高 | OAuthボタン追加 |
| useSupabaseAuth.ts | 高 | OAuth関数追加 |
| AuthProvider.tsx | 中 | Context拡張 |
| .env.local | 中 | 環境変数追加 |

### 2.2 データベース影響

```sql
-- Supabase自動管理テーブル
auth.users       -- 統一ユーザーID管理
auth.identities  -- プロバイダー情報

-- アプリケーション用（要作成）
CREATE TABLE public.users (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  avatar_url TEXT,
  auth_provider TEXT,  -- 'google', 'twitter', 'facebook'
  provider_id TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 2.3 セキュリティ考慮事項

- **スコープ最小化**: email, profile のみ要求
- **CSRF対策**: state parameter使用
- **HTTPS必須**: 本番環境でのみOAuth有効化

---

## 第3部：OAuth基礎知識

### 3.1 OAuthとは

「**他のサービスのアカウントを使って、安全にログインする仕組み**」

```
通常のログイン:
ユーザー → [メール/パスワード] → アプリ

OAuthログイン:
ユーザー → [Googleボタン] → Google認証 → アプリ
```

### 3.2 なぜOAuthが必要か

| メリット | ユーザー側 | 開発者側 |
|---------|-----------|----------|
| **セキュリティ** | パスワード不要 | パスワード管理不要 |
| **利便性** | ワンクリックログイン | 開発コスト削減 |
| **信頼性** | 大手企業の認証利用 | セキュリティリスク低減 |

### 3.3 SupabaseでのOAuth処理

#### ユーザーIDの管理

```typescript
// FacebookでログインしてもGoogleでログインしても
// Supabaseが統一IDを生成

const user = await supabase.auth.getUser()
console.log(user.id)  // "d0f3e2c1-a4b5-6789-0123-456789abcdef"
                      // ↑ このIDは変わらない

// プロバイダー情報は別途保存
console.log(user.app_metadata.provider)   // "facebook"
console.log(user.user_metadata.provider_id) // "1234567890"
```

#### 重要なポイント

1. **統一ID**: どのプロバイダーでもSupabase IDは同じ
2. **プロバイダー情報保持**: 元のIDはmetadataに保存
3. **複数プロバイダー対応**: 1ユーザーが複数の認証方法を利用可能

---

## 第4部：プロバイダー選定と優先順位

### 4.1 推奨プロバイダー

| 優先度 | プロバイダー | 理由 | 実装難易度 | コスト |
|--------|------------|------|-----------|--------|
| **1** | Google | 利用率80%、実装簡単 | 簡単 | 無料 |
| **2** | Apple | iOS率50%、セキュリティ重視層 | 中 | $99/年 |
| **3** | Twitter | 情報収集層、拡散効果 | 簡単 | 無料 |
| **4** | Facebook | ビジネス層、実名制 | 簡単 | 無料 |

### 4.2 不採用プロバイダー

- **Microsoft**: B2B向けで個人投資家には不要
- **LINE**: 金融サービスとの相性が微妙
- **Yahoo! Japan**: 利用者層の高齢化、審査が厳格

### 4.3 ビジネスインパクト

```
【期待効果】
- 登録完了率: 30% → 65%（+116%向上）
- 離脱率: 70% → 35%（-50%削減）
- パスワード忘れ: 20% → 2%（-90%削減）

【ROI試算】
- 実装コスト: 約52万円
- 期待収益: 月42万円増
- 投資回収: 1.2ヶ月
```

---

## 第5部：実装後の運用

### 5.1 監視項目

| メトリクス | 目標値 | アラート閾値 |
|-----------|--------|-------------|
| OAuth成功率 | >95% | <90% |
| 認証時間 | <3秒 | >5秒 |
| エラー率 | <1% | >3% |

### 5.2 トラブルシューティング

| エラー | 原因 | 解決法 |
|--------|------|--------|
| redirect_uri_mismatch | URI設定ミス | Console設定確認 |
| invalid_client | ID/Secret誤り | 環境変数確認 |
| access_denied | 権限不足 | スコープ確認 |

### 5.3 法的要件

- 利用規約の更新（第三者サービス利用明記）
- プライバシーポリシー更新（OAuth情報取得明記）

---

## 付録：クイックリファレンス

### 環境変数設定
```env
VITE_ENABLE_OAUTH=true
VITE_GOOGLE_CLIENT_ID=xxx.apps.googleusercontent.com
```

### Feature Flag
```typescript
const ENABLE_OAUTH = import.meta.env.VITE_ENABLE_OAUTH === 'true'
```

### ロールバック（5分以内）
```bash
# Feature Flag無効化
VITE_ENABLE_OAUTH=false
# 再デプロイ
git push origin main
```

---

以上
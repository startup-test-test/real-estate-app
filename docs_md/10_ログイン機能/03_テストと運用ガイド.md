# OAuth テストと運用ガイド

作成日: 2025年8月12日  
バージョン: 2.0.0（統合版）

---

## 第1部：影響範囲チェックリスト

### 1.1 コード変更チェック

#### 必須変更ファイル
- [ ] `/pages/Login.tsx` - OAuthボタン追加
- [ ] `/hooks/useSupabaseAuth.ts` - OAuth関数追加
- [ ] `/components/AuthProvider.tsx` - Context拡張
- [ ] `/pages/AuthCallback.tsx` - 新規作成
- [ ] `/App.tsx` - ルート追加
- [ ] `/.env.local` - 環境変数追加
- [ ] `/package.json` - react-icons追加

#### 影響確認ファイル
- [ ] Dashboard.tsx - ユーザー情報表示
- [ ] Simulator.tsx - 認証状態確認
- [ ] PropertyDetail.tsx - 共有時の認証

### 1.2 UI/UXチェック

- [ ] PC - ボタン配置適切
- [ ] タブレット - レスポンシブ対応
- [ ] スマートフォン - タップ領域44px以上
- [ ] 画面遷移 - 3秒以内完了

### 1.3 セキュリティチェック

- [ ] スコープ最小限（email, profile）
- [ ] HTTPS必須
- [ ] CSRF対策（state parameter）
- [ ] トークン安全保管

---

## 第2部：シナリオテスト

### 2.1 基本機能テスト（10項目）

#### TEST-001: 新規Googleログイン
```
前提: 未登録のGoogleアカウント
手順:
1. ログインページアクセス
2. 「Googleでログイン」クリック
3. Google認証完了
期待: ダッシュボード表示、DBにユーザー作成
```

#### TEST-002: 既存ユーザー再ログイン
```
前提: 登録済みGoogleアカウント
手順: Googleでログイン
期待: 即座にダッシュボード表示
```

#### TEST-003: 複数プロバイダー利用
```
前提: 同一メールでGoogle/Facebook保有
手順: 別プロバイダーでログイン
期待: 同一ユーザーとして認識
```

### 2.2 エラーテスト（5項目）

#### ERR-001: 認証キャンセル
```
手順: Google画面でキャンセル
期待: ログイン画面に戻る、エラーなし
```

#### ERR-002: ネットワークエラー
```
手順: 認証中にネットワーク切断
期待: エラーメッセージ表示、リトライ可能
```

### 2.3 セキュリティテスト（3項目）

#### SEC-001: CSRF攻撃防御
```
手順: 不正なstate parameterで認証試行
期待: リクエスト拒否、エラーログ記録
```

### 2.4 パフォーマンステスト（2項目）

#### PERF-001: 認証速度
```
測定項目:
- ボタンクリック→Google画面: <1秒
- 認証完了→ダッシュボード: <3秒
合格基準: 合計6秒以内
```

#### PERF-002: 同時ログイン
```
条件: 100ユーザー同時
合格基準: 95%が5秒以内、エラー率<1%
```

### 2.5 業務連携テスト（5項目）

#### BIZ-001: 招待フロー
```
手順:
1. 招待リンクアクセス
2. OAuthログイン
期待: 共有コンテンツ自動表示
```

#### BIZ-002: 既存機能確認
```
チェック項目:
- [ ] メール/パスワードログイン動作
- [ ] パスワードリセット機能
- [ ] Remember Me機能
- [ ] ログアウト処理
- [ ] シミュレーション実行
```

---

## 第3部：自動テストコード

### 3.1 E2Eテスト（Cypress）

```typescript
// cypress/e2e/oauth.cy.ts
describe('OAuth認証', () => {
  it('Googleログインフロー', () => {
    cy.visit('/login')
    cy.get('[data-testid="google-login"]').click()
    
    // Googleモック認証
    cy.origin('https://accounts.google.com', () => {
      cy.get('#identifierId').type('test@gmail.com')
      cy.get('#passwordNext').click()
    })
    
    // リダイレクト確認
    cy.url().should('include', '/dashboard')
    cy.contains('ようこそ')
  })
})
```

### 3.2 負荷テスト（k6）

```javascript
// k6/load-test.js
import http from 'k6/http'
import { check } from 'k6'

export const options = {
  stages: [
    { duration: '1m', target: 100 },
    { duration: '3m', target: 100 },
    { duration: '1m', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<5000'],
    http_req_failed: ['rate<0.01'],
  },
}

export default function () {
  const response = http.post(
    'https://staging.ooya-dx.com/api/auth/oauth',
    JSON.stringify({ provider: 'google', token: 'mock' })
  )
  
  check(response, {
    'status is 200': (r) => r.status === 200,
    'response < 5s': (r) => r.timings.duration < 5000,
  })
}
```

---

## 第4部：本番運用

### 4.1 監視設定

| 監視項目 | 閾値 | アラート |
|---------|------|---------|
| OAuth成功率 | >95% | <90%で通知 |
| 認証時間 | <3秒 | >5秒で通知 |
| エラー率 | <1% | >3%で通知 |
| API制限 | - | 80%到達で通知 |

### 4.2 ログ設定

```typescript
// 認証イベントログ
const logAuthEvent = (event: string, provider: string, success: boolean) => {
  console.log('Auth Event:', {
    event,
    provider,
    success,
    timestamp: new Date().toISOString(),
    userId: user?.id
  })
  
  // 本番環境のみGoogle Analytics送信
  if (import.meta.env.PROD) {
    gtag('event', 'authentication', {
      event_category: 'engagement',
      event_label: provider,
      value: success ? 1 : 0
    })
  }
}
```

### 4.3 サポート準備

#### FAQ追加項目
```
Q: Googleアカウントがない場合は？
A: メールアドレスでの登録も可能です

Q: パスワードは大家DXに保存される？
A: いいえ、Googleが管理します

Q: 複数の方法でログインできる？
A: はい、同じメールなら統合されます
```

---

## 第5部：リリース判定基準

### 5.1 Go/No-Go チェックリスト

#### 技術要件
- [ ] 全テストケース合格（25/25）
- [ ] セキュリティ監査合格
- [ ] パフォーマンス基準達成
- [ ] 主要ブラウザ動作確認

#### ビジネス要件
- [ ] 法務確認完了
- [ ] プライバシーポリシー更新
- [ ] 利用規約更新
- [ ] サポート体制準備

#### 緊急時対応
- [ ] ロールバック手順確認
- [ ] 緊急連絡先リスト作成
- [ ] エスカレーション手順文書化

### 5.2 段階的リリース計画

```
Week 1: 開発環境（100%）
Week 2: ステージング（100%）
Week 3: 本番（10%）Feature Flag
Week 4: 本番（50%）
Week 5: 本番（100%）
```

### 5.3 成功指標

| 期間 | 指標 | 目標 |
|------|------|------|
| 1週間 | 登録率 | +20% |
| 1ヶ月 | 登録率 | +50% |
| 3ヶ月 | 離脱率 | -30% |

---

## 付録：トラブル対応クイックガイド

### 即時対応（5分以内）
```bash
# OAuth無効化
VITE_ENABLE_OAUTH=false
git push
```

### 調査コマンド
```bash
# ログ確認
supabase logs auth --tail 100

# セッション確認
curl https://[project].supabase.co/auth/v1/user \
  -H "Authorization: Bearer [token]"
```

### サポート用テンプレート
```
お客様、

OAuthログインに関するお問い合わせありがとうございます。

1. ブラウザのキャッシュをクリア
2. ポップアップブロックを解除
3. 再度お試しください

解決しない場合は、メールアドレスでのログインをご利用ください。

よろしくお願いいたします。
```

---

以上
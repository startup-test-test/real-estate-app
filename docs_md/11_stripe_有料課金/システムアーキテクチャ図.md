# Stripe決済システム アーキテクチャ図

## システム全体図

```mermaid
graph TB
    subgraph "Frontend (React)"
        UI[UsageStatusBar<br/>使用状況表示]
        Modal[UpgradeModal<br/>アップグレード画面]
        Hook[useUsageStatus<br/>カスタムフック]
    end

    subgraph "Supabase"
        Auth[Authentication<br/>認証システム]
        DB[(PostgreSQL)]
        EF1[Edge Function<br/>smart-service]
        EF2[Edge Function<br/>handle-stripe-webhook]
        
        subgraph "Database Tables"
            T1[user_usage<br/>使用状況]
            T2[subscriptions<br/>サブスクリプション]
            T3[usage_history<br/>使用履歴]
        end
    end

    subgraph "Stripe"
        Checkout[Checkout Session<br/>決済画面]
        Webhook[Webhook Events<br/>イベント通知]
        Customer[Customer<br/>顧客管理]
        Sub[Subscription<br/>サブスクリプション]
    end

    UI --> Hook
    Modal --> Hook
    Hook --> Auth
    Hook --> DB
    
    Modal --> EF1
    EF1 --> Checkout
    Checkout --> Customer
    Customer --> Sub
    
    Sub --> Webhook
    Webhook --> EF2
    EF2 --> T2
    
    DB --> T1
    DB --> T2
    DB --> T3
```

## 決済フロー詳細

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant App as React App
    participant SF as Supabase Functions
    participant Stripe as Stripe
    participant DB as Supabase DB

    User->>App: 「今すぐアップグレード」クリック
    App->>SF: POST /smart-service
    Note over SF: Checkout Session作成
    SF->>Stripe: Create Checkout Session
    Stripe-->>SF: Session URL
    SF-->>App: Redirect URL
    App->>User: Stripe決済画面へリダイレクト
    
    User->>Stripe: カード情報入力
    Stripe->>User: 決済完了
    User->>App: アプリへリダイレクト
    
    Note over Stripe: 非同期でWebhook送信
    Stripe->>SF: POST /handle-stripe-webhook
    Note over SF: 署名検証
    SF->>DB: サブスクリプション更新
    
    App->>DB: 使用状況確認
    DB-->>App: プレミアムステータス
    App->>User: 無制限利用可能表示
```

## データフロー図

```mermaid
graph LR
    subgraph "使用制限チェックフロー"
        Start([開始]) --> Check{サブスク<br/>確認}
        Check -->|Active| Premium[無制限利用]
        Check -->|なし| Count{使用回数<br/>確認}
        Count -->|< 5回| Allow[利用許可]
        Count -->|>= 5回| Deny[制限表示]
        Deny --> Upgrade[アップグレード促進]
    end
```

## データベース関係図

```mermaid
erDiagram
    auth_users ||--o{ user_usage : "has"
    auth_users ||--o{ subscriptions : "has"
    auth_users ||--o{ usage_history : "has"
    
    auth_users {
        uuid id PK
        string email
        timestamp created_at
    }
    
    user_usage {
        uuid id PK
        uuid user_id FK
        int usage_count
        timestamp period_start_date
        timestamp period_end_date
        timestamp updated_at
    }
    
    subscriptions {
        uuid id PK
        uuid user_id FK
        string status
        string stripe_subscription_id
        string stripe_customer_id
        string stripe_price_id
        timestamp current_period_start
        timestamp current_period_end
        timestamp cancelled_at
        timestamp updated_at
    }
    
    usage_history {
        uuid id PK
        uuid user_id FK
        string feature_type
        jsonb feature_data
        timestamp created_at
    }
```

## Edge Functions 処理フロー

### create-checkout-session (smart-service)

```mermaid
flowchart TD
    A[リクエスト受信] --> B{認証確認}
    B -->|OK| C[ユーザー情報取得]
    B -->|NG| Z[401エラー]
    C --> D{既存顧客?}
    D -->|Yes| E[顧客ID取得]
    D -->|No| F[新規顧客作成]
    F --> E
    E --> G[Checkout Session作成]
    G --> H[メタデータ設定]
    H --> I[URLを返却]
```

### handle-stripe-webhook

```mermaid
flowchart TD
    A[Webhookリクエスト] --> B[署名検証]
    B -->|OK| C{イベントタイプ}
    B -->|NG| Z[400エラー]
    
    C -->|checkout.session.completed| D[サブスク情報取得]
    C -->|subscription.updated| E[ステータス更新]
    C -->|subscription.deleted| F[キャンセル処理]
    C -->|invoice.payment_succeeded| G[支払い成功処理]
    C -->|invoice.payment_failed| H[支払い失敗処理]
    
    D --> I[DBに保存/更新]
    E --> I
    F --> I
    G --> I
    H --> I
    
    I --> J[200 OK返却]
```

## セキュリティアーキテクチャ

```mermaid
graph TB
    subgraph "セキュリティレイヤー"
        subgraph "Frontend"
            RLS[Row Level Security<br/>行レベルセキュリティ]
        end
        
        subgraph "API Layer"
            JWT[JWT認証<br/>※Webhook以外]
            CORS[CORS設定]
        end
        
        subgraph "Webhook"
            SIG[Stripe署名検証]
            SECRET[Webhook Secret]
        end
        
        subgraph "Environment"
            ENV[環境変数<br/>DEV/PROD分離]
            SECRETS[GitHub/Supabase<br/>Secrets管理]
        end
    end
    
    RLS --> JWT
    JWT --> CORS
    CORS --> SIG
    SIG --> SECRET
    SECRET --> ENV
    ENV --> SECRETS
```

## デプロイメントアーキテクチャ

```mermaid
graph LR
    subgraph "Development"
        Dev[開発環境]
        DevStripe[Stripe Test Mode]
        DevDB[Supabase Dev]
    end
    
    subgraph "CI/CD"
        GH[GitHub Actions]
        Test[自動テスト]
    end
    
    subgraph "Production"
        Prod[本番環境]
        ProdStripe[Stripe Live Mode]
        ProdDB[Supabase Prod]
    end
    
    Dev --> GH
    GH --> Test
    Test --> Prod
    
    DevStripe -.->|テスト| Dev
    DevDB -.->|テスト| Dev
    
    ProdStripe -.->|本番| Prod
    ProdDB -.->|本番| Prod
```

---
作成日: 2025年8月12日
バージョン: 1.0.0
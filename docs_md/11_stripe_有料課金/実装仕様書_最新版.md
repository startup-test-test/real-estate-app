# Stripe決済システム実装仕様書（最新版）

## 1. システム概要

### 1.1 フリーミアムモデル
- **無料プラン**: 月5回まで無料でシミュレーション機能を利用可能
- **プレミアムプラン**: 月額2,980円で無制限利用
- **リセット周期**: 30日ごと（ユーザー登録日基準）

### 1.2 技術スタック
- **決済プロバイダ**: Stripe
- **バックエンド**: Supabase Edge Functions (Deno)
- **データベース**: PostgreSQL (Supabase)
- **フロントエンド**: React + TypeScript

## 2. データベース設計

### 2.1 テーブル構造

#### user_usage（使用状況管理）
```sql
CREATE TABLE user_usage (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  usage_count INTEGER DEFAULT 0,
  period_start_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  period_end_date TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '30 days'),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### subscriptions（サブスクリプション管理）
```sql
CREATE TABLE subscriptions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  status TEXT CHECK (status IN ('active', 'inactive', 'cancelled', 'past_due')),
  stripe_subscription_id TEXT,
  stripe_customer_id TEXT,
  stripe_price_id TEXT,
  current_period_start TIMESTAMP WITH TIME ZONE,
  current_period_end TIMESTAMP WITH TIME ZONE,
  cancelled_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### usage_history（使用履歴）
```sql
CREATE TABLE usage_history (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  feature_type TEXT NOT NULL,
  feature_data JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.2 RLS（Row Level Security）ポリシー

```sql
-- user_usage policies
ALTER TABLE user_usage ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own usage" ON user_usage
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can update own usage" ON user_usage
  FOR UPDATE USING (auth.uid() = user_id);

-- subscriptions policies
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own subscription" ON subscriptions
  FOR SELECT USING (auth.uid() = user_id);

-- usage_history policies
ALTER TABLE usage_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own history" ON usage_history
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own history" ON usage_history
  FOR INSERT WITH CHECK (auth.uid() = user_id);
```

### 2.3 PostgreSQL関数

#### check_and_reset_usage（使用状況確認と自動リセット）
```sql
CREATE OR REPLACE FUNCTION check_and_reset_usage(p_user_id UUID)
RETURNS TABLE(current_count INTEGER, period_end TIMESTAMP WITH TIME ZONE)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- 既存レコードがない場合は作成
  INSERT INTO user_usage (user_id, usage_count, period_start_date, period_end_date)
  VALUES (p_user_id, 0, NOW(), NOW() + INTERVAL '30 days')
  ON CONFLICT (user_id) DO NOTHING;

  -- 期限切れの場合はリセット
  UPDATE user_usage
  SET 
    usage_count = 0,
    period_start_date = NOW(),
    period_end_date = NOW() + INTERVAL '30 days',
    updated_at = NOW()
  WHERE user_id = p_user_id
    AND period_end_date <= NOW();

  -- 現在の状態を返す
  RETURN QUERY
  SELECT usage_count, period_end_date
  FROM user_usage
  WHERE user_id = p_user_id;
END;
$$;
```

## 3. Edge Functions実装

### 3.1 create-checkout-session (smart-service)

**エンドポイント**: `/functions/v1/smart-service`

**機能**:
- Stripe Checkout Sessionの作成
- 顧客情報の自動作成・管理
- メタデータにユーザーIDを保存

**実装詳細**:
```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.0'
import Stripe from 'https://esm.sh/stripe@13.10.0'

const stripe = new Stripe(Deno.env.get('DEV_STRIPE_SECRET_KEY'), {
  apiVersion: '2023-10-16',
})

serve(async (req) => {
  const { priceId, userId } = await req.json()
  
  // Stripeカスタマー作成または取得
  const customers = await stripe.customers.list({ email, limit: 1 })
  const customerId = customers.data[0]?.id || 
    (await stripe.customers.create({ email, metadata: { supabase_user_id: userId } })).id

  // Checkout Session作成
  const session = await stripe.checkout.sessions.create({
    customer: customerId,
    payment_method_types: ['card'],
    mode: 'subscription',
    line_items: [{ price: priceId, quantity: 1 }],
    success_url: `${APP_URL}/?payment=success&session_id={CHECKOUT_SESSION_ID}`,
    cancel_url: `${APP_URL}/?payment=cancelled`,
    metadata: { user_id: userId },
    subscription_data: { metadata: { user_id: userId } },
    locale: 'ja',
    billing_address_collection: 'required',
  })

  return new Response(JSON.stringify({ sessionId: session.id, url: session.url }))
})
```

### 3.2 handle-stripe-webhook

**エンドポイント**: `/functions/v1/handle-stripe-webhook`

**機能**:
- Stripe Webhookイベントの処理
- 署名検証による安全性確保
- サブスクリプション状態の自動更新

**処理するイベント**:
- `checkout.session.completed`: 決済完了時
- `customer.subscription.updated`: サブスクリプション更新時
- `customer.subscription.deleted`: サブスクリプション解約時
- `invoice.payment_succeeded`: 支払い成功時
- `invoice.payment_failed`: 支払い失敗時

**実装詳細**:
```typescript
import Stripe from 'https://esm.sh/stripe@13.10.0?target=deno'

serve(async (req) => {
  // 署名検証（非同期処理）
  const signature = req.headers.get('stripe-signature')
  const body = await req.text()
  
  const event = await stripe.webhooks.constructEventAsync(
    body, 
    signature, 
    webhookSecret
  )

  switch (event.type) {
    case 'checkout.session.completed':
      // サブスクリプション情報をDBに保存
      await supabase.from('subscriptions').upsert({
        user_id: session.metadata.user_id,
        stripe_subscription_id: subscription.id,
        stripe_customer_id: subscription.customer,
        stripe_price_id: subscription.items.data[0].price.id,
        status: 'active',
        current_period_start: new Date(subscription.current_period_start * 1000),
        current_period_end: new Date(subscription.current_period_end * 1000),
      })
      break
    // 他のイベント処理...
  }
})
```

### 3.3 セキュリティ設定

**JWT認証の無効化**:
- Supabase Dashboard → Edge Functions → Settings
- "Verify JWT with legacy secret" → OFF
- Stripe署名検証で代替セキュリティを確保

**CORS設定**:
```typescript
const headers = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type, stripe-signature',
  'Access-Control-Allow-Methods': 'POST, OPTIONS'
}
```

## 4. フロントエンド実装

### 4.1 使用制限管理（usageLimit.ts）

```typescript
export const checkUsageLimit = async (userId: string): Promise<UsageStatus> => {
  // 1. サブスクリプション確認
  const { data: subscriptions } = await supabase
    .from('subscriptions')
    .select('status')
    .eq('user_id', userId)
    .eq('status', 'active')
    .limit(1)

  // プレミアム会員は無制限
  if (subscriptions?.[0]?.status === 'active') {
    return {
      canUse: true,
      currentCount: 0,
      limit: -1,
      isSubscribed: true,
      periodEndDate: null,
      daysLeft: -1
    }
  }

  // 2. 無料プランの使用状況確認
  const { data } = await supabase
    .rpc('check_and_reset_usage', { p_user_id: userId })

  return {
    canUse: data.current_count < 5,
    currentCount: data.current_count,
    limit: 5,
    isSubscribed: false,
    periodEndDate: new Date(data.period_end),
    daysLeft: calculateDaysLeft(data.period_end)
  }
}
```

### 4.2 UI Components

#### UsageStatusBar（使用状況表示）
- プレミアムプラン: 「プレミアムプラン - 全機能が無制限でご利用いただけます」
- 無料プラン: 「今月の利用状況: 3/5回」プログレスバー表示
- 制限到達時: 警告表示とアップグレード促進

#### UpgradeModal（アップグレード画面）
- 月額2,980円の価格表示
- 特典の説明
- Stripe決済への遷移ボタン

### 4.3 決済フロー実装

```typescript
const handleUpgrade = async () => {
  const response = await fetch(
    'https://gtnzhnsbdmkadfawuzmc.supabase.co/functions/v1/smart-service',
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${session.access_token}`,
      },
      body: JSON.stringify({
        priceId: 'price_1RvChRR8rkVVzR7nAeDvfiur',
        userId: user.id,
      }),
    }
  )
  
  const data = await response.json()
  window.location.href = data.url // Stripe Checkoutへリダイレクト
}
```

## 5. 環境変数設定

### 5.1 GitHub Repository Secrets
```
DEV_STRIPE_SECRET_KEY=sk_test_xxxxx
DEV_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx
DEV_STRIPE_PRICE_ID=price_1RvChRR8rkVVzR7nAeDvfiur
DEV_STRIPE_WEBHOOK_SECRET=whsec_xxxxx
SUPABASE_URL=https://gtnzhnsbdmkadfawuzmc.supabase.co
SUPABASE_ANON_KEY=xxxxx
SUPABASE_SERVICE_ROLE_KEY=xxxxx
```

### 5.2 Supabase Secrets
同様の環境変数をSupabase Dashboard → Settings → Secretsに設定

## 6. Stripe Dashboard設定

### 6.1 商品設定
- **商品名**: 大家DX プレミアムプラン
- **価格**: ¥2,980/月
- **価格ID**: price_1RvChRR8rkVVzR7nAeDvfiur
- **通貨**: JPY
- **請求サイクル**: 月次

### 6.2 Webhook設定
- **エンドポイント名**: ooya-dx-dev
- **URL**: https://gtnzhnsbdmkadfawuzmc.supabase.co/functions/v1/handle-stripe-webhook
- **リッスンイベント**:
  - checkout.session.completed
  - customer.subscription.updated
  - customer.subscription.deleted
  - invoice.payment_succeeded
  - invoice.payment_failed

## 7. テスト情報

### 7.1 テストカード
```
カード番号: 4242 4242 4242 4242
有効期限: 任意の将来の日付（例：12/34）
CVC: 任意の3桁（例：123）
郵便番号: 任意の5桁（例：12345）
```

### 7.2 テストフロー
1. 無料プランで5回シミュレーション実行
2. 6回目で制限メッセージ表示
3. 「今すぐアップグレード」クリック
4. Stripe決済画面でテストカード入力
5. 決済完了後、自動的にプレミアムプラン表示
6. 無制限でシミュレーション利用可能

## 8. トラブルシューティング

### 8.1 よくあるエラーと対処法

#### 401 Unauthorized（Webhook）
- **原因**: JWT認証が有効になっている
- **解決**: Supabase DashboardでJWT認証を無効化

#### Webhook署名検証エラー
- **原因**: 同期処理での署名検証
- **解決**: constructEventAsyncを使用

#### カラムが見つからない
- **原因**: DBスキーマの不一致
- **解決**: ALTER TABLEでカラム追加

### 8.2 デバッグ方法

#### Edge Functionログ確認
```
Supabase Dashboard → Edge Functions → Logs
```

#### Webhookログ確認
```
Stripe Dashboard → 開発者 → Webhooks → イベントログ
```

## 9. 本番環境への移行

### 9.1 環境変数の切り替え
- DEV_プレフィックスをPROD_に変更
- 本番用のStripeキーを設定

### 9.2 Webhook URLの更新
- 本番環境のSupabase URLに変更
- 本番用のWebhookシークレットを生成

### 9.3 テスト実施
- 本番環境でのE2Eテスト
- 決済フローの動作確認
- サブスクリプション更新の確認

## 10. 今後の拡張計画

### 10.1 機能追加
- [ ] サブスクリプション解約機能
- [ ] 支払い方法の変更機能
- [ ] 請求書ダウンロード機能
- [ ] 支払い履歴表示

### 10.2 UI/UX改善
- [ ] プレミアムプランのデザイン改善
- [ ] 決済成功時のアニメーション
- [ ] より詳細な使用統計表示

---
作成日: 2025年8月12日
更新日: 2025年8月12日
バージョン: 1.0.0
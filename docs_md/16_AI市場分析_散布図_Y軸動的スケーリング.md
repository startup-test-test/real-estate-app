# AI市場分析 - 散布図Y軸動的スケーリングと外れ値除去

## 概要
市場分析ページの散布図において、Y軸（価格）の表示範囲を動的に調整し、外れ値を除去することで、データの視認性を向上させる実装。

## 実装日
2025年9月24日

## 解決した課題

### 1. Y軸スケーリングの問題
- **問題**: 最大価格が12,000万円でも、Y軸が30,000万円まで表示され、グラフ上部に無駄な空白が発生
- **原因**: Y軸の範囲が固定値（10,000万円）にハードコーディングされていた
- **解決**: データの最大値に基づいて3パターンの動的スケーリングを実装

### 2. 異常値の問題
- **問題**: 93,000万円（93億円）という異常なデータポイントがあり、グラフ全体のスケールを歪めていた
- **原因**: APIから`price: 930000000`（9.3億円）という異常値が返されていた
- **解決**: 外れ値除去ロジックの実装（ハードリミットとIQR法の併用）

## 実装詳細

### 1. 3パターンY軸スケーリング

```typescript
// データから最大価格を計算（外れ値除去後）
const maxPrice = Math.max(...filteredPriceData);
let yRange, yDtick;

if (maxPrice <= 10000) {
  // パターン1: 標準（〜1億円）
  yRange = [0, 10000];
  yDtick = 1000;  // 1000万円刻み（0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000）
} else if (maxPrice <= 20000) {
  // パターン2: 高額（〜2億円）
  yRange = [0, 20000];
  yDtick = 2000;  // 2000万円刻み（0, 2000, 4000, 6000, 8000, 10000, 12000, 14000, 16000, 18000, 20000）
} else {
  // パターン3: 超高額（〜3億円）
  yRange = [0, 30000];
  yDtick = 3000;  // 3000万円刻み（0, 3000, 6000, 9000, 12000, 15000, 18000, 21000, 24000, 27000, 30000）
}
```

#### パターン選択の理由
- **パターン1（〜1億円）**: 最も一般的な価格帯。1000万円刻みで詳細表示
- **パターン2（〜2億円）**: 高級物件。2000万円刻みで見やすく表示
- **パターン3（〜3億円）**: 超高級物件。3000万円刻みで全体を俯瞰

### 2. 外れ値除去ロジック

#### 2.1 ハードリミット（30,000万円）
```typescript
// 3億円を超える異常値を除外
const hardLimitData = priceData.filter(price => price <= 30000);
```

#### 2.2 IQR（四分位範囲）法による統計的外れ値除去
```typescript
const calculateIQRBounds = (data: number[]) => {
  const sorted = [...data].sort((a, b) => a - b);
  const q1Index = Math.floor(sorted.length * 0.25);
  const q3Index = Math.floor(sorted.length * 0.75);
  const q1 = sorted[q1Index];  // 第1四分位数
  const q3 = sorted[q3Index];  // 第3四分位数
  const iqr = q3 - q1;         // 四分位範囲

  // 外れ値の境界を計算
  const lowerBound = q1 - 1.5 * iqr;
  const upperBound = q3 + 1.5 * iqr;

  return { lowerBound, upperBound, q1, q3, iqr };
};

// IQR法で外れ値を除外
const iqrBounds = calculateIQRBounds(hardLimitData);
const filteredPriceData = hardLimitData.filter(
  price => price >= iqrBounds.lowerBound && price <= iqrBounds.upperBound
);
```

#### IQR法の利点
- 統計的に妥当な外れ値検出
- データの分布に基づく動的な閾値設定
- 単一の極端な値がグラフ全体のスケールを歪めることを防止

#### IQR法の実装詳細
- **適用条件**: データが4件以上ある場合のみIQR法を適用
- **データが少ない場合**: 3億円のハードリミットのみ適用
- **併用方式**: IQR法で外れ値を除去した後、さらに3億円上限を適用（二段階フィルタリング）

### 3. 価格データの単位変換処理

```typescript
// APIから取得したデータの価格単位を正規化
let price;
if (p['取引価格（万円）'] !== undefined && p['取引価格（万円）'] !== null) {
  // 既に万円単位の場合
  price = p['取引価格（万円）'];
  // 異常に大きい値（1000億以上）の場合は円として扱い10000で割る
  if (price > 10000000) {
    price = price / 10000;
  }
} else if (p.price !== undefined && p.price !== null) {
  // priceフィールドは基本的に円単位
  price = p.price / 10000;
} else if (p.取引価格 !== undefined && p.取引価格 !== null) {
  // 取引価格も円単位として扱う
  price = p.取引価格 / 10000;
} else {
  price = 0;
}

// 異常値をログに出力（デバッグ用）
if (price > 50000) { // 5億円以上
  console.log(`異常な価格データ発見:`, {
    元データ: p,
    変換後: price
  });
}
```

## 効果

### Before
- Y軸が固定で30,000万円まで表示
- グラフ上部に大きな空白
- 93億円の異常値でスケールが歪む

### After
- データに応じてY軸が3パターンで自動調整
- グラフの視認性が大幅に向上
- 外れ値が自動除去され、正常な価格帯のみ表示

## 技術的なポイント

1. **Plotlyのlayout設定**
   - `yaxis.range`: Y軸の表示範囲
   - `yaxis.dtick`: 目盛りの間隔（1000, 2000, 3000の3パターン）
   - `yaxis.tickformat`: 数値のフォーマット（カンマ区切り）
   - `yaxis.ticksuffix`: 単位の表示（万円）
   - `hoverlabel`: ツールチップのスタイル設定

2. **パフォーマンスの考慮**
   - 外れ値除去は描画前に1回のみ実行
   - ソート処理は必要最小限に抑制
   - IQR計算は必要な場合のみ実行

3. **ユーザビリティ**
   - 各パターンで均等な目盛り間隔
   - ツールチップで実際の価格を正確に表示
   - shapes（赤い縦線とハイライト領域）も動的にY軸範囲に合わせて調整

## 適用されたグラフ

1. **「1. 延べ床と価格」散布図**
   - 延床面積（土地の場合は土地面積）と価格の関係を表示
   - IQR法とハードリミットで外れ値を除去
   - 3パターンのY軸スケーリングを実装

2. **「3. 建築年別価格分布」散布図**
   - 建築年と価格の関係を表示
   - 同じIQR法とハードリミットロジックを適用
   - 同じ3パターンのY軸スケーリングを実装

## 今後の改善案

1. **設定のカスタマイズ**
   - ユーザーが外れ値除去の閾値を調整可能に
   - Y軸のパターンを増やす（例：5億円まで対応）

2. **視覚的フィードバック**
   - 外れ値として除外されたデータ数を表示
   - 除外されたデータを別の色で薄く表示するオプション

3. **他のグラフへの適用**
   - 建築年別価格分布グラフ
   - ヒートマップの価格レンジ設定
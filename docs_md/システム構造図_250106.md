# 大家DX システム構造・ユーザーフロー図

作成日: 2025年1月6日

---

## 1. 全体構造図

```
┌────────────────────────────────────────────────────────────────────┐
│                         ooya.tech                                   │
│                     （統合プラットフォーム）                          │
└────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌────────────────────────────────────────────────────────────────────┐
│                        Neon Auth（認証）                            │
│                      ユーザー登録・ログイン                          │
│                         【1回だけ】                                 │
└────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌────────────────────────────────────────────────────────────────────┐
│                      ダッシュボード（マイページ）                     │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐               │
│  │ シミュレーター │ │  サービスB   │ │  サービスC   │               │
│  │  月額1,000円  │ │  月額500円   │ │  月額2,000円 │               │
│  │   ✅ 契約中   │ │  ✅ 契約中   │ │  ⬜ 未契約   │               │
│  └──────────────┘ └──────────────┘ └──────────────┘               │
└────────────────────────────────────────────────────────────────────┘
         │                    │                    │
         ▼                    ▼                    ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  /simulator  │    │ /service-b   │    │ /service-c   │
│ シミュレーター │    │  サービスB   │    │  サービスC   │
│    機能      │    │    機能      │    │    機能      │
└──────────────┘    └──────────────┘    └──────────────┘
         │                    │                    │
         ▼                    ▼                    ▼
┌────────────────────────────────────────────────────────────────────┐
│                        Neon DB（データベース）                       │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐               │
│  │ simulations  │ │service_b_data│ │service_c_data│               │
│  │ テーブル     │ │ テーブル     │ │ テーブル     │               │
│  └──────────────┘ └──────────────┘ └──────────────┘               │
│                                                                    │
│  ┌──────────────┐ ┌──────────────┐                                │
│  │    users     │ │subscriptions │  ← 共通テーブル                 │
│  │  テーブル    │ │  テーブル    │                                │
│  └──────────────┘ └──────────────┘                                │
└────────────────────────────────────────────────────────────────────┘
```

---

## 2. ユーザーフロー（Aさんの例）

```
【新規ユーザー Aさん】

    ①                    ②                     ③
 サイト訪問    →    無料会員登録     →    ダッシュボード
ooya.tech          メール/パスワード         マイページ表示
                   （1回だけ）

                                                │
                         ┌──────────────────────┼──────────────────────┐
                         ▼                      ▼                      ▼
                        ④                     ⑤                      ⑥
                シミュレーター          サービスBを           サービスCは
                 を無料で試す            契約する              まだ契約しない
                         │                      │
                         ▼                      ▼
                        ⑦                     ⑧
                  「便利！契約     →    Stripe決済
                   しよう」             月額500円
                         │
                         ▼
                        ⑨
                  Stripe決済
                  月額1,000円
                         │
                         ▼
┌────────────────────────────────────────────────────────────────────┐
│                     【Aさんの状態】                                  │
│                                                                    │
│  ログイン: 1つ（メールアドレス）                                    │
│  契約中:                                                           │
│    ├── シミュレーター: 月額1,000円                                  │
│    └── サービスB: 月額500円                                        │
│  月額請求: 合計 1,500円（Stripe）                                   │
│  保存データ:                                                       │
│    ├── simulations テーブル → シミュレーション結果                  │
│    └── service_b_data テーブル → サービスBのデータ                  │
└────────────────────────────────────────────────────────────────────┘
```

---

## 3. 契約フロー詳細

```
┌─────────────────────────────────────────────────────────────────┐
│                    サービス契約フロー                             │
└─────────────────────────────────────────────────────────────────┘

   未契約ユーザー          契約ページ            Stripe           契約完了
        │                    │                   │                 │
        │   ①契約ボタン     │                   │                 │
        │ ───────────────▶  │                   │                 │
        │                    │  ②決済リクエスト │                 │
        │                    │ ────────────────▶│                 │
        │                    │                   │                 │
        │                    │  ③決済画面表示   │                 │
        │  ◀─────────────────────────────────────│                 │
        │                    │                   │                 │
        │   ④カード情報入力  │                   │                 │
        │ ──────────────────────────────────────▶│                 │
        │                    │                   │                 │
        │                    │  ⑤Webhook通知    │                 │
        │                    │ ◀────────────────│                 │
        │                    │                   │                 │
        │                    │  ⑥DBに契約保存   │                 │
        │                    │ ─────────────────────────────────▶ │
        │                    │                   │                 │
        │   ⑦契約完了画面    │                   │                 │
        │  ◀─────────────────────────────────────────────────────  │
        │                    │                   │                 │
        ▼                    ▼                   ▼                 ▼

┌─────────────────────────────────────────────────────────────────┐
│  Neon DB: subscriptions テーブルに保存                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ userId: "user_123"                                       │    │
│  │ serviceName: "simulator"                                 │    │
│  │ stripeSubscriptionId: "sub_xxxxx"                        │    │
│  │ status: "active"                                         │    │
│  │ price: 1000                                              │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. データ保存フロー（シミュレーター例）

```
┌─────────────────────────────────────────────────────────────────┐
│                  シミュレーション保存フロー                       │
└─────────────────────────────────────────────────────────────────┘

    Aさん              シミュレーター画面           Neon DB
      │                       │                      │
      │  ①物件情報入力        │                      │
      │ ────────────────────▶│                      │
      │                       │                      │
      │  ②シミュレーション実行│                      │
      │ ────────────────────▶│                      │
      │                       │                      │
      │  ③結果表示            │                      │
      │ ◀────────────────────│                      │
      │                       │                      │
      │  ④「保存」ボタン     │                      │
      │ ────────────────────▶│                      │
      │                       │                      │
      │                       │  ⑤データ保存        │
      │                       │ ───────────────────▶│
      │                       │                      │
      │                       │                      │  simulations
      │                       │                      │  テーブルに保存
      │                       │                      │
      │  ⑥保存完了           │                      │
      │ ◀────────────────────│                      │
      │                       │                      │
      ▼                       ▼                      ▼

┌─────────────────────────────────────────────────────────────────┐
│  simulations テーブル                                            │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ id: "sim_001"                                            │    │
│  │ userId: "user_123"  ← Aさん                              │    │
│  │ propertyName: "サンプルマンション"                        │    │
│  │ data: {                                                  │    │
│  │   price: 50000000,                                       │    │
│  │   yield: 7.5,                                            │    │
│  │   irr: 12.3,                                             │    │
│  │   ...                                                    │    │
│  │ }                                                        │    │
│  │ createdAt: "2025-01-06"                                  │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 技術スタック まとめ

```
┌─────────────────────────────────────────────────────────────────┐
│                        ooya.tech                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│   │  Next.js    │    │   Vercel    │    │  Tailwind   │        │
│   │  (React)    │    │  (ホスティング)│   │   CSS      │        │
│   └─────────────┘    └─────────────┘    └─────────────┘        │
│                                                                  │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│   │  Neon DB    │    │  Neon Auth  │    │   Prisma    │        │
│   │ (PostgreSQL)│    │   (認証)    │    │   (ORM)     │        │
│   └─────────────┘    └─────────────┘    └─────────────┘        │
│                                                                  │
│   ┌─────────────┐    ┌─────────────┐                           │
│   │   Stripe    │    │   Resend    │                           │
│   │   (決済)    │    │  (メール)   │                           │
│   └─────────────┘    └─────────────┘                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. URL構造

```
ooya.tech/                    ← トップページ（ランディング）
ooya.tech/auth/signin         ← ログイン
ooya.tech/auth/signup         ← 新規登録
ooya.tech/dashboard           ← マイページ（契約管理）
ooya.tech/billing             ← 課金管理
│
├── ooya.tech/simulator       ← シミュレーター（月額1,000円）
│
├── ooya.tech/service-b       ← サービスB（月額500円）※将来
│
└── ooya.tech/service-c       ← サービスC（月額2,000円）※将来
```

---

## 7. ポイントまとめ

| 項目 | 内容 |
|------|------|
| ユーザー登録 | **1回だけ**（Neon Auth） |
| ログイン | **共通**（全サービスで同じ） |
| 契約 | **サービスごと**（必要なものだけ） |
| 決済 | **Stripe**（複数商品対応） |
| データ | **1つのDB**（テーブルは分離） |
| 請求 | **合算**（Stripeが自動計算） |

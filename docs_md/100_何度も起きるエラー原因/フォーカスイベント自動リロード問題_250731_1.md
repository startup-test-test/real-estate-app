# フォーカスイベント自動リロード問題

## 概要
GitHub Codespacesの環境で、画面内の何もない箇所をクリックするたびにデータのリロードが発生する問題について記録します。

## 発生日時と症状
- **発生日**: 2025年7月31日
- **場所**: `/bolt_front/src/pages/Dashboard.tsx`
- **環境**: GitHub Codespaces
- **症状**:
  - 画面の任意の場所をクリックするとデータが再読み込みされる
  - コンソールに「ページフォーカス時にデータを更新」のログが頻繁に表示
  - ユーザー体験を著しく損なう

## 問題の原因

### GitHub Codespacesの特殊な動作
```typescript
// 問題のあったコード
React.useEffect(() => {
  const handleFocus = () => {
    const lastUpdate = (window as any).lastDashboardUpdate || 0;
    const now = Date.now();
    if (now - lastUpdate > 5000) {
      console.log('ページフォーカス時にデータを更新');
      (window as any).lastDashboardUpdate = now;
      loadSimulations(true);
    }
  };

  window.addEventListener('focus', handleFocus);
  return () => window.removeEventListener('focus', handleFocus);
}, []);
```

### 原因の詳細
1. **GitHub Codespacesでのfocusイベントの挙動**
   - 通常の環境では、`focus`イベントはウィンドウやタブがフォーカスを得たときに発火
   - GitHub Codespacesでは、画面内のクリックでも`focus`イベントが発火する
   - これは仮想環境特有の挙動の可能性がある

2. **問題の流れ**
   ```
   1. ユーザーが画面の任意の場所をクリック
   2. focusイベントが発火
   3. handleFocus関数が実行される
   4. 5秒以上経過していればデータが再読み込みされる
   5. UIが一瞬ちらつく
   ```

## 実装した解決策

### visibilitychangeイベントへの変更
```typescript
// 修正後のコード
React.useEffect(() => {
  const handleVisibilityChange = () => {
    if (document.visibilityState === 'visible') {
      const lastUpdate = (window as any).lastDashboardUpdate || 0;
      const now = Date.now();
      // 最後の更新から10秒以上経過していたら更新
      if (now - lastUpdate > 10000) {
        console.log('タブが表示されたときにデータを更新');
        (window as any).lastDashboardUpdate = now;
        loadSimulations(true);
      }
    }
  };

  document.addEventListener('visibilitychange', handleVisibilityChange);
  return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
}, []);
```

### 解決策の利点
1. **クリックによる誤動作の防止**
   - `visibilitychange`はタブの表示/非表示の切り替え時のみ発火
   - 画面内のクリックでは発火しない

2. **適切なタイミングでの更新**
   - ユーザーが他のタブで作業後、戻ってきたときに更新
   - 本来の目的である「最新データの表示」を維持

3. **更新間隔の調整**
   - 5秒から10秒に延長し、頻繁な更新を防止

## 他の検討された解決策

### 1. フォーカス時の自動更新を完全に無効化
```typescript
// 自動更新を完全に削除する案
// React.useEffect(() => { ... }, []); // この部分を削除
```

**メリット**:
- 不要なリロードが完全になくなる
- パフォーマンスの向上

**デメリット**:
- 他のタブで編集した内容が自動反映されない
- 手動でリロードボタンを押す必要がある
- ユーザー体験の低下

### 2. イベントの詳細な条件分岐
```typescript
const handleFocus = (event: FocusEvent) => {
  // イベントのターゲットを確認
  if (event.target === window) {
    // ウィンドウレベルのフォーカスのみ処理
  }
};
```

**課題**:
- GitHub Codespacesでは効果がない可能性
- 環境依存の実装になる

## デバッグ方法

### 1. イベントの発火確認
```typescript
window.addEventListener('focus', (e) => {
  console.log('Focus event:', {
    target: e.target,
    currentTarget: e.currentTarget,
    timestamp: new Date().toISOString()
  });
});
```

### 2. visibilitychangeの動作確認
```typescript
document.addEventListener('visibilitychange', () => {
  console.log('Visibility changed:', {
    visibilityState: document.visibilityState,
    hidden: document.hidden,
    timestamp: new Date().toISOString()
  });
});
```

## ベストプラクティス

### 1. 環境に応じた実装
```typescript
// 開発環境と本番環境で挙動を変える
const isDevelopment = process.env.NODE_ENV === 'development';
const isCodespaces = window.location.hostname.includes('github.dev');

if (!isDevelopment || !isCodespaces) {
  // 本番環境では通常のfocusイベントを使用
}
```

### 2. デバウンス処理の実装
```typescript
const debounce = (func: Function, wait: number) => {
  let timeout: NodeJS.Timeout;
  return (...args: any[]) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  };
};

const debouncedUpdate = debounce(() => {
  loadSimulations(true);
}, 1000);
```

### 3. ユーザー設定の提供
```typescript
// ユーザーが自動更新をオン/オフできる設定
const [autoRefreshEnabled, setAutoRefreshEnabled] = useState(true);

React.useEffect(() => {
  if (!autoRefreshEnabled) return;
  // 自動更新の処理
}, [autoRefreshEnabled]);
```

## 関連する問題と対策

### 1. 過度な API 呼び出し
- スロットリングやデバウンスの実装
- キャッシュの活用
- 条件付き更新の実装

### 2. 状態の不整合
- 楽観的更新の実装
- 適切なローディング状態の表示
- エラーハンドリングの強化

## まとめ
GitHub Codespacesのような仮想環境では、ブラウザイベントの挙動が通常と異なる場合があります。`focus`イベントの代わりに`visibilitychange`イベントを使用することで、より安定した動作を実現できました。開発時は必ず実際の使用環境でテストを行い、環境特有の問題に対処することが重要です。
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>個人メディア キーワード分類ビューア</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f0f2f5; color: #1a1a1a; }
  .header { background: #1e293b; color: #fff; padding: 8px 20px; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; z-index: 20; height: 40px; }
  .header h1 { font-size: 16px; white-space: nowrap; }
  .header .sub { font-size: 12px; color: #94a3b8; }
  .header .updated { font-size: 11px; color: #94a3b8; margin-left: auto; }

  .main { max-width: 1400px; margin: 0 auto; padding: 16px; }

  /* Stats */
  .stats { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
  .stat-card { background: #fff; border-radius: 6px; padding: 10px 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); min-width: 120px; }
  .stat-card .label { font-size: 11px; color: #64748b; }
  .stat-card .value { font-size: 20px; font-weight: 700; }
  .stat-card.total .value { color: #1e293b; }
  .stat-card.exp .value { color: #ea580c; }
  .stat-card.guide .value { color: #2563eb; }
  .stat-card.delete .value { color: #9ca3af; }
  .stat-card.vol .value { color: #16a34a; font-size: 16px; }
  .stat-card.filtered .value { color: #7c3aed; }

  /* フィルター */
  .filters { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
  .filter-btn { padding: 4px 12px; border: 1px solid #d1d5db; border-radius: 20px; font-size: 11px; cursor: pointer; background: #fff; }
  .filter-btn:hover { background: #f1f5f9; }
  .filter-btn.active { background: #1e293b; color: #fff; border-color: #1e293b; }

  /* トピックフィルター */
  .topic-filters { display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap; }
  .topic-btn { padding: 3px 10px; border: 1px solid #e2e8f0; border-radius: 14px; font-size: 10px; cursor: pointer; background: #fff; color: #475569; }
  .topic-btn:hover { background: #f1f5f9; }
  .topic-btn.active { background: #475569; color: #fff; border-color: #475569; }

  /* 数値フィルター */
  .num-filters { display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; }
  .num-filter-group { display: flex; align-items: center; gap: 6px; }
  .num-filter-group .group-label { font-size: 11px; font-weight: 600; color: #475569; white-space: nowrap; }
  .num-filter-group select { padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 11px; background: #fff; cursor: pointer; }

  /* 検索 */
  .kw-search { margin-bottom: 12px; }
  .kw-search input { padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; width: 300px; }

  /* テーブル */
  .table-wrap { border-radius: 6px; overflow: auto; max-height: calc(100vh - 42px); box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
  table { border-collapse: collapse; font-size: 12px; background: #fff; width: 100%; }
  th { background: #1e293b; color: #fff; padding: 8px 10px; text-align: left; position: sticky; top: 0; z-index: 15; white-space: nowrap; font-weight: 500; font-size: 11px; cursor: pointer; }
  th:hover { background: #334155; }
  th .sort-icon { font-size: 9px; margin-left: 4px; }
  td { border-bottom: 1px solid #f1f5f9; padding: 6px 10px; max-width: 400px; overflow: hidden; text-overflow: ellipsis; }
  tr:hover { background: #f8fafc; }

  /* 判定スタイル */
  tr.row-exp { border-left: 3px solid #ea580c; }
  tr.row-guide { border-left: 3px solid #2563eb; }
  tr.row-delete { border-left: 3px solid #e5e7eb; opacity: 0.5; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 10px; font-weight: 600; }
  .badge-exp { background: #fff7ed; color: #c2410c; }
  .badge-guide { background: #dbeafe; color: #1e40af; }
  .badge-delete { background: #f3f4f6; color: #9ca3af; }
  .badge-target { background: #fef9c3; color: #a16207; font-size: 12px; }
  .badge-review { background: #fee2e2; color: #dc2626; }
  .filter-btn.review { border-color: #dc2626; color: #dc2626; }
  .filter-btn.review.active { background: #dc2626; color: #fff; border-color: #dc2626; }
  tr.row-review { background: #fef2f2; }

  .footer { padding: 8px; font-size: 11px; color: #94a3b8; }
  .empty { text-align: center; padding: 60px; color: #94a3b8; font-size: 14px; }
</style>
</head>
<body>
<div class="header">
  <h1>個人メディア キーワード分類</h1>
  <span class="sub">不動産投資 — 実体験ベース記事コンテンツ</span>
  <span class="updated" id="updated"></span>
</div>
<div class="main" id="main">
  <div class="empty">読み込み中...</div>
</div>

<script>
let allData = [];
let currentFilter = 'all';
let currentTopic = 'all';
let currentKdMax = 'all';
let currentVolMin = 'all';
let currentPageGroup = 'all';
let currentCategory = 'all';
let sortCol = -1;
let sortAsc = true;

async function loadData() {
  try {
    const basePath = decodeURIComponent(location.pathname).includes('/プレビュー用/')
      ? '../個人メディアのキーワード分析/'
      : '個人メディアのキーワード分析/';
    const res = await fetch(basePath + encodeURIComponent('不動産投資_個人メディア_判定済み.tsv') + '?t=' + Date.now());
    const text = await res.text();
    const rows = text.trim().split('\n').map(r => r.split('\t'));
    allData = rows;
    render();
    document.getElementById('updated').textContent = '最終読込: ' + new Date().toLocaleString('ja-JP');
  } catch (e) {
    document.getElementById('main').innerHTML = '<div class="empty">読み込みに失敗しました</div>';
  }
}

function render() {
  if (allData.length < 2) {
    document.getElementById('main').innerHTML = '<div class="empty">データなし</div>';
    return;
  }
  const header = allData[0];
  const data = allData.slice(1).filter(r => r.length >= 6);

  // Stats
  let expCount = 0, guideCount = 0, deleteCount = 0, reviewCount = 0;
  let totalVol = 0, expVol = 0, guideVol = 0;
  const topicMap = {};

  data.forEach(r => {
    const 判定 = (r[5] || '').trim();
    const vol = parseInt(r[4]) || 0;
    const topic = (r[8] || '').trim();
    const review = (r[10] || '').trim();
    if (判定 === '体験記事') { expCount++; expVol += vol; }
    else if (判定 === '解説記事') { guideCount++; guideVol += vol; }
    else if (判定 === '削除') { deleteCount++; }
    if (review === '要確認') { reviewCount++; }
    if (判定 !== '削除') totalVol += vol;
    if (topic && 判定 !== '削除') {
      topicMap[topic] = (topicMap[topic] || 0) + 1;
    }
  });

  // Filter by 判定
  let filtered = data;
  if (currentFilter === 'exp') filtered = filtered.filter(r => (r[5]||'').trim() === '体験記事');
  else if (currentFilter === 'guide') filtered = filtered.filter(r => (r[5]||'').trim() === '解説記事');
  else if (currentFilter === 'delete') filtered = filtered.filter(r => (r[5]||'').trim() === '削除');
  else if (currentFilter === 'review') filtered = filtered.filter(r => (r[10]||'').trim() === '要確認');

  // Topic filter
  if (currentTopic !== 'all') {
    filtered = filtered.filter(r => (r[8]||'').trim() === currentTopic);
  }

  // カテゴリフィルター
  if (currentCategory !== 'all') {
    filtered = filtered.filter(r => (r[13]||'').trim() === currentCategory);
  }

  // ページグループフィルター
  if (currentPageGroup !== 'all') {
    filtered = filtered.filter(r => (r[11]||'').trim() === currentPageGroup);
  }

  // SEO難易度フィルター
  if (currentKdMax !== 'all') {
    const maxKd = parseInt(currentKdMax);
    filtered = filtered.filter(r => {
      const kd = (r[3]||'').trim();
      if (kd === 'N/A' || kd === '') return true;
      const kdVal = parseInt(kd);
      return !isNaN(kdVal) && kdVal <= maxKd;
    });
  }

  // 月間検索数フィルター
  if (currentVolMin !== 'all') {
    const minVol = parseInt(currentVolMin);
    filtered = filtered.filter(r => {
      const vol = parseInt(r[4]) || 0;
      return vol >= minVol;
    });
  }

  // Keyword search
  const kwFilter = document.getElementById('kwSearch') ? document.getElementById('kwSearch').value : '';
  if (kwFilter) {
    filtered = filtered.filter(r => (r[2]||'').includes(kwFilter));
  }

  // Sort
  if (sortCol >= 0) {
    filtered.sort((a, b) => {
      let va = (a[sortCol] || '').trim();
      let vb = (b[sortCol] || '').trim();
      if (sortCol === 3 || sortCol === 4) {
        va = parseFloat(va) || 0;
        vb = parseFloat(vb) || 0;
        return sortAsc ? va - vb : vb - va;
      }
      return sortAsc ? va.localeCompare(vb, 'ja') : vb.localeCompare(va, 'ja');
    });
  }

  let html = '';

  // Stats
  html += '<div class="stats">';
  html += '<div class="stat-card total"><div class="label">合計キーワード</div><div class="value">' + data.length + '</div></div>';
  html += '<div class="stat-card exp"><div class="label">体験記事</div><div class="value">' + expCount + '</div></div>';
  html += '<div class="stat-card guide"><div class="label">解説記事</div><div class="value">' + guideCount + '</div></div>';
  html += '<div class="stat-card delete"><div class="label">削除</div><div class="value">' + deleteCount + '</div></div>';
  html += '<div class="stat-card vol"><div class="label">有効KW検索Vol合計</div><div class="value">' + totalVol.toLocaleString() + '</div></div>';
  html += '<div class="stat-card filtered"><div class="label">絞り込み結果</div><div class="value">' + filtered.length + '</div></div>';
  html += '</div>';

  // 判定フィルター
  html += '<div class="filters">';
  html += '<div class="filter-btn' + (currentFilter==='all'?' active':'') + '" onclick="setFilter(\'all\')">すべて (' + data.length + ')</div>';
  html += '<div class="filter-btn' + (currentFilter==='exp'?' active':'') + '" onclick="setFilter(\'exp\')">体験記事 (' + expCount + ')</div>';
  html += '<div class="filter-btn' + (currentFilter==='guide'?' active':'') + '" onclick="setFilter(\'guide\')">解説記事 (' + guideCount + ')</div>';
  html += '<div class="filter-btn' + (currentFilter==='delete'?' active':'') + '" onclick="setFilter(\'delete\')">削除 (' + deleteCount + ')</div>';
  html += '<div class="filter-btn review' + (currentFilter==='review'?' active':'') + '" onclick="setFilter(\'review\')">要確認 (' + reviewCount + ')</div>';
  html += '</div>';

  // カテゴリ・SEO難易度・月間検索数フィルター
  html += '<div class="num-filters">';

  // カテゴリ
  const catMap = {};
  data.forEach(r => {
    const cat = (r[13]||'').trim();
    if (cat) catMap[cat] = (catMap[cat]||0) + 1;
  });
  const sortedCats = Object.entries(catMap).sort((a, b) => b[1] - a[1]);
  html += '<div class="num-filter-group">';
  html += '<span class="group-label">カテゴリ:</span>';
  html += '<select onchange="setCategory(this.value)">';
  html += '<option value="all"' + (currentCategory==='all'?' selected':'') + '>すべて</option>';
  sortedCats.forEach(function([cat, cnt]) {
    html += '<option value="' + cat.replace(/"/g,'&quot;') + '"' + (currentCategory===cat?' selected':'') + '>' + cat + ' (' + cnt + ')</option>';
  });
  html += '</select>';
  html += '</div>';

  html += '<div class="num-filter-group">';
  html += '<span class="group-label">SEO難易度:</span>';
  html += '<select onchange="setKdMax(this.value)">';
  html += '<option value="all"' + (currentKdMax==='all'?' selected':'') + '>すべて</option>';
  html += '<option value="10"' + (currentKdMax==='10'?' selected':'') + '>10以下</option>';
  html += '<option value="20"' + (currentKdMax==='20'?' selected':'') + '>20以下</option>';
  html += '<option value="30"' + (currentKdMax==='30'?' selected':'') + '>30以下</option>';
  html += '<option value="40"' + (currentKdMax==='40'?' selected':'') + '>40以下</option>';
  html += '<option value="50"' + (currentKdMax==='50'?' selected':'') + '>50以下</option>';
  html += '</select>';
  html += '</div>';
  html += '<div class="num-filter-group">';
  html += '<span class="group-label">月間検索数:</span>';
  html += '<select onchange="setVolMin(this.value)">';
  html += '<option value="all"' + (currentVolMin==='all'?' selected':'') + '>すべて</option>';
  html += '<option value="10"' + (currentVolMin==='10'?' selected':'') + '>10以上</option>';
  html += '<option value="50"' + (currentVolMin==='50'?' selected':'') + '>50以上</option>';
  html += '<option value="100"' + (currentVolMin==='100'?' selected':'') + '>100以上</option>';
  html += '<option value="500"' + (currentVolMin==='500'?' selected':'') + '>500以上</option>';
  html += '<option value="1000"' + (currentVolMin==='1000'?' selected':'') + '>1,000以上</option>';
  html += '<option value="5000"' + (currentVolMin==='5000'?' selected':'') + '>5,000以上</option>';
  html += '</select>';
  html += '</div>';
  // ページグループフィルター
  const pgMap = {};
  data.forEach(r => {
    const pg = (r[11]||'').trim();
    if (pg) pgMap[pg] = (pgMap[pg]||0) + 1;
  });
  const sortedPgs = Object.entries(pgMap).sort((a, b) => b[1] - a[1]);
  html += '<div class="num-filter-group">';
  html += '<span class="group-label">ページグループ:</span>';
  html += '<select onchange="setPageGroup(this.value)">';
  html += '<option value="all"' + (currentPageGroup==='all'?' selected':'') + '>すべて</option>';
  sortedPgs.forEach(function([pg, cnt]) {
    html += '<option value="' + pg.replace(/"/g,'&quot;') + '"' + (currentPageGroup===pg?' selected':'') + '>' + pg + ' (' + cnt + ')</option>';
  });
  html += '</select>';
  html += '</div>';
  html += '</div>';

  // Topic filters
  const sortedTopics = Object.entries(topicMap).sort((a, b) => b[1] - a[1]);
  if (sortedTopics.length > 0) {
    html += '<div class="topic-filters">';
    html += '<div class="topic-btn' + (currentTopic==='all'?' active':'') + '" onclick="setTopic(\'all\')">全トピック</div>';
    sortedTopics.forEach(([topic, count]) => {
      html += '<div class="topic-btn' + (currentTopic===topic?' active':'') + '" onclick="setTopic(\'' + topic.replace(/'/g, "\\'") + '\')">' + topic + ' (' + count + ')</div>';
    });
    html += '</div>';
  }

  // Search
  html += '<div class="kw-search"><input type="text" id="kwSearch" placeholder="キーワード検索..." oninput="rerender()" value="' + (kwFilter||'') + '"></div>';

  // 非表示列: ページ種類(7), トピック(8)はページグループに統合
  const hideCols = [7, 8];

  // Table
  html += '<div class="table-wrap"><table><tr>';
  header.forEach((h, i) => {
    if (hideCols.includes(i)) return;
    const icon = sortCol === i ? (sortAsc ? '▲' : '▼') : '';
    html += '<th onclick="setSort(' + i + ')">' + h + '<span class="sort-icon">' + icon + '</span></th>';
  });
  html += '</tr>';

  filtered.forEach(row => {
    const 判定 = (row[5] || '').trim();
    const review = (row[10] || '').trim();
    let cls = '';
    if (review === '要確認') cls = 'row-review';
    else if (判定 === '体験記事') cls = 'row-exp';
    else if (判定 === '解説記事') cls = 'row-guide';
    else if (判定 === '削除') cls = 'row-delete';

    html += '<tr class="' + cls + '">';
    row.forEach((cell, j) => {
      if (hideCols.includes(j)) return;
      cell = (cell||'').trim();
      let display = cell.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

      // 判定列にバッジ
      if (j === 5) {
        if (cell === '体験記事') display = '<span class="badge badge-exp">' + display + '</span>';
        else if (cell === '解説記事') display = '<span class="badge badge-guide">' + display + '</span>';
        else if (cell === '削除') display = '<span class="badge badge-delete">' + display + '</span>';
      }
      // 月間検索数をフォーマット
      if (j === 4 && !isNaN(cell) && cell !== '') {
        display = Number(cell).toLocaleString();
      }
      // 狙い目列にバッジ
      if (j === 9 && cell === '◎') {
        display = '<span class="badge badge-target">◎</span>';
      }
      // 要確認列にバッジ
      if (j === 10 && cell === '要確認') {
        display = '<span class="badge badge-review">要確認</span>';
      }
      html += '<td>' + display + '</td>';
    });
    html += '</tr>';
  });
  html += '</table></div>';
  html += '<div class="footer">表示: ' + filtered.length + '件 / ' + data.length + '件</div>';

  document.getElementById('main').innerHTML = html;
}

function setFilter(f) {
  currentFilter = f;
  rerender();
}

function setTopic(t) {
  currentTopic = t;
  rerender();
}

function setKdMax(v) {
  currentKdMax = v;
  rerender();
}

function setVolMin(v) {
  currentVolMin = v;
  rerender();
}

function setPageGroup(v) {
  currentPageGroup = v;
  rerender();
}

function setCategory(v) {
  currentCategory = v;
  rerender();
}

function setSort(col) {
  if (sortCol === col) { sortAsc = !sortAsc; }
  else { sortCol = col; sortAsc = true; }
  rerender();
}

function rerender() {
  if (allData.length > 0) render();
}

loadData();
</script>
</body>
</html>

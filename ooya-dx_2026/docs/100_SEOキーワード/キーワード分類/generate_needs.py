#!/usr/bin/env python3
"""検索キーワードごとに「解決ニーズ」（ユーザーが具体的に解決したい内容）を自動生成する"""
import re

FILEPATH = '/Users/tetzlow/real-estate-app/ooya-dx_2026/docs/100_SEOキーワード/キーワード分類/仲介手数料_判定済み.tsv'
COL_NAME = '解決ニーズ'

# --- パターン定義 ---
# (正規表現, 解決ニーズ文) のリスト。上から順に評価、最初にマッチしたものを採用
PATTERNS = [
    # ===== 支払い時期・方法 =====
    (r'いつ払う|支払いタイミング|払うタイミング', '仲介手数料を払うタイミング（契約時？引渡時？）を確認したい'),
    (r'クレジットカード', '仲介手数料をクレジットカードで支払えるか知りたい'),
    (r'paypay', '仲介手数料をPayPayで支払えるか知りたい'),
    (r'先払い', '仲介手数料は先払い（前払い）が必要か確認したい'),
    (r'後払い', '仲介手数料を後払いにできるか知りたい'),
    (r'現金$', '仲介手数料は現金払いが必須なのか確認したい'),
    (r'毎月払う', '仲介手数料は毎月の支払いか一括か確認したい'),
    (r'分割払い', '仲介手数料を分割払いできるか知りたい'),
    (r'仲介手数料 分割$', '仲介手数料を分割で支払えるか知りたい'),

    # ===== 書類・手続き =====
    (r'請求書\s*ひな形', '仲介手数料の請求書テンプレート・ひな形を入手したい'),
    (r'請求書$', '仲介手数料の請求書の書式・記載事項を確認したい'),
    (r'領収書\s*印紙', '仲介手数料の領収書に収入印紙が必要か確認したい'),
    (r'領収書\s*但し書き', '仲介手数料の領収書の但し書きの正しい書き方を知りたい'),
    (r'領収書$', '仲介手数料の領収書の発行方法・書式を確認したい'),
    (r'見積書', '仲介手数料の見積書に記載すべき内容を確認したい'),
    (r'契約書', '契約書における仲介手数料の記載内容・確認ポイントを知りたい'),
    (r'覚書', '仲介手数料に関する覚書の作成方法を知りたい'),
    (r'約定書', '仲介手数料の約定書の内容を確認したい'),
    (r'表$', '仲介手数料の価格帯別一覧表を見たい'),

    # ===== 返金・トラブル =====
    (r'返還請求', '支払った仲介手数料を返還請求できるか・方法を知りたい'),
    (r'返金', '契約キャンセル時に仲介手数料が返金されるか知りたい'),
    (r'ぼったくられた', '仲介手数料を不当に高く取られた場合の対処法を知りたい'),
    (r'クレーム', '仲介手数料に関するクレーム・苦情の対処法を知りたい'),
    (r'拒否', '仲介手数料の支払いを拒否できるケースを知りたい'),
    (r'未払い', '仲介手数料を未払いにした場合どうなるか知りたい'),
    (r'二重取り|二重$', '仲介手数料の二重取りが違法かどうか確認したい'),
    (r'抜き行為', '仲介手数料の抜き行為（中抜き）が問題ないか知りたい'),

    # ===== 金額感・判断 =====
    (r'高い理由', '仲介手数料がなぜ高額なのか理由を理解したい'),
    (r'高い$|高すぎる', '自分が払う仲介手数料が適正額か判断したい'),
    (r'安くする', '仲介手数料を安くする具体的な方法を知りたい'),
    (r'値段$|値段は', '仲介手数料がいくらかかるか金額を知りたい'),
    (r'満額', '仲介手数料の満額（上限いっぱい）がいくらか知りたい'),
    (r'正規', '仲介手数料の正規料金（法定上限）を確認したい'),
    (r'定額', '仲介手数料が定額制の不動産会社があるか知りたい'),
    (r'額$', '仲介手数料の具体的な金額を知りたい'),
    (r'どれくらい', '仲介手数料がだいたいどれくらいかかるか知りたい'),

    # ===== 誰が払う・負担 =====
    (r'誰が払う', '仲介手数料は売主・買主のどちらが払うのか知りたい'),
    (r'どちらが払う', '仲介手数料の負担者（売主・買主）を確認したい'),
    (r'売主\s*買主\s*両方', '仲介手数料は売主・買主の両方が払うのか確認したい'),
    (r'売り手\s*買い手', '仲介手数料の売り手・買い手の負担割合を知りたい'),
    (r'売主\s*買主', '仲介手数料は売主と買主それぞれいくらか知りたい'),
    (r'折半', '仲介手数料を売主・買主で折半できるか知りたい'),
    (r'売主$', '売主側の仲介手数料の仕組みを知りたい'),

    # ===== 両手・片手・分かれ =====
    (r'両手取り', '両手取り（両手仲介）の仕組みと注意点を知りたい'),
    (r'両手とは', '両手仲介とは何か・片手との違いを理解したい'),
    (r'両手$', '両手仲介の仕組みと手数料の流れを知りたい'),
    (r'分かれとは', '「分かれ」の意味と手数料の分配方法を知りたい'),
    (r'分かれ$', '仲介手数料の「分かれ」の仕組みを理解したい'),

    # ===== ローン・融資 =====
    (r'ローンに組み込む', '仲介手数料を住宅ローンに含めて借りられるか知りたい'),
    (r'住宅ローン', '仲介手数料を住宅ローンに組み込めるか確認したい'),
    (r'ローン特約', '仲介手数料のローン特約（ローン不成立時の扱い）を知りたい'),
    (r'ローン$', '仲介手数料とローンの関係を理解したい'),
    (r'融資', '仲介手数料を融資に組み込めるか確認したい'),

    # ===== 基礎・定義 =====
    (r'とは\s*簡単に', '仲介手数料の仕組みをわかりやすく理解したい'),
    (r'とは\s*不動産', '不動産取引における仲介手数料の仕組みを理解したい'),
    (r'とは$', '仲介手数料とは何か基本を理解したい'),
    (r'意味$', '仲介手数料の意味・定義を理解したい'),
    (r'定義$', '仲介手数料の正式な定義を確認したい'),
    (r'仕組み', '仲介手数料の仕組み（誰が誰に払うか）を理解したい'),
    (r'必要$', '仲介手数料が本当に必要なのか確認したい'),
    (r'メリット', '仲介手数料を払うメリット・払わない場合のリスクを知りたい'),
    (r'ビジネス', '仲介手数料のビジネスモデル・収益構造を理解したい'),
    (r'義務$', '仲介手数料の支払いが法的義務かどうか確認したい'),
    (r'原則$', '仲介手数料の基本原則・ルールを確認したい'),
    (r'決まり', '仲介手数料の決まり・規定を確認したい'),
    (r'内訳', '仲介手数料の内訳（何に使われているか）を知りたい'),
    (r'成功報酬', '仲介手数料は成功報酬なのか確認したい'),
    (r'費用$', '仲介手数料がどの程度の費用になるか知りたい'),
    (r'出し方', '仲介手数料の算出方法を知りたい'),
    (r'求め方', '仲介手数料の求め方・計算手順を知りたい'),
    (r'会社によって違う', '不動産会社によって仲介手数料が異なる理由を知りたい'),
    (r'どこに書いてある', '仲介手数料の金額が書かれている書類・場所を知りたい'),
    (r'書いてない|記載なし', '仲介手数料の記載がない場合の対処法を知りたい'),
    (r'仲介手数料 手数料$', '仲介手数料と他の手数料の違いを整理したい'),
    (r'事務手数料', '仲介手数料と事務手数料の違いを知りたい'),
    (r'弁護士', '仲介手数料のトラブルで弁護士に相談すべきか知りたい'),

    # ===== AD関連 =====
    (r'ad\s*違い', '仲介手数料のAD（広告料）との違いを知りたい'),
    (r'ad$', '仲介手数料のAD（広告料）の仕組みを知りたい'),

    # ===== 印紙・税関連 =====
    (r'収入印紙', '仲介手数料の支払いに収入印紙が必要か知りたい'),
    (r'印紙代', '仲介手数料にかかる印紙代の金額を知りたい'),
    (r'印紙$', '仲介手数料の領収書・契約書の印紙税を確認したい'),

    # ===== 業者・代理 =====
    (r'業者間', '不動産業者間取引の仲介手数料の扱いを知りたい'),
    (r'業者売主', '業者が売主の場合の仲介手数料を確認したい'),
    (r'代理$', '代理契約の場合の仲介手数料を確認したい'),
    (r'電話問い合わせ', '仲介手数料について電話で問い合わせる方法を知りたい'),

    # ===== 交渉・値引き =====
    (r'値切る客|値切る', '仲介手数料を値切る方法・コツを知りたい'),
    (r'値切れ', '仲介手数料は実際に値切れるのか知りたい'),
    (r'払いたくない', '仲介手数料を払わずに済む方法があるか知りたい'),
    (r'なくすには', '仲介手数料をなくす方法があるか知りたい'),
    (r'下げる', '仲介手数料を下げる具体的な交渉方法を知りたい'),
    (r'抑えたい', '仲介手数料をできるだけ抑える方法を知りたい'),
    (r'減額', '仲介手数料の減額交渉の方法を知りたい'),
    (r'払わなくていい', '仲介手数料を払わなくていいケースがあるか知りたい'),
    (r'相見積もり', '仲介手数料を相見積もりで比較する方法を知りたい'),
    (r'キャンペーン', '仲介手数料キャンペーン（割引）を実施している会社を探したい'),
    (r'キャッシュバック', '仲介手数料のキャッシュバックがある会社を探したい'),
    (r'かからない方法', '仲介手数料がかからない取引方法を知りたい'),
    (r'抑える方法', '仲介手数料を抑える具体的な方法を知りたい'),
    (r'割引', '仲介手数料の割引がある不動産会社を探したい'),
    (r'値下げ', '仲介手数料の値下げ交渉のやり方を知りたい'),
    (r'交渉$', '仲介手数料の交渉方法・成功するコツを知りたい'),
    (r'ランキング', '仲介手数料が安い不動産会社のランキングを見たい'),
    (r'比較$', '不動産会社の仲介手数料を比較したい'),

    # ===== 無料・ゼロ =====
    (r'(?:手数料\s*)?0$', '仲介手数料が無料（0円）の不動産会社を探したい'),
    (r'0円|ゼロ$', '仲介手数料ゼロ円の物件・会社を探したい'),
    (r'不要$', '仲介手数料が不要なケースを知りたい'),
    (r'9800円', '仲介手数料9,800円の仕組みを知りたい'),
    (r'なし$', '仲介手数料なし（無料）の不動産会社があるか知りたい'),
    (r'無料\s*からくり', '仲介手数料無料のからくり・裏側を知りたい'),
    (r'無料\s*仕組み', '仲介手数料無料の仕組みを理解したい'),
    (r'無料\s*デメリット', '仲介手数料無料のデメリット・リスクを知りたい'),
    (r'無料\s*理由', '仲介手数料が無料にできる理由を知りたい'),
    (r'無料\s*注意点', '仲介手数料無料の物件の注意点を知りたい'),
    (r'無料\s*罠', '仲介手数料無料の裏に隠された罠を知りたい'),
    (r'無料\s*怪しい', '仲介手数料無料が怪しくないか確認したい'),
    (r'無料\s*なぜ', '仲介手数料が無料にできる理由を知りたい'),
    (r'無料\s*不動産', '仲介手数料無料の不動産会社を探したい'),
    (r'無料\s*賃貸', '仲介手数料無料の賃貸物件を探したい'),
    (r'無料\s*売買', '仲介手数料無料で売買できる方法を知りたい'),
    (r'無料\s*中古', '仲介手数料無料の中古物件を探したい'),
    (r'無料\s*新築', '仲介手数料無料の新築物件を探したい'),
    (r'無料', '仲介手数料が無料の不動産会社の仕組みを知りたい'),

    # ===== 賃貸 =====
    (r'一人暮らし', '一人暮らしの賃貸で仲介手数料がいくらか知りたい'),
    (r'共益費|管理費', '仲介手数料に共益費・管理費が含まれるか知りたい'),
    (r'借主$', '借主が負担する仲介手数料の金額を知りたい'),
    (r'0\.55ヶ月|半月|半分', '仲介手数料0.55ヶ月分（半額）の根拠を知りたい'),
    (r'0\.5ヶ月', '仲介手数料0.5ヶ月分の法的根拠を知りたい'),
    (r'1ヶ月', '仲介手数料1ヶ月分は上限なのか確認したい'),
    (r'2ヶ月', '仲介手数料が2ヶ月分請求された場合の対処を知りたい'),
    (r'何ヶ月|ヶ月分', '仲介手数料が家賃何ヶ月分か知りたい'),
    (r'ヶ月$|か月$', '仲介手数料が家賃何ヶ月分か確認したい'),
    (r'オーナー|大家', '大家・オーナーが払う仲介手数料の仕組みを知りたい'),
    (r'オフィス', 'オフィス・事務所賃貸の仲介手数料を知りたい'),
    (r'店舗', '店舗賃貸の仲介手数料の相場を知りたい'),
    (r'住み替え', '住み替え時の仲介手数料（売却+購入）を知りたい'),
    (r'礼金', '仲介手数料と礼金の違い・合計費用を知りたい'),
    (r'生活保護', '生活保護受給者の仲介手数料の扱いを知りたい'),
    (r'アパート$', 'アパート賃貸の仲介手数料の相場を知りたい'),
    (r'駐車場', '駐車場賃貸の仲介手数料がいくらか知りたい'),
    (r'賃貸\s*相場', '賃貸の仲介手数料の相場を知りたい'),
    (r'賃貸\s*上限', '賃貸の仲介手数料の法定上限を知りたい'),
    (r'賃貸\s*計算', '賃貸の仲介手数料を計算したい'),
    (r'賃貸$', '賃貸物件の仲介手数料がいくらか知りたい'),

    # ===== 不動産売買 =====
    (r'建売', '建売住宅購入時の仲介手数料を知りたい'),
    (r'中古住宅', '中古住宅の仲介手数料がいくらか知りたい'),
    (r'購入$', '不動産購入時の仲介手数料を知りたい'),
    (r'建物$', '建物の仲介手数料の計算方法を知りたい'),
    (r'手付金', '仲介手数料と手付金の違い・支払い順序を知りたい'),
    (r'手付解除', '手付解除した場合の仲介手数料の扱いを知りたい'),
    (r'売却$', '不動産売却時の仲介手数料がいくらか知りたい'),
    (r'分譲', '分譲マンション・分譲住宅の仲介手数料を知りたい'),
    (r'マンション', 'マンション売買の仲介手数料を知りたい'),
    (r'戸建', '戸建て売買の仲介手数料を知りたい'),
    (r'土地$', '土地売買の仲介手数料を知りたい'),
    (r'新築', '新築購入時の仲介手数料がかかるか知りたい'),

    # ===== 法律・上限 =====
    (r'宅建業法', '宅建業法における仲介手数料の規定を確認したい'),
    (r'宅建$', '宅建業法での仲介手数料の上限規定を知りたい'),
    (r'下限$', '仲介手数料に下限額があるか確認したい'),
    (r'国土交通省', '国交省が定める仲介手数料の基準を確認したい'),
    (r'最大$', '仲介手数料の最大額（法定上限）を知りたい'),
    (r'法定$', '仲介手数料の法定上限額を確認したい'),
    (r'限度$', '仲介手数料の限度額を確認したい'),
    (r'上限$', '仲介手数料の法定上限額を確認したい'),
    (r'空き家|低廉', '800万円以下の低廉な空き家の仲介手数料特例を知りたい'),
    (r'特例', '仲介手数料の特例（低廉物件等）の内容を知りたい'),
    (r'ルール$', '仲介手数料のルール・決まりを確認したい'),
    (r'料率', '仲介手数料の料率（%）を確認したい'),
    (r'(?<!料)率$', '仲介手数料の手数料率を確認したい'),
    (r'割合$', '仲介手数料の割合（物件価格に対する%）を知りたい'),
    (r'法定調書', '仲介手数料の法定調書の作成方法を知りたい'),
    (r'改正|改定', '仲介手数料の法改正の内容を知りたい'),
    (r'ガイドライン', '仲介手数料のガイドライン・指針を確認したい'),

    # ===== 会計・経費 =====
    (r'勘定科目', '仲介手数料の正しい勘定科目を知りたい'),
    (r'仕訳', '仲介手数料の仕訳方法を知りたい'),
    (r'取得価額|取得価格', '仲介手数料を取得価額に含めるべきか知りたい'),
    (r'繰延資産', '仲介手数料を繰延資産として処理すべきか知りたい'),
    (r'資産計上', '仲介手数料を資産計上するか経費処理するか知りたい'),
    (r'減価償却', '仲介手数料の減価償却の要否を知りたい'),
    (r'計上時期', '仲介手数料の計上時期を確認したい'),
    (r'按分', '仲介手数料の按分方法を知りたい'),
    (r'売上計上', '仲介手数料の売上計上タイミングを知りたい'),
    (r'固定資産', '仲介手数料を固定資産に含めるか知りたい'),
    (r'取得費$', '仲介手数料を取得費に含められるか知りたい'),
    (r'損金', '仲介手数料を損金算入できるか知りたい'),
    (r'前払[いい費]', '仲介手数料の前払い処理の方法を知りたい'),
    (r'原価$', '仲介手数料を原価に含めるか知りたい'),
    (r'譲渡費用', '仲介手数料を譲渡費用として計上できるか知りたい'),
    (r'業務委託料', '仲介手数料と業務委託料の違いを知りたい'),
    (r'経費', '仲介手数料を経費として処理する方法を知りたい'),
    (r'確定申告', '仲介手数料の確定申告での処理方法を知りたい'),

    # ===== 消費税 =====
    (r'仕入税額控除', '仲介手数料の仕入税額控除の可否を知りたい'),
    (r'消費税\s*いくら', '仲介手数料の消費税額を計算したい'),
    (r'消費税\s*かかる|税金かかる', '仲介手数料に消費税がかかるか確認したい'),
    (r'消費税\s*計算', '仲介手数料の消費税込みの金額を計算したい'),
    (r'消費税', '仲介手数料にかかる消費税の扱いを知りたい'),
    (r'課税$', '仲介手数料が課税対象か非課税か確認したい'),
    (r'免税$', '仲介手数料の免税条件を知りたい'),
    (r'税率$', '仲介手数料にかかる税率を確認したい'),
    (r'税金$', '仲介手数料にかかる税金の種類を知りたい'),
    (r'(?<![手仲介])税$', '仲介手数料に関する税金の扱いを知りたい'),
    (r'税務', '仲介手数料の税務処理を確認したい'),
    (r'法人税', '仲介手数料の法人税上の処理を知りたい'),
    (r'源泉徴収', '仲介手数料に源泉徴収が必要か知りたい'),

    # ===== 計算 =====
    (r'速算式', '仲介手数料の速算式（3%+6万円等）を知りたい'),
    (r'物件価格', '物件価格から仲介手数料を計算したい'),
    (r'シミュレーション', '仲介手数料のシミュレーションをしたい'),
    (r'計算方法', '仲介手数料の正しい計算方法を知りたい'),
    (r'計算\s*ツール', '仲介手数料を自動計算できるツールを使いたい'),
    (r'計算\s*サイト', '仲介手数料を計算できるサイトを見つけたい'),
    (r'計算$', '自分の物件の仲介手数料を正確に計算したい'),
    (r'自動計算', '仲介手数料を自動計算したい'),
    (r'早見表', '仲介手数料の早見表を見たい'),
    (r'エクセル', '仲介手数料をエクセルで計算したい'),

    # ===== 相場 =====
    (r'相場\s*賃貸', '賃貸の仲介手数料の相場金額を知りたい'),
    (r'相場\s*売買', '不動産売買の仲介手数料の相場を知りたい'),
    (r'相場$', '仲介手数料の一般的な相場金額を知りたい'),
    (r'平均$', '仲介手数料の平均金額を知りたい'),
    (r'最低金額', '仲介手数料の最低金額を知りたい'),
    (r'目安', '仲介手数料の目安金額を知りたい'),

    # ===== 金額別・パーセント =====
    (r'(\d+)万円以下', None),  # 動的生成
    (r'(\d+)万円以上', None),  # 動的生成
    (r'(\d+)万円$', None),     # 動的生成
    (r'(\d+)万$', None),       # 動的生成
    (r'何パーセント', '仲介手数料が物件価格の何%か知りたい'),
    (r'パーセント$', '仲介手数料のパーセンテージ（%）を知りたい'),
    (r'(\d+)パーセント', None),  # 動的生成
    (r'100パーセント', '仲介手数料100%（満額）の意味を知りたい'),
    (r'50パーセント|50$', '仲介手数料50%（半額）の仕組みを知りたい'),
    (r'55パーセント|55$', '仲介手数料55%（0.55ヶ月分）の意味を知りたい'),
    (r'3パーセント|仲介手数料 3$', '仲介手数料3%の計算方法と6万円の意味を知りたい'),
    (r'3\s*プラス6万円|3\s*\+\s*6万円|6万とは|6万円\s*意味|6万円\s*根拠', '仲介手数料「3%+6万円」の6万円の意味・根拠を知りたい'),
    (r'6パーセント', '仲介手数料6%が適用されるケースを知りたい'),
    (r'(?:仲介手数料\s+)?4パーセント', '仲介手数料4%が適用されるケースを知りたい'),
    (r'仲介手数料 ([2456])$', None),  # 動的生成
    (r'(\d+)\.\d+', None),  # 動的生成 (0.55, 1.1, 3.3等)
    (r'(\d+)円', None),  # 動的生成

    # ===== 物件・ケース =====
    (r'物件$', '特定の物件の仲介手数料がいくらか知りたい'),
    (r'半金$', '仲介手数料を半金（半額ずつ2回）で払うのか確認したい'),
    (r'造作譲渡', '造作譲渡（居抜き）時の仲介手数料の扱いを知りたい'),
    (r'ガイドライン', '仲介手数料に関するガイドラインを確認したい'),
    (r'報酬額', '仲介手数料の報酬額の算出方法を知りたい'),
]


def generate_need(kw, page_group, intent, article_title):
    """キーワードから解決ニーズを生成"""
    # 削除対象はスキップ
    if not kw:
        return ''

    # ベースキーワード（修飾語なし）
    base = kw.replace('仲介手数料', '').strip()
    if not base:
        return '仲介手数料の全体像（仕組み・計算方法・相場・上限）を把握したい'

    # パターンマッチ
    for pattern, need in PATTERNS:
        m = re.search(pattern, kw)
        if m:
            if need is None:
                # 動的生成
                return generate_dynamic(kw, m, page_group)
            return need

    # ページグループベースのフォールバック
    return generate_from_group(kw, page_group, intent, article_title)


def generate_dynamic(kw, m, page_group):
    """動的にニーズを生成（金額・パーセント系）"""
    matched = m.group(0)

    # 金額パターン
    amt_match = re.search(r'(\d+)万円?(以下|以上)?', kw)
    if amt_match:
        amount = amt_match.group(1)
        suffix = amt_match.group(2) or ''
        if suffix == '以下':
            return f'物件価格{amount}万円以下の場合の仲介手数料を計算したい'
        elif suffix == '以上':
            return f'物件価格{amount}万円以上の場合の仲介手数料を計算したい'
        else:
            return f'{amount}万円の物件の仲介手数料がいくらか知りたい'

    # パーセントパターン
    pct_match = re.search(r'(\d+)パーセント', kw)
    if pct_match:
        pct = pct_match.group(1)
        return f'仲介手数料{pct}%の意味・適用ケースを知りたい'

    # 小数パターン (0.55, 1.1, 3.3等)
    dec_match = re.search(r'(\d+\.\d+)', kw)
    if dec_match:
        val = dec_match.group(1)
        return f'仲介手数料{val}の意味（ヶ月分？%？）を確認したい'

    # 数字のみ (2, 3, 4, 5, 6等)
    num_match = re.search(r'仲介手数料\s+(\d+)$', kw)
    if num_match:
        n = num_match.group(1)
        return f'仲介手数料「{n}」の意味（{n}%？{n}ヶ月？）を知りたい'

    return '仲介手数料の具体的な金額・条件を確認したい'


def generate_from_group(kw, page_group, intent, article_title):
    """ページグループから解決ニーズを生成（フォールバック）"""
    group_needs = {
        '仲介手数料_基礎解説': '仲介手数料の基本的な仕組みを理解したい',
        '仲介手数料基礎解説': '仲介手数料の基本的な仕組みを理解したい',
        '仲介手数料相場': '仲介手数料の相場金額を確認したい',
        '仲介手数料_相場': '仲介手数料の相場金額を確認したい',
        '仲介手数料_計算': '仲介手数料の金額を正確に計算したい',
        '仲介手数料_交渉': '仲介手数料の値引き交渉方法を知りたい',
        '仲介手数料_無料': '仲介手数料無料の仕組みとリスクを知りたい',
        '仲介手数料_法律': '仲介手数料の法的規制・上限を確認したい',
        '仲介手数料_会計': '仲介手数料の会計処理方法を知りたい',
        '仲介手数料_消費税': '仲介手数料の消費税の扱いを確認したい',
        '仲介手数料_賃貸': '賃貸の仲介手数料について知りたい',
        '仲介手数料_不動産': '不動産売買の仲介手数料を知りたい',
        '仲介手数料_不動産売買': '不動産売買の仲介手数料を知りたい',
        '仲介手数料_金額別': '特定の価格帯の仲介手数料を知りたい',
        '仲介手数料_金額': '仲介手数料の金額を知りたい',
        '仲介手数料_具体例・ケース': '仲介手数料の具体的な数値・条件を確認したい',
        '仲介手数料_比較・検討': '仲介手数料を比較検討して判断したい',
        '仲介手数料_時期・スケジュール': '仲介手数料の支払い時期を確認したい',
        '仲介手数料_支払い方法': '仲介手数料の支払い方法を確認したい',
        '仲介手数料_還付': '仲介手数料の返金・還付条件を知りたい',
        '仲介手数料_延納・分割': '仲介手数料の分割・延納が可能か知りたい',
        '仲介手数料_書式': '仲介手数料の書類書式を確認したい',
        '仲介手数料_不動産特化': '不動産取引の仲介手数料を知りたい',
    }

    if page_group in group_needs:
        return group_needs[page_group]

    # 検索意図から抽出（括弧内の部分）
    if intent:
        m = re.search(r'[（(](.+?)[）)]', intent)
        if m:
            return m.group(1)

    # キーワードから直接生成
    suffix = kw.replace('仲介手数料', '').strip()
    if suffix:
        return f'仲介手数料の「{suffix}」について知りたい'

    return '仲介手数料について知りたい'


def main():
    with open(FILEPATH, 'r', encoding='utf-8') as f:
        lines = f.readlines()

    header = lines[0].strip().split('\t')

    # 既に列がある場合は上書き、なければ追加
    if COL_NAME in header:
        col_idx = header.index(COL_NAME)
        insert_new = False
    else:
        # 検索意図の次の位置に挿入
        intent_idx = header.index('検索意図')
        col_idx = intent_idx + 1
        header.insert(col_idx, COL_NAME)
        insert_new = True

    idx = {name: i for i, name in enumerate(lines[0].strip().split('\t'))}
    kw_i = idx['キーワード']
    hantei_i = idx['判定']
    pg_i = idx.get('ページグループ', -1)
    intent_i = idx.get('検索意図', -1)
    title_i = idx.get('想定ページタイトル', -1)

    new_lines = ['\t'.join(header) + '\n']
    filled = 0
    total = 0

    for line in lines[1:]:
        cols = line.strip().split('\t')

        kw = cols[kw_i] if kw_i < len(cols) else ''
        hantei = cols[hantei_i] if hantei_i < len(cols) else ''
        pg = cols[pg_i] if pg_i >= 0 and pg_i < len(cols) else ''
        intent = cols[intent_i] if intent_i >= 0 and intent_i < len(cols) else ''
        title = cols[title_i] if title_i >= 0 and title_i < len(cols) else ''

        total += 1

        if hantei == '削除':
            need = ''
        else:
            need = generate_need(kw, pg, intent, title)
            if need:
                filled += 1

        if insert_new:
            cols.insert(col_idx, need)
        else:
            while len(cols) <= col_idx:
                cols.append('')
            cols[col_idx] = need

        new_lines.append('\t'.join(cols) + '\n')

    with open(FILEPATH, 'w', encoding='utf-8') as f:
        f.writelines(new_lines)

    print(f'=== 解決ニーズ生成完了 ===')
    print(f'  対象行数: {total}')
    print(f'  生成数: {filled}')
    print(f'  空欄（削除等）: {total - filled}')


if __name__ == '__main__':
    main()

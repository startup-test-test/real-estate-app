# シミュレーションAPI アーキテクチャ図解

## 現状の構成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           フロントエンド（Next.js）                      │
│                                                                         │
│  ┌─────────────────────────────┐    ┌─────────────────────────────┐    │
│  │     収益シミュレーター        │    │      CFシミュレーター        │    │
│  │  /mypage/revenue-simulator   │    │   /mypage/cf-simulator      │    │
│  │                              │    │                              │    │
│  │  ・フル機能入力フォーム       │    │  ・簡易入力フォーム           │    │
│  │  ・空室率、家賃下落率など     │    │  ・固定値で送信              │    │
│  │    ユーザーが設定可能         │    │    - rentDecline: 0          │    │
│  │                              │    │    - majorRepairCycle: 0     │    │
│  │                              │    │    - propertyTax: 0.5%       │    │
│  └──────────────┬───────────────┘    └──────────────┬───────────────┘    │
│                 │                                   │                    │
│                 │  fetch(API_ENDPOINTS.SIMULATE)    │                    │
│                 │                                   │                    │
└─────────────────┼───────────────────────────────────┼────────────────────┘
                  │                                   │
                  ▼                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      同じAPIエンドポイント                               │
│                                                                         │
│                    POST /api/simulate                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  /api/simulate.py（Vercel Python Functions）                            │
│                                                                         │
│  1. リクエストボディを読み取り                                           │
│  2. キャメルケース → スネークケース変換                                  │
│  3. バリデーション実行                                                   │
│  4. run_full_simulation() を呼び出し                                    │
│  5. 結果をJSONで返却                                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ import
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  /api/shared/calculations.py（計算ロジック）                             │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  run_full_simulation(property_data)                              │   │
│  │                                                                   │   │
│  │  1. calculate_basic_metrics()    → 基本指標                      │   │
│  │  2. calculate_property_valuation() → 物件評価                    │   │
│  │  3. calculate_sale_analysis()    → 売却分析                      │   │
│  │  4. calculate_cash_flow_table()  → キャッシュフロー表            │   │
│  │  5. 結果をまとめて返却                                            │   │
│  │                                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## データフロー

```
┌──────────────────┐
│  ユーザー入力     │
│  (フロントエンド)  │
└────────┬─────────┘
         │
         ▼
┌──────────────────────────────────────────────────────────────┐
│  入力パラメータ（キャメルケース）                              │
│                                                              │
│  {                                                           │
│    purchasePrice: 5000,     ← 物件価格（万円）               │
│    monthlyRent: 30,         ← 月間家賃（万円）               │
│    loanAmount: 4500,        ← 借入金額（万円）               │
│    interestRate: 1.5,       ← 金利（%）                      │
│    loanYears: 35,           ← 借入期間（年）                 │
│    holdingYears: 10,        ← 保有期間（年）                 │
│    vacancyRate: 5,          ← 空室率（%）                    │
│    managementFee: 10000,    ← 管理費（円）                   │
│    ...                                                       │
│  }                                                           │
└──────────────────────────────────────────────────────────────┘
         │
         │ POST /api/simulate
         ▼
┌──────────────────────────────────────────────────────────────┐
│  スネークケースに変換                                         │
│                                                              │
│  {                                                           │
│    purchase_price: 5000,                                     │
│    monthly_rent: 30,                                         │
│    loan_amount: 4500,                                        │
│    ...                                                       │
│  }                                                           │
└──────────────────────────────────────────────────────────────┘
         │
         │ run_full_simulation()
         ▼
┌──────────────────────────────────────────────────────────────┐
│  計算処理                                                     │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ calculate_basic_metrics()                               │ │
│  │  → 表面利回り、実質利回り、NOI、DSCR、CCR、ROI         │ │
│  └────────────────────────────────────────────────────────┘ │
│                          ↓                                   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ calculate_cash_flow_table()                             │ │
│  │  → 年次ごとのキャッシュフロー詳細計算                    │ │
│  │  → 減価償却、税金、繰越欠損金、売却分析                  │ │
│  └────────────────────────────────────────────────────────┘ │
│                          ↓                                   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ calculate_property_valuation()                          │ │
│  │  → 収益還元評価、積算評価                                │ │
│  └────────────────────────────────────────────────────────┘ │
│                          ↓                                   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ calculate_sale_analysis()                               │ │
│  │  → 売却コスト、売却益                                    │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────────────┐
│  レスポンス                                                   │
│                                                              │
│  {                                                           │
│    results: {                    ← サマリー指標              │
│      "表面利回り（%）": 7.2,                                  │
│      "年間キャッシュフロー（円）": 2460000,  ← 簡易計算値     │
│      ...                                                     │
│    },                                                        │
│    cash_flow_table: [            ← 年次キャッシュフロー表    │
│      {                                                       │
│        "年次": "1年目",                                       │
│        "営業CF": 2463456,        ← 詳細計算値（税引後）      │
│        ...                                                   │
│      },                                                      │
│      ...                                                     │
│    ],                                                        │
│    ...                                                       │
│  }                                                           │
└──────────────────────────────────────────────────────────────┘
```

---

## 収益シミュレーター vs CFシミュレーター

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        収益シミュレーター                                │
│                     /mypage/revenue-simulator                           │
│                                                                         │
│  【特徴】                                                                │
│  ・フル機能の入力フォーム                                                │
│  ・詳細なパラメータ設定が可能                                            │
│  ・物件評価、売却分析など全機能                                          │
│                                                                         │
│  【送信パラメータ】                                                      │
│  ・ユーザーが入力した値をそのまま送信                                    │
│  ・空室率、家賃下落率、大規模修繕など全て設定可能                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         CFシミュレーター                                 │
│                       /mypage/cf-simulator                              │
│                                                                         │
│  【特徴】                                                                │
│  ・簡易入力フォーム（6項目のみ）                                         │
│  ・シンプルなキャッシュフロー計算                                        │
│                                                                         │
│  【送信パラメータ】（フロントエンドで固定値を設定）                       │
│  ・rentDecline: 0              ← 家賃下落なし                           │
│  ・majorRepairCycle: 0         ← 大規模修繕なし                         │
│  ・majorRepairCost: 0                                                   │
│  ・propertyTax: 物件価格 × 0.5% ← 固定資産税0.5%固定                    │
│  ・vacancyRate: 5              ← 空室率5%固定                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

                                    │
                                    │ 両方とも
                                    ▼

┌─────────────────────────────────────────────────────────────────────────┐
│                       同じAPI・同じ計算ロジック                          │
│                                                                         │
│                    POST /api/simulate                                   │
│                    run_full_simulation()                                │
│                                                                         │
│  ※ 入力パラメータが異なるだけで、計算ロジックは共通                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 課題：`results`と`cash_flow_table`の値の不一致

```
┌─────────────────────────────────────────────────────────────────────────┐
│  calculate_basic_metrics()                                              │
│                                                                         │
│  annual_cf = (月間家賃 × 10000 - 管理費 - 固定費) × 12                  │
│                                                                         │
│  【含まれない項目】                                                      │
│  ・空室率 ✗                                                             │
│  ・固定資産税 ✗                                                         │
│  ・ローン返済 ✗                                                         │
│  ・税金 ✗                                                               │
│                                                                         │
│  → results["年間キャッシュフロー（円）"] に使用                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

                              ≠ 値が異なる

┌─────────────────────────────────────────────────────────────────────────┐
│  calculate_cash_flow_table()                                            │
│                                                                         │
│  営業CF = 実効収入 - 経費 - ローン返済 - 修繕費 - 改装費 - 税金          │
│                                                                         │
│  【含まれる項目】                                                        │
│  ・空室率 ✓                                                             │
│  ・固定資産税 ✓                                                         │
│  ・ローン返済 ✓                                                         │
│  ・税金 ✓                                                               │
│  ・減価償却（税金計算用） ✓                                              │
│  ・繰越欠損金 ✓                                                         │
│                                                                         │
│  → cash_flow_table[0]["営業CF"] に使用                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 今後の改善案：API分離

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           フロントエンド                                 │
│                                                                         │
│  ┌─────────────────────────────┐    ┌─────────────────────────────┐    │
│  │     収益シミュレーター        │    │      CFシミュレーター        │    │
│  └──────────────┬───────────────┘    └──────────────┬───────────────┘    │
│                 │                                   │                    │
│                 ▼                                   ▼                    │
│       POST /api/simulate              POST /api/cf-simulate（新規）     │
│                                                                         │
└─────────────────┬───────────────────────────────────┬────────────────────┘
                  │                                   │
                  ▼                                   ▼
┌─────────────────────────────┐    ┌─────────────────────────────────────┐
│  /api/simulate.py           │    │  /api/cf-simulate.py（新規作成）    │
│  （既存・変更なし）          │    │                                     │
│                              │    │  ・CFシミュレーター専用             │
│                              │    │  ・結果のカスタマイズ可能           │
│                              │    │  ・cash_flow_tableから              │
│                              │    │    正確な営業CFを取得               │
│                              │    │                                     │
└──────────────┬───────────────┘    └──────────────┬──────────────────────┘
               │                                   │
               │                                   │
               └───────────────┬───────────────────┘
                               │
                               │ import（共有）
                               ▼
               ┌───────────────────────────────────┐
               │  /api/shared/calculations.py      │
               │  （計算ロジックは共通）            │
               └───────────────────────────────────┘
```

**メリット:**
- 収益シミュレーターに影響を与えずにCF用の出力をカスタマイズ可能
- 計算ロジックは1箇所で管理（保守性維持）
- 各エンドポイントで独立した改修が可能

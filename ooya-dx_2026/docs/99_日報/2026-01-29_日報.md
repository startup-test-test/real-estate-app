# 日報 2026-01-29

## 作業内容

### 1. CFシミュレーターの簡略化

**変更内容**
- 固定資産税：1% → 0.5% に変更
- 家賃下落率：1% → 0% に変更（下落なし）
- 大規模修繕：10年周期3% → なし（0）に変更

**修正ファイル**
- `app/mypage/cf-simulator/new/CFSimulatorNewClient.tsx`
- `app/mypage/cf-simulator/[id]/CFSimulatorDetailClient.tsx`

---

### 2. CFシミュレーション計算のバグ調査

**問題**
- サマリーの「年間CF」表示値（976万円）とキャッシュフロー表の「営業CF」（246万円）が大きく異なる
- Geminiの分析で指摘された計算不整合

**調査結果**
- `results["年間キャッシュフロー"]`は`basic_metrics['annual_cf']`を使用（簡易計算：税金・空室率・ローン返済未反映）
- `cash_flow_table["営業CF"]`は詳細計算（全要素反映）
- 両者で計算方法が異なり、値が一致しない仕様になっていた

**対応**
- `/api/shared/calculations.py`の`run_full_simulation()`で`cash_flow_table`から実際の値を取得するよう修正
- ただし、収益シミュレーターにも影響が出るため、ユーザー指示により**元に戻した**

---

### 3. API分離の検討・仕様整理

**背景**
- CFシミュレーターと収益シミュレーターが同じAPI（`/api/simulate`）を共有
- 片方を変更すると他方に影響が出る

**検討した方針**
- エンドポイントを分離（`/api/simulate` と `/api/cf-simulate`）
- 計算ロジック（`/api/shared/calculations.py`）は共有のまま

**作成したドキュメント**
- `docs/17_APIの仕様/シミュレーションAPI仕様.md` - 詳細なAPI仕様書
- `docs/17_APIの仕様/アーキテクチャ図解.md` - 現状の構成図解

---

### 4. 利用規約・プライバシーポリシーページの修正

**問題**
- ヘッダーとコンテンツが被っていた

**修正ファイル**
- 関連のページコンポーネント

---

## コミット履歴

```
07f821c fix: 利用規約・プライバシーポリシーページのヘッダー被り修正
75af2c8 fix: CFシミュレーション詳細ページで自動保存に変更し更新ボタンを削除
```

※ API計算ロジックの変更は元に戻したため未コミット

---

## 学んだこと・メモ

- `basic_metrics['annual_cf']`と`cash_flow_table['営業CF']`は異なる計算方法
  - basic_metrics: 簡易計算（月間家賃 - 管理費 - 固定費）× 12
  - cash_flow_table: 詳細計算（空室率・税金・ローン・減価償却すべて反映）
- 共有APIを変更する際は影響範囲を確認する必要がある
- API分離により独立した改修が可能になる

---

## 次回以降の課題

### 優先度：高
- [ ] CFシミュレーター専用API（`/api/cf-simulate`）の作成
  - 計算ロジックは共有（`/api/shared/calculations.py`）
  - 結果出力をCF用にカスタマイズ
  - 収益シミュレーターに影響を与えない

### 優先度：中
- [ ] E2Eテストの完成（Basic Auth対応が必要）
- [ ] Playwrightテストの環境設定

### 優先度：低
- [ ] ローン比較シミュレーターの実装
- [ ] 税金シミュレーターの実装

---

## 現状のAPI構成

```
収益シミュレーター ──┐
                    ├──→ POST /api/simulate ──→ calculations.py
CFシミュレーター ───┘
```

## 今後のAPI構成（予定）

```
収益シミュレーター ──→ POST /api/simulate ────┐
                                              ├──→ calculations.py（共有）
CFシミュレーター ────→ POST /api/cf-simulate ─┘
```

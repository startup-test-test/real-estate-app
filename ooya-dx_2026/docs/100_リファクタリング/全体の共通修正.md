# サイト全体の共通修正ルール（PageSpeed Insights 分析）

計測日: 2026/02/18

## なぜ「共通ルール」で直すのか

計測した4ページ（/profile, /media, /media記事）で**全く同じ問題**が繰り返し検出された。
これは個別ページの問題ではなく、**サイト共通のインフラ（レイアウト・フォント・CSS/JSバンドル・画像配信）が原因。**

→ 共通インフラを1回直せば、計測していないページも含め **サイト全体（全ページ）が一括で改善される。**

---

## 計測結果サマリ

| ページ | Desktop | Mobile | FCP(M) | LCP(M) | TBT(M) | CLS(M) |
|--------|---------|--------|--------|--------|--------|--------|
| /profile | 86 | 56 | 9.1s | 51.0s | 30ms | 0 |
| /media | 82 | 47 | 7.7s | 41.6s | 380ms | 0 |
| /media (desktop版) | 82 | 47 | 7.7s | 41.6s | 380ms | 0 |
| /media/base/bad-2ch | 87 | 57 | 8.2s | 45.2s | 80ms | 0.002 |

Desktop は FCP 0.5〜0.6s / LCP 2.0〜3.2s で良好。**モバイルが深刻（LCP 40〜51秒）。**

---

## 共通修正ルール一覧

### ルール 1: フォント読み込みの最適化

**影響度: 最大 — モバイル LCP 40〜51秒の主因**

**現状の問題:**
- クリティカルパスに **40個以上の woff2 ファイル**がチェーンされている
- 合計 ~800 KiB がページ表示前に読み込まれる
- Desktop でもクリティカルパス最大 3,513ms

**共通ルール:**
1. **使用フォント・ウェイトの棚卸し** — Inter + Noto Sans JP + Noto Serif JP の3書体に、実際に使っているウェイトだけ残す
2. **`font-display: swap`** — 全フォントで確認。フォント読み込み完了前にテキストを表示させる
3. **`preload` は最優先の2〜3ファイルのみ** — 全フォントをpreloadしない
4. **日本語フォントのサブセット化** — 使用文字のみ含むwoff2を生成し、ファイルサイズを削減
5. **不要なウェイト・フォントファイルを削除** — 40個→5〜10個が目標

**修正箇所:** `app/layout.tsx`（フォント定義）、`next.config.mjs`、`globals.css`

---

### ルール 2: 全 `<img>` タグを Next.js `<Image>` に統一

**影響度: 高 — 画像最適化 + CLS解消 + lazy loading**

**現状の問題:**
- 素の `<img>` タグに width/height 未指定 → CLS（レイアウトシフト）発生
- PNG/JPG をそのまま配信 → WebP/AVIF 変換なし
- 表示サイズより大きい画像を配信（例: 300x300 を 144x144 で表示）

**共通ルール:**
1. **全ページの `<img>` を `next/image` の `<Image>` に置換**
2. **必ず `width` / `height` を指定**（fill モードの場合は親に `relative` + `sizes` を指定）
3. **外部画像は `next.config.mjs` の `images.remotePatterns` に登録**
4. **`priority` は LCP 要素のみに付与**（ファーストビューのヒーロー画像など）
5. **それ以外は自動 lazy loading に任せる**

**修正箇所:** 全ページ・全コンポーネントの `<img>` タグ（作業中）

---

### ルール 3: 元画像ファイルの最適化

**影響度: 高 — ネットワークペイロード 15,000〜17,800 KiB の主因**

**現状の問題:**
- サムネイル用途の画像が 1,000〜2,200 KiB（PNG）のまま配信
- `<Image>` に移行しても、元画像が巨大なままだと効果が限定的

| 画像 | 現在サイズ | 用途 |
|-----|----------|------|
| `neteitou_250409_1-1.png` | 2,220 KiB | サムネイル |
| `0411_5.png` | 1,792 KiB | サムネイル |
| `0411_4.png` | 1,764 KiB | サムネイル |
| `0411_2.png` | 1,741 KiB | サムネイル |
| `akiya.png` | 1,101 KiB | プロフィール画像 |
| `hero-media.jpeg` | 622 KiB | メディアヒーロー |

**共通ルール:**
1. **サムネイル画像は 800px幅以下にリサイズ** — 表示サイズに合わせる
2. **PNG → WebP に変換**（ロスレスが不要なら lossy WebP で 50〜80% 削減）
3. **目標: サムネイル1枚あたり 100〜300 KiB 以下**
4. **新規追加画像も同じルールを適用する**（今後の運用ルール）

**修正箇所:** `public/images/`, `public/img/`, 外部サムネイル画像

---

### ルール 4: browserslist の見直し（レガシー polyfills 削除）

**影響度: 中 — 全ページで 14 KiB 削減**

**現状の問題:**
全ページで同じ polyfill チャンク (`e5ebd9515e628167.js`) が読み込まれている:
- `Array.prototype.at` / `.flat` / `.flatMap`
- `Object.fromEntries` / `Object.hasOwn`
- `String.prototype.trimStart` / `.trimEnd`

→ 全て Baseline 機能。最新ブラウザでは不要。

**共通ルール:**
```
# package.json の browserslist または .browserslistrc
last 2 versions
> 1%
not dead
not ie 11
```

**修正箇所:** `package.json`（browserslist）または `.browserslistrc`

---

### ルール 5: 未使用 CSS の削減

**影響度: 中 — 全ページで同じ 65 KiB がブロッキング**

**現状の問題:**
全ページで同じ2つの CSS チャンクが「未使用」として指摘:

| チャンク | 削減可能 |
|---------|---------|
| `779f91fc5742b25f.css` | 32.6 KiB |
| `e8ae91a8272b746e.css` | 32.3 KiB |

さらにこれらは **レンダリングブロッキング** にもなっている（モバイル合計 4,990〜6,530ms）。

**共通ルール:**
1. **Tailwind CSS の content 設定を確認** — 未使用クラスが purge されているか
2. **shadcn/ui の未使用コンポーネントを整理** — 使っていないコンポーネントのCSSを除外
3. **CSS チャンクの中身を調査** — どのライブラリ由来かを特定して対処

**修正箇所:** `tailwind.config.ts`、`globals.css`、`next.config.mjs`

---

### ルール 6: 未使用 JS の dynamic import 化

**影響度: 中 — 全ページで ~233 KiB 削減**

**現状の問題:**
全ページで同じ3つの JS チャンクが「未使用」として指摘:

| チャンク | 転送サイズ | 削減可能 |
|---------|----------|---------|
| `7186a204b944b278.js` | 116.8 KiB | 90.4 KiB |
| `dca2b8c0b18b5c31.js` | 95.1 KiB | 58.8 KiB |
| `e5ebd9515e628167.js` | 69.5 KiB | 24.5 KiB |

**共通ルール:**
1. **チャンクの中身を特定** — `next build` の `--analyze` で何のライブラリかを確認
2. **初期表示に不要なコンポーネントは `next/dynamic` で遅延読み込み**
3. **重いライブラリ（chart系、エディタ系など）は使うページでのみ import**

**修正箇所:** 各ページ・コンポーネントの import 文

---

### ルール 7: Google Tag Manager の遅延読み込み

**影響度: 低〜中 — 強制リフロー解消 + 60 KiB 削減**

**現状の問題:**
- GTM (`gtag/js`) が全ページで強制リフローを引き起こしている
- 未使用 JS としても 59.9 KiB 指摘

**共通ルール:**
```tsx
// next/script で strategy を afterInteractive または lazyOnload に
<Script
  src="https://www.googletagmanager.com/gtag/js?id=G-Z2QBGBT7JP"
  strategy="afterInteractive"
/>
```

**修正箇所:** `components/GoogleAnalytics.tsx`

---

## 優先度まとめ

| 優先度 | ルール | 期待効果 | 難易度 |
|-------|--------|---------|-------|
| **P0** | ルール1: フォント最適化 | LCP 40〜51s → 大幅短縮 | 中 |
| **P1** | ルール2: `<img>` → `<Image>` 統一 | WebP自動変換 + CLS解消 | 中（作業中） |
| **P1** | ルール3: 元画像ファイル最適化 | ペイロード 17MB → 目標 5MB以下 | 低（作業） |
| **P2** | ルール4: browserslist 見直し | polyfills 14 KiB 削除 | 低 |
| **P2** | ルール7: GTM 遅延読み込み | リフロー解消 + 60 KiB | 低 |
| **P3** | ルール5: 未使用 CSS 削減 | 65 KiB + ブロッキング解消 | 高 |
| **P3** | ルール6: 未使用 JS 分割 | 233 KiB 削減、TBT改善 | 高 |

---

## 画像最適化の実施方法

### 元画像が大きすぎる問題

Next.js `<Image>` に移行しても、**元画像が 1〜2MB のままだと効果が限定的。**
`<Image>` は配信時に WebP 変換してくれるが、変換元が巨大だと初回生成が遅く、サーバー負荷も高い。

→ **元画像自体を適正サイズにリサイズしてから、`<Image>` で自動 WebP 配信する** のがベスト。

### 方法1: sharp（Node.js）で一括変換

```bash
# sharp-cli をインストール
npx sharp-cli resize 800 --input "public/images/**/*.png" --output "public/images/"

# または Node.js スクリプトで
const sharp = require('sharp');
await sharp('input.png')
  .resize(800)           // 幅800pxにリサイズ
  .webp({ quality: 80 }) // WebP変換（品質80%）
  .toFile('output.webp');
```

### 方法2: cwebp（コマンドライン）で変換

```bash
# PNG → WebP 変換
cwebp -q 80 input.png -o output.webp

# 一括変換
for f in public/images/**/*.png; do
  cwebp -q 80 "$f" -o "${f%.png}.webp"
done
```

### 推奨フロー（ルール2 + ルール3 の組み合わせ）

```
1. 元画像をリサイズ（幅800px以下）
   ↓
2. Next.js <Image> コンポーネントに統一
   ↓
3. Next.js が自動で WebP/AVIF 配信 + lazy loading + width/height 付与
```

### 画像サイズの目安

| 用途 | 推奨幅 | 目標サイズ |
|-----|-------|----------|
| サムネイル | 400〜600px | 50〜150 KiB |
| カード画像 | 600〜800px | 100〜200 KiB |
| ヒーロー画像 | 1200〜1600px | 200〜400 KiB |
| ロゴ | 実寸（251px等） | 10 KiB 以下 |
| プロフィール写真 | 300px | 20〜50 KiB |

### 今後の運用ルール（新規画像追加時）

1. **幅1600px以下にリサイズしてからリポジトリに追加**
2. **PNG は写真には使わない** — 写真は JPG or WebP（PNGはロゴ・アイコン等の透過画像のみ）
3. **1枚あたり 300 KiB を超えたら圧縮を検討**
4. **`<Image>` コンポーネントを必ず使う**（素の `<img>` は禁止）

---

## 進捗管理

- [x] PageSpeed Insights 計測（2026/02/18）
- [x] 共通問題の洗い出し・共通ルール策定（本ドキュメント）
- [ ] ルール1: フォント最適化
- [ ] ルール2: Next.js Image 移行完了
- [ ] ルール3: 元画像ファイル最適化
- [ ] ルール4: browserslist 見直し
- [ ] ルール5: 未使用 CSS 削減
- [ ] ルール6: 未使用 JS 分割
- [ ] ルール7: GTM 遅延読み込み
- [ ] 改善後の再計測

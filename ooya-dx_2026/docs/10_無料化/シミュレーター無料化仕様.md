3# シミュレーター無料化仕様

## 概要

シミュレーターを無料で公開し、保存機能のみ会員登録を必要とする仕様に変更する。

## 背景・目的

### 現状の課題
- 有料（¥980/月）でアクセスがほぼない
- 競合（ヤモリ）が無料で同等機能を提供
- ユーザーベースがないため、収益化の土台がない

### 目的
1. 無料化で利用ハードルを下げ、ユーザー獲得
2. メールアドレス（リード）の獲得
3. 将来的な有料機能（リフォーム紹介等）の土台作り

---

## 現状の仕組み

### URL構成

| URL | 用途 | 認証 |
|-----|------|------|
| `/simulator/` | LPページ（登録を促す） | 不要 |
| `/mypage/simulator/` | シミュレーター本体 | **必要** |

### 認証フロー（現状）

```
ユーザー
    ↓
/simulator/ （LP）
    ↓
「10秒で無料登録」ボタン
    ↓
/auth/signup （会員登録）
    ↓
/mypage/simulator/ （シミュレーター）
    ↓
入力 → 計算（Python API）→ 結果表示 → 自動保存
```

### 関連ファイル

| ファイル | 役割 |
|----------|------|
| `app/simulator/page.tsx` | LPページ |
| `app/simulator/SimulatorLPClient.tsx` | LP UI |
| `app/mypage/simulator/page.tsx` | シミュレーター |
| `app/mypage/simulator/SimulatorClient.tsx` | シミュレーター本体（約3000行） |
| `app/mypage/MypageLayoutClient.tsx` | マイページレイアウト |
| `components/dashboard/DashboardLayout.tsx` | ダッシュボードレイアウト（認証UI） |
| `api/simulate.py` | シミュレーション計算API（Python） |

### 認証の仕組み

- `DashboardLayout.tsx` で `useAuth()` を使用
- 認証チェック自体は強制ではない（UIのみ表示）
- Python API（`/api/simulate`）には認証チェックなし
- 保存API（`useSimulations`）はNeon Authで認証

---

## 変更後の仕組み

### URL構成（変更後）

| URL | 用途 | 認証 |
|-----|------|------|
| `/simulator/` | **シミュレーター本体** | **不要** |
| `/mypage/` | マイページ（保存済み物件一覧） | 必要 |

### 新しいフロー

```
ユーザー
    ↓
/simulator/ （シミュレーター）
    ↓
入力 → 計算（Python API）→ 結果表示
    ↓
「保存」ボタン押下
    ↓
未ログイン？ → 登録モーダル表示 → 登録 → 保存
ログイン済み → 保存
```

### 機能の分離

| 機能 | 認証 | 備考 |
|------|------|------|
| シミュレーション入力 | 不要 | 誰でも使える |
| シミュレーション計算 | 不要 | Python APIをそのまま使用 |
| 結果表示 | 不要 | グラフ・表の表示 |
| PDF出力 | 不要 | ブラウザ印刷機能 |
| **結果の保存** | **必要** | DBへの保存時のみ登録 |
| 保存済み物件の閲覧 | 必要 | マイページで表示 |

---

## メールアドレス取得フロー（迷いポイント）

### 選択肢の比較

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    メールアドレス取得タイミングの選択肢                    │
└─────────────────────────────────────────────────────────────────────────┘

【案A】保存時のみ登録（推奨）
──────────────────────────────────────────────────────────────────────────
  ユーザー訪問
       │
       ▼
  ┌──────────────┐
  │ シミュレーター │  ← 登録不要
  │   入力画面    │
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐
  │  計算実行     │  ← 登録不要（Python API）
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐
  │  結果表示     │  ← 登録不要（グラフ・表・PDF）
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐
  │ 「保存」押下   │
  └──────┬───────┘
         │
         ▼
    ログイン済み？
     /        \
   Yes         No
    │           │
    ▼           ▼
  保存実行   ┌─────────────┐
    │       │ 登録モーダル  │
    │       │ (メール入力)  │
    │       └──────┬──────┘
    │              │
    │              ▼
    │         メール登録
    │              │
    │              ▼
    └──────► 保存実行
                   │
                   ▼
              マイページへ導線


【案B】結果表示時に登録
──────────────────────────────────────────────────────────────────────────
  ユーザー訪問
       │
       ▼
  ┌──────────────┐
  │ シミュレーター │  ← 登録不要
  │   入力画面    │
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐
  │  計算実行     │  ← 登録不要
  └──────┬───────┘
         │
         ▼
    ログイン済み？
     /        \
   Yes         No
    │           │
    ▼           ▼
  結果表示   ┌─────────────┐
    │       │ 登録モーダル  │  ← ここでブロック
    │       │ (メール入力)  │
    │       └──────┬──────┘
    │              │
    │              ▼
    └──────► 結果表示


【案C】計算前に登録
──────────────────────────────────────────────────────────────────────────
  ユーザー訪問
       │
       ▼
  ┌──────────────┐
  │ シミュレーター │  ← 登録不要
  │   入力画面    │
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐
  │「計算」ボタン  │
  └──────┬───────┘
         │
         ▼
    ログイン済み？
     /        \
   Yes         No
    │           │
    ▼           ▼
  計算実行   ┌─────────────┐
    │       │ 登録モーダル  │  ← ここでブロック
    │       │ (メール入力)  │
    │       └──────┬──────┘
    │              │
    │              ▼
    └──────► 計算実行
```

### 各案のメリット・デメリット

| 案 | メール取得率 | 離脱率 | ユーザー体験 | 推奨度 |
|----|-------------|--------|-------------|--------|
| **A: 保存時のみ** | 低〜中 | 最低 | 最高 | ★★★ |
| B: 結果表示時 | 中〜高 | 中 | 中 | ★★ |
| C: 計算前 | 高 | 高 | 低 | ★ |

### 推奨：案A（保存時のみ登録）

**理由**:
1. **離脱率が最低**: 登録前に価値を体験できる
2. **口コミしやすい**: 「登録なしで使えるよ」と紹介できる
3. **登録者の質が高い**: 本当に使いたい人だけが登録
4. **SEO訴求**: 「登録不要・無料シミュレーター」でアピール可能

**トレードオフ**:
- メール取得率は低くなる
- ただし、取得したメールは「保存したい=本気度が高い」ユーザー

---

## 登録モーダルのUI案

```
┌─────────────────────────────────────────────────┐
│                                          [×]   │
│                                                 │
│   📊 シミュレーション結果を保存しませんか？      │
│                                                 │
│   メールアドレスを登録すると、                   │
│   結果をいつでも確認・編集できます。             │
│                                                 │
│   ┌─────────────────────────────────────┐      │
│   │ メールアドレス                        │      │
│   └─────────────────────────────────────┘      │
│                                                 │
│   ┌─────────────────────────────────────┐      │
│   │ パスワード                           │      │
│   └─────────────────────────────────────┘      │
│                                                 │
│   ┌─────────────────────────────────────────┐  │
│   │         無料で登録して保存する           │  │
│   └─────────────────────────────────────────┘  │
│                                                 │
│   すでにアカウントをお持ちの方は ログイン        │
│                                                 │
│   ────────────────────────────────────────     │
│                                                 │
│   登録せずにPDFでダウンロードする →             │
│                                                 │
└─────────────────────────────────────────────────┘
```

### モーダルのポイント

1. **価値を明示**: 「保存するとできること」を説明
2. **代替手段を提示**: 「PDFでダウンロード」も可能
3. **ログイン導線**: 既存ユーザー向けのリンク

---

## 決定事項

- [ ] **案A（保存時のみ登録）** を採用する
- [ ] **案B（結果表示時に登録）** を採用する
- [ ] **案C（計算前に登録）** を採用する

---

## 技術的な変更点

### 1. 新しいシミュレーターページの作成

**場所**: `app/simulator/page.tsx`（既存LPを置き換え）

**変更内容**:
- `SimulatorClient.tsx` の機能を `/simulator/` で動作させる
- 認証なしでも計算・表示可能に
- 保存時のみ認証チェック

### 2. 保存時の登録モーダル

**新規作成**: `components/simulator/RegisterModal.tsx`

**動作**:
```tsx
const handleSave = () => {
  if (!user) {
    setShowRegisterModal(true);  // 登録モーダル表示
    return;
  }
  saveSimulation(data);  // 保存実行
};
```

### 3. Python API

**変更なし**: `api/simulate.py` はそのまま使用

- 認証チェックなし（現状維持）
- 計算ロジックはそのまま

### 4. LPページの対応

**選択肢**:
- A) `/simulator/` をシミュレーターにして、LPを別URLに移動
- B) `/` をLPにして、`/simulator/` をシミュレーターに

**推奨**: B案（現状のLPは `/` にある）

---

## 実装タスク

### Phase 1: シミュレーター公開化

- [ ] `app/simulator/` にシミュレーター本体を移動/コピー
- [ ] 認証なしで動作するよう修正
- [ ] レイアウトを非ログイン用に調整（サイドバーなし）

### Phase 2: 保存時の登録フロー

- [ ] `RegisterModal.tsx` 作成
- [ ] 保存ボタン押下時の認証チェック追加
- [ ] 登録後に保存を実行するフロー実装

### Phase 3: マイページ連携

- [ ] 保存後にマイページへの導線表示
- [ ] マイページから `/simulator/?edit=xxx` で編集可能に

### Phase 4: LP・導線の調整

- [ ] LPの「無料登録」ボタンを「今すぐ試す」に変更
- [ ] メタ情報（SEO）の更新
- [ ] 「登録不要で使える」訴求を追加

---

## テスト項目

### 機能テスト

- [ ] 未ログインでシミュレーション計算ができる
- [ ] 未ログインで結果が表示される
- [ ] 未ログインでPDF出力ができる
- [ ] 未ログインで保存ボタンを押すと登録モーダルが表示される
- [ ] 登録後に保存が実行される
- [ ] ログイン済みで保存ができる

### 回帰テスト

- [ ] マイページからの物件編集が動作する
- [ ] 既存ユーザーの保存済み物件が表示される

---

## リスク・注意点

1. **API負荷**: 認証なしでAPIを叩けるようになるため、悪意のある大量リクエストに注意
   - 対策: レートリミットの検討（将来）

2. **データ移行**: 既存ユーザーの保存済みデータに影響なし

3. **SEO**: URL変更があればリダイレクト設定が必要

---

## スケジュール

| フェーズ | 作業 | 見積もり |
|----------|------|----------|
| Phase 1 | シミュレーター公開化 | 2-3時間 |
| Phase 2 | 保存時の登録フロー | 1-2時間 |
| Phase 3 | マイページ連携 | 1時間 |
| Phase 4 | LP・導線の調整 | 1時間 |
| テスト | 動作確認 | 1時間 |
| **合計** | | **6-8時間** |

---

## 承認

- [ ] 仕様承認
- [ ] 実装開始

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-13 | 初版作成 |

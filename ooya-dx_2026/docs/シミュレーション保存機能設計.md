# シミュレーション保存機能設計

**ステータス:** 未実装（課題）
**優先度:** 高（Stripe実装後に着手）
**最終更新:** 2026年1月8日

---

## 概要

ユーザーが実行したシミュレーション結果をNeon PostgreSQLに保存し、後から閲覧・再利用できるようにする機能。

---

## 現状

| 項目 | 状態 |
|------|------|
| Prisma Simulation モデル | ❌ 未作成 |
| 保存 API | ❌ 未作成 |
| 取得 API | ❌ 未作成 |
| フロントエンド連携 | ❌ ダミー関数のまま |

### 現在のコード（SimulatorClient.tsx）

```typescript
// TODO: Neon Auth 移行後に有効化
const saveSimulation = async (..._args: any[]): Promise<{ data: any; error: null }> =>
  ({ data: { id: 'temp-id' }, error: null }); // useSupabaseData();
```

以前は Supabase を使用していたが、Neon Auth 移行時にコメントアウトされた状態。

---

## 設計

### データベース設計

#### Simulation テーブル

```prisma
model Simulation {
  id          String   @id @default(cuid())
  userId      String                          // Neon Auth の User ID
  name        String                          // シミュレーション名（物件名など）
  propertyUrl String?                         // 物件URL（任意）
  imageUrl    String?                         // 物件画像URL（Vercel Blob）
  inputData   Json                            // 入力データ（フォーム内容）
  results     Json?                           // 計算結果
  cashFlow    Json?                           // キャッシュフローテーブル
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}
```

#### 保存するデータ構造

**inputData（入力データ）:**
```json
{
  "propertyName": "サンプルマンション",
  "purchasePrice": 50000000,
  "buildingPrice": 30000000,
  "landPrice": 20000000,
  "monthlyRent": 150000,
  "managementFee": 5000,
  "loanAmount": 45000000,
  "loanInterestRate": 1.5,
  "loanPeriod": 35,
  "buildingAge": 10,
  "buildingStructure": "RC",
  ...
}
```

**results（計算結果）:**
```json
{
  "surfaceYield": 3.6,
  "realYield": 2.8,
  "irr": 5.2,
  "ccr": 8.5,
  "dscr": 1.35,
  "ltv": 90,
  "paybackPeriod": 12,
  ...
}
```

**cashFlow（キャッシュフロー）:**
```json
[
  { "year": 1, "income": 1800000, "expenses": 500000, "cashFlow": 1300000 },
  { "year": 2, "income": 1782000, "expenses": 510000, "cashFlow": 1272000 },
  ...
]
```

---

## API 設計

### エンドポイント一覧

| メソッド | パス | 用途 |
|---------|------|------|
| POST | `/api/simulations` | 新規保存 |
| GET | `/api/simulations` | 一覧取得 |
| GET | `/api/simulations/[id]` | 詳細取得 |
| PUT | `/api/simulations/[id]` | 更新 |
| DELETE | `/api/simulations/[id]` | 削除 |

### POST /api/simulations

**リクエスト:**
```typescript
{
  name: string;
  propertyUrl?: string;
  imageUrl?: string;
  inputData: object;
  results?: object;
  cashFlow?: object[];
}
```

**レスポンス:**
```typescript
{
  id: string;
  createdAt: string;
}
```

### GET /api/simulations

**レスポンス:**
```typescript
{
  simulations: [
    {
      id: string;
      name: string;
      imageUrl?: string;
      createdAt: string;
      updatedAt: string;
      // 一覧では results の概要のみ
      summary: {
        surfaceYield: number;
        irr: number;
      }
    }
  ]
}
```

### GET /api/simulations/[id]

**レスポンス:**
```typescript
{
  id: string;
  name: string;
  propertyUrl?: string;
  imageUrl?: string;
  inputData: object;
  results: object;
  cashFlow: object[];
  createdAt: string;
  updatedAt: string;
}
```

---

## フロントエンド設計

### 保存フロー

```
シミュレーション実行
    ↓
計算結果表示
    ↓
「保存」ボタンクリック
    ↓
POST /api/simulations
    ↓
「保存しました」メッセージ表示
```

### 読み込みフロー

```
マイページ → 保存済みシミュレーション一覧
    ↓
一覧から選択
    ↓
GET /api/simulations/[id]
    ↓
inputData をフォームに復元
    ↓
再計算 or 結果表示
```

### UI 変更点

1. **シミュレーター画面**
   - 計算結果に「保存」ボタン追加
   - 保存成功時のトースト表示

2. **マイページ**
   - 保存済みシミュレーション一覧ページ追加
   - カード形式で物件画像・名前・利回り表示
   - 削除機能

---

## 実装手順

### Phase 1: バックエンド

1. [ ] Prisma スキーマに Simulation モデル追加
2. [ ] `npx prisma migrate dev` でマイグレーション
3. [ ] `/api/simulations/route.ts` 作成（POST, GET）
4. [ ] `/api/simulations/[id]/route.ts` 作成（GET, PUT, DELETE）
5. [ ] 認証チェック（getServerUser）追加
6. [ ] サブスク確認（active/trialing のみ保存可能）

### Phase 2: フロントエンド

7. [ ] `hooks/useSimulations.ts` 作成
8. [ ] SimulatorClient.tsx の saveSimulation を実装
9. [ ] 保存ボタン・トースト UI 追加
10. [ ] 保存済み一覧ページ作成 `/mypage/simulations`
11. [ ] 読み込み機能実装

### Phase 3: テスト

12. [ ] 保存・読み込みの動作確認
13. [ ] 複数シミュレーション管理確認
14. [ ] 削除機能確認

---

## 制限事項

| 項目 | 制限値 | 理由 |
|------|--------|------|
| 保存可能数 | 無制限（または50件） | 要検討 |
| データサイズ | 1MB/件 | JSON カラムの制限 |

---

## セキュリティ考慮事項

1. **認証必須**
   - 全 API で getServerUser() による認証チェック

2. **所有者確認**
   - 取得・更新・削除時に userId の一致を確認

3. **サブスク確認**
   - 保存機能は有料会員のみ（active/trialing）

---

## 画面イメージ

### 保存済み一覧ページ

```
┌────────────────────────────────────────────────────┐
│ マイページ > 保存済みシミュレーション              │
├────────────────────────────────────────────────────┤
│                                                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ 🏢画像   │  │ 🏢画像   │  │ 🏢画像   │        │
│  │          │  │          │  │          │        │
│  │ 物件A    │  │ 物件B    │  │ 物件C    │        │
│  │ 利回り3.6%│  │ 利回り4.2%│  │ 利回り5.1%│        │
│  │ IRR 5.2% │  │ IRR 6.1% │  │ IRR 7.3% │        │
│  │          │  │          │  │          │        │
│  │[開く][削除]│  │[開く][削除]│  │[開く][削除]│        │
│  └──────────┘  └──────────┘  └──────────┘        │
│                                                    │
└────────────────────────────────────────────────────┘
```

### シミュレーター画面（保存ボタン追加）

```
┌────────────────────────────────────────────────────┐
│ シミュレーション結果                               │
├────────────────────────────────────────────────────┤
│                                                    │
│  表面利回り: 3.6%    実質利回り: 2.8%             │
│  IRR: 5.2%           CCR: 8.5%                    │
│  DSCR: 1.35          LTV: 90%                     │
│                                                    │
│  ┌─────────────────────────────────────────────┐  │
│  │           35年間キャッシュフロー            │  │
│  │           📊 グラフ                         │  │
│  └─────────────────────────────────────────────┘  │
│                                                    │
│  [📥 PDFダウンロード]  [💾 保存する]              │
│                                                    │
└────────────────────────────────────────────────────┘
```

---

## 依存関係

```
Stripe アクセス制御
    ↓
シミュレーション保存機能 ← 今ここが課題
    ↓
保存済み一覧ページ
```

---

## 参考

- 現在の SimulatorClient.tsx: `app/mypage/simulator/SimulatorClient.tsx`
- Prisma スキーマ: `prisma/schema.prisma`
- 認証ヘルパー: `lib/auth/server.ts`

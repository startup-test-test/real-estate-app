<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç‹¬è‡ªä½“é¨“æ•´ç†ï½œ7ç‰©ä»¶ Ã— 15ã‚«ãƒ†ã‚´ãƒª</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #232733;
    --border: #2e3340;
    --text: #e2e4e9;
    --text-dim: #8b8fa3;
    --accent: #6c8cff;
    --accent-dim: #4a62b3;
    --green: #4ade80;
    --green-dim: #166534;
    --yellow: #fbbf24;
    --red: #f87171;
    --orange: #fb923c;
    --purple: #a78bfa;
    --pink: #f472b6;
    --cyan: #22d3ee;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    padding: 24px;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    max-width: 1200px;
  }

  h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
  .subtitle { color: var(--text-dim); font-size: 0.85rem; }

  .header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .save-status { font-size: 0.75rem; color: var(--text-dim); margin-right: 8px; }
  .save-status.saved { color: var(--green); }

  .btn {
    padding: 8px 16px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--surface);
    color: var(--text);
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s;
  }

  .btn:hover { border-color: var(--accent-dim); background: var(--surface2); }

  .btn-accent {
    background: var(--accent-dim);
    border-color: var(--accent);
    color: var(--accent);
  }

  .btn-accent:hover { background: var(--accent); color: var(--bg); }

  .btn-danger {
    border: none;
    background: transparent;
    color: var(--text-dim);
    padding: 2px 6px;
    font-size: 0.7rem;
    cursor: pointer;
  }

  .btn-danger:hover { color: var(--red); }

  /* Stats */
  .stats-bar {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
    max-width: 1200px;
  }

  .stat {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 20px;
    text-align: center;
  }

  .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
  .stat-label { font-size: 0.75rem; color: var(--text-dim); }

  /* Grid layout */
  .grid-container {
    overflow-x: auto;
    padding-bottom: 16px;
  }

  .grid-table {
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  /* Sticky category column */
  .grid-table th,
  .grid-table td {
    border: 1px solid var(--border);
    vertical-align: top;
  }

  .grid-table thead th {
    background: var(--surface);
    padding: 0;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  .grid-table .col-cat {
    position: sticky;
    left: 0;
    z-index: 3;
    background: var(--surface);
    min-width: 200px;
    max-width: 200px;
  }

  .grid-table thead .col-cat {
    z-index: 4;
  }

  /* Property header cell */
  .prop-header-cell {
    min-width: 300px;
    max-width: 300px;
    padding: 12px 16px;
    text-align: center;
  }

  .prop-header-num {
    width: 32px; height: 32px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
    margin-bottom: 4px;
  }

  .p1 { background: #1e3a5f; color: #60a5fa; }
  .p2 { background: #1a3329; color: #4ade80; }
  .p3 { background: #3b2f1a; color: #fbbf24; }
  .p4 { background: #2d1f3d; color: #a78bfa; }
  .p5 { background: #3d1f2b; color: #f472b6; }
  .p6 { background: #1a3333; color: #22d3ee; }
  .p7 { background: #3d2b1f; color: #fb923c; }

  .prop-header-title {
    font-weight: 600;
    font-size: 0.9rem;
  }

  .prop-header-sub {
    font-size: 0.75rem;
    color: var(--text-dim);
  }

  .prop-header-type {
    display: inline-block;
    font-size: 0.7rem;
    padding: 1px 8px;
    border-radius: 10px;
    margin-top: 4px;
  }

  .type-res { background: rgba(167,139,250,0.2); color: var(--purple); }
  .type-inv { background: rgba(74,222,128,0.15); color: var(--green); }

  .prop-header-pct {
    margin-top: 6px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  /* Category label */
  .cat-cell {
    padding: 12px 16px;
    background: var(--surface);
  }

  .cat-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    font-size: 0.85rem;
    white-space: nowrap;
  }

  .cat-icon { font-size: 1rem; }

  /* Content cell */
  .content-cell {
    padding: 10px 14px;
    min-width: 300px;
    max-width: 300px;
    background: var(--bg);
  }

  .content-cell ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .content-cell li {
    position: relative;
    padding-left: 14px;
    margin-bottom: 4px;
    display: flex;
    align-items: flex-start;
    gap: 4px;
    font-size: 0.8rem;
    line-height: 1.6;
  }

  .content-cell li::before {
    content: 'ãƒ»';
    position: absolute;
    left: 0;
    color: var(--accent);
  }

  .item-text {
    flex: 1;
    cursor: text;
    padding: 2px 4px;
    border-radius: 4px;
    transition: background 0.2s;
  }

  .item-text:hover { background: var(--surface2); }

  .item-text:focus {
    outline: none;
    background: var(--surface2);
    box-shadow: 0 0 0 1px var(--accent-dim);
  }

  .add-item-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    margin-top: 4px;
    border: 1px dashed var(--border);
    border-radius: 6px;
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 0.75rem;
    transition: all 0.2s;
  }

  .add-item-btn:hover {
    border-color: var(--accent-dim);
    color: var(--accent);
    background: rgba(108,140,255,0.05);
  }

  .empty-msg {
    color: var(--text-dim);
    font-style: italic;
    font-size: 0.8rem;
  }

  .badge {
    display: inline-block;
    padding: 1px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    margin-bottom: 6px;
  }

  .badge-filled { background: rgba(74,222,128,0.15); color: var(--green); }
  .badge-empty { background: rgba(248,113,113,0.1); color: var(--text-dim); }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 0.85rem;
    color: var(--text);
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s;
    z-index: 100;
  }

  .toast.show { opacity: 1; transform: translateY(0); }
  .toast-success { background: var(--green-dim); border: 1px solid var(--green); }
  .toast-info { background: var(--accent-dim); border: 1px solid var(--accent); }

  /* Scroll hint */
  .scroll-hint {
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-bottom: 8px;
  }
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>ç‹¬è‡ªä½“é¨“æ•´ç†</h1>
    <p class="subtitle">7ç‰©ä»¶ã®è³¼å…¥å®Ÿç¸¾ &times; 15ã‚«ãƒ†ã‚´ãƒªï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›† / ï¼‹ã§è¿½åŠ  / âœ•ã§å‰Šé™¤ï¼‰</p>
  </div>
  <div class="header-actions">
    <span class="save-status" id="saveStatus"></span>
    <button class="btn btn-accent" onclick="saveToFile()">data.json ã«ä¿å­˜</button>
    <button class="btn" onclick="importJSON()">JSONèª­è¾¼</button>
    <button class="btn" onclick="resetData()">åˆæœŸãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™</button>
  </div>
</div>

<div class="stats-bar" id="statsBar"></div>

<p class="scroll-hint">â† æ¨ªã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦å…¨ç‰©ä»¶ã‚’ç¢ºèª â†’</p>

<div class="grid-container">
  <table class="grid-table" id="gridTable"></table>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="fileInput" accept=".json" style="display:none;">

<script>
const STORAGE_KEY = 'experience_data_v1';
const DATA_FILE = 'data.json';

const categories = [
  { key: 'purchase',    icon: 'ğŸ ', name: 'â‘ ç‰©ä»¶è³¼å…¥ã®ãƒ—ãƒ­ã‚»ã‚¹' },
  { key: 'finance',     icon: 'ğŸ¦', name: 'â‘¡èè³‡ãƒ»ãƒ­ãƒ¼ãƒ³' },
  { key: 'renovation',  icon: 'ğŸ”¨', name: 'â‘¢ãƒªãƒ•ã‚©ãƒ¼ãƒ ' },
  { key: 'vacancy',     icon: 'ğŸ‘¤', name: 'â‘£ç©ºå®¤å¯¾ç­–ãƒ»å®¢ä»˜ã‘' },
  { key: 'tax',         icon: 'ğŸ“‹', name: 'â‘¤ç¨å‹™ãƒ»ç¢ºå®šç”³å‘Š' },
  { key: 'sale',        icon: 'ğŸ’°', name: 'â‘¥å£²å´' },
  { key: 'study',       icon: 'ğŸ“š', name: 'â‘¦å‹‰å¼·ã—ãŸäº‹ãƒ»æ›¸ç±' },
  { key: 'other',       icon: 'ğŸ’¡', name: 'â‘§ãã®ä»–ï¼ˆæˆåŠŸãƒ»å¤±æ•—ï¼‰' },
  { key: 'corporate',   icon: 'ğŸ¢', name: 'â‘¨æ³•äººãƒ»æ³•äººåŒ–' },
  { key: 'cashflow',    icon: 'ğŸ“Š', name: 'â‘©åæ”¯ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼' },
  { key: 'management',  icon: 'ğŸ”§', name: 'â‘ªç‰©ä»¶ç®¡ç†ãƒ»é‹å–¶' },
  { key: 'area',        icon: 'ğŸ“', name: 'â‘«ã‚¨ãƒªã‚¢é¸å®š' },
  { key: 'insurance',   icon: 'ğŸ›¡ï¸', name: 'â‘¬ä¿é™º' },
  { key: 'agent',       icon: 'ğŸ¤', name: 'â‘­ä¸å‹•ç”£ä¼šç¤¾ã¨ã®ä»˜ãåˆã„æ–¹' },
  { key: 'duediligence',icon: 'ğŸ”', name: 'â‘®ç‰©ä»¶èª¿æŸ»ãƒ»DD' }
];

const defaultProperties = [
  {
    id: 1, year: '2019', title: 'å“å·åŒº æ–°ç¯‰ãƒãƒ³ã‚·ãƒ§ãƒ³', purpose: 'è‡ªå·±å±…ä½',
    subtitle: 'ä½å®…ãƒ­ãƒ¼ãƒ³ï¼ˆãƒ•ãƒ©ãƒƒãƒˆ35Sï¼‰ã§è³¼å…¥',
    data: {
      purchase: ['æŒã¡å®¶ã‚’åæ”¯è¨ˆç®—ã§ãã‚‹ã®ã‹æ¤œè¨¼','æŒã¡å®¶ã®é¸å®šæ–¹æ³•','æŒã¡å®¶ vs è³ƒè²¸ã®æ¯”è¼ƒæ¤œè¨ï¼ˆKW: æŒã¡å®¶ è³ƒè²¸ ã©ã£ã¡ï¼‰','ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ãŒåˆã‚ã¦å®¶ã‚’è²·ã†ã€‚å®Ÿéš›ã«è²·ã£ãŸã‚¹ãƒšãƒƒã‚¯ã‚’è©³ç´°ã«è¨˜è¼‰'],
      finance: ['ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã§ã‚‚ä½å®…ãƒ­ãƒ¼ãƒ³ãŒçµ„ã‚ãŸï¼ˆKW: ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ ä½å®…ãƒ­ãƒ¼ãƒ³ï¼‰','10å‰²èè³‡ã®ãƒ•ãƒ«ãƒ­ãƒ¼ãƒ³ã‚’ãƒ•ãƒ©ãƒƒãƒˆ35Sã§å®Ÿç¾'],
      renovation: ['ãƒªãƒ•ã‚©ãƒ¼ãƒ æ¥­è€…ã¨ã®æ‰“ã¡åˆã‚ã›ãƒ—ãƒ­ã‚»ã‚¹'],
      vacancy: ['å®¢ä»˜ã‘ã«å›°ã£ãŸæ™‚ã®å¯¾ç­–','ãƒã‚¤ã‚½ã‚¯ã®ä½œæˆã¨æ´»ç”¨'],
      tax: ['3000ä¸‡å††ã®ç‰¹åˆ¥æ§é™¤ã‚’å®Ÿéš›ã«ä½¿ç”¨'],
      sale: ['å£²å´æ™‚ã®ä»²ä»‹æ‰‹æ•°æ–™ã‚’50%ã«äº¤æ¸‰','å°‚ä»»åª’ä»‹ vs ä¸€èˆ¬åª’ä»‹ã®é¸æŠçµŒé¨“'],
      study: ['ã€Œãƒãƒ³ã‚·ãƒ§ãƒ³ã¯10å¹´ã§å£²ã‚Šãªã•ã„ã€ã‚’å‚è€ƒã«èª­äº†','ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚·ãƒ£ãƒ«ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ã§ã®å­¦ç¿’ã‚’æ¤œè¨'],
      other: ['ä½å®…ãƒ­ãƒ¼ãƒ³ã®å£²å´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯éœ€è¦ãŒã‚ã‚‹ã‹æ¤œè¨¼'],
      corporate: [], cashflow: [], management: [], area: [], insurance: [], agent: [], duediligence: []
    }
  },
  {
    id: 2, year: '2023', title: 'åŸ¼ç‰çœŒæ±éƒ¨ ç¯‰å¤æˆ¸å»º', purpose: 'åç›Šç‰©ä»¶',
    subtitle: 'åˆã‚ã¦ã®åç›Šç‰©ä»¶ã€‚ç¾é‡‘ã§è³¼å…¥',
    data: {
      purchase: ['ãªãœç©ºãå®¶ã‚’è²·ã£ãŸã®ã‹','ç©ºãå®¶ã‚’è³ƒè²¸ç›®çš„ã§è³¼å…¥','ä½•ä»¶ãã‚‰ã„ã®ç‰©ä»¶ã‚’è¦‹ãŸã‹','è³¼å…¥ã®æ„æ€æ±ºå®šãƒ—ãƒ­ã‚»ã‚¹','åœŸåœ°ã®å€¤æ®µã§è³¼å…¥ï¼ˆåœŸåœ°å€¤ç‰©ä»¶ã®è¦‹æ¥µã‚ï¼‰','è²·ä»˜ç”³è¾¼ã€‚ä»²ä»‹æ‰‹æ•°æ–™ã¯400ä¸‡å††ãƒ™ãƒ¼ã‚¹ã§è¨ˆç®—'],
      finance: ['æ—¥æœ¬æ”¿ç­–é‡‘èå…¬åº«ã‹ã‚‰è³‡é‡‘èª¿é”ï¼ˆåˆã‚ã¦ã®ç©ºãå®¶æŠ•è³‡ï¼‰','å®Ÿéš›ã«æå‡ºã—ãŸè³‡æ–™ã‚ã‚Š','é‡‘èæ©Ÿé–¢17ç¤¾ã«æ–­ã‚‰ã‚ŒãŸçµŒé¨“','250ä¸‡å††ã‚’5å¹´é–“ã§å€Ÿå…¥ã€‚é‡‘åˆ©ã®è©³ç´°','èè³‡æ‰¿èªå¾Œã«åŸ¼ç‰çœŒä¿¡ç”¨é‡‘åº«ã®å£åº§é–‹è¨­ï¼ˆèè³‡å…¥é‡‘ç”¨ï¼‰'],
      renovation: ['400ä¸‡å††ã®ãƒ•ãƒ«ãƒªãƒ•ã‚©ãƒ¼ãƒ ','3ãƒ¶æœˆã‹ã‘ã¦å®Œæˆ','æš®ã‚‰ã—ã®ãƒãƒ¼ã‚±ãƒƒãƒˆã§éƒ¨åˆ†çš„ã«å†…è£…ã‚’æ•´ç†'],
      vacancy: ['ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã‚’å®Ÿæ–½','ã‚¦ãƒ©ã‚±ãƒ³ã•ã‚“ã®æ›¸ç±ã‚’å‚è€ƒã«','ãƒã‚¤ã‚½ã‚¯ã‚’æŒã£ã¦æœ€å¯„é§…ã‚’å›ã£ã¦éœ€è¦ãƒ»å®¶è³ƒã‚’ãƒ’ã‚¢ãƒªãƒ³ã‚°','æ•·é‡‘ãƒ»ç¤¼é‡‘ã‚¼ãƒ­ã€1ãƒ¶æœˆãƒ•ãƒªãƒ¼ãƒ¬ãƒ³ãƒˆè¨­å®š','çŸ­æœŸè§£ç´„ãªã—ï¼ˆ24ãƒ¶æœˆã§è¨­å®šï¼‰','æš®ã‚‰ã—ã®ãƒãƒ¼ã‚±ãƒƒãƒˆã§éƒ¨åˆ†çš„ã«å†…è£…æ•´ç†','ãƒ†ãƒ¬ãƒ“å‡ºæ¼”ä¾é ¼ã‚’å—ã‘ã¦ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã«å›ç­”'],
      tax: ['æ¸›ä¾¡å„Ÿå´è²»ã¯15å¹´é–“ã§è¨ˆä¸Šã€‚å‚µå‹™å„Ÿé‚„å¹´æ•°ã‚’é•·ãã™ã‚‹ç‚º'],
      sale: [],
      study: ['åœŸåœ°å€¤ç‰©ä»¶ã®è²·ã„æ–¹ã®å‹•ç”»ã§å­¦ç¿’','ã‚¦ãƒ©ã‚±ãƒ³ä¸å‹•ç”£ã®æˆ¸å»ºæŠ•è³‡ã®å†…å®¹ã‚’å‚è€ƒã«','ç©ºãå®¶å†ç”Ÿã«é–¢ã™ã‚‹æ›¸ç±ã‚’èª­äº†'],
      other: [],
      corporate: ['æ³•äººã§å®Ÿæ–½ã®ãŸã‚çµŒå–¶è€…ä¿è¨¼ãªã—'],
      cashflow: [], management: [], area: [], insurance: [], agent: [], duediligence: []
    }
  },
  {
    id: 3, year: '2023', title: 'åŸ¼ç‰çœŒæ±éƒ¨ ç¯‰å¤æˆ¸å»º', purpose: 'åç›Šç‰©ä»¶',
    subtitle: 'ç¾é‡‘ã§è³¼å…¥',
    data: {
      purchase: ['ç¯‰å¤ã§åœŸåœ°å€¤ã§å‡ºãŸãŸã‚è³¼å…¥'],
      finance: ['åŸ¼ç‰çœŒä¿¡ç”¨é‡‘åº«ã§ä¿è¨¼å”ä¼šèè³‡ï¼ˆ10å¹´ãƒ­ãƒ¼ãƒ³ï¼‰','ã•ã„ãŸã¾å¸‚ã®åˆ¶åº¦ã‚’æ´»ç”¨'],
      renovation: [],
      vacancy: ['ã™ãã«å®¢ä»˜ã‘ã§ããŸ'],
      tax: [], sale: [], study: [], other: [],
      corporate: [], cashflow: [], management: [], area: [], insurance: [], agent: [], duediligence: []
    }
  },
  {
    id: 4, year: '2024', title: 'è¶Šè°·å¸‚ ãƒ•ã‚¡ãƒŸãƒªãƒ¼åŒºåˆ†ãƒãƒ³ã‚·ãƒ§ãƒ³', purpose: 'åç›Šç‰©ä»¶',
    subtitle: 'ãƒªãƒ¼ã‚¹ãƒãƒƒã‚¯ã«ã¦è³¼å…¥',
    data: {
      purchase: ['ãƒªãƒ¼ã‚¹ãƒãƒƒã‚¯ã«ã¦è³¼å…¥','å®šæœŸå€Ÿå®¶å¥‘ç´„ã‚’è¨­å®š'],
      finance: ['åŸ¼ç‰çœŒã®ä¿¡ç”¨é‡‘åº«ã§15å¹´ã®ãƒ•ãƒ«ãƒ­ãƒ¼ãƒ³'],
      renovation: [], vacancy: [], tax: [], sale: [], study: [], other: [],
      corporate: [], cashflow: [], management: [], area: [], insurance: [], agent: [], duediligence: []
    }
  },
  {
    id: 5, year: '2024', title: 'å·è¶Šå¸‚ ãƒ•ã‚¡ãƒŸãƒªãƒ¼åŒºåˆ†ãƒãƒ³ã‚·ãƒ§ãƒ³', purpose: 'åç›Šç‰©ä»¶',
    subtitle: 'ãƒ•ãƒ«ãƒ­ãƒ¼ãƒ³ã§è³¼å…¥',
    data: { purchase:[],finance:[],renovation:[],vacancy:[],tax:[],sale:[],study:[],other:[],corporate:[],cashflow:[],management:[],area:[],insurance:[],agent:[],duediligence:[] }
  },
  {
    id: 6, year: '2024', title: 'ã•ã„ãŸã¾å¸‚æµ¦å’ŒåŒº æˆ¸å»º', purpose: 'åç›Šç‰©ä»¶',
    subtitle: 'ãƒ•ãƒ«ãƒ­ãƒ¼ãƒ³ã§è³¼å…¥',
    data: { purchase:[],finance:[],renovation:[],vacancy:[],tax:[],sale:[],study:[],other:[],corporate:[],cashflow:[],management:[],area:[],insurance:[],agent:[],duediligence:[] }
  },
  {
    id: 7, year: '2025', title: 'ã•ã„ãŸã¾å¸‚å¤§å®®åŒº ãƒ•ãƒ«ãƒªãƒãƒ™æˆ¸å»º', purpose: 'è‡ªå·±å±…ä½',
    subtitle: 'ä½å®…ãƒ­ãƒ¼ãƒ³ã§è³¼å…¥',
    data: { purchase:[],finance:[],renovation:[],vacancy:[],tax:[],sale:[],study:[],other:[],corporate:[],cashflow:[],management:[],area:[],insurance:[],agent:[],duediligence:[] }
  }
];

// ===== DATA =====
let properties = [];

async function loadData() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    try { properties = JSON.parse(saved); showSaveStatus('ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾©å…ƒ'); return; } catch(e) {}
  }
  try {
    const res = await fetch(DATA_FILE);
    if (res.ok) { properties = await res.json(); localStorage.setItem(STORAGE_KEY, JSON.stringify(properties)); showSaveStatus('data.json ã‹ã‚‰èª­ã¿è¾¼ã¿'); return; }
  } catch(e) {}
  properties = JSON.parse(JSON.stringify(defaultProperties));
}

function saveData() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(properties));
  showSaveStatus('è‡ªå‹•ä¿å­˜æ¸ˆã¿');
}

function showSaveStatus(msg) {
  const el = document.getElementById('saveStatus');
  el.textContent = msg;
  el.classList.add('saved');
  setTimeout(() => el.classList.remove('saved'), 3000);
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast toast-${type} show`;
  setTimeout(() => t.classList.remove('show'), 2000);
}

async function saveToFile() {
  const json = JSON.stringify(properties, null, 2);
  if (window.showSaveFilePicker) {
    try {
      const h = await window.showSaveFilePicker({ suggestedName: 'data.json', types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }] });
      const w = await h.createWritable(); await w.write(json); await w.close();
      showToast('data.json ã«ä¿å­˜ã—ã¾ã—ãŸ'); return;
    } catch(e) { if (e.name === 'AbortError') return; }
  }
  const blob = new Blob([json], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'data.json'; a.click();
  showToast('data.json ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰');
}

function importJSON() { document.getElementById('fileInput').click(); }

document.getElementById('fileInput').addEventListener('change', (e) => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const data = JSON.parse(ev.target.result);
      if (Array.isArray(data) && data[0]?.data) { properties = data; saveData(); renderAll(); showToast('èª­ã¿è¾¼ã¿å®Œäº†'); }
      else showToast('ç„¡åŠ¹ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ', 'info');
    } catch(err) { showToast('è§£æå¤±æ•—', 'info'); }
  };
  reader.readAsText(file); e.target.value = '';
});

function resetData() {
  if (!confirm('åˆæœŸãƒ‡ãƒ¼ã‚¿ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) return;
  properties = JSON.parse(JSON.stringify(defaultProperties));
  saveData(); renderAll(); showToast('ãƒªã‚»ãƒƒãƒˆå®Œäº†');
}

// ===== EDIT =====
function addItem(propId, catKey) {
  const prop = properties.find(p => p.id === propId);
  prop.data[catKey].push('ï¼ˆã“ã“ã«ä½“é¨“ã‚’å…¥åŠ›ï¼‰');
  saveData(); renderAll();
  setTimeout(() => {
    const cells = document.querySelectorAll(`.cell-p${propId}-${catKey} .item-text`);
    const last = cells[cells.length - 1];
    if (last) { last.focus(); const r = document.createRange(); r.selectNodeContents(last); const s = window.getSelection(); s.removeAllRanges(); s.addRange(r); }
  }, 50);
}

function deleteItem(propId, catKey, idx) {
  properties.find(p => p.id === propId).data[catKey].splice(idx, 1);
  saveData(); renderAll();
}

function updateItem(propId, catKey, idx, text) {
  const prop = properties.find(p => p.id === propId);
  if (text.trim() === '') prop.data[catKey].splice(idx, 1);
  else prop.data[catKey][idx] = text.trim();
  saveData(); renderStats();
}

// ===== RENDER =====
function renderAll() {
  renderStats();
  renderGrid();
}

function renderStats() {
  let filled = 0, all = 0, totalItems = 0;
  properties.forEach(p => {
    categories.forEach(c => {
      all++;
      if ((p.data[c.key]?.length || 0) > 0) filled++;
      totalItems += p.data[c.key]?.length || 0;
    });
  });
  document.getElementById('statsBar').innerHTML = `
    <div class="stat"><div class="stat-value">${properties.length}</div><div class="stat-label">ç‰©ä»¶æ•°</div></div>
    <div class="stat"><div class="stat-value">${filled}/${all}</div><div class="stat-label">è¨˜å…¥æ¸ˆã¿ã‚»ãƒ«</div></div>
    <div class="stat"><div class="stat-value">${Math.round(filled / all * 100)}%</div><div class="stat-label">å……å®Ÿåº¦</div></div>
    <div class="stat"><div class="stat-value">${totalItems}</div><div class="stat-label">ä½“é¨“é …ç›®æ•°</div></div>
  `;
}

function renderGrid() {
  const table = document.getElementById('gridTable');

  // Header row: ã‚«ãƒ†ã‚´ãƒª | ç‰©ä»¶1 | ç‰©ä»¶2 | ...
  let html = '<thead><tr><th class="col-cat" style="padding:12px 16px;text-align:left;">ã‚«ãƒ†ã‚´ãƒª</th>';
  properties.forEach(p => {
    const pctFilled = categories.filter(c => (p.data[c.key]?.length || 0) > 0).length;
    const pct = Math.round(pctFilled / categories.length * 100);
    const pctColor = pct >= 75 ? 'var(--green)' : pct >= 50 ? 'var(--yellow)' : pct > 0 ? 'var(--orange)' : 'var(--red)';
    const typeClass = p.purpose === 'è‡ªå·±å±…ä½' ? 'type-res' : 'type-inv';

    html += `<th class="prop-header-cell">
      <div class="prop-header-num p${p.id}">${p.id}</div><br>
      <div class="prop-header-title">${p.title}</div>
      <div class="prop-header-sub">${p.year}å¹´ | ${p.subtitle}</div>
      <span class="prop-header-type ${typeClass}">${p.purpose}</span>
      <div class="prop-header-pct" style="color:${pctColor}">${pct}% (${pctFilled}/${categories.length})</div>
    </th>`;
  });
  html += '</tr></thead>';

  // Body rows: each category
  html += '<tbody>';
  categories.forEach(cat => {
    html += `<tr>`;
    html += `<td class="col-cat cat-cell"><div class="cat-label"><span class="cat-icon">${cat.icon}</span>${cat.name}</div></td>`;

    properties.forEach(p => {
      const items = p.data[cat.key] || [];
      let cellHtml = `<div class="cell-p${p.id}-${cat.key}">`;

      cellHtml += `<span class="badge ${items.length > 0 ? 'badge-filled' : 'badge-empty'}">${items.length > 0 ? items.length + 'ä»¶' : 'æœªè¨˜å…¥'}</span>`;

      if (items.length > 0) {
        cellHtml += '<ul>' + items.map((item, idx) => `
          <li>
            <span class="item-text" contenteditable="true"
              onblur="updateItem(${p.id},'${cat.key}',${idx},this.textContent)"
              onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}"
            >${item}</span>
            <button class="btn-danger" onclick="deleteItem(${p.id},'${cat.key}',${idx})" title="å‰Šé™¤">âœ•</button>
          </li>
        `).join('') + '</ul>';
      }

      cellHtml += `<button class="add-item-btn" onclick="addItem(${p.id},'${cat.key}')">ï¼‹ è¿½åŠ </button>`;
      cellHtml += '</div>';

      html += `<td class="content-cell">${cellHtml}</td>`;
    });

    html += '</tr>';
  });
  html += '</tbody>';

  table.innerHTML = html;
}

// Init
loadData().then(() => renderAll());
</script>
</body>
</html>

# Vercelデプロイ障害レポート（2026-02-08）

> ステータス: **解決済み（キャッシュなしRedeployで復旧）**
> プロジェクト: ooya-dx_2026（`prj_rKZBQb3W4r0RZuUkk1iEDC5mfAz7`）
> リージョン: iad1（Washington, D.C., USA East）
> 障害時間: 12:28頃 〜 15:49頃（約3時間20分）
> 解決方法: ダッシュボードから**キャッシュなしでRedeploy**

---

## 概要

構造化データの軽微な修正（4行削除）をプッシュしたところ、Vercelのビルドが「Cloning completed」の後でハングし、Gitトリガーのデプロイができなくなった。約3時間20分にわたり複数の回避策を試行。最終的に**キャッシュなしのRedeploy**でビルドが正常に進行し、復旧した。

---

## 経緯

| 時刻 | 操作 | コミット | 結果 |
|------|------|----------|------|
| 12:28頃 | mainにプッシュ | `c17007d` | **成功（2m 13s）** — 本日最後の正常デプロイ |
| 12:28頃 | mainEntity削除（4行修正）をプッシュ | `b66f31a` | **ハング（10分超）** → キャンセル |
| 12:35頃 | 空コミットでリトライ | `91f0ca0` | **ハング（10分超）** → キャンセル |
| 12:40頃 | CLIから `vercel --prod` でデプロイ | - | 成功したが**別プロジェクト（real-estate-app）に配信**され本番未反映 |
| 12:45頃 | キャッシュなしで Redeploy | - | **ハング（6分超）** → キャンセル |
| 13:03頃 | 重複プロジェクトのGit連携解除後、再プッシュ | `876b546` | **ハング** → キャンセル |
| 13:39頃 | キャッシュなし + 空コミットで再プッシュ | `f97ccab` | **ハング** → キャンセル |
| 13:46頃 | Build Machine設定確認後、Redeploy | - | **ハング（10分超）** → キャンセル |
| 14:22頃 | 重複プロジェクト削除後、Redeploy（キャッシュなし） | `c17007d` | **ハング（5分超）** → キャンセル |
| 14:35頃 | Build Machine を Turbo→Standard に変更後、Redeploy | `c17007d` | Next.js未検出エラー（CLIデプロイの再デプロイのため） |
| 14:37頃 | 成功済みGitデプロイからRedeploy（キャッシュなし） | `c17007d` | **ハング（5分超）** → キャンセル |
| 14:44頃 | Root Directoryリセット後、Redeploy（キャッシュなし） | `c17007d` | **ハング（3分超）** → キャンセル |
| 14:52頃 | Root Directoryリセット後、developにプッシュ | `5975bc0` | **ハング（3分超）** → キャンセル |
| 14:55頃 | **プリビルトデプロイ** | develop最新 | デプロイ成功（32s）だが**ページ未生成で404発生** |
| 15:05頃 | **前回の正常デプロイに復旧** | `c17007d` | `vercel promote` で即座に復旧 |
| 15:23頃 | developにプッシュ（復旧テスト） | `dcb4b55` | **ハング（4分超）** → キャンセル |
| 15:48頃 | developにプッシュ（復旧テスト2） | `7eccdc3` | Gitトリガー: **ハング** → キャンセル |
| 15:49頃 | **ダッシュボードからキャッシュなしRedeploy** | `7eccdc3` | **成功（2m 50s）** ← 復旧！ |
| 15:58頃 | mainにマージ、キャッシュなしRedeploy | `7eccdc3` | **成功** — 本番デプロイ完了 |

---

## 症状

ビルドログが**毎回5行で停止**する：

```
Running build in Washington, D.C., USA (East) – iad1
Build machine configuration: 4 cores, 8 GB
Cloning github.com/startup-test-test/real-estate-app (Branch: ..., Commit: ...)
Cloning completed: 8.xxxs
(Skipping build cache / Restored build cache)
```

- `npm install` や `next build` が**一切始まらない**
- 10分以上経っても次のログが出ない
- Production / Preview どちらも同じ症状
- **Gitトリガーのビルドのみ発生**

---

## 切り分け結果

| 確認項目 | 結果 | 詳細 |
|----------|------|------|
| ローカルビルド | **正常に成功** | `npx next build` で全ページビルド完了 |
| コード変更 | 軽微 | ToolStructuredData.tsx から mainEntity を4行削除しただけ |
| キャッシュなし再デプロイ | 当初ハング → 後に**成功** | 時間経過後にキャッシュなしRedeployで復旧 |
| 重複プロジェクト削除 | **ハング** | `real-estate-app` プロジェクトを完全削除。改善なし |
| Build Machine変更 | **ハング** | Turbo→Standardに変更しても改善なし |
| Root Directoryリセット | **ハング** | 空→再設定しても改善なし |
| 重複プロジェクトでの同一コミット | **成功（2分）** | `real-estate-app` では同じコードが正常にビルド |
| プリビルトデプロイ | デプロイ成功だが**ページ未生成** | ローカル環境に環境変数がないためApp Routerのページが生成されず404 |
| Vercel Status Page | 直近で障害あり | Jan 30, Feb 3, Feb 7 にビルド関連障害が報告済み |
| Root Directory | 正常 | `ooya-dx_2026` に設定済み |
| Python依存 | 問題なし | requirements.txt は実質空（コメントのみ） |
| Gitリポジトリサイズ | 問題なし | 242MB（クローンは8秒で完了） |
| Node.js バージョン | 24.x | 正常デプロイ時と同じ |

---

## 根本原因

**Vercelのiad1リージョンにおけるGitクローン後のビルド開始処理の一時的なインフラ障害**

約3時間20分後にキャッシュなしRedeployで復旧。Vercel側のビルドキューまたはビルドランナーの詰まりが時間経過で解消されたと推定。

### 判断根拠

1. 同じコードが重複プロジェクト（`real-estate-app`）では正常にビルド成功（2分）
2. ローカルビルドは7秒で成功
3. コード変更は軽微（4行削除のみ）で原因ではない
4. Vercelステータスページに類似の障害が直近で複数報告されている
5. 時間経過後にキャッシュなしRedeployで復旧 → インフラ側の一時障害

### Vercelの直近障害履歴

| 日付 | 障害内容 | 関連性 |
|------|----------|--------|
| **Jan 30** | Elevated git clone duration at build time | **直接関連** — 同じ症状。公式回避策として `vercel build && vercel deploy --prebuilt` が案内された |
| **Feb 3** | Elevated latency creating new deployments | 関連 — デプロイ遅延 |
| **Feb 3** | Elevated Errors on API & Dashboard, Delayed Builds | 関連 — ビルド遅延 |
| **Feb 7** | Problems Loading Dashboard & Elevated Builds Error Rate | 関連 — ビルドエラー率上昇（前日） |

ステータスページ: https://www.vercel-status.com/

---

## 解決方法

### 最終的な解決: キャッシュなしRedeploy

ダッシュボードから**キャッシュなしでRedeploy**を実行したところ、ビルドが正常に進行した（2m 50s）。

**手順:**
1. Vercelダッシュボード → Deployments
2. 成功済みのデプロイの **「...」→ Redeploy**
3. **「Use existing Build Cache」のチェックを外す**
4. 実行

### プリビルトデプロイは使用不可

以下の方法はこのプロジェクトでは**使用不可**：

```bash
# ⚠️ このプロジェクトでは使わないこと
vercel build --prod && vercel deploy --prebuilt --prod
```

**理由:** ローカル環境にVercelのシステム環境変数がないため、Next.js App RouterのページがServerless Functionsとして生成されず、デプロイすると**サイト全体が404**になる。

### 404発生時の緊急復旧

もし誤ったデプロイで404が発生した場合、以下で即座に復旧できる：

```bash
npx vercel promote <正常なデプロイURL>
```

今回は `vercel promote ooya-dx2026-pwh7kg6jh-ooya-techs-projects.vercel.app` で復旧した。

---

## 対応済みアクション

- [x] 重複プロジェクト `real-estate-app` を**削除**（ビルド時間の浪費を防止）
- [x] 重複プロジェクト `ooya-saas`、`ooya-saas-zson` を**削除**（同じ重複問題）
- [x] `mockuphomepage` を**削除**（未使用プロジェクト）
- [x] Build Machine を **Turbo → Standard** に変更（過課金を防止）
- [x] Vercelサポートに**問い合わせ済み**（AIチャットボット経由）
- [x] **キャッシュなしRedeploy**でビルド復旧を確認
- [x] mainブランチに最新コードをマージ・本番デプロイ完了
- [x] リッチリザルトテストで**3件の有効なアイテム**を確認（mainEntity修正反映済み）

---

## 発見された副次的問題

### 重複プロジェクト問題

同じGitリポジトリに2つのVercelプロジェクトが紐づいていた：

| プロジェクト | 役割 | ドメイン | 対応 |
|-------------|------|---------|------|
| `ooya-dx_2026` | 本番 | ooya.tech | 継続使用 |
| `real-estate-app` | 不要な重複 | real-estate-app-seven-silk.vercel.app | **削除済み** |

- push のたびに2つのビルドが同時に走り、ビルド時間を浪費していた
- Build Minutes が月$22.27に膨れていた原因の一つ
- 初期セットアップ時にCLIで自動作成された残骸と推定

同様の重複が別リポジトリでも発見：

| プロジェクト | リポジトリ | 対応 |
|-------------|----------|------|
| `ooya-saas` | startup-test-test/ooya-saas | **削除済み** |
| `ooya-saas-zson` | startup-test-test/ooya-saas | **削除済み** |
| `mockuphomepage` | Git未接続 | **削除済み** |

### Build Machine 設定の不一致

- ダッシュボード設定: **Turbo performance**（30 vCPUs, 60 GB）— $0.126/分
- 実際のビルドログ: **4 cores, 8 GB**（Standard相当）
- Turbo料金が課金されているのにStandard性能で動いていた
- **対応済み**: Standardに明示変更

### Vercel利用料金への影響

| 項目 | 金額 | 備考 |
|------|------|------|
| Included Credit | $20.00 / $20.00 | 使い切り |
| Build Minutes | $22.27 | 重複ビルド＋ハングビルドの浪費 |
| On-Demand合計 | $3.69 | 超過分 |

---

## 今後の対応・教訓

### デプロイがハングした場合のチェックリスト

1. **Vercelステータスページを確認**: https://www.vercel-status.com/
2. **ダッシュボードからキャッシュなしRedeploy**を試す
3. 3分経っても5行のログのままなら**キャンセル**（ビルド時間の浪費を防止）
4. 複数回失敗する場合は**時間をおいて再試行**（30分〜数時間）
5. 改善しない場合は**Vercelサポートに問い合わせ**

### 復旧確認済み

- [x] Gitトリガービルドがキャッシュなしで正常に動作することを確認
- [x] リッチリザルトテストで構造化データの有効性を確認
- [ ] Vercelサポートからの回答を待つ
- [ ] 来月のBuild Minutes費用が正常化しているか確認
- [ ] `dekitayo`（www.dekitayo.jp）と `reform`（owners-reform.com）の削除を検討

---

## 参考

- Vercel Status: https://www.vercel-status.com/
- リッチリザルトテスト: https://search.google.com/test/rich-results
- Vercel プリビルトデプロイ: https://vercel.com/docs/cli/deploy#prebuilt-deployments
- Build stuck after Cloning completed: https://github.com/vercel/community/discussions/515

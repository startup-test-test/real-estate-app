# Vercelデプロイ障害レポート（2026-02-09）

> ステータス: **解決済み（Build Command上書きでキャッシュクリア）**
> プロジェクト: ooya-dx_2026
> リージョン: iad1（Washington, D.C., USA East）
> 関連: [2026-02-08 障害レポート](./Vercelデプロイ障害_20260208.md)

---

## 概要

2/8に発生したビルドキャッシュ起因のハング問題が再発。Gitプッシュによるデプロイでビルドキャッシュが復元されると、「Cloning completed」「Restored build cache」の後でビルドがハングする。キャッシュなしでRedeployすると正常にビルドが完了する。

---

## 経緯

| 時刻 | 操作 | ブランチ | 結果 |
|------|------|----------|------|
| 11:32頃 | developにプッシュ（SEO修正） | develop | **ハング**（キャッシュ復元後に停止） |
| - | キャンセル → キャッシュクリア → 再デプロイ | develop | **成功（3m 1s）** |
| 11:37頃 | mainにマージ・プッシュ | main | **ハング**（キャッシュ復元後に停止） |
| 11:40頃 | キャンセル → キャッシュなし再デプロイ | main | **成功（2m 56s）** ✅ |
| 11:48頃 | CDN Cache + Data Cache を Purge（ダッシュボード） | - | 完了 |
| 11:50頃 | 空コミットでGitプッシュ（Purge効果テスト） | develop | **ハング**（ビルドキャッシュは別物だった） |
| 11:55頃 | 環境変数 `VERCEL_FORCE_NO_BUILD_CACHE=1` を全環境に設定 | - | CLI で設定完了 |
| 11:58頃 | 環境変数設定後にGitプッシュ | develop | **ハング**（環境変数はBuild Cacheに効果なし） |
| - | 環境変数 `VERCEL_FORCE_NO_BUILD_CACHE` を全環境から削除 | - | 削除完了 |
| 12:03頃 | Build Command上書き（`rm -rf .next/cache node_modules/.cache && next build`） | develop | **成功（2m 8s）** ✅ |

---

## ハング時のビルドログ（共通パターン）

```
Running build in Washington, D.C., USA (East) – iad1
Build machine configuration: 4 cores, 8 GB
Cloning github.com/startup-test-test/real-estate-app (Branch: main, Commit: 4f9727d)
Cloning completed: 8.361s
Restored build cache from previous deployment (Hn1G7dHa2XAMUDDszLnojjpobRZF)
← ここで停止（5行目以降のログが出ない）
```

---

## パターン分析

| ビルド | キャッシュ | 結果 |
|--------|----------|------|
| 2/8 ダッシュボードRedeploy（キャッシュなし） | **なし（Skipping）** | **成功** |
| 2/8 Gitプッシュ | あり（Restored） | **ハング** |
| 2/9 developプレビュー（Gitプッシュ） | あり（Restored） | **ハング** |
| 2/9 developプレビュー（キャッシュなし再デプロイ） | **なし** | **成功（3m 1s）** |
| 2/9 main本番（Gitプッシュ） | あり（Restored） | **ハング** |

| 2/9 main本番（キャッシュなし再デプロイ） | **なし** | **成功（2m 56s）** |
| 2/9 CDN+Data Cache Purge後のGitプッシュ | あり（Restored） | **ハング** |

**結論: キャッシュありビルドは100%ハング、キャッシュなしは100%成功**

---

## 2/8からの変化

- 2/8: キャッシュなしRedeployで復旧後、Gitプッシュも正常に戻ると期待
- 2/9: **再発確認** — キャッシュなしで成功しても、次のGitプッシュで再びハング
- キャッシュの「破損→再生成→再破損」のサイクルが繰り返されている

---

## 対処法

### 即時対応（毎回のデプロイ）

1. Gitプッシュ後、**3分以内にビルドが進行しなければキャンセル**
2. ダッシュボードから **Redeploy → 「Use existing Build Cache」のチェックを外す**
3. キャッシュなしでビルド完了を確認

### 試行した対策と結果

| No. | 対策 | 結果 |
|:---:|------|:----:|
| 1 | ダッシュボードからキャッシュなしRedeploy | ✅ **毎回成功**（ただし手動操作が必要） |
| 2 | Settings → Caches → CDN Cache Purge（`*` で全削除） | ❌ **効果なし**（CDN CacheとBuild Cacheは別物） |
| 3 | Settings → Caches → Data Cache Purge | ❌ **効果なし**（Data CacheとBuild Cacheは別物） |
| 4 | キャッシュなし成功後の新キャッシュ再生成に期待 | ❌ **効果なし**（再生成されたキャッシュでも再びハング） |
| 5 | 環境変数 `VERCEL_FORCE_NO_BUILD_CACHE=1` を全環境に設定 | ❌ **効果なし**（ビルドキャッシュ制御には非対応） → 削除済み |
| 6 | **Build Command上書き: `rm -rf .next/cache node_modules/.cache && next build`** | ✅ **成功！ Gitプッシュで自動デプロイが正常動作（2m 8s）** |

#### キャッシュの種類（重要な学び）

Vercelには3種類のキャッシュがあり、ダッシュボードのCaches設定から削除できるのはCDNとDataのみ。**ビルドキャッシュはダッシュボードから直接削除できない。**

| キャッシュ | 用途 | ダッシュボードからPurge | 今回の問題 |
|-----------|------|:---:|:---:|
| **Build Cache** | ビルド成果物（node_modules, .next等） | ❌ 不可 | **これが原因** |
| CDN Cache | ページ配信キャッシュ | ✅ 可能 | 無関係 |
| Data Cache | ISR/データキャッシュ | ✅ 可能 | 無関係 |

### 恒久対応

| 方法 | 状態 |
|------|------|
| ~~環境変数 `VERCEL_FORCE_NO_BUILD_CACHE=1`~~ | ❌ 効果なし → 削除済み |
| **Vercelサポートへ問い合わせ** | **推奨（根本原因の特定のため）** |

### 解決策（採用）

**Settings → Build and Deployment → Build Command を上書き:**

```
rm -rf .next/cache node_modules/.cache && next build
```

これにより、ビルドキャッシュが復元されても、ビルド開始前にキャッシュファイルが削除され、正常にビルドが進行する。Gitプッシュからの自動デプロイが正常に動作するようになった。

#### 解決後のデプロイ結果

| ブランチ | ビルド時間 | 結果 |
|---------|:---:|:---:|
| develop（プレビュー） | 2m 8s | ✅ 成功 |
| main（本番） | 2m 7s | ✅ 成功 |

#### ユーザーへの影響

**影響なし。** 削除されるのはビルドマシン上のコンパイルキャッシュのみ。

| キャッシュ | 削除対象？ | 説明 |
|----------|:---:|------|
| `.next/cache`（ビルドキャッシュ） | ✅ 削除 | ビルド高速化用。ユーザーには無関係 |
| `node_modules/.cache` | ✅ 削除 | パッケージのビルドキャッシュ。ユーザーには無関係 |
| ユーザーのブラウザキャッシュ | ❌ 影響なし | そのまま維持される |
| CDNキャッシュ（ページ配信） | ❌ 影響なし | そのまま維持される |
| ISR/データキャッシュ | ❌ 影響なし | そのまま維持される |

---

## ビルド時間への影響

| | キャッシュあり（正常時） | Build Command上書き後 |
|---|---|---|
| ビルド時間 | 約2分 | 約2分8秒 |
| 差 | - | +約8秒 |

キャッシュクリア後のビルド時間はほぼ変わらず、影響は軽微。

---

## 関連情報

- 2/8 障害レポート: [Vercelデプロイ障害_20260208.md](./Vercelデプロイ障害_20260208.md)
- Vercel Status Page: https://www.vercelstatus.com/
- Vercel Community（同様の報告）: GitHub Discussions に「Cloning completed」後のハング報告あり

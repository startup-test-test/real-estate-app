# マイページアクセス不可（2026年1月24日発覚）

## 概要

- **発覚日時**: 2026年1月24日 15:30頃
- **発生日時**: 2026年1月21日 19:28（推定）
- **影響範囲**: `/mypage` および `/mypage/simulator` ページ
- **症状**: 「Application error: a client-side exception has occurred」エラーでマイページにアクセス不可

## エラー内容

### エラー1: react-joyride React 19 非互換

```
react@19.2.3 deduped invalid: "15 - 18" from node_modules/react-joyride
```

- **原因**: `react-joyride@2.9.3` は React 15-18のみサポート。React 19.2.3との互換性なし
- **問題箇所**:
  - `app/mypage/MyPageClient.tsx`
  - `app/mypage/simulator/SimulatorClient.tsx`
- **状況**: `run={false}` でチュートリアルを無効化していたが、コンポーネント自体がレンダリングされるため互換性エラー発生

### エラー2: Reactフック順序違反

```
Runtime Error: Rendered fewer hooks than expected.
This may be caused by an accidental early return statement.
```

- **原因**: `shared-header.tsx` で `useEffect` フックより前に早期リターン（`return null`）があった
- **問題箇所**: `components/shared-header.tsx` 43-45行目

```tsx
// 問題のコード（修正前）
const isDashboardRoute = DASHBOARD_ROUTES.some(route => pathname?.startsWith(route));
if (isDashboardRoute && !forceShow) {
  return null;  // ← useEffectより前に早期リターン
}

useEffect(() => { ... }, []);  // ← 早期リターン後は呼ばれない
```

## 発生原因

1. **2026年1月21日 19:28** - commit `3f80553` でヘッダーリファクタリング
   - `shared-header.tsx` 新規作成時にフック順序違反のコードを含めてしまった

2. **同日以降** - `/mypage` ルートでのみバグが顕在化
   - ダッシュボードルート（`/mypage`, `/dashboard`等）で早期リターンが発生
   - 他のページでは早期リターンしないためバグが潜在化

3. **react-joyride問題との複合**
   - react-joyrideのReact 19互換性エラーが先に発生
   - ヘッダーのフック順序問題が表面化しにくかった

## 対応方法

### 修正1: react-joyride コンポーネント無効化

```tsx
// app/mypage/MyPageClient.tsx
// app/mypage/simulator/SimulatorClient.tsx

// 修正前
import Joyride, { CallBackProps, STATUS, Step } from 'react-joyride';
...
<Joyride run={false} ... />

// 修正後
// react-joyride React 19対応まで無効化
// import Joyride, { CallBackProps, STATUS, Step } from 'react-joyride';
type Step = any;  // 仮の型定義
...
{/* チュートリアル - react-joyride React 19対応まで完全に無効化 */}
```

### 修正2: フック順序の修正

```tsx
// components/shared-header.tsx

// 修正前（フック前に早期リターン）
const isDashboardRoute = ...;
if (isDashboardRoute && !forceShow) {
  return null;
}
useEffect(() => { ... }, []);

// 修正後（早期リターン前にフック配置）
const isDashboardRoute = ...;
useEffect(() => { ... }, []);  // ← フックを先に
if (isDashboardRoute && !forceShow) {
  return null;  // ← 早期リターンは後
}
```

## 修正ファイル一覧

| ファイル | 修正内容 |
|---------|----------|
| `app/mypage/MyPageClient.tsx` | Joyrideコンポーネント・importをコメントアウト |
| `app/mypage/simulator/SimulatorClient.tsx` | 同上 |
| `components/shared-header.tsx` | useEffectを早期リターンより前に移動 |

## 再発防止策

1. **Reactフックのルール遵守**
   - フックは常にコンポーネントのトップレベルで呼び出す
   - 条件分岐や早期リターンの前にフックを配置

2. **依存ライブラリの互換性確認**
   - React メジャーバージョンアップ時は依存ライブラリの対応状況を確認
   - `npm ls` で `invalid` 警告をチェック

3. **ダッシュボードルートのテスト**
   - `/mypage` 等の認証必須ページも定期的に動作確認

## 関連コミット

- `3f80553` (2026-01-21): ヘッダーリファクタリング（バグ混入）
- `746ecd2`: チュートリアル一時無効化（react-joyride対応）
- 本修正コミット: react-joyride完全無効化 + フック順序修正

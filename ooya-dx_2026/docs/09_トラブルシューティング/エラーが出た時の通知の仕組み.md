# エラー通知システム

## 概要

本番環境でエラーが発生した際、ユーザーにはエラーページを表示し、同時に運営者にメールで通知を送信する仕組み。

## フロー図

```
ユーザー操作
    ↓
エラー発生
    ↓
┌─────────────────────────────────────────────────┐
│  app/error.tsx または app/global-error.tsx       │
│  (React Error Boundary)                         │
└─────────────────────────────────────────────────┘
    ↓                           ↓
┌──────────────┐       ┌──────────────────────────┐
│ エラーページ  │       │ /api/error-report        │
│ を表示       │       │ にエラー情報を送信        │
└──────────────┘       └──────────────────────────┘
                                ↓
                       ┌──────────────────────────┐
                       │ Resend経由でメール送信    │
                       │ → ERROR_NOTIFICATION_EMAIL│
                       └──────────────────────────┘
```

## ファイル構成

| ファイル | 役割 |
|---------|------|
| `app/error.tsx` | 一般的なランタイムエラー用のエラーページ |
| `app/global-error.tsx` | ルートレイアウトのエラー用（html/bodyを含む） |
| `app/api/error-report/route.ts` | エラー通知API（Resend経由でメール送信） |
| `app/test-error/page.tsx` | エラーページのテスト用ページ |

## 環境変数

| 変数名 | 説明 | 設定場所 |
|--------|------|----------|
| `ERROR_NOTIFICATION_EMAIL` | エラー通知の送信先メールアドレス | Vercel |
| `RESEND_API_KEY` | Resend APIキー | Vercel |
| `CONTACT_EMAIL` | フォールバック用メールアドレス | Vercel |

※ `ERROR_NOTIFICATION_EMAIL` が未設定の場合、`CONTACT_EMAIL` に送信

## 現在の設定

- **通知先**: `togo@startup-marketing.co.jp`
- **送信元**: `大家DX エラー通知 <noreply@ooya.tech>`

## エラーページの表示内容

### ユーザーに表示される内容

```
┌─────────────────────────────────────┐
│         [大家DX ロゴ]               │
│                                     │
│           ⚠️ (警告アイコン)         │
│                                     │
│     エラーが発生しました            │
│                                     │
│  申し訳ございません。予期しない     │
│  エラーが発生しました。             │
│                                     │
│  問題が解決しない場合は、しばらく   │
│  時間をおいて再度お試しください。   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ 🔄 もう一度試す              │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ 🏠 トップページへ戻る        │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ ← 前のページに戻る           │   │
│  └─────────────────────────────┘   │
│                                     │
│  お問い合わせ: お問い合わせフォーム │
└─────────────────────────────────────┘
```

### ボタンの動作

| ボタン | 動作 |
|--------|------|
| もう一度試す | `reset()` - ページを再レンダリング |
| トップページへ戻る | `/` に遷移 |
| 前のページに戻る | `window.history.back()` |
| お問い合わせフォーム | `/contact` に遷移 |

## メール通知の内容

```
件名: [エラー発生] エラーメッセージの先頭50文字

本文:
大家DXでエラーが発生しました

発生日時: 2026-01-24T06:57:28.279Z
URL: https://www.ooya.tech/test-error

エラーメッセージ:
これはテストエラーです。

スタックトレース:
Error: これはテストエラーです。
    at r (https://www.ooya.tech/...)
    ...

Error ID: （あれば表示）

User Agent:
Mozilla/5.0 (Macintosh; ...)

---
このメールは自動送信されています。
```

## レートリミット

同じエラーが短時間に大量発生した場合のスパム防止機能：

- **クールダウン**: 1分間（60秒）
- **判定基準**: エラーメッセージ + URL の組み合わせ
- **動作**: クールダウン中は同一エラーの通知をスキップ

## テスト方法

1. https://www.ooya.tech/test-error にアクセス
2. 「エラーを発生させる」ボタンをクリック
3. エラーページが表示される
4. 設定したメールアドレスに通知が届く

※ `/test-error` ページは `noindex` 設定済み（検索エンジンにインデックスされない）

## 開発環境での動作

- **メール送信**: スキップ（コンソールにログ出力のみ）
- **エラーページ**: エラー詳細（メッセージ、スタックトレース）も表示

## 関連ドキュメント

- [マイページアクセス不可_260124_1.md](./マイページアクセス不可_260124_1.md) - エラー事例

## 追加日

2026年1月24日

# 決済まわりのシナリオテスト

## 概要

Stripe決済機能のテスト手順と結果を記録する。

## 環境設定

### Stripe Price ID

| 環境 | Price ID | 価格 | 用途 |
|------|----------|------|------|
| Production | `price_1SjwexBKdvisvdVlavZIUFwn` | ¥980/月 | 本番運用 |
| Preview | `price_1SnwzoBKdvisvdVlDsSlOxvm` | ¥10/日 | テスト用 |
| localhost | `price_1SnwzoBKdvisvdVlDsSlOxvm` | ¥10/日 | テスト用 |

### テスト用クレジットカード

| カード番号 | 結果 |
|-----------|------|
| `4242 4242 4242 4242` | 成功 |
| `4000 0000 0000 0341` | 初回成功、更新時失敗 |
| `4000 0000 0000 9995` | 残高不足で失敗 |

- 有効期限: 未来の日付（例: `12/30`）
- CVC: 任意の3桁（例: `123`）

## テストシナリオ

### 1. 新規サブスクリプション登録

| 項目 | 内容 |
|------|------|
| 環境 | Vercel Preview（develop） |
| 手順 | 新規ユーザー登録 → `/mypage/billing` → プレミアムプラン購入 |
| 期待結果 | Stripe Checkout完了 → Webhook受信 → Subscriptionテーブルに登録 |
| テスト日 | 2026-01-10 |
| 結果 | ✅ 成功（¥10/日プラン） |

### 2. サブスクリプションキャンセル

| 項目 | 内容 |
|------|------|
| 環境 | Vercel Preview / Production |
| 手順 | `/mypage/billing` → カスタマーポータル → キャンセル |
| 期待結果 | Stripeでキャンセル → Webhook受信 → DBのステータス更新 |
| テスト日 | 2026-01-10 |
| 結果 | ✅ 成功 |

### 3. 自動更新（翌日/翌月課金）

| 項目 | 内容 |
|------|------|
| 環境 | Vercel Preview（¥10/日プラン） |
| 手順 | 1日待機 → Stripeダッシュボードで請求確認 |
| 期待結果 | 自動課金 → Webhook受信 → current_period_end更新 |
| テスト日 | - |
| 結果 | 未テスト |

### 4. 決済失敗

| 項目 | 内容 |
|------|------|
| 環境 | Vercel Preview |
| 手順 | テストカード `4000000000000341` で登録 → 更新時に失敗 |
| 期待結果 | past_due ステータスに変更 → メール通知（設定していれば） |
| テスト日 | - |
| 結果 | 未テスト |

### 5. 二重登録防止

| 項目 | 内容 |
|------|------|
| 環境 | Vercel Preview |
| 手順 | 有料ユーザーで再度 `/mypage/billing` へアクセス |
| 期待結果 | 購入ボタンが非表示 or 無効 |
| テスト日 | - |
| 結果 | 未テスト |

### 6. Webhook受信確認

| 項目 | 内容 |
|------|------|
| 環境 | Vercel Preview / Production |
| 確認場所 | Vercel Logs → `/api/stripe/webhook` |
| 主要イベント | `checkout.session.completed`, `customer.subscription.updated`, `customer.subscription.deleted` |
| テスト日 | 2026-01-10 |
| 結果 | ✅ 確認済み |

## localhost環境での注意事項

### Webhook受信

localhost環境では **Stripe CLI** が必要：

```bash
stripe listen --forward-to localhost:3000/api/stripe/webhook
```

これを実行しないと、決済完了後にDBにSubscriptionが作成されない。

### 新規ユーザー登録

localhost環境では **新規ユーザー登録不可**（Neon Auth Domains制限）。

対策：
1. Vercel Preview環境で新規登録
2. localhostでそのユーザーでログイン
3. 決済テスト実行

詳細: [Basic認証とNeonAuth仕様.md](./Basic認証とNeonAuth仕様.md)

## トラブルシューティング

### エラー: "No such price: 'price_xxx\n'"

**原因**: Vercel環境変数に改行が含まれている

**解決方法**:
```bash
# 削除
npx vercel env rm STRIPE_PRICE_ID preview -y

# 改行なしで再設定
printf 'price_1SnwzoBKdvisvdVlDsSlOxvm' | npx vercel env add STRIPE_PRICE_ID preview

# 再デプロイ
git commit --allow-empty -m "chore: fix env var" && git push
```

### エラー: "認証が必要です" (401)

**原因**: ログインしていない、またはセッション切れ

**解決方法**: 再ログイン

### Webhook未受信（localhost）

**原因**: `stripe listen` が実行されていない

**解決方法**: Stripe CLIで `stripe listen --forward-to localhost:3000/api/stripe/webhook` を実行

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-10 | 初版作成 |
| 2026-01-10 | テスト用価格（¥10/日）追加、新規登録・キャンセルテスト完了 |

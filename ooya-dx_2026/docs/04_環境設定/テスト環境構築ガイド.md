# テスト環境構築ガイド

作成日: 2026-01-08

## 概要

Vercel Preview + Neon Branch を活用したテスト環境の構築方法。
developブランチで開発・テストし、mainにマージすると本番に自動デプロイされる仕組み。

---

## 構成図

```
[開発・テスト]
develop ──push──→ Vercel Preview + Neon Branch DB + Stripe テストモード
    │
    │ PR作成 & マージ
    ▼
[本番]
main ──────────→ Vercel本番 + Neon本番DB + Stripe本番モード
```

---

## 環境比較

### 概要

| 項目 | 本番 (main) | テスト (develop) |
|------|-------------|------------------|
| Gitブランチ | `main` | `develop` |
| Vercel | ooya-dx2026.vercel.app | xxx-git-develop-xxx.vercel.app |
| Neon DB | main (本番) | develop (ブランチ) |
| Stripe | 本番モード (live) | テストモード (test) |
| デプロイ | mainプッシュで自動 | developプッシュで自動 |

### 詳細設定値

#### Vercel URL

| 環境 | URL |
|------|-----|
| 本番 | https://ooya-dx2026.vercel.app |
| テスト | https://ooya-dx2026-git-develop-xxx.vercel.app |

#### Neon Database

| 環境 | ブランチ名 | 接続先 |
|------|-----------|--------|
| 本番 | `main` | ep-sparkling-tooth-xxx.ap-southeast-1.aws.neon.tech |
| テスト | `develop` | ep-xxx-develop.ap-southeast-1.aws.neon.tech |

#### Stripe APIキー

| 環境 | Secret Key | Publishable Key |
|------|------------|-----------------|
| 本番 | `sk_live_...` | `pk_live_...` |
| テスト | `sk_test_...` | `pk_test_...` |

#### 環境変数一覧

| 変数名 | 本番 (Production) | テスト (Preview) |
|--------|-------------------|------------------|
| `DATABASE_URL` | 本番Neon接続文字列 | developブランチ接続文字列 |
| `STRIPE_SECRET_KEY` | sk_live_... | sk_test_... |
| `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` | pk_live_... | pk_test_... |
| `STRIPE_WEBHOOK_SECRET` | whsec_...(本番) | whsec_...(テスト) |
| `NEON_AUTH_BASE_URL` | 本番URL | 本番URL（共通可） |
| `BLOB_READ_WRITE_TOKEN` | 本番トークン | 本番トークン（共通可） |

---

## 開発フロー

```
1. developブランチで開発
      ↓
2. git push → Vercel Previewに自動デプロイ
      ↓
3. Preview URLで動作確認
      ↓
4. 動作確認OK
      ↓
5. GitHub PR作成 (develop → main)
      ↓
6. PRレビュー（任意）
      ↓
7. PRマージ
      ↓
8. main更新 → 本番に自動デプロイ
```

---

## 設定手順

### Step 1: developブランチ作成

```bash
# developブランチを作成してプッシュ
git checkout -b develop
git push -u origin develop
```

### Step 2: Neon Branch作成

1. [Neonダッシュボード](https://console.neon.tech/)にアクセス
2. プロジェクト選択
3. 「Branches」タブをクリック
4. 「Create Branch」をクリック
5. 設定:
   - Name: `develop`
   - Parent branch: `main`
   - Include data: チェックを入れる（本番データをコピー）
6. 「Create Branch」をクリック
7. 新しい接続文字列をコピー

### Step 3: Vercel環境変数設定

1. [Vercel Dashboard](https://vercel.com/)にアクセス
2. プロジェクト「ooya-dx_2026」を選択
3. 「Settings」→「Environment Variables」

#### Production環境（本番）
```
DATABASE_URL = postgresql://...本番DB...
STRIPE_SECRET_KEY = sk_live_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = pk_live_...
```

#### Preview環境（テスト）
```
DATABASE_URL = postgresql://...develop Branch DB...
STRIPE_SECRET_KEY = sk_test_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = pk_test_...
```

**設定方法:**
- 各変数の「Environment」で「Production」または「Preview」を選択
- 同じ変数名で異なる値を環境別に設定可能

### Step 4: GitHub Branch Protection（推奨）

mainブランチへの直接プッシュを禁止し、PR必須にする。

1. GitHubリポジトリ → 「Settings」→「Branches」
2. 「Add rule」をクリック
3. Branch name pattern: `main`
4. 設定:
   - ✅ Require a pull request before merging
   - ✅ Require approvals (任意)
   - ✅ Require status checks to pass before merging (任意)
5. 「Create」をクリック

---

## Vercel Preview機能について

### 自動Preview URL

GitHubにプッシュすると自動でPreview URLが生成される。

```
main     → https://ooya-dx2026.vercel.app (本番)
develop  → https://ooya-dx2026-git-develop-xxx.vercel.app
PR #42   → https://ooya-dx2026-git-pr-42-xxx.vercel.app
```

### Preview URLの確認方法

1. **GitHub PR**: PRページのコメントにVercelボットがURL投稿
2. **Vercel Dashboard**: Deploymentsタブで確認
3. **git push後のターミナル**: デプロイ完了後にURL表示

---

## Neon Branch機能について

### Branchとは

- Gitのブランチのように、データベースをコピー・分岐できる
- 本番DBに影響を与えずにテスト可能
- スキーマ変更のテストに最適

### 無料プランの制限

- 1ブランチまで無料
- 本番 + 1テストブランチ構成が可能

### Branch作成時のオプション

| オプション | 説明 |
|-----------|------|
| Include data | 親ブランチのデータをコピー |
| Point-in-time | 特定時点のデータを使用 |

---

## Stripe テスト/本番の切り替え

### APIキー

| 環境 | Secret Key | Publishable Key |
|------|------------|-----------------|
| テスト | sk_test_... | pk_test_... |
| 本番 | sk_live_... | pk_live_... |

### テスト用カード番号

```
成功: 4242 4242 4242 4242
失敗: 4000 0000 0000 0002
3Dセキュア: 4000 0025 0000 3155
```

有効期限: 任意の将来日付
CVC: 任意の3桁

---

## 日常の開発フロー

### 新機能開発

```bash
# 1. developブランチに切り替え
git checkout develop

# 2. 最新を取得
git pull origin develop

# 3. 開発作業...

# 4. コミット & プッシュ
git add .
git commit -m "feat: 新機能追加"
git push

# 5. Preview URLで確認

# 6. OKならGitHubでPR作成 (develop → main)

# 7. PRマージ → 本番自動デプロイ
```

### 緊急の本番修正（Hotfix）

```bash
# 1. mainから直接修正ブランチ作成
git checkout main
git checkout -b hotfix/urgent-fix

# 2. 修正 & コミット

# 3. mainにPR作成 & マージ

# 4. developにも反映
git checkout develop
git merge main
git push
```

---

## チェックリスト

### 初期設定

- [ ] developブランチ作成
- [ ] Neon Branch作成
- [ ] Vercel環境変数設定（Production/Preview分離）
- [ ] GitHub Branch Protection設定（任意）
- [ ] Stripe テストAPIキー設定

### 動作確認

- [ ] developプッシュでPreviewデプロイされる
- [ ] Preview環境がテストDBに接続している
- [ ] Stripeテスト決済が動作する
- [ ] mainマージで本番デプロイされる

---

## トラブルシューティング

### Preview環境が本番DBに接続してしまう

→ Vercel環境変数の「Environment」設定を確認。Preview用とProduction用で別々の値を設定。

### Neon Branchの接続エラー

→ 接続文字列のエンドポイントがブランチ用になっているか確認。

### PRマージ後に本番デプロイされない

→ Vercelの「Git」設定で「Production Branch」が`main`になっているか確認。
